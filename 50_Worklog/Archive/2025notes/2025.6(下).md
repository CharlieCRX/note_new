# 6.13

å½“å‰ä»»åŠ¡ï¼š

- ç½‘ç»œåŒæ­¥GPSä¸å¼€å‘æ¿çš„æ—¶é—´
- æ‰¹é‡é©¯æœå¼€å‘æ¿çš„é“·é’Ÿ
- æ‰¹é‡åŒæ­¥å¼€å‘æ¿ä¸Šçš„æ—¶é—´

## ç½‘ç»œåŒæ­¥GPSä¸å¼€å‘æ¿çš„æ—¶é—´

### éœ€æ±‚

å­˜åœ¨GPSä¿¡å·æºå¹¶ä¸”ä¸Šé¢æœ‰ç½‘å£ã€‚ç°åœ¨æƒ³è®©åµŒå…¥å¼è®¾å¤‡ä¸GPSä¿¡å·æºè¿›è¡Œç½‘ç»œäº¤äº’ï¼Œå®ç°åµŒå…¥å¼å¼€å‘æ¿çš„æ—¶é—´ä¸GPSçš„æ—¶é—´ä¿¡æ¯åŒæ­¥ã€‚

### é—®é¢˜

ç°åœ¨å­˜åœ¨çš„é—®é¢˜åœ¨äºï¼š

- åªçŸ¥é“GPSå­˜åœ¨ç½‘å£ï¼Œä½†æ˜¯æˆ‘åº”è¯¥æ€ä¹ˆæ‰èƒ½é€šè¿‡ç½‘ç»œè®¿é—®GPSçš„æ—¶é—´ä¿¡æ¯å‘¢ï¼Ÿ
- åµŒå…¥å¼è®¾å¤‡å¦‚ä½•æ‰èƒ½å°†è·å–åˆ°çš„æ—¶é—´ä¿¡æ¯ï¼Œå†™å…¥åˆ°è‡ªå·±çš„æ—¶é’Ÿå½“ä¸­ï¼Ÿ

è¯·ä½ æŒ‰ç…§ç°åœ¨çš„éœ€æ±‚å’Œé—®é¢˜ï¼Œå¸®æˆ‘æ¢³ç†ä¸‹æˆ‘è¯¥æ€ä¹ˆå…¥æ‰‹è¿™ä¸ªé—®é¢˜ã€‚

### åœ°ç‹±å¼€å±€ï¼ˆè¿˜å¥½ï¼‰

æ²¡æœ‰æ‰‹å†Œï¼Œåªæœ‰ï¼š

- èƒ½æ¥å…¥ GPS çš„ä»¥å¤ªç½‘å£
- GPS å’Œ PC ï¼ˆens33ï¼‰å¯ä»¥è¿æ¥åˆ°åŒä¸€ä¸ªå±€åŸŸç½‘ï¼ˆæˆ–ç›´è¿ï¼‰
- çŸ¥é“ GPS çš„ **IP åœ°å€**`192.168.1.126`å’ŒUDPç«¯å£5000ã€‚

## NMEAè¯·æ±‚

æ­¤ GPS è®¾å¤‡å¯èƒ½æ”¯æŒé€šè¿‡ UDP å‘æŸç«¯å£å‘é€ã€ŒNMEA è¯·æ±‚å‘½ä»¤ã€ï¼Œç„¶åè®¾å¤‡ä¼šè¿”å›å¸¦æ—¶é—´çš„æ•°æ®ã€‚

å¯ä»¥ç”¨ `netcat` å°è¯•å‘é€å‘½ä»¤ï¼š

```bash
echo '$PRWIILOG,NMEA,GGA,RMC,ZDA,ON,0*7D\r\n' | nc -u -w1 192.168.1.126 5000
```

å¦‚æœæƒ³è¦è®© GPS åœç”¨ä¸Šé¢å·²ç»å¯ç”¨çš„ NMEA æ¶ˆæ¯ï¼Œéœ€è¦ä½¿ç”¨ä¸å¯ç”¨æ—¶æ ¼å¼ç›¸åŒçš„å‘½ä»¤ï¼Œåªéœ€æŠŠ `ON` æ”¹ä¸º `OFF` å³å¯ã€‚

```bash
echo -e '$PRWIILOG,NMEA,GGA,RMC,ZDA,OFF,0*2B\r\n' | nc -u -w1 192.168.1.126 5000
```

ç„¶åä¸€è¾¹å‘é€ï¼Œä¸€è¾¹ç›‘å¬ï¼š

```bash
sudo tcpdump -i ens33 -A udp port 5000
```

æ­¤æ—¶è·å–åˆ°çš„æ•°æ®

```bash
10:29:41.887560 IP 192.168.1.126.5000 > ubuntu.2000: UDP, length 256
E.....@...pO...~...........=$GPZDA,022942.00,13,06,2025,00,00*104
$HT,01,1,+499.1,+6.2E-10,0,1,0,17997824*
$HT,02,1,0,+08,0,0,000014555*
$HT,03,2:1,3.0,01,100000*
$HT,04,192.168.1.126,255.255.255.0,192.168.1.1,5000,2000*
$HT,12,2,E11845.2397,N3158.5174,M-063.-8,0.1K,06,16,1,1*
```

## Netcat

ï¼ˆNetcatï¼‰æ˜¯ç”¨äºç½‘ç»œè¿æ¥çš„å·¥å…·ï¼Œå‚æ•°å«ä¹‰ï¼š

- `-u`ï¼šä½¿ç”¨ UDP åè®®ï¼ˆè€Œéé»˜è®¤çš„ TCP åè®®ï¼‰ã€‚
- `-w1`ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 1 ç§’ï¼Œè‹¥è¿æ¥æ— å“åº”åˆ™è‡ªåŠ¨æ–­å¼€ã€‚

- ç›®æ ‡åœ°å€ï¼š`192.168.1.126`ï¼ˆå±€åŸŸç½‘ IPï¼‰ï¼Œç«¯å£ `5000`ï¼ˆè‡ªå®šä¹‰ç«¯å£ï¼Œé€šå¸¸ç”¨äº UDP æ•°æ®ä¼ è¾“ï¼‰ã€‚

## NMEAå‘½ä»¤

```bash
echo '$PRWIILOG,NMEA,GGA,RMC,ZDA,ON,0*7D\r\n' | nc -u -w1 192.168.1.126 5000
```

- `$P` å¼€å¤´ï¼šè¡¨ç¤ºã€Œ**ç§æœ‰ NMEA å‘½ä»¤**ã€ï¼ˆProprietary NMEA Sentenceï¼‰
- `RWII`ï¼šæ˜¯è¯¥è®¾å¤‡å‚å•†çš„ä»£å·ï¼ˆå¦‚ Raymarine æˆ– Hemisphereï¼‰

æ‰€ä»¥ `$PRWIILOG`ã€`$PRWIIHLP`ã€`$PRWIINET` éƒ½æ˜¯è¿™ç±»è®¾å¤‡æ”¯æŒçš„ç§æœ‰å‘½ä»¤ï¼Œç”¨äºæ§åˆ¶ NMEA æ¶ˆæ¯æ ¼å¼çš„è¾“å‡ºã€ç½‘ç»œè¡Œä¸ºç­‰ã€‚

## è®© GPS å‘é€ UDP å¹¿æ’­

éœ€è¦è®©è®¾å¤‡å°† UDP æ•°æ®åŒ…å‘åˆ° **å¹¿æ’­åœ°å€**ï¼Œæ¯”å¦‚ï¼š

```bash
192.168.1.255:2000
```

è¿™æ„å‘³ç€ï¼š

- **ç›®æ ‡ IP åœ°å€**ï¼šå¹¿æ’­åœ°å€ï¼ˆæ•´ä¸ªå­ç½‘ï¼Œå¦‚ 192.168.1.255ï¼‰
- **ç›®æ ‡ç«¯å£**ï¼šä½ æŒ‡å®šçš„ç«¯å£ï¼ˆå¦‚ 2000ï¼‰

ä½†æ˜¯è®¾ç½®çš„æ—¶å€™ï¼Œè®¾ç½®é”™è¯¯ï¼Œå¯èƒ½éœ€è¦è·å–å…¶å¯¹åº”å‚å®¶ä¿¡æ¯

## è·å–MACåœ°å€

ç”µè„‘æ˜¯ `192.168.1.x`ï¼ŒGPS æ˜¯ `192.168.1.126`ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤è·å–å…¶ MAC åœ°å€ï¼š

```bash
arp -n 192.168.1.126
```

è¾“å‡ºä¸ºï¼š

```bash
crx@ubuntu:~/work/apps/ruclock$ arp -n 192.168.1.126
Address                  HWtype  HWaddress           Flags Mask            Iface
192.168.1.126            ether   22:36:59:34:24:43   C                     ens33
```

å…¶ä¸­ï¼š

- `HWaddress` å°±æ˜¯ MAC åœ°å€ï¼š`22:36:59:34:24:43`
- `arp -n` è¡¨ç¤ºä¸åš DNS è§£æã€‚

ç”±æ­¤å¯çŸ¥GPS è®¾å¤‡çš„ MAC åœ°å€ä¸º`22:36:59:34:24:43`ã€‚

## Cè¯­è¨€è§£æ

ç°åœ¨å·²çŸ¥çš„ GPS å“åº”ä¸º

```bash
10:29:41.887560 IP 192.168.1.126.5000 > ubuntu.2000: UDP, length 256
E.....@...pO...~...........=$GPZDA,022942.00,13,06,2025,00,00*104
$HT,01,1,+499.1,+6.2E-10,0,1,0,17997824*
$HT,02,1,0,+08,0,0,000014555*
$HT,03,2:1,3.0,01,100000*
$HT,04,192.168.1.126,255.255.255.0,192.168.1.1,5000,2000*
$HT,12,2,E11845.2397,N3158.5174,M-063.-8,0.1K,06,16,1,1*
```

ç°åœ¨æƒ³è·å–çš„æ˜¯ï¼š

- æ—¶é—´ä¿¡æ¯

  ```bash
  $GPZDA,022942.00,13,06,2025,00,00*104
  ```

- ç»çº¬åº¦

  ```bash
  $HT,12,2,E11845.2397,N3158.5174,M-063.-8,0.1K,06,16,1,1*
  ```

è¯·ä½ æ ¹æ®æ­¤ä¿¡æ¯æ ¼å¼ï¼Œç»™ä¸€ä¸ªåˆç†çš„Cè¯­è¨€å®ç°ï¼Œèƒ½å¤Ÿè®¿é—®IPåœ°å€ä¸º`10.1.2.06`UDP5000çš„ GPS ä¿¡å·æºã€‚

# 6.16

## è§£å†³æ£€æŸ¥ä½ç½®ç§»åŠ¨é”™è¯¯

è¿˜æ˜¯è€é—®é¢˜ï¼Œä¹‹å‰æ£€æŸ¥ä½ç½®ç§»åŠ¨æ˜¯å¦æˆåŠŸçš„æ ‡å¿—ä¸º`COIN`æ˜¯å¦è¾“å‡ºé«˜ç”µå¹³ï¼Œä½¿ç”¨çš„æ˜¯æ‰‹å†Œæä¾›çš„æ ‡å‡†æ£€æµ‹æ–¹å¼ã€‚

ä½†æ˜¯ç°åœ¨çš„é—®é¢˜å°±æ˜¯ï¼Œå¼‚å¸¸åœºæ™¯ä¸‹ï¼Œå³ä½¿ä½ç½®ç§»åŠ¨è¿˜æ²¡åˆ°ä½ï¼Œ`COIN`å£å°±è¾“å‡ºé«˜ç”µå¹³äº†ã€‚

### é—®é¢˜åˆ†æ

çœŸå®çš„ä½ç½®ç§»åŠ¨çš„æ£€æµ‹æ–¹æ³•ï¼š

åœ¨æ£€æµ‹ `COIN` ä¿¡å·çš„åŒæ—¶ï¼Œè·å–å½“å‰ç”µæœºçš„ç»å¯¹å€¼è„‰å†²æ•° `currentPulse` å’Œç›®æ ‡ä½ç½®è„‰å†²`targetPulse`æ•°è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœå‡ºç°äº†æ­¤åœºæ™¯ï¼š

- `DO`ä¿¡å·ä¸º 1 ï¼šç”µæœºè‡ªå·±è®¤ä¸ºå·²ç»ä½ç½®ç§»åŠ¨æˆåŠŸ
- `currentPulse` != `targetPulse` ï¼šè¯æ˜å®é™…ç”µæœºå¹¶æœªç§»åŠ¨å®Œæˆ

å°±è¯æ˜ç”µæœºå­˜åœ¨å¼‚å¸¸é—®é¢˜ã€‚æ£€æŸ¥æ˜¯å¦è´Ÿè½½è¿‡é‡ã€‚

### è§£å†³æ–¹æ¡ˆä»¥åŠé£é™©

åªæœ‰å½“:

- `COIN`ä¿¡å·ä¸º 1 

- å½“å‰ä½ç½®å’Œç›®æ ‡ä½ç½®è„‰å†²æ•°å°äºè¯¯å·®é˜ˆå€¼

  ```cpp
  abs(currentPulse - targetPulse) < thresholdPulse
  ```

æ‰èƒ½è®©ç”µæœºåœæ­¢ä½ç½®ç§»åŠ¨ã€‚

ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼š

ç°åœ¨æ£€æŸ¥ä½ç½®ç§»åŠ¨çš„å‡½æ•°ï¼Œæ˜¯å¾ªç¯è°ƒç”¨çš„ã€‚ä½†æ˜¯å¦‚æœå‡ºç°ç”µæœºé€Ÿåº¦å¾ˆå¿«ï¼Œç„¶åä½ç½®ç§»åŠ¨å·²ç»å®Œæˆã€‚æ­¤æ—¶DOä¿¡å·è¾“å‡ºé«˜ç”µå¹³1ï¼Œä½†æ˜¯ç”±äºè¯»å–ç”µæœºå¯„å­˜å™¨çš„é€Ÿåº¦è¾ƒæ…¢ï¼Œæ£€æµ‹åˆ°å½“å‰ä½ç½®å’Œç›®æ ‡ä½ç½®è„‰å†²æ•°å¤§äºè¯¯å·®é˜ˆå€¼ï¼Œå°±ä¼šæ— é™åˆ¶åœ°ç­‰å¾…ä¸‹å»ã€‚

## å®šä½å®Œæˆæ‰‹å†Œ2

### ç¥ç§˜çš„`COIN`

å½“å‰è´Ÿè´£å®šä½å®Œæˆçš„`COIN`çš„å¯„å­˜å™¨ä¸º`P3-20`ï¼Œæ˜¯æ•°å­—`DO1`ç«¯å£ã€‚

å‡ºç°äº†å¼‚å¸¸æƒ…å†µï¼šå½“å‰ä½ç½®å°šæœªåˆ°è¾¾ï¼Œç”µæœºçš„`DO1`ç«¯å£ä¾¿è¾“å‡ºäº†é«˜ç”µå¹³ä»£è¡¨å®šä½å®Œæˆã€‚

åœ¨æ‰‹å†Œä¸­ï¼Œå¯¹äº`DO1`ç«¯å£çš„`COIN`çš„åŠŸèƒ½ï¼Œæœ‰å¦‚ä¸‹è§£æ

| å®šä¹‰å€¼ | ç¬¦å· |   åŠŸèƒ½   | åŠŸèƒ½è§£æ                                                     |
| :----: | :--: | :------: | ------------------------------------------------------------ |
|   5    | COIN | å®šä½å®Œæˆ | ä½ç½®æ§åˆ¶æ—¶ï¼ŒOFF ï¼šä½ç½®åå·®å¤§äºå‚æ•° PA-16ï¼›ON ï¼šä½ç½®åå·®å°äºå‚æ•° PA-16ã€‚ |

### PA-16

æˆ‘ä»¬ç»§ç»­æŸ¥è¯¢ä¸‹`PA-16`å¯„å­˜å™¨çš„åŠŸèƒ½ï¼ˆé¡ºå¸¦çœ‹`PA-17`ï¼‰

| ç¼–å· |       åç§°       | åŠŸèƒ½                                                         |     å‚æ•°èŒƒå›´     | å‡ºå‚å€¼ |
| :--: | :--------------: | :----------------------------------------------------------- | :--------------: | :----: |
|  16  |     å®šä½å®Œæˆ     | ä½ç½®æ§åˆ¶ä¸‹å®šä½å®Œæˆè„‰å†²èŒƒå›´ã€‚å½“å†…çš„å‰©ä½™è„‰å†²æ•°å°äºæˆ–ç­‰äºæœ¬å‚æ•°è®¾å®šå€¼æ—¶ï¼Œæ•°å­—è¾“å‡º`DO`çš„`COIN`ï¼ˆå®šä½å®Œæˆï¼‰ONï¼Œå¦åˆ™OFF |   0-30000è„‰å†²    |  130   |
|  17  | ä½ç½®è¶…å·®èŒƒå›´æ£€æµ‹ | ä½ç½®æ§åˆ¶æ–¹å¼ä¸‹ï¼Œå½“ä½ç½®åå·®è®¡æ•°å™¨çš„æ•°å€¼è¶…è¿‡æœ¬å‚æ•°å€¼æ—¶ï¼Œé©±åŠ¨å™¨ç»™å‡ºä½ç½®æŠ¥è­¦ | 0-30000 Ã—100è„‰å†² |  6000  |

ç»è¿‡ä½ç½®ç§»åŠ¨çš„å®é™…æ£€æŸ¥ï¼Œå‘ç°ä½ç½®ç§»åŠ¨çš„æ—¶å€™ï¼Œ

# 6.17

ä»Šæ—¥ä»»åŠ¡ï¼š

- è®¾è®¡ä¸å‰ç«¯äº¤äº’çš„æ¥å£
- é€šè¿‡QMLè®¾è®¡ç•Œé¢

## éœ€æ±‚æ¢³ç†

ç°åœ¨Qtç¨‹åºè¦ä½œä¸ºå‰ç«¯å±•ç¤ºï¼Œéœ€è¦åç«¯æ¥å£æ¥æä¾›ä¿¡æ¯ã€‚

éœ€è¦åšçš„å·¥ä½œï¼š

1. è·å–è®¾å¤‡ä¿¡æ¯ï¼šè·å–ç½‘æ®µå†…æ‰€æœ‰ç½‘ç»œè®¾å¤‡ä»¥åŠç›¸å…³ä¿¡æ¯
2. GPSé©¯æœé“·é’Ÿï¼šå°†é€‰ä¸­çš„ç½‘ç»œè®¾å¤‡è¿›è¡Œç»Ÿä¸€çš„GPSé©¯æœ
   1. æ£€æŸ¥æ˜¯å¦æ»¡è¶³é©¯æœæ¡ä»¶
   2. é©¯æœçŠ¶æ€æ£€æµ‹
3. ç½‘ç»œåŒæ­¥å¼€å‘æ¿è®¾å¤‡æ—¶é—´ä¸GPSæ—¶é—´

## é“·é’Ÿé©¯æœæ¥å£

- æ˜¯å¦æ»¡è¶³é©¯æœæ¡ä»¶
- é©¯æœé“·é’Ÿ
- é“·é’ŸçŠ¶æ€



# 6.18

ä»Šå¤©é…ç½®Clionï¼Œä½¿å…¶å¼€å‘QMLã€‚

## é…ç½®CLionçš„Qtå¼€å‘ç¯å¢ƒ

å®‰è£…å¥½ï¼š

- **Qt6ï¼ˆå« MinGW å·¥å…·é“¾ï¼‰**
  - Qt è·¯å¾„å¦‚ï¼š`D:\develop\Qt\Qt6.9\6.9.0\mingw_64\`
  - MinGW è·¯å¾„å¦‚ï¼š`D:\develop\Qt\Qt6.9\Tools\mingw1310_64\`
- **CMake**ï¼ˆQt è‡ªå¸¦æˆ–å•ç‹¬å®‰è£…ï¼‰
  - å®‰è£…è·¯å¾„ï¼š`D:\develop\Qt\Qt6.9\Tools\CMake_64\bin\cmake.exe`
- **CLion** å’Œæ’ä»¶ï¼šå‹¾é€‰ `Qt for CMake` æ’ä»¶

### å…‹éš†ä»£ç 

ä»¥`FluentUI`é¡¹ç›®åœ¨`Clion`å¯åŠ¨ä¸ºä¾‹ã€‚

cloneä»“åº“åˆ°æœ¬åœ°ï¼Œæˆ‘çš„ç›®å½•ä¸º

```bash
F:\project\FluentUI
```

ç„¶åç”¨Clionæ‰“å¼€æ­¤é¡¹ç›®ã€‚

### é…ç½®å·¥å…·é“¾

**æ‰“å¼€ CLion è®¾ç½®**ï¼šFile > Settings > Build, Execution, Deployment > Toolchains

**æ·»åŠ  MinGW å·¥å…·é“¾**

- Name: `Qt-MinGW`

- CMake: ä½¿ç”¨ Qt ä¸­çš„ cmakeï¼Œä¾‹å¦‚ï¼š

  ```makefile
  D:\develop\Qt\Qt6.9\Tools\CMake_64\bin\cmake.exe
  ```

- Make: ä½¿ç”¨ ninjaï¼ˆå¯é€‰ï¼‰

  ```bash
  D:\develop\Qt\Qt6.9\Tools\Ninja\ninja.exe
  ```

- ç¼–è¯‘å™¨ï¼š

  ```bash
  C:\develop\Qt\Qt6.9\Tools\mingw1310_64\bin\gcc.exe
  ```

å®£å‘Šå¤±è´¥ï¼Œå› ä¸ºç¼–è¯‘åæ— æ³•æ‰¾åˆ°dllçš„å…¥å£ã€‚æš‚æ—¶ä½œç½¢ã€‚

# 6.19

## Qt6è¿æ¥linux

ç°åœ¨æƒ³åšçš„éœ€æ±‚æ˜¯ï¼Œ

- Qt ç¨‹åºåœ¨ Windows ä¸Šè¿è¡Œï¼ˆä½¿ç”¨ Qt6.9 + MinGWï¼‰
- Linux ä¸Šæœ‰ä¸€ä¸ª C å†™çš„åå°ç¨‹åºï¼ˆæœåŠ¡/å®ˆæŠ¤è¿›ç¨‹ï¼‰åœ¨è¿è¡Œ
- è®© Qt ä½œä¸ºå‰ç«¯ï¼Œé€šè¿‡ç½‘ç»œä¸ Linux åå°è½¯ä»¶è¿›è¡Œäº¤äº’ï¼Œå‘é€è¯·æ±‚ã€æ¥æ”¶å“åº”

å¯¹åº”çš„éœ€æ±‚æŠ½è±¡ä¸ºï¼š

- äº¤äº’ç›®æ ‡ï¼šä¸linuxä¸Šè¿è¡Œçš„åå°è½¯ä»¶è¿›è¡Œäº¤äº’ï¼Œqtåªä½œä¸ºå‰ç«¯ç•Œé¢å‘é€è¯·æ±‚å’Œæ¥æ”¶å“åº”
- è½¯ä»¶ç±»å‹ï¼šæ˜¯ä¸€ä¸ªCè¯­è¨€çš„ç¨‹åº
- Qtç‰ˆæœ¬ï¼šWindows+Qt6.9 + MinGW

## æ“ä½œæ­¥éª¤

1. ç¡®è®¤ Linux åå°æœåŠ¡æ˜¯å¦å¯ä»¥ä½œä¸º TCP æœåŠ¡è¿è¡Œ
2. ç¼–å†™çš„ Linux æœåŠ¡ç¨‹åºç›‘å¬ç«¯å£
3. åœ¨ Qt ä¸­æ·»åŠ  `QTcpSocket` å®¢æˆ·ç«¯ä»£ç 
4.  æµ‹è¯•ç½‘ç»œæ˜¯å¦èƒ½è¿é€š

## æ¥å£API

ç°åœ¨éœ€è¦ååŠ©Qtå‰ç«¯å’ŒCåç«¯å®šæ¥å£ã€‚

éœ€è¦Cåç«¯æä¾›çš„æ¥å£ï¼š

- è·å–è®¾å¤‡ä¿¡æ¯

  - ç½‘ç»œä¿¡æ¯ï¼šIPï¼ŒMAC
  - æ—¶é—´ä¿¡æ¯ï¼šdate
  - é“·é’Ÿä¿¡æ¯ï¼šstatusã€tempç­‰

- åŒæ­¥è®¾å¤‡æ—¶é—´

  - è°ƒç”¨åç«‹åˆ»æ‰§è¡ŒåŒæ­¥è®¾å¤‡çš„æ—¶é—´

- æ˜¯å¦æ»¡è¶³GPSé©¯æœé“·é’Ÿçš„æ¡ä»¶

- GPSé©¯æœé“·é’Ÿ

  - è¾“å…¥ï¼šæ—¶é—´å¸¸æ•°`time_constant`ï¼Œç›¸ä½é˜ˆå€¼`ns_threshold`

  - è¾“å‡ºï¼š

    å…¶æ•°æ®æ ¼å¼ä¸º

    ```C
    typedef struct {
      bool success;
      DisciplineStartStatus code;
      const char* message;  // å¯ä»¥å‰ç«¯ç›´æ¥å¼¹å‡º
    } DisciplineStartResult;
    ```

- GPSé©¯æœè¿‡ç¨‹ä¸­çš„çŠ¶æ€æ£€æŸ¥

  - è°ƒç”¨åï¼Œè¿”å›é©¯æœç»“æœä»¥åŠä¿¡æ¯

  - è¿”å›å€¼ç»“æ„ä½“

    ```C
    typedef struct {
      int disOK;  // è®­ç»ƒçŠ¶æ€
      int phase;  // ç›¸ä½æ¼‚ç§»
      int steer;  // é¢‘ç‡è°ƒæ•´å€¼
      int training_status; // 0: æ­£åœ¨è®­ç»ƒï¼Œ1: æˆåŠŸï¼Œ2: å¤±è´¥ï¼Œ-1: é”™è¯¯
      char message[64];    // çŠ¶æ€è¯´æ˜ï¼Œå¯é€‰
    } DiscipliningStatus;
    ```

  è¯·ä½ ä¾æ®è¿™äº›ä¿¡æ¯ï¼Œç»™å‡ºAPIæ¥å£åç§°ä»¥åŠAPIçš„jsonæ•°æ®æ ¼å¼

## APIæ¥å£

| åŠŸèƒ½æè¿°           | URI è·¯å¾„                    | è¯·æ±‚æ–¹å¼ | è¯·æ±‚å†…å®¹ç±»å‹       | è¯´æ˜                             |
| ------------------ | --------------------------- | -------- | ------------------ | -------------------------------- |
| è·å–è®¾å¤‡ä¿¡æ¯       | `/api/device/info`          | GET      | N/A                | è¿”å›ç½‘ç»œä¿¡æ¯ã€ç³»ç»Ÿæ—¶é—´ã€CSACçŠ¶æ€ |
| åŒæ­¥è®¾å¤‡æ—¶é—´       | `/api/device/sync_time`     | GET      | N/A                | åç«¯ç«‹å³åŒæ­¥ç³»ç»Ÿæ—¶é—´             |
| æŸ¥è¯¢æ˜¯å¦èƒ½å¯åŠ¨é©¯æœ | `/api/discipline/can_start` | GET      | N/A                | è¿”å›æ˜¯å¦æ»¡è¶³è®­ç»ƒå¯åŠ¨æ¡ä»¶         |
| å¯åŠ¨é©¯æœ           | `/api/discipline/start`     | POST     | `application/json` | å¯åŠ¨ GPS é©¯æœ                    |
| æŸ¥è¯¢é©¯æœçŠ¶æ€       | `/api/discipline/status`    | GET      | N/A                | è¿”å›è®­ç»ƒå®æ—¶çŠ¶æ€ä¿¡æ¯             |

##   è·å–è®¾å¤‡ä¿¡æ¯

åç«¯æ¥æ”¶è¯·æ±‚ï¼Œè·å–ï¼š

- ç½‘ç»œä¿¡æ¯ï¼šIPï¼ŒMAC
- æ—¶é—´ä¿¡æ¯ï¼šdate
- é“·é’Ÿä¿¡æ¯ï¼šstatusã€tempç­‰

### é“·é’Ÿæ¥å£

è·å–é“·é’Ÿä¿¡æ¯çš„è¯¦ç»†æ¥å£åœ¨`ruclock/include/telemetry_query.h`ä¸­

```C
int get_telemetry_data(T_CSAC_telemetry *telemetry);
```

### å“åº”æ ¼å¼

```json
{
  "network": {
    "ip": "192.168.1.10",
    "mac": "AA:BB:CC:DD:EE:FF"
  },
  "system": {
    "date": "2025-06-19 11:20:00"
  },
  "csac": {
    "status": 0x0000,
    "temp": 41.5,
    "steer": 12,
    "phase": 33
  }
}
```

## åŒæ­¥è®¾å¤‡æ—¶é—´

åç«¯æ¥å—è¯·æ±‚åï¼ŒåŒæ­¥è®¾å¤‡æ—¶é—´ä¸GPSä¿¡å·ä¸€è‡´ã€‚

### è¯·æ±‚

```http
POST /api/device/sync_time
Host: 10.1.2.140:5000
```

### å“åº”

```json
{ "success": true, "message": "æ—¶é—´åŒæ­¥æˆåŠŸ" }
```

## æŸ¥è¯¢æ˜¯å¦èƒ½å¯åŠ¨é©¯æœ

### é“·é’Ÿæ¥å£

é€šè¿‡è°ƒç”¨é“·é’Ÿæ¨¡å—`ruclock/include/discipliner.h`

```C
/**
 * @brief æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡Œé©¯æœ
 * æ»¡è¶³çš„æ¡ä»¶ï¼š
 *   1. é“·é’ŸçŠ¶æ€ç¨³å®š
 *   2. å­˜åœ¨GPS 1PPSè¾“å…¥ 
 * @return true = å¯ä»¥ ï¼Œfalse = ä¸å¯ä»¥
 */
bool discipliner_is_ready_to_execute();
```

### è¯·æ±‚

```http
GET /api/discipline/can_start
Host: 10.1.2.140:5000
```

### å“åº”

```json
{
  "can_start": true,
  "reason": "æ¡ä»¶æ»¡è¶³"
}
```

## å¯åŠ¨é©¯æœ

è¾“å…¥è®­ç»ƒæ—¶é—´å¸¸æ•°å’Œç›¸ä½é˜ˆå€¼ï¼Œè¿›è¡ŒGPSé©¯æœé“·é’Ÿæµç¨‹

### é“·é’Ÿæ¥å£

è°ƒç”¨é“·é’Ÿæ¨¡å—`ruclock/include/ruclock.h`çš„

```C
DisciplineStartResult ruclock_discipliner_start_training(uint8_t ns_threshold, uint16_t time_constant);
```

### è¯·æ±‚

```http
POST /api/discipline/start
Host: 10.1.2.140:5000
Content-Type: application/json

{
  "time_constant": 900,
  "ns_threshold": 1000
}
```

### å“åº”

```json
{
  "success": true,
  "code": 0,
  "message": "é©¯æœå¼€å§‹æˆåŠŸ"
}
```

##  æŸ¥è¯¢é©¯æœçŠ¶æ€

### é“·é’Ÿæ¥å£

è°ƒç”¨é“·é’Ÿæ¨¡å—`ruclock/include/ruclock.h`

```C
DiscipliningStatus ruclock_discipliner_update_training_status();
```

### è¯·æ±‚

```http
GET /api/discipline/status
Host: 10.1.2.140:5000
```

### å“åº”

```json
{
  "disOK": 0,
  "phase": 45,
  "steer": 12,
  "training_status": 0,
  "message": "è®­ç»ƒä¸­ï¼šSteer=12, Phase=45 ns"
}
```

## QtQuické¡¹ç›®1

å¶ç„¶å‘ç°äº†[Qtçš„ä¸­æ–‡è¯´æ˜ä¹¦](https://doc.qt.io/qt-6/zh/qtquick-index.html)

å“ˆå“ˆå“ˆå“ˆï¼Œå¯ä»¥~

# 6.20

## ä¿¡å·

*ä¿¡å·*æ˜¯äº‹ä»¶ï¼Œ*ä¿¡å·*é€šè¿‡*ä¿¡å·å¤„ç†å‡½æ•°*å“åº”ã€‚

### ä¿¡å·å¤„ç†ç¨‹åºæ¥æ”¶ä¿¡å·

å¯¹è±¡ä¸­å­˜åœ¨ä¿¡å·ï¼Œä¾‹å¦‚`Button`ï¼Œå…¶ç»§æ‰¿äº`AbstractButton`ç±»å‹ã€‚å…¶å­˜åœ¨çš„ä¿¡å·ä¾‹ä¸ºï¼š

- **[clicked](https://doc.qt.io/qt-6/zh/qml-qtquick-controls-abstractbutton.html#clicked-signal)**()
- **[doubleClicked](https://doc.qt.io/qt-6/zh/qml-qtquick-controls-abstractbutton.html#doubleClicked-signal)**()
- **[pressAndHold](https://doc.qt.io/qt-6/zh/qml-qtquick-controls-abstractbutton.html#pressAndHold-signal)**()

æ‰€ä»¥å¦‚æœæƒ³è¦å¤„ç†è¿™äº›ä¿¡å·ï¼Œå°±éœ€è¦åœ¨åˆ›å»º`Button`å¯¹è±¡çš„æ—¶å€™ï¼Œå†…éƒ¨åˆ›å»ºä¸€ä¸ªåä¸º`on<Signal>` çš„ä¿¡å·å¤„ç†ç¨‹åºã€‚`clicked` ä¿¡å·ï¼Œè¯¥ä¿¡å·åœ¨æŒ‰é’®è¢«ç‚¹å‡»æ—¶å‘å‡ºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¥æ”¶è¯¥ä¿¡å·çš„ä¿¡å·å¤„ç†ç¨‹åºåº”ä¸º`onClicked` ã€‚

### å±æ€§æ”¹å˜çš„ä¿¡å·å¤„ç†

å½“ QML å±æ€§çš„å€¼æ”¹å˜æ—¶ï¼Œä¿¡å·ä¼šè‡ªåŠ¨å‘å‡ºã€‚è¿™ç§ç±»å‹çš„ä¿¡å·æ˜¯*å±æ€§å˜åŒ–ä¿¡å·*ï¼Œè¿™äº›ä¿¡å·çš„å¤„ç†ç¨‹åºä»¥*on<Property>Changed* çš„å½¢å¼ç¼–å†™ï¼Œå…¶ä¸­*<Property>*æ˜¯å±æ€§åç§°ï¼Œç¬¬ä¸€ä¸ªå­—æ¯å¤§å†™ã€‚

ä¾‹å¦‚ï¼Œ[MouseArea](https://doc.qt.io/qt-6/zh/qml-qtquick-mousearea.html) ç±»å‹æœ‰ä¸€ä¸ª[pressed](https://doc.qt.io/qt-6/zh/qml-qtquick-mousearea.html#pressed-signal) å±æ€§ã€‚è¦åœ¨è¯¥å±æ€§å‘ç”Ÿå˜åŒ–æ—¶æ¥æ”¶é€šçŸ¥ï¼Œå¯ç¼–å†™ä¸€ä¸ªåä¸º`onPressedChanged` çš„ä¿¡å·å¤„ç†ç¨‹åº

## å†™ä¸€ä¸ªç•Œé¢å§

# 6.21

å¦‚éœ€è¿›ä¸€æ­¥å¸®ä½ ç”Ÿæˆ PA å‚æ•°è®¾ç½®å»ºè®®ï¼ˆå¦‚ `PA40`ã€`PA4`ã€`PA43`ç­‰ï¼‰ï¼Œè¯·å‘Šè¯‰æˆ‘å½“å‰ä½¿ç”¨çš„æ¨¡å¼ï¼ˆé€Ÿåº¦æ§åˆ¶ / è½¬çŸ©æ§åˆ¶ / ä½ç½®æ§åˆ¶ï¼‰ã€‚



ä»Šå¤©ä¸»è¦ä»»åŠ¡å°±æ˜¯è§£å†³æ¥¼ä¸‹æ°´æ± çš„è´Ÿè½½é—®é¢˜ã€‚

è´Ÿè½½ 27kg æ—¶ä¼ºæœç”µæœºå¯åŠ¨å›°éš¾æˆ–çªç„¶ä¸‹å ï¼Œè¿™æœ¬è´¨ä¸Šæ˜¯ç”µæœº**è¾“å‡ºåŠ›çŸ©ä¸è¶³**æˆ–**æ§åˆ¶å“åº”ä¸å½“**ã€‚

## ç”µæœºè½¬é€Ÿè®¡ç®—

### é½¿è½®è½¬é€Ÿæ¢ç®—ä¸ºç”µæœºè½¬é€Ÿ

> ç°åœ¨å·²çŸ¥ç”µæœºå¸¦åŠ¨é½¿è½®è½¬åŠ¨ï¼Œç”µæœºè½¬åŠ¨1åœˆï¼Œé½¿è½®è½¬åŠ¨10åœˆã€‚å¹¶ä¸”ç”µæœºç°åœ¨çš„é½¿è½®å¤–å¾„ä¸º44mmã€‚å¦‚æœå½“å‰é½¿è½®çš„è½¬é€Ÿä¸º40mm/sï¼Œé‚£ä¹ˆç”µæœºè½¬é€Ÿæ˜¯å¤šå°‘ï¼Ÿ

å·²çŸ¥æ¡ä»¶ï¼š

- **é½¿è½®åŠå¾„**ï¼š`r=22â€‰mm`
- **é½¿è½®çº¿é€Ÿåº¦**ï¼š`v=40â€‰mm`
- **ä¼ åŠ¨æ¯”**ï¼šç”µæœºè½¬10åœˆï¼Œé½¿è½®è½¬1åœˆï¼ˆå³ï¼šä¼ åŠ¨æ¯” `i=10`ï¼‰

æ­¥éª¤åˆ†è§£

1. æ±‚é½¿è½®çš„è§’é€Ÿåº¦

   é½¿è½®çš„çº¿é€Ÿåº¦ä¸è§’é€Ÿåº¦çš„å…³ç³»ä¸ºï¼š
   $$
   v=Ï‰â‹…r
   $$
   ä»£å…¥æ•°æ®ï¼š
   $$
   \omega_{\text{é½¿è½®}} = \frac{v}{r} = \frac{40}{22} \approx 1.818\,\text{rad/s}
   $$
   
2.  **æ¢ç®—é½¿è½®çš„è½¬é€Ÿï¼ˆrpmï¼‰**

   è½¬é€Ÿ`n`ä¸è§’é€Ÿåº¦çš„å…³ç³»ä¸ºï¼š
   $$
   n_{\text{é½¿è½®}} = \frac{\omega_{\text{é½¿è½®}} \cdot 60}{2\pi}
   $$

   $$
   n_{\text{é½¿è½®}} = \frac{1.818 \cdot 60}{2\pi} \approx \frac{109.1}{6.283} \approx 17.37\,\text{rpm}
   $$

   

3. æ ¹æ®ä¼ åŠ¨æ¯”æ±‚ç”µæœºè½¬é€Ÿ

   å› ä¸ºç”µæœºè½¬10åœˆï¼Œé½¿è½®æ‰è½¬1åœˆï¼Œæ‰€ä»¥ç”µæœºè½¬é€Ÿæ˜¯é½¿è½®çš„ 10 å€ï¼š
   $$
   n_{\text{ç”µæœº}} = n_{\text{é½¿è½®}} \cdot 10 \approx 17.37 \cdot 10 = 173.7\,\text{rpm}
   $$

### ä¸æ†é€Ÿåº¦æ¢ç®—ä¸ºç”µæœºè½¬é€Ÿ

> å·²çŸ¥ä¸æ†ç§»åŠ¨é€Ÿåº¦ä¸º 40â€¯mm/sï¼Œä¸æ†èºè·ä¸º 123â€¯mmï¼Œä¼ åŠ¨æ¯”ä¸º 12ï¼ˆç”µæœºè½¬12åœˆï¼Œä¸æ†è½¬1åœˆï¼‰ï¼Œæ±‚ç”µæœºçš„è½¬é€Ÿï¼ˆå•ä½ rpmï¼‰ã€‚

---

æ­¥éª¤åˆ†æ

1. **æ ¹æ®ä¸æ†èºè·è®¡ç®—ä¸æ†çš„è½¬é€Ÿ**

* **èºè·å®šä¹‰**ï¼šä¸æ†è½¬ 1 åœˆï¼Œç§»åŠ¨ 123â€¯mmã€‚
* å¦‚æœç§»åŠ¨é€Ÿåº¦æ˜¯ 40â€¯mm/sï¼Œé‚£ä¸æ†æ¯ç§’éœ€è¦è½¬å¤šå°‘åœˆï¼Ÿ

$$
n_{\text{ä¸æ†}} = \frac{\text{ç§»åŠ¨é€Ÿåº¦}}{\text{èºè·}} = \frac{40}{123} \approx 0.3252\,\text{è½¬/ç§’}
$$

æ¢æˆ rpmï¼ˆè½¬/åˆ†é’Ÿï¼‰ï¼š

$$
n_{\text{ä¸æ†}} = 0.3252 \times 60 \approx 19.51\,\text{rpm}
$$

---

2. **åˆ©ç”¨ä¼ åŠ¨æ¯”è®¡ç®—ç”µæœºè½¬é€Ÿ**

ä¼ åŠ¨æ¯” 12:1ï¼ˆç”µæœºè½¬12åœˆï¼Œä¸æ†è½¬1åœˆï¼‰ï¼š

$$
n_{\text{ç”µæœº}} = 12 \cdot n_{\text{ä¸æ†}} = 12 \cdot 19.51 \approx 234.1\,\text{rpm}
$$

3. æœ€ç»ˆç­”æ¡ˆï¼š

**ç”µæœºè½¬é€Ÿçº¦ä¸ºï¼š**
$$
\boxed{234.1\,\text{rpm}}
$$

## ç”µæœºè´Ÿè½½ä¸è½¬çŸ©å…³ç³»

### ç”µæœºå‹å·

ç”µæœºé“­ç‰Œå‚æ•°ï¼š

- **é¢å®šåŠŸç‡**ï¼šPn = 400W
- **é¢å®šè½¬çŸ©**ï¼šTn = 1.27 NÂ·m
- **é¢å®šç”µå‹**ï¼šUn = 220V
- **é¢å®šç”µæµ**ï¼šIn = 2.5A
- **å‹å·**ï¼šDB60-01330A1-Aï¼Œè½¬é€Ÿä¸º 3000 rpmï¼ˆä»ç”µæœºç¼–å·ä¸­å¯è§£ç å¾—å‡ºï¼‰

### ç”µæœºZ1é™æ€è´Ÿè½½è®¡ç®—

ç°åœ¨å·²çŸ¥çš„ç”µæœºZ1è´Ÿè´£å‚ç›´ä¸Šä¸‹çš„ä½ç½®ç§»åŠ¨ã€‚

- ç”µæœºå‹å·ï¼š`DB60-01330A1-A`ã€‚
- é½¿è½®å¤–å¾„ï¼š44mmï¼ˆåŠå¾„ä¸º22mmï¼‰
- ä¼ åŠ¨æ¯”ï¼š10ï¼ˆç”µæœºè½¬10åœˆï¼Œé½¿è½®è½¬1åœˆï¼‰

#### 1.è¾“å‡ºè½´æ‰­çŸ©è®¡ç®—ï¼ˆé½¿è½®ç«¯ï¼‰

- å·²çŸ¥ç”µæœºé¢å®šæ‰­çŸ©
  $$
  T_{\text{motorMax}} = 1.27\,\text{NÂ·m}
  $$
  
- ä¼ åŠ¨æ¯”`i=10`**â†’** è¾“å‡ºæ‰­çŸ©æ”¾å¤§10å€
  $$
  T_{\text{è¾“å‡º}} = T_{\text{ç”µæœº}} \times i \times \eta = 1.3 \times 10 \times 0.85 = 11.05 \, \text{Nm}
  $$

  > âš ï¸ **é½¿è½®æ•ˆç‡ Î·**ï¼šå–0.85ï¼ˆèœ—è½®èœ—æ†ï¼‰æˆ–0.95ï¼ˆè¡Œæ˜Ÿé½¿è½®ï¼‰ï¼Œæ­¤å¤„ä¿å®ˆä¼°è®¡0.85ã€‚

#### 2.é½¿è½®æ‹‰åŠ›è½¬æ¢ï¼ˆå¤–å¾„44mm â†’ åŠå¾„22mmï¼‰

$$
F_{\text{æ‹‰åŠ›}} = \frac{T_{\text{è¾“å‡º}}}{r} = \frac{11.05}{0.022} \approx 502.3 \, \text{N}
$$

å¯æ‰¿å—çš„è´Ÿè½½é‡é‡
$$
m_{\text{ç†è®º}} = \frac{F_{\text{æ‹‰åŠ›}}}{g} = \frac{502.3}{9.8} \approx 51.3 \, \text{kg}
$$

### Z1åŠ¨æ€è´Ÿè½½è®¡ç®—

ä¼ºæœç”µæœº `DB60-01330A1-A`ï¼Œé…å¥— `P100S` é©±åŠ¨å™¨ï¼Œåœ¨å¦‚ä¸‹å‰æä¸‹ï¼š

- **ä½ç½®æ§åˆ¶æ¨¡å¼**å’Œ**é€Ÿåº¦æ§åˆ¶æ¨¡å¼**ä¸‹
- ä»¥**æœ€å¤§ç”µæœºè½¬é€Ÿ 3000 rpm**
- é©±åŠ¨ä¸€ä¸ªé€šè¿‡**44mmé½¿è½® + 10:1å‡é€Ÿæ¯”**çš„è´Ÿè½½å‡é™æœºæ„
- è´Ÿè½½æœ€å¤§é‡é‡ä¸º40kg

è®¾ç½®åˆç†è®¾ç½®ä¼ºæœé©±åŠ¨å™¨å‚æ•° `PA40`ï¼ˆåŠ é€Ÿæ—¶é—´å¸¸æ•°ï¼Œå•ä½ï¼šmsï¼Œè¡¨ç¤º**ä» 0 åŠ é€Ÿåˆ° 1000 rpm**æ‰€ç”¨æ—¶é—´ï¼‰ï¼Œéœ€è¦ç¡®ä¿ï¼š

- ç”µæœº **ä¸ä¼šè¿‡è½½**
- å¸¦åŠ¨**40kg å‚ç›´è´Ÿè½½**ä¸ä¼šâ€œè·³åŠ¨â€æˆ–â€œä¸‹å â€
- å¯åœè¿‡ç¨‹**å¹³ç¨³**

---

#### ç¬¬ä¸€æ­¥ï¼šè´Ÿè½½äº§ç”Ÿçš„**é™æ€è½¬çŸ©**

è´Ÿè½½åŠåœ¨é½¿è½®ä¸Šï¼Œå¯¹è¾“å‡ºè½´äº§ç”Ÿé‡åŠ›è½¬çŸ©ï¼š

$$
T_{\text{load}} = m \cdot g \cdot r = 40 \cdot 9.8 \cdot 0.022 \approx 8.62\,\text{NÂ·m}
$$

æŠ˜ç®—åˆ°ç”µæœºè½´ï¼ˆå‡é€Ÿæ¯” 10:1ï¼‰ï¼š

$$
T_{\text{motor,static}} = \frac{8.62}{10} = 0.862\,\text{NÂ·m}
$$

ç”µæœºé¢å®šè½¬çŸ©ä¸º 1.27 NÂ·m â†’ é™æ€æƒ…å†µä¸‹æ˜¯**å®‰å…¨çš„**ã€‚

---

#### ç¬¬äºŒæ­¥ï¼šåŠ é€Ÿè¿‡ç¨‹äº§ç”Ÿçš„åŠ¨æ€é™„åŠ è½¬çŸ©

è¦è®¡ç®—åŠ é€Ÿè¿‡ç¨‹äº§ç”Ÿçš„é™„åŠ è½¬çŸ©ï¼š

$$
T_{\text{accel}} = \frac{J_{\text{load,eq}} \cdot \alpha}{\eta}
$$

ç®€åŒ–å»ºæ¨¡ï¼š**ç”¨åŠ›çŸ© = åŠ é€ŸåŠ› Ã— åŠ›è‡‚**ï¼ˆå¯¹ç”µæœºè½´ï¼‰

åŠ é€Ÿæ—¶é—´ (`PA40`)
$$
t_a
$$
 å†³å®šäº†çº¿åŠ é€Ÿåº¦ï¼š

* ç›®æ ‡è½¬é€Ÿ = 3000 rpm = 314 rad/s
* é½¿è½®è½´è½¬é€Ÿ = 300 rpm = 31.4 rad/s
* åŠ é€Ÿåº¦ï¼š

  $$
  \alpha = \frac{\omega}{t_a} = \frac{31.4}{t_a}
  $$

è½¬æˆç”µæœºè½´ï¼ˆåŠ å¿« 10 å€ï¼‰ â‡’ ç”µæœºè§’åŠ é€Ÿåº¦ï¼š

$$
\alpha_{\text{motor}} = \frac{314}{t_a}
$$

ç”¨è´Ÿè½½è´¨é‡m = 40 kgï¼Œåœ¨é½¿è½®åŠå¾„ r = 0.022 mï¼š

è½¬çŸ©éœ€æ±‚ï¼š

$$
T_{\text{accel}} = \frac{m \cdot r^2 \cdot \alpha_{\text{motor}}}{i^2}
= \frac{40 \cdot 0.022^2 \cdot \frac{314}{t_a}}{10^2}
\approx \frac{0.607}{t_a}
$$

---

#### ç¬¬ä¸‰æ­¥ï¼šæ€»è½¬çŸ© â‰¤ ç”µæœºé¢å®šè½¬çŸ©ï¼ˆ1.27NÂ·mï¼‰

$$
T_{\text{total}} = T_{\text{static}} + T_{\text{accel}} = 0.862 + \frac{0.607}{t_a} \leq 1.27
$$

è§£å¾—ï¼š

$$
\frac{0.607}{t_a} \leq 0.408 \Rightarrow t_a \geq \frac{0.607}{0.408} \approx 1.49\,\text{s}
$$

æ‰€ä»¥ï¼š**ç”µæœºä» 0 åŠ é€Ÿåˆ° 300 rpmï¼ˆè´Ÿè½½è½´ï¼‰è‡³å°‘éœ€è¦ 1.49 ç§’**

#### æœ€ç»ˆç»“è®ºï¼š`PA40` å»ºè®®è®¾ç½®ä¸ºï¼š

`PA40` æ§åˆ¶çš„æ˜¯â€œ**ç”µæœºä» 0 â†’ 1000 rpm** æ‰€éœ€æ—¶é—´ï¼ˆå•ä½ msï¼‰â€

3000 rpm çš„åŠ é€Ÿæ—¶é—´åº”ä¸ºï¼š
$$
t_{3000} = 3 \cdot PA40
$$

æ‰€ä»¥ä¸ºè¾¾åˆ° 1.5 ç§’çš„å®‰å…¨åŠ é€Ÿæ—¶é—´ï¼š

$$
PA40 = \frac{1500}{3} = \boxed{500\,\text{ms}}
$$
ä¼ºæœç”µæœºæ”¯æŒçŸ­æ—¶é—´è¿‡è½½ 2ï½3 å€ â‡’ ç”µæœºæœ€å¤§ç¬æ—¶è½¬çŸ©å¯èƒ½é«˜è¾¾ **2.5ï½3 NÂ·m**ã€‚ä¹Ÿå¯ä»¥å¯¹åŠå¤„ç†ã€‚

æ¨èå€¼ï¼š

| å‚æ•°   | å»ºè®®å€¼ | è¯´æ˜                      |
| ------ | ------ | ------------------------- |
| `PA40` | `500`  | åŠ é€Ÿæ—¶é—´å¸¸æ•°ï¼ˆ0â†’1000rpmï¼‰ |
| `PA41` | `500`  | å‡é€Ÿæ—¶é—´å¸¸æ•°ï¼ˆ1000-0rpmï¼‰ |
| `PA42` | `100`  | S å‹åŠ å‡é€Ÿæ›²çº¿å¹³æ»‘æ—¶é—´    |

å¦‚è´Ÿè½½æ‘†åŠ¨æˆ–æƒ¯é‡å¤§ï¼Œè¿˜å¯ä»¥è®¾ä¸º 600\~800msï¼Œæé«˜ç¨³å®šæ€§ã€‚ç°åœ¨ä¸ºäº†ç¨³å®šï¼Œç»Ÿä¸€è®¾ç½®ä¸º1000msï¼Œå¹¶ä¸”PA42è®¾ç½®ä¸º200ms

# 6.23

ä»Šå¤©ä»»åŠ¡å°±æ˜¯ï¼ŒæŠŠpspè°ƒè¯•å®Œæ¯•åï¼Œå»æ°´æ± æµ‹è¯•ã€‚

ç°åœ¨ç•™å­˜çš„é—®é¢˜å°±æ˜¯pspç‚¹åŠ¨çš„æ—¶å€™ï¼Œä¼šæŠ¥é”™ã€‚

## pspç‚¹åŠ¨é”™è¯¯

ç°åœ¨ç”±äºåŠ ä¸Šäº†ç‚¹åŠ¨æ—¶å€™ï¼Œå°†é™¤äº†å½“å‰ç”µæœºä¹‹å¤–çš„æ‰€æœ‰ç”µæœºçš„åˆ¹è½¦DOåŠŸèƒ½æ›¿æ¢æ‰çš„å‘½ä»¤ã€‚å¯¼è‡´è“ç‰™å‡ºé—®é¢˜äº†ã€‚ç°åœ¨å…·ä½“åˆ†æé—®é¢˜ã€‚

### é—®é¢˜æè¿°

ç”µæœºä½¿èƒ½çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æ‰“å¼€ç”µç£åˆ¶åŠ¨å™¨ï¼Œè®©ç”µæœºæ­£å¸¸è¿è¡Œã€‚

X1ã€X2ç”µæœºï¼ˆ`M_X1`å’Œ`M_X2`ï¼‰ç‚¹åŠ¨è¿è¡Œä¹‹å‰ï¼Œä¼šé€šè¿‡å¹¿æ’­(`M_ALL`ä»£è¡¨çš„æ˜¯æ‰€æœ‰ç”µæœº)å…ˆå°†å…¶ä»–ç”µæœºçš„åˆ¹è½¦DOå£åŠŸèƒ½å±è”½æ‰ã€‚ç„¶åæ¢å¤X1å’ŒX2çš„åˆ¹è½¦DOã€‚

è€Œå…¶ä»–ç”µæœºè¿è¡Œçš„æ—¶å€™ï¼Œä¼šé‡æ–°æ¢å¤æ‰€æœ‰ç”µæœºçš„åˆ¹è½¦DOã€‚

ç”µæœºçš„åˆ¹è½¦DOåŠŸèƒ½ï¼Œæ˜¯ç”±`P3_21`ä»£è¡¨çš„æ•°å­—è¾“å‡º DO2 æ§åˆ¶çš„ã€‚å…¶å€¼å«ä¹‰ä¸ºï¼š

- `P3_21 = 8`ï¼šåˆ¹è½¦åŠŸèƒ½
- `P3_21 = 0`ï¼šæ— ä»»ä½•åŠŸèƒ½

ä»£ç å¦‚ä¸‹ï¼šï¼ˆåœ¨`enableJogServo()`ä¸­ï¼‰

```C++
if(motorID == M_ALL){
    clearBrakeDOConfig(motorID); // P3_21 = 0
    restoreBrakeDOConfig(M_X1);	// P3_21 = 8
    restoreBrakeDOConfig(M_X2);
} else {
    restoreBrakeDOConfig(M_ALL);
}
```

æ‰€ä»¥å½“æˆ‘ä½¿ç”¨Z2ç”µæœºç‚¹åŠ¨ï¼Œä¼šèµ°å¹¿æ’­æ¢å¤æ‰€æœ‰ç”µæœºçš„åˆ¹è½¦DOè¿™ä¸ªé€»è¾‘

```C++
restoreBrakeDOConfig(M_ALL);
```

ä½†æ˜¯æ­¤æ—¶å°±å‡ºé—®é¢˜äº†ã€‚æˆ‘æ‰§è¡ŒZ2ç”µæœºç‚¹åŠ¨ï¼Œä¼šå‡ºç°å¡é¡¿å¹¶ä¸”ç‚¹åŠ¨ç§»åŠ¨ä¸ç”Ÿæ•ˆçš„æƒ…å†µã€‚å…·ä½“æ—¥å¿—å¦‚ä¸‹ï¼š

```BASH
INFO  2025-06-23T09:28:24.750 "getLocation: ç”µæœº[Z2]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º-1790107" 
INFO  2025-06-23T09:28:24.750 "getLocation: ç”µæœº[Z2]å½“å‰ä½ç½®ä¸º (188.787) mm " 
INFO  2025-06-23T09:28:24.859 "ç”µæœº[Z2]è½¬é€Ÿä¸º(54)mm/s" 
INFO  2025-06-23T09:28:26.949 "ç”µæœºZ2ç‚¹åŠ¨æ§åˆ¶ï¼Œæ–¹å‘=1" 
INFO  2025-06-23T09:28:27.057 "ç”µæœº5å†™å…¥æˆåŠŸ,16(287,2)" 
INFO  2025-06-23T09:28:27.118 "ç”µæœº5å†™å…¥æˆåŠŸ,16(287,10)" 
INFO  2025-06-23T09:28:27.184 "getLocation: ç”µæœº[Z2]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º-1790106" 
INFO  2025-06-23T09:28:27.185 "getLocation: ç”µæœº[Z2]å½“å‰ä½ç½®ä¸º (188.787) mm " 
ERROR 2025-06-23T09:28:32.280 "è“ç‰™å†™è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†æœªæ”¶åˆ°å›åº”." 
ERROR 2025-06-23T09:28:32.281 "ç”µæœº-1å†™å…¥å¤±è´¥,16(277,8)" 
ERROR 2025-06-23T09:28:32.281 "é…ç½®[å…¨éƒ¨]ç”µæœºDOåˆ¹è½¦åŠŸèƒ½å¤±è´¥ï¼" 
INFO  2025-06-23T09:28:32.339 "ç”µæœº5å†™å…¥æˆåŠŸ,16(53,1)" 
INFO  2025-06-23T09:28:32.344 "è¡Œè½¦ç‚¹åŠ¨è¿åŠ¨çŠ¶æ€æ£€æŸ¥çº¿ç¨‹å¯åŠ¨" 
WARN  2025-06-23T09:28:32.444 "è¿™ä¸æ˜¯ä¸ªæ­£ç¡®çš„æµç¨‹" 
INFO  2025-06-23T09:28:32.501 "ç”µæœº5å†™å…¥æˆåŠŸ,16(53,0)" 
INFO  2025-06-23T09:28:32.553 "ç”µæœº5å†™å…¥æˆåŠŸ,16(287,2)" 
INFO  2025-06-23T09:28:32.553 "ç”µæœºZ2ç‚¹åŠ¨åœæ­¢" 
INFO  2025-06-23T09:28:32.554 "è¡Œè½¦ç‚¹åŠ¨è¿è¡Œç»“æŸ." 
INFO  2025-06-23T09:28:32.555 "è¡Œè½¦æ£€æŸ¥çº¿ç¨‹æ­£å¸¸é€€å‡º" 
INFO  2025-06-23T09:28:32.609 "getLocation: ç”µæœº[Z2]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º-1816922" 
INFO  2025-06-23T09:28:32.609 "getLocation: ç”µæœº[Z2]å½“å‰ä½ç½®ä¸º (191.615) mm " 
```

å¯ä»¥å‘ç°ï¼Œå‘é€å¹¿æ’­é…ç½®DO2çš„æ—¶å€™ï¼Œå‡ºç°äº†â€œ**è“ç‰™å†™è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†æœªæ”¶åˆ°å›åº”**â€çš„é—®ã€‚

### é—®é¢˜åˆ†æ

å› ä¸ºç”µæœºå¹¿æ’­çš„æ—¶å€™

æ—¢ç„¶å¹¿æ’­ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œé‚£å°±ç ”ç©¶ä¸‹è®©è“ç‰™å‘é€å¹¿æ’­çš„æ—¶å€™ï¼Œä¸ç”¨æ¥æ”¶å›åº”ã€‚ç›´æ¥åœ¨è“ç‰™å‘é€æ•°æ®é‚£è¾¹å¤„ç†å³å¯è§£å†³é—®é¢˜ã€‚

## æ€¥åœå’Œä½ç½®æ£€æµ‹çš„å†²çª

### é—®é¢˜æè¿°

> ç°åœ¨qtæœ‰ä¸ªéœ€æ±‚ï¼Œæè¿°å¦‚ä¸‹ï¼šè¿™ä¸ªqtä»£ç æ˜¯ä¸ºäº†æ§åˆ¶ç”µæœºä½ç½®ç§»åŠ¨çš„ ä½†æ˜¯ç°åœ¨å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼š 
>
> 1. ä½ç½®ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä»£ç ä¼šè¿›å…¥checkMoveçš„æ£€æŸ¥ä½ç½®ç§»åŠ¨çš„çº¿ç¨‹ä¸­
>
>   ```C++
>   m_checkWoker = new QThread;
>   connect(m_checkWoker, &QThread::started, this, &MotorCtrl::checkMove); 
>   ```
>
> 2. åœ¨æ£€æŸ¥çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œæ¯100msæ£€æµ‹å½“å‰ç”µæœºä½ç½®çš„æ£€æµ‹å‡½æ•°    
>
>   ```C++
>   do{        // çº¿ç¨‹æš‚åœ100æ¯«ç§’        QThread::msleep(100); 	
>   ```
> 3. å¦‚æœæ£€æµ‹è¿‡ç¨‹ä¸­æˆ‘æŒ‰äº†æ€¥åœæŒ‰é’®ï¼Œè°ƒç”¨äº†å‡½æ•°`on_stopBt_clicked()` è¿™ä¸ªæ—¶å€™ä¼šåœæ­¢æ‰€æœ‰ç”µæœºä½¿èƒ½ã€‚æ­¤æ—¶æ£€æµ‹ä½ç½®çš„è¯·æ±‚å°±ä¼šè¯»è¶…æ—¶ï¼Œå¯¼è‡´è¯»ä¸å‡ºæ•°æ®æ¥ã€‚ 
>
>   ```bash
>   ERROR 2025-06-23T14:10:05.084 "modbusè¯»è¶…æ—¶" "[modbusID=2, regtype=4, startReg=4120, stopReg=4123]"  
>   INFO  2025-06-23T14:10:05.084 "getLocation: ç”µæœº[X2]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º(0)pulse"  
>   INFO  2025-06-23T14:10:05.084 "getLocation: ç”µæœº[X2]å½“å‰ä½ç½®ä¸º (0) mm "
>   ```
>
>
>   ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€ç¬é—´è¿™å‡ ä¸ªæ“ä½œå¯èƒ½åŒæ—¶è¿›è¡Œäº†ã€‚  ç°åœ¨æƒ³è®©ä½ å¸®æˆ‘è€ƒè™‘ä¸‹ï¼Œå¦‚ä½•åœ¨æ£€æµ‹ä½ç½®çš„è¿‡ç¨‹ä¸­ï¼Œä¼˜å…ˆè¿›è¡Œæ€¥åœçš„é€»è¾‘å‘¢ï¼Ÿ

æ€»ç»“ä¸ºï¼š

> **ä½ç½®æ£€æµ‹çº¿ç¨‹ï¼ˆcheckMoveï¼‰åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ­¤æ—¶æ‰§è¡Œäº†æ€¥åœï¼ˆon_stopBt_clickedï¼‰ï¼Œä¼šå› ä¸ºç”µæœºå·²ç»æ–­ä½¿èƒ½ï¼Œå¯¼è‡´ä½ç½®è¯»å–è¶…æ—¶ï¼Œçº¿ç¨‹å¡ä½ï¼Œè¿›è€Œå½±å“ç¨‹åºé€»è¾‘ã€‚**

### ç›®æ ‡ğŸ¯

ä¸€æ—¦è§¦å‘æ€¥åœï¼Œä½ç½®æ£€æµ‹çº¿ç¨‹æš‚åœæ£€æµ‹ä½ç½®ï¼ˆä¸æŠ¥é”™ä¹Ÿä¸é€€å‡ºï¼‰ï¼›å¾…æ€¥åœæ“ä½œå®Œæ¯•åï¼Œä½ç½®æ£€æµ‹è‡ªåŠ¨ç»§ç»­ã€‚

- æ€¥åœæ—¶æš‚åœä½ç½®æ£€æµ‹ï¼ˆè€Œéç»ˆæ­¢çº¿ç¨‹æˆ–é€€å‡ºå¾ªç¯ï¼‰
-  æ€¥åœç»“æŸåè‡ªåŠ¨æ¢å¤ä½ç½®æ£€æµ‹
-  æ‰€æœ‰æ“ä½œçº¿ç¨‹å®‰å…¨ï¼Œä¸å¡æ­»ã€ä¸å†²çª

### è§£å†³æ–¹æ¡ˆ

ç®€æ´æ–¹æ¡ˆï¼š`std::atomic<bool> + è½®è¯¢ + sleep`ã€‚

åœ¨MotorCtrlä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„åŸå­å˜é‡ `m_emergencyStop` æ§åˆ¶æ£€æµ‹é€»è¾‘ã€‚

#### 1.å¤´æ–‡ä»¶

```C++
#include <atomic>

std::atomic<bool> m_emergencyStop = false;
```

#### 2.åœ¨æ€¥åœå‡½æ•°ä¸­è®¾ç½®æ ‡å¿—

```C++
void MotorCtrl::on_stopBt_clicked()
{
    m_emergencyStop = true;
    disableAllMotors(); // åŸæœ‰é€»è¾‘
    m_emergencyStop = false;
}
```

#### 3.åœ¨ `checkMove()` æ£€æµ‹çº¿ç¨‹ä¸­åŠ å…¥ç­‰å¾…æœºåˆ¶

```C++
void MotorCtrl::checkMove()
{
    while (true) {
        // å¦‚æœæ˜¯æ€¥åœçŠ¶æ€ï¼Œåˆ™ç­‰å¾…æ¢å¤
        while (m_emergencyStop) {
            QLOG_WARN() << "æ£€æµ‹çº¿ç¨‹æš‚åœä¸­ï¼ˆæ€¥åœä¸­ï¼‰...";
            QThread::msleep(200);  // ç­‰å¾…è§£é™¤æ€¥åœï¼Œé¿å…å ç”¨CPU
        }

        // æ‰§è¡Œä½ç½®è¯»å–
        bool success = readMotorPosition();
        if (!success) {
            QLOG_ERROR() << "ä½ç½®è¯»å–å¤±è´¥";
            // å¯æ ¹æ®æƒ…å†µé€‰æ‹© continue / break / log åå†ç»§ç»­
        }

        // æ¯100msæ£€æµ‹ä¸€æ¬¡
        QThread::msleep(100);
    }
}
```

æœ€ç»ˆæœ¬æè®®æ²¡æœ‰é‡‡çº³ã€‚å› ä¸ºæˆ‘å‘ç°æ˜¯ä½ç½®è·å–é”™è¯¯ï¼Œå¯èƒ½éœ€è¦åœ¨è·å–ä½ç½®çš„éƒ¨åˆ†æ·»åŠ è¿™ä¸ªç­‰å¾…é€»è¾‘ã€‚

# 6.24

- [x] è§£å†³å®‰å“ç•Œé¢å±•ç¤ºé”™è¯¯é—®é¢˜
- [ ] è§£å†³æ‘‡æ†æ²¡è¿›å…¥ç•Œé¢å´èƒ½æ“ä½œä½¿èƒ½çš„é—®é¢˜

## æ‘‡æ†æ§åˆ¶

ç°åœ¨é—®é¢˜æ˜¯ï¼Œåœ¨è¿˜æ²¡è¿›å…¥ä¸»ç•Œé¢çš„æ—¶å€™ï¼Œå¦‚æœæ­¤æ—¶ä½¿ç”¨æ‘‡æ†ï¼Œå°±èƒ½æ§åˆ¶ç”µæœºç§»åŠ¨ã€‚æ­¤æ“ä½œéå¸¸å±é™©ï¼Œéœ€è¦åˆ¤æ–­åœ¨æ²¡æœ‰è¿›å…¥ä¸»ç•Œé¢çš„æ—¶å€™ï¼Œç¦ç”¨æ‘‡æ†æ“ä½œé€»è¾‘ã€‚

### ä¿¡å·æ³¨å†Œ

ç°åœ¨æ‘‡æ†ä¸ç”µæœºæ§åˆ¶é€»è¾‘æ˜¯é€šè¿‡`main.cpp`ä¸­çš„æ§½å‡½æ•°è¿›è¡Œè¿æ¥çš„

```C++
int main(int argc, char *argv[]) {
    ...
	InputManager inputManager;
    MotorCtrl *mc = MotorCtrl::get_instance();
    QObject::connect(&inputManager,
                     &InputManager::joyForwardMoveStart,
                     mc, &MotorCtrl::on_actionUpRightFrontBt_pressed);
    QObject::connect(&inputManager,
                     &InputManager::joyForwardMoveEnd,
                     mc, &MotorCtrl::on_actionUpRightFrontBt_released);
    QObject::connect(&inputManager,
                     &InputManager::joyBackwardMoveStart,
                     mc, &MotorCtrl::on_actionDownLeftBackBt_pressed);
    QObject::connect(&inputManager,
                     &InputManager::joyBackwardMoveEnd,
                     mc, &MotorCtrl::on_actionDownLeftBackBt_released);
    QObject::connect(&inputManager, &InputManager::joystickEvent,
        [](const QString& axisKey, Direction dir) {
            qDebug().nospace() << "[" << QDateTime::currentDateTime().toString("hh:mm:ss.zzz")
                             << "] " << axisKey
                             << " â†’ " << InputManager::directionToString(dir);
        });
    ...
}
```

æˆ‘åœ¨è€ƒè™‘ï¼Œæ˜¯å¦å•ç‹¬å†™ä¸€ä¸ªç±»ï¼Œä¸“é—¨è´Ÿè´£æ‘‡æ†å’Œç”µæœºæ§åˆ¶çš„è¿æ¥å’Œæ–­å¼€ã€‚è¿™æ ·åœ¨åœºæ™¯ä¸‹ï¼š

- ç¨‹åºå¯åŠ¨å‰ï¼ˆç™»å½•ç•Œé¢ï¼‰ç¦æ­¢æ‘‡æ†æ§åˆ¶ç”µæœº
- ç™»å½•æˆåŠŸè¿›å…¥ä¸»ç•Œé¢åï¼Œå¯ç”¨æ‘‡æ†æ§åˆ¶ç”µæœº
- åœ¨ä¸»ç•Œé¢å¼¹çª—å¼¹å‡ºæˆ–ç•Œé¢åˆ‡æ¢æ—¶ï¼Œä¸´æ—¶ç¦ç”¨æ‘‡æ†æ§åˆ¶å¼¹çª—å…³é—­åé‡æ–°å¯ç”¨æ‘‡æ†æ§åˆ¶
- å¼¹çª—å…³é—­åé‡æ–°å¯ç”¨æ‘‡æ†æ§åˆ¶

### åˆ›å»ºæ‘‡æ†å¯ç”¨ç±»

åˆ›å»º`JoystickControllerManager`ç±»ä¸“é—¨è´Ÿè´£æ‘‡æ†å¯ç”¨å’Œåœæ­¢çš„é€»è¾‘ã€‚å¹¶ä¸”ç™»å½•éªŒè¯å‡½æ•°ä¸­ä¸´æ—¶åˆ›å»ºäº†è¿™ä¸ªç±»è¿›è¡Œæ‘‡æ†åŠŸèƒ½è¿æ¥ã€‚

```C++
explicit JoystickControllerManager(InputManager *inputManager,
                                       MotorCtrl *motorCtrl,
                                       QObject *parent = nullptr);
void enable();   // å»ºç«‹è¿æ¥
void disable();  // æ–­å¼€è¿æ¥
bool isEnabled() const { return m_connected; }
```

ä½†æ˜¯å°½ç®¡æ—¥å¿—ä¸­æç¤ºâ€œæ‘‡æ†åŠŸèƒ½å·²ç»å¯ç”¨â€ï¼Œä½†å®é™…ä¸Šæ‘‡æ†æ§åˆ¶ä¾æ—§æ²¡æœ‰ç”Ÿæ•ˆã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå’Œä¿¡å·è¿æ¥ä½œç”¨åŸŸå¤±æ•ˆé—®é¢˜ã€‚

## Qtå±€éƒ¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ

```Cpp
// ä½ åœ¨ LoginWindow ç™»å½•æˆåŠŸåè¿™æ ·åšï¼š
InputManager inputManager;  // âœ… å±€éƒ¨å˜é‡ï¼ˆå‡½æ•°é€€å‡ºåè¢«é”€æ¯ï¼‰
MotorCtrl *mc = MotorCtrl::get_instance();
JoystickControllerManager joystickMgr(&inputManager, mc);  // âœ… ä¹Ÿæ˜¯å±€éƒ¨å˜é‡
joystickMgr.enable();
```

- è¿™äº›å¯¹è±¡éƒ½åªåœ¨ç™»å½•éªŒè¯å‡½æ•°ä¸­ä¸´æ—¶åˆ›å»ºã€‚
- å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå®ƒä»¬å°±**è‡ªåŠ¨ææ„é”€æ¯**äº†ã€‚
- è™½ç„¶ `joystickMgr.enable()` è¿æ¥äº†ä¿¡å·ï¼Œä½† **è¿æ¥çš„å¯¹è±¡é©¬ä¸Šå°±ä¸å­˜åœ¨äº†**ï¼Œæ‰€ä»¥æ‘‡æ†åŠŸèƒ½ä¹Ÿéšä¹‹å¤±æ•ˆã€‚

### è§£å†³æ€è·¯

1. **ä¸è¦åœ¨ LoginWindow ä¸­ä¸´æ—¶ new æˆ–å£°æ˜ `InputManager` æˆ– `JoystickControllerManager`**
2. æŠŠå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå»¶é•¿åˆ°ä¸»ç¨‹åºç»“æŸï¼ˆæœ€å¥½æ”¾åœ¨ main æˆ– MainWindow é‡Œï¼‰
3. ç™»å½•çª—å£åªè´Ÿè´£â€œå‘å‡ºä¿¡å·â€ï¼Œä¸»çª—å£æˆ– main è´Ÿè´£â€œå¯ç”¨æ‘‡æ†â€

### è§£å†³æ–¹æ³•

ç°æœ‰çš„ `main.cpp â†’ MainWindow â†’ CenterWindow â†’ LoginWindow` ç»“æ„ä¸ºï¼š

```C++
// main.cpp
int main(int argc, char *argv[])
{
	...
	MainWindow w;
	...
}

// MainWindow
MainWindow::MainWindow(QWidget *parent)
    : FMainWindow(parent)
{
    init_UI();
}


void MainWindow::init_UI()
{
    ...
    centerWindow = new CenterWindow;
    setCentralWidget(centerWindow);
    ...
}

// centerWindow
CenterWindow::CenterWindow(QWidget *parent) :
    FCenterWindow(parent)
{
    init_UI();
}

void CenterWindow::init_UI() {
    ...
    if(DbCtrl::m_systemInfo_tb.mode){
        UserManager *usr = new UserManager(this);
        bc->setUserManager(usr);
        mc->setUserManager(usr);
        m_loginWindow = new LoginWindow(this);
        addWidget(tr("ç³»ç»Ÿç™»å½•"), "login", m_loginWindow);
    ...
}
```

éå¸¸å¥½ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥**åŸºäºä½ ç°æœ‰çš„ `main.cpp â†’ MainWindow â†’ CenterWindow â†’ LoginWindow` ç»“æ„**ï¼Œç»™å‡ºä¸€ä¸ª **å®Œæ•´çš„ã€å®‰å…¨çš„æ‘‡æ†æ§åˆ¶æƒé™ç®¡ç†æ–¹æ¡ˆ**ï¼Œç¡®ä¿ï¼š

1. **æ‘‡æ†æ§åˆ¶å™¨ä¸è¢«æå‰é”€æ¯**ï¼ˆä¿è¯ä½œç”¨åŸŸï¼‰
2. **ç™»å½•æˆåŠŸåæ‰å¯ç”¨æ‘‡æ†**
3. **ä»£ç ç»“æ„æ¸…æ™°ã€ç¬¦åˆä½ å½“å‰çš„æ¶æ„**

------

### æ€»ä½“æ–¹æ¡ˆï¼ˆåˆ†ä¸‰æ­¥ï¼‰

#### æ­¥éª¤ 1ï¼šåœ¨ `main.cpp` ä¸­åˆ›å»º InputManager å’Œ JoystickControllerManagerï¼Œå¹¶ä¼ å…¥ MainWindow

```cpp
// main.cpp
int main(int argc, char *argv[])
{
    SQApplication a(argc, argv);

    // é˜²é‡å¤å¯åŠ¨ã€è®¾ç½®æ—¥å¿—ç­‰ ...
    QLockFile *lockfile = new QLockFile("servo.lock");
    if(!lockfile->tryLock(2000)){
        QMessageBox::critical(nullptr, "é”™è¯¯", "é‡å¤å¯åŠ¨ç¨‹åº", QMessageBox::Cancel);
        return -1;
    }

    setupFileLogging();
    DbCtrl::DbIint(0);

    // 1ï¸âƒ£ åˆ›å»º InputManagerã€MotorCtrl å’Œ JoystickControllerManager
    InputManager *inputManager = new InputManager;
    MotorCtrl *motorCtrl = MotorCtrl::get_instance();
    JoystickControllerManager *joystickMgr = new JoystickControllerManager(inputManager, motorCtrl);

    // 2ï¸âƒ£ åˆ›å»ºä¸»çª—å£å¹¶ä¼ å…¥ joystickMgr
    MainWindow w;
    w.setJoystickManager(joystickMgr);

    // 3ï¸âƒ£ å¯åŠ¨çª—å£
    w.showSL();
    return a.exec();
}
```

------

#### æ­¥éª¤ 2ï¼šåœ¨ `MainWindow` ä¸­æ¥æ”¶å¹¶è½¬å‘ joystickMgr ç»™ CenterWindow

`mainwindow.h`ï¼š

```cpp
class MainWindow : public FMainWindow {
    ...
public:
    void setJoystickManager(JoystickControllerManager *mgr);
private:
    JoystickControllerManager *m_joystickMgr = nullptr;
};
```

`mainwindow.cpp`ï¼š

```cpp
void MainWindow::setJoystickManager(JoystickControllerManager *mgr)
{
    m_joystickMgr = mgr;
    if (centerWindow) {
        centerWindow->setJoystickManager(mgr);
    }
}
```

------

#### æ­¥éª¤ 3ï¼šåœ¨ `CenterWindow` ä¸­è®¾ç½® joystickMgrï¼Œå¹¶ä¼ ç»™ `LoginWindow`

`centerwindow.h`ï¼š

```cpp
class CenterWindow : public FCenterWindow {
public:
    void setJoystickManager(JoystickControllerManager *mgr);
private:
    JoystickControllerManager *m_joystickMgr = nullptr;
};
```

`centerwindow.cpp`ï¼š

```cpp
void CenterWindow::setJoystickManager(JoystickControllerManager *mgr)
{
    m_joystickMgr = mgr;
    if (m_loginWindow) {
        m_loginWindow->setJoystickManager(mgr);
    }
}
```

------

æ­¥éª¤ 4ï¼šåœ¨ `LoginWindow` ä¸­æŒæœ‰ joystickMgrï¼Œå¹¶åœ¨ç™»å½•æˆåŠŸæ—¶å¯ç”¨æ‘‡æ†

`loginwindow.h`ï¼š

```cpp
class LoginWindow : public QWidget {
    Q_OBJECT
public:
    void setJoystickManager(JoystickControllerManager *mgr);

signals:
    void loginSuccess();  // å·²æœ‰æˆ–éœ€è¦æ·»åŠ 

private:
    JoystickControllerManager *m_joystickMgr = nullptr;
};
```

`loginwindow.cpp`ï¼š

```cpp
void LoginWindow::setJoystickManager(JoystickControllerManager *mgr)
{
    m_joystickMgr = mgr;
}
```

#### ç™»å½•æˆåŠŸå¤„ç†ä»£ç ï¼š

```cpp
void LoginWindow::on_loginBtn_clicked()
{
    QString usr = usrName_le->text();
    QString pwd = pwd_le->text();

    if (check_password(usr, pwd)) {
        emit em_login(usr);  // ä½ çš„å·²æœ‰ä¿¡å·
        QLOG_INFO() << "ç”¨æˆ·-" << usr << "-ç™»å½•æˆåŠŸ";

        if (m_joystickMgr) {
            m_joystickMgr->enable();  // âœ… å¯ç”¨æ‘‡æ†æ§åˆ¶
            QLOG_INFO() << "JoystickController â” æ‘‡æ†åŠŸèƒ½å·²ç»å¯ç”¨ï¼";
        }

        emit loginSuccess();  // å¦‚éœ€é€šçŸ¥å¤–éƒ¨å…³é—­ç™»å½•ç•Œé¢
    } else {
        QMessageBox::warning(this, "ç™»å½•å¤±è´¥", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
}
```

------

### æ€»ç»“æ¶æ„å›¾ï¼š

```
main.cpp
 â””â”€â”€ MainWindow
     â””â”€â”€ CenterWindow
         â””â”€â”€ LoginWindow

JoystickControllerManager
 â””â”€â”€ ç”Ÿå‘½å‘¨æœŸç”± main.cpp æ§åˆ¶
 â””â”€â”€ è¢« LoginWindow ä½¿ç”¨
```

------

### ğŸš€ æœ€ç»ˆæ•ˆæœ

| é˜¶æ®µ     | çŠ¶æ€                           |
| -------- | ------------------------------ |
| å¯åŠ¨å‰   | æ‘‡æ†æœªå¯ç”¨                     |
| ç™»å½•ç•Œé¢ | ç”¨æˆ·éªŒè¯å¯†ç                    |
| ç™»å½•æˆåŠŸ | `joystickMgr->enable()` è¢«è°ƒç”¨ |
| ç™»å½•å¤±è´¥ | ä¸å¯ç”¨æ‘‡æ†                     |

------



## é€€å‡ºç™»å½•è¿˜èƒ½ç»§ç»­ä½¿ç”¨æ‘‡æ†

ç°åœ¨é€šè¿‡ä¸Šä¸€æ­¥éªŒè¯ç™»å½•æ‰èƒ½æ§åˆ¶ç”µæœºï¼Œä½†æ˜¯ç°åœ¨é€€å‡ºåç”µæœºä¾æ—§èƒ½æ­£å¸¸ä½¿ç”¨ã€‚é€€å‡ºç”µæœºçš„é€»è¾‘ä¸º

```C++
// MotorCtrl
void MotorCtrl::setUserManager(UserManager *m)
{
    m_userManager = m;
    connect(m_user, &QPushButton::clicked, this, [=](){
       m_userManager->selfCfgDlg(m_user->text(), true);
    });
}

// UserManager
void UserManager::selfCfgDlg(const QString &username, const bool isLogin) 
{
    ....
    emit em_logout();
}
```

éœ€æ±‚æ˜¯ï¼š

- ç”¨**ä¿¡å·æœºåˆ¶**æ•æ‰ç™»å½•æˆåŠŸå’Œç™»å‡ºäº‹ä»¶
- ç™»å½•ä¿¡å·åœ¨ `LoginWindow` çš„ `em_login(QString username)` ä¿¡å·é‡Œå‘å‡º
- ç™»å‡ºä¿¡å·åœ¨ `UserManager` çš„ `em_logout()` ä¿¡å·é‡Œå‘å‡º
- ä¸»ç•Œé¢æ®æ­¤åšæ‘‡æ†æ§åˆ¶çš„å¯ç”¨ä¸ç¦ç”¨ï¼ŒåŠç•Œé¢åˆ‡æ¢æ§åˆ¶

å¹¶ä¸”è¿˜éœ€è¦æ³¨æ„ï¼Œç®¡ç†çš„`UserManager`å¯¹è±¡è¦ç»Ÿä¸€ã€‚

# 6.25

## å¼¹çª—ç¦ç”¨æ‘‡æ†

### é—®é¢˜

åœ¨ç”µæœºç•Œé¢ä¸­ï¼Œä¼šç»å¸¸å‡ºç°å¼¹çª—ï¼Œæç¤ºå½“å‰çŠ¶æ€ã€‚ä¾‹å¦‚ï¼š

```C++
SMessageBox::sQdialogBoxOk(this, QMessageBox::Critical,QString("ä¸‹å‘ç”µæœº%1ç‚¹åŠ¨é…ç½®å¤±è´¥").arg(DbCtrl::s_motorNameList.at(motorID)));
```

æ­¤æ—¶ä¸ºå®‰å…¨ä¸ç¨³å®šæ€§ï¼Œåº”ä¸´æ—¶ç¦ç”¨æ‘‡æ†æ§åˆ¶ï¼ˆé˜²æ­¢è¯¯è§¦/å†²çªï¼‰ã€‚ å¼¹çª—å…³é—­åå†æ¢å¤æ§åˆ¶ã€‚

ç°åœ¨ç¦æ­¢æ‘‡æ†å’Œå¯ç”¨æ‘‡æ†çš„æ–¹æ³•åœ¨ç±»`JoystickControllerManager`ä¸­ï¼Œå…¶å¤´æ–‡ä»¶ä¸º

```C++
#ifndef JOYSTICKCONTROLLERMANAGER_H
#define JOYSTICKCONTROLLERMANAGER_H

#include <QObject>
#include "inputmanager.h"
#include "motorCtrl.h"

class JoystickControllerManager : public QObject
{
    Q_OBJECT
public:
    explicit JoystickControllerManager(InputManager *inputManager,
                                       MotorCtrl *motorCtrl,
                                       QObject *parent = nullptr);
    void enable();   // å»ºç«‹è¿æ¥
    void disable();  // æ–­å¼€è¿æ¥
    bool isEnabled() const { return m_connected; }

private:
    InputManager *m_inputManager;
    MotorCtrl *m_motorCtrl;
    bool m_connected;

    // è®°å½•é¢å¤–æ—¥å¿—è¿æ¥
    QMetaObject::Connection m_debugLogConnection;

};

#endif // JOYSTICKCONTROLLERMANAGER_H
```

ç„¶å`SMessageBox`çš„å¤´æ–‡ä»¶ä¸º

```cPP
#ifndef COMMUTILS_H
#define COMMUTILS_H

#include <QObject>
#include <QWidget>
#include <QMessageBox>

class SMessageBox : QMessageBox
{
    Q_OBJECT
private:
    SMessageBox();
    static SMessageBox *m_instance;
    static bool m_isMute;

public:
    static SMessageBox*get_instance(){
        if(m_instance == NULL){
            m_instance = new  SMessageBox();
        }
        return m_instance;
    }
    static int sQdialogOkCancel(QWidget *t, QMessageBox::Icon _icon, QString text);
    static void sQdialogDelayMS(QWidget *t, QMessageBox::Icon _icon, QString text, quint32 msec);
    static void sQdialogBoxOk(QWidget *t, QMessageBox::Icon _icon, QString text);
    static void muteEn(bool en);

    void delayMSec(quint32 msec);
    void messageBoxDelayMS(QWidget *t, QMessageBox::Icon _icon, QString text, quint32 msec);
    void messageBox(QWidget *t, QMessageBox::Icon _icon, QString text);
    int messageBoxOkCancel(QWidget *t, QMessageBox::Icon _icon, QString text);
    int messageBoxYesNo(QWidget *t, QMessageBox::Icon _icon, QString text, QString yes="æ˜¯", QString no="å¦");
};

#endif // COMMUTILS_H
```

æ‰€ä»¥æˆ‘è¯¥å¦‚ä½•åœ¨æ¯æ¬¡è°ƒç”¨`SMessageBox`çš„ç›¸å…³å‡½æ•°ï¼Œå°±è°ƒç”¨`disable()`ï¼Œæ‰§è¡Œå®Œæ¯•åè°ƒç”¨`enable()`ã€‚ä»¥æ­¤æ¥è·å¾—å¼¹çª—ç¦æ­¢æ‘‡æ†æ§åˆ¶çš„é€»è¾‘ï¼Ÿ

è§£å†³è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒåœ¨äº**åœ¨å¼¹çª—æ˜¾ç¤ºå‰ç¦ç”¨æ‘‡æ†ï¼Œå¹¶åœ¨å¼¹çª—å…³é—­åé‡æ–°å¯ç”¨æ‘‡æ†**ã€‚ç”±äº `SMessageBox` æ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ˜¯ç›´æ¥è°ƒç”¨çš„ï¼Œä½ ä¸èƒ½ç›´æ¥åœ¨å…¶å†…éƒ¨ä¿®æ”¹ `JoystickControllerManager` çš„çŠ¶æ€ã€‚

æœ€ä½³çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¿®æ”¹ `SMessageBox` ä¸­çš„é™æ€å¼¹çª—å‡½æ•°ï¼Œä½¿å…¶åœ¨æ˜¾ç¤ºå¼¹çª—ä¹‹å‰è°ƒç”¨ç¦ç”¨æ‘‡æ†çš„æ–¹æ³•ï¼Œå¹¶åœ¨å¼¹çª—è¿”å›ç»“æœä¹‹åè°ƒç”¨å¯ç”¨æ‘‡æ†çš„æ–¹æ³•ã€‚

## é”™è¯¯

okï¼Œç»è¿‡è°ƒè¯•ï¼Œå‘ç°å·²ç»æ²¡æ³•è¿›å…¥ç•Œé¢å†…çš„è®¾ç½®äº†ã€‚ç»è¿‡å›é€€ç‰ˆæœ¬æ¥è§£å†³äº†æ­¤é—®é¢˜ã€‚æ‰€ä»¥ä¸Šé¢è§£å†³é—®é¢˜çš„åŠæ³•ï¼Œéœ€è¦é‡æ–°å®¡è§†ã€‚

## ç™»å½•æµç¨‹

ç°åœ¨å°±å…ˆé™ä¸‹å¿ƒæ¥ï¼Œä»å¤´èµ°ä¸€éä¸€ä¸ªåœºæ™¯

> åœ¨padæ¨¡å¼ä¸‹ï¼Œä»mainå‡½æ•°å¼€å§‹ï¼Œä»ç™»å½•ç•Œé¢åˆ°ä¸»ç•Œé¢çš„ä»£ç æµç¨‹ã€‚

ä»¥æ­¤æ¥æ‰¾åˆ°å¦‚ä½•åŒºåˆ†ç™»å½•ç•Œé¢å’Œä¸»ç•Œé¢ã€‚ä»¥å®ç°åªåœ¨ç™»å½•åçš„ä¸»ç•Œé¢æ‰èƒ½ä½¿æ‘‡æ†æ­£å¸¸è¿è½¬ã€‚

### main

```C++
int main(int argc, char *argv[])
{
    SQApplication a(argc, argv);

    // è®¾ç½®æ—¥å¿—è·¯å¾„
    setupFileLogging();
    ...

    DbCtrl::DbIint(0);
    MainWindow w;
    if(DbCtrl::m_systemInfo_tb.mode == 1){
        a.getTimer()->setInterval(DbCtrl::m_systemInfo_tb.screenTime*5000);
        a.connect(a.getTimer(), &QTimer::timeout, &w, &MainWindow::on_timeout);
    }
    w.showSL();
    ...

    return a.exec();
}
```

å¯ä»¥çœ‹å‡ºmainå‡½æ•°è°ƒç”¨ `MainWindow` ç±»çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”è°ƒç”¨äº†`showSL()`è®©çª—å£æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚

### MainWindow

æ¥ä¸‹æ¥æˆ‘ä»¬å°†ç›®å…‰è½¬å‘`MainWindow`ç±»ï¼Œæ¥æ·±å…¥äº†è§£ `main` å‡½æ•°ä¸­ `MainWindow w;` å’Œ `w.showSL();` æ‰§è¡Œæ—¶ï¼Œ`MainWindow` ç±»å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆã€‚

#### æ„é€ å‡½æ•° `MainWindow::MainWindow()

å½“ `main` å‡½æ•°æ‰§è¡Œ `MainWindow w;` è¿™è¡Œä»£ç æ—¶ï¼ŒC++ ä¼šè°ƒç”¨ `MainWindow` ç±»çš„æ„é€ å‡½æ•°ï¼š

```C++
MainWindow::MainWindow(QWidget *parent)
    : FMainWindow(parent) // è°ƒç”¨åŸºç±» FMainWindow çš„æ„é€ å‡½æ•°
{
    init_UI(); // è°ƒç”¨è‡ªå®šä¹‰çš„ init_UI() å‡½æ•°
}
```

1. `: FMainWindow(parent)` (åˆå§‹åŒ–åˆ—è¡¨)

   åœ¨ `MainWindow` æ„é€ å‡½æ•°ä½“æ‰§è¡Œä¹‹å‰ï¼Œå®ƒä¼šå…ˆè°ƒç”¨å…¶åŸºç±» `FMainWindow` çš„æ„é€ å‡½æ•°ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸º `FMainWindow` å¯èƒ½ä¼šåˆå§‹åŒ–ä¸€äº›å…¬å…±çš„çª—å£å±æ€§ã€å¸ƒå±€æˆ–è€…å…¶ä»–åœ¨ `MainWindow` ä¸­éœ€è¦ä½¿ç”¨çš„ç»„ä»¶ã€‚è¿™æ„å‘³ç€ä½ çš„ `MainWindow` æ‹¥æœ‰äº† `FMainWindow` çš„æ‰€æœ‰ç‰¹æ€§å’Œèƒ½åŠ›ã€‚

2. `init_UI();`

   è¿™æ˜¯ `MainWindow` æ„é€ å‡½æ•°ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚å®ƒè°ƒç”¨äº†ä¸€ä¸ªåä¸º `init_UI()` çš„ç§æœ‰ï¼ˆæˆ–ä¿æŠ¤ï¼‰æˆå‘˜å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°è´Ÿè´£**åˆå§‹åŒ–å’Œè®¾ç½®ä¸»çª—å£çš„æ‰€æœ‰ç”¨æˆ·ç•Œé¢å…ƒç´ **ã€‚

#### init_UI()

ç°åœ¨æˆ‘ä»¬æ¥çœ‹ `init_UI()` åšäº†ä»€ä¹ˆ

```C++
void MainWindow::init_UI()
{
    // 1. éšè—æ ‡é¢˜æ ä¸Šçš„ç‰¹å®šæŒ‰é’®
    getTitleBar()->setFixButtonVisible(false);
    getTitleBar()->setMaxButtonVisible(false);
    getTitleBar()->setSkinButtonVisible(false); // çš®è‚¤æŒ‰é’®å…ˆéšè—
    getTitleBar()->setSettingButtonVisible(false);

    // 2. æ ¹æ®ç³»ç»Ÿæ¨¡å¼åˆ›å»ºä¸»é¢˜èœå•
    if(DbCtrl::m_systemInfo_tb.mode){ // å¦‚æœæ¨¡å¼ä¸ºçœŸ (ä¾‹å¦‚ï¼Œå¹³æ¿æ¨¡å¼)
        themeMenu = new ThemeMenu("PAD", this); // åˆ›å»º PAD æ¨¡å¼çš„ä¸»é¢˜èœå•
    }else{ // å¦åˆ™ (ä¾‹å¦‚ï¼ŒPC æ¨¡å¼)
        themeMenu = new ThemeMenu("PC", this); // åˆ›å»º PC æ¨¡å¼çš„ä¸»é¢˜èœå•
    }

    // 3. å°†ä¸»é¢˜èœå•è®¾ç½®åˆ°æ ‡é¢˜æ çš„çš®è‚¤æŒ‰é’®ä¸Šï¼Œå¹¶è¿æ¥ä¿¡å·
    getTitleBar()->getSkinButton()->setMenu(themeMenu);
    // å½“ä¸»é¢˜èœå•å‘å‡º skinChange ä¿¡å·æ—¶ï¼Œè°ƒç”¨ DbCtrl çš„ on_updateSystemSkinMode æ§½
    connect(themeMenu, &ThemeMenu::skinChange, DbCtrl::get_instance(), &DbCtrl::on_updateSystemSkinMode);

    // 4. åˆ›å»ºå¹¶è®¾ç½®ä¸­å¿ƒçª—å£
    centerWindow = new CenterWindow; // åˆ›å»ºè‡ªå®šä¹‰çš„ä¸­å¿ƒçª—å£
    setCentralWidget(centerWindow); // å°†å…¶è®¾ç½®ä¸º MainWindow çš„ä¸­å¿ƒéƒ¨ä»¶

    // 5. åˆ›å»ºå¹¶è®¾ç½®çŠ¶æ€æ 
    m_stat_lb = new QLabel(this); // åˆ›å»ºä¸€ä¸ªæ ‡ç­¾ç”¨äºæ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    statusBar()->setSizeGripEnabled(false); // ç¦ç”¨çŠ¶æ€æ å³ä¸‹è§’çš„å¤§å°è°ƒæ•´æ‰‹æŸ„
    statusBar()->addWidget(m_stat_lb); // å°†æ ‡ç­¾æ·»åŠ åˆ°çŠ¶æ€æ 

    // 6. éšè—æ•´ä¸ªæ ‡é¢˜æ å’ŒçŠ¶æ€æ 
    getTitleBar()->setVisible(false);
    statusBar()->setVisible(false);

    // 7. æ ¹æ®ç³»ç»Ÿæ¨¡å¼è®¾ç½®ä¸­å¿ƒçª—å£çš„å¯¼èˆªæ åˆå§‹ç´¢å¼•
    if(DbCtrl::m_systemInfo_tb.mode){ // å¦‚æœæ¨¡å¼ä¸ºçœŸ (ä¾‹å¦‚ï¼Œå¹³æ¿æ¨¡å¼)
        centerWindow->getNavgationBar()->setCurrentIndex(2); // å¯¼èˆªæ åˆ‡æ¢åˆ°ç´¢å¼• 2
    }else{ // å¦åˆ™ (ä¾‹å¦‚ï¼ŒPC æ¨¡å¼)
        centerWindow->getNavgationBar()->setCurrentIndex(1); // å¯¼èˆªæ åˆ‡æ¢åˆ°ç´¢å¼• 1
    }
}
```

**`init_UI()` çš„ä¸»è¦èŒè´£**ï¼š

- **ä¸»é¢˜ç®¡ç†**ï¼šæ ¹æ® `DbCtrl::m_systemInfo_tb.mode`ï¼ˆå¯èƒ½æ˜¯ä»æ•°æ®åº“è¯»å–çš„ç³»ç»Ÿè¿è¡Œæ¨¡å¼ï¼Œå¦‚PCæ¨¡å¼æˆ–PADæ¨¡å¼ï¼‰ï¼Œåˆ›å»ºä¸åŒçš„ `ThemeMenu`ï¼Œå¹¶å°†å…¶ä¸æ ‡é¢˜æ çš„çš®è‚¤æŒ‰é’®å…³è”ã€‚

  åŒæ—¶ï¼Œå®ƒ**è¿æ¥**äº† `themeMenu` çš„ `skinChange` ä¿¡å·åˆ° `DbCtrl` çš„ `on_updateSystemSkinMode` æ§½ï¼Œè¿™æ„å‘³ç€å½“ç”¨æˆ·é€šè¿‡èœå•æ”¹å˜çš®è‚¤æ—¶ï¼Œä¼šè§¦å‘æ•°æ®åº“ä¸­çš„çš®è‚¤æ¨¡å¼æ›´æ–°ã€‚

- **å¯¼èˆªåˆå§‹åŒ–**ï¼šæ ¹æ®ç³»ç»Ÿæ¨¡å¼ï¼Œè®¾ç½® `CenterWindow` å†…å¯¼èˆªæ çš„åˆå§‹æ˜¾ç¤ºé¡µé¢

#### showSL()

åœ¨ `main` å‡½æ•°ä¸­ï¼Œ`MainWindow w;` å®Œæˆäº†æ‰€æœ‰å†…éƒ¨ UI çš„æ„å»ºå’Œåˆå§‹åŒ–ï¼Œä½†æ­¤æ—¶çª—å£è¿˜æ˜¯ä¸å¯è§çš„ã€‚`w.showSL();` è¿™è¡Œä»£ç å°±æ˜¯è´Ÿè´£è®©çª—å£æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚

```C++
void MainWindow::showSL()
{
    if(DbCtrl::m_systemInfo_tb.mode == 0){ // å¦‚æœæ¨¡å¼ä¸º 0 (ä¾‹å¦‚ï¼ŒPC æ¨¡å¼)
        this->setFixedSize(800, 500); // è®¾ç½®å›ºå®šå¤§å°
        this->showMinimized(); // æœ€å°åŒ–æ˜¾ç¤º
    }else{ // å¦åˆ™ (ä¾‹å¦‚ï¼Œå¹³æ¿æ¨¡å¼)
        this->showFullScreen(); // å…¨å±æ˜¾ç¤º
    }
}
```

### FMainWindow

`FMainWindow` ä½œä¸ºåŸºç±»ï¼Œä¸ºä½ åº”ç”¨ç¨‹åºçš„ `MainWindow` æä¾›äº†**å¼ºå¤§çš„æ— è¾¹æ¡†çª—å£å®šåˆ¶èƒ½åŠ›**ã€‚å®ƒå¤„ç†äº†å¤æ‚çš„é¼ æ ‡äº‹ä»¶æ¥**å®ç°çª—å£æ‹–åŠ¨**ï¼Œé›†æˆäº†**è‡ªå®šä¹‰æ ‡é¢˜æ **æ¥å–ä»£ç³»ç»Ÿæ ‡é¢˜æ çš„åŠŸèƒ½ï¼Œå¹¶æä¾›äº†**ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡**å’Œ**æµ®åŠ¨å°éƒ¨ä»¶**çš„æ”¯æŒã€‚

è¿™ä¸ªæŠ€æœ¯ç»†èŠ‚ä¸å†èµ˜è¿°ã€‚è¿™ä¸ªæ˜¯`Qframer`çš„é€»è¾‘ã€‚

## å±•ç¤º

åœ¨ `MainWindow::init_UI()` å‡½æ•°ä¸­ï¼š

```C++
// ... å…¶ä»–ä»£ç  ...
centerWindow = new CenterWindow;
setCentralWidget(centerWindow);
// ... å…¶ä»–ä»£ç  ...
if(DbCtrl::m_systemInfo_tb.mode){
    centerWindow->getNavgationBar()->setCurrentIndex(2); // å¯¼èˆªæ åˆ‡æ¢åˆ°ç´¢å¼• 2
}else{
    centerWindow->getNavgationBar()->setCurrentIndex(1); // å¯¼èˆªæ åˆ‡æ¢åˆ°ç´¢å¼• 1
}
```

è¦ç†è§£åº”ç”¨ç¨‹åºå¯åŠ¨åç”¨æˆ·çœ‹åˆ°çš„æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼š

1. **`CenterWindow` çš„ç»“æ„**ï¼šå®ƒå†…éƒ¨æ˜¯å¦‚ä½•å¸ƒå±€çš„ï¼Ÿ`getNavgationBar()` è¿”å›çš„æ˜¯ä»€ä¹ˆç±»å‹çš„å¯¹è±¡ï¼Ÿ
2. **å¯¼èˆªæ çš„å†…å®¹**ï¼šè¿™ä¸ªå¯¼èˆªæ åŒ…å«äº†å“ªäº›é¡µé¢æˆ–éƒ¨ä»¶ï¼Ÿç´¢å¼• 1 å’Œç´¢å¼• 2 åˆ†åˆ«å¯¹åº”ç€ä»€ä¹ˆï¼Ÿ

æ‰€ä»¥æˆ‘ä»¬å°†è§†è§’çœ‹å‘`CenterWindow`

### CenterWindow::init_UI

```CPP
void CenterWindow::init_UI()
{
    // 1. æ·»åŠ  "åŸºç¡€é…ç½®" é¡µé¢
    BaseConfig *baseConfigPane = new BaseConfig(this);
    addWidget(tr("åŸºç¡€é…ç½®"), "baseConfig", baseConfigPane);

    // 2. éšè—å¯¼èˆªæ  (é‡è¦ï¼)
    getNavgationBar()->setVisible(false);

    // 3. æ·»åŠ  "è¡Œè½¦æ§åˆ¶" é¡µé¢
    MotorCtrl *motorCtrlPane = MotorCtrl::get_instance(this);
    addWidget(tr("è¡Œè½¦æ§åˆ¶"), "motorCtrl",  motorCtrlPane);

    // 4. æ ¹æ®ç³»ç»Ÿæ¨¡å¼è¿›è¡Œæ¡ä»¶æ€§é…ç½®
    if(DbCtrl::m_systemInfo_tb.mode){   // PAD æ¨¡å¼
        UserManager *usr = new UserManager(this); // åˆ›å»ºç”¨æˆ·ç®¡ç†å™¨
        baseConfigPane->setUserManager(usr); // å°†ç”¨æˆ·ç®¡ç†å™¨è®¾ç½®ç»™ BaseConfig
        motorCtrlPane->setUserManager(usr); // å°†ç”¨æˆ·ç®¡ç†å™¨è®¾ç½®ç»™ MotorCtrl

        m_loginWindow = new LoginWindow(this); // åˆ›å»ºç™»å½•çª—å£
        addWidget(tr("ç³»ç»Ÿç™»å½•"), "login", m_loginWindow); // å°†ç™»å½•çª—å£æ·»åŠ åˆ°ä¸­å¿ƒçª—å£

         // è¿æ¥ç™»å½•æˆåŠŸä¿¡å·ï¼šå½“ LoginWindow å‘å‡º em_login ä¿¡å·æ—¶
        connect(m_loginWindow, &LoginWindow::em_login, this, [=](QString username){
            DbCtrl::setCurrUser(username);
            getNavgationBar()->setCurrentIndex(1);  // ä¸»ç•Œé¢
        });

        // è¿æ¥ç™»å½•æˆåŠŸä¿¡å·åˆ° MotorCtrlï¼šåœ¨ç™»å½•æˆåŠŸæ—¶é€šçŸ¥ MotorCtrl
        connect(m_loginWindow, &LoginWindow::em_login, motorCtrlPane, &MotorCtrl::on_login);

        // è¿æ¥ç”¨æˆ·é€€å‡ºä¿¡å·ï¼šå½“ UserManager å‘å‡º em_logout ä¿¡å·æ—¶
        connect(usr, &UserManager::em_logout, this, [=](){
            DbCtrl::setCurrUser("");
            getNavgationBar()->setCurrentIndex(2); // å¯¼èˆªæ åˆ‡æ¢åˆ°ç´¢å¼• 2 (å³ "ç³»ç»Ÿç™»å½•" é¡µé¢)
        });
    }



//    connect(getNavgationBar()->buttons.at(getNavgationBar()->buttons.size()-1),
//            &QPushButton::clicked, lw, &LoginWindow::on_timeout);

    MotorStatus *sta = new MotorStatus(this);
    //addWidget(tr("è¿è¡ŒçŠ¶æ€"), "status",  sta);

    setAlignment(TopCenter);
}
```

`init_UI()` çš„ä¸»è¦èŒè´£ï¼š

- **é¡µé¢ç®¡ç†**ï¼šé€šè¿‡ `addWidget()` æ–¹æ³•ï¼Œå°† `BaseConfig` å’Œ `MotorCtrl` å®ä¾‹ä½œä¸ºå­é¡µé¢æ·»åŠ åˆ° `CenterWindow` ä¸­ã€‚
- **éšè—å¯¼èˆªæ **ï¼š`getNavgationBar()->setVisible(false)`
- **PADç•Œé¢å±•ç¤º**ï¼š`DbCtrl::m_systemInfo_tb.mode` ä¸ºçœŸ
  - åˆ›å»º `UserManager` å’Œ `LoginWindow`ã€‚
  - `LoginWindow` è¢«æ·»åŠ ä¸ºç¬¬ä¸‰ä¸ªé¡µé¢ï¼ˆç´¢å¼• 2ï¼Œå› ä¸º `BaseConfig` æ˜¯ç´¢å¼• 0ï¼Œ`MotorCtrl` æ˜¯ç´¢å¼• 1ï¼‰ã€‚
  - ç™»å½•æˆåŠŸåï¼Œåº”ç”¨ç¨‹åºä¼šé€šè¿‡ `getNavgationBar()->setCurrentIndex(1)` è‡ªåŠ¨åˆ‡æ¢åˆ°â€œè¡Œè½¦æ§åˆ¶â€é¡µé¢ã€‚
  - ç”¨æˆ·é€€å‡ºåï¼Œä¼šé€šè¿‡ `getNavgationBar()->setCurrentIndex(2)` è‡ªåŠ¨åˆ‡æ¢å›â€œç³»ç»Ÿç™»å½•â€é¡µé¢
- **PCç•Œé¢å±•ç¤º**ï¼š`DbCtrl::m_systemInfo_tb.mode` ä¸ºå‡
  - `LoginWindow` å’Œ `UserManager` ä¸ä¼šè¢«åˆ›å»ºæˆ–æ·»åŠ åˆ°å¯¼èˆªä¸­ã€‚
  - è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯¼èˆªæ ä¸­åªæœ‰â€œåŸºç¡€é…ç½®â€ (ç´¢å¼• 0) å’Œâ€œè¡Œè½¦æ§åˆ¶â€ (ç´¢å¼• 1) ä¸¤ä¸ªé¡µé¢ã€‚
- **é¡µé¢ç´¢å¼•æ¨æ–­**ï¼š
  - `BaseConfig` åº”è¯¥åœ¨ç´¢å¼• `0`ã€‚
  - `MotorCtrl` åº”è¯¥åœ¨ç´¢å¼• `1`ã€‚
  - PADæ¨¡å¼ä¸‹ï¼Œ`LoginWindow` åº”è¯¥åœ¨ç´¢å¼• `2`ã€‚

### æ€»ç»“

è¿™æ ·åº”ç”¨ç¨‹åºåœ¨å¯åŠ¨æ—¶ï¼Œä¼šæ ¹æ® **`DbCtrl::m_systemInfo_tb.mode`** è¿™ä¸ªæ•°æ®åº“é…ç½®æ¥å†³å®šç”¨æˆ·é¦–å…ˆçœ‹åˆ°å“ªä¸ªç•Œé¢ï¼š

- **å¦‚æœ `mode` ä¸º `0` (PC æ¨¡å¼)**ï¼šåº”ç”¨ä¼šæ˜¾ç¤º **`MotorCtrl` (è¡Œè½¦æ§åˆ¶)** é¡µé¢ï¼Œå¹¶ä¸”çª—å£ä»¥å›ºå®šå¤§å°æœ€å°åŒ–åˆ°ä»»åŠ¡æ ã€‚
- **å¦‚æœ `mode` ä¸º `1` (PAD æ¨¡å¼)**ï¼šåº”ç”¨ä¼šæ˜¾ç¤º **`LoginWindow` (ç³»ç»Ÿç™»å½•)** é¡µé¢ï¼Œå¹¶ä¸”çª—å£ä»¥å…¨å±æ¨¡å¼æ˜¾ç¤ºã€‚

## æ‘‡æ†æ§åˆ¶2

ç°åœ¨åœ¨PADæ¨¡å¼ä¸‹ï¼Œä¼šä½¿ç”¨æ‘‡æ†æ¥æ§åˆ¶ç”µæœºçš„å‰è¿›å’Œåé€€ã€‚å¹¶ä¸”å…¶å¯ç”¨å’Œå…³é—­æ‘‡æ†æ§åˆ¶çš„é€»è¾‘å·²ç»åœ¨`JoystickControllerManager`ä¸­å®ç°äº†

```Cpp
#ifndef JOYSTICKCONTROLLERMANAGER_H
#define JOYSTICKCONTROLLERMANAGER_H

#include <QObject>
#include "inputmanager.h"
#include "motorCtrl.h"

class JoystickControllerManager : public QObject
{
    Q_OBJECT
public:
    explicit JoystickControllerManager(InputManager *inputManager,
                                       MotorCtrl *motorCtrl,
                                       QObject *parent = nullptr);
    void enable();   // å»ºç«‹è¿æ¥
    void disable();  // æ–­å¼€è¿æ¥
    bool isEnabled() const { return m_connected; }

private:
    InputManager *m_inputManager;
    MotorCtrl *m_motorCtrl;
    bool m_connected;

};

#endif // JOYSTICKCONTROLLERMANAGER_H
```

ç°åœ¨æƒ³å®ç°åœ¨PADæ¨¡å¼ä¸‹ï¼Œç™»å½•ä¹‹å‰çš„ç•Œé¢`LoginWindow`æ—¶å€™ï¼Œç¦ç”¨æ‘‡æ†é€»è¾‘ï¼›åœ¨ç™»å½•æˆåŠŸåçš„ç•Œé¢`MotorCtrl`ï¼Œå¯ç”¨æ‘‡æ†é€»è¾‘ã€‚æˆ‘è¯¥æ€ä¹ˆåšï¼Ÿ

é€šè¿‡è¿™ä¸‰ä¸ªæ­¥éª¤ï¼š

1. åœ¨ `main` å‡½æ•°ä¸­**åˆ›å»º** `JoystickControllerManager` å®ä¾‹ã€‚
2. åœ¨ `CenterWindow` ä¸­**ä¿å­˜** `JoystickControllerManager` çš„æŒ‡é’ˆï¼Œå¹¶æ·»åŠ åœ¨ç™»å½•æˆåŠŸå’Œç™»å‡ºæ—¶**è°ƒç”¨å…¶ `enable()` å’Œ `disable()` æ–¹æ³•çš„é€»è¾‘**ï¼ŒåŒæ—¶è®¾ç½®åˆå§‹çŠ¶æ€ã€‚
3. åœ¨ `main` å‡½æ•°ä¸­å°†åˆ›å»ºçš„ `JoystickControllerManager` å®ä¾‹**ä¼ é€’**ç»™ `CenterWindow`ã€‚

ç»è¿‡è°ƒè¯•ï¼Œå‘ç°æ²¡ä»€ä¹ˆé—®é¢˜ã€‚

## å¼¹çª—æ—¶å€™å±è”½æ‘‡æ†

ç°åœ¨è¿˜æƒ³å®ç°å¦å¤–ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯åœ¨å¼¹çª—çš„æ—¶å€™ï¼Œç¦ç”¨æ‰æ‰€æœ‰çš„æ‘‡æ†æ§åˆ¶é€»è¾‘ã€‚å¼¹çª—é€»è¾‘ç”±`SMessageBox`å®ç°çš„ã€‚ä¾‹å¦‚åœ¨`MotorCtrl`ä¸­å®ç°çš„ã€‚ä¾‹å­ï¼š

```Cpp
bool MotorCtrl::UI_confirmSetOrigin()
{
    if (m_funSl_btgrp->checkedId() == Revolve) {
        return SMessageBox::sQdialogOkCancel(this, QMessageBox::Question,
            "ç¡®å®šè¦å°†æ­¤ä½ç½®è®¾ä¸ºåŸç‚¹?") == QMessageBox::Accepted;
    }

    if (!DbCtrl::getAdminStat()) {
        AdminAuthDialog dlg(this);
        return dlg.exec() == QDialog::Accepted && dlg.authResult();
    }

    return true;
}
```

å±•ç¤ºæ­¤ç±»å¼¹çª—çš„æ—¶å€™ï¼Œèƒ½å¦åœ¨å¼€å§‹å¼¹çª—æ—¶å€™ç¦ç”¨æ‘‡æ†ï¼Œè·å–å®Œæ¯•å¼¹çª—ä¿¡æ¯åå¯åŠ¨æ‘‡æ†ï¼Ÿ

å¹¶ä¸”ä¸ºäº†ç®€å•è€ƒè™‘ï¼Œèƒ½å¦ä»¥ç»Ÿä¸€çš„ä¿¡å·è¿›è¡Œå¤„ç†ã€‚æ„æ€å°±æ˜¯å¼¹çª—å‡ºç°çš„æ—¶å€™ï¼Œå‘é€å¼¹çª—å¼€å§‹ä¿¡å·ã€‚æ­¤æ—¶å¼¹çª—å¼€å§‹ä¿¡å·ä¼šä¸æ‘‡æ†çš„åœç”¨é€»è¾‘æ§½å‡½æ•°è¿æ¥ï¼Œè°ƒç”¨å…¶åœç”¨æ‘‡æ†ã€‚å¼¹çª—ç»“æŸæ—¶ï¼Œå‘é€å¼¹çª—ç»“æŸä¿¡å·ï¼Œæ­¤æ—¶è°ƒç”¨å…¶å¯ç”¨æ‘‡æ†ï¼Ÿ

ä¸è¿‡ä»¥ä½ ä¸ºå‡†ï¼Œå“ªä¸ªç®€å•æ–¹ä¾¿ï¼Œä½¿ç”¨å“ªä¸ªç­–ç•¥ã€‚

### åœ¨ `SMessageBox` å†…éƒ¨ç»Ÿä¸€å¤„ç† (å†…éƒ¨ç»Ÿä¸€ï¼Œæœ€ç»ˆé€‰æ‹©)

å½“ç”¨æˆ·æ˜ç¡®æŒ‡å‡ºä¿®æ”¹ 120 å¤šä¸ªè°ƒç”¨ç‚¹ä¸å¯è¡Œæ—¶ï¼Œæˆ‘æ„è¯†åˆ°å¿…é¡»å°†ç»Ÿä¸€å¤„ç†çš„é€»è¾‘**ä¸‹æ²‰åˆ° `SMessageBox` å†…éƒ¨**ã€‚è¿™æ„å‘³ç€ `SMessageBox` è‡ªèº«å¿…é¡»å…·å¤‡å‘å‡ºä¿¡å·çš„èƒ½åŠ›ã€‚

**å…³é”®æ´å¯Ÿï¼š** æˆ‘é‡æ–°æ£€æŸ¥äº† `SMessageBox` çš„ç±»å®šä¹‰ã€‚è™½ç„¶å®ƒç›´æ¥ç»§æ‰¿ `QMessageBox` è€Œä¸æ˜¯ `QObject`ï¼Œä½† `QMessageBox` ç»§æ‰¿è‡ª `QDialog`ï¼Œ`QDialog` ç»§æ‰¿è‡ª `QWidget`ï¼Œè€Œ `QWidget` æœ€ç»ˆæ˜¯ç»§æ‰¿è‡ª `QObject` çš„ã€‚è¿™æ„å‘³ç€ `SMessageBox` **æœ¬èº«å°±å·²ç»æ˜¯ `QObject` çš„å­ç±»äº†**ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `Q_OBJECT` å®å’Œä¿¡å·æ§½æœºåˆ¶ï¼Œè€Œæ— éœ€æ”¹å˜ç»§æ‰¿é“¾ã€‚è¿™æ˜¯ä¸€ä¸ªå…³é”®çš„ç®€åŒ–ï¼

**æ€è·¯ï¼š**

1. **ä¸º `SMessageBox` æ·»åŠ ä¿¡å·ï¼š** åœ¨ `SMessageBox` çš„å¤´æ–‡ä»¶ä¸­æ·»åŠ  `Q_OBJECT` å®ï¼Œå¹¶å£°æ˜ `dialogAboutToOpen()` å’Œ `dialogClosed()` ä¿¡å·ã€‚
2. **åœ¨ `SMessageBox` æ–¹æ³•å†…éƒ¨å‘å‡ºä¿¡å·ï¼š**
   - **å¯¹äºé˜»å¡å¼å¼¹çª—æ–¹æ³•** (`sQdialogOkCancel`, `messageBox` ç­‰è°ƒç”¨ `exec()` çš„æ–¹æ³•)ï¼šåœ¨è°ƒç”¨ `exec()` **ä¹‹å‰**å‘å‡º `dialogAboutToOpen()` ä¿¡å·ï¼Œåœ¨ `exec()` **è¿”å›ä¹‹å**å‘å‡º `dialogClosed()` ä¿¡å·ã€‚è¿™æ ·ï¼Œåœ¨æ•´ä¸ªå¼¹çª—æ˜¾ç¤ºæœŸé—´ï¼Œæ‘‡æ†éƒ½ä¼šè¢«ç¦ç”¨ã€‚
   - **å¯¹äºéé˜»å¡å¼å¼¹çª—æ–¹æ³•** (`sQdialogDelayMS`, `messageBoxDelayMS` ç­‰è°ƒç”¨ `show()` çš„æ–¹æ³•)ï¼šç”±äºè¿™äº›æ–¹æ³•ç«‹å³è¿”å›ï¼Œä¸èƒ½åœ¨æ–¹æ³•æœ«å°¾å‘å‡º `dialogClosed()`ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ï¼Œåœ¨ `show()` **ä¹‹å‰**å‘å‡º `dialogAboutToOpen()`ï¼Œç„¶å**è¿æ¥å¼¹çª—å®ä¾‹çš„ `finished()` ä¿¡å·**ã€‚å½“å¼¹çª—çœŸæ­£å…³é—­æ—¶ï¼Œå®ƒçš„ `finished()` ä¿¡å·ä¼šè¢«è§¦å‘ï¼Œæ­¤æ—¶å†ç”± `SMessageBox` å•ä¾‹å‘å‡º `dialogClosed()`ã€‚
3. **æ‘‡æ†æ§åˆ¶å™¨ç›‘å¬ `SMessageBox` ä¿¡å·ï¼š** `JoystickControllerManager` åœ¨å…¶æ„é€ å‡½æ•°ä¸­ç›´æ¥è¿æ¥åˆ° `SMessageBox::get_instance()` å‘å‡ºçš„è¿™ä¸¤ä¸ªä¿¡å·ã€‚

## æ›´å¤šè‡ªå®šä¹‰å¼¹çª—çš„æ‘‡æ†ç¦ç”¨

ç°åœ¨ä¾æ—§å­˜åœ¨å…¶ä»–çš„å¼¹çª—éœ€è¦ç›¸åŒçš„å¯ç”¨å’Œç¦ç”¨é€»è¾‘ã€‚

# 6.26

ä»Šå¤©æ”¶å°¾è®¾ç½®ç•Œé¢çš„å¼¹çª—å¤„ç†ã€‚

## å¼¹çª—æ€»ç»“

æˆ‘ä»¬é‡‡ç”¨äº†**é€çº§ä¼ é€’ï¼ˆDependency Injectionï¼‰**çš„æ–¹å¼ï¼Œç¡®ä¿æ‰€æœ‰éœ€è¦æ§åˆ¶æ‘‡æ†çš„ç»„ä»¶éƒ½èƒ½è®¿é—®åˆ°åŒä¸€ä¸ª `joystickManager` å®ä¾‹ã€‚

### a) åˆ›å»ºä¸èµ·å§‹ä¼ é€’ (`main.cpp`)

- **åˆ›å»ºæ—¶æœºï¼š** `joystickManager` çš„å®ä¾‹åœ¨ **`main.cpp`** ä¸­è¢«åˆ›å»ºã€‚è¿™æ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ï¼Œå¯ä»¥æ–¹ä¾¿åœ°è·å– `InputManager` å’Œ `MotorCtrl`ï¼ˆæ‘‡æ†ç®¡ç†å™¨ä¾èµ–çš„ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼‰çš„å®ä¾‹ã€‚
- **çˆ¶å¯¹è±¡è®¾ç½®ï¼š** å°† `QCoreApplication::instance()` è®¾ç½®ä¸º `joystickManager` çš„çˆ¶å¯¹è±¡ï¼Œç¡®ä¿å…¶ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç¨‹åºä¸€è‡´ï¼Œå¹¶åœ¨ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨é”€æ¯ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
- **èµ·å§‹ä¼ é€’ï¼š** `main.cpp` å°†åˆ›å»ºçš„ `joystickManager` å®ä¾‹é€šè¿‡ `MainWindow::setJoystickManager()` æ–¹æ³•ï¼Œé¦–æ¬¡ä¼ é€’ç»™ä¸»çª—å£ã€‚

### b) é€çº§å‘ä¸‹ä¼ é€’ (`MainWindow` -> `CenterWindow` -> `MotorCtrl`)

- **`MainWindow` æ¥æ”¶ä¸ä¼ é€’ï¼š**
  - `MainWindow` åŒ…å«ä¸€ä¸ª `JoystickControllerManager* m_joystickManager;` æˆå‘˜ã€‚
  - `MainWindow::setJoystickManager(JoystickControllerManager *manager)` æ–¹æ³•æ¥æ”¶æ¥è‡ª `main.cpp` çš„ `joystickManager` å®ä¾‹ã€‚
  - æ¥æ”¶åï¼Œ`MainWindow` ä¼šç«‹å³è°ƒç”¨ `centerWindow->setJoystickManager(m_joystickManager);` å°†è¯¥å®ä¾‹è¿›ä¸€æ­¥ä¼ é€’ç»™å…¶å†…éƒ¨çš„ `CenterWindow`ã€‚
- **`CenterWindow` æ¥æ”¶ä¸ä½¿ç”¨ï¼š**
  - `CenterWindow` åŒæ ·åŒ…å« `JoystickControllerManager* m_joystickManager;` æˆå‘˜å’Œ `setJoystickManager` æ–¹æ³•ã€‚
  - `CenterWindow` åœ¨å…¶å†…éƒ¨é€»è¾‘ä¸­ï¼Œç‰¹åˆ«æ˜¯å¤„ç†**å¯¼èˆªé¡µé¢åˆ‡æ¢** (`handleNavigationChange`)ã€**ç”¨æˆ·ç™»å‡º** (`UserManager::em_logout` ä¿¡å·å¤„ç†) ä»¥åŠè¿æ¥ `BaseConfig` çš„**â€œè¿”å›â€ä¿¡å·**æ—¶ï¼Œä¼šæ ¹æ®é¡µé¢ç±»å‹æˆ–äº‹ä»¶è°ƒç”¨ `m_joystickManager->enable()` æˆ– `m_joystickManager->disable()`ã€‚
  - `CenterWindow` è¿˜ä¼šå°† `joystickManager` ä¼ é€’ç»™å…¶å­ç»„ä»¶ï¼Œä¾‹å¦‚ `MotorCtrl`ã€‚
- **`MotorCtrl` æ¥æ”¶ä¸ä½¿ç”¨ï¼š**
  - `MotorCtrl` ä¹Ÿä¼šæŒæœ‰ `JoystickControllerManager* m_joystickManager;` å¹¶é€šè¿‡ `setJoystickManager` æ¥æ”¶å®ä¾‹ã€‚
  - `MotorCtrl` åœ¨å…¶ç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘ç‚¹ï¼ˆå¦‚ç‚¹å‡»**â€œè®¾ç½®â€æŒ‰é’® (`on_cfgBt_clicked`)** æˆ– **â€œå¿«é€Ÿé…ç½®â€æŒ‰é’® (`on_quickCfg_clicked`)** æ—¶ï¼‰ï¼Œä¼šæ˜¾å¼åœ°è°ƒç”¨ `m_joystickManager->disable()` æ¥ç¦ç”¨æ‘‡æ†ã€‚

### c) ç²¾å‡†æ§åˆ¶ï¼šç¦ç”¨ä¸å¯ç”¨æ—¶æœº

`joystickManager` çš„æ ¸å¿ƒåœ¨äºå…¶å†…éƒ¨çš„**ç¦ç”¨è®¡æ•°å™¨ (`m_disableCount`)**ã€‚è¿™ä¸ªè®¡æ•°å™¨ç¡®ä¿äº†å³ä½¿å¤šæ¬¡è°ƒç”¨ `disable()` æˆ– `enable()`ï¼Œæ‘‡æ†çš„å®é™…è¿æ¥/æ–­å¼€æ“ä½œä¹Ÿåªä¼šå‘ç”Ÿä¸€æ¬¡ï¼Œå¹¶ä¸”åªæœ‰å½“æ‰€æœ‰ç¦ç”¨è¯·æ±‚éƒ½è§£é™¤åï¼Œæ‘‡æ†æ‰ä¼šçœŸæ­£å¯ç”¨ã€‚

ä¸»è¦çš„ç¦ç”¨ä¸å¯ç”¨æ—¶æœºå¦‚ä¸‹ï¼š

- **ç¦ç”¨ (`disable()`)ï¼š**
  - **è¿›å…¥è®¾ç½®æµç¨‹å‰ï¼š** `MotorCtrl::on_cfgBt_clicked()` åœ¨ç”¨æˆ·ç‚¹å‡»è®¾ç½®æŒ‰é’®ï¼Œæ— è®ºæ˜¯ç›´æ¥è¿›å…¥è¿˜æ˜¯éœ€è¦ç®¡ç†å‘˜è®¤è¯å‰ï¼Œéƒ½ä¼šç«‹å³è°ƒç”¨ `disable()`ã€‚
  - **å¼¹å‡ºå¯¹è¯æ¡†æ—¶ï¼š** `SMessageBox::get_instance()->dialogAboutToOpen()` ä¿¡å·ï¼ˆè¢« `joystickManager` å†…éƒ¨è¿æ¥ï¼‰ä¼šåœ¨ä»»ä½•å¯¹è¯æ¡†å¼¹å‡ºå‰è§¦å‘ `disable()`ã€‚`MotorCtrl::on_quickCfg_clicked()` ä¹Ÿä¼šåœ¨å¼¹å‡ºå¿«é€Ÿé…ç½®å¯¹è¯æ¡†å‰è°ƒç”¨ã€‚
  - **å¯¼èˆªåˆ°éè¡Œè½¦é¡µé¢ï¼š** `CenterWindow::handleNavigationChange()` åœ¨å¯¼èˆªåˆ°â€œåŸºç¡€é…ç½®â€æˆ–â€œç³»ç»Ÿç™»å½•â€é¡µé¢æ—¶ä¼šè°ƒç”¨ `disable()`ã€‚
  - **è¶…æ—¶ç™»å‡ºï¼š** `MainWindow::on_timeout()` åœ¨ç³»ç»Ÿå› è¶…æ—¶è‡ªåŠ¨ç™»å‡ºå¹¶åˆ‡æ¢åˆ°ç™»å½•é¡µé¢å‰ï¼Œä¼šè°ƒç”¨ `disable()`ã€‚
  - **ç”¨æˆ·ç™»å‡ºï¼š** `CenterWindow` ä¸­å¤„ç† `UserManager::em_logout` ä¿¡å·çš„é€»è¾‘ä¼šè°ƒç”¨ `disable()`ã€‚
- **å¯ç”¨ (`enable()`)ï¼š**
  - **å¯¹è¯æ¡†å…³é—­åï¼š** `SMessageBox::get_instance()->dialogClosed()` ä¿¡å·ï¼ˆè¢« `joystickManager` å†…éƒ¨è¿æ¥ï¼‰ä¼šåœ¨å¯¹è¯æ¡†å…³é—­åè§¦å‘ `enable()`ã€‚
  - **ä»è®¾ç½®é¡µé¢è¿”å›ï¼š** `BaseConfig` é¡µé¢ç‚¹å‡»â€œå–æ¶ˆ/è¿”å›â€æŒ‰é’®æ—¶ï¼Œä¼šå‘å‡ºä¿¡å·ï¼Œ`CenterWindow` æ•è·åä¼šè°ƒç”¨ `enable()`ã€‚
  - **å¯¼èˆªåˆ°è¡Œè½¦æ§åˆ¶é¡µé¢ï¼š** `CenterWindow::handleNavigationChange()` åœ¨å¯¼èˆªåˆ°â€œè¡Œè½¦æ§åˆ¶â€é¡µé¢æ—¶ä¼šè°ƒç”¨ `enable()`ã€‚
  - **ç®¡ç†å‘˜è®¤è¯å¤±è´¥/å–æ¶ˆï¼š** åœ¨ `MotorCtrl::on_cfgBt_clicked()` ä¸­ï¼Œå¦‚æœç®¡ç†å‘˜è®¤è¯å¤±è´¥æˆ–ç”¨æˆ·å–æ¶ˆäº†å¯¹è¯æ¡†ï¼Œæ‘‡æ†ä¼šé‡æ–° `enable()`ã€‚

é€šè¿‡è¿™ç§ç»†è‡´çš„æ§åˆ¶å’Œæ˜ç¡®çš„ä¾èµ–å…³ç³»ï¼Œ`joystickManager` èƒ½å¤Ÿå‡†ç¡®åœ°åœ¨ç”¨æˆ·ç•Œé¢çš„å…³é”®æ“ä½œç‚¹ä¸Šç¦ç”¨å’Œå¯ç”¨æ‘‡æ†åŠŸèƒ½ï¼Œä¿è¯äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

# 6.27

## æ°´æ± Z1ä¸‹å 

### æ—¶é—´çº¿

- 23:36:56.685ï¼šZ1ä»114.122mmä½ç½®æ­£å‘ç‚¹åŠ¨å¼€å§‹ï¼Œé€Ÿåº¦ä¸º30mm/s
- 23:37:05.217ï¼šç‚¹åŠ¨ç»“æŸï¼Œç‚¹åŠ¨ä½ç½®ä¸º171.795mm
- 23:37:05.669ï¼šZ1ä»ä½ç½®171.795mmå¼€å§‹ï¼Œæ‰§è¡Œè´Ÿå‘ç‚¹åŠ¨
- 23:37:06.388ï¼šZ1è´Ÿå‘ç‚¹åŠ¨å¼‚å¸¸ç»“æŸï¼Œåœæ­¢ä½ç½®ä¸º-64.628mmï¼ŒæŒç»­æ—¶é—´ä¸º719msã€‚å¼‚å¸¸ç§»åŠ¨è·ç¦»ä¸º236.423mmã€‚é€Ÿåº¦ä¸º328.82mm/sï¼Œå¼‚å¸¸ä¸‹å 

### å¼‚å¸¸æ—¥å¿—

```bash
INFO  2025-06-26T23:37:05.879 "ç”µæœº-1å†™å…¥æˆåŠŸ,16(277,8)" 
INFO  2025-06-26T23:37:05.879 "æˆåŠŸé…ç½®[å…¨éƒ¨]ç”µæœºDOåˆ¹è½¦åŠŸèƒ½ï¼" 
INFO  2025-06-26T23:37:06.040 "ç”µæœº3å†™å…¥æˆåŠŸ,16(53,1)" 
INFO  2025-06-26T23:37:06.042 "è¡Œè½¦ç‚¹åŠ¨è¿åŠ¨çŠ¶æ€æ£€æŸ¥çº¿ç¨‹å¯åŠ¨" 
INFO  2025-06-26T23:37:06.059 "ç”µæœº254å†™å…¥æˆåŠŸ,16(17,60)" 
WARN  2025-06-26T23:37:06.169 "è¿™ä¸æ˜¯ä¸ªæ­£ç¡®çš„æµç¨‹" 
INFO  2025-06-26T23:37:06.268 "ç”µæœº3å†™å…¥æˆåŠŸ,16(53,0)" 
INFO  2025-06-26T23:37:06.328 "ç”µæœº3å†™å…¥æˆåŠŸ,16(287,2)" 
INFO  2025-06-26T23:37:06.328 "ç”µæœºZ1ç‚¹åŠ¨åœæ­¢" 
INFO  2025-06-26T23:37:06.328 "è¡Œè½¦ç‚¹åŠ¨è¿è¡Œç»“æŸ.
```

çœ‹åˆ°æ‰§è¡Œäº†è¯­å¥`è¿™ä¸æ˜¯ä¸ªæ­£ç¡®çš„æµç¨‹`ï¼Œå…¶åœ¨æ£€æŸ¥çº¿ç¨‹`checkJog()`é€»è¾‘å®ç°ä¸º

```C++
if(!anyMotorCheckedInThisCycle){
    m_allDone = true;
    QLOG_WARN()<<QString("è¿™ä¸æ˜¯ä¸ªæ­£ç¡®çš„æµç¨‹");
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ£€æŸ¥ç‚¹åŠ¨çš„æ—¶å€™ï¼Œæ­¤åˆ¤æ–­è¯­å¥ä¸ºçœŸã€‚

### å¼‚å¸¸é€»è¾‘

å½“è¿™ä¸ª `if` è¯­å¥ä¸ºçœŸæ—¶ï¼Œæ„å‘³ç€ä»¥ä¸‹æƒ…å†µï¼š

1. **ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨ï¼š** `checkJog` å‡½æ•°æœ¬èº«å·²ç»è¢« `actionJog` è°ƒç”¨å¹¶å¯åŠ¨åœ¨ä¸€ä¸ªæ–°çš„ `QThread` ä¸­ã€‚
2. **å½“å‰å¾ªç¯ä¸­æ²¡æœ‰ç”µæœºè¢«ç›‘æ§ï¼š** åœ¨ `for (int motorID= 0; ...)` å¾ªç¯ä¸­ï¼Œ**æ²¡æœ‰ä¸€ä¸ª** `m_needCheck.at(motorID)` è¢«è¯„ä¼°ä¸º `true`ã€‚æ¢å¥è¯è¯´ï¼Œ`m_needCheck` å‘é‡ä¸­æ‰€æœ‰çš„å€¼éƒ½æ˜¯ `false`ã€‚

**è¿™è¡¨æ˜ä¸€ä¸ªå¼‚å¸¸çš„ç¨‹åºçŠ¶æ€ï¼š** ç›‘æ§çº¿ç¨‹è¢«å¯åŠ¨äº†ï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰ä»»ä½•ç”µæœºè¢«æŒ‡å®šéœ€è¦å®ƒå»ç›‘æ§ã€‚ä»é€»è¾‘ä¸Šè®²ï¼Œå¦‚æœç‚¹åŠ¨æ“ä½œè¢«æ­£ç¡®å¯åŠ¨ï¼Œè‡³å°‘ä¼šæœ‰ä¸€ä¸ªç”µæœºï¼ˆæˆ–åŒç”µæœºæ¨¡å¼ä¸‹çš„ä¸¤ä¸ªç”µæœºï¼‰è¢«æ ‡è®°ä¸º `m_needCheck`ã€‚å¦‚æœè¿™ä¸ªæ¡ä»¶ä¸º `true`ï¼Œå°±æ„å‘³ç€ï¼š

- ~~**å¯åŠ¨é€»è¾‘æœ‰ç¼ºé™·ï¼š** `actionJog` æˆ– `applyJogConfig` åœ¨å¯åŠ¨æ—¶æœªèƒ½æ­£ç¡®åœ°è®¾ç½® `m_needCheck` æ ‡å¿—ã€‚~~
- ~~**çŠ¶æ€ä¸ä¸€è‡´ï¼š** ç³»ç»Ÿçš„æŸä¸ªéƒ¨åˆ†å¯èƒ½åœ¨ç‚¹åŠ¨å¯åŠ¨åï¼Œæ„å¤–åœ°é‡ç½®äº† `m_needCheck` æ ‡å¿—ã€‚~~
- `m_allDone` å¯¼è‡´ `for` å¾ªç¯æå‰é€€å‡º

## ç‚¹åŠ¨å‰è¿›æ§åˆ¶é€»è¾‘

åœ¨ç‚¹åŠ¨æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»ä¸€æ¬¡å‰è¿›æŒ‰é’®åæ¾å¼€ã€‚æ­¤æ—¶ç”µæœºä»æœªåœæ­¢ã€‚æ­¤æ—¶å¿«é€ŸæŒ‰ä¸‹ç¬¬äºŒæ¬¡å‰è¿›æŒ‰é’®ï¼Œæ­¤æ—¶ä¼šå¼¹çª—æç¤º`å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…`ï¼Œä½†æ˜¯ç”µæœºç•Œé¢è¡Œä¸ºç±»ä¼¼äºæŒç»­æŒ‰ä½å‰è¿›æŒ‰é’®ï¼Œç”µæœºä¼šä¸€ç›´å‰è¿›ç§»åŠ¨ã€‚

### å‰è¿›æŒ‰é’®

å‰è¿›æŒ‰é’®ä¸º`m_action_upRightFront_bt`ï¼Œå…¶åœ¨PADä¸Šçš„è¡Œä¸ºæ˜¯

```C++
connect(m_action_upRightFront_bt, &SQPushButton::touchBegin, this, &MotorCtrl::on_actionUpRightFrontBt_pressed);

connect(m_action_upRightFront_bt, &SQPushButton::touchEnd, this, &MotorCtrl::on_actionUpRightFrontBt_released);
```

å¯¹åº”æŒ‰é’®çš„å¤„ç†é€»è¾‘ä¸º

```C++
void MotorCtrl::on_actionUpRightFrontBt_pressed()
{
    if (!checkMotorConfigurationValidity()) {
         QLOG_ERROR()<<QString("MotorCtrlï¼šå‰è¿›æŒ‰é’®é•¿æŒ‰å¤±æ•ˆ");
         return;
    }
    // [ç‚¹åŠ¨æ¨¡å¼] ç§»åŠ¨
    if(m_runMode_chb->isChecked()){
        if(!isRunning()){
            m_allDone =false;
            actionJog(1);
        }
    }
}

void MotorCtrl::on_actionUpRightFrontBt_released()
{
    if (!checkMotorConfigurationValidity()) {
         QLOG_ERROR()<<QString("MotorCtrlï¼šå‰è¿›æŒ‰é’®æ¾å¼€å¤±æ•ˆ");
         return;
    }
    if(m_runMode_chb->isChecked()){
        m_allDone = true;
    }else{
        on_actionUpRightFrontBt_clicked();
    }
}

bool MotorCtrl::isRunning()
{
    if(m_checkWoker && m_checkWoker->isRunning()){
        QLOG_WARN()<<QString("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…");
        //SMessageBox::sQdialogBoxOk(this, QMessageBox::Information, tr("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…"));
        if(m_jog_done){
            return true;
        }
    }
    return false;
}
```

### åŸå› åˆ†æ

å¯¼è‡´ç”µæœºæŒç»­å‰è¿›çš„å¯èƒ½äº‹ä»¶åºåˆ—ï¼š

1. **ç¬¬ä¸€æ¬¡æŒ‰ä¸‹ (`touchBegin`)ï¼š**

   - `on_actionUpRightFrontBt_pressed()` è¢«è°ƒç”¨ã€‚
   - å¤„äºç‚¹åŠ¨æ¨¡å¼ (`m_runMode_chb->isChecked()` ä¸ºçœŸ)ã€‚
   - `isRunning()` è¢«è°ƒç”¨ã€‚å‡è®¾æ­¤æ—¶ `m_checkWoker` çº¿ç¨‹å°šæœªå¯åŠ¨ï¼ˆåˆå§‹çŠ¶æ€ï¼‰ï¼Œ`isRunning()` è¿”å› `false`ã€‚
   - `m_allDone` è¢«è®¾ç½®ä¸º `false`ã€‚
   - `actionJog(1)` è¢«è°ƒç”¨ï¼Œå®ƒå¯åŠ¨ç”µæœºï¼Œå¹¶åˆ›å»º/å¯åŠ¨ `m_checkWoker`ï¼ˆæ‚¨çš„ `checkJog` ç›‘æ§çº¿ç¨‹ï¼‰ã€‚

2. **ç¬¬ä¸€æ¬¡æ¾å¼€ (`touchEnd`)ï¼š**

   - `on_actionUpRightFrontBt_released()` è¢«è°ƒç”¨ã€‚
   - å¤„äºç‚¹åŠ¨æ¨¡å¼ã€‚
   - **`m_allDone` è¢«è®¾ç½®ä¸º `true`**ã€‚è¿™ä¸ªæ ‡å¿—ä¼šé€šçŸ¥ `checkJog` çº¿ç¨‹ï¼Œç‚¹åŠ¨æ“ä½œå·²ç»“æŸï¼Œéœ€è¦åœæ­¢ç”µæœºã€‚
   - æ­¤æ—¶ï¼Œ`checkJog` çº¿ç¨‹ä¼šæ¥æ”¶åˆ° `m_allDone` ä¸º `true` çš„ä¿¡å·ï¼Œç†æƒ³çŠ¶æ€ä¸‹å¼€å§‹æ‰§è¡Œå…¶åœæ­¢é€»è¾‘ï¼ˆè°ƒç”¨ `actionJogStop()`åï¼Œå‘é€ `em_jogDone(true)` ä¿¡å·ï¼Œåœ¨å¯¹åº”æ§½å‡½æ•°`on_jogDone()`ä¸­å°†`m_jog_done = true`ï¼‰ã€‚

3. **å…³é”®çš„â€œæ—¶é—´çª—å£â€ï¼š**

   - åœ¨ `on_actionUpRightFrontBt_released()` è®¾ç½® `m_allDone = true` å’Œ `checkJog` çº¿ç¨‹**å®é™…å®Œæˆå…¶æ‰€æœ‰åœæ­¢æ“ä½œ**ï¼ˆåŒ…æ‹¬ç”µæœºåœæ­¢å’Œè®¾ç½® `m_jog_done = true`ï¼‰ä¹‹é—´ï¼Œå­˜åœ¨ä¸€ä¸ªçŸ­æš‚çš„å»¶è¿Ÿã€‚ä¾‹å¦‚åœ¨`checkJog`çº¿ç¨‹ä¸­ï¼Œå¾ªç¯æœ‰

     ```C++
     do{
         QThread::msleep(100);
         ...
     }while(!m_allDone);
     ```

     è¿™ä¸ªå»¶è¿Ÿå¯èƒ½å‡ ç™¾æ¯«æ¯«ç§’ã€‚

   - `checkJog` çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ `do-while(!m_allDone)` å¾ªç¯ã€‚

   - åœ¨å®ƒèƒ½å¤Ÿæ£€æµ‹åˆ° `m_allDone` å˜ä¸º `true` ä¹‹å‰ï¼Œå®ƒå¿…é¡»å…ˆå®Œæˆå½“å‰çš„å¾ªç¯è¿­ä»£ã€‚

   - è€Œè¿™ä¸ªè¿­ä»£ï¼Œé¦–å…ˆä¼šæ‰§è¡Œ `QThread::msleep(100)`ã€‚è¿™æ„å‘³ç€ï¼Œä» `m_allDone` è¢«è®¾ç½®ä¸º `true` çš„é‚£ä¸€åˆ»èµ·ï¼Œ`checkJog` çº¿ç¨‹**æœ€é•¿å¯èƒ½éœ€è¦ 100 æ¯«ç§’**æ‰èƒ½å†æ¬¡æ£€æŸ¥ `m_allDone` çš„çŠ¶æ€ã€‚

   - åœ¨è¿™ 100 æ¯«ç§’ï¼ˆæˆ–è€…æ›´çŸ­ï¼Œå¦‚æœå®ƒåœ¨ `msleep` ä¹‹åæ‰è¢«è®¾ç½®ï¼‰å†…ï¼Œ**ç”µæœºä»åœ¨è¿è¡Œ**ï¼Œå› ä¸º `checkJog` è¿˜æ²¡æœ‰è¿›å…¥ `actionJogStop()` é€»è¾‘ã€‚

4. **ç¬¬äºŒæ¬¡æŒ‰ä¸‹ (`on_actionUpRightFrontBt_pressed`) å‘ç”Ÿåœ¨å»¶è¿ŸæœŸé—´ï¼š**

   - å½“ç”¨æˆ·å¿«é€ŸæŒ‰ä¸‹ç¬¬äºŒæ¬¡æŒ‰é’®æ—¶ï¼Œæ°å¥½å‘ç”Ÿåœ¨è¿™ä¸ª `QThread::msleep(100)` å¯¼è‡´çš„æ—¶é—´çª—å£å†…ï¼Œæˆ–è€…åœ¨ `checkJog` çº¿ç¨‹æ£€æµ‹åˆ° `m_allDone` ä¹‹å‰ã€‚

   - æ­¤æ—¶ï¼Œ`isRunning()` è¢«è°ƒç”¨ã€‚è®©æˆ‘ä»¬å†æ¬¡çœ‹ `isRunning()` çš„é€»è¾‘ï¼š

     ```C++
     bool MotorCtrl::isRunning()
     {
          if(m_checkWoker && m_checkWoker->isRunning()){ // è¿™ä¸¤ä¸ªæ¡ä»¶åœ¨å»¶è¿ŸæœŸé—´éƒ½æ˜¯ true
              QLOG_WARN()<<QString("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…");
              SMessageBox::sQdialogBoxOk(this, QMessageBox::Information, tr("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…"));
              if(m_jog_done){ // <--- å…³é”®ç‚¹ï¼šm_jog_done æ­¤æ—¶ä»ä¸º false
                  return true; // æ‰€ä»¥è¿™ä¸ªåˆ†æ”¯ä¸ä¼šè¢«æ‰§è¡Œ
              }
          }
          return false; // <--- isRunning() æœ€ç»ˆè¿”å› false
     }
     ```

   - ç»“æœå°±æ˜¯ï¼Œ`isRunning()` è¿”å› `false`ï¼Œå°½ç®¡å¼¹å‡ºäº†è­¦å‘Šã€‚

5. **æ–°çš„ `actionJog(1)` è¢«å…è®¸æ‰§è¡Œï¼š**

   - `on_actionUpRightFrontBt_pressed()` ä¸­çš„ `if(!isRunning())` æ¡ä»¶æˆç«‹ã€‚
   - `m_allDone` **è¢«é‡æ–°è®¾ç½®ä¸º `false`**ï¼ˆç”¨äºæ–°çš„ç‚¹åŠ¨ä¼šè¯ï¼‰ã€‚
   - `actionJog(1)` å†æ¬¡è¢«è°ƒç”¨ï¼Œå®ƒä¼šå¯åŠ¨ç”µæœºï¼ˆå¦‚æœä¹‹å‰æœ‰åœæ­¢è¿¹è±¡åˆ™è¢«è¦†ç›–ï¼‰ï¼Œå¹¶å¯èƒ½å¯åŠ¨ä¸€ä¸ªæ–°çš„ `checkJog` çº¿ç¨‹ï¼Œæˆ–è€…**å¤ç”¨å½“å‰çš„ `m_checkWoker` çº¿ç¨‹**ã€‚

### é—®é¢˜æ ¹æºï¼š`m_allDone` çš„â€œè¢«é‡ç½®â€ä¸â€œè¢«è¦†ç›–â€

- **`m_allDone` è¢«â€œé‡ç½®â€ï¼š** ç¬¬ä¸€æ¬¡æ¾å¼€å°† `m_allDone` è®¾ä¸º `true`ï¼Œæ—¨åœ¨åœæ­¢ç”µæœºã€‚

  ä½†æ˜¯ï¼Œåœ¨ `checkJog` çº¿ç¨‹æœ‰æœºä¼šå®Œå…¨å“åº”è¿™ä¸ª `true` å¹¶åœ¨ `actionJogStop()` ä¸­åœæ­¢ç”µæœºä¹‹å‰ï¼Œç¬¬äºŒæ¬¡æŒ‰ä¸‹åœ¨ `actionJog()` å†…éƒ¨**åˆæŠŠ `m_allDone` é‡æ–°è®¾å›äº† `false`**ã€‚

  è¿™å°±åƒç»™ä¸€ä¸ªå³å°†åœæ­¢çš„çº¿ç¨‹å‘äº†ä¸€ä¸ªâ€œåœæ­¢â€ä¿¡å·ï¼Œä½†è¿˜æ²¡ç­‰å®ƒåœä¸‹ï¼Œåˆå‘äº†ä¸€ä¸ªâ€œç»§ç»­è¿è¡Œâ€çš„ä¿¡å·ã€‚

- **`m_jog_done` çš„â€œæ»åæ€§â€ï¼š** `m_jog_done` åªæœ‰åœ¨ `checkJog` çº¿ç¨‹**å®Œå…¨é€€å‡ºå¾ªç¯å¹¶æ‰§è¡Œå®Œ `actionJogStop()`** åæ‰ä¼šè¢«è®¾ç½®ä¸º `true`ã€‚

  ç”±äº `msleep(100)` çš„å­˜åœ¨ï¼Œè¿™ä¸ªâ€œå®Œå…¨é€€å‡ºâ€çš„æ—¶æœºæ¯” `m_allDone = true` çš„è®¾ç½®æ—¶æœºè¦æ™šã€‚å› æ­¤ï¼Œåœ¨ç¬¬äºŒæ¬¡æŒ‰ä¸‹æ—¶ï¼Œ`m_jog_done` ä»ç„¶æ˜¯ `false`ï¼Œæœªèƒ½èµ·åˆ°åº”æœ‰çš„é˜»æ­¢ä½œç”¨ã€‚

å½“ç„¶ï¼Œè¿˜æœ‰å¦ä¸€ç§å¯èƒ½ï¼š

## çº¿ç¨‹å¯åŠ¨å‰çš„å¿«é€ŸåŒå‡»

è®©æˆ‘ä»¬é‡æ–°æ¢³ç†ä¸€ä¸‹è¿™ä¸ªæ›´æ—©ã€æ›´éšè”½çš„ç«æ€åœºæ™¯ï¼š

1. **ç¬¬ä¸€æ¬¡æŒ‰ä¸‹ (`touchBegin`)ï¼š**
   - `on_actionUpRightFrontBt_pressed()` è¢«è°ƒç”¨ã€‚
   - `m_runMode_chb->isChecked()` ä¸ºçœŸã€‚
   - `isRunning()` è¢«è°ƒç”¨ï¼Œæ­¤æ—¶ **`m_checkWoker` å°šæœªè¢«åˆ›å»º**ï¼ˆæˆ–å·²ç»“æŸä¸”ä¸º `nullptr`ï¼‰ï¼Œæ‰€ä»¥ `m_checkWoker && m_checkWoker->isRunning()` ä¸º `false`ï¼Œ`isRunning()` è¿”å› `false`ã€‚
   - `m_allDone` è¢«è®¾ç½®ä¸º `false`ã€‚
   - `actionJog(1)` è¢«è°ƒç”¨ã€‚
2. **`actionJog` å‡½æ•°å¼€å§‹æ‰§è¡Œï¼š**
   - åœ¨ `actionJog` å†…éƒ¨ï¼Œä¼šæœ‰å„ç§å‰ç½®æ£€æŸ¥ (`applyJogConfig`, `isPositionWithinLimit`, `enableJogServo`)ã€‚è¿™äº›æ“ä½œå¯èƒ½éœ€è¦å‡ ååˆ°å‡ ç™¾æ¯«ç§’ã€‚
   - **åœ¨è¿™æ®µå»¶è¿ŸæœŸé—´ï¼Œ`m_checkWoker` çº¿ç¨‹å°šæœªè¢«åˆ›å»ºæˆ–å¯åŠ¨ã€‚**
   - å‡è®¾ `applyJogConfig` å’Œ `isPositionWithinLimit` éƒ½é€šè¿‡äº†ã€‚
   - ç„¶åè°ƒç”¨ `enableJogServo`ï¼Œå®ƒä¼šå°è¯•ä¸‹å‘ç”µæœºå¯åŠ¨å‘½ä»¤ã€‚
3. **ç¬¬ä¸€æ¬¡æ¾å¼€ (`touchEnd`) å‘ç”Ÿåœ¨ `actionJog` å†…éƒ¨ã€çº¿ç¨‹å¯åŠ¨ä¹‹å‰ï¼š**
   - `on_actionUpRightFrontBt_released()` è¢«è°ƒç”¨ã€‚
   - `m_runMode_chb->isChecked()` ä¸ºçœŸã€‚
   - **`m_allDone` è¢«è®¾ç½®ä¸º `true`**ã€‚
4. **ç¬¬äºŒæ¬¡æŒ‰ä¸‹ (`touchBegin`) å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡æ¾å¼€ä¹‹åï¼Œçº¿ç¨‹å¯åŠ¨ä¹‹å‰ï¼š**
   - `on_actionUpRightFrontBt_pressed()` å†æ¬¡è¢«è°ƒç”¨ã€‚
   - `m_runMode_chb->isChecked()` ä¸ºçœŸã€‚
   - `isRunning()` å†æ¬¡è¢«è°ƒç”¨ã€‚**æ­¤æ—¶ `m_checkWoker` ä»ç„¶æ²¡æœ‰è¢« `actionJog` åˆ›å»ºæˆ–å¯åŠ¨**ï¼ˆæˆ–è€…å³ä½¿åˆ›å»ºäº†ï¼Œ`isRunning()` ä¹Ÿä¼šå› ä¸º `!m_checkWoker->isRunning()` è€Œè¿”å› `false`ï¼‰ã€‚
   - æ‰€ä»¥ `isRunning()` è¿”å› `false`ã€‚
   - `if (!isRunning())` æ¡ä»¶æˆç«‹ã€‚
   - `m_allDone` **å†æ¬¡è¢«è®¾ç½®ä¸º `false`**ã€‚
   - `actionJog(1)` å†æ¬¡è¢«è°ƒç”¨ã€‚
5. `actionJog` å‡½æ•°ç¬¬äºŒæ¬¡æ‰§è¡Œå¤±è´¥
   - å‰ç½®æ£€æŸ¥`canStartJog()`ã€‚æ­¤æ£€æŸ¥æ“ä½œä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨å°šæœªåœæ­¢çš„ç‚¹åŠ¨`!m_jog_done`ã€‚æ­¤æ—¶`actionJog`å‡½æ•°ä¼šå› ä¸ºä¸æ»¡è¶³æ­¤æ¡ä»¶ï¼Œè¢«ç»ˆæ­¢æ‰ã€‚
6. **ç»“æœï¼š**
   - ç¬¬ä¸€æ¬¡ `actionJog` è¿˜åœ¨å¿™äºå¯åŠ¨ç”µæœºå’Œå„ç§æ£€æŸ¥ï¼Œå®ƒå†…éƒ¨çš„ `m_allDone` åœ¨å®ƒåˆ›å»ºçº¿ç¨‹ä¹‹å‰è¢«å¤–éƒ¨æ¾å¼€äº‹ä»¶è®¾ç½®ä¸º `true`ã€‚
   - ä½†ç´§æ¥ç€ç¬¬äºŒæ¬¡æŒ‰ä¸‹ï¼ŒåˆæŠŠè¿™ä¸ª `m_allDone` é‡æ–°è®¾ç½®å›äº† `false`ï¼Œå¹¶å¯åŠ¨äº†ç¬¬äºŒæ¬¡ `actionJog` æµç¨‹ã€‚
   - è¿™ä¼šå¯¼è‡´ç¬¬ä¸€æ¬¡ `actionJog` æœ€ç»ˆåˆ›å»º `checkJog` çº¿ç¨‹æ—¶ï¼Œ`m_allDone` å·²ç»æ˜¯ `false`ï¼ˆè¢«ç¬¬äºŒæ¬¡æŒ‰ä¸‹è¦†ç›–ï¼‰ã€‚
   - è€Œç¬¬äºŒæ¬¡çš„ `actionJog` ä¼šç”±äº`canStartJog()`ä¸ºå‡åœæ­¢åˆ›å»ºã€‚ä½†æ˜¯ç¬¬ä¸€æ¬¡ `actionJog` åœ¨åˆ›å»ºçº¿ç¨‹æ—¶å‘ç° `m_allDone` æ˜¯ `false`ï¼Œç„¶åç”µæœºæŒç»­è¿è¡Œã€‚

**æ ¹æœ¬é—®é¢˜ï¼š** `m_allDone` æ˜¯ä¸€ä¸ªå…¨å±€çŠ¶æ€ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œç®¡ç†æ–¹å¼å­˜åœ¨æ¼æ´ã€‚å®ƒæ—¢è¢« `on_actionUpRightFrontBt_released()` ç”¨ä½œå³æ—¶åœæ­¢ä¿¡å·ï¼Œåˆè¢« `actionJog()` ç”¨ä½œæ–°å¯åŠ¨çš„åˆå§‹åŒ–å€¼ã€‚å½“å®ƒä»¬ä¹‹é—´å­˜åœ¨æ—¶é—´å·®æ—¶ï¼Œ`m_allDone` å°±å®¹æ˜“è¢«é”™è¯¯åœ°è¦†ç›–ã€‚

`m_allDone` çš„å¤šç‚¹æ§åˆ¶å’ŒéåŸå­æ€§æ›´æ–°ï¼Œå¯¼è‡´çŠ¶æ€ä¸ç¡®å®šã€‚å®ƒæ—¢æ˜¯ç‚¹åŠ¨å¼€å§‹çš„â€œæ¸…ç†â€ä¿¡å·ï¼ˆåœ¨ `pressed` ä¸­è®¾ä¸º `false`ï¼‰ï¼Œåˆæ˜¯ç‚¹åŠ¨ç»“æŸçš„â€œåœæ­¢â€ä¿¡å·ï¼ˆåœ¨ `released` ä¸­è®¾ä¸º `true`ï¼Œæˆ–åœ¨ `checkJog` å†…éƒ¨è®¾ä¸º `true`ï¼‰

## m_allDoneçš„å¤„ç†æ–¹æ¡ˆ

åœ¨`on_actionUpRightFrontBt_pressed()`å’Œ`on_actionDownLeftBackBt_pressed()`ä¸­ï¼Œå°†`m_allDone`çš„è®¾ç½®å€¼ï¼Œæ”¾åˆ°`actionJog()`ä¸­ã€‚

# 6.28

ä»Šå¤©è§£å†³çš„æ˜¯`è§£å†³è¶…æ—¶ç™»å½•é€€å‡ºæ—¶ï¼Œç‚¹åŠ¨çŠ¶æ€ä»åœ¨è¿›è¡Œçš„é—®é¢˜`

å¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯ç™»å½•ä¹‹å‰ï¼Œæç¤ºè“ç‰™è¿æ¥çŠ¶æ€ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹ç°åœ¨padæ¨¡å¼ä¸‹ï¼Œå¦‚ä½•è¿æ¥è“ç‰™çš„ã€‚å°±æ˜¯åœ¨è®¾ç½®ç•Œé¢ä¸­ï¼Œå…³äºè®¾å¤‡çš„è¿æ¥åŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ã€‚

## MOTOR06aeå±•ç¤º

padåˆšå¼€æœºçš„æ—¶å€™ï¼Œæ˜¯æ—¥å¿—ä¸­å°±è®°å½•äº†

```BASH
INFO  2025-05-13T19:47:56.696 "å‘ç°è“ç‰™è®¾å¤‡:-3C:A8:0A:8F:23:88" 
INFO  2025-05-13T19:47:57.298 "å‘ç°è“ç‰™è®¾å¤‡:-56:F1:7A:F5:66:B2" 
INFO  2025-05-13T19:47:57.368 "å‘ç°è“ç‰™è®¾å¤‡:-58:FF:B6:36:27:0E" 
INFO  2025-05-13T19:47:57.376 "å‘ç°è“ç‰™è®¾å¤‡:-54:E9:34:FA:28:3A" 
INFO  2025-05-13T19:47:57.389 "å‘ç°è“ç‰™è®¾å¤‡:-02:68:EB:45:79:CC" 
INFO  2025-05-13T19:47:57.582 "å‘ç°è“ç‰™è®¾å¤‡:-59:2B:DF:C1:AA:6F" 
INFO  2025-05-13T19:47:57.618 "å‘ç°è“ç‰™è®¾å¤‡:-E2:73:E7:21:BD:1A" 
INFO  2025-05-13T19:47:58.029 ">>>>>>>å‘ç°ç›®æ ‡è“ç‰™è®¾å¤‡MOTOR06ae--A0:DD:6C:02:06:AE<<<<<<<" 
```

# 6.30

ç”µæœºè¿˜åœ¨ä¸‹å ï¼Ÿåˆ°åº•æ˜¯å“ªé‡Œå½±å“äº†ï¼Ÿ

åˆšæ‰å®éªŒäº†ä¸€ä¸‹åŠ é€Ÿå‡é€Ÿæ—¶é—´ï¼Œå‘ç°åŠ é€Ÿæ—¶é—´ç¡®å®æ˜¯é€šè¿‡äº†4sæ‰åŠ é€Ÿä¸Šå»çš„ã€‚ä½†æ˜¯å‡é€ŸåŸºæœ¬ä¸Šå°±æ˜¯ç¬é—´ä»ç›®æ ‡é€Ÿåº¦åˆ°é›¶äº†ï¼Œæ˜¯å¦æœ‰å…¶ä»–å› ç´ å¯¼è‡´è¿™ä¸ªé—®é¢˜ï¼Ÿ

åœ¨ç”µæœºå¯åŠ¨ï¼Œå°è¯•ä¸‹é™è´Ÿè½½çš„ç¬é—´ï¼Œè´Ÿè½½çŸ­æš‚åœ°æ‰è½ã€‚è¿™é€šå¸¸æ˜¯ç”±äº**æŠ±é—¸é‡Šæ”¾è¿‡æ—©æˆ–ç”µæœºæ–½åŠ åŠ›çŸ©ä¸è¶³**å¯¼è‡´çš„ã€‚**ç”µæœºåˆšå¼€å§‹ä½¿èƒ½**ã€ä½†è¿˜æ²¡èƒ½æ§åˆ¶ä½è´Ÿè½½æ—¶ï¼Œ**æœºæ¢°åˆ¶åŠ¨å™¨å·²ç»æå‰é‡Šæ”¾**ï¼Œå¯¼è‡´é‡åŠ›ä½œç”¨ä¸‹è´Ÿè½½**è‡ªç”±ä¸‹è½ï¼ˆçŸ­æ—¶é—´ï¼‰**ã€‚

## æœºæ¢°åˆ¶åŠ¨å™¨ï¼ˆæŠ±é—¸ï¼‰çš„é‡Šæ”¾æ—¶åº

å‚æ•°47ã€48ã€49ä¸»è¦ä¸æœºæ¢°åˆ¶åŠ¨å™¨çš„**åŠ¨ä½œï¼ˆæŠ±ç´§ï¼‰**æ—¶åºæœ‰å…³ï¼š

- **å‚æ•° 47 (ç”µæœºåœæ­¢æ—¶æœºæ¢°åˆ¶åŠ¨å™¨åŠ¨ä½œè®¾å®š)**ï¼šå®šä¹‰ç”µæœºåœè½¬åï¼Œæœºæ¢°åˆ¶åŠ¨å™¨æŠ±ç´§åˆ°ç”µæœºç”µæµåˆ‡æ–­çš„å»¶è¿Ÿæ—¶é—´ã€‚è¿™ä¸ªå‚æ•°æ˜¯ä¸ºäº†ç¡®ä¿ç”µæœºåœ¨å®Œå…¨å¤±ç”µå‰ï¼Œåˆ¶åŠ¨å™¨å·²ç»å¯é æŠ±ç´§ï¼Œé˜²æ­¢åœæ­¢æ—¶çš„ä¸‹å ã€‚
- **å‚æ•° 48 (ç”µæœºè¿è½¬æ—¶æœºæ¢°åˆ¶åŠ¨å™¨åŠ¨ä½œè®¾å®š)**ï¼šå®šä¹‰ç”µæœºè¿è½¬æ—¶ï¼Œç”µæœºç”µæµåˆ‡æ–­åˆ°æœºæ¢°åˆ¶åŠ¨å™¨æŠ±ç´§çš„å»¶è¿Ÿæ—¶é—´ã€‚è¿™ç”¨äºè®©ç”µæœºå…ˆå‡é€Ÿï¼Œä¿æŠ¤åˆ¶åŠ¨å™¨ã€‚
- **å‚æ•° 49 (ç”µæœºè¿è½¬æ—¶æœºæ¢°åˆ¶åŠ¨å™¨åŠ¨ä½œé€Ÿåº¦)**ï¼šå®šä¹‰ç”µæœºåœ¨è¿è½¬æ—¶ï¼Œæœºæ¢°åˆ¶åŠ¨å™¨æŠ±ç´§çš„é€Ÿåº¦é˜ˆå€¼ã€‚

### å…³é”®å‚æ•°

| å‚æ•°ç¼–å· | åç§°                     | ä½œç”¨                                                         | å®é™…æ§åˆ¶é˜¶æ®µ                    |
| -------- | ------------------------ | ------------------------------------------------------------ | ------------------------------- |
| **94**   | ç”µç£åˆ¶åŠ¨å™¨æ‰“å¼€çš„å»¶æ—¶     | ä»ç”µæœºå¼€å§‹é€šç”µï¼ˆç”µæµè¾“å‡ºï¼‰åˆ° **å‘å‡º BRK ON ä¿¡å·**ï¼ˆåˆ¶åŠ¨å™¨æ¾å¼€ï¼‰çš„å»¶æ—¶ | **â€œä¸Šç”µ/å¯åŠ¨â€é˜¶æ®µï¼ˆç”µæœºä½¿èƒ½ï¼‰** |
| **47**   | ç”µæœºåœæ­¢æ—¶åˆ¶åŠ¨å™¨åŠ¨ä½œå»¶æ—¶ | ä»å‘å‡º BRK OFFï¼ˆåˆ¶åŠ¨å™¨åˆä¸Šï¼‰åˆ°ç”µæœºæ–­ç”µçš„å»¶æ—¶                 | **â€œåœæœº/æ–­èƒ½â€é˜¶æ®µ**             |

### **ç”µæœºåˆšä½¿èƒ½ï¼ˆä»éä½¿èƒ½ â†’ ä½¿èƒ½ï¼‰é˜¶æ®µ**çš„åŠ¨ä½œé¡ºåº

```bash
æ—¶é—´çº¿ï¼ˆå¯åŠ¨é˜¶æ®µï¼‰:

1. ç”µæœºä½¿èƒ½ï¼ˆä¼ºæœONï¼‰
2. ç”µæœºå¼€å§‹è¾“å‡ºç”µæµï¼ˆäº§ç”ŸåŠ›çŸ©ï¼‰
3. ç­‰å¾… â€œå‚æ•°94â€ è®¾ç½®çš„å»¶æ—¶æ—¶é—´
4. å‘å‡º BRK ONï¼ˆé‡Šæ”¾æœºæ¢°åˆ¶åŠ¨å™¨ï¼‰
5. ç”µæœºå·²å»ºç«‹åŠ›çŸ© â†’ åˆ¶åŠ¨å™¨æ¾å¼€ â†’ æ‰˜ä½è´Ÿè½½
```

å› æ­¤ï¼š

- **å‚æ•°94 å¤ªå°ï¼š** åˆ¹è½¦è¿‡æ—©æ¾å¼€ â†’ ç”µæœºåŠ›çŸ©å°šæœªå»ºç«‹ â†’ æ‰è½
- **å‚æ•°94 åˆç†ï¼š** ç”µæœºæœ‰è¶³å¤Ÿæ—¶é—´å»ºç«‹æ‰˜ä½è´Ÿè½½çš„åŠ›çŸ© â†’ åˆ¹è½¦æ‰æ¾å¼€ â†’ å®‰å…¨å¯åŠ¨

### è°ƒå‚å»ºè®®

| å‚æ•°          | æ¨èè®¾å®š                          | åŸå›                                                  |
| ------------- | --------------------------------- | ---------------------------------------------------- |
| **PA94**      | **â‰¥ 50~100ms**ï¼ˆå»ºè®®åˆå§‹è®¾ä¸º100ï¼‰ | ç»™ç”µæœºç•™æ—¶é—´è¾“å‡ºç”µæµï¼Œå½¢æˆæ‰˜åŠ›ï¼Œé˜²æ­¢åˆ¹è½¦æå‰æ¾å¼€     |
| **PA47**      | â‰¥ 30~~50ï¼ˆå³300~~500msï¼‰          | ç”µæœºæ–­ç”µå‰ï¼Œå»¶è¿Ÿåˆé—¸åˆ¹è½¦ï¼Œé˜²æ­¢è´Ÿè½½è¿˜æ²¡å®Œå…¨é™æ­¢å°±åˆ¹è½¦ |
| **PA48/PA49** | å¯ç•¥åè°ƒæ•´ï¼ˆä¸åœæœºæœ‰å…³ï¼‰          | å¦‚æœåªæ˜¯å¯åŠ¨æ‰è½é—®é¢˜ï¼Œæš‚æ—¶ä¸ç”¨åŠ¨                     |

ä½†æ˜¯è®¾ç½®å®Œæ¯•åï¼ŒæŠ¥è­¦Err19ï¼ŒåŸå› å°±æ˜¯

> PA94 å‚æ•°å€¼è®¾ç½®è¿‡å¤§ï¼Œæ§åˆ¶è„‰å†²æ¥äº†ï¼ŒæŠ±é—¸è¿˜æœªæ‰“å¼€ã€‚

å°†å»¶è¿Ÿæ—¶é—´è®¾ç½®ä¸º10mså°±èƒ½è§£å†³äº†ã€‚

## è“ç‰™è¿æ¥

### å½“å‰è¿æ¥æµç¨‹

æˆ‘ä»¬å…ˆçœ‹ä¸‹ï¼Œæ­¤padè®¾å¤‡ç™»å½•æ—¶å€™æ˜¯å¦‚ä½•åˆå§‹åŒ–è“ç‰™è®¾å¤‡çš„ã€‚

åˆšç™»é™†åï¼Œå‘ç°æ—¥å¿—æ‰“å°äº†

```C++
INFO  2025-06-30T16:15:03.511 ============== æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ– ============== 
INFO  2025-06-30T16:15:03.512 Qt ç‰ˆæœ¬: 5.14.2 
INFO  2025-06-30T16:15:03.598 "getLocation: ç”µæœº[X1]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º(0)pulse" 
INFO  2025-06-30T16:15:03.599 "getLocation: ç”µæœº[X1]å½“å‰ä½ç½®ä¸º (0) mm " 
INFO  2025-06-30T16:15:03.599 "getLocation: ç”µæœº[X2]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º(0)pulse" 
INFO  2025-06-30T16:15:03.599 "getLocation: ç”µæœº[X2]å½“å‰ä½ç½®ä¸º (0) mm " 
ERROR 2025-06-30T16:15:03.599 "ç”µæœºX1è¯»å–ç‚¹åŠ¨é€Ÿåº¦å¤±è´¥" 
INFO  2025-06-30T16:15:04.233 ">>>>>>>å‘ç°ç›®æ ‡è“ç‰™è®¾å¤‡MOTOR06ae--A0:DD:6C:02:06:AE<<<<<<<" 
INFO  2025-06-30T16:15:04.604 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
INFO  2025-06-30T16:15:04.605 è“ç‰™è®¾å¤‡[ "MOTOR06ae" ]å·²è¿æ¥ï¼Œä¿æŒè¿æ¥çŠ¶æ€ã€‚ 
ERROR 2025-06-30T16:15:05.082 "è“ç‰™è¯»è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†æœªæ”¶åˆ°å›åº”" 
ERROR 2025-06-30T16:15:05.082 "ç”µæœºX1è¯»å–é€Ÿåº¦å¤±è´¥" 
INFO  2025-06-30T16:15:05.515 "ç”µæœº[X1]è½¬é€Ÿä¸º(0)mm/s" 
```

ç»™äººçš„ä½“éªŒå°±æ˜¯ï¼Œå¯åŠ¨åç«‹åˆ»å¼¹çª—æç¤ºç”µæœº`[X1][X2]`ä½ç½®è¯»å–é”™è¯¯ã€‚éšåå¡é¡¿ï¼Œç„¶åå†å¼¹å‡ºç”µæœºé€Ÿåº¦è¯»å–å¤±è´¥ã€‚

æˆ‘ä»¬çœ‹ä¸‹ä»mainå‡½æ•°å¼€å§‹ï¼Œæ—¥å¿—æ˜¯æ€ä¹ˆè®°å½•ä¸Šçš„ï¼š

```C++
int main(int argc, char *argv[])
{
    SQApplication a(argc, argv);
    QLockFile *lockfile = new QLockFile("servo.lock");
    if(!lockfile->tryLock(2000)){
        QMessageBox::critical(nullptr, "é”™è¯¯", "é‡å¤å¯åŠ¨ç¨‹åº", QMessageBox::Cancel);
        return -1;
    }

    // è®¾ç½®æ—¥å¿—è·¯å¾„
    setupFileLogging();


    DbCtrl::DbIint(0);
    MainWindow w;   // åˆ›å»ºä¸»çª—å£å¯¹è±¡

    // æ‘‡æ†æ³¨å†Œ
    InputManager inputManager;
    MotorCtrl *mc = MotorCtrl::get_instance();
    // åˆ›å»ºæ‘‡æ†æ§åˆ¶å™¨ç®¡ç†å™¨
    JoystickControllerManager joystickManager(&inputManager, mc);

    // å°† joystickManager ä¼ é€’ç»™ CenterWindow
    w.centerWindow->setJoystickManager(&joystickManager); // å‡è®¾ CenterWindow æ˜¯ MainWindow çš„å…¬å…±æˆå‘˜æˆ–æœ‰getæ–¹æ³•

    if(DbCtrl::m_systemInfo_tb.mode == 1){
        a.getTimer()->setInterval(DbCtrl::m_systemInfo_tb.screenTime*5000);
        a.connect(a.getTimer(), &QTimer::timeout, &w, &MainWindow::on_timeout);
    }
    w.showSL(); // æ˜¾ç¤ºä¸»çª—å£

//    splash.finish(&w);

    return a.exec();
}
```

å¯ä»¥çœ‹å‡ºï¼Œ`setupFileLogging()`ä¼šæ‰“å°æ—¥å¿—

```bash
INFO  2025-06-30T16:15:03.511 ============== æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ– ============== 
INFO  2025-06-30T16:15:03.512 Qt ç‰ˆæœ¬: 5.14.2 
```

éšååˆå§‹åŒ–ç”µæœº`MotorCtrl`ï¼Œåœ¨å…¶æ„é€ å‡½æ•°ä¸­ï¼Œåˆå§‹åŒ–æ—¶ï¼Œå…¶ä¼šè¯»å–ç”µæœºX1ã€X2çš„ä¿¡æ¯ï¼ˆä½ç½®å’Œé€Ÿåº¦ï¼‰ã€‚

```C++
// åˆå§‹åŒ–è¯»å–ç”µæœºä¿¡æ¯
on_funSl_changed();
```

æ‰€ä»¥ä¼šäº§ç”Ÿæ—¥å¿—

```bash 
INFO  2025-06-30T16:15:03.598 "getLocation: ç”µæœº[X1]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º(0)pulse" 
INFO  2025-06-30T16:15:03.599 "getLocation: ç”µæœº[X1]å½“å‰ä½ç½®ä¸º (0) mm " 
INFO  2025-06-30T16:15:03.599 "getLocation: ç”µæœº[X2]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º(0)pulse" 
INFO  2025-06-30T16:15:03.599 "getLocation: ç”µæœº[X2]å½“å‰ä½ç½®ä¸º (0) mm " 
ERROR 2025-06-30T16:15:03.599 "ç”µæœºX1è¯»å–ç‚¹åŠ¨é€Ÿåº¦å¤±è´¥" 
```

é‚£ä¹ˆæ€ä¹ˆåœ¨è¯»å–è¿‡ç¨‹ä¸­å°±å¯åŠ¨äº†`å‘ç°è“ç‰™è®¾å¤‡`çš„æµç¨‹å‘¢ï¼Ÿ

### å‘ç°è“ç‰™è®¾å¤‡

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ—¥å¿—æ˜¯ä»`ModbusBt`æ¨¡å—å‘é€å‡ºæ¥çš„ï¼š

```C++
// å®šä¹‰
private slots:
    void onDeviceDiscovered(const QBluetoothDeviceInfo &info);
// å®ç°
void ModbusBt::onDeviceDiscovered(const QBluetoothDeviceInfo &info)
{
    if (info.name().contains(BT_NAME_PREFIX)) {
        QLOG_INFO()<<QString(">>>>>>>å‘ç°ç›®æ ‡è“ç‰™è®¾å¤‡%1--%2<<<<<<<").arg(info.name())
                     .arg(info.address().toString());
        m_devices.append(qMakePair(info.name(), info.address().toString()));
        if(m_currDev == info.name()){
            if(m_isHold){
                open(m_currDev);
            }
        }
        emit em_motorDiscovered(info.name());
    }else{
//        QLOG_INFO()<<QString("å‘ç°è“ç‰™è®¾å¤‡:%1-%2").arg(info.name()).arg(info.address().toString());
    }
}
```

æ‰€ä»¥è‚¯å®šçš„æ˜¯ï¼ŒæŸä¸ªä¿¡å·çš„å‡ºç°è°ƒç”¨äº†è¿™ä¸ªæ§½å‡½æ•°ã€‚

**æ ¸å¿ƒé—®é¢˜å°±åœ¨è¿™é‡Œã€‚** `MotorCtrl` ç±»çš„ç”µæœºä¿¡æ¯è¯»å–æ“ä½œï¼ˆä¾‹å¦‚ `getLocation` æˆ– `readReg16`ï¼‰æœ€ç»ˆä¼šé€šè¿‡ **`ModbusBt`** çš„å®ä¾‹è¿›è¡Œé€šä¿¡ã€‚åœ¨ `ModbusBt` çš„æ„é€ å‡½æ•°ä¸­ï¼Œå®ƒä¼šåˆå§‹åŒ– `QBluetoothDeviceDiscoveryAgent` å¹¶ç«‹å³å¯åŠ¨è“ç‰™æ‰«æï¼š

```CPP
ModbusBt::ModbusBt(QObject *parent) : ModbusIO(parent)
{
    ...
    m_discoveryAgent = new QBluetoothDeviceDiscoveryAgent(this);
    m_socket = new QBluetoothSocket(QBluetoothServiceInfo::RfcommProtocol, this);
    connect(m_discoveryAgent, &QBluetoothDeviceDiscoveryAgent::deviceDiscovered, this, &ModbusBt::onDeviceDiscovered);
    ...
}
```

æ‰€ä»¥ï¼Œ**ç°åœ¨æä¾›çš„æ—¥å¿—é¡ºåºè¡¨æ˜ï¼Œè“ç‰™æ‰«ææ˜¯åœ¨ `MotorCtrl` å°è¯•è¯»å–ç”µæœºä¿¡æ¯**ï¼ˆå¯¼è‡´â€œç”µæœºX1è¯»å–ç‚¹åŠ¨é€Ÿåº¦å¤±è´¥â€ç­‰é”™è¯¯ï¼‰**çš„** **åŒæ—¶æˆ–ä¹‹å** **ç«‹å³å¼€å§‹çš„ã€‚**

### æ”¹è¿›ä½“éªŒ

éœ€è¦è°ƒæ•´å¯åŠ¨æ—¶çš„æµç¨‹ï¼š

1. **å°†è“ç‰™è®¾å¤‡çš„å‘ç°å’Œè¿æ¥ä½œä¸ºåº”ç”¨ç¨‹åºå¯åŠ¨çš„** **å‰ç½®æ­¥éª¤** æˆ–åœ¨åå°é™é»˜è¿›è¡Œã€‚
2. åªæœ‰åœ¨è“ç‰™è¿æ¥æˆåŠŸåï¼Œæ‰å°è¯•è¿›è¡Œ Modbus é€šä¿¡ï¼Œè¯»å–ç”µæœºæ•°æ®ã€‚

ä½¿ç”¨æ–¹æ¡ˆä¸ºï¼š**é€šè¿‡ä¿¡å·æ§½æœºåˆ¶å¼‚æ­¥å¤„ç†ï¼ˆæ¨èï¼Œæ›´æµç•…ï¼‰**

1. **è®© `MotorCtrl` åœ¨åˆå§‹åŒ–æ—¶** **ä¸ç«‹å³è¯»å–** **ç”µæœºæ•°æ®ã€‚**
2. **å½“ `ModbusBt` æŠ¥å‘Šè“ç‰™è¿æ¥æˆåŠŸæ—¶ï¼Œé€šè¿‡ä¿¡å·æ§½é€šçŸ¥ `MotorCtrl` å¼€å§‹è¯»å–ç”µæœºæ•°æ®ã€‚**

è®¾ç½®ç•Œé¢ä¸­ï¼Œè“ç‰™è®¾å¤‡åç§°ä¸å±•ç¤ºã€‚

## è“ç‰™è®¾å¤‡é€‰æ‹©

ç‚¹å‡»åˆ·æ–°åˆ—è¡¨ï¼Œåœ¨padæ¨¡å¼ä¸‹æ²¡æ³•è·å–åˆ°æ­£ç¡®çš„è®¾å¤‡ä¿¡æ¯ã€‚

å½“å‰è·å–è®¾å¤‡ä¿¡æ¯çš„æ–¹æ³•ä¸ºï¼š

```C++
bool BaseConfig::getDevList()
{
    m_com_cb->clear();
    if(DbCtrl::m_systemInfo_tb.useBt){
        ModbusBt::get_instance(this)->startScan();
    }else{
        QStringList list;
        foreach (const QSerialPortInfo &info, QSerialPortInfo::availablePorts()){
            list.append(info.portName());
        }
        m_com_cb->addItems(list);
    }
    return true;
}
```

åœ¨åˆ¤æ–­è“ç‰™è¿æ¥çš„æ—¶å€™ï¼Œæ‰§è¡Œäº†`ModbusBt`ä¸‹çš„`startScan()`å‡½æ•°

```C++
void ModbusBt::onDeviceDiscovered(const QBluetoothDeviceInfo &info)
{
    if (info.name().contains(BT_NAME_PREFIX)) {
        QLOG_INFO()<<QString(">>>>>>>å‘ç°ç›®æ ‡è“ç‰™è®¾å¤‡%1--%2<<<<<<<").arg(info.name())
                     .arg(info.address().toString());
        m_devices.append(qMakePair(info.name(), info.address().toString()));
        if(m_currDev == info.name()){
            if(m_isHold){
                open(m_currDev);
            }
        }
        emit em_motorDiscovered(info.name());
    }else{
//        QLOG_INFO()<<QString("å‘ç°è“ç‰™è®¾å¤‡:%1-%2").arg(info.name()).arg(info.address().toString());
    }
}
```

ä½†æ˜¯å¹¶æ²¡æœ‰å°†è·å–åˆ°çš„åç§°ï¼Œè®¾ç½®åˆ°å¤é€‰æ¡†ä¸­ã€‚
