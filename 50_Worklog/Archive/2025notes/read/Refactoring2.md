# 第 1 章 重构,第一个示例

- 如果程序杂乱无章,先为它整理出结构来,再做需要的修改,通常来说更加简单
- 不论最终提出什么方案,他们一定会在6个月之内再次修改它
- 重构的时机：是需求的变化使重构变得必要。如果一段代码能正常工作,并且不会再被修改,那么完全可以不去重构它

## 1.3 重构的第一步

充分的测试体系

- 确保即将修改的代码拥有一组可靠的测试
- 重构前,先检查自己是否有一套可靠的测试集。这些测试必须有自我检验能力。
- 尽管编写测试需要花费时间,但却为我节省下可观的调试时间

## 1.4 分解statement函数

- 小步修改,每次修改后就运行测试。以微小的步伐修改程序
- 代码推送(push)到远端仓库前,我会把零碎的修改压缩成一个更有意义的提交(commit)
- 进一步提升其表达能力
- 唯有能写出人类容易理解的代码的,才是优秀的程序员。
- 先优化结构，再优化性能。如果重构引入了性能损耗,先完成重构,再做性能优化
- 好代码的检验标准就是人们是否能轻而易举地修改它
- 小的步子可以更快前进,请保持代码永远处于可工作状态,小步修改累积起来也能大大改善系统的设计

# 第2章 重构的原则

>  :thumbsup:重构的关键在于运用大量微小且保持软件行为的步骤,一步步达成大规模的修改。每个单独的重构要么很小,要么由若干小步骤组合而成。因此,在重构的过程中,我的代码很少进入不可工作的状态,即便重构没有完成,我也可以在任何时刻停下来。
>
> 如果有人说他们的代码在重构过程中有一两天时间不可用,基本上可以确定,他们在做的事不是重构。

- 重构是为了让代码“更容易理解,更易于修改

## 2.3 为何重构

- 代码越多,做正确的修改就越困难
- 性能VS可读性：计算机是否多花了几个时钟周期来编译,又有什么关系呢?如果一个程序员花费一周时间来修改某段代码,那才要命呢——如果他理解了我的代码,这个修改原本只需一小时。

## 2.4 何时重构

在我编程的每个小时,我都会做重构。

- 一旦我需要思考“这段代码到底在做什么”的时候，就可以重构了
- 重构的价值：在研读代码时,重构会引领我获得更高层面的理解,如果只是阅读代码很难有此领悟
- 有些人以为这些重构只是毫无意义地把玩代码,他们没有意识到,缺少了这些细微的整理,他们就无法看到隐藏在一片混乱背后的机遇。
- 至少要让营地比你到达时更干净
- 重构不是与编程割裂的行为。你不会专门安排时间重构,正如你不会专门安排时间写if语句。
- 优秀的程序员知道,添加新功能最快的方法往往是先修改现有的代码,使新功能容易被加入。
- 如果不花一点儿时间尝试,往往很难真实了解重构一块代码的难度

何时不能重构呢？如果重写比重构还容易,就别重构了（需要考虑清楚）

## 2.5 重构的挑战

> :thumbsup: 重构的意义不在于把代码库打磨得闪闪发光,而是纯粹经济角度出发的考量。我们之所以重构,因为它能让我们更快——添加功能更快,修复bug更快。

不会改变程序可观察的行为,这是重构的一个重要特征。

- 没有自测试的代码，重构风险太大,可能引入bug

针对遗留代码（servoV3）

- 重构可以很好地帮助我们理解遗留系统
- 把程序从一块顽石打磨成美玉

## 2.6 重构、架构和YAGNI

重构可以改善既有代码的设计。

- 在编码之前先完成架构:ear:：假设了软件的需求可以预先充分理解。但经验显示,这个假设很多时候甚至可以说大多数时候是不切实际的。只有真正使用了软件、看到了软件对工作的影响,人们才会想明白自己到底需要什么,这样的例子不胜枚举。
- 不要猜测未来：有了重构技术,我就可以采取不同的策略。与其猜测未来需要哪些灵活性、需要什么机制来提供灵活性,我更愿意只根据当前的需求来构造软件,同时把软件的设计质量做得很高。

## 2.7 重构与软件开发过程

> 重构的第一块基石是自测试代码。我应该有一套自动化的测试，我可以频繁地运行它们，并且我有信心：如果我在编程过程中犯了任何错误，会有测试失败。

那么我是否存在这样的自测代码呢？

主要是当前面对的是像电机这样，需要交互，改完代码以后需要上机实践的情况下，怎么做好测试体系呢？

又像是，使用界面的测试，又该怎么写好测试体系呢？🚗

# 第 3 章 代码的坏味道

如果尿布臭了，就换掉它。

# 第 4 章 构筑测试体系

## 4.1 自测试代码的价值

- “类应该包含它们自己的测试代码。”这让我决定，将测试代码和产品代码一起放到代码库中。
- 简单运行自测的方法：确保所有测试都完全自动化，让它们检查自己的测试结果。
- 写接口前的准备：添加特性时，先编写相应的测试代码。为了添加这个功能，我需要实现些什么？编写测试代码还能帮我把注意力集中于接口而非实现（这永远是一件好事）。
- 一旦测试代码正常运行，工作就可以结束了
- 测试驱动开发：先编写一个（失败的）测试，编写代码使测试通过，然后进行重构以保证代码整洁。这个“测试、编码、重构”的循环应该在每个小时内都完成很多次。这种良好的节奏感可使编程工作以更加高效、有条不紊的方式开展。
- 重构之前，记得先为它添加测试
- 频繁地运行测试。对于你正在处理的代码，与其对应的测试至少每隔几分钟就要运行一次，每天至少运行一次所有的测试
- 正常路径测完后，测试非正常路径