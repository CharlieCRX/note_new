# 10.9

å›½åº†å›å½’ï¼Œæ•´ç†ä¸‹è‡ªå·±çš„ä»»åŠ¡å®‰æ’

## ä»»åŠ¡å®‰æ’

### AD5932

1. æ–°å¼€å‘æ¿DTSæ ‘é€‚é…è°ƒè¯•ï¼ˆæ˜¯å¦ä¿®æ”¹ä¹‹å‰çš„PHYèŠ‚ç‚¹ä»¥é€‚åº”æ–°å¼€å‘æ¿ç­‰ï¼‰1å¤©
2. AD5932 ä¸»ç¨‹åºé€»è¾‘éªŒè¯è°ƒè¯• 1 å¤©
3. åŸºäºä¸Šé¢è°ƒè¯•ç»“æœï¼Œå®Œå–„å•æ³¢æŸé¡¹ç›®çš„æ³¢å½¢ç”Ÿæˆæ¥å£ + è°ƒè¯•æ¥å£ 2 å¤©
4. é…ç½®å•æ³¢æŸå›è°ƒå‡½æ•° 0.5 å¤©

### æ°´æ± é—®é¢˜è§£å†³

1. è°ƒè¯•åŒç”µæœºå‡ºç°çš„å¡é¡¿+å»¶è¿Ÿé—®é¢˜ï¼ˆ3å¤©ï¼‰
2. åŠ å…¥å¯é…ç½®çš„åŒå¥—ç”µæœºæ¨¡å¼é€‚é…ï¼ˆå¾…å®šæ—¶é•¿ï¼‰

ç°åœ¨ç”±äºå¿˜è®°äº†AD5932çš„ç›¸å…³å†…å®¹ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°é˜…è¯»ä¸‹AD5932çš„æ‰‹å†Œã€‚

## AD5932è°ƒè¯•

ç°åœ¨éœ€è¦è®©ç¨‹åºè·‘èµ·æ¥ã€‚éœ€è¦éªŒè¯ï¼š

- èƒ½å¦æ­£å¸¸é€šè¿‡ SPI æ€»çº¿é€šä¿¡
- è¯»å†™æ–¹æ³•æ˜¯å¦å†™å¯¹

è¿™ä¸ªé€šä¿¡éªŒè¯éœ€è¦é€šè¿‡ç”Ÿæˆç®€å•çš„æ­£å¼¦ã€ä¸‰è§’å’Œæ–¹æ³¢æ¥å®ç°ã€‚é¦–å…ˆå°±æ˜¯å®ç°ä¸€ä¸ªç®€å•çš„æ­£å¼¦æ³¢ã€‚

ç»è¿‡éªŒè¯å‘ç°ï¼Œä»£ç å¹¶æ²¡æœ‰æ­£ç¡®åœ°ç”Ÿæˆæ­£å¼¦æ³¢ã€‚ä¸‹é¢å°±éœ€è¦è®¤çœŸçœ‹ä¸‹ï¼Œåˆ°åº•å“ªé‡Œå¯¼è‡´çš„æ³¢å½¢è¾“å‡ºä¸å¯¹çš„ã€‚

ç°åœ¨ç°è±¡å°±æ˜¯ï¼Œå†™å…¥ä¸€ä¸ªé¢‘ç‡ä¸º 10000Hz çš„æ­£å¼¦æ³¢è¾“å‡ºï¼Œä½†æ˜¯æµ‹é‡çš„ VOUT å¹¶ä¸å­˜åœ¨ã€‚

## AD5932é€šä¿¡

AD5932 ä½¿ç”¨çš„æ—¶é’Ÿé¢‘ç‡ä¸º 50MHzï¼Œå¹¶ä¸”ä½¿ç”¨ SPI æ€»çº¿æ§åˆ¶å™¨çš„ä¸‰å·æ§åˆ¶å™¨æ¥ä¸ CPU è¿›è¡Œäº¤äº’ã€‚

æ‰€ä»¥`spi_init`å’Œ`ad5932_write`ä¸¤ä¸ªå‡½æ•°åº”è¯¥æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ã€‚å› ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯è·Ÿä¹‹å‰çš„é€šä¿¡ä»£ç ç›¸åŒçš„ã€‚

## AD5932æ‰‹å†Œ

### ğŸ§© AD5932 å¼•è„šåŠŸèƒ½ç®€æ˜æ¸…å•

| å¼•è„šå· | åç§°          | ç±»å‹     | ä¸»è¦åŠŸèƒ½                       | å¤‡æ³¨                                                      |
| ------ | ------------- | -------- | ------------------------------ | --------------------------------------------------------- |
| **1**  | **COMP**      | æ¨¡æ‹Ÿ     | DAC åç½®ç”µå‹å»è€¦               | æ¥ä¸€ä¸ªç”µå®¹åˆ° AVDD                                         |
| **2**  | **AVDD**      | ç”µæº     | æ¨¡æ‹Ÿç”µæºï¼ˆ2.3~5.5 Vï¼‰          | åŠ  0.1 ÂµF å»è€¦ç”µå®¹åˆ° AGND                                 |
| **3**  | **DVDD**      | ç”µæº     | æ•°å­—ç”µæºï¼ˆ2.3~5.5 Vï¼‰          | åŠ  0.1 ÂµF å»è€¦ç”µå®¹åˆ° DGND                                 |
| **4**  | **CAP/2.5V**  | ç”µæº     | å†…éƒ¨ 2.5 V ç¨³å‹è¾“å‡º            | å…¸å‹æ¥ 100 nF ç”µå®¹åˆ° DGNDï¼›è‹¥ DVDD â‰¤ 2.7 Vï¼Œå¯çŸ­æ¥åˆ° DVDD |
| **5**  | **DGND**      | åœ°       | æ•°å­—åœ°                         | ä¸ AGND åˆ†å¼€å¸ƒçº¿åå•ç‚¹è¿æ¥                                |
| **6**  | **MCLK**      | è¾“å…¥     | ä¸»æ—¶é’Ÿè¾“å…¥                     | å†³å®šè¾“å‡ºé¢‘ç‡ä¸ç›¸ä½å™ªå£°                                    |
| **7**  | **SYNCOUT**   | è¾“å‡º     | æ‰«æçŠ¶æ€è¾“å‡ºï¼ˆEOS æˆ–æ­¥è¿›ä¿¡å·ï¼‰ | éœ€è®¾ SYNCOUTEN=1 å¯ç”¨                                     |
| **8**  | **MSBOUT**    | è¾“å‡º     | DAC æ•°æ®çš„åå‘ MSB             | éœ€è®¾ MSBOUTEN=1 å¯ç”¨                                      |
| **9**  | **INTERRUPT** | è¾“å…¥     | æ‰«æä¸­æ–­ä¿¡å·                   | ä½â†’é«˜è§¦å‘ï¼Œè¾“å‡ºå›åˆ°ä¸­å€¼                                   |
| **10** | **CTRL**      | è¾“å…¥     | æ§åˆ¶å¯åŠ¨/åˆå§‹åŒ–/å¤–éƒ¨æ­¥è¿›       | ä½â†’é«˜è§¦å‘åŠ¨ä½œï¼Œæ¨¡å¼ç”±å¯„å­˜å™¨å†³å®š                           |
| **11** | **SDATA**     | è¾“å…¥     | ä¸²è¡Œæ•°æ®è¾“å…¥                   | å…ˆåœ°å€ï¼Œåæ•°æ®ï¼ˆMSBâ†’LSBï¼‰                                 |
| **12** | **SCLK**      | è¾“å…¥     | ä¸²è¡Œæ—¶é’Ÿè¾“å…¥                   | æ•°æ®åœ¨ä¸‹é™æ²¿é‡‡æ ·                                          |
| **13** | **FSYNC**     | è¾“å…¥     | å¸§åŒæ­¥ä¿¡å·ï¼ˆä½æœ‰æ•ˆï¼‰           | æ‹‰ä½è¡¨ç¤ºå¼€å§‹å‘é€æ–°å­—                                      |
| **14** | **STANDBY**   | è¾“å…¥     | çœç”µæ¨¡å¼ï¼ˆé«˜æœ‰æ•ˆï¼‰             | é«˜ç”µå¹³ï¼šå…³é—­ MCLK/DAC/ç¨³å‹å™¨                              |
| **15** | **AGND**      | åœ°       | æ¨¡æ‹Ÿåœ°                         | å»ºè®®ä¸ DGND å•ç‚¹è¿æ¥                                      |
| **16** | **VOUT**      | æ¨¡æ‹Ÿè¾“å‡º | æ¨¡æ‹Ÿè¾“å‡ºä¿¡å·ç«¯                 | å†…éƒ¨ 200 Î© è´Ÿè½½ï¼Œæ¨èåŠ  20 pF åˆ° AGND                     |

### ğŸ§­ AD5932 Control Register ä½å®šä¹‰ï¼ˆç®€æ˜ç‰ˆï¼‰

| ä½å·        | åç§°             | åŠŸèƒ½æè¿°                                                     | å¯é€‰å€¼                     |
| ----------- | ---------------- | ------------------------------------------------------------ | -------------------------- |
| **D15â€“D12** | **ADDR**         | å¯„å­˜å™¨åœ°å€ï¼ˆ4 ä½ï¼‰                                           | å‚è€ƒè¡¨ 5ï¼ˆå†™å…¥ä¸åŒå¯„å­˜å™¨ï¼‰ |
| **D11**     | **B24**          | é¢‘ç‡å¯„å­˜å™¨å†™å…¥æ–¹å¼é€‰æ‹©ï¼š1 = ä¸€æ¬¡å†™å…¥å®Œæ•´ 24 ä½ï¼ˆè¿ç»­ä¸¤æ¬¡å†™å…¥ LSBâ†’MSBï¼‰ï¼›0 = åˆ†åˆ«æ“ä½œé«˜/ä½ 12 ä½å¯„å­˜å™¨ | 0 / 1                      |
| **D10**     | **DAC ENABLE**   | DAC ä½¿èƒ½ï¼š1 = å¯ç”¨ DAC è¾“å‡ºï¼›0 = å…³é—­ DACï¼ˆä»…è¾“å‡º MSBOUT ä¿¡å·ï¼‰ | 0 / 1                      |
| **D9**      | **SINE/TRI**     | è¾“å‡ºæ³¢å½¢ç±»å‹ï¼š1 = æ­£å¼¦æ³¢ï¼ˆç» ROM è½¬æ¢ï¼‰ï¼›0 = ä¸‰è§’æ³¢ï¼ˆç»•è¿‡ ROMï¼‰ | 0 / 1                      |
| **D8**      | **MSBOUTEN**     | MSBOUT å¼•è„šè¾“å‡ºæ§åˆ¶ï¼š1 = è¾“å‡º MSBï¼›0 = é«˜é˜»æ€                | 0 / 1                      |
| **D7**      | â€”                | **ä¿ç•™ä½ï¼Œå¿…é¡»ç½® 1**                                         | å›ºå®šä¸º 1                   |
| **D6**      | â€”                | **ä¿ç•™ä½ï¼Œå¿…é¡»ç½® 1**                                         | å›ºå®šä¸º 1                   |
| **D5**      | **INT/EXT INCR** | é¢‘ç‡æ­¥è¿›è§¦å‘æºï¼š1 = å¤–éƒ¨è§¦å‘ï¼ˆCTRL å¼•è„šï¼‰ï¼›0 = è‡ªåŠ¨æ­¥è¿›      | 0 / 1                      |
| **D4**      | â€”                | **ä¿ç•™ä½ï¼Œå¿…é¡»ç½® 1**                                         | å›ºå®šä¸º 1                   |
| **D3**      | **SYNCSEL**      | SYNCOUT è¾“å‡ºæ¨¡å¼ï¼ˆä»…å½“ D2=1 æ—¶æœ‰æ•ˆï¼‰ï¼š1 = æ‰«æç»“æŸè¾“å‡ºé«˜ç”µå¹³ï¼ˆEOS æ¨¡å¼ï¼‰ï¼›0 = æ¯æ¬¡æ­¥è¿›è¾“å‡ºè„‰å†²ï¼ˆ4Ã—TCLOCKï¼‰ | 0 / 1                      |
| **D2**      | **SYNCOUTEN**    | SYNCOUT å¼•è„šä½¿èƒ½ï¼š1 = è¾“å‡ºæœ‰æ•ˆï¼›0 = é«˜é˜»æ€                   | 0 / 1                      |
| **D1**      | â€”                | **ä¿ç•™ä½ï¼Œå¿…é¡»ç½® 1**                                         | å›ºå®šä¸º 1                   |
| **D0**      | â€”                | **ä¿ç•™ä½ï¼Œå¿…é¡»ç½® 1**                                         | å›ºå®šä¸º 1                   |

# 10.10

ä»Šæ—¥ä»»åŠ¡å°±æ˜¯é…ç½®RK3568çš„fpgaè¯»å†™åŠŸèƒ½ï¼Œå®ç°CTRLå¼•è„šçš„æ§åˆ¶ã€‚

ç°åœ¨å·²ç»å°† fpga è¯»å†™ç¨‹åºæ”¾å…¥åˆ°äº†å¼€å‘æ¿ä¸­ï¼Œä½†æ˜¯å³ä½¿å†™å…¥äº†é¢‘ç‡å¯„å­˜å™¨å¹¶ä¸”è®¾ç½®è¾“å‡ºæ ·å¼ä¸ºæ­£å¼¦æ³¢åï¼Œæ‹‰é«˜CTRLå¼•è„šï¼Œä¹Ÿä»ç„¶æ²¡æœ‰ä½œç”¨ã€‚

å¥½çš„ï¼Œç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œå‘ç°ç¡®å®éœ€è¦å†™å…¥é¢‘ç‡å¯„å­˜å™¨åï¼Œå†ä½¿ç”¨CTRLå¼€å§‹é¢‘ç‡è¾“å‡ºã€‚

# 10.11

## ç‘•ä¸æ©ç‘œ

ç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œå‘ç° AD5932 çš„ MSBOUT å¼•è„šç¡®å®èƒ½å¤Ÿè¾“å‡ºå¯¹åº”é¢‘ç‡çš„æ–¹æ³¢ -- ä½†åŒæ—¶ä¹Ÿæ··æ‚ç€ä¸€ä¸ª 25 MHz çš„æ­£å¼¦æ³¢ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥æš‚æ—¶ä¸è€ƒè™‘è¿™ä¸ªæ­£å¼¦æ³¢é€ æˆçš„å›°æ‰°ï¼Œè½¬è€Œåº†è´ºä¸‹å½“å‰ä»£ç çš„ç»“æ„åŸºæœ¬æ²¡ä»€ä¹ˆé—®é¢˜ï¼š

1. SPI è¯»å†™é€»è¾‘æ²¡é—®é¢˜
2. FPGA æ§åˆ¶ CTRL å¼•è„šæ²¡é—®é¢˜
3. å†™é¢‘ç‡å­—é€»è¾‘æ²¡é—®é¢˜

ä¸‹é¢å°±è¦å¼€å§‹æ‰«é¢‘äº†ã€‚

# 10.13

## fpgaè¾“å‡º

ç°åœ¨æ‰§è¡Œå¼€å‘æ¿çš„å‘½ä»¤ï¼š

```BASH
root@RK356X:/# fpga -r 0x13
00000000
```

ç»“æœä¸º`00000000`æˆ–`00000001`ã€‚

è€Œç°åœ¨æˆ‘éœ€è¦é€šè¿‡Cè¯­è¨€çš„`system()`å‡½æ•°æ¥æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œå¹¶å°†è·å–åˆ°çš„å€¼ï¼Œè½¬æ¢ä¸º 0 æˆ–è€… 1ã€‚`system()` **åªè¿”å›å‘½ä»¤çš„é€€å‡ºçŠ¶æ€**ï¼ˆexit codeï¼‰ï¼Œè€Œä¸æ˜¯å‘½ä»¤çš„ **è¾“å‡ºç»“æœ**ã€‚

æ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°èƒ½å¤Ÿæ•è·å‘½ä»¤è¾“å‡ºçš„æ–¹æ³•ã€‚è¿™é‡Œç”¨åˆ°äº†ï¼š

```C
FILE *popen(const char *command, const char *mode);
int pclose(FILE *stream);
```

- **åŠŸèƒ½**

   åˆ›å»ºä¸€ä¸ªç®¡é“ï¼ˆpipeï¼‰ï¼Œå¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œ `command`ï¼Œå¹¶è¿”å›ä¸€ä¸ª `FILE*` æµã€‚
   ä¸»è¿›ç¨‹å°±èƒ½é€šè¿‡è¿™ä¸ªæµè¯»å–å‘½ä»¤çš„è¾“å‡ºæˆ–å†™å…¥å‘½ä»¤çš„è¾“å…¥ã€‚

- **è¿”å›å€¼**

  - æˆåŠŸï¼šè¿”å› `FILE*` æŒ‡é’ˆï¼Œå¯ä»¥ç”¨ `fgets()`ã€`fscanf()` ç­‰æ ‡å‡† I/O å‡½æ•°æ“ä½œï¼›
  - å¤±è´¥ï¼šè¿”å› `NULL`ã€‚

## æµ‹è¯•é€»è¾‘

ç°åœ¨å…ˆæµ‹è¯•ä¸€ä¸ªåœºæ™¯ï¼š

> èµ·å§‹é¢‘ç‡ï¼š50KHz
>
> Î”fï¼š2KHz
>
> é€’å¢æ¬¡æ•°ï¼š10æ¬¡
>
> æ¯ä¸ªæ³¢å½¢æŒç»­å‘¨æœŸï¼š2ä¸ª

åº”è¯¥è¾“å…¥çš„æ˜¯ï¼š

```BASH
./ad5932_test -s 50000 -d 2000  -n 2 -w 2
```

è¿™æ ·è¾“å…¥æ—¶ï¼Œ5932çš„è¾“å‡ºæƒ…å†µå°±æ˜¯ï¼š

> é”™è¯¯è¾“å‡º1ï¼š
>
> æ³¢å½¢ï¼šæ–¹æ³¢
>
> é¢‘ç‡ï¼šåªæœ‰ç»ˆæ­¢é¢‘ç‡ 70KHz
>
> æŒç»­æ—¶é—´ï¼š18.5ms
>
> é”™è¯¯åŸå› ï¼šæµ‹é‡é”™è¯¯ï¼Œä¸ä¼šä½¿ç”¨ç¤ºæ³¢å™¨çš„æµ‹é‡

> é”™è¯¯è¾“å‡º2ï¼šï¼ˆæ­¤æ¬¡èµ·å§‹é¢‘ç‡ä¸º20KHzï¼‰
>
> é¢‘ç‡ï¼šèµ·å§‹20KHzï¼Œç»“æŸä¸º40KHz

# 10.14

ä»Šå¤©ä¸»è¦ä»»åŠ¡å°±æ˜¯äº‰å–å°† AD5932 çš„é©±åŠ¨ç¨‹åºé›†æˆåˆ°é¡¹ç›®ä¸­ã€‚éœ€è¦é¢å¯¹çš„é—®é¢˜æ˜¯ï¼š

- `ad5932_test`ä¿®æ”¹äº†ä»€ä¹ˆä»£ç é€»è¾‘ï¼Œå°†å…¶ä¿®æ”¹åˆ°`singleBeam`
- å±è”½`singleBeam`å½“å‰*è™šå‡*çš„ç”¨æˆ·å±‚`app`ï¼Œå¹¶å†™ä¸€ä¸ªæµ‹è¯•ä¸»å‡½æ•°å’Œ`cmake`è„šæœ¬è¿›è¡Œæµ‹è¯•
- æµ‹è¯•æ— è¯¯åï¼Œå‘ä½•æ€»ç¡®å®šè¿›ä¸€æ­¥çš„éœ€æ±‚ï¼ˆåº“ or collecterã€gmacé€šä¿¡å›¾ç¤ºï¼‰

æ–°åŠ åŠŸèƒ½ï¼šè¾“å‡ºå›ºå®šæ—¶é•¿çš„å›ºå®šé¢‘ç‡æ³¢å½¢å‡½æ•°

## å›ºå®šæ—¶é•¿çš„å›ºå®šé¢‘ç‡æ³¢å½¢è¾“å‡º

è¿™ä¸ªé€»è¾‘å¯ä»¥é€šè¿‡ç²—è°ƒï¼š

- æ§åˆ¶å¯„å­˜å™¨è®¾ç½®æ³¢å½¢è¾“å‡ºçš„åŒæ—¶ï¼Œç¦ç”¨ SYNCOUT å¼•è„š
- è®¾ç½®æ­¥è¿›é¢‘ç‡å¯„å­˜å™¨çš„å€¼ä¸º 0 
- ä¼‘çœ å›ºå®šæ—¶é•¿åï¼Œæ‰§è¡Œresetæ“ä½œ

ä½†æ˜¯è¿™æ ·å¯¼è‡´çš„æœ€å¤§é—®é¢˜å°±æ˜¯ï¼šç²—è°ƒæ—¶é—´ä¸ç¨³å®šã€‚åœ¨ä¼‘çœ å›ºå®šæ—¶é•¿åï¼Œè®¾å¤‡éœ€è¦æ—¶é—´æ¥æ‰§è¡Œ i2c æ€»çº¿çš„ fpga å†™ STANDBY å¯„å­˜å™¨ä¸º 1 çš„æµç¨‹ã€‚ç»è¿‡æµ‹è¯•ï¼Œå‘ç°æ—¶é—´å¤§äº 4 msï¼Œå¾ˆä¸ç¨³å®šã€‚

ä½†æ˜¯è¿™æ ·ä¹Ÿå¯å‘äº†æˆ‘ï¼š

- å¦‚æœè¿›è¡Œæ­¥è¿›é¢‘ç‡ä¸º 0 çš„æ‰«é¢‘ï¼Œå°±ç›¸å½“äºå›ºå®šäº†è¾“å‡ºé¢‘ç‡ã€‚ 

é‚£ä¹ˆå¦‚ä½•å›ºå®šè¾“å‡ºæ—¶é—´å‘¢ï¼Ÿç°åœ¨å·²çŸ¥çš„æ‰«é¢‘æ§åˆ¶è¾“å‡ºæ—¶é—´åŠŸèƒ½çš„é€»è¾‘å¦‚ä¸‹ï¼š

```C
/**
 * @brief è®¾ç½®é¢‘ç‡é€’å¢çš„æ—¶é—´é—´éš”ã€‚
 *
 * è¯¥å‡½æ•°æ ¹æ®è¾“å…¥çš„æ¨¡å¼ã€ä¹˜æ•°å’Œé—´éš”å€¼ï¼Œè®¡ç®—å‡ºé€’å¢é—´éš”å¯„å­˜å™¨ï¼ˆTINCï¼‰çš„å€¼
 * å¹¶å†™å…¥èŠ¯ç‰‡ã€‚å‡½æ•°ä¼šç¡®ä¿:
 * `mode`      åœ¨0æˆ–1ä¹‹é—´ï¼Œ
 * `mclk_mult` åœ¨0åˆ°3ä¹‹é—´ï¼Œ
 * `interval`  åœ¨2åˆ°2047ä¹‹é—´ã€‚
 *
 * @param mode        é€’å¢é—´éš”æ¨¡å¼ï¼Œ 0 = åŸºäºè¾“å‡ºä¿¡å·çš„å‘¨æœŸæ•°, 1 = åŸºäºMCLKã€‚
 * @param mclk_mult   å½“modeä¸º1æ—¶çš„ä¹˜æ•°é€‰æ‹©ï¼Œ0=1x, 1=5x, 2=100x, 3=500xã€‚(è¿™é‡Œæš‚æ—¶ä¸è€ƒè™‘ mode æ˜¯å¦ä¸º1)//TODO
 * @param interval    é€’å¢é—´éš”å€¼ï¼ŒèŒƒå›´0~2047ã€‚
 */
void ad5932_set_increment_interval(int mode, int mclk_mult, uint16_t interval) {
  uint16_t reg_value = AD5932_REG_INCR_INTVL;
  
  // ç¡®ä¿åœ¨æœ‰æ•ˆèŒƒå›´å†…
  if (interval < 2) interval = 2;
  if (interval > 2047) interval = 2047;
  if (mode < 0) mode = 0;
  if (mode > 1) mode = 1;
  if (mclk_mult < 0) mclk_mult = 0;
  if (mclk_mult > 3) mclk_mult = 3;

  // è®¾ç½®é—´éš”å€¼(ä½11ä½)
  reg_value |= (interval & 0x07FF);

  // è®¾ç½®ä¹˜æ•°(ä½11-12)
  reg_value |= ((mclk_mult & 0x03) << 11);

  // è®¾ç½®æ¨¡å¼(ä½13)
  reg_value |= ((mode & 0x01) << 13);

  ad5932_write(reg_value);
  usleep(10000);
}
```

è¿™é‡Œå¦‚æœæˆ‘æƒ³è®© 100KHz çš„æ³¢å½¢è¾“å‡º 1 msï¼Œéœ€è¦ä»€ä¹ˆå‚æ•°å‘¢ï¼Ÿ

1. é¢‘ç‡ f=100â€‰kHzï¼Œå‘¨æœŸ T ä¸ºï¼š1/ 100K = 10 us
2. è¾“å‡ºæ€»æ—¶é—´ t = 1ms = 1000us
3. N = t/T = 100

åœ¨ **1â€¯ms** çš„æ—¶é—´å†…ï¼Œ**100â€¯kHz æ–¹æ³¢å¯ä»¥å®Œæ•´è¾“å‡º 100 ä¸ªå‘¨æœŸ**ã€‚

æ‰€ä»¥è¿™é‡Œç›´æ¥è°ƒç”¨ï¼š

```C
ad5932_set_increment_interval(0ï¼Œ 0ï¼Œ 50);
```

è¿™æ ·æ¯æ¬¡é¢‘ç‡è¾“å‡ºçš„é—´éš”ä¸º 50 ä¸ªå‘¨æœŸï¼Œå¹¶ä¸”å›ºå®šæ‰«é¢‘æ­¥æ•°ä¸º 2 æ­¥ï¼Œç»¼åˆèµ·æ¥å°±æ˜¯ 100 ä¸ªå‘¨æœŸäº†ã€‚

# 10.15

## ç¥ç§˜çš„collecter

ç°åœ¨éœ€è¦æ¢³ç†ä¸‹å…³äº`collecter`çš„éœ€æ±‚ã€‚

# 10.16

ç°åœ¨æ‘†åœ¨æˆ‘çš„çœ¼å‰çš„æœ‰ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

1. DAC63001çš„é©±åŠ¨ç¨‹åº
2. collecteré›†æˆ DAC63001

## DAC63001

### 1.ç¡®å®šè®¾å¤‡åœ°å€

å¯¹äº DAC63001ï¼Œç¬¬ä¸€æ­¥æ˜¯ç¡®ä¿æˆ‘ä»¬çŸ¥é“è®¾å¤‡çš„ **IÂ²C ä»åœ°å€**ã€‚

DAC63001 çš„ 7 ä½ IÂ²C åœ°å€ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

- **é«˜ 4 ä½ï¼ˆå›ºå®šï¼‰**ï¼š`1001`
- **ä½ 3 ä½ï¼ˆç”± A0 å¼•è„šçŠ¶æ€å†³å®šï¼‰**ï¼šè§ä¸‹è¡¨ (A0 å¼•è„šå¯ä»¥è¿æ¥åˆ°å››ç§ä¸åŒçš„ç”µå¹³ï¼Œä»è€Œæä¾›å››ä¸ªå”¯ä¸€çš„ IÂ²C åœ°å€é€‰é¡¹)

| A0 å¼•è„šè¿æ¥ | ä½ 3 ä½ (AD2â€“AD0) | 7 ä½ IÂ²C åœ°å€ï¼ˆäºŒè¿›åˆ¶ï¼‰ | 7 ä½ IÂ²C åœ°å€ï¼ˆåå…­è¿›åˆ¶ï¼‰ |
| :---------- | :---------------- | :---------------------- | :------------------------ |
| AGND        | 000               | `1001 000`              | 0x48                      |
| VDD         | 001               | `1001 001`              | 0x49                      |
| SDA         | 010               | `1001 010`              | 0x4A                      |
| SCL         | 011               | `1001 011`              | 0x4B                      |

> å®é™…é€šä¿¡æ—¶ï¼ŒIÂ²C æ§åˆ¶å™¨å‘é€çš„åœ°å€å­—èŠ‚ä¸º `(7ä½åœ°å€ << 1) | R/Wä½`ã€‚
>
> ä¾‹å¦‚ï¼Œè‹¥ A0 æ¥ AGNDï¼Œå†™æ“ä½œåœ°å€ä¸º `0x90`ï¼ˆå³ `0x48 << 1`ï¼‰ï¼Œè¯»æ“ä½œåœ°å€ä¸º `0x91`

åœ¨æˆ‘ä»¬çš„ç¡¬ä»¶è®¾è®¡ä¸­ï¼ŒA0å¼•è„šçš„æ¥çš„æ˜¯å“ªä¸€ä¸ªå¼•è„šï¼Ÿç»è¿‡æ²Ÿé€šï¼šç¡¬ä»¶è®¾è®¡çš„æ—¶å€™ï¼Œå°† **A0 å¼•è„šæ¥åˆ°äº† AGND**ï¼ˆæ¥åœ°ï¼‰ã€‚æ‰€ä»¥ 7 ä½ åœ°å€ä¸ºï¼š

- **7 ä½ IÂ²C åœ°å€**ï¼š`0x48`

è¿™ä¸ª 7 ä½åœ°å€åœ¨é€šä¿¡æ—¶éœ€è¦è½¬æ¢ä¸º 8 ä½ï¼Œå¹¶åŒ…å«è¯»å†™ä½ï¼ˆR/Wï¼‰ï¼š

- **å†™åœ°å€ (W)**ï¼š`0x48 << 1 | 0` = `0x90`
- **è¯»åœ°å€ (R)**ï¼š`0x48 << 1 | 1` = `0x91`

### 2.ç¡®å®šéªŒè¯å¯„å­˜å™¨

è¦éªŒè¯é€šä¿¡æˆåŠŸï¼Œæˆ‘ä»¬åº”è¯¥è¯»å–ä¸€ä¸ªå…¶å†…å®¹æ˜¯**å·²çŸ¥å›ºå®šå€¼**çš„å¯„å­˜å™¨ã€‚æ ¹æ®æ•°æ®æ‰‹å†Œï¼ŒDAC63001 ç¡®å®æœ‰ä¸€ä¸ªè®¾å¤‡IDå¯„å­˜å™¨ï¼š

- Device ID å¯„å­˜å™¨ä¿¡æ¯

å…¶åç§°ä¸ºï¼š`GENERAL-STATUS`ï¼ŒI2Cåœ°å€ä¸º`0x22h`

#### Device ID å€¼

åœ¨ `GENERAL-STATUS` å¯„å­˜å™¨ä¸­ï¼Œ**ä½[7:2] æ˜¯ DEVICE-ID å­—æ®µ**ã€‚ä¸åŒå™¨ä»¶çš„æœŸæœ›å€¼ï¼š

| å™¨ä»¶å‹å·     | Device ID å€¼ | äºŒè¿›åˆ¶   |
| :----------- | :----------- | :------- |
| **DAC63001** | **`09h`**    | `001001` |
| DAC63002     | `08h`        | `001000` |
| DAC53001     | `0Bh`        | `001011` |
| DAC53002     | `0Ah`        | `001010` |

#### éªŒè¯æ­¥éª¤ï¼š

1. **è¯»å– GENERAL-STATUS å¯„å­˜å™¨** (åœ°å€ `0x22`)
2. **æå–ä½[7:2]** çš„å€¼
3. **éªŒè¯æ˜¯å¦ä¸º `0x09`** (å¯¹äº DAC63001)

ç»è¿‡éªŒè¯ï¼Œç¡®å®èƒ½å¤ŸéªŒè¯ä»£ç ä¸æ‰‹å†Œä¿æŒä¸€è‡´äº†ã€‚

## MAC TO MAC

å¼€å‘æ¿çš„ eth0 è¦é€šè¿‡ MAC TO MAC çš„æ–¹å¼ï¼Œä¸å¼€å‘æ¿ä¸Šçš„ FPGA è¿›è¡Œäº¤äº’ã€‚ä½†æ˜¯ç°åœ¨é‡åˆ°çš„é—®é¢˜å°±æ˜¯ï¼š

- FPGA æ— æ³•ä¸ eth0 é€šä¿¡

æŸ¥çœ‹ç½‘ç»œè¿æ¥æƒ…å†µï¼š

```bash
root@RK356X:/tmp# ifconfig 

eth0      Link encap:Ethernet  HWaddr FA:A6:9F:DF:4F:13  
          inet addr:169.254.151.47  Bcast:169.254.255.255  Mask:255.255.0.0
          inet6 addr: fe80::4572:7394:ed58:c4aa/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:7985 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:612732 (598.3 KiB)
          Interrupt:39 

root@RK356X:/tmp# ip link show eth0
3: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
    link/ether fa:a6:9f:df:4f:13 brd ff:ff:ff:ff:ff:ff
```

eth0 å¯åŠ¨çš„æ—¶å€™ï¼Œå†…æ ¸æ—¥å¿—ï¼š

```bash
root@RK356X:/tmp# dmesg | grep fe010000
[    1.813298] rk_gmac-dwmac fe010000.ethernet: Looking up phy-supply from device tree
[    1.813314] rk_gmac-dwmac fe010000.ethernet: Looking up phy-supply property in node /ethernet@fe010000 failed
[    1.813338] rk_gmac-dwmac fe010000.ethernet: no regulator found
[    1.813388] rk_gmac-dwmac fe010000.ethernet: clock input or output? (output).
[    1.813406] rk_gmac-dwmac fe010000.ethernet: TX delay(0x20).
[    1.813421] rk_gmac-dwmac fe010000.ethernet: RX delay(0x20).
[    1.813439] rk_gmac-dwmac fe010000.ethernet: integrated PHY? (no).
[    1.813717] rk_gmac-dwmac fe010000.ethernet: NO interface defined!
[    1.813878] rk_gmac-dwmac fe010000.ethernet: User ID: 0x30, Synopsys ID: 0x51
[    1.813897] rk_gmac-dwmac fe010000.ethernet: 	DWMAC4/5
[    1.813913] rk_gmac-dwmac fe010000.ethernet: DMA HW capability register supported
[    1.813926] rk_gmac-dwmac fe010000.ethernet: RX Checksum Offload Engine supported
[    1.813938] rk_gmac-dwmac fe010000.ethernet: TX Checksum insertion supported
[    1.813950] rk_gmac-dwmac fe010000.ethernet: Wake-Up On Lan supported
[    1.813991] rk_gmac-dwmac fe010000.ethernet: TSO supported
[    1.814006] rk_gmac-dwmac fe010000.ethernet: Enable RX Mitigation via HW Watchdog Timer
[    1.814017] rk_gmac-dwmac fe010000.ethernet: TSO feature enabled
[   20.317313] rk_gmac-dwmac fe010000.ethernet eth0: No Safety Features support found
[   20.317341] rk_gmac-dwmac fe010000.ethernet eth0: IEEE 1588-2008 Advanced Timestamp supported
[   20.317623] rk_gmac-dwmac fe010000.ethernet eth0: registered PTP clock
[   21.326889] rk_gmac-dwmac fe010000.ethernet: unsupported interface -22
[   21.326940] rk_gmac-dwmac fe010000.ethernet eth0: Link is Up - 1Gbps/Full - flow control off
```

å¯¹åº”çš„ dts æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸ºï¼š

```C
gmac1: ethernet@fe010000 {
        compatible = "rockchip,rk3568-gmac", "snps,dwmac-4.20a";
        reg = <0x0 0xfe010000 0x0 0x10000>;
        interrupts = <GIC_SPI 32 IRQ_TYPE_LEVEL_HIGH>,
                     <GIC_SPI 29 IRQ_TYPE_LEVEL_HIGH>;
        interrupt-names = "macirq", "eth_wake_irq";
        rockchip,grf = <&grf>;
        clocks = <&cru SCLK_GMAC1>, <&cru SCLK_GMAC1_RX_TX>,
                 <&cru SCLK_GMAC1_RX_TX>, <&cru CLK_MAC1_REFOUT>,
                 <&cru ACLK_GMAC1>, <&cru PCLK_GMAC1>,
                 <&cru SCLK_GMAC1_RX_TX>, <&cru CLK_GMAC1_PTP_REF>,
                 <&cru PCLK_XPCS>;
        clock-names = "stmmaceth", "mac_clk_rx",
                      "mac_clk_tx", "clk_mac_refout",
                      "aclk_mac", "pclk_mac",
                      "clk_mac_speed", "ptp_ref",
                      "pclk_xpcs";
        resets = <&cru SRST_A_GMAC1>;
        reset-names = "stmmaceth";

        snps,mixed-burst;
        snps,tso;

        snps,axi-config = <&gmac1_stmmac_axi_setup>;
        snps,mtl-rx-config = <&gmac1_mtl_rx_setup>;
        snps,mtl-tx-config = <&gmac1_mtl_tx_setup>;
        status = "disabled";

        mdio1: mdio {
                compatible = "snps,dwmac-mdio";
                #address-cells = <0x1>;
                #size-cells = <0x0>;
        };

        gmac1_stmmac_axi_setup: stmmac-axi-config {
                snps,wr_osr_lmt = <4>;
                snps,rd_osr_lmt = <8>;
                snps,blen = <0 0 0 0 16 8 4>;
        };

        gmac1_mtl_rx_setup: rx-queues-config {
                snps,rx-queues-to-use = <1>;
                queue0 {};
        };

        gmac1_mtl_tx_setup: tx-queues-config {
                snps,tx-queues-to-use = <1>;
                queue0 {};
        };
};
```

å¯¹åº”çš„æ¿çº§é…ç½®ä¸ºï¼š

```C
&gmac1 {
        clock_in_out = "output";

        assigned-clocks = <&cru SCLK_GMAC1_RX_TX>, <&cru SCLK_GMAC1>;
        assigned-clock-parents = <&cru SCLK_GMAC1_RGMII_SPEED>;
        assigned-clock-rates = <0>, <125000000>;

        pinctrl-names = "default";
        pinctrl-0 = <&gmac1m1_miim
                &gmac1m1_tx_bus2
                &gmac1m1_rx_bus2
                &gmac1m1_rgmii_clk
                &gmac1m1_rgmii_bus
                                &gmac1m1_clkinout>;

        tx_delay = <0x20>;
        rx_delay = <0x20>;

        status = "okay";

        fixed-link {
                 speed = <1000>;
                 full-duplex;
        };

};
```

è¯·é—®é—®é¢˜å¯èƒ½å‡ºç°åœ¨å“ªé‡Œäº†ï¼Ÿ

# 10.17

## ç½‘ç»œè¯Šæ–­

ä»Šå¤©æµ‹è¯•äº†ä¸‹ï¼š

```bash
tcpdump -i eth0 -e -n -c 10
```

è¿è¡Œç»“æœ

```BASH
root@RK356X:/# tcpdump -i eth0 -e -n -c 10
[17350.631263] device eth0 entered promiscuous mode
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
06:42:39.405192 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.405212 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.405221 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.405230 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.405239 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.405246 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.405256 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.426499 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.439295 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
06:42:39.452284 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
10 packets captured
2606 packets received by filter
2578 packets dropped by kernel
[17350.800512] device eth0 left promiscuous mode

```

### é—®é¢˜è¯Šæ–­ä»·å€¼

é€šè¿‡è¿™ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å‘ç°äº†**å…³é”®é—®é¢˜è¯æ®**ï¼š

```bash
æºMAC: 00:43:4d:49:4e:40 > ç›®çš„MAC: 22:33:44:55:66:77
æºIP: 192.168.1.37.5000 > ç›®çš„IP: 192.168.1.10.5030
```

### è¾“å‡ºç»“æœè¯´æ˜çš„é—®é¢˜

#### 1. **é€šä¿¡æ–¹å‘ç¡®è®¤**

```bash
00:43:4d:49:4e:40 > 22:33:44:55:66:77
```

- **â†’** æ•°æ®ç¡®å®ä»FPGAæµå‘å¼€å‘æ¿
- **â†’** ç‰©ç†é“¾è·¯åŸºæœ¬æ­£å¸¸ï¼Œæ•°æ®èƒ½åˆ°è¾¾

#### 2. **åœ°å€ä¸åŒ¹é…é—®é¢˜**

| åœ°å€ç±»å‹ | FPGAå‘é€çš„ç›®æ ‡åœ°å€  | å¼€å‘æ¿å®é™…åœ°å€      | çŠ¶æ€     |
| :------- | :------------------ | :------------------ | :------- |
| MACåœ°å€  | `22:33:44:55:66:77` | `fa:a6:9f:df:4f:13` | âŒ ä¸åŒ¹é… |
| IPåœ°å€   | `192.168.1.10`      | `169.254.151.47`    | âŒ ä¸åŒ¹é… |

#### 3. **æ•°æ®åŒ…ä¸¢å¼ƒè¯æ®**

```bash
5067 packets received by filter
5020 packets dropped by kernel
```

### è¾“å‡ºç»“æœçš„æŠ€æœ¯å«ä¹‰

#### æ•°æ®åŒ…å±‚é¢

```bash
02:56:26.023835 00:43:4d:49:4e:40 > 22:33:44:55:66:77, ethertype IPv4 (0x0800), length 1070: 192.168.1.37.5000 > 192.168.1.10.5030: UDP, length 1028
```

| å­—æ®µ               | æŠ€æœ¯å«ä¹‰           | é—®é¢˜æŒ‡ç¤º            |
| :----------------- | :----------------- | :------------------ |
| `æºMAC`            | å‘é€è®¾å¤‡ç¡¬ä»¶åœ°å€   | FPGAçš„MACåœ°å€       |
| `ç›®çš„MAC`          | ç›®æ ‡è®¾å¤‡ç¡¬ä»¶åœ°å€   | **ä¸æ˜¯å¼€å‘æ¿çš„MAC** |
| `æºIP:ç«¯å£`        | å‘é€åº”ç”¨åœ°å€       | FPGAçš„åº”ç”¨æœåŠ¡      |
| `ç›®çš„IP:ç«¯å£`      | ç›®æ ‡åº”ç”¨åœ°å€       | **ä¸æ˜¯å¼€å‘æ¿çš„IP**  |
| `UDP, length 1028` | ä¼ è¾“åè®®å’Œæ•°æ®å¤§å° | åº”ç”¨å±‚åè®®æ­£å¸¸      |

#### ç³»ç»Ÿå±‚é¢

```bash
5067 packets received by filter
5020 packets dropped by kernel
```

| ç»Ÿè®¡é¡¹               | å«ä¹‰                  | é—®é¢˜åˆ†æ               |
| :------------------- | :-------------------- | :--------------------- |
| `received by filter` | tcpdumpè¿‡æ»¤å™¨æ”¶åˆ°çš„åŒ… | æ•°æ®ç¡®å®åˆ°è¾¾ç³»ç»Ÿ       |
| `dropped by kernel`  | å†…æ ¸ä¸¢å¼ƒçš„åŒ…          | **åœ°å€ä¸åŒ¹é…å¯¼è‡´ä¸¢å¼ƒ** |

### æ¡ˆä¾‹ä¸­çš„è¯Šæ–­ä»·å€¼

#### æ’é™¤çš„æ•…éšœç‚¹

1. âœ… **ç‰©ç†è¿æ¥**ï¼šæ•°æ®åŒ…èƒ½åˆ°è¾¾ï¼Œè¯´æ˜ç‰©ç†é“¾è·¯æ­£å¸¸
2. âœ… **FPGAå‘é€åŠŸèƒ½**ï¼šFPGAèƒ½æ­£å¸¸ç”Ÿæˆå’Œå‘é€æ•°æ®åŒ…
3. âœ… **å¼€å‘æ¿æ¥æ”¶ç¡¬ä»¶**ï¼šç½‘å¡èƒ½æ­£å¸¸æ¥æ”¶æ•°æ®

#### ç¡®è®¤çš„æ•…éšœç‚¹

1. âŒ **åœ°å€é…ç½®**ï¼šç›®æ ‡MAC/IPåœ°å€ä¸åŒ¹é…
2. âŒ **ç½‘ç»œæ ˆè¿‡æ»¤**ï¼šå†…æ ¸å› åœ°å€ä¸åŒ¹é…è€Œä¸¢å¼ƒæ•°æ®åŒ…

## ç½‘ç»œé—®é¢˜è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®æ­£FPGAé…ç½®ï¼ˆæ¨èï¼‰

#### æ­¥éª¤1ï¼šä¿®æ”¹FPGAçš„ç›®æ ‡åœ°å€

è®©FPGAå‘é€æ­£ç¡®çš„ç›®æ ‡åœ°å€ï¼š

```verilog
// FPGAç½‘ç»œé…ç½®ä¿®æ­£
ç›®çš„MACåœ°å€ = fa:a6:9f:df:4f:13  // å¼€å‘æ¿eth0çš„å®é™…MAC
ç›®çš„IPåœ°å€ = 169.254.151.47      // å¼€å‘æ¿eth0çš„å®é™…IP
æºIPåœ°å€ = 169.254.151.xxx       // åŒç½‘æ®µçš„ä»»æ„IPï¼Œå¦‚169.254.151.100
```

#### æ­¥éª¤2ï¼šéªŒè¯é…ç½®

åœ¨å¼€å‘æ¿ä¸Šæµ‹è¯•ï¼š

```bash
# ç›‘å¬æ•°æ®åŒ…ï¼Œåº”è¯¥çœ‹åˆ°æ­£ç¡®çš„ç›®æ ‡åœ°å€
tcpdump -i eth0 -e -n -c 5

# æµ‹è¯•è¿é€šæ€§
ping 169.254.151.100  # FPGAçš„IPåœ°å€
```

------

MACé—®é¢˜å‘Šä¸€æ®µè½ï¼Œç°åœ¨é¢ä¸´çš„æ˜¯æ— èŠå¹¶ä¸”å†—é•¿çš„`collecter`è°ƒè¯•é—®é¢˜äº†ã€‚

## collecter

é€šè¿‡äº†ç¼–è¯‘éš¾é¢˜åï¼Œç°åœ¨è¦é¢ä¸´çš„æ˜¯è¿è¡Œæ—¶æŠ¥é”™é—®é¢˜ï¼š

```bash
root@RK356X:/# collecter -s
collect_en_rc :1 g_app_cfgctrl->collect_en:1
ioctl i2c-w:: No such device or address
ioctl i2c-r:: No such device or address
ioctl i2c-w:: No such device or address
ioctl i2c-r:: No such device or address
```

ç°åœ¨å·²ç»å°†ä¸ç”¨çš„ä»£ç æ³¨é‡Šæ‰äº†ï¼Œä½†æ˜¯è¿è¡Œçš„æ—¶å€™ï¼Œä¼šé‡å¯å•æ¿ã€‚å¾ˆå¥‡æ€ªå•Šã€‚

# 10.20

åŒä¼‘çš„æ„Ÿè§‰è¿˜ä¸é”™ã€‚ä»Šå¤©æ„Ÿè§‰æ›´æœ‰åŠ¨åŠ›å»å†™ä¸œè¥¿äº†ã€‚

## collecteré‡å¯å•æ¿

```bash
root@RK356X:/# collecter -s
collect_en_rc :1 g_app_cfgctrl->collect_en:1
 &pkg_hdr.pad-&pkg_hdr.eth=42
index=0 write=0095e2b8  readbk=b8e29500
index=1 write=43000000  readbk=00000043
index=2 write=404e494d  readbk=4d494e40
index=3 write=00450008  readbk=08004500
index=4 write=00001c04  readbk=04200000
index=5 write=11800000  readbk=00008011
index=6 write=a8c01969  readbk=b34dc0a8
index=7 write=010a0a01  readbk=010a0a01
index=8 write=88130502  readbk=02051388
index=9 write=0804a613  readbk=13a604óŸ–1.16 6f71c736ce typ 23/03/02-20:01:48
In
LP4/4x derate en, other dram:2x trefi
ddrconfig:0
LPDDR4X, 324MHz
BW=32 Col=10 Bk=8 CS0 Row=16 CS=1 Die BW=16 Size=2048MB
tdqss: cs0 dqs0: -24ps, dqs1: -72ps, dqs2: -96ps, dqs3: -96ps, 

change to: 324MHz
PHY drv:clk:36,ca:36,DQ:29,odt:0
vrefinner:24%, vrefout:41%
dram drv:40,odt:0
clk skew:0x62

change to: 528MHz
PHY drv:clk:36,ca:36,DQ:29,odt:0
vrefinner:24%, vrefout:41%
dram drv:40,odt:0
clk skew:0x58

change to: 780MHz
PHY drv:clk:36,ca:36,DQ:29,odt:0
vrefinner:24%, vrefout:41%
dram drv:40,odt:0
clk skew:0x58

change to: 1560MHz(final freq)
PHY drv:clk:36,ca:36,DQ:29,odt:60
vrefinner:16%, vrefout:22%
dram drv:40,odt:80
vref_ca:00000071
clk skew:0x2b
cs 0:
the read training result:
DQS0:0x33, DQS1:0x34, DQS2:0x34, DQS3:0x34, 
min  : 0xd 0x10 0x10  0xb  0x1  0x2  0x6  0x7 , 0xa  0x7 0x11  0x1  0xc 0x16 0x10 0x10 ,
       0xd  0xc 0x12  0xf  0x2  0x8  0xb  0xc , 0xa  0x7  0x4  0x1 0x10 0x11 0x10 0x10 ,
mid  :0x29 0x2a 0x2c 0x24 0x1c 0x1b 0x21 0x21 ,0x25 0x23 0x2c 0x1b 0x28 0x2e 0x2b 0x2a ,
      0x28 0x27 0x2c 0x2b 0x1c 0x23 0x27 0x28 ,0x25 0x22 0x1e 0x1b 0x29 0x2c 0x2b 0x29 ,
max  :0x45 0x45 0x48 0x3d 0x37 0x35 0x3d 0x3b ,0x41 0x3f 0x47 0x36 0x44 0x47 0x46 0x44 ,
      0x43 0x43 0x47 0x47 0x37 0x3e 0x43 0x45 ,0x41 0x3d 0x39 0x35 0x43 0x47 0x47 0x43 ,
range:0x38 0x35 0x38 0x32 0x36 0x33 0x37 0x34 ,0x37 0x38 0x36 0x35 0x38 0x31 0x36 0x34 ,
      0x36 0x37 0x35 0x38 0x35 0x36 0x38 0x39 ,0x37 0x36 0x35 0x34 0x33 0x36 0x37 0x33 ,
the write training result:
DQS0:0x27, DQS1:0x1d, DQS2:0x18, DQS3:0x18, 
min  :0x5f 0x62 0x63 0x5a 0x52 0x4f 0x56 0x5a 0x5c ,0x4c 0x4a 0x54 0x44 0x51 0x58 0x54 0x53 0x53 ,
      0x4c 0x4e 0x50 0x50 0x45 0x48 0x4a 0x4e 0x4c ,0x4a 0x49 0x44 0x42 0x52 0x51 0x50 0x50 0x4c ,
mid  :0x77 0x79 0x7c 0x72 0x6a 0x69 0x6f 0x72 0x73 ,0x67 0x64 0x6d 0x5f 0x6a 0x71 0x6d 0x6d 0x6c ,
      0x67 0x69 0x6a 0x6b 0x5e 0x61 0x65 0x68 0x66 ,0x65 0x64 0x5f 0x5d 0x6c 0x6c 0x6b 0x6b 0x66 ,
max  :0x90 0x91 0x95 0x8b 0x83 0x84 0x89 0x8b 0x8b ,0x83 0x7f 0x87 0x7a 0x84 0x8b 0x87 0x87 0x86 ,
      0x83 0x84 0x85 0x86 0x78 0x7b 0x81 0x83 0x81 ,0x81 0x80 0x7a 0x79 0x87 0x87 0x86 0x86 0x81 ,
range:0x31 0x2f 0x32 0x31 0x31 0x35 0x33 0x31 0x2f ,0x37 0x35 0x33 0x36 0x33 0x33 0x33 0x34 0x33 ,
      0x37 0x36 0x35 0x36 0x33 0x33 0x37 0x35 0x35 ,0x37 0x37 0x36 0x37 0x35 0x36 0x36 0x36 0x35 ,
CA Training result:
cs:0 min  :0x53 0x3f 0x45 0x3e 0x4a 0x3c 0x48 ,0x54 0x47 0x48 0x3c 0x49 0x3f 0x4f ,
cs:0 mid  :0x8c 0x81 0x7f 0x81 0x82 0x7f 0x71 ,0x8d 0x8b 0x80 0x7e 0x82 0x81 0x79 ,
cs:0 max  :0xc5 0xc3 0xb9 0xc4 0xbb 0xc2 0x9a ,0xc6 0xd0 0xb9 0xc1 0xbb 0xc3 0xa3 ,
cs:0 range:0x72 0x84 0x74 0x86 0x71 0x86 0x52 ,0x72 0x89 0x71 0x85 0x72 0x84 0x54 ,
out
U-Boot SPL board init
U-Boot SPL 2017.09-gaaca6ffec1-211203 #zzz (Dec 03 2021 - 18:42:16)
unknown raw ID phN
unrecognized JEDEC id bytes: 00, 00, 00
Trying to boot from MMC2
```

## æ—¥å¿—è¾“å‡ºé—®é¢˜

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨æ‰§è¡Œå®Œæ¯•ï¼š

```bash
index=9 write=0804a613  readbk=13a604óŸ–1.16 6f71c736ce typ 23/03/02-20:01:48
```

è®¾å¤‡å°±è¿›å…¥äº†é‡å¯çš„æµç¨‹ã€‚çœ‹ä¸‹æ‰§è¡Œè¾“å‡º`index`çš„ä»£ç ï¼ˆ`collecter/dev/fpga.c`ï¼‰ï¼š

```C
int fpga_init(T_app_cfgctrl *config)
{
    ...
    INFO_LOG("Writing UDP header to FPGA registers (base address: 0x%04X)\n", UDP_HEAD_START);
    for(i=0; i<sizeof(U_pkg_hdr)/4; i++){
        uint32_t tmp = 0;
        fpga_reg_write_4Bytes((uint16_t)(UDP_HEAD_START+i), &pkg_hdr.data[i*4]);
        fpga_reg_read((uint16_t)(UDP_HEAD_START+i), &tmp);
        printf("index=%d write=%08x  readbk=%08x\n", i, *(uint32_t*)&pkg_hdr.data[i*4], tmp);
    }
    ...
        
    INFO_LOG("FPGA initialization completed successfully\n");
    return 0;
}
```

å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ—¥å¿—`INFO_LOG`å¹¶æœªè¢«æ‰“å°ï¼Œè€Œ`printf`åˆ™æ­£å¸¸è¾“å‡ºã€‚é¦–å…ˆæ‰¾åˆ°è¿™ä¸ªé—®é¢˜çš„åŸå› ã€‚çœ‹ä¸‹`INFO_LOG`çš„æ‰§è¡Œä»£ç ï¼ˆ`app/commondef.h`ï¼‰ï¼š

```C
#define     INFO_LOG(fmt, args...)	\
    syslog(LOG_USER, "[INFO][%s](%d)" fmt, __func__, __LINE__, ##args) 
```

ç°åœ¨æš‚æ—¶å°†å…¶æ”¹ä¸ºäº†`printf`:

```C
#define INFO_LOG(fmt, args...) \
    printf("[INFO][%s](%d)" fmt "\n", __func__, __LINE__, ##args)
```

æ˜å¤©æµ‹è¯•ä¸‹å†™å…¥ï¼Œä»Šå¤©åˆ°æ­¤ä¸ºæ­¢äº†ã€‚

# 10.21

## DAC63001å†™æ“ä½œ

ç°åœ¨æƒ³é€šè¿‡å†™**DAC-X-CONFIG** å¯„å­˜å™¨ (é…ç½® DAC é€šé“æ¨¡å¼)ï¼Œé€šè¿‡å†™å…¥å’Œå›è¯»éªŒè¯æ˜¯å¦å†™å…¥æˆåŠŸã€‚

é€‰æ‹© **DAC-0-CONFIG** å¯„å­˜å™¨ä½œä¸ºæµ‹è¯•ç›®æ ‡ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå…¸å‹çš„å¯è¯»å†™é…ç½®å¯„å­˜å™¨ã€‚å…¶å…³é”®å‚æ•°ä¸ºï¼š

1. IÂ²C å¯„å­˜å™¨åœ°å€ï¼š`0x18h`
2. è¯»å†™æç¤ºï¼šè¯¥å¯„å­˜å™¨ 16 ä½å‡å¯è¯»å†™

å®Œæˆäº†æœ€åšå®çš„åŸºç¡€å·¥ä½œï¼š**éªŒè¯ IÂ²C è¯»å†™é©±åŠ¨çš„å¯é æ€§**ã€‚è¿™æ˜¯ä»åº•å±‚é€šä¿¡åˆ°åº”ç”¨å±‚ç¼–ç¨‹çš„å…³é”®è¿‡æ¸¡ã€‚

## åº”ç”¨éœ€æ±‚ï¼ˆé”¯é½¿æ³¢ï¼‰æ˜ å°„åˆ° DAC å¯„å­˜å™¨

è¦ä½¿ç”¨ DAC63001 çš„å†…ç½®åŠŸèƒ½ç”Ÿæˆé”¯é½¿æ³¢ï¼Œéœ€è¦ä»ä¸‰ä¸ªæ ¸å¿ƒæ–¹é¢é…ç½®å¯„å­˜å™¨ï¼š

| **ç¼–ç¨‹æ–¹é¢ (æ¦‚å¿µ)**             | **ç›®æ ‡/ä½œç”¨**                                    | **æ¶‰åŠçš„ä¸»è¦å¯„å­˜å™¨ (ä½ éœ€è¦æŸ¥æ‰¾çš„)**                          |
| ------------------------------- | ------------------------------------------------ | ------------------------------------------------------------ |
| **1. å¹…åº¦å®šä¹‰ (Amplitude)**     | å†³å®šé”¯é½¿æ³¢çš„**å³°å€¼**å’Œ**è°·å€¼**ï¼Œå³è¾“å‡ºç”µå‹èŒƒå›´ã€‚ | **DAC-0-MARGIN-HIGH** (æœ€å¤§å€¼) **DAC-0-MARGIN-LOW** (æœ€å°å€¼) |
| **2. æ³¢å½¢å®šä¹‰ (Shape & Speed)** | å†³å®šæ³¢å½¢**ç±»å‹**ï¼ˆé”¯é½¿æ³¢ï¼‰å’Œ**é¢‘ç‡/é€Ÿåº¦**ã€‚      | **DAC-0-FUNC-CONFIG** (åŒ…å«æ³¢å½¢ç±»å‹ã€æ­¥è¿›å¤§å°ã€æ­¥è¿›æ—¶é—´)     |
| **3. å¯åŠ¨æ§åˆ¶ (Control)**       | å†³å®šä½•æ—¶å¼€å§‹ç”Ÿæˆæ³¢å½¢ã€‚                           | **COMMON-TRIGGER** (å¯åŠ¨åŠŸèƒ½ç”Ÿæˆ)                            |

### å¹…åº¦é…ç½®

åœ°å€ï¼š

-  **DAC-0-MARGIN-HIGH** (`0x01h`)
- **DAC-0-MARGIN-LOW** (`0x02h`) 

**æ•°æ®å¯¹é½**ï¼šå¯¹äº 12 ä½ DAC63001ï¼Œå°† $4095 (0xFFF)$ **å·¦ç§» 4 ä½**åˆ° 16 ä½å¯„å­˜å™¨çš„é«˜ 12 ä½ï¼Œå¾—åˆ° `0xFFF0`ï¼Œè¿™æ˜¯æ­£ç¡®çš„**æœ€å¤§**æ•°å­—ç ã€‚

**å¹…åº¦å®šä¹‰**ï¼š**é”¯é½¿æ³¢çš„å¹…åº¦**æ˜¯ç”± `HIGH` å’Œ `LOW` ä¸¤ä¸ªå¯„å­˜å™¨å…±åŒå†³å®šçš„ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ª**å…¨å¹…**ï¼ˆä»æœ€ä½ç‚¹åˆ°æœ€é«˜ç‚¹ï¼‰çš„é”¯é½¿æ³¢ï¼Œæ­£ç¡®çš„é…ç½®åº”è¯¥æ˜¯ï¼š

| **å¯„å­˜å™¨**                      | **ç›®æ ‡æ•°å­—ç ** | **å†™å…¥ 16 ä½å€¼** | **ä½œç”¨**       |
| ------------------------------- | -------------- | ---------------- | -------------- |
| **DAC-0-MARGIN-HIGH** (`0x01h`) | $4095$ (max)   | **`0xFFF0`**     | æ³¢å½¢çš„**å³°å€¼** |
| **DAC-0-MARGIN-LOW** (`0x02h`)  | $0$ (min)      | **`0x0000`**     | æ³¢å½¢çš„**è°·å€¼** |

å› æ­¤ï¼Œç¬¬ä¸€æ­¥çš„é…ç½®ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š

```C
// å‡è®¾ i2c_write_reg16 å‡½æ•°å·²å®ç°
i2c_write_reg16(fd, DAC63001_I2C_ADDR, 0x01, 0xFFF0); // è®¾å®šå³°å€¼
i2c_write_reg16(fd, DAC63001_I2C_ADDR, 0x02, 0x0000); // è®¾å®šè°·å€¼
```

### æ³¢å½¢ç±»å‹å’Œé¢‘ç‡é…ç½®

é…ç½® **DAC-0-FUNC-CONFIG** å¯„å­˜å™¨ï¼ˆåœ°å€ `0x18h`ï¼‰ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªæœ€é‡è¦çš„é…ç½®ï¼š**æ³¢å½¢ç±»å‹**å’Œ**æ³¢å½¢é€Ÿåº¦**ã€‚ 

è¦ç”Ÿæˆé”¯é½¿æ³¢ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½® `FUNC-GEN-CONFIG-BLOCK` å­—æ®µï¼ˆé€šå¸¸æ˜¯ä½å‡ ä½ï¼‰æ¥é€‰æ‹©é”¯é½¿æ³¢æ¨¡å¼ã€‚

è€Œæ³¢å½¢ç±»å‹æ˜¯é€šè¿‡è®¾ç½®**Bit [10:8]** è®¾ç½®ä¸º **`001`**ï¼ˆé”¯é½¿æ³¢ï¼‰ã€‚

é™¤äº†æ³¢å½¢ç±»å‹å¤–ï¼Œé”¯é½¿æ³¢çš„é¢‘ç‡å–å†³äºä¸¤ä¸ªå› ç´ ï¼š

1. **æ•°å­—æ­¥è¿›å¤§å° (CODE-STEP)**ï¼šæ¯æ¬¡æ›´æ–°æ—¶ï¼ŒDAC è¾“å‡ºæ”¹å˜å¤šå°‘ LSBã€‚
2. **æ­¥è¿›æ—¶é—´ (SLEW-RATE)**ï¼šç›¸é‚»ä¸¤æ¬¡æ­¥è¿›ä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚

å®ƒä»¬ä¸€èµ·å†³å®šäº†æ³¢å½¢çˆ¬æ»¡æ•´ä¸ªå¹…åº¦ï¼ˆä» `0x0000` åˆ° `0xFFF0`ï¼‰æ‰€éœ€çš„æ—¶é—´ã€‚

åœ¨**DAC-0-FUNC-CONFIG** å¯„å­˜å™¨ï¼ˆ`0x18h`ï¼‰ä¸­ï¼Œå¯¹äºè¿™ä¸¤ä¸ªå‚æ•°çš„é…ç½®ä¸ºï¼š

| **å…³é”®ä½åŸŸ**  | **é¢„æœŸä½œç”¨**                                          | **ä½åŸŸä½ç½® (Bit [X:Y])** |
| ------------- | ----------------------------------------------------- | ------------------------ |
| **CODE-STEP** | å®šä¹‰æ¯æ¬¡æ­¥è¿›çš„ LSB æ•°é‡ (ä¾‹å¦‚ 1 LSB, 2 LSB, 3 LSB ç­‰) | Bit [6:4]                |
| **SLEW-RATE** | å®šä¹‰ä¸¤æ¬¡æ­¥è¿›ä¹‹é—´çš„æ—¶é—´é—´éš” (ä¾‹å¦‚ $4\mu s, 8\mu s$ ç­‰) | Bit [3:0]                |

# 10.22

ä»Šå¤©è°ƒè¯•ä¸å¥½ DAC63001 ä¸èµ°äº†ã€‚

## è¾“å‡ºå›ºå®šç”µå‹æµ‹è¯•

ç°åœ¨ç¡®å®šäº† I2C çš„è¯»å†™åŠŸèƒ½å·²ç»å®Œæˆï¼š

```C
int i2c_write_reg16(int fd, uint8_t dev_addr, uint8_t reg_addr, uint16_t value);
int i2c_read_reg16(int fd, uint8_t dev_addr, uint8_t reg_addr, uint16_t *value);
```

é‚£ä¹ˆç°åœ¨å°±è¦æ£€æµ‹ä¸‹ï¼Œæ˜¯å¦èƒ½è¾“å‡ºå›ºå®šç”µå‹å€¼ã€‚æ•´ç†æ‰‹å†Œå¯¹äºè¾“å‡ºç”µå‹å€¼çš„ç›¸å…³æ“ä½œã€‚ç»è¿‡æ‰‹å†Œæç¤ºï¼Œå›ºå®šç”µå‹çš„è¾“å‡ºéœ€è¦é…ç½® 3 ä¸ªå¯„å­˜å™¨ã€‚



# 10.23

ä»Šå¤©ä»»åŠ¡å°±æ˜¯å®Œæˆï¼š

1. æŠ“å– FPGA çš„ç½‘ç»œåŒ…ç„¶åä½¿ç”¨å›è°ƒå‡½æ•°è¿›è¡Œè½¬å‘æˆ–å­˜å‚¨
2. å®Œæˆ dac63001 æ¶‰åŠçš„ç”µå‹é…ç½®ï¼ˆå›ºå®šå’Œå¯è°ƒé”¯é½¿æ³¢ï¼‰
3. è§£å†³ AD5932 çªå˜æ³¢å½¢é—®é¢˜

## æŠ“åŒ…

> ä»»åŠ¡æè¿°ï¼š
>
> - æŠ“åŒ…æ–¹å¼ï¼šFPGA ä¸ cpu ä¹‹é—´é€šè¿‡ MAC -to - MAC çš„æ–¹å¼è¿›è¡Œè¿æ¥ï¼Œç°åœ¨å·²çŸ¥çš„è¿æ¥æ–¹å¼æ˜¯ï¼š`fpga.c`å’Œ`packet_sni_fwd.c`å†³å®šçš„
> - æ¥æ”¶çš„æ•°æ®å¤„ç†ï¼šæŠ“åˆ°åŒ…æ•°æ®åï¼Œéœ€è¦é€šè¿‡å›è°ƒå‡½æ•°å°†å…¶è½¬å‘åˆ°å›è°ƒå‡½æ•°å³å¯ã€‚

### ä» FPGA è·å–ç½‘ç»œåŒ…æ•°æ®çš„æ–¹å¼

FPGA è¿æ¥åˆ° CPU çš„ç½‘ç»œæ¥å£ä¸Šï¼Œå¹¶é€šè¿‡ **L2 åŸå§‹å¥—æ¥å­— (Raw Socket)** æŠ“å–æ•°æ®åŒ…ã€‚ä» FPGA è·å–ç½‘ç»œåŒ…æ•°æ®çš„è¿‡ç¨‹æ˜¯ï¼š

**FPGA (`eth0`) $\xrightarrow{\text{UDP/IP/Ethernet å°è£…}}$ CPU/Linux Kernel $\xrightarrow{\text{Raw Socket}}$ `eth_sniffer` çº¿ç¨‹**

ç„¶åæ•°æ®åŒ…çš„åç»­å¤„ç†é€»è¾‘æ˜¯ï¼š

**`eth_sniffer` $\xrightarrow{\text{å›è°ƒ}}$ `eth_callback` $\xrightarrow{\text{æ£€æŸ¥/å­˜å‚¨/è½¬å‘å†³ç­–}}$ (å­˜å‚¨åˆ° Buffer) $\mid$ (è½¬å‘åˆ° `eth1`)**

ç°åœ¨éœ€è¦ä½¿ç”¨æ–°çš„ä»£ç æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚

### å‘é€å·²æŠ“åŒ…çš„æ•°æ®

è¿™ä¸ªæ–°å‡½æ•°çš„éœ€æ±‚ä¸ºï¼š

1. ä» FPGA è·å–ç½‘ç»œåŒ…ã€‚è·å–æ–¹å¼å¦‚ä¸Š
2. ç„¶åæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå°†æ”¶åˆ°çš„åŒ…ï¼Œè½¬ä¼ è¾“ç»™è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚



åŸºäºæ‚¨çš„éœ€æ±‚ï¼ˆæœ€é«˜å€¼1.1Vï¼Œæœ€ä½å€¼0.1Vï¼‰ï¼Œæˆ‘æ¥è¯¦ç»†åˆ†æDAC63001èƒ½ç”Ÿæˆçš„é”¯é½¿æ³¢é¢‘ç‡èŒƒå›´ã€‚

## é”¯é½¿æ³¢é¢‘ç‡èŒƒå›´

### ç¡¬ä»¶å‚æ•°é™åˆ¶

**å·²çŸ¥æ¡ä»¶ï¼š**

- å‚è€ƒç”µå‹ï¼š1.25Vï¼ˆå‡è®¾ä½¿ç”¨å†…éƒ¨å‚è€ƒæˆ–å¤–éƒ¨1.25Vå‚è€ƒï¼‰
- åˆ†è¾¨ç‡ï¼š12ä½ï¼ˆ4096ä¸ªä»£ç ï¼‰
- ç”µå‹èŒƒå›´ï¼š0.1V - 1.1V
- slew_rateèŒƒå›´ï¼š4Âµs - 5127.92Âµsï¼ˆ15ä¸ªæ¡£ä½ï¼‰
- code_stepèŒƒå›´ï¼š1-32 LSBï¼ˆ8ä¸ªæ¡£ä½ï¼‰

### å…·ä½“è®¡ç®—

#### 1. ç”µå‹èŒƒå›´å¯¹åº”çš„DACä»£ç 

```text
MARGIN_HIGH = (1.1 / 1.25) Ã— 4095 â‰ˆ 3604
MARGIN_LOW = (0.1 / 1.25) Ã— 4095 â‰ˆ 328
ä»£ç èŒƒå›´ = 3604 - 328 + 1 = 3277 LSB
```

#### 2. é¢‘ç‡è®¡ç®—å…¬å¼

```text
é¢‘ç‡ = 1 / (slew_rate Ã— (ä»£ç èŒƒå›´ / code_step))
```

### é¢‘ç‡èŒƒå›´è®¡ç®—

#### æœ€é«˜é¢‘ç‡ï¼ˆä½¿ç”¨æœ€å¿«å‚æ•°ï¼‰

```text
slew_rate = 4Âµs (0.000004s)
code_step = 32 LSB
æ­¥æ•° = 3277 / 32 â‰ˆ 102.4æ­¥ï¼ˆå–102æ­¥ï¼‰

æœ€é«˜é¢‘ç‡ = 1 / (0.000004 Ã— 102) 
         = 1 / 0.000408 
         â‰ˆ 2451 Hz
```

#### æœ€ä½é¢‘ç‡ï¼ˆä½¿ç”¨æœ€æ…¢å‚æ•°ï¼‰

```text
slew_rate = 5127.92Âµs (0.00512792s)  
code_step = 1 LSB
æ­¥æ•° = 3277æ­¥

æœ€ä½é¢‘ç‡ = 1 / (0.00512792 Ã— 3277)
         = 1 / 16.803
         â‰ˆ 0.0595 Hz
```

#### å®Œæ•´çš„é¢‘ç‡é‡ç¨‹è¡¨

| å‚æ•°ç»„åˆ                  | å®é™…é¢‘ç‡  | å¤‡æ³¨         |
| :------------------------ | :-------- | :----------- |
| slew_rate=1, code_step=7  | 2451 Hz   | **æœ€é«˜é¢‘ç‡** |
| slew_rate=1, code_step=6  | 1225 Hz   |              |
| slew_rate=1, code_step=5  | 817 Hz    |              |
| slew_rate=1, code_step=4  | 613 Hz    |              |
| slew_rate=1, code_step=3  | 490 Hz    |              |
| slew_rate=1, code_step=2  | 367 Hz    |              |
| slew_rate=1, code_step=1  | 184 Hz    |              |
| ...                       | ...       |              |
| slew_rate=15, code_step=7 | 1.91 Hz   |              |
| slew_rate=15, code_step=6 | 0.955 Hz  |              |
| slew_rate=15, code_step=5 | 0.637 Hz  |              |
| slew_rate=15, code_step=4 | 0.478 Hz  |              |
| slew_rate=15, code_step=3 | 0.382 Hz  |              |
| slew_rate=15, code_step=2 | 0.286 Hz  |              |
| slew_rate=15, code_step=0 | 0.0595 Hz | **æœ€ä½é¢‘ç‡** |

## å•æ³¢æŸéœ€æ±‚åˆ†æ

å•æ³¢æŸéœ€æ±‚ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š

- å‘é€ä¿¡å·ï¼šä»¥LFMæˆ–è€…å›ºå®šé¢‘ç‡çš„æ–¹æ³¢è¾“å‡ºä¿¡å·
- æ¥æ”¶ä¿¡å·ï¼šä»¥å›ºå®šæˆ–è€…å¯å˜å¢ç›Šæ¥æ”¶ä¿¡å·å¹¶å‘é€ç»™å›è°ƒå‡½æ•°

å…¶ä¸­å‘é€ä¿¡å·éœ€æ±‚è¾ƒä¸ºç®€å•ï¼Œå¹¶ä¸”å·²ç»å®ç°ï¼šé€šè¿‡ spi æ§åˆ¶ AD5932 è¾“å‡ºå›ºå®šé¢‘ç‡æˆ–è€…æ‰«é¢‘ä¿¡å·ã€‚

æ¥æ”¶ä¿¡å·çš„é€»è¾‘éœ€è¦å†æ¢³ç†ä¸€ä¸‹ï¼š

- æ¥æ”¶ä¿¡å·çš„å¢ç›Šé…ç½®ï¼šè®¾ç½®ADC63001ç”µå‹ï¼Œæ¥å®ç°å¯å˜åå‘é”¯é½¿æ³¢æˆ–è€…å›ºå®šç”µå‹è¾“å‡ºï¼Œæ§åˆ¶ä¸åŒçš„å¢ç›Šï¼Œæ­¤æ—¶å°±éœ€è¦å¼€å§‹æ¥æ”¶ä¿¡å·
- é…ç½® FPGA å¤´éƒ¨ä¿¡æ¯ï¼šFPGA é€šè¿‡ MAC-to-MAC æ–¹å¼è¿æ¥åˆ° CPU çš„ç½‘ç»œæ¥å£ `eth0` ä¸Šã€‚é…ç½® FPGA å‘é€ç½‘ç»œåŒ…çš„å½¢å¼`fpga_init()`ã€‚
- å‘ FPGA çš„å¯„å­˜å™¨ 0 å†™å…¥ 1 åï¼Œä¼šå¯åŠ¨ FPGA å‘ `eth0` å‘é€ç½‘ç»œåŒ…
- æŠ“åŒ…çº¿ç¨‹ (`eth_sniffer`) æŒç»­æ¥æ”¶æ•°æ®ï¼Œå¹¶è°ƒç”¨ä¸€ä¸ªå›è°ƒå‡½æ•° (`eth_callback` æˆ–æ‚¨è‡ªå®šä¹‰çš„å‡½æ•°) è¿›è¡Œå¤„ç†

## é¡¹ç›®é€»è¾‘

é¡¹ç›®å»ºç«‹åœ¨`/home/crx/work/project/singleBeam`ï¼Œé¡¹ç›®æ¶æ„åˆ†å±‚ä¸ºï¼š

```bash
crx@crx-PC:~/work/project/singleBeam$ tree -L 2
.
â”œâ”€â”€ app
â”‚   â””â”€â”€ ad5932_main.c
â”œâ”€â”€ build
â”‚   â””â”€â”€ makefile
â”œâ”€â”€ dev
â”‚   â”œâ”€â”€ ad5932.c
â”‚   â””â”€â”€ ad5932.h
â”œâ”€â”€ Makefile
â””â”€â”€ protocol
    â”œâ”€â”€ spi_hal.c
    â””â”€â”€ spi_hal.h

6 directories, 6 files
```

æ¯ä¸€å±‚çš„åŠŸèƒ½é€»è¾‘å¦‚ä¸‹ã€‚

### dev

è®¾å¤‡é©±åŠ¨æ¥å£å±‚ã€‚æ­¤å±‚åŒ…å«äº†`AD5932`çš„æ¥å£ï¼Œç±»ä¼¼

```C
void ad5932_reset(void);
void ad5932_set_waveform(int wave_type);
```

å®šä¹‰äº†ä½¿ç”¨èŠ¯ç‰‡çš„åŸå­æ“ä½œã€‚é™¤äº†é©±åŠ¨`AD5932`è¿›è¡Œå‘é€æ³¢å½¢å¤–ï¼Œå•æ³¢æŸé¡¹ç›®è¿˜éœ€è¦è¿™äº›å¤–è®¾ï¼š

- `ADC63001`è®¾å¤‡é©±åŠ¨ä»£ç 
- `RK3568`CPUæœ¬èº«çš„ç½‘ç»œæŠ“åŒ…é©±åŠ¨ä»£ç 

### app

ç”¨æˆ·ä½¿ç”¨å±‚ã€‚æ­¤å±‚é¢å‘ç”¨æˆ·ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒç”¨æ­¤ä¸­æ¥å£ï¼Œè®¾ç½®ï¼š

- è¾“å‡ºä¿¡å·çš„æ³¢å½¢å‚æ•°
- æ¥æ”¶ä¿¡å·çš„å¢ç›Š
- æ¥æ”¶ç½‘ç»œåŒ…çš„å›è°ƒå‡½æ•°

### protocol

èŠ¯ç‰‡é©±åŠ¨åè®®å±‚ã€‚å¯¹äºä¸åŒçš„èŠ¯ç‰‡ï¼Œå…¶ä½¿ç”¨çš„é€šä¿¡åè®®ä¸ä¸€è‡´ï¼š

- `AD5932`ï¼šä½¿ç”¨ SPI é€šä¿¡
- `ADC63001`ï¼šä½¿ç”¨ I2C é€šä¿¡

### build

åœ¨æ‰§è¡Œ`make`ç¼–è¯‘é¡¹ç›®çš„æ—¶å€™ï¼Œä¼šå°†ç”Ÿæˆçš„ä¸­é—´æ–‡ä»¶ä»¥å¯¹åº”ç›®å½•çš„å½¢å¼å­˜å‚¨åœ¨`build/makefile`ç›®å½•ä¸‹é¢

## é›†æˆADC63001

ç°åœ¨è¦å°†åŸºäº I2C çš„ ADC63001 é©±åŠ¨å†™è¿›å»ã€‚é›†æˆåçš„é¡¹ç›®ä¸ºï¼š

```bash
crx@crx-PC:~/work/project/singleBeam$ tree -L 2
.
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ ad5932_main.c
â”‚   â””â”€â”€ dac63001_main.c
â”œâ”€â”€ build
â”‚   â””â”€â”€ makefile
â”œâ”€â”€ dev
â”‚   â”œâ”€â”€ ad5932.c
â”‚   â”œâ”€â”€ ad5932.h
â”‚   â”œâ”€â”€ dac63001.c
â”‚   â””â”€â”€ dac63001.h
â”œâ”€â”€ Makefile
â””â”€â”€ protocol
    â”œâ”€â”€ i2c_hal.c
    â”œâ”€â”€ i2c_hal.h
    â”œâ”€â”€ spi_hal.c
    â””â”€â”€ spi_hal.h

6 directories, 11 files
```

1. **åè®®æŠ½è±¡**ï¼šI2C HALé©±åŠ¨æä¾›äº†ç»Ÿä¸€çš„I2Cæ¥å£
2. **è®¾å¤‡é©±åŠ¨**ï¼šDAC63001é©±åŠ¨æä¾›äº†ç®€æ´çš„APIæ¥å£
3. **åº”ç”¨å±‚**ï¼šå‘½ä»¤è¡Œå·¥å…·ä¾¿äºæµ‹è¯•å’Œä½¿ç”¨

# 10.24

## FPGAä¼ è¾“ç½‘ç»œåŒ…

å½“å‰çš„ fpga åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ—¥å¿—è®°å½•ä¸ºï¼š

```bash
Oct 24 02:57:01 : [INFO][fpga_init](134)Configured MAC addresses - DST: B8:72:CE:24:00:00, SRC: 00:43:4D:49:4E:40
Oct 24 02:57:01 : [INFO][get_local_ip](93)Local IP address: 0x0A01A8C0
Oct 24 02:57:01 : [INFO][fpga_init](158)Configured IP addresses - SRC: 0xC0A8010A, DST: 0x0A010205
Oct 24 02:57:01 : [INFO][fpga_init](160)Configured ports - SRC: 5000, DST: 5030
Oct 24 02:57:01 : [INFO][fpga_init](162)IP packet length: 1052, UDP packet length: 1032
Oct 24 02:57:01 : [INFO][fpga_init](168)Writing UDP header to FPGA registers (base address: 0x0040)
Oct 24 02:57:01 : [INFO][fpga_init](190)FPGA initialization completed successfully
```



### 1. ç½‘ç»œåŒ…çš„åŸºæœ¬ç»“æ„

FPGAç»„ç»‡ç½‘ç»œåŒ…æ—¶ï¼Œéµå¾ªæ ‡å‡†çš„OSIä¸ƒå±‚æ¨¡å‹ï¼ˆç®€åŒ–åˆ°å››å±‚ï¼‰ï¼š

```tex
+-----------------------+
|     åº”ç”¨å±‚æ•°æ®         |  <- æ‚¨çš„é‡‡æ ·æ•°æ®
+-----------------------+
|     UDPå¤´éƒ¨           |  <- ç«¯å£ä¿¡æ¯
+-----------------------+
|     IPå¤´éƒ¨            |  <- IPåœ°å€ä¿¡æ¯
+-----------------------+
|     ä»¥å¤ªç½‘å¤´éƒ¨         |  <- MACåœ°å€ä¿¡æ¯
+-----------------------+
|     ç‰©ç†å±‚            |  <- ç”µä¿¡å·/å…‰ä¿¡å·
+-----------------------+
```

### 2. FPGAç½‘ç»œåŒ…çš„å…·ä½“æ ¼å¼

FPGAç”Ÿæˆçš„æ•°æ®åŒ…ç»“æ„å¦‚ä¸‹ï¼š

```C
// å®Œæ•´çš„ç½‘ç»œåŒ…ç»“æ„
typedef struct {
    // ä»¥å¤ªç½‘å¸§å¤´ (14å­—èŠ‚)
    uint8_t  dst_mac[6];    // ç›®æ ‡MACåœ°å€
    uint8_t  src_mac[6];    // æºMACåœ°å€  
    uint16_t eth_type;      // åè®®ç±»å‹ (0x0800 = IPv4)
    
    // IPå¤´éƒ¨ (20å­—èŠ‚)
    uint8_t  ver_hl;        // ç‰ˆæœ¬å’Œå¤´éƒ¨é•¿åº¦
    uint8_t  serv_type;     // æœåŠ¡ç±»å‹
    uint16_t pkt_len;       // æ€»é•¿åº¦
    uint16_t re_mark;       // æ ‡è¯†
    uint16_t flag_seg;      // æ ‡å¿—å’Œåˆ†ç‰‡
    uint8_t  surv_tm;       // ç”Ÿå­˜æ—¶é—´
    uint8_t  protocol;      // åè®® (17 = UDP)
    uint16_t h_check;       // å¤´éƒ¨æ ¡éªŒå’Œ
    uint32_t src_ip;        // æºIPåœ°å€
    uint32_t dst_ip;        // ç›®æ ‡IPåœ°å€
    
    // UDPå¤´éƒ¨ (8å­—èŠ‚)
    uint16_t sport;         // æºç«¯å£
    uint16_t dport;         // ç›®æ ‡ç«¯å£
    uint16_t pktlen;        // UDPé•¿åº¦
    uint16_t check_sum;     // æ ¡éªŒå’Œ
    
    // æœ‰æ•ˆè½½è·
    uint32_t pkt_id;        // åŒ…ID (4å­—èŠ‚)
    uint8_t  adc_data[];    // ADCé‡‡æ ·æ•°æ®
} fpga_packet_t;
```

### 3. MAC-to-MACä¼ è¾“æµç¨‹

#### æ­¥éª¤1: FPGAå‡†å¤‡æ•°æ®

```C
// åœ¨fpga.cä¸­çš„åˆå§‹åŒ–è¿‡ç¨‹
void fpga_init() {
    // é…ç½®MACåœ°å€
    pkg_hdr.eth.dst_mac = {ç›®æ ‡MAC};  // å¦‚: 00:11:22:33:44:55
    pkg_hdr.eth.src_mac = {FPGA MAC}; // å¦‚: AA:BB:CC:DD:EE:FF
    pkg_hdr.eth.eth_type = 0x0800;    // IPv4åè®®
    
    // é…ç½®IPåœ°å€
    pkg_hdr.ip.src_ip = FPGA_IP;      // FPGAçš„IPåœ°å€
    pkg_hdr.ip.dst_ip = DEST_IP;      // ç›®æ ‡è®¾å¤‡IP
    
    // é…ç½®UDPç«¯å£
    pkg_hdr.udp.sport = SOURCE_PORT;  // æºç«¯å£
    pkg_hdr.udp.dport = DEST_PORT;    // ç›®æ ‡ç«¯å£
}
```

#### æ­¥éª¤2: æ•°æ®åŒ…å‘é€åˆ°eth0

```tex
FPGAå†…éƒ¨æµç¨‹ï¼š
ADCé‡‡æ · â†’ æ•°æ®å°è£… â†’ æ·»åŠ UDPå¤´ â†’ æ·»åŠ IPå¤´ â†’ æ·»åŠ MACå¤´ â†’ ç‰©ç†å±‚å‘é€
```

### 4. ç½‘ç»œæ¥å£(eth0)çš„å·¥ä½œ

#### æ¥æ”¶æ•°æ®åŒ…ï¼š

```C
// åœ¨packet_sni_fwd.cä¸­çš„æ¥æ”¶é€»è¾‘
void eth_sniffer() {
    while(1) {
        // ä»eth0æ¥æ”¶åŸå§‹æ•°æ®åŒ…
        len = recvfrom(g_if_proc_info[SRC_IF_ID].fd, 
                      g_if_proc_info[SRC_IF_ID].recv_buf, 
                      RCV_BUF_SIZE, 0, NULL, &fromLen);
        
        if(len > 0) {
            // æ•°æ®åŒ…åˆ°è¾¾ï¼
            // bufä¸­çš„å†…å®¹å°±æ˜¯å®Œæ•´çš„ä»¥å¤ªç½‘å¸§
        }
    }
}
```

#### æ•°æ®åŒ…åœ¨eth0çš„æµåŠ¨ï¼š

```tex
ç‰©ç†å±‚(eth0ç½‘å¡) â†’ æ•°æ®é“¾è·¯å±‚(å†…æ ¸) â†’ åŸå§‹å¥—æ¥å­—(æˆ‘ä»¬çš„ç¨‹åº)
```

### 5. MACåœ°å€çš„ä½œç”¨å’ŒæŸ¥æ‰¾

#### ARPåè®® - MACåœ°å€è§£æï¼š

```tex
å½“FPGAè¦å‘é€åŒ…åˆ°ç›®æ ‡IPæ—¶ï¼š
1. FPGAæ£€æŸ¥ï¼šç›®æ ‡IPæ˜¯å¦åœ¨åŒä¸€å­ç½‘ï¼Ÿ
2. å¦‚æœåœ¨åŒä¸€å­ç½‘ï¼šç›´æ¥å‘é€ARPè¯·æ±‚"è°çš„IPæ˜¯X.X.X.Xï¼Ÿ"
3. ç›®æ ‡è®¾å¤‡å›å¤ï¼š"IP X.X.X.Xçš„MACæ˜¯YY:YY:YY:YY:YY:YY"
4. FPGAç”¨è¿™ä¸ªMACåœ°å€å¡«å……ç›®æ ‡MACå­—æ®µ
```

#### ä»£ç ä¸­çš„MACé…ç½®ï¼š

```C
// é…ç½®ç›®æ ‡MAC (é«˜ä½2å­—èŠ‚ + ä½ä½4å­—èŠ‚)
uint16_t tmp = htons(config->cfg.dst_mac_high);
uint32_t tmpl = htonl(config->cfg.dst_mac_low);
memcpy(pkg_hdr.eth.dst_mac+2, (unsigned char*)&tmpl, 4);
memcpy(pkg_hdr.eth.dst_mac, (unsigned char*)&tmp, 2);

// é…ç½®æºMAC (FPGAçš„MACåœ°å€)
tmp = htons((uint16_t)config->cfg.src_mac_high);
tmpl = htonl(config->cfg.src_mac_low);
memcpy(pkg_hdr.eth.src_mac+2, (unsigned char*)&tmpl, 4);
memcpy(pkg_hdr.eth.src_mac, (unsigned char*)&tmp, 2);
```

### 6. å®Œæ•´çš„ä¼ è¾“ç¤ºä¾‹

```TEX
FPGA (MAC: AA:BB:CC:DD:EE:FF, IP: 192.168.1.100)
     â†“ ç›´æ¥è¿æ¥æˆ–é€šè¿‡äº¤æ¢æœº
eth0 (MAC: 11:22:33:44:55:66, IP: 192.168.1.50)
     â†“
ç›®æ ‡è®¾å¤‡ (MAC: 99:88:77:66:55:44, IP: 192.168.1.200)
```

### ä¼ è¾“è¿‡ç¨‹ï¼š

1. **FPGAæ„é€ æ•°æ®åŒ…**ï¼š

   ```c
   ç›®æ ‡MAC: 99:88:77:66:55:44
   æºMAC:   AA:BB:CC:DD:EE:FF  
   ç›®æ ‡IP:  192.168.1.200
   æºIP:    192.168.1.100
   ```

2. **eth0æ¥æ”¶æ•°æ®åŒ…**ï¼š

   - ç½‘å¡é©±åŠ¨çœ‹åˆ°ç›®æ ‡MACä¸æ˜¯è‡ªå·±ï¼Œä½†å¤„äº**æ··æ‚æ¨¡å¼**
   - ä»ç„¶å°†æ•°æ®åŒ…ä¼ é€’ç»™ä¸Šå±‚åè®®æ ˆ
   - æˆ‘ä»¬çš„åŸå§‹å¥—æ¥å­—æ•è·åˆ°è¿™ä¸ªåŒ…

3. **ç¨‹åºå¤„ç†**ï¼š

   ```c
   // åœ¨eth_callbackå‡½æ•°ä¸­è§£æ
   ip_hdr* ip = (ip_hdr*)(packet + sizeof(eth_hdr));
   udp_hdr* udp = (udp_hdr*)(packet + sizeof(eth_hdr) + (ip->ver_hl & 0x0f) * 4);
   uint8_t* payload = (uint8_t*)packet + sizeof(eth_hdr) + (ip->ver_hl & 0x0f) * 4 + sizeof(udp_hdr);
   ```

## é›†æˆæ¥æ”¶ä¿¡æ¯éœ€æ±‚åˆ†æ

é¦–å…ˆç†è§£é…ç½® FPGA å‘é€ UDP åŒ…çš„é€»è¾‘ã€‚è¿™éƒ¨åˆ†é€»è¾‘åœ¨`fpga.c`ä¸­çš„`fpga_init()`å‡½æ•°ä¸­ã€‚

ç°åœ¨åˆ›å»ºä¸€ä¸ªæµ‹è¯•é¡¹ç›®`/home/crx/work/project/netFpga`ï¼Œç›®çš„æ˜¯å°†åˆå§‹åŒ– fpga çš„ç½‘ç»œå¤´ï¼Œç„¶åèƒ½åœ¨å½“å‰å¼€å‘æ¿çš„ eth0 æŠ“åˆ° fpga è½¬å‘çš„ç½‘ç»œåŒ…ã€‚

ç°åœ¨å·²çŸ¥çš„æ˜¯ï¼š

- FPGA çš„ MAC åœ°å€æ˜¯é€šè¿‡ MAC to MAC çš„å½¢å¼ä¸ eth0 ç›´æ¥è¿æ¥ã€‚ç½‘ç»œåŒ…ä¼šç›´æ¥å‘é€ç»™ eth0 å¯¹åº”çš„ GMAC1 ç«¯å£
- FPGA æ— è®ºæ€ä¹ˆé…ç½®è‡ªå·±çš„ UDP åŒ…å¤´ä¸­ç›®çš„/æºIP/MACï¼Œeth0 éƒ½èƒ½æŠ“åˆ°ä» FPGA å‘æ¥çš„ç½‘ç»œåŒ…
- æ··æ‚æ¨¡å¼ç›‘å¬ eth0 çš„ç½‘ç»œåŒ…

ç°åœ¨å·²ç»å°† FPGA çš„è¯»å†™æ–¹æ³•åŠ å…¥åˆ°äº†`protocol/i2c_hal.h`ä¸­ï¼š

```C
int i2c_hal_fpga_read(uint8_t fpga_addr, uint16_t reg_addr, uint32_t *val);
int i2c_hal_fpga_write(uint8_t fpga_addr, uint16_t reg_addr, uint32_t val);
```

ç»è¿‡éªŒè¯ï¼Œæ˜¯æ­£ç¡®çš„

```bash
root@RK356X:/tmp# ./i2c_fpga_test -r 0x6
FPGA [0x0006] = 0x0000FFFF
root@RK356X:/tmp# ./i2c_fpga_test -r 0x40
FPGA [0x0040] = 0xB07B2500
root@RK356X:/tmp# ./i2c_fpga_test -r 0x42
FPGA [0x0042] = 0x4D494E40
```

ç°åœ¨éœ€è¦é‡æ–°æ¢³ç†ä¸‹å•æ³¢æŸçš„é€»è¾‘äº†ï¼Œå› ä¸ºä¸‹ä¸€æ­¥è¦å°†ç½‘ç»œæŠ“åŒ…çš„é€»è¾‘åŠ å…¥è¿›æ¥ã€‚

## å•æ³¢æŸ

è½å®åˆ°ä»£ç ä¹‹å‰ï¼Œå…ˆå°†å•æ³¢æŸçš„é€»è¾‘é‡æ–°æ¢³ç†ä¸€ä¸‹ã€‚

### å‘é€ä¿¡å·

è¦å®ç°è¾“å‡ºLFMæˆ–è€…å›ºå®šæ³¢å½¢çš„æ–¹æ³¢ã€‚è¿™é‡Œæä¾›ä¸€ä¸ªæ¥å£ï¼Œæ¥å£çš„å…¥å‚å’Œç»“æœæè¿°å¦‚ä¸‹ã€‚

#### è¡Œä¸ºæè¿°

ç”¨æˆ·æ‰§è¡Œåï¼Œç¨‹åºçš„è¡Œä¸ºï¼š

1. åˆå§‹åŒ–é…ç½® FPGA çš„ç½‘ç»œé…ç½®ï¼ˆéœ€å®ç°ï¼‰
2. é…ç½® AD5932 ç›¸å…³æ³¢å½¢æ•°æ®å¯„å­˜å™¨ï¼ˆå·²å®ç°ï¼‰
3. å¯åŠ¨ç›‘å¬ï¼ˆéœ€å®ç°ï¼‰
4. å¯åŠ¨ AD5932 æ³¢å½¢è¾“å‡ºï¼ˆå·²å®ç°ï¼‰

### æ¥æ”¶ä¿¡å·

è¿™é‡Œéœ€è¦è®¾ç½® n us çš„å¢ç›Šï¼Œå¹¶åœ¨å¢ç›Šæ—¶é—´å®Œæ¯•åï¼Œå°†æŠ“å–çš„æ•°æ®è¿”å›ç»™å›è°ƒå‡½æ•°ã€‚

#### è¡Œä¸ºæè¿°

ç”¨æˆ·æ‰§è¡Œåï¼Œç¨‹åºçš„è¡Œä¸ºï¼š

1. å¯åŠ¨ç›‘å¬ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰ç›‘å¬çš„è¯ï¼‰
2. é…ç½® adc63001 çš„æ•°æ®å¯„å­˜å™¨ï¼ˆå¯å˜é”¯é½¿æ³¢å¢ç›Šï¼‰
3. å¯åŠ¨ adc63001 çš„ç”µå‹æ§åˆ¶ vgc èŠ¯ç‰‡å®ç°å¢ç›Šæ§åˆ¶ã€‚
4. ç»“æŸå¢ç›Šæ§åˆ¶
5. ç»“æŸå¹¶è¿”å›ç›‘å¬çš„æ•°æ®

```C
receive_single_beam_response()
```

å…¶å…¥å‚ä¸ºï¼š

- åˆå§‹å¢ç›Š

- ç»“æŸå¢ç›Š

- å¢ç›ŠæŒç»­æ—¶é—´

- ç½‘ç»œåŒ…å›è°ƒå‡½æ•°

  ```C
  typedef void (*NetPacketCallback)(const uint8_t *data, int length);
  ```

# 10.27

ç°åœ¨å·²ç»å®ç°åŸºæœ¬çš„æ¥å£é€»è¾‘ã€‚ç°åœ¨å®Œæ•´æµ‹è¯•ä¸€éï¼Œçœ‹çœ‹æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

## æ¥å£æµ‹è¯•

é¦–å…ˆçœ‹ä¸‹å‘é€æ¥å£çš„ç›¸å…³å®ç°ï¼š

```C
void* sweep_thread(void* arg) {
  SweepTask *task = (SweepTask*)arg;

  ad5932_init();
  ad5932_reset();
  ad5932_set_start_frequency(task->cfg.start_freq);
  ad5932_set_delta_frequency(task->cfg.delta_freq, task->cfg.positive_incr);
  ad5932_set_number_of_increments(task->cfg.num_incr);
  ad5932_set_increment_interval(0, task->cfg.mclk_mult, task->cfg.interval_val);
  ad5932_set_waveform(task->cfg.wave_type);
  ad5932_start_sweep();

  while (!ad5932_is_sweep_done()) {
    usleep(10); // 10å¾®ç§’ è½®è¯¢ç­‰å¾…
  }

  ad5932_reset();
  ad5932_set_standby(false);

  free(task);
  return NULL;
}


void generate_single_beam_signal(const DDSConfig *cfg) {
  // åˆå§‹åŒ– FPGA UDP å¤´
  fpga_init(i2c_dev);
  fpga_initialize_udp_header(&udp_header_params);

  // åˆ›å»ºæ‰«é¢‘çº¿ç¨‹
  pthread_t tid;
  SweepTask *task = malloc(sizeof(SweepTask));
  task->cfg = *cfg;
  pthread_create(&tid, NULL, sweep_thread, task);
  pthread_detach(tid); // åå°æ‰§è¡Œï¼Œç”¨æˆ·ä¸éœ€ join
}
```

`generate_single_beam_signal()`ç¨‹åºçš„è¡Œä¸ºæ˜¯ï¼š

1. åˆå§‹åŒ– FPGA çš„ç½‘ç»œåŒ…å¤´æ ¼å¼
2. æ‰«é¢‘çº¿ç¨‹å¼€å¯ï¼Œåˆ›å»ºæ‰«é¢‘å¹¶å¼€å§‹è¾“å‡ºè§„å®šçš„æ‰«é¢‘ä¿¡å·ã€‚

# 10.28

ä»Šå¤©éœ€è¦æ•´åˆä¸€ä¸ªå‘é€å’Œæ¥æ”¶ä¸€ä½“çš„å‡½æ•°ã€‚

## æ”¶å‘ç»“åˆå‡½æ•°

å½“å‰å‘é€ä¿¡å·å’Œæ¥æ”¶ä¿¡å·çš„æµç¨‹æ˜¯åˆ†å¼€çš„ã€‚

ç°åœ¨æ”¶å‘ä¸€ä½“å‡½æ•°å®šä¹‰ä¸º`transmit_and_receive_single_beam()`ï¼Œè¡Œä¸ºæ˜¯ï¼š

1. åˆå§‹åŒ–`fpga`ç½‘ç»œå¤´
2. é…ç½®æ‰«é¢‘å‚æ•°
3. é…ç½®æ¥æ”¶å¢ç›Šå’Œå›è°ƒå‡½æ•°
4. å¯åŠ¨ fpga å‘é€ç½‘ç»œåŒ… + å¯åŠ¨ç½‘ç»œç›‘å¬ï¼ˆå…ˆäºæ‰«é¢‘å¼€å§‹ï¼‰
5. å¯åŠ¨æ‰«é¢‘ä¿¡å·ï¼Œå¹¶æ£€æµ‹æ˜¯å¦æ‰«é¢‘ç»“æŸ
6. ç»“æŸåï¼Œç«‹åˆ»å¯åŠ¨å¢ç›Šæ‰«ææ³¢å½¢
7. å»¶è¿Ÿ 5ms åï¼Œåœæ­¢å¢ç›Šæ‰«æä¿¡å·
8. åœæ­¢fpga å‘é€ç½‘ç»œåŒ…

## å»¶è¿Ÿé—®é¢˜

å¥½çš„ï¼Œç°åœ¨è§£å†³äº†èƒ½ä¸èƒ½ç”¨çš„é—®é¢˜ã€‚ä½†æ˜¯éšä¹‹è€Œæ¥çš„ï¼Œå°±æ˜¯å¥½ä¸å¥½ç”¨çš„é—®é¢˜ã€‚ç°åœ¨ä»æ£€æµ‹åˆ°å‘é€ä¿¡å·å·²ç»ç»“æŸæ—¶åˆ»å¼€å§‹ï¼Œåˆ°æ¥æ”¶å¼€å§‹ï¼Œè€—æ—¶1.5msã€‚

ç°åœ¨æƒ³å®ç°çš„å°±æ˜¯ï¼Œèƒ½å¦å°½å¯èƒ½å¿«çš„ï¼Œå®ç°å‘é€ä¿¡å·ä¸€ç»“æŸï¼Œé©¬ä¸Šå¼€å§‹æ¥æ”¶ä¿¡å·ã€‚

ç°åœ¨æƒ³é€šè¿‡å¤–éƒ¨ç¡¬ä»¶æ¥å®ç°å‘é€ä¿¡å·ä¸€ç»“æŸï¼Œç«‹åˆ»å¯åŠ¨æ¥æ”¶æµç¨‹ã€‚**é…ç½® GPIO ä¸ºå¤–éƒ¨è§¦å‘æ¨¡å¼ (`GPI-CONFIG=1001`)**ï¼Œè®©å¤–éƒ¨å¼•è„šèƒ½ç›´æ¥è§¦å‘æ³¢å½¢è¾“å‡ºï¼ˆå³ Start/Stop Function Generationï¼‰ã€‚

## å¤–éƒ¨å¼•è„šæ§åˆ¶æ³¢å½¢å¯åŠ¨å’Œåœæ­¢

1. **è½¯ä»¶ç«¯é…ç½® DAC å¯„å­˜å™¨**ï¼ˆåªéœ€ä¸€æ¬¡ï¼Œé€šè¿‡ IÂ²Cï¼‰
   - æ‰“å¼€å¤–éƒ¨å‚è€ƒï¼›
   - è®¾ç½®æ³¢å½¢å‚æ•°ï¼›
   - å¯ç”¨ Function Generatorï¼›
   - æŠŠ GPIO æ˜ å°„ä¸º Start/Stop è§¦å‘ï¼›
   - æŒ‡å®šé€šé“ï¼ˆå¦‚ DAC0ï¼‰ï¼›
   - å¯ç”¨è¾“å…¥ï¼›

é€šè¿‡ä½•æ€»åŠ å…¥çš„ 3ä¸ª FPGAå¼•è„šï¼š

```C
  // DAC æ§åˆ¶å¯„å­˜å™¨
  REG_DAC_CTRL        = 0x0014,   // DAC GPIOè¾“å‡ºè§¦å‘
  REG_DAC_CTRL_EN     = 0x0015,   // DAC GPIOæ§åˆ¶ä½¿èƒ½
  REG_DAC_TIMER       = 0x0016,   // DAC æŒç»­è¾“å‡ºæ—¶é—´ï¼Œå•ä½40ns
```

æ¥å®ç°ç¡¬ä»¶è‡ªåŠ¨æ§åˆ¶ DAC63001 çš„æ³¢å½¢å¼€å§‹è¾“å‡ºã€‚å…¶åŸç†å°±æ˜¯ä½¿ç”¨äº† GPIO çš„å‡½æ•°ç”ŸæˆåŠŸèƒ½ã€‚é…ç½® GPIO åŠŸèƒ½çš„å‡½æ•°åœ¨`dac63001`ä¸­å®šä¹‰ï¼š

```C
/*
* @brief å¯ç”¨GPIOå¼•è„šè§¦å‘DACå‡½æ•°å¼€å§‹/åœæ­¢
*/
int dac63001_enable_gpio_start_stop_trigger(void);
```

## æ¥æ”¶é—®é¢˜2

ç°åœ¨è™½ç„¶åšå¥½äº†æ•´ä½“çš„æµç¨‹ï¼Œä½†æ˜¯å¯¹äºæ¥æ”¶çš„ç½‘ç»œåŒ…ï¼Œéœ€è¦è¿›è¡Œç¼“å­˜å¤„ç†ã€‚ç°åœ¨å·²ç»å®ç°äº†åœ¨æ”¶åŒ…çš„è¿‡ç¨‹ä¸­ï¼Œå°†åŒ…ä¼ é€’ç»™`call_back`å›è°ƒå‡½æ•°ã€‚

ä½†æ˜¯ç°åœ¨éœ€è¦æ–°çš„éœ€æ±‚ï¼š

1. æ”¶åŒ…è¿‡ç¨‹ä¸­ï¼Œè¿›è¡Œå†…å­˜ç¼“å­˜ï¼ˆæ•°æ®é‡æ¯ç§’20mbï¼Œæœ€å¤§æ”¶åŒ…æŒç»­æ—¶é—´åœ¨ 20 sä»¥å†…ï¼Œå·®ä¸å¤š 500mbï¼‰
2. æ”¶åŒ…ç»“æŸåï¼Œä¸»åŠ¨è°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œå°†ç¼“å­˜çš„æ•°æ®ä¼ è¾“ç»™ç”¨æˆ·ã€‚

å·²ç»å®ç°äº†ã€‚æ„Ÿè°¢deepseek

## å‘½ä»¤è§£æ

ç°åœ¨ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œä½¿ç”¨`sbeam_test.c`ä½œä¸ºæµ‹è¯•ç¨‹åºã€‚å…¶ä¸­å¯¹äºç‰¹å®šå‘½ä»¤ï¼Œä¸‹é¢æ˜¯ä¸€äº›è®²è§£ã€‚

### 10msæ—¶é—´å®½åº¦æµ‹è¯•

è¿è¡Œä»£ç ï¼š

```bash
sbeam_test -c --start-freq 300 --delta-freq 0 --num-incr 2 --interval-val 2 --start-gain 0 --end-gain 80 --duration-us 60000
```

ç¤ºæ³¢å™¨æµ‹è¯•æ¡ä»¶ï¼š

1. æ—¶é—´å®½åº¦è®¾ç½®ä¸º 10 msï¼Œå»¶æ—¶è®¾ç½®ä¸º 40ms
2. é€šé“1å³°å³°å€¼è®¾ç½®ä¸º 500mvï¼Œé€šé“2å³°å³°å€¼ä¸º200mv
3. è®¾ç½®é€šé“1ä¸ºè§¦å‘ç”µå‹ 1.3Vå·¦å³
4. é€šé“1æ¥`AD5932`çš„ `MSBOUT`å¼•è„šï¼Œé€šé“2æ¥`DAC63001`çš„`OUT0`å¼•è„š

æœ€ç»ˆèƒ½çœ‹åˆ°ä¸€ä¸ª 300Hz çš„æ–¹æ³¢è¾“å‡ºäº†6æ¬¡ï¼Œå¹¶ä¸”åœ¨æœ€åä¸€ä¸ªæ³¢å½¢ç»“æŸåï¼Œè°ƒç”¨äº†ç”Ÿæˆé”¯é½¿æ³¢ã€‚é”¯é½¿æ³¢æŒç»­æ—¶é—´åœ¨550mså·¦å³ã€‚

### 1msæ—¶é—´å®½åº¦æµ‹è¯•

è¿™æ˜¯é”¯é½¿æ³¢æœ€å°ç”Ÿæˆæ—¶é—´ã€‚

è¿è¡Œä»£ç ï¼š

```bash
sbeam_test -c --start-freq 3000 --delta-freq 0 --num-incr 2 --interval-val 2 --start-gain 0 --end-gain 80 --duration-us 1000
```

æ—¶é—´å®½åº¦è®¾ç½®ä¸º 1 msï¼Œå»¶æ—¶è®¾ç½®ä¸º 4ms

1msçš„å›ºå®šå¢ç›Šé…ç½®ï¼š

```bash
sbeam_test -c --start-freq 3000 --delta-freq 0 --num-incr 2 --interval-val 2 --start-gain 80 --end-gain 80 --duration-us 1000
```

æ­¤æ—¶è¿è¡Œå±…ç„¶ç¨‹åºå¤±è´¥äº†ã€‚å‘ç°é—®é¢˜ï¼Œæ˜¯å› ä¸ºåœ¨ç›¸åŒå¢ç›Šé…ç½®ç”µå‹åï¼Œå±…ç„¶æ‰‹åŠ¨é‡Šæ”¾äº†i2cèµ„æºã€‚

### 100msæ—¶é—´å®½åº¦æµ‹è¯•

```bash
sbeam_test -c --start-freq 30 --delta-freq 0 --num-incr 2 --interval-val 2 --start-gain 0 --end-gain 80 --duration-us 100000
```

### 300msæ—¶é—´å®½åº¦æµ‹è¯•(295000å¼€å§‹å¤±æ•ˆ)

```bash
sbeam_test -c --start-freq 30 --delta-freq 0 --num-incr 2 --interval-val 2 --start-gain 0 --end-gain 80 --duration-us 300000
```

æ­¤æ—¶é”¯é½¿æ³¢ç”Ÿæˆä¸äº†ã€‚ä¸è¿‡ä½¿ç”¨ä¹‹å‰çš„æ¿å­å°±å¯ä»¥è¾“å‡º300msçš„é”¯é½¿æ³¢ï¼ˆä½¿ç”¨é”¯é½¿æ³¢æ ¸å¿ƒç¨‹åº`./ad8338_gain_sweep_with_resistors`ï¼‰

æ€€ç–‘æ˜¯ GPIO å‘é€çš„åœæ­¢æ—¶é—´å¯èƒ½ä¼šæœ‰å½±å“ã€‚ç°åœ¨å¯åŠ¨é”¯é½¿æ³¢è¾“å‡ºåï¼Œæ˜¯å»¶è¿Ÿ 500us ï¼ˆ0.5msï¼‰ååœæ­¢é”¯é½¿æ³¢è¾“å‡ºçš„ã€‚ç°åœ¨ä¿®æ”¹ GPIO è°ƒç”¨æ—¶é—´é—´éš”ä¸º1msï¼Œå†æ¬¡å°è¯•ä¸‹ã€‚

okäº†ï¼Œèƒ½å¤Ÿæ­£å¸¸è¾“å‡ºäº†ã€‚ä½†æ˜¯æ­¤æ—¶è¾“å‡ºæ—¶é—´æœ€å°å€¼åªèƒ½æ˜¯1.1msä»¥ä¸Š

# 10.29

## æ—¶é—´å®½åº¦2

### 480msæ—¶é—´å®½åº¦æµ‹è¯•

æ­¤æ—¶ GPIO è§¦å‘åœæ­¢æ³¢å½¢ç”Ÿæˆå‡½æ•°çš„æ—¶é—´é—´éš”ä¸º 1 msï¼š

```bash
./sbeam_test -c --start-freq 30 --delta-freq 0 --num-incr 2 --interval-val 2 --start-gain 0 --end-gain 80 --duration-us 480000
```

æ­¤æ—¶èƒ½å¤Ÿè¾“å‡ºæ­£å¸¸çš„é”¯é½¿æ³¢ã€‚

ä½†æ˜¯490mså°±ä¸å¯ä»¥ï¼Œå°†æ—¶é—´é—´éš”æ”¹ä¸º3msï¼Œæ­¤æ—¶è¾“å‡ºokã€‚

å¢ç›Šè¾“å‡ºæ—¶é—´æŒç»­åˆ°2.7sï¼Œéƒ½æ˜¯æ­£å¸¸çš„ã€‚ä½†æ˜¯åˆ°äº†2.8så°±ä¸èƒ½è¾“å‡ºäº†

### 2.8sæ—¶é—´å®½åº¦æµ‹è¯•

æ­¤æ—¶ GPIO æ—¶é—´é—´éš”ä¸º 3ms

```bash
./sbeam_test -c --start-freq 30 --delta-freq 0 --num-incr 2 --interval-val 2 --start-gain 0 --end-gain 80 --duration-us 2800000
```

æ­¤æ—¶èƒ½å¤Ÿè¾“å‡ºæ­£å¸¸çš„é”¯é½¿æ³¢ã€‚

å°†å…¶æ”¹ä¸º 4 msã€‚

æœ€ç»ˆä½¿ç”¨0.5ms GPIO å¯åœå»¶è¿Ÿï¼Œä½†æ˜¯å¯¹åº”çš„å¢ç›ŠæŒç»­æ—¶é—´é™åˆ¶ä¸º 1ms - 250ms

## æ‰“åŒ…ä¸ºåº“

è¿™ä¸ªåº“çš„è¿è¡Œéœ€æ±‚æ˜¯ï¼š

> è¿™ä¸ªåº“ä¸ä¼šåœ¨ PCï¼ˆx86ï¼‰ä¸Šè¿è¡Œï¼Œä¹Ÿä¸ä¼šè¢« x86 ç¨‹åºè°ƒç”¨ï¼Œåªæ˜¯**åœ¨ PC ä¸Šç¼–è¯‘ã€åœ¨ ARM ä¸Šè¿è¡Œ**
>
> æ‰€ä»¥**åº“ï¼ˆ.so / .aï¼‰å¿…é¡»ç”¨ ARM äº¤å‰ç¼–è¯‘å™¨ç”Ÿæˆ**ï¼Œå› ä¸ºå®ƒæœ€ç»ˆè¦åœ¨ ARM ä¸Šè¢«é“¾æ¥å’Œè¿è¡Œã€‚

## æ±‡æ€»ä»£ç 

å·²ç»å°†å®Œæ•´ä»£ç æäº¤åˆ°SVNã€‚è¿˜å‰©ä¸€ä¸ªäº¤å‰ç¼–è¯‘ç¯å¢ƒè¦æä¾›ç»™ç”¨æˆ·ã€‚

## ATK-DLIMX93ç¼–è¯‘ç¯å¢ƒ

ç°åœ¨éœ€è¦å°†ï¼š

- collecter ç¨‹åº
- dac63001

ä¸¤ä¸ªç¨‹åºäº¤å‰ç¼–è¯‘åˆ°å¼€å‘æ¿IMX93ä¸Šã€‚é¦–å…ˆæ˜¯é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒã€‚æŒ‰ç…§ã€Š03ã€æ­£ç‚¹åŸå­ã€‘ATK-DLIMX93å‡ºå‚ç³»ç»Ÿæºç ä½¿ç”¨æŒ‡å—V1.0ã€‹é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒï¼Œåœ¨ä½¿ç”¨ä¹‹å‰ï¼Œéœ€è¦æ‰‹åŠ¨ä½¿èƒ½ç¯å¢ƒå˜é‡ï¼š

```bash
source /opt/fsl-imx-xwayland/6.1-mickledore/environment-setup-armv8a-poky-linux
```

éªŒè¯

```bash
env | grep "poky"
```

```bash
aarch64-poky-linux-gcc --version
```

æ‰§è¡Œï¼š

```bash
crx@crx-PC:~/work/project/collecter$ aarch64-poky-linux-gcc --version
aarch64-poky-linux-gcc (GCC) 12.3.0
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

éªŒè¯å®Œæ¯•åï¼Œå°±å¯ä»¥è¿›è¡Œå¼€å‘äº†ã€‚

ç°åœ¨å¦‚æœæˆ‘æƒ³ä½¿ç”¨è¿™ä¸ªç¼–è¯‘å™¨ç¼–è¯‘ç¨‹åºï¼Œæˆ‘è¯¥æ€ä¹ˆåšï¼Ÿ

éœ€è¦åœ¨`Makefile`ä¸­é…ç½®ç¼–è¯‘å™¨çš„æ—¶å€™

```makefile
# =========================
# å·¥å…·é“¾é…ç½®ï¼ˆIMX93 ç¯å¢ƒï¼‰
# =========================
# è‹¥ç³»ç»Ÿå·²é€šè¿‡ source å¯¼å‡º CC ç­‰å˜é‡ï¼Œåˆ™ç›´æ¥ä½¿ç”¨å®ƒ
ifeq ($(origin CC), default)
CC := aarch64-poky-linux-gcc
endif
```

## é›†æˆcollecter

ç°åœ¨éœ€è¦å°†åŸæœ‰çš„é€šè¿‡å¢ç›Šé…ç½® DAC63004 çš„ç”µå‹ï¼Œæ”¹ä¸ºé€šè¿‡å¢ç›Šé…ç½® DAC63001 çš„ç”µå‹ã€‚é¦–å…ˆæŸ¥çœ‹`DAC_63004.h`ä¸­æä¾›çš„æ¥å£ï¼Œçœ‹çœ‹é¡¹ç›®åœ¨å“ªé‡Œå¼•ç”¨äº†è¿™äº›æ¥å£ã€‚

```c
int config_gain(int chn, int gain, int rep);
```

è¿™ä¸ªå°±æ˜¯é…ç½®å¢ç›Šçš„æ ‡å‡†æ¥å£ï¼Œåœ¨`/home/crx/work/project/collecter/app/calc.c`ä¸­è°ƒç”¨äº†

```C
fpga_init(c);
if(type){
    c->show_charts = e_calc_cfg_ok;
}else{
    for(int i=0; i<MAX_CHN_CNT; i++){
        config_gain(i, c->cfg.gain[0], 0);
    }
    c->adjust_en = e_calc_cfg_ok;
} 
```

å¥½åƒæ˜¯ç»™æ‰€æœ‰çš„é€šé“é…ç½®åŒä¸€ä¸ªå¢ç›Šï¼Œä¸”è¡¥å¿å€¼ä¸º0ã€‚

æˆ‘ä»¬çœ‹ä¸‹`DAC63004`æ˜¯å¦‚ä½•å°†å¢ç›Šé…ç½®ä¸‹å»çš„ã€‚

### DAC63004é…ç½®å¢ç›Š

dac63004é…ç½®å¢ç›Šçš„æ¥å£ä¸ºï¼š

```C
int config_gain(int chn, int gain, int rep);
```

æ‰€ä½œçš„åŠŸèƒ½å°±æ˜¯ï¼š

1. éªŒè¯å…¥å‚çš„åˆæ³•æ€§
2. å°†è¾“å…¥çš„ AD8338 çš„å¢ç›Šå€¼ï¼Œè½¬æ¢ä¸ºå¯¹åº” dac63004 çš„ç”µå‹å€¼ç¼–ç 
3. å°†ç”µå‹å€¼ç¼–ç å†™å…¥åˆ° DAC63004

æ‰€ä»¥æˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯ï¼š

1. å°†å¢ç›Šè½¬æ¢ä¸º AD8338 æ‰€éœ€è¦çš„ç”µå‹å€¼
2. é…ç½® DAC63001 ç”Ÿæˆå›ºå®šç”µå‹å€¼

# 10.30

## ç”µæœºåŠ å…¥ç›¸å¯¹ä½ç½®ä¿¡æ¯

### å¢åŠ ç›¸å¯¹ä½ç½®

> ç°æœ‰çš„è¡Œè½¦ç³»ç»Ÿä¸­ï¼Œåªæœ‰ä¸€ä¸ªç»å¯¹åæ ‡ç³»ï¼Œ è¡Œè½¦å½’é›¶åéœ€è¦é‡æ–°è®¾ç½®é™ä½ä¿¡æ¯ã€‚éœ€å¢åŠ ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼Œ ç”¨æˆ·æ§åˆ¶è¡Œè½¦è¿åŠ¨æ—¶ï¼Œä½¿ç”¨ç›¸å¯¹ä½ç½®å®šä½ï¼Œ é™ä½åˆ¤æ–­ä½¿ç”¨ç”µæœºç»å¯¹ä½ç½®

å¦‚æœä½¿ç”¨æ•°æ®åº“ä¿å­˜ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼š

1. æ¯æ¬¡ç§»åŠ¨éƒ½å°†ç»å¯¹ä½ç½®è®°å½•ä¸‹æ¥ï¼ˆæ€§èƒ½å¼€é”€å¤§ï¼‰
2. è®¾ç½®åŸç‚¹ä¹‹å‰ï¼Œé¦–å…ˆå°†ç”µæœºçš„å½“å‰ç»å¯¹ä½ç½®è®°å½•ä¸‹æ¥ï¼Œè®°å½•å®Œæ¯•åï¼Œè®¾ç½®åŸç‚¹ï¼ˆä¸¤å¥—å¤–è®¾æ§åˆ¶åŒä¸€ä¸ªå¸¦é™ä½çš„ç”µæœºï¼Œä¼šå¯¼è‡´ä¸¤å¥—å¤–è®¾çš„æ•°æ®åº“ä¸ç»Ÿä¸€ï¼‰

è¿™æ ·å°±éœ€è¦ç»Ÿä¸€çš„ä¸€ä¸ªè®¾å¤‡ï¼ˆè“ç‰™ç›’å­ï¼‰å­˜å‚¨æ¯ä¸ªç”µæœºé›¶ç‚¹çš„ç»å¯¹ä½ç½®ã€‚è¿™æ ·å°±å¯ä»¥å®ç°å¤šå¥—å¤–è®¾å¯¹åº”åŒä¸€ä¸ªç”µæœºï¼Œä¹Ÿä¼šæœ‰ç›¸åŒçš„é™ä½ä¿¡æ¯ã€‚

åœ¨åŠ å…¥äº†ç»Ÿä¸€çš„ç»å¯¹ä½ç½®ä¿¡æ¯åï¼Œæ€ä¹ˆå®ç°ä½ç½®ç§»åŠ¨å’Œç‚¹åŠ¨å‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆåˆ†æä¸‹ï¼Œå½“å‰çš„ä½ç½®ã€ç‚¹åŠ¨ç§»åŠ¨é€»è¾‘ã€‚

### å½“å‰ä½ç½®ç§»åŠ¨é€»è¾‘

`actionDir(int dir)`å‡½æ•°å¯¹äºä½ç½®åˆ¤æ–­çš„é€»è¾‘ï¼š

1. ç¦ç”¨ç•Œé¢æ‰€æœ‰æŒ‰é’®ï¼ˆé™¤äº†ç´§æ€¥åœæ­¢ï¼‰
2. è®¡ç®—ç›®æ ‡ä½ç½® = è¦ç§»åŠ¨çš„è·ç¦» + å½“å‰ç”µæœºçš„ç»å¯¹ä½ç½®ï¼ˆé›¶ç‚¹æ— å…³ï¼‰ã€‚ç„¶ååˆ¤æ–­æ˜¯å¦è¶…å‡ºé™åˆ¶çš„èŒƒå›´ã€‚ï¼ˆç›®æ ‡ä½ç½®ï¼šå½“å‰ä½ç½®ä¸º15mmï¼Œè¦å‘å‰ç§»åŠ¨5mmï¼Œé‚£ä¹ˆ20mmå°±æ˜¯ç›®æ ‡ä½ç½®ï¼‰
3. å¦‚æœæ²¡æœ‰è¶…å‡ºèŒƒå›´ï¼Œåˆ™æ­£å¸¸è¿›è¡Œä½ç½®ç§»åŠ¨

å¦‚æœå¼•å…¥äº†ç»å¯¹ä½ç½®ï¼Œé‚£ä¹ˆè¦è®¡ç®—ç›®æ ‡ä½ç½®çš„æ—¶å€™ï¼Œè¦ç§»åŠ¨çš„è·ç¦»æ˜¯ç›¸åŒçš„ï¼Œå½“å‰ç”µæœºçš„ç»å¯¹ä½ç½®ï¼ˆæ­¤æ—¶çš„ç»å¯¹ä½ç½®ï¼Œå°±æ˜¯ç›¸å¯¹äºé›¶ç‚¹çš„ç›¸å¯¹ä½ç½®äº†ï¼‰ä¹Ÿæ˜¯éœ€è¦è·å–å¹¶åŠ å…¥çš„ã€‚ä½†æ˜¯é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦å°†é›¶ç‚¹å¯¹åº”çš„ç»å¯¹ä½ç½®åŠ å…¥è¿›æ¥ã€‚è¿™æ ·ï¼š

- `L1 = getLocation()`ï¼šç”µæœºç›¸å¯¹äºé›¶ç‚¹çš„ç›¸å¯¹ä½ç½®
- `L0 = getZeroLocation()`ï¼šå°±æ˜¯è·å–é›¶ç‚¹çš„ç»å¯¹ä½ç½®

æ­¤æ—¶ L0 + L1 å°±æ˜¯ç”µæœºçœŸå®çš„ç»å¯¹ä½ç½®ï¼Œé™ä½å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚

å› ä¸ºä½ç½®ç§»åŠ¨æ˜¯è·ç¦»å¯æ§çš„ï¼Œä¸­é€”ä¸éœ€è¦é¢‘ç¹è·å–é›¶ç‚¹ä½ç½®ã€‚å¼€å§‹æ—¶è®¡ç®—ä¸è¶…è¿‡é™ä½ï¼Œç»“æŸæ—¶ä¹Ÿä¸ä¼šè¶…å‡ºã€‚

### å½“å‰ç‚¹åŠ¨é€»è¾‘çš„ä½ç½®åˆ¤æ–­

**ç‚¹åŠ¨å‰**ï¼š

ç‚¹åŠ¨ç§»åŠ¨å‰ï¼Œå°±æ˜¯è·å–å½“å‰ç”µæœºçš„ç»å¯¹ä½ç½®ï¼Œç„¶åçœ‹æ˜¯å¦å¤„äºé™ä½ä¹‹é—´ã€‚å½“å‰ç”µæœºçš„ç»å¯¹ä½ç½®ï¼Œå°±æ˜¯ä¸è®¡é›¶ç‚¹çš„ã€‚

`actionJog(int dir)`å‡½æ•°å¯¹äºä½ç½®åˆ¤æ–­ï¼Œé›†æˆåœ¨å‡½æ•°`isPositionWithLimit()`ä¸­ã€‚

**ç‚¹åŠ¨ä¸­**ï¼š

ç‚¹åŠ¨å¼€å§‹åï¼Œè°ƒç”¨çº¿ç¨‹`checkJog()`è¿›è¡Œç‚¹åŠ¨çŠ¶æ€æ£€æµ‹ã€‚å¯¹äºä½ç½®æ˜¯å¦è¶…å‡ºé™ä½çš„é€»è¾‘ä¸ºï¼š

1. è·å–å½“å‰ç”µæœºçš„ç»å¯¹ä½ç½®
2. æ¯”è¾ƒå½“å‰ç»å¯¹ä½ç½®æ˜¯å¦è¶…å‡ºäº†é™ä½

åŠ å…¥é›¶ç‚¹ç»å¯¹ä½ç½®åï¼Œæ­¤æ—¶çš„`getLocation()`ç›¸å½“äºè·å–ç›¸å¯¹é›¶ç‚¹çš„ç›¸å¯¹ä½ç½®ã€‚æ­¤æ—¶ç”µæœºçš„å®é™…ä½ç½®ï¼Œå°±éœ€è¦é›¶ç‚¹çš„ç»å¯¹ä½ç½® + ç›¸å¯¹ä½ç½®æ‰å¯ä»¥ã€‚

å½“å‰è¦è®¡ç®—çš„ç»å¯¹ä½ç½® = `getZeroLocation()` + `getLocation()`ã€‚åªæœ‰è¿™ä¸ªç»å¯¹ä½ç½®ä¸è¶…è¿‡ï¼Œæ‰èƒ½è®©ç‚¹åŠ¨ç»§ç»­è¿›è¡Œã€‚

### ç»¼åˆ

å¯¹äºé›¶ç‚¹çš„è·å–ï¼Œèƒ½å¦åœ¨`MotorCtrl.cpp`åˆå§‹åŒ–çš„æ—¶å€™å°±è¯»å–ï¼ˆè“ç‰™ç›’å­ï¼‰é›¶ç‚¹çš„ç»å¯¹ä½ç½®ï¼Œç„¶åæ”¾åœ¨å…¨å±€å˜é‡ä¸­ã€‚è¿™æ ·å°±ä¼šçœå»é¢‘ç¹è°ƒç”¨è·å–è¿™ä¸ªå˜é‡çš„æ—¶é—´ã€‚

ä½†æ˜¯ä¿®æ”¹é›¶ç‚¹çš„æ—¶å€™ï¼ˆ`setOrigin()`ï¼‰ï¼Œå°±éœ€è¦åŒæ­¥æ›´æ–°å…¨å±€å˜é‡å’Œå¯¹åº”è“ç‰™ç›’å­ä¸­é›¶ç‚¹çš„ç»å¯¹ä½ç½®ã€‚

## ç›¸å¯¹ä½ç½®åŠ å…¥é€»è¾‘

### ä¸€ã€é—®é¢˜èƒŒæ™¯

å½“å‰è¡Œè½¦æ§åˆ¶ç³»ç»Ÿä»…ä½¿ç”¨**ç»å¯¹åæ ‡ç³»**ã€‚

- æ¯æ¬¡å½’é›¶åéƒ½éœ€è¦é‡æ–°è®¾ç½®é™ä½ä¿¡æ¯ï¼›
- ç”¨æˆ·æ“ä½œæ—¶ä¸æ–¹ä¾¿è¿›è¡ŒåŸºäºç›¸å¯¹åæ ‡çš„ç§»åŠ¨ã€‚

ç›®æ ‡ï¼šå¼•å…¥**ç›¸å¯¹ä½ç½®ä¿¡æ¯**ã€‚ä»¥ä¾¿äºï¼š

- ç”¨æˆ·ä»¥ç›¸å¯¹é›¶ç‚¹çš„æ–¹å¼è¿›è¡Œæ§åˆ¶ï¼ˆæ›´ç¬¦åˆç›´è§‰ï¼‰ï¼›
- ç³»ç»Ÿä¾æ—§ä½¿ç”¨ç»å¯¹ä½ç½®è¿›è¡Œé™ä½åˆ¤æ–­ï¼ˆå®‰å…¨ï¼‰ã€‚

### äºŒã€ç°æœ‰é—®é¢˜

| ç¼–å· | é—®é¢˜æè¿°                                     | å½±å“                           |
| ---- | -------------------------------------------- | ------------------------------ |
| 1    | è‹¥æ¯æ¬¡ç§»åŠ¨éƒ½å°†ç»å¯¹ä½ç½®å†™å…¥æ•°æ®åº“ï¼Œæ€§èƒ½å¼€é”€å¤§ | æ•°æ®åº“é¢‘ç¹è®¿é—®                 |
| 2    | è‹¥ç”±å¤šå¥—å¤–è®¾åˆ†åˆ«è®°å½•é›¶ç‚¹ï¼Œå¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´ | é›¶ç‚¹æ¼‚ç§»ã€é™ä½å¤±æ•ˆ             |
| 3    | ç‚¹åŠ¨ä¸ä½ç½®ç§»åŠ¨é€»è¾‘ä¸­ï¼Œæœªå¼•å…¥é›¶ç‚¹çš„ç»å¯¹ä½ç½®   | æ— æ³•åŒæ—¶å…¼é¡¾ç›¸å¯¹ä½ç½®ä¸é™ä½åˆ¤æ–­ |
| 4    | æ¯æ¬¡ä½ç½®åˆ¤æ–­éƒ½ä»è“ç‰™ç›’å­è¯»å–é›¶ç‚¹ä¿¡æ¯         | æ€§èƒ½æµªè´¹                       |

### ä¸‰ã€è§£å†³æ€è·¯

#### 1. ç»Ÿä¸€é›¶ç‚¹ç®¡ç†

- åœ¨è“ç‰™ç›’å­ä¸­**é›†ä¸­å­˜å‚¨æ¯ä¸ªç”µæœºçš„é›¶ç‚¹ç»å¯¹ä½ç½®**ï¼›
- æ‰€æœ‰å¤–è®¾è¯»å–åŒä¸€ä»½æ•°æ®ï¼Œå®ç°é›¶ç‚¹ç»Ÿä¸€ï¼›
- é¿å…é™ä½ä¸ä¸€è‡´é—®é¢˜ã€‚

#### 2.å¼•å…¥ä¸¤å±‚ä½ç½®ä½“ç³»

å®šä¹‰ä¸‰ä¸ªå…³é”®é‡ï¼š

| åç§°                     | å«ä¹‰                           |
| ------------------------ | ------------------------------ |
| `L0 = getZeroLocation()` | é›¶ç‚¹çš„ç»å¯¹ä½ç½®ï¼ˆæ¥è‡ªè“ç‰™ç›’å­ï¼‰ |
| `L1 = getLocation()`     | å½“å‰ç”µæœºç›¸å¯¹é›¶ç‚¹çš„ç›¸å¯¹ä½ç½®     |
| `L_abs = L0 + L1`        | ç”µæœºçœŸå®ç»å¯¹ä½ç½®               |

> **é™ä½åˆ¤æ–­** ä½¿ç”¨ `L_abs`
>  **ç”¨æˆ·æ“ä½œ** ä½¿ç”¨ `L1`

### å››ã€é€»è¾‘ä¿®æ”¹ç‚¹

#### 1. ä½ç½®ç§»åŠ¨é€»è¾‘ï¼ˆ`actionDir(int dir)`ï¼‰

- åŸé€»è¾‘ï¼š
   ç›®æ ‡ = å½“å‰ç»å¯¹ä½ç½® + ç§»åŠ¨è·ç¦»
- æ–°é€»è¾‘ï¼š
   ç›®æ ‡ = (é›¶ç‚¹ç»å¯¹ä½ç½® + ç›¸å¯¹é›¶ç‚¹ä½ç½®) + ç§»åŠ¨è·ç¦»
- åˆ¤æ–­é™ä½æ—¶ï¼Œä½¿ç”¨ç›®æ ‡çš„ç»å¯¹ä½ç½®åˆ¤æ–­ã€‚

#### 2. ç‚¹åŠ¨é€»è¾‘

- **ç‚¹åŠ¨å‰æ£€æŸ¥**ï¼š
   åˆ¤æ–­ `(L0 + L1)` æ˜¯å¦å¤„äºé™ä½èŒƒå›´å†…ï¼›
- **ç‚¹åŠ¨è¿‡ç¨‹ä¸­**ï¼ˆ`checkJog()`ï¼‰ï¼š
   å®æ—¶è®¡ç®— `(L0 + L1)`ï¼Œè‹¥è¶…å‡ºé™ä½åˆ™åœæ­¢ã€‚

#### 3. é›¶ç‚¹æ›´æ–°

- åˆå§‹åŒ–æ—¶ï¼š
   ç¨‹åºå¯åŠ¨ â†’ ä»è“ç‰™ç›’å­è¯»å–é›¶ç‚¹ç»å¯¹ä½ç½® â†’ å­˜å…¥å…¨å±€å˜é‡ï¼›
- æ›´æ–°æ—¶ï¼ˆ`setOrigin()`ï¼‰ï¼š
  - é‡æ–°æµ‹é‡å½“å‰ç»å¯¹ä½ç½®ä½œä¸ºæ–°é›¶ç‚¹ï¼›
  - åŒæ­¥æ›´æ–°è“ç‰™ç›’å­ï¼›
  - åŒæ­¥æ›´æ–°å…¨å±€ç¼“å­˜

### äº”ã€å®æ–½å»ºè®®

1. **æ•°æ®ç»“æ„**

   - å®šä¹‰ä¸€ä¸ª `MotorState` ç±»/ç»“æ„ï¼Œé›†ä¸­ç®¡ç†ï¼š

     ```c++
     struct MotorState {
         double zeroAbsPos;   // L0
         double relPos;       // L1
         double absPos() const { return zeroAbsPos + relPos; }
     };
     ```

   - æ‰€æœ‰é€»è¾‘åªæ“ä½œ `MotorState`ã€‚

2. **æ€§èƒ½ä¼˜åŒ–**

   - é›¶ç‚¹åªåœ¨å¯åŠ¨å’Œæ›´æ–°æ—¶è¯»å–ï¼›
   - è¿è¡Œä¸­ä¸å†è®¿é—®è“ç‰™ç›’å­

3. **å®‰å…¨æ€§**

   - é™ä½åˆ¤æ–­å§‹ç»ˆä½¿ç”¨ç»å¯¹ä½ç½®ï¼›
   - åªå…è®¸ä¿®æ”¹é›¶ç‚¹çš„æ¨¡å—æ›´æ–°å…¨å±€å˜é‡å’Œè“ç‰™ç›’å­ã€‚

### å…­ã€å­˜ç–‘ç‚¹

å¦‚æœç°åœ¨å…¨å±€å˜é‡`MotorState`ä¿å­˜äº†ç”µæœºçš„ä½ç½®ï¼Œå¹¶ä¸”åœ¨è¿›ç¨‹Aä¸­ï¼Œé™åˆ¶äº†åªæœ‰ä¿®æ”¹é›¶ç‚¹çš„æ¨¡å—ï¼ˆä¿®æ”¹`zeroAbsPos`ï¼‰å’Œè·å–ä½ç½®çš„æ¨¡å—ï¼ˆä¿®æ”¹`relPos`ï¼‰å¯ä»¥ä¿®æ”¹è¿™ä¸ªä½ç½®ä¿¡æ¯ã€‚

é‚£ä¹ˆå¦‚æœæ­¤æ—¶å¦ä¸€ä¸ªè¿›ç¨‹Bä¹Ÿåœ¨æ§åˆ¶è¿™ä¸ªç”µæœºï¼Œé‚£ä¹ˆå¦‚æœæ­¤è¿›ç¨‹Bè®¾ç½®äº†é›¶ç‚¹æˆ–è€…ç§»åŠ¨äº†ç”µæœºï¼Œé‚£å°±ä¼šå¯¼è‡´ä¸¤ä¸ªè¿›ç¨‹ç¼“å­˜çš„ä½ç½®ä¿¡æ¯ä¸ä¸€è‡´ã€‚ä»è€Œå¯¼è‡´Aè¿›ç¨‹ä½ç½®ä¿¡æ¯æ··ä¹±ã€‚å¦‚ä½•è§£å†³ï¼Ÿ

> å¤šä¸ªè¿›ç¨‹å„è‡ªç»´æŠ¤ä½ç½®ç¼“å­˜ï¼ˆ`MotorState`ï¼‰ä¼šäº§ç”ŸçŠ¶æ€åˆ†è£‚ï¼Œè¿›è€Œå¯¼è‡´é™ä½è¯¯åˆ¤æˆ–è¿åŠ¨é€»è¾‘é”™è¯¯ã€‚

è¿™ä¸ªé—®é¢˜å¼•å‡ºæ¥çš„æ ¸å¿ƒæ˜¯ï¼š

**ç”µæœºçŠ¶æ€å¿…é¡»æœ‰å”¯ä¸€æƒå¨æºï¼ˆsource of truthï¼‰**ã€‚

 æ— è®ºæ˜¯è“ç‰™ç›’å­è¿˜æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œéƒ½è¦è®©æ‰€æœ‰æ§åˆ¶è€…â€œè¯»å†™åŒä¸€ä¸ªçœŸå€¼â€ï¼Œå¦åˆ™å±€éƒ¨ç¼“å­˜å¿…ç„¶åˆ†è£‚ã€‚

## çŠ¶æ€åˆ†è£‚é£é™©

**â€œå¤šè¿›ç¨‹æ§åˆ¶åŒä¸€ç‰©ç†è®¾å¤‡çš„çŠ¶æ€ä¸€è‡´æ€§é—®é¢˜â€**ï¼š

> å¤šä¸ªè¿›ç¨‹å„è‡ªç»´æŠ¤ä½ç½®ç¼“å­˜ï¼ˆ`MotorState`ï¼‰ä¼šäº§ç”ŸçŠ¶æ€åˆ†è£‚ï¼Œè¿›è€Œå¯¼è‡´é™ä½è¯¯åˆ¤æˆ–è¿åŠ¨é€»è¾‘é”™è¯¯ã€‚

åˆ†ä¸‰æ­¥åˆ†æï¼š
 1ï¸âƒ£ æ˜ç¡®é—®é¢˜æœ¬è´¨

 2ï¸âƒ£ å¯èƒ½çš„è§£å†³æ¶æ„

 3ï¸âƒ£ æ¨èå®ç°æ–¹å¼ï¼ˆå¯è½åœ°ï¼‰

### ä¸€ã€é—®é¢˜æœ¬è´¨ï¼šçŠ¶æ€åˆ†è£‚ï¼ˆState Divergenceï¼‰

å‡è®¾ï¼š

- è¿›ç¨‹ Aï¼šä¸»æ§åˆ¶ç•Œé¢
  - æŒæœ‰è‡ªå·±çš„ `MotorState`ï¼ˆå« `zeroAbsPos`, `relPos`ï¼‰
- è¿›ç¨‹ Bï¼šå¦ä¸€æ§åˆ¶å®¢æˆ·ç«¯
  - åŒæ ·æŒæœ‰è‡ªå·±çš„ `MotorState`
  - ä¹Ÿèƒ½æ“ä½œåŒä¸€ä¸ªç”µæœºï¼ˆé€šè¿‡ Modbus / è“ç‰™ç›’å­ï¼‰

**é£é™©åœ¨äºï¼š**

- B è°ƒç”¨ `setOrigin()` æ›´æ–°äº†é›¶ç‚¹ï¼ˆè“ç‰™ç›’å­å­˜å‚¨å˜åŒ–ï¼‰ï¼Œä½† A çš„ç¼“å­˜ä»æ˜¯æ—§å€¼ï¼›
- æˆ–è€… B æ‰§è¡Œç‚¹åŠ¨ / ä½ç½®ç§»åŠ¨ï¼Œä½¿ç”µæœºç‰©ç†ä½ç½®å˜åŒ–ï¼Œä½† A çš„ `relPos` æœªæ›´æ–°ï¼›
- A åç»­å‘å‡ºçš„åŠ¨ä½œåŸºäºâ€œæ—§çŠ¶æ€â€è®¡ç®—ç›®æ ‡ä½ç½® â†’ é€ æˆé”™è¯¯åŠ¨ä½œç”šè‡³æ’é™ä½ã€‚

è¿™å°±æ˜¯**åˆ†å¸ƒå¼çŠ¶æ€åŒæ­¥é—®é¢˜**ï¼Œå…¸å‹çš„â€œå¤šæ§åˆ¶æº + æœ¬åœ°ç¼“å­˜â€å¯¼è‡´çš„éä¸€è‡´æ€§ã€‚

### äºŒã€é›†ä¸­çŠ¶æ€ç®¡ç†è§£å†³

è®©**è“ç‰™ç›’å­**æˆ–**ä¸­é—´æœåŠ¡è¿›ç¨‹**å……å½“â€œçŠ¶æ€ä¸­å¿ƒâ€ï¼Œæ‰€æœ‰çŠ¶æ€è¯»å†™ç»Ÿä¸€èµ°å®ƒã€‚

#### æ¶æ„å›¾ï¼š

```bash
+--------------------+
|   è“ç‰™ç›’å­/çŠ¶æ€æœåŠ¡ |
|  - ä¿å­˜ zeroAbsPos |
|  - ä¿å­˜ relPos æˆ– absPos |
|  - æä¾›è¯»/å†™æ¥å£   |
+---------+----------+
          |
  ---------------------
  |                   |
è¿›ç¨‹A               è¿›ç¨‹B
  |                   |
  ---> è¯»/å†™ API <----
```

#### ä¼˜ç‚¹ï¼š

- çŠ¶æ€å”¯ä¸€ï¼›
- ä»»æ„è¿›ç¨‹æ“ä½œéƒ½ä¼šè¢«åŒæ­¥æ„ŸçŸ¥ï¼›
- å¯å¤©ç„¶æ‰©å±•åˆ°ç½‘ç»œå¤šèŠ‚ç‚¹ã€‚

#### ç¼ºç‚¹ï¼š

- å¢åŠ äº† IPC æˆ–ç½‘ç»œè®¿é—®çš„å»¶è¿Ÿï¼›
- å®ç°ç¨å¤æ‚ï¼ˆéœ€è¦å…±äº«è®¿é—®æœºåˆ¶ï¼‰ã€‚

#### å®ç°æ–¹å¼ï¼š

- è‹¥è“ç‰™ç›’å­å…·å¤‡å†™å…¥æ¥å£ â†’ ç›´æ¥è®©å®ƒæˆä¸ºå”¯ä¸€å­˜å‚¨æºï¼›
- è‹¥è“ç‰™ç›’å­ä»…æä¾›åªè¯»æ¥å£ â†’ å¯ä»¥åœ¨ç³»ç»Ÿä¸­å¢åŠ ä¸€ä¸ª **å®ˆæŠ¤è¿›ç¨‹ `MotorStateService`**ï¼š
  - è´Ÿè´£ä¸ç¡¬ä»¶é€šä¿¡ï¼›
  - æš´éœ²æœ¬åœ° IPC æ¥å£ï¼ˆå¦‚ UNIX domain socket / DBus / gRPCï¼‰ï¼›
  - è¿›ç¨‹ Aã€B å‡é€šè¿‡å®ƒè¿›è¡Œè¯»å†™ã€‚

### ä¸‰ã€å®è·µå»ºè®®

å®šä¹‰ä¸€ä¸ªçŠ¶æ€æœåŠ¡ `MotorStateService`ï¼š

```c++
// MotorStateService.h
struct MotorState {
    double zeroAbsPos;
    double relPos;
    double absPos() const { return zeroAbsPos + relPos; }
};

class MotorStateService {
public:
    static MotorStateService& instance();
    MotorState getState();
    void setZero(double zero);
    void updateRelative(double rel);
private:
    MotorState m_state;
    std::mutex mtx;
};
```

åœ¨ç³»ç»Ÿä¸­ï¼š

- è¿›ç¨‹ Aã€B éƒ½é€šè¿‡ `MotorStateService` è·å–æˆ–ä¿®æ”¹çŠ¶æ€ï¼›
- å†…éƒ¨ç”±æœåŠ¡ç»Ÿä¸€ä¸è“ç‰™ç›’å­é€šä¿¡ï¼›
- å¯æ‰©å±•ä¸º IPC æœåŠ¡å½¢å¼ã€‚

> **ç”µæœºçŠ¶æ€å¿…é¡»æœ‰å”¯ä¸€æƒå¨æºï¼ˆsource of truthï¼‰**ã€‚
>  æ— è®ºæ˜¯è“ç‰™ç›’å­è¿˜æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œéƒ½è¦è®©æ‰€æœ‰æ§åˆ¶è€…â€œè¯»å†™åŒä¸€ä¸ªçœŸå€¼â€ï¼Œå¦åˆ™å±€éƒ¨ç¼“å­˜å¿…ç„¶åˆ†è£‚ã€‚

### å››ã€é—®é¢˜å»¶ç”³

å¦‚æœé‡‡ç”¨ç»Ÿä¸€çš„ä½ç½®ä¿¡æ¯çŠ¶æ€ç”±è“ç‰™ç›’å­ç»´æŠ¤

```C++
struct MotorState {
    double zeroAbsPos;
    double relPos;
    double absPos() const { return zeroAbsPos + relPos; }
};
```

Aã€Bè¿›ç¨‹åœ¨ä½ç½®ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å®æ—¶è·å–å½“å‰ç”µæœºçš„ç›¸å¯¹ä½ç½®ã€‚æ­¤æ—¶è¿›ç¨‹ä¼šè°ƒç”¨`getLocation()`æ¥è·å–ç›¸å¯¹ä½ç½®ä¿¡æ¯ã€‚æ­¤å‡½æ•°æ˜¯ç›´æ¥é€šè¿‡è¿›ç¨‹ä¸å¯¹åº”ç”µæœºçš„ä¼ºæœæ§åˆ¶å™¨è¿›è¡Œé€šä¿¡çš„ï¼Œä¸èµ°è“ç‰™ç›’å­ç›¸å…³çš„é€šè®¯ã€‚

é‚£ä¹ˆå½“è¿›ç¨‹å®æ—¶è·å–ä½ç½®ä¿¡æ¯åï¼Œå¦‚ä½•ä¿®æ”¹è“ç‰™ç›’å­ç»´æŠ¤çš„ä½ç½®ä¿¡æ¯çŠ¶æ€å‘¢ï¼Ÿå¯èƒ½çš„åœºæ™¯ï¼š

1. è¿›ç¨‹ä»ä¼ºæœæ§åˆ¶å™¨ä¸­è·å–å½“å‰ä½ç½®ï¼Œç„¶åå°†æ›´æ–°çš„æ•°æ®å†™å…¥åˆ°è“ç‰™ç›’å­ï¼ˆè¿›ç¨‹ä¸€æ”¶ä¸€å†™ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§ï¼Œå¯¼è‡´ä¸‹ä¸€æ¬¡å®æ—¶å±•ç¤ºçš„ä½ç½®ä¿¡æ¯å»¶è¿Ÿè€Œä¸å¤Ÿå‡†ç¡® ï¼‰
2. è¿›ç¨‹ä¸é€šè¿‡ä¼ºæœæ§åˆ¶å™¨ç›´æ¥è·å–å½“å‰ä½ç½®ï¼Œç›´æ¥é€šè¿‡è®¿é—®è“ç‰™ç›’å­ä¿å­˜ç»Ÿä¸€çš„ä½ç½®ä¿¡æ¯æ¥è·å–ã€‚è“ç‰™ç›’å­æ”¶åˆ°è·å–å½“å‰æˆ‘ä½ç½®è¯·æ±‚åï¼Œéœ€è¦å†å‘ä¼ºæœæ§åˆ¶å™¨å‘é€è·å–ä½ç½®ä¿¡æ¯çš„å‘½ä»¤ã€‚ï¼ˆè®¿é—®ä½ç½®ä¿¡æ¯ï¼Œéœ€è¦ç­‰å¾…è“ç‰™ç›’å­å’Œä¼ºæœæ§åˆ¶å™¨çš„ä¸¤æ¬¡è¯»ååº”æ—¶é—´ï¼Œä¹Ÿæ˜¯ä¸å¤Ÿå‡†ç¡®ï¼‰
3. å»¶è¿Ÿå†™å…¥è“ç‰™ç›’å­ï¼šè¿›ç¨‹ä¾æ—§åœ¨ä¼ºæœæ§åˆ¶å™¨ä¸­è·å–ç”µæœºçš„å½“å‰ä½ç½®ï¼Œä½†æ˜¯éœ€è¦åœ¨ç§»åŠ¨ç»“æŸåï¼Œå°†æœ€æ–°çš„ç§»åŠ¨æ•°æ®å†™å…¥åˆ°è“ç‰™ç›’å­çš„ä½ç½®ä¿¡æ¯ä¸­ã€‚ï¼ˆæ„Ÿè§‰ä¸é”™ï¼‰

ä½†æ˜¯å…¶å®ï¼Œæœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œè“ç‰™ç›’å­ä¸éœ€è¦ç»´æŠ¤å½“å‰ä½ç½®ä¿¡æ¯ï¼Ÿå®æ—¶ä½ç½®æ˜¯é«˜é¢‘å˜åŒ–ã€æ¯«ç§’çº§æ›´æ–°çš„å†…å®¹ï¼Œç”±ä¼ºæœé©±åŠ¨å™¨è´Ÿè´£æœ€åˆé€‚ã€‚ è“ç‰™ç›’å­å…¶å®ä¸é€‚åˆä½œä¸ºé«˜é¢‘åŒæ­¥ç‚¹ã€‚

```bash
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      è“ç‰™ç›’å­         â”‚
â”‚  å­˜ï¼šzeroAbsPos       â”‚
â”‚  é™ä½èŒƒå›´ã€é…ç½®ç­‰      â”‚
â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ï¼ˆåªåœ¨è®¾åŸç‚¹æ—¶åŒæ­¥ä¸€æ¬¡ï¼‰
      â”‚
â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ§åˆ¶è¿›ç¨‹A/B       â”‚
â”‚  è°ƒä¼ºæœå™¨â†’å¾—relPos    â”‚
â”‚  è®¡ç®—absPos = zeroAbsPos + relPos â”‚
â”‚  å±•ç¤º & æ§åˆ¶é€»è¾‘       â”‚
â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ï¼ˆå®æ—¶è¯»ï¼‰
      â”‚
â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç”µæœºä¼ºæœæ§åˆ¶å™¨     â”‚
â”‚  æä¾›å½“å‰ä½ç½®ï¼ˆé«˜é¢‘ï¼‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **è“ç‰™ç›’å­ä¸éœ€è¦ç»´æŠ¤å®æ—¶ä½ç½®ä¿¡æ¯ï¼Œåªéœ€ç»´æŠ¤â€œé›¶ç‚¹ç»å¯¹ä½ç½®â€è¿™ä¸€é™æ€åŸºå‡†ã€‚**
>  æ‰€æœ‰å®æ—¶ä½ç½®ä¿¡æ¯éƒ½ä»¥ä¼ºæœåé¦ˆä¸ºå‡†ï¼Œå¹¶é€šè¿‡ `absPos = zeroAbsPos + relPos` ç»Ÿä¸€åæ ‡ä½“ç³»ã€‚

æœ€ç»ˆè€ƒè™‘çš„å°±æ˜¯ï¼š

1. è“ç‰™ç›’å­ç»´æŠ¤â€œé›¶ç‚¹çš„ç»å¯¹ä½ç½®â€
2. å®æ—¶çš„ä½ç½®ä¿¡æ¯ï¼Œä¾æ—§é€šè¿‡è¿›ç¨‹ç›´æ¥è®¿é—®ä¼ºæœæ§åˆ¶å™¨æ¥è·å–
3. æ¯æ¬¡ä½ç½®ç§»åŠ¨çš„æ—¶å€™ï¼Œéƒ½éœ€è¦è·å–ä¸‹é›¶ç‚¹çš„ç»å¯¹ä½ç½®è¿›è¡Œé™ä½å¤„ç†

## ç”µæœºçš„åŸºç¡€é…ç½®è¿ç§»

> ç”µæœºçš„åŸºç¡€é…ç½®ä¹Ÿè¿ç§»åˆ°è“ç‰™å°ç›’å­ï¼Œè¡Œè½¦æ§åˆ¶è½¯ä»¶å¯åŠ¨åå…ˆè·å–ç”µæœºé…ç½®ï¼Œ ç”µæœºé…ç½®ä»¥å¤–çš„å…¶ä»–ä¿¡æ¯ä»æ—§åœ¨è¡Œè½¦æ§åˆ¶è½¯ä»¶æ•°æ®åº“ä¸­è®°å½•

å½“å‰ç”µæœºçš„é…ç½®ä¿¡æ¯ï¼Œæ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨å¯¹åº”çš„æœ¬åœ°å­˜å‚¨ä¸€ä»½å„ä¸ªç”µæœºçš„é…ç½®æ•°æ®åº“ã€‚

ä½†è¿™æ ·ä¼šå¯¼è‡´å¦‚æœä¸¤ä¸ªè®¾å¤‡çš„ä¸¤ä¸ªè¿›ç¨‹ä¿®æ”¹äº†ç”µæœºçš„æŸä¸€é¡¹æ•°æ®çš„è¯ï¼Œå¦ä¸€ä¸ªè®¾å¤‡çš„è¿›ç¨‹é…ç½®ä¿¡æ¯è¿˜æ˜¯ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä»è€Œå¯¼è‡´é…ç½®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

æ‰€ä»¥ä¸ºäº†ç»Ÿä¸€ç”µæœºé…ç½®ï¼Œéœ€è¦ä¸€ä¸ªæƒå¨ä¸­å¿ƒï¼ˆè“ç‰™ç›’å­ï¼‰æ¥ä¿å­˜æ•´å¥—ç”µæœºçš„åŸºç¡€é…ç½®ã€‚åç»­æ‰€æœ‰çš„ç”µæœºä¿¡æ¯è®¿é—®å’Œä¿®æ”¹ï¼Œéƒ½éœ€è¦ä¿®æ”¹è“ç‰™ç›’å­çš„é…ç½®ã€‚

### ä¸€ã€å½“å‰é…ç½®ä¿¡æ¯

ä¸‹é¢ä»ä»£ç çœ‹ä¸‹ï¼Œå½“å‰é…ç½®æ•°æ®åº“çš„é€»è¾‘ã€‚

åœ¨æ§åˆ¶ç”µæœºçš„åˆå§‹åŒ–ç¯å¢ƒçš„æ—¶å€™ï¼Œè°ƒç”¨äº†æ•°æ®åº“çš„åˆå§‹åŒ–å‡½æ•°ï¼š

```C++
DbCtrl::DbInit(0);
```

ä»ä»£ç çœ‹ï¼Œå½“å‰é…ç½®æ•°æ®åº“åŒ…å«ä»¥ä¸‹ä¸»è¦è¡¨ï¼š

- `sysInfo_tb` - ç³»ç»Ÿä¿¡æ¯è¡¨
- `user_tb` - ç”¨æˆ·è¡¨
- `servo_class_tb` - ä¼ºæœç”µæœºç±»åˆ«è¡¨
- `servoMotor_tb` - ä¼ºæœç”µæœºé…ç½®è¡¨

å…¶æ ¸å¿ƒé€»è¾‘ä¸ºï¼š

1. **æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨**ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºè¡¨ç»“æ„
2. **æ’å…¥é»˜è®¤æ•°æ®** - 7ä¸ªç”µæœºçš„é¢„è®¾é…ç½®ï¼š
   - ç”µæœºåç§°ï¼šX1, X2, Y1, Z1, Î¸, Z2, Y2
   - ä½ç½®æè¿°ï¼šå‰åç§»åŠ¨æ§åˆ¶ç”µæœºå·¦ã€å³ç­‰
   - é»˜è®¤å‚æ•°ï¼šé€Ÿåº¦ã€ç‚¹å‡»è·ç¦»ã€é™ä½ç­‰
   - Y2ç”µæœºé»˜è®¤ç¦ç”¨ï¼ˆ`isEnable=0`ï¼‰

### äºŒã€è¿ç§»åˆ°è“ç‰™ç›’å­çš„æ€è·¯

1. **æ•°æ®å­˜å‚¨è½¬ç§»**ï¼š
   - ç”µæœºåŸºç¡€é…ç½®å­˜å‚¨åœ¨è“ç‰™ç›’å­ä¸­
   - è¡Œè½¦æ§åˆ¶è½¯ä»¶å¯åŠ¨æ—¶ä»è“ç‰™ç›’å­è·å–é…ç½®
   - å…¶ä»–ä¿¡æ¯ï¼ˆç”¨æˆ·ã€ç³»ç»Ÿè®¾ç½®ï¼‰ä»ä¿å­˜åœ¨æœ¬åœ°æ•°æ®åº“
2. **é€šä¿¡åè®®è®¾è®¡**ï¼š
   - å®šä¹‰è·å–ç”µæœºé…ç½®çš„è“ç‰™é€šä¿¡å‘½ä»¤
   - å®šä¹‰ä¿®æ”¹ç”µæœºé…ç½®çš„è“ç‰™é€šä¿¡å‘½ä»¤
   - å®æ—¶åŒæ­¥é…ç½®å˜æ›´

### ä¸‰ã€éœ€è¦ä¿®æ”¹çš„å…³é”®å‡½æ•°

- `DbInit()` - æ”¹ä¸ºä»è“ç‰™ç›’å­è·å–é…ç½®
- `setSpeed()`, `setClickDist()`, `setMotorEnableState()`ç­‰ - æ”¹ä¸ºé€šè¿‡è“ç‰™ä¿®æ”¹
- å¢åŠ è“ç‰™é€šä¿¡æ¥å£å‡½æ•°

### å››ã€ç†è®ºä¸Šçš„è¿ç§»æ­¥éª¤

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šå®ç°é…ç½®è·å–æ¥å£
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šå®ç°é…ç½®ä¿®æ”¹æ¥å£
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šç§»é™¤æœ¬åœ°ç”µæœºé…ç½®è¡¨

å…·ä½“æ­¥éª¤ï¼š

1. å†™ä¸€ä¸ªdemoç¨‹åºï¼Œæµ‹è¯•`DbCtrl::DbInit(0)`èƒ½å¤Ÿåœ¨è“ç‰™ç›’å­ä¸Šåˆå§‹åŒ–ä¸€ä¸ªç¬¦åˆå½“å‰é¡¹ç›®çš„æ•°æ®åº“
2. æµ‹è¯•æ•°æ®åº“è¯»å†™å‡½æ•°ï¼Œæ£€éªŒæ˜¯å¦èƒ½æ­£å¸¸è¯»å†™æ•°æ®
3. æ›¿æ¢æœ¬åœ°ç”µæœºé…ç½®è¡¨

## æ§åˆ¶åˆ†ç»„

### ä¸€ã€å®ç°ç›®æ ‡

> è¡Œè½¦æ§åˆ¶åˆ’åˆ†åŠŸèƒ½ç»„ï¼Œæ¯ç»„éƒ½æœ‰å‰åå·¦å³æ—‹è½¬çš„æ§åˆ¶ï¼Œæ ¹æ®ç”µæœºé…ç½®æ‰“å¼€æˆ–è€…å…³é—­æŸä¸€ç§æ§åˆ¶ã€‚

å°±æ˜¯æœ€ç»ˆèƒ½å¤Ÿå®ç°é€‰æ‹©ç»„æ¥æ§åˆ¶ï¼š

1. é€‰æ‹©ç»„1ï¼Œåˆ™è°ƒç”¨ç»„1çš„æ•´å¥—ç”µæœº
2. é€‰æ‹©ç»„2ï¼Œåˆ™è°ƒç”¨ç»„2çš„æ•´å¥—ç”µæœº

æ¯ç»„éƒ½åŒ…å«ç›¸åŒåŠŸèƒ½çš„ç”µæœºï¼ˆä¸Šä¸‹ã€å‰è¿›åé€€ã€å·¦å³ã€æ—‹è½¬ç­‰ï¼‰ã€‚

### äºŒã€å½“å‰æ§åˆ¶ç°çŠ¶

å°±æ‹¿å½“å‰ç‚¹åŠ¨é€»è¾‘`actionJog()`è¿›è¡Œåˆ†æï¼Œçœ‹ä¸‹å½“å‰è¿›ç¨‹æ˜¯å¦‚ä½•æ§åˆ¶æŸä¸ªç‰¹å®šåŠŸèƒ½ç”µæœºè¿›è¡Œç§»åŠ¨çš„ï¼š

- è·å–å½“å‰è¦æ“ä½œçš„ç”µæœºå‹å·ï¼Œè°ƒç”¨äº†`getMotorID()`ã€‚

- `getMotorID()`ä¼šæ ¹æ®ç•Œé¢ä¸Šé€‰æ‹©çš„ç”µæœºï¼ˆæ˜¯æ—‹è½¬è¿˜æ˜¯å·¦å³ç§»åŠ¨çš„åŠŸèƒ½æ¥åŒºåˆ†çš„ç”µæœºï¼‰ï¼Œè·å–åˆ°å¯¹åº”æšä¸¾`E_MOTOR_ID`ä¸­å®šä¹‰çš„çš„ ID å·

  ```C++
  typedef enum {
      M_ALL=-1,
      M_X1 = 0,
      M_X2,
      M_Y1,
      M_Z1,
      M_Angle,
      M_Z2,
      M_Y2,
  
      M_end
  }E_MOTOR_ID;
  ```

- è·å–ç”µæœºé…ç½®ä¿¡æ¯ï¼šå¯¹åº”å½“å‰å®šä¹‰çš„`motorID`ï¼ŒåŒ¹é…æ•°æ®åº“ä¸­å”¯ä¸€`id`å¯¹åº”çš„ç”µæœºå‚æ•°ä¿¡æ¯ï¼ˆå½“å‰å°±æ˜¯`id = motorID`  ï¼‰ï¼š

  ```C++
  id, name, model, modbusID, linkStat, outsideDiameter, gearRatio, 
  screwPitch, minLimit, maxLimit, speed, clickDistance, currLocation,
  position, dir, isEnable
  ```

  è·å–ä¿¡æ¯çš„æ–¹æ³•ï¼š

  ```C++
  float screwPitch = DbCtrl::m_servoMotor_tb.at(motorID).screwPitch
  ```

- ä¼ºæœæ§åˆ¶modubsï¼šä¼ºæœæ§åˆ¶å™¨å¯¹åº”æ¯ä¸€ä¸ªç”µæœºéƒ½æœ‰å”¯ä¸€çš„`ModbusID`ï¼Œé€šè¿‡`motorID`ä¸ä¹‹ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œé…ç½®å¯¹åº”ä¼ºæœæ§åˆ¶å™¨çš„å¯„å­˜å™¨ã€‚

è¿™æ ·å°±å®ç°äº†æ ¹æ®ç•Œé¢é€‰ä¸­çš„ç”µæœºï¼Œæœ€ç»ˆèƒ½å¤Ÿæ§åˆ¶å¯¹åº”çš„æ•°æ®åº“é…ç½®ä»¥åŠä¼ºæœæ§åˆ¶å™¨ä½¿ä¹‹ç§»åŠ¨ã€‚

```bash
ç•Œé¢é€‰ä¸­ç”µæœº - è·å–ç”µæœºmotorID - é¢„å…ˆé…ç½®å¥½çš„æ•°æ®åº“ + é¢„å…ˆé…ç½®å¥½çš„modbusID
```

### ä¸‰ã€å®ç°æ€è·¯

å…¶å®æœ€ç»ˆå°±æ˜¯å®ç°ï¼Œé€‰æ‹©ç»„0çš„`M_Angle`æ—¶å€™ï¼Œå°±ä¼šé€šè¿‡æŸ¥è¯¢é…ç½®é¡¹çš„æ–¹å¼ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ•°æ®åº“`id`ä»¥åŠ`modbusID`ã€‚ç»„1äº¦ç„¶ã€‚

ç¬¼ç»Ÿæ€è·¯ï¼š

1. ç»´æŒ`E_MOTOR_ID`çš„åŠŸèƒ½é…ç½®ï¼Œçœç•¥å…¶å¯¹åº”çš„IDé…ç½®ã€‚ä¾‹å¦‚`M_Angle`å°±æ˜¯å•ç‹¬æ§åˆ¶æ—‹è½¬çš„ç”µæœºåŠŸèƒ½
2. åˆ†ç»„æ§åˆ¶éœ€è¦åŠ å…¥ä¸€ä¸ªæ ‡å¿—ä½ã€‚æ­¤æ ‡å¿—ä½è®°å½•äº†å½“å‰é€‰æ‹©çš„ç”µæœºç»„ã€‚ä¾‹å¦‚
   - `groupID = 0`ï¼šæ§åˆ¶ç»„0
   - `groupID = 1`ï¼šæ§åˆ¶ç»„1
3. è·å–æ•°æ®åº“ä¸»é”®`id`çš„æ–¹æ³•å°±ç”±`E_MOTOR_ID`åŠŸèƒ½é¡¹å’Œåˆ†ç»„æ ‡å¿—`groupID`å…±åŒå®ç°ã€‚
4. è·å–`modbusID`çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç”±`E_MOTOR_ID`åŠŸèƒ½é¡¹å’Œåˆ†ç»„æ ‡å¿—`groupID`å…±åŒå®ç°ã€‚
5. æŒ‰ç…§`motorID`å¯¹åº”çš„`modbusID`é…ç½®å³å¯ï¼ˆ`PA71 - modusID`èŒƒå›´æ˜¯1-254ï¼‰

ç°åœ¨å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼š

1. `motorID`ä¸æ•°æ®åº“ç”µæœºä¿¡æ¯ä¸»é”®`id`æ·±åº¦ç»‘å®š

   ä¾‹å¦‚è·å–æŸä¸ªç”µæœºçš„ä¸æ†èºè·ï¼š

   ```c++
   DbCtrl::m_servoMotor_tb.at(motorID).screwPitch
   ```

   é—®é¢˜ï¼šmotorIDç›´æ¥ä½œä¸ºæ•°æ®åº“ç´¢å¼•

2. `motorID`ä¸ç”µæœºçš„`modbusID`æ·±åº¦ç»‘å®š

   ä¾‹å¦‚å‘`modbusID`çš„ç”µæœºå†™æ•°æ®æ“ä½œï¼š

   ```C++
   MotorRegs::get_instance()->writeReg16(motorID, MotorRegs::H06_04, JOG_speed);
   ```

   é—®é¢˜ï¼šmotorIDç›´æ¥ä½œä¸ºModbusåœ°å€  

å¦‚ä½•è§£é™¤`motorID`ä¸æ•°æ®åº“ä¸»é”®`id`å’Œ`modbusID`çš„å¼ºç»‘å®šï¼Ÿé‚£å°±ä¸ç”¨è§£é™¤å•Šï¼Œç›´æ¥å†™æ­»å°±å®Œäº†ã€‚

## æ§åˆ¶åˆ†ç»„2

ç°åœ¨éœ€è¦é‡æ–°å®¡è§†ä¸‹è¿™ä¸ªåˆ†ç»„é—®é¢˜äº†ã€‚ä¹‹å‰è¯•å›¾è§£é™¤`motorID`çš„æ€è·¯è¿‡äºéº»çƒ¦ï¼Œç°åœ¨é‡æ–°æ¢³ç†ä¸‹æˆ‘æ‰€æƒ³å®ç°çš„æ–¹æ¡ˆã€‚

### ç†è®ºæ–¹æ¡ˆ

1. ä¿ç•™`E_MOTOR_ID`ä½œä¸ºåŠŸèƒ½æšä¸¾ï¼š

   - ä¿æŒå½“å‰æšä¸¾ç±»çš„ç‰¹æ€§ï¼šä½œä¸ºä¸€å¥—ç”µæœºä¸åŒåŠŸèƒ½åˆ’åˆ†

2. åˆ’åˆ†çœŸæ­£çš„`motorID`æšä¸¾ç»„ï¼Œä¾‹å¦‚èµ·åä¸º`MODBUS_ID`

   - ç¬¬ä¸€å¥—å°±æ˜¯`A_X1 = 1`ã€`A_X2 =2`ã€...ã€`A_Z2`å¯¹åº”çš„å°±æ˜¯ä¹‹å‰`E_MOTOR_ID`çš„`M_X1`ç­‰
   - ç¬¬äºŒå¥—å°±æ˜¯`B_X1 = 11`ç­‰ï¼Œä»£è¡¨ç¬¬äºŒå¥—`motorID`

3. è®¾ç½®`groupID`

   - ç•Œé¢åˆ›å»ºå¤é€‰æ¡†ï¼Œé€‰æ‹©å¯¹åº”çš„ç»„ï¼Œç›¸å½“äºè®¾ç½®äº†å¯¹åº”çš„`groupID`

4. å®ç°ç”µæœºåŠŸèƒ½é€‰æ‹©`E_MOTOR_ID`å’Œ`groupID`å…±åŒå†³å®šçš„`MODBUS_ID`çš„å‡½æ•°

   - ç”¨æˆ·é€‰æ‹©äº†å¯¹åº”ç”µæœºç»„ä»¥åŠå¯¹åº”çš„ç”µæœºåï¼Œè°ƒç”¨æ­¤å‡½æ•°ä¼šè·å–åˆ°å¯¹åº”`MODBUS_ID`ä¸‹çš„`motorID`

     ä¾‹å¦‚å¯¹åº”å…³ç³»ä¸ºï¼š

     ```bash
     MODBUS_ID = groupID * 10 + E_MOTOR_ID
     ```

5. ä¿æŒç°åœ¨çš„æ•°æ®åº“è¯»å–ä»¥åŠä¼ºæœæ§åˆ¶å‡½æ•°çš„åŸå‹å³å¯ã€‚

6. æ•°æ®åº“åŠ å…¥æ–°çš„`MODBUS_ID`å¯¹åº”çš„ä¸»é”®ä»¥åŠå„é¡¹é…ç½®

7. é…ç½®ç¬¬äºŒå¥—ç”µæœºçš„`modbusID`ä¸º`MODBUS_ID`å®šä¹‰çš„ç¼–å·

æ‚¨çš„æ€è·¯æ›´æ¸…æ™°ä¸”æ›´å®ç”¨ï¼Œæˆ‘æ¥å¸®æ‚¨å®Œå–„è¿™ä¸ªæ–¹æ¡ˆã€‚è¿™ä¸ªæ–¹æ¡ˆç¡®å®æ›´ç®€æ´ï¼Œæ”¹åŠ¨é‡ä¹Ÿæ›´å°ã€‚

## ä¸€ã€ç†è®ºæ–¹æ¡ˆå®Œå–„

### 1. ä¿ç•™ç°æœ‰`E_MOTOR_ID`åŠŸèƒ½æšä¸¾
```cpp
typedef enum {
    M_ALL = -1,
    M_X1 = 0,      // å‰åç§»åŠ¨å·¦
    M_X2,          // å‰åç§»åŠ¨å³  
    M_Y1,          // å·¦å³ç§»åŠ¨ä¸Šè½´
    M_Z1,          // å‚ç›´ä¸Šä¸‹
    M_Angle,       // æ—‹è½¬
    M_Z2,          // å›ºå®šä½ä¸Šä¸‹
    M_Y2,          // å·¦å³ç§»åŠ¨ä¸‹è½´
    
    M_end
} E_MOTOR_ID;
```

### 2. å®šä¹‰æ–°çš„`MODBUS_ID`æšä¸¾ç»„
```cpp
// ç¬¬ä¸€å¥—ç”µæœºç»„ (ç»„0)
typedef enum {
    A_X1 = 1,      // Modbusåœ°å€1
    A_X2 = 2,      // Modbusåœ°å€2  
    A_Y1 = 3,      // Modbusåœ°å€3
    A_Z1 = 4,      // Modbusåœ°å€4
    A_Angle = 5,   // Modbusåœ°å€5
    A_Z2 = 6,      // Modbusåœ°å€6
    A_Y2 = 7,      // Modbusåœ°å€7
    
    GROUP_A_END
} MODBUS_ID_GROUP_A;

// ç¬¬äºŒå¥—ç”µæœºç»„ (ç»„1)  
typedef enum {
    B_X1 = 11,     // Modbusåœ°å€11
    B_X2 = 12,     // Modbusåœ°å€12
    B_Y1 = 13,     // Modbusåœ°å€13
    B_Z1 = 14,     // Modbusåœ°å€14
    B_Angle = 15,  // Modbusåœ°å€15
    B_Z2 = 16,     // Modbusåœ°å€16
    B_Y2 = 17,     // Modbusåœ°å€17
    
    GROUP_B_END
} MODBUS_ID_GROUP_B;
```

### 3. åˆ†ç»„æ˜ å°„å‡½æ•°
```cpp
class GroupManager {
private:
    static int m_current_group; // 0=ç»„A, 1=ç»„B
    
public:
    static void setCurrentGroup(int group_id) {
        m_current_group = group_id;
    }
    
    static int getCurrentGroup() {
        return m_current_group;
    }
    
    // æ ¸å¿ƒæ˜ å°„å‡½æ•°ï¼šæ ¹æ®åŠŸèƒ½+ç»„å· -> MODBUS_ID
    static int getModbusID(E_MOTOR_ID motor_func) {
        if (m_current_group == 0) {
            // ç»„Aæ˜ å°„
            switch(motor_func) {
                case M_X1: return A_X1;
                case M_X2: return A_X2;
                case M_Y1: return A_Y1;
                case M_Z1: return A_Z1;
                case M_Angle: return A_Angle;
                case M_Z2: return A_Z2;
                case M_Y2: return A_Y2;
                default: return -1;
            }
        } else {
            // ç»„Bæ˜ å°„  
            switch(motor_func) {
                case M_X1: return B_X1;
                case M_X2: return B_X2;
                case M_Y1: return B_Y1;
                case M_Z1: return B_Z1;
                case M_Angle: return B_Angle;
                case M_Z2: return B_Z2;
                case M_Y2: return B_Y2;
                default: return -1;
            }
        }
    }
    
    // åå‘æ˜ å°„ï¼šMODBUS_ID -> æ•°æ®åº“ä¸»é”®id
    static int getDbId(int modbus_id) {
        // è¿™é‡Œéœ€è¦æ ¹æ®æ‚¨çš„æ•°æ®åº“è®¾è®¡æ¥æ˜ å°„
        // å‡è®¾æ•°æ®åº“ä¸»é”®idä¸MODBUS_IDæœ‰å¯¹åº”å…³ç³»
        return modbus_id; // æˆ–è€…é€šè¿‡æŸ¥æ‰¾è¡¨
    }
};
```

## äºŒã€æ•°æ®åº“è®¾è®¡ä¿®æ”¹

### 1. æ‰©å±•æ•°æ®åº“è¡¨ç»“æ„
```sql
-- ä¿æŒç°æœ‰è¡¨ç»“æ„ï¼Œä½†éœ€è¦ä¸ºç¬¬äºŒç»„ç”µæœºæ·»åŠ è®°å½•
-- ç°æœ‰è®°å½•å¯¹åº”ç»„A (modbusID 1-7)
-- æ–°å¢è®°å½•å¯¹åº”ç»„B (modbusID 11-17)

-- ä¸ºç»„Bæ’å…¥ç”µæœºé…ç½®è®°å½•
INSERT INTO servoMotor_tb (name, model, modbusID, linkStat, outsideDiameter, 
                          gearRatio, screwPitch, minLimit, maxLimit, speed, 
                          clickDistance, currLocation, position, dir, isEnable)
SELECT 
    -- åç§°å¯ä»¥åŠ åç¼€åŒºåˆ†
    name || '_B' as name, 
    model,
    -- Modbusåœ°å€+10
    modbusID + 10 as modbusID,
    linkStat,
    outsideDiameter,
    gearRatio, 
    screwPitch,
    minLimit,
    maxLimit,
    speed,
    clickDistance,
    currLocation,
    position,
    dir,
    isEnable
FROM servoMotor_tb 
WHERE modbusID BETWEEN 1 AND 7;
```

## ä¸‰ã€ä»£ç ä¿®æ”¹æ–¹æ¡ˆ

### 1. ä¿®æ”¹ç‚¹åŠ¨æ§åˆ¶å‡½æ•°
```cpp
void actionJog(E_MOTOR_ID motor_func, JogDirection dir) {
    // 1. è·å–å½“å‰ç»„çš„MODBUS_ID
    int modbus_id = GroupManager::getModbusID(motor_func);
    
    // 2. æ ¹æ®MODBUS_IDè·å–æ•°æ®åº“ä¸»é”®id
    int db_id = GroupManager::getDbId(modbus_id);
    
    // 3. è·å–ç”µæœºé…ç½®ï¼ˆä¿æŒç°æœ‰é€»è¾‘ï¼Œä½†ä½¿ç”¨æ–°çš„db_idï¼‰
    // è¿™é‡Œéœ€è¦ä¿®æ”¹DbCtrlçš„æ¥å£ï¼Œæ”¯æŒé€šè¿‡db_idè·å–é…ç½®
    T_servoMotor_tb motor_config = DbCtrl::getMotorConfigById(db_id);
    
    // 4. ä½¿ç”¨é…ç½®å‚æ•°
    float screwPitch = motor_config.screwPitch;
    float speed = motor_config.speed;
    
    // 5. Modbusé€šä¿¡ï¼ˆä½¿ç”¨æ–°çš„modbus_idï¼‰
    MotorRegs::get_instance()->writeReg16(modbus_id, MotorRegs::H06_04, JOG_speed);
    
    // 6. å…¶ä»–åŸæœ‰é€»è¾‘...
}
```

### 2. ä¿®æ”¹æ•°æ®åº“è®¿é—®æ¥å£
```cpp
// åœ¨DbCtrlç±»ä¸­æ·»åŠ æ–°æ–¹æ³•
class DbCtrl {
public:
    // æ–°å¢ï¼šæ ¹æ®æ•°æ®åº“ä¸»é”®idè·å–ç”µæœºé…ç½®
    static T_servoMotor_tb getMotorConfigById(int db_id) {
        for (const auto& motor : m_servoMotor_tb) {
            if (motor.id == db_id) {
                return motor;
            }
        }
        return T_servoMotor_tb(); // è¿”å›ç©ºé…ç½®
    }
    
    // ä¿æŒåŸæœ‰çš„é€šè¿‡ç´¢å¼•è®¿é—®çš„æ–¹æ³•ï¼ˆå‘åå…¼å®¹ï¼‰
    static T_servoMotor_tb getMotorConfigByIndex(int index) {
        if (index >= 0 && index < m_servoMotor_tb.size()) {
            return m_servoMotor_tb.at(index);
        }
        return T_servoMotor_tb();
    }
};
```

### 3. ç•Œé¢ç»„é€‰æ‹©å®ç°
```cpp
// åœ¨ä¸»ç•Œé¢æ·»åŠ ç»„é€‰æ‹©æ§ä»¶
QComboBox* group_combo = new QComboBox();
group_combo->addItem("ç»„A", 0);
group_combo->addItem("ç»„B", 1);

// ç»„åˆ‡æ¢ä¿¡å·
connect(group_combo, QOverload<int>::of(&QComboBox::currentIndexChanged), 
        [this](int index) {
    int group_id = group_combo->itemData(index).toInt();
    GroupManager::setCurrentGroup(group_id);
    // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°ç•Œé¢çŠ¶æ€
    updateUIForCurrentGroup();
});
```

## å››ã€å…·ä½“å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šæ•°æ®åº“å‡†å¤‡
1. æ‰§è¡ŒSQLè„šæœ¬ï¼Œä¸ºç»„Bæ’å…¥ç”µæœºé…ç½®è®°å½•
2. éªŒè¯ä¸¤ç»„æ•°æ®éƒ½æ­£ç¡®å¯¼å…¥

### é˜¶æ®µ2ï¼šæ ¸å¿ƒä»£ç ä¿®æ”¹
1. å®ç°`GroupManager`ç±»
2. åœ¨`DbCtrl`ä¸­æ·»åŠ `getMotorConfigById`æ–¹æ³•
3. ä¿®æ”¹`actionJog`ç­‰æ ¸å¿ƒæ§åˆ¶å‡½æ•°

### é˜¶æ®µ3ï¼šç•Œé¢ä¿®æ”¹
1. æ·»åŠ ç»„é€‰æ‹©æ§ä»¶
2. è¿æ¥ç»„åˆ‡æ¢ä¿¡å·

### é˜¶æ®µ4ï¼šæµ‹è¯•éªŒè¯
1. æµ‹è¯•ç»„AåŠŸèƒ½æ˜¯å¦æ­£å¸¸
2. æµ‹è¯•ç»„BåŠŸèƒ½æ˜¯å¦æ­£å¸¸
3. æµ‹è¯•ç»„åˆ‡æ¢æ˜¯å¦æµç•…

## äº”ã€ä¼˜åŠ¿åˆ†æ

è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜åŠ¿ï¼š

1. **æ”¹åŠ¨é‡å°**ï¼šä¿æŒç°æœ‰`E_MOTOR_ID`æšä¸¾ï¼Œä¸éœ€è¦å¤§è§„æ¨¡é‡æ„
2. **é€»è¾‘æ¸…æ™°**ï¼š`åŠŸèƒ½ + ç»„å· -> MODBUS_ID`çš„æ˜ å°„å…³ç³»æ˜ç¡®
3. **æ•°æ®åº“å…¼å®¹**ï¼šé€šè¿‡æ’å…¥æ–°è®°å½•æ”¯æŒç¬¬äºŒç»„ï¼Œä¸å½±å“ç°æœ‰æ•°æ®
4. **æ˜“äºæ‰©å±•**ï¼šå¦‚æœéœ€è¦ç¬¬ä¸‰ç»„ï¼Œåªéœ€å®šä¹‰`MODBUS_ID_GROUP_C`å¹¶æ’å…¥æ•°æ®
5. **é£é™©å¯æ§**ï¼šå¯ä»¥åˆ†é˜¶æ®µå®æ–½ï¼Œé€æ­¥éªŒè¯

## å…­ã€æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“ä¸»é”®**ï¼šç¡®ä¿`servoMotor_tb`çš„`id`å­—æ®µèƒ½å¤Ÿå®¹çº³æ–°çš„MODBUS_IDå€¼
2. **Modbusåœ°å€å†²çª**ï¼šç¡®ä¿ä¸¤ç»„ç”µæœºçš„Modbusåœ°å€ä¸å†²çª
3. **åˆå§‹åŒ–é¡ºåº**ï¼šç¡®ä¿`GroupManager`åœ¨æ§åˆ¶å‡½æ•°è°ƒç”¨å‰å·²åˆå§‹åŒ–
4. **é”™è¯¯å¤„ç†**ï¼šåœ¨æ˜ å°„å‡½æ•°ä¸­æ·»åŠ é”™è¯¯æ£€æŸ¥ï¼Œè¿”å›æ— æ•ˆå€¼æ—¶ç»™å‡ºæ˜ç¡®æç¤º

è¿™ä¸ªæ–¹æ¡ˆæ—¢æ»¡è¶³äº†åˆ†ç»„æ§åˆ¶çš„éœ€æ±‚ï¼Œåˆæœ€å¤§é™åº¦åœ°å‡å°‘äº†ä»£ç ä¿®æ”¹é‡ï¼Œæ˜¯ä¸€ä¸ªåŠ¡å®ä¸”å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚

ä½†æ˜¯è¿™ä¸ªé—®é¢˜å¼•å‡ºçš„å¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼šå¹¿æ’­å¦‚ä½•å¤„ç†ï¼Ÿ

# 10.31

## å¹¿æ’­é—®é¢˜æ€è€ƒ

å…ˆæŒ‰ä¸‹ä¸è°ˆï¼Œå…ˆä¼˜å…ˆè€ƒè™‘ä¸‹å¦‚ä½•å®ç°

## æ§åˆ¶åˆ†ç»„3

ç°åœ¨ç»è¿‡æµç¨‹å›¾æ¢³ç†ï¼Œå¤§ä½“å°†æ§åˆ¶åˆ†ç»„ä»»åŠ¡åˆ†ä¸ºäº†å‡ ä¸ªå­ä»»åŠ¡ï¼š

1. `servo`è¿›ç¨‹åˆå§‹åŒ–åˆ†ç»„è¡¨
   - åˆ†ç»„è¡¨è®°å½•äº†å½“å‰æ§åˆ¶å™¨èƒ½å¤Ÿæ§åˆ¶çš„ç”µæœºç»„ï¼šä»…ä¿å­˜ä¸€ä¸ªæ”¯æŒçš„æ•°ç»„å³å¯
   - ç”µæœºç»„0ã€1è¡¨ç¤ºæ­£å¸¸çš„å‰åä¸¤å¥—å®Œæ•´ç”µæœºç»„ï¼›ç”µæœºç»„2è¡¨ç¤ºé©»æ³¢ç®¡ç”µæœºç»„
2. è·å–åˆ†ç»„ä¿¡æ¯
   - `MotorCtrl`ç¤ºä¾‹åŒ–çš„æ—¶å€™ï¼Œè·å–åˆ°æ•°æ®åº“çš„åˆ†ç»„ä¿¡æ¯åˆ—è¡¨`m_supported_motor_groups`
   - æ§åˆ¶ç»„idï¼šä»¥æ•°ç»„`m_supported_motor_groups`ä¸­çš„ç¬¬ä¸€ä¸ªç»„å·ä½œä¸ºé»˜è®¤æ§åˆ¶ç»„å·`group_id`
3. ç”µæœºå±•ç¤ºç•Œé¢çš„åˆ†ç»„å±•ç¤ºé€»è¾‘
   - å¤é€‰æ¡†å±•ç¤ºç»„åï¼šä¸‹æ–¹å¤é€‰æ¡†å±•ç¤ºå½“å‰ç”µæœºç»„`group_id`çš„åç§°
   - ç•Œé¢æŒ‰éœ€å±è”½å’Œå±•ç¤ºï¼ˆéš¾ç‚¹ï¼šåé¢æ€è€ƒå¦‚ä½•åˆç†åœ°å±è”½æŒ‰é’®ä»¥åŠå¯¹åº”çš„æ§½å‡½æ•°è¿æ¥ï¼‰
4. è·å–å½“å‰ç”µæœºIDï¼ˆ`getMotorID`ï¼‰
   - åŠ å…¥æ ¹æ®å½“å‰é€‰ä¸­çš„ç”µæœºåŠŸèƒ½ID`E_MOTOR_ID`å’Œåˆ†ç»„ID`group_id`æ¥ç¡®è®¤å¯¹åº”modbus_idçš„å‡½æ•°
   - å…¶ä½™è¯»å†™æ•°æ®åº“ä»¥åŠè¯»å†™ä¼ºæœæ§åˆ¶å™¨é€»è¾‘ä¸å˜

å‰©ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

- å¹¿æ’­é—®é¢˜
- é©»æ³¢ç®¡å±•ç¤ºé—®é¢˜

éœ€è¦è¿›ä¸€æ­¥ç†è§£ä»£ç é€»è¾‘åï¼Œå†åˆ†æã€‚

## åˆ†ç»„è¡¨çš„æ•°æ®åº“è®¾è®¡

### éœ€æ±‚

1. ä¿®æ”¹ `sysInfo_tb` è¡¨ç»“æ„ï¼šä»¥`list`çš„å½¢å¼å­˜å‚¨åœ¨ç”¨æˆ·è¡¨`sysInfo_tb`ä¸­åŠ å…¥ç»„åˆ—è¡¨å­—æ®µ`supportedGroups`ï¼Œè®°å½•å½“å‰å¤–è®¾æ”¯æŒçš„ç”µæœºç»„
2. æ‰©å±• `servoMotor_tb` è¡¨æ•°æ®ï¼šåœ¨è¡¨`servoMotor_tb `ä¸­ï¼ŒåŠ å…¥åˆ†ç»„1ã€2çš„æ‰€æœ‰ç”µæœºidï¼ˆä¹Ÿæ˜¯mobusIDå’Œä¸»é”®idï¼‰ä»¥åŠé…ç½®é¡¹

### å®ç°æ–¹æ³•

å½“å‰`sysInfo_tb`è¡¨çš„ç»“æ„ä¸ºï¼š

```sql
CREATE TABLE sysInfo_tb (mode INTEGER, screenTime INTEGER, xMode INTEGER, targetLength INTEGER, targetWidth INTEGER, targetHeight INTEGER, portName VARCHAR, baudRate INTEGER, dataBits INTEGER,flowContrl INTEGER, parity INTEGER, stopBits INTEGER, useBt INTEGER, BtMAC VARCHAR)
```

å¯¹äºæ‹“å±•`servoMotor_tb`ä¸­çš„æ•°æ®ï¼š

- åˆ†ç»„0çš„ç”µæœºidä¾æ—§ä»1-7ï¼Œä½†æ˜¯éœ€è¦å°†`name`å­—æ®µåŠ ä¸Šå‰ç¼€`A_`ã€‚ä¾‹å¦‚`X1`æ”¹ä¸º`A_X1`
- åˆ†ç»„1çš„ç”µæœºidä»11å¼€å§‹ï¼Œåˆ°16ç»“æŸï¼ˆåŒ…å«6ä¸ªç”µæœºï¼‰ã€‚ç”µæœºæ•´ä½“é…ç½®å¦‚ç»„0ã€‚ä¸”å‰ç¼€ä¸º`B_`
- åˆ†ç»„2çš„ç”µæœºdä»21å¼€å§‹ï¼Œåˆ°22ç»“æŸï¼ˆåŒ…å«2ä¸ªç”µæœºï¼‰åç§°ç‰¹å®šä¸º`C_Z1`ä¸`C_Î¸`ï¼Œä¸”å…¶é…ç½®ä¸ç»„0ã€1çš„Z1å’ŒÎ¸åç§°çš„ç”µæœºé…ç½®ç›¸åŒ

ç°åœ¨å°±æ˜¯éœ€è¦ä¿®æ”¹`dbctrl.cpp`ä¸­åˆå§‹åŒ–æ•°æ®åº“çš„é€»è¾‘ï¼Œä½¿ä¹‹é€‚åº”ä»¥ä¸Šä¿®æ”¹ã€‚

