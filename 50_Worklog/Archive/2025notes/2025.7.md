# 7.1

ä»Šå¤©ç»§ç»­è“ç‰™è®¾å¤‡çš„é—®é¢˜ã€‚

ç°åœ¨å·²ç»çŸ¥é“çš„æ˜¯ï¼Œ6ä¸ªç”µæœºçš„ä¼ºæœæ§åˆ¶å™¨ï¼Œè¢«ä¸€ä¸ªç»Ÿä¸€çš„è“ç‰™è®¾å¤‡æ‰€ç®¡æ§ã€‚æ‰€ä»¥è¿æ¥æŸä¸ªç”µæœºä¼ºæœçš„æµç¨‹ä¸ºï¼š

```bash
å®‰å“æ§åˆ¶å™¨ -> ç»Ÿä¸€è“ç‰™è®¾å¤‡ -> ä¼ºæœæ§åˆ¶å™¨
```

æœ€ç»ˆè¦å®ç°çš„åŠŸèƒ½å°±æ˜¯ï¼š

1. ç•Œé¢å±•ç¤ºè“ç‰™çŠ¶æ€å›¾æ ‡ï¼Œåˆ†åˆ«ä»£è¡¨å·²è¿æ¥ã€æœªè¿æ¥å’Œæ­£åœ¨è¿æ¥ä¸­
2. ç”¨æˆ·ç‚¹å‡»è“ç‰™å›¾æ ‡ï¼Œè‡ªåŠ¨è¿›å…¥æœç´¢è“ç‰™ä¿¡å·çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å¼¹çª—å±•ç¤ºæ‰«åˆ°çš„ç›®æ ‡è“ç‰™è®¾å¤‡
3. é€‰ä¸­è“ç‰™è®¾å¤‡ï¼Œè¿›è¡Œå„ä¸ªç”µæœºçš„æ‰«æï¼Œè·å–ç”µæœºçš„è¿æ¥æƒ…å†µã€‚

ç°åœ¨ä»å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼š

- PADè“ç‰™è¿æ¥æ¨¡å¼ï¼Œå¦‚æœæ•°æ®åº“ä¸­ä¸å­˜åœ¨`portName`ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„é€šè®¯æµ‹è¯•åŠŸèƒ½å°±ä¼šæœ‰å¼‚å¸¸ï¼š
  - ç‚¹å‡»æ‰«æåï¼Œæ‰«æé€Ÿåº¦å¾ˆæ…¢
  - æ‰«æçš„ç»“æœæ˜¯ï¼Œä¸€å¼‚å¸¸ä¸€æ­£å¸¸ï¼Œæ— ä¸€ä¾‹å¤–ã€‚

## æ— portNameçš„é€šè®¯æµ‹è¯•

### é€šè®¯æµ‹è¯•

é¦–å…ˆè§‚å¯Ÿç°è±¡ï¼Œç„¶åæ£€æŸ¥ä»£ç ã€‚

ç™»å½•ç•Œé¢åï¼Œéšåå…³é—­æ‰å‡ ä¸ªå¼¹çª—åï¼Œè¿›å…¥è®¾ç½®ç•Œé¢ï¼Œç‚¹å‡»`é€šè®¯æµ‹è¯•`ï¼Œæ­¤æ—¶æ—¥å¿—è®°å½•ä¸º

```bash
INFO  2025-07-01T09:56:30.861 ============== æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ– ============== 
INFO  2025-07-01T09:56:30.861 Qt ç‰ˆæœ¬: 5.14.2 
INFO  2025-07-01T09:56:30.949 UDP server ip( "127.0.0.1" ) port( 62000 ) 
INFO  2025-07-01T09:56:31.834 ">>>>>>>å‘ç°ç›®æ ‡è“ç‰™è®¾å¤‡MOTOR06ae--A0:DD:6C:02:06:AE<<<<<<<" 
INFO  2025-07-01T09:56:31.834 "å‘ç°æŒ‡å®šè®¾å¤‡ 'MOTOR06ae'ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥..." 
INFO  2025-07-01T09:56:31.835 è“ç‰™å‘ç°å·²åœæ­¢ï¼Œå‡†å¤‡è¿æ¥ã€‚ 
INFO  2025-07-01T09:56:32.837 "è“ç‰™è®¾å¤‡[]è¿æ¥æˆåŠŸ!" 
INFO  2025-07-01T09:56:32.837 "è¿æ¥æˆåŠŸå Socket çŠ¶æ€: 3 (é”™è¯¯ç : -2, é”™è¯¯ä¿¡æ¯: )" 
INFO  2025-07-01T09:56:32.850 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
INFO  2025-07-01T09:58:12.798 "è“ç‰™MOTOR06aeè¿æ¥å…³é—­" 

// ä¸»ç•Œé¢
INFO  2025-07-01T09:58:12.798 "getLocation: ç”µæœº[X1]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º(0)pulse" 
INFO  2025-07-01T09:58:12.798 "getLocation: ç”µæœº[X1]å½“å‰ä½ç½®ä¸º (0) mm " 
INFO  2025-07-01T09:58:12.798 "getLocation: ç”µæœº[X2]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º(0)pulse" 
INFO  2025-07-01T09:58:12.798 "getLocation: ç”µæœº[X2]å½“å‰ä½ç½®ä¸º (0) mm " 
ERROR 2025-07-01T09:58:12.798 "ç”µæœºX1è¯»å–ç‚¹åŠ¨é€Ÿåº¦å¤±è´¥" 
ERROR 2025-07-01T09:58:14.377 "ç”µæœºX1è¯»å–é€Ÿåº¦å¤±è´¥" 
INFO  2025-07-01T09:58:14.635 "ç”µæœº[X1]è½¬é€Ÿä¸º(0)mm/s" 
INFO  2025-07-01T09:58:14.664 ç”¨æˆ·- "1" -ç™»å½•æˆåŠŸ 
INFO  2025-07-01T09:58:15.689 "ç”µæœº [Y2] æœªé…ç½®ç”Ÿæ•ˆ" 
INFO  2025-07-01T09:58:15.689 "getLocation: ç”µæœº[Y1]å½“å‰çš„ç»å¯¹ä½ç½®è„‰å†²æ•°ä¸º(0)pulse" 
INFO  2025-07-01T09:58:15.689 "getLocation: ç”µæœº[Y1]å½“å‰ä½ç½®ä¸º (0) mm " 
ERROR 2025-07-01T09:58:15.689 "ç”µæœºY1è¯»å–ç‚¹åŠ¨é€Ÿåº¦å¤±è´¥" 
ERROR 2025-07-01T09:58:16.136 "ç”µæœºY1è¯»å–é€Ÿåº¦å¤±è´¥" 
INFO  2025-07-01T09:58:16.277 "ç”µæœº[Y1]è½¬é€Ÿä¸º(0)mm/s" 

// è¿›å…¥è®¾ç½®ç•Œé¢
INFO  2025-07-01T09:58:18.674 MotorCtrl: è®¤è¯æˆåŠŸï¼Œå‡†å¤‡è¿›å…¥è®¾ç½®é¡µé¢ï¼Œæ‘‡æ†å†æ¬¡ç¡®ä¿ç¦ç”¨ã€‚ 

// ç‚¹å‡»é€šè®¯æµ‹è¯•
INFO  2025-07-01T09:58:23.097 "BaseConfigï¼šä¸è“ç‰™è®¾å¤‡[MOTOR06ae]çš„é€šè®¯è¿æ¥æµ‹è¯•å¼€å§‹...." 
INFO  2025-07-01T09:58:24.178 "è“ç‰™è®¾å¤‡[]è¿æ¥æˆåŠŸ!" 
INFO  2025-07-01T09:58:24.178 "è¿æ¥æˆåŠŸå Socket çŠ¶æ€: 3 (é”™è¯¯ç : -2, é”™è¯¯ä¿¡æ¯: )" 
INFO  2025-07-01T09:58:24.178 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
INFO  2025-07-01T09:58:24.178 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]å·²ç»è¿æ¥ï¼Œå¼€å§‹æµ‹è¯•å„ç”µæœºçš„è¿é€šæ€§..." 
INFO  2025-07-01T09:58:24.179 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[0]" 
INFO  2025-07-01T09:58:24.180 "è“ç‰™MOTOR06aeè¿æ¥å…³é—­" 
ERROR 2025-07-01T09:58:24.180 "æ•æ‰é”™è¯¯ï¼ŒERRORCODE=19" 
ERROR 2025-07-01T09:58:27.334 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡å¤±è´¥." 
INFO  2025-07-01T09:58:27.335 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[1]" 
INFO  2025-07-01T09:58:27.445 "è“ç‰™è®¾å¤‡[]è¿æ¥æˆåŠŸ!" 
INFO  2025-07-01T09:58:27.445 "è¿æ¥æˆåŠŸå Socket çŠ¶æ€: 3 (é”™è¯¯ç : 19, é”™è¯¯ä¿¡æ¯: Trying to connect while connection is in progress)" 
INFO  2025-07-01T09:58:27.445 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
ERROR 2025-07-01T09:58:27.922 "è“ç‰™è¯»è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†æœªæ”¶åˆ°å›åº”" 
INFO  2025-07-01T09:58:27.923 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[2]" 
INFO  2025-07-01T09:58:27.923 "è“ç‰™MOTOR06aeè¿æ¥å…³é—­" 
ERROR 2025-07-01T09:58:27.924 "æ•æ‰é”™è¯¯ï¼ŒERRORCODE=19" 
ERROR 2025-07-01T09:58:30.922 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡å¤±è´¥." 
INFO  2025-07-01T09:58:30.923 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[3]" 
INFO  2025-07-01T09:58:31.150 "è“ç‰™è®¾å¤‡[]è¿æ¥æˆåŠŸ!" 
INFO  2025-07-01T09:58:31.150 "è¿æ¥æˆåŠŸå Socket çŠ¶æ€: 3 (é”™è¯¯ç : 19, é”™è¯¯ä¿¡æ¯: Trying to connect while connection is in progress)" 
INFO  2025-07-01T09:58:31.150 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
ERROR 2025-07-01T09:58:31.627 "è“ç‰™è¯»è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†æœªæ”¶åˆ°å›åº”" 
INFO  2025-07-01T09:58:31.628 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[4]" 
INFO  2025-07-01T09:58:31.628 "è“ç‰™MOTOR06aeè¿æ¥å…³é—­" 
ERROR 2025-07-01T09:58:31.629 "æ•æ‰é”™è¯¯ï¼ŒERRORCODE=19" 
ERROR 2025-07-01T09:58:34.482 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡å¤±è´¥." 
INFO  2025-07-01T09:58:34.483 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[5]" 
INFO  2025-07-01T09:58:34.591 "è“ç‰™è®¾å¤‡[]è¿æ¥æˆåŠŸ!" 
INFO  2025-07-01T09:58:34.591 "è¿æ¥æˆåŠŸå Socket çŠ¶æ€: 3 (é”™è¯¯ç : 19, é”™è¯¯ä¿¡æ¯: Trying to connect while connection is in progress)" 
INFO  2025-07-01T09:58:34.591 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
ERROR 2025-07-01T09:58:35.067 "è“ç‰™è¯»è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†æœªæ”¶åˆ°å›åº”" 
INFO  2025-07-01T09:58:35.068 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[6]" 
INFO  2025-07-01T09:58:35.068 "è“ç‰™MOTOR06aeè¿æ¥å…³é—­" 
ERROR 2025-07-01T09:58:35.069 "æ•æ‰é”™è¯¯ï¼ŒERRORCODE=19" 
ERROR 2025-07-01T09:58:37.922 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡å¤±è´¥." 
```

é—®é¢˜è®°å½•ï¼š

- ç‚¹å‡»é€šè®¯æµ‹è¯•ï¼Œä½†æ˜¯ä¸ºå•¥å…ˆæç¤ºäº†ç©ºè®¾å¤‡è¿æ¥æˆåŠŸï¼Ÿ

  ```BASH
  INFO  2025-07-01T09:58:23.097 "BaseConfigï¼šä¸è“ç‰™è®¾å¤‡[MOTOR06ae]çš„é€šè®¯è¿æ¥æµ‹è¯•å¼€å§‹...." 
  INFO  2025-07-01T09:58:24.178 "è“ç‰™è®¾å¤‡[]è¿æ¥æˆåŠŸ!" 
  ```

- è¿æ¥æˆåŠŸæ˜¯å“ªä¸ªè¿æ¥æˆåŠŸçš„ï¼Ÿ

  ```bash
  NFO  2025-07-01T09:58:24.178 "è“ç‰™è®¾å¤‡[]è¿æ¥æˆåŠŸ!" 
  INFO  2025-07-01T09:58:24.178 "è¿æ¥æˆåŠŸå Socket çŠ¶æ€: 3 (é”™è¯¯ç : -2, é”™è¯¯ä¿¡æ¯: )" 
  INFO  2025-07-01T09:58:24.178 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
  ```

  å¾ˆæ˜æ˜¾è¿™é‡Œæœ‰ä¸¤ä¸ªè¿æ¥æˆåŠŸï¼Œæ‰€ä»¥è¿™ä¸ªçŠ¶æ€æ˜¯å“ªä¸ªè¿æ¥çš„å‘¢ï¼Ÿ

  ```CPP
  void ModbusBt::onConnected();
  ```

  é€šè¿‡æ­¤å‡½æ•°ï¼Œå¯ä»¥å¾—çŸ¥æ˜¯ç©ºè®¾å¤‡è¿æ¥æˆåŠŸäº†ã€‚æ€ä¹ˆä¼šè®©ç©ºè®¾å¤‡è¿æ¥æˆåŠŸå‘¢ï¼Ÿ

```C++
// æ„é€ å‡½æ•°
m_connect_test_bt = new QPushButton(this);
m_connect_test_bt->setText(tr("é€šè®¯æµ‹è¯•"));
m_connect_test_bt->setObjectName("connect_test_bt");
connect(m_connect_test_bt, &QPushButton::clicked, this, &BaseConfig::on_connect_test_clicked);

// å‡½æ•°å®šä¹‰
void BaseConfig::on_connect_test_clicked()
{
    m_tView->setColumnHidden(m_tModel->fieldIndex(("linkStat")), false);
    QString portName =  m_com_cb->currentText();
    QLOG_INFO() << QString("BaseConfigï¼šä¸è“ç‰™è®¾å¤‡[%1]çš„é€šè®¯è¿æ¥æµ‹è¯•å¼€å§‹....").arg(portName);
    if(MotorRegs::get_instance()->testConnection(portName)){
        QLOG_INFO() << QString("BaseConfigï¼šè“ç‰™è®¾å¤‡[%1]å·²ç»è¿æ¥ï¼Œå¼€å§‹æµ‹è¯•å„ç”µæœºçš„è¿é€šæ€§...").arg(portName);
        for(int i=0; i<m_tModel->rowCount(); i++){
            QSqlRecord rc = m_tModel->record(i);
            rc.setValue("linkStat", "--");
            m_tModel->setRecord(i, rc);
        }
        for(int i=0; i<m_tModel->rowCount(); i++){
            QSqlRecord rc = m_tModel->record(i);
            QLOG_INFO() << QString("BaseConfigï¼šè“ç‰™è®¾å¤‡[%1]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[%2]").arg(portName).arg(i);
            if(MotorStatus::getLinkStat(portName, i)){
                rc.setValue("linkStat", tr("åœ¨æœ"));
            }else{
                rc.setValue("linkStat", tr("å¼‚å¸¸"));
            }
            m_tModel->setRecord(i, rc);
        }
    }else{
        SMessageBox::sQdialogBoxOk(m_parent, QMessageBox::Critical, tr("æ‰“å¼€è®¾å¤‡å¤±è´¥!è¯·é€‰æ‹©è®¾å¤‡åé‡è¯•ï¼"));
    }

}


```

- `QComboBox *m_com_cb`ï¼šæ˜¯ä¸€ä¸ªä¸“é—¨å±•ç¤ºå½“å‰å·²ç»è¿æ¥çš„è“ç‰™è®¾å¤‡ã€‚å‰ç¼€æ˜¯`MOTOR`ï¼Œä»£è¡¨ç»Ÿä¸€çš„ç”µæœºè“ç‰™ç®¡ç†è®¾å¤‡

### ç©ºè®¾å¤‡è¿æ¥æˆåŠŸ

æ—¥å¿—ä¸­ï¼Œè¿›è¡Œæµ‹è¯•åå±…ç„¶æç¤ºç©ºè®¾å¤‡è¿æ¥æˆåŠŸï¼Œçœ‹ä¸‹å“ªé‡Œçš„é—®é¢˜ã€‚

```C++
QLOG_INFO() << QString("BaseConfigï¼šä¸è“ç‰™è®¾å¤‡[%1]çš„é€šè®¯è¿æ¥æµ‹è¯•å¼€å§‹....").arg(portName);	// MOTOR06ae
if(MotorRegs::get_instance()->testConnection(portName)){...}

// MotorRegs çš„å®ä¾‹åŒ–
static MotorRegs*get_instance(){
    if(m_instance == NULL){
        m_instance = new MotorRegs();
    }
    return m_instance;
}

// æ„é€ å‡½æ•°ä¸­å­˜åœ¨çš„é€»è¾‘
if(DbCtrl::m_systemInfo_tb.useBt){	// ä½¿ç”¨è“ç‰™
    m_modbusIO = ModbusBt::get_instance(this);
}

static ModbusBt*get_instance(QObject *parent = nullptr){
    if(m_instance == NULL){
        m_instance = new  ModbusBt(parent);
    }
    return m_instance;
}

ModbusBt::ModbusBt(QObject *parent) : ModbusIO(parent)
{
    m_currDev = QString(DbCtrl::m_systemInfo_tb.portName);;	// æ­¤æ—¶æ•°æ®åº“ä¸­çš„ç«¯å£å°±æ˜¯ç©ºçš„!ğŸ…
    m_isHold = true;
    m_linked = false;
    m_devices.clear();
    m_discoveryAgent = new QBluetoothDeviceDiscoveryAgent(this);
    m_socket = new QBluetoothSocket(QBluetoothServiceInfo::RfcommProtocol, this);
    connect(m_discoveryAgent, &QBluetoothDeviceDiscoveryAgent::deviceDiscovered, this, &ModbusBt::onDeviceDiscovered);
    connect(m_discoveryAgent, &QBluetoothDeviceDiscoveryAgent::finished, this, &ModbusBt::onScanFinished);

    connect(m_socket, &QBluetoothSocket::connected, this, &ModbusBt::onConnected);
    connect(m_socket, &QBluetoothSocket::disconnected, this, &ModbusBt::onClosed);
    connect(m_socket, QOverload<QBluetoothSocket::SocketError>::of(&QBluetoothSocket::error), this, &ModbusBt::onError);

    m_mutex = new QMutex();
}
```

æ‰€ä»¥å¯ä»¥å¾—çŸ¥ï¼Œåœ¨çœŸæ­£åœ°è°ƒç”¨`testConnection()`è¿›è¡Œæµ‹è¯•è¿æ¥ä¹‹å‰ï¼Œè®¾å¤‡å·²ç»å°è¯•è¿æ¥è¿‡ä¸€æ¬¡ç©ºè®¾å¤‡äº†ã€‚å¹¶ä¸”å±…ç„¶è¿æ¥æˆåŠŸï¼Ÿ

æ‰€ä»¥è¿™é‡Œçš„ä¿®æ”¹æ–¹æ¡ˆæ˜¯ï¼šåœ¨ `testConnection` ä¸­è®¾ç½®ç›®æ ‡è®¾å¤‡ã€‚

ä½†æ˜¯é—®é¢˜åœ¨äºï¼Œè¿™æ ·æ˜¯å¦éœ€è¦ä¿®æ”¹å…¶ä»–é€»è¾‘ã€‚è¯·ç»™å‡ºå®Œæ•´çš„ä¿®æ”¹å»ºè®®ã€‚åŒ…æ‹¬`MotorRegs`å’Œ`ModbusBt`çš„æ„é€ å‡½æ•°ä»¥åŠç›¸å…³å‡½æ•°ã€‚

### ç”µæœºè®¾å¤‡è¿æ¥é”™è¯¯

æ¥ä¸‹æ¥åˆ†ææµ‹è¯•ç”µæœºè®¾å¤‡è¿æ¥é”™è¯¯çš„é—®é¢˜ï¼š

```bash
INFO  2025-07-01T09:58:24.178 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ."
INFO  2025-07-01T09:58:24.179 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[0]" 
INFO  2025-07-01T09:58:24.180 "è“ç‰™MOTOR06aeè¿æ¥å…³é—­" 
ERROR 2025-07-01T09:58:24.180 "æ•æ‰é”™è¯¯ï¼ŒERRORCODE=19" 
ERROR 2025-07-01T09:58:27.334 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡å¤±è´¥." 
INFO  2025-07-01T09:58:27.335 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[1]" 
INFO  2025-07-01T09:58:27.445 "è“ç‰™è®¾å¤‡[]è¿æ¥æˆåŠŸ!" 
INFO  2025-07-01T09:58:27.445 "è¿æ¥æˆåŠŸå Socket çŠ¶æ€: 3 (é”™è¯¯ç : 19, é”™è¯¯ä¿¡æ¯: Trying to connect while connection is in progress)" 
INFO  2025-07-01T09:58:27.445 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
ERROR 2025-07-01T09:58:27.922 "è“ç‰™è¯»è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†æœªæ”¶åˆ°å›åº”" 
INFO  2025-07-01T09:58:27.923 "BaseConfigï¼šè“ç‰™è®¾å¤‡[MOTOR06ae]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[2]" 
INFO  2025-07-01T09:58:27.923 "è“ç‰™MOTOR06aeè¿æ¥å…³é—­" 
ERROR 2025-07-01T09:58:27.924 "æ•æ‰é”™è¯¯ï¼ŒERRORCODE=19" 
ERROR 2025-07-01T09:58:30.922 "è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡å¤±è´¥." 
```

å¯ä»¥çœ‹å‡ºï¼Œè¿æ¥è“ç‰™è®¾å¤‡`MOTOR06ae`å·²ç»æˆåŠŸäº†ã€‚ä½†æ˜¯åœ¨æµ‹è¯•è¿æ¥åï¼Œåˆä¸»åŠ¨æ–­å¼€äº†æ­¤è“ç‰™è®¾å¤‡çš„è¿æ¥ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

æˆ‘ä»¬æ¥ç€çœ‹è¿™éƒ¨åˆ†çš„ä»£ç ï¼š

```CPp
QLOG_INFO() << QString("BaseConfigï¼šè“ç‰™è®¾å¤‡[%1]ï¼Œæµ‹è¯•ç”µæœºç¼–å·[%2]").arg(portName).arg(i);
if(MotorStatus::getLinkStat(portName, i)){...}


bool MotorStatus::getLinkStat(QString portName, qint32 motorID)
{
    quint16 val = 0;
    if(motorID>DbCtrl::m_servoMotor_tb.size()){
        return false;
    }
    if(!m_motorsState.size()){
        m_motorsState.resize(DbCtrl::m_servoMotor_tb.size());
    }
    bool ret = MotorRegs::get_instance()->readReg16ForLinkTest(portName, motorID, 0, val);
    m_motorsState[motorID] = ret;
    if(!ret){
        m_initOk = false;
    }

    // é€šè®¯æˆåŠŸï¼Œåˆ™è®¾ç½®portName
    if (ret) {

    }
    return ret;
}

static MotorRegs*get_instance(){
    if(m_instance == NULL){
        m_instance = new MotorRegs();
    }
    return m_instance;
}

bool MotorRegs::readReg16ForLinkTest(QString portName, qint32 motorID, quint32 regAddr, quint16 &val)
{
    val = 0;
    m_modbusIO->open(portName, false);
    if(m_modbusIO->isOpen()){
        QVector<quint16> data;
        data.resize(1);
        if(m_modbusIO->read(motorID+1, ModbusIO::HoldingRegisters, regAddr, regAddr, data)){
            val = data.at(0);
            return true;
        }else{
            emit readFailed(motorID);
        }
    }else{
        emit openFailed();
    }
    return false;
}


bool ModbusBt::open(const QString&name, bool reOpen)
{
    bool ret = false;
    bool isHold = m_isHold;
    if(m_socket->isOpen()){
        if(name == m_currDev){
            if(m_isHold){
                QLOG_INFO()<<"è“ç‰™è®¾å¤‡["<<name<<"]å·²è¿æ¥ï¼Œä¿æŒè¿æ¥çŠ¶æ€ã€‚";
                return true;
            }else{
                close();
            }
        }else{
            if (!reOpen) {
                m_isHold = false;
                close();
            } else {
                m_isHold = true;
            }
        }
    }
    for(int i=0; i<m_devices.size(); i++){
        if(name == m_devices.at(i).first){
            m_socket->connectToService(QBluetoothAddress(m_devices.at(i).second),
                                       QBluetoothUuid(QBluetoothUuid::SerialPort));
            QEventLoop loop;
            QTimer timer;
            bool timeout = false;
            timer.setSingleShot(true);
            connect(&timer, &QTimer::timeout, &loop, [&timeout,&loop](){
                loop.quit();
                timeout = true;
            });
            connect(m_socket, &QBluetoothSocket::connected, &loop, &QEventLoop::quit);
            timer.start(3000);
            loop.exec();
            if (timer.isActive()) {
                timer.stop();
            }
            disconnect(m_socket, &QBluetoothSocket::connected, &loop, &QEventLoop::quit);
            if(timeout){
                QLOG_ERROR()<< QString("è¿æ¥%1è“ç‰™è®¾å¤‡å¤±è´¥.").arg(name);
                ret = false;
            }else{
                QLOG_INFO()<< QString("è¿æ¥%1è“ç‰™è®¾å¤‡æˆåŠŸ.").arg(name);
                ret = true;
                m_currDev = QString(name);
                m_isHold = isHold;
            }
            break;
        }
    }
    return ret;
}
```

åœ¨è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œåˆè°ƒç”¨äº†`MotorRegs::get_instance()`ç„¶åæ‰è°ƒç”¨äº†`readReg16ForLinkTest()`.

> Q:æˆ‘ç°åœ¨æƒ³é—®çš„æ˜¯ï¼Œè¿™é‡Œä¼šé‡æ–°æ„é€ ä¸€é`new MotorRegs()`å—ï¼Ÿ
>
> A:è¿™æ˜¯**å•ä¾‹æ¨¡å¼**å®ç°ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š
>
> - **ä¸ä¼šé‡æ–°æ„é€ ã€‚**
> - `if(m_instance == NULL)` è¿™ä¸ªæ¡ä»¶åˆ¤æ–­ç¡®ä¿äº† `m_instance = new MotorRegs();` è¿™è¡Œä»£ç åªä¼šåœ¨ `get_instance()` æ–¹æ³•**ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶**æ‰§è¡Œä¸€æ¬¡ã€‚
> - ä¹‹åçš„æ‰€æœ‰è°ƒç”¨ï¼Œ`m_instance` éƒ½å·²ç»ä¸å†æ˜¯ `NULL`ï¼Œæ‰€ä»¥å®ƒä¼šç›´æ¥è¿”å›ä¹‹å‰åˆ›å»ºçš„é‚£ä¸ª `MotorRegs` å®ä¾‹ã€‚
>
> å› æ­¤ï¼Œå½“ `MotorStatus::getLinkStat` è°ƒç”¨ `MotorRegs::get_instance()->readReg16ForLinkTest()` æ—¶ï¼Œå®ƒæ“ä½œçš„æ˜¯**åŒä¸€ä¸ª `MotorRegs` å®ä¾‹**ï¼Œä¸ä¼šå¯¼è‡´ `MotorRegs` é‡æ–°æ„é€ 

### ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿æ¥å…³é—­ï¼Ÿ

æ ¸å¿ƒé—®é¢˜åœ¨äº `m_isHold` è¿™ä¸ªæˆå‘˜å˜é‡çš„çŠ¶æ€ç®¡ç†ã€‚

1. **`m_isHold` çš„åˆå§‹åŒ–ï¼š** åœ¨ `ModbusBt` ç±»çš„**æ„é€ å‡½æ•°**ä¸­ï¼Œ`m_isHold` è¢«åˆå§‹åŒ–ä¸º `true`ã€‚è¿™è¡¨ç¤ºç³»ç»Ÿæœ€åˆçš„æ„å›¾æ˜¯â€œä¿æŒâ€è¿æ¥ã€‚

2. **`readReg16ForLinkTest` çš„è°ƒç”¨ï¼š**  `MotorStatus::getLinkStat` å‡½æ•°ä¼šè°ƒç”¨ `MotorRegs::readReg16ForLinkTest`ï¼Œè€Œ `readReg16ForLinkTest` çš„ç¬¬ä¸€è¡Œå°±æ˜¯ï¼š

   ```C++
   m_modbusIO->open(portName, false); // reOpen å‚æ•°ä¸º false
   ```

   è¿™æ¡è¯­å¥ä¼šå†æ¬¡å°è¯•â€œæ‰“å¼€â€è¿æ¥ã€‚

3. **`ModbusBt::open` å†…éƒ¨çš„åˆ¤æ–­é€»è¾‘ï¼š** å½“ä½ ç¬¬äºŒæ¬¡è°ƒç”¨ `open` å‡½æ•°æ—¶ï¼ˆæ¥è‡ª `readReg16ForLinkTest`ï¼‰ï¼Œæ—¥å¿—æ˜¾ç¤º 

   ```BASH
   ModbusBt::open - è°ƒç”¨å¼€å§‹ï¼Œname: [MOTOR06ae], reOpen: [0], m_isHold (å½“å‰): [0], m_currDev (å½“å‰): [MOTOR06ae], m_socket->isOpen() (å½“å‰): [1]ã€‚
   ```

   è¿™æ„å‘³ç€ï¼š

   - `m_socket->isOpen()` ä¸º `true`ï¼šè“ç‰™ Socket å®é™…ä¸Šæ˜¯æ‰“å¼€çš„ã€‚
   - `name` (`"MOTOR06ae"`) ç­‰äº `m_currDev` (`"MOTOR06ae"`)ï¼šè¦è¿æ¥çš„è®¾å¤‡ä¸å½“å‰å·²è¿æ¥çš„è®¾å¤‡æ˜¯åŒä¸€ä¸ªã€‚
   - **æœ€å…³é”®çš„ï¼š`m_isHold (å½“å‰)` ä¸º `0` (å³ `false`)ã€‚**

   ç”±äºè¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œä»£ç è¿›å…¥äº† `ModbusBt::open` ä¸­çš„è¿™ä¸ªåˆ†æ”¯ï¼š

   ```C++
   if(m_socket->isOpen()){
       if(name == m_currDev){
           if(m_isHold){ // è¿™é‡Œ m_isHold æ˜¯ falseï¼Œæ‰€ä»¥è·³è¿‡è¿™ä¸ªåˆ†æ”¯
               // QLOG_INFO()<<"è“ç‰™è®¾å¤‡["<<name<<"]å·²è¿æ¥ï¼Œä¿æŒè¿æ¥çŠ¶æ€ã€‚";
               // return true;
           }else{ // <-- è¿›å…¥äº†è¿™é‡Œï¼
               QLOG_INFO()<< QString("ModbusBt::open - m_isHold ä¸º falseï¼Œå…³é—­å½“å‰è¿æ¥ã€‚è®¾å¤‡: [%1]");
               close(); // <-- è¿æ¥åœ¨è¿™é‡Œè¢«ä¸»åŠ¨å…³é—­äº†ï¼
           }
       }
       // ...
   }
   ```

   å› æ­¤ï¼Œå°½ç®¡è¿æ¥æ˜¯å»ºç«‹çš„å¹¶ä¸”ç›®æ ‡è®¾å¤‡ä¹Ÿæ˜¯æ­£ç¡®çš„ï¼Œä½†ç”±äº `m_isHold` åœ¨**é‚£ä¸ªæ—¶åˆ»**çš„å€¼æ˜¯ `false`ï¼Œç¨‹åºé€»è¾‘è®¤ä¸ºè¿™ä¸ªè¿æ¥â€œä¸åº”è¯¥è¢«ä¿æŒâ€ï¼Œæ‰€ä»¥å®ƒ**ä¸»åŠ¨è°ƒç”¨äº† `close()`** æ¥æ–­å¼€è¿æ¥ã€‚è¿™è§£é‡Šäº†ä½ åœ¨æ—¥å¿—ä¸­çœ‹åˆ°çš„ `è“ç‰™MOTOR06aeè¿æ¥å…³é—­`ã€‚

### è¿æ¥å…³é—­çš„è§£å†³æ–¹æ¡ˆ

   ä¿®æ”¹ `ModbusBt::open` çš„ `if(name == m_currDev)` åˆ†æ”¯ï¼š

   1. å½“ `socket` å·²ç»æ‰“å¼€ï¼Œå¹¶ä¸”è¿æ¥çš„æ˜¯**æ­£ç¡®çš„ç›®æ ‡è®¾å¤‡**æ—¶ (`name == m_currDev`)ï¼Œ**æ— è®º `m_isHold` å½“å‰æ˜¯ `true` è¿˜æ˜¯ `false`ï¼Œéƒ½ç›´æ¥è¿”å› `true`ï¼Œä¸æ‰§è¡Œ `close()` æ“ä½œã€‚** å› ä¸ºæ—¢ç„¶è¿æ¥å·²ç»å­˜åœ¨ä¸”æ­£ç¡®ï¼Œå°±åº”è¯¥ç›´æ¥ä½¿ç”¨å®ƒè¿›è¡Œæµ‹è¯•ï¼Œè€Œä¸æ˜¯å…ˆå…³é—­å†å°è¯•é‡æ–°æ‰“å¼€ã€‚
   2. åœ¨ `for` å¾ªç¯ä¸­ï¼Œ**åªè¦æˆåŠŸå»ºç«‹æ–°è¿æ¥ï¼Œå°±å¼ºåˆ¶å°† `m_isHold` è®¾ç½®ä¸º `true`**ã€‚è¿™ç¡®ä¿äº†ä»»ä½•æ–°å»ºç«‹çš„è¿æ¥éƒ½è¢«è§†ä¸ºâ€œä¿æŒâ€çŠ¶æ€ï¼Œä»è€Œé¿å…äº†åœ¨åç»­ `open` è°ƒç”¨ä¸­å› ä¸º `m_isHold` ä¸º `false` è€Œè¢«å…³é—­ã€‚

   ç»è¿‡ä¿®æ”¹åï¼ŒæˆåŠŸè§£å†³è¿æ¥å…³é—­é—®é¢˜

## PADè“ç‰™è¿æ¥ç™»å½•æ—¶å€™çš„æ“ä½œ

   åœ¨è“ç‰™è¿æ¥ç™»å½•çš„æ—¶å€™ï¼Œéœ€è¦é¦–å…ˆè¿›è¡Œè“ç‰™è®¾å¤‡çš„è¿æ¥ï¼Œå¦åˆ™åç»­è¿æ¥å°†å˜å¾—å¾ˆå·®åŠ²ã€‚å¹¶ä¸”å°†è¿æ¥åçš„è®¾å¤‡ï¼Œä½œä¸ºå”¯ä¸€çš„ç«¯å£å­˜æ”¾åœ¨æ•°æ®åº“ä¸­ï¼Œä»¥åŠä½œä¸º`ModbusBt`çš„é»˜è®¤è¿æ¥è®¾å¤‡`m_currDev`ã€‚

### æµç¨‹

mainå‡½æ•°

```C++
int main(int argc, char *argv[])
{
    SQApplication a(argc, argv);
    QLockFile *lockfile = new QLockFile("servo.lock");
    if(!lockfile->tryLock(2000)){
        QMessageBox::critical(nullptr, "é”™è¯¯", "é‡å¤å¯åŠ¨ç¨‹åº", QMessageBox::Cancel);
        return -1;
    }

    // è®¾ç½®æ—¥å¿—è·¯å¾„
    setupFileLogging();

    // åˆå§‹åŒ–æ•°æ®åº“
    DbCtrl::DbInit(0);
    MainWindow w;   // åˆ›å»ºä¸»çª—å£å¯¹è±¡

    // æ‘‡æ†æ³¨å†Œ
    InputManager inputManager;
    MotorCtrl *mc = MotorCtrl::get_instance();
    // åˆ›å»ºæ‘‡æ†æ§åˆ¶å™¨ç®¡ç†å™¨
    JoystickControllerManager joystickManager(&inputManager, mc);

    // å°† joystickManager ä¼ é€’ç»™ CenterWindow
    w.centerWindow->setJoystickManager(&joystickManager); // å‡è®¾ CenterWindow æ˜¯ MainWindow çš„å…¬å…±æˆå‘˜æˆ–æœ‰getæ–¹æ³•

    if(DbCtrl::m_systemInfo_tb.mode == 1){
        a.getTimer()->setInterval(DbCtrl::m_systemInfo_tb.screenTime*5000);
        a.connect(a.getTimer(), &QTimer::timeout, &w, &MainWindow::on_timeout);
    }
    w.showSL(); // æ˜¾ç¤ºä¸»çª—å£

//    splash.finish(&w);

    return a.exec();
}
```

- åœ¨`åˆå§‹åŒ–æ•°æ®åº“`åï¼Œåˆå§‹åŒ–å½“å‰è“ç‰™ä¿¡æ¯ï¼Œæ­¤æ—¶éœ€è¦å¼¹çª—é˜»å¡ä¸‹ä¸€æ­¥çš„è¿›è¡Œã€‚

  - é¦–å…ˆæ ¹æ®æ•°æ®åº“ä¸­ä¿å­˜çš„`portName`è¿›è¡Œè¿æ¥ï¼ŒæŸ¥çœ‹æ˜¯å¦è¿æ¥æˆåŠŸã€‚

    ```C++
    QString portName = DbCtrl::m_systemInfo_tb.portName;
    ```

    å¦‚æœæˆåŠŸï¼Œåˆ™ç»§ç»­æ²¿ç”¨å½“å‰`portName`ï¼›

    å¦‚æœè¿æ¥ä¸ä¸Šï¼Œåˆ™éœ€è¦ä¸‹ä¸€æ­¥æ“ä½œ

  - æ‰«æè®¾å¤‡ï¼Œè·å–ç›®æ ‡`MOTOR`å‰ç¼€çš„è®¾å¤‡ã€‚é’ˆå¯¹å½“å‰æ¯ä¸ªè“ç‰™ç¯å¢ƒä¸­ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€å°`MOTOR`å‰ç¼€çš„è“ç‰™è®¾å¤‡ï¼Œåœæ­¢æ‰«æã€‚

  - è¿æ¥ç›®æ ‡è®¾å¤‡æˆåŠŸåï¼Œå°†æ–°çš„è®¾å¤‡åç§°ä»¥`portName`ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚å¹¶ä¸”é‡æ–°è®¾ç½®`m_currDev`

## ä¼˜åŒ–ç™»å½•é€»è¾‘

### é—®é¢˜

ç°åœ¨é—®é¢˜æ˜¯ï¼Œç™»å½•é€Ÿåº¦å¤ªæ…¢ã€‚å³ä½¿ä¸Šä¸€æ¬¡ç™»å½•æˆåŠŸäº†å¹¶ä¸”å°†ç«¯å£å­˜æ”¾åœ¨äº†æ•°æ®åº“ä¸­ï¼Œæœ¬æ¬¡è°ƒç”¨æ­¤ç¨‹åºä¾æ—§å¾ˆæ…¢ã€‚å¿…é¡»è§£å†³**å¦‚ä½•åœ¨ä¸è¿›è¡Œè“ç‰™æ‰«æçš„æƒ…å†µä¸‹ï¼Œæ‰¾åˆ°ä¸Šæ¬¡æˆåŠŸè¿æ¥è®¾å¤‡çš„ MAC åœ°å€**ï¼Œä»¥ä¾¿èƒ½å¤Ÿå¿«é€Ÿè¿æ¥

```bash
INFO  2025-07-01T15:18:07.792 BaseConfig: 'è¿”å›'æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå‘å‡º dialogClosed ä¿¡å·ã€‚ 
INFO  2025-07-01T15:19:48.013 ============== æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ– ============== 
INFO  2025-07-01T15:19:48.014 Qt ç‰ˆæœ¬: 5.14.2 
INFO  2025-07-01T15:19:48.017 BluetoothInit: å¼€å§‹æ‰§è¡Œè“ç‰™è¿æ¥åˆå§‹åŒ–æµç¨‹ã€‚ 
INFO  2025-07-01T15:19:48.017 "ModbusBtï¼šåˆå§‹åŒ–æ„é€ ï¼Œè®¾å¤‡[MOTOR06ae]å°†ä½œä¸ºè¿æ¥ç›®æ ‡" 
INFO  2025-07-01T15:19:48.144 "BluetoothInit: å°è¯•è¿æ¥æ•°æ®åº“ä¸­ä¿å­˜çš„è“ç‰™è®¾å¤‡ [MOTOR06ae]" 
INFO  2025-07-01T15:19:48.144 "ModbusBt::open - Socket æœªæ‰“å¼€åˆ†æ”¯ï¼Œå°†å°è¯•è¿æ¥ã€‚" 
ERROR 2025-07-01T15:19:48.144 "ModbusBt::open - æœªèƒ½è¿æ¥åˆ°è®¾å¤‡ [MOTOR06ae]ï¼Œå¯èƒ½æœªæ‰¾åˆ°æˆ–è¿æ¥å¤±è´¥ã€‚" 
INFO  2025-07-01T15:19:48.144 "ModbusBt::open - è°ƒç”¨ç»“æŸï¼Œè¿”å›: [0], m_isHold (ç»“æŸæ—¶): [1], m_currDev (ç»“æŸæ—¶): [MOTOR06ae]" 
WARN  2025-07-01T15:19:48.145 "BluetoothInit: æ— æ³•è¿æ¥åˆ°ä¸Šæ¬¡ä¿å­˜çš„è“ç‰™è®¾å¤‡ [MOTOR06ae]ã€‚" 
INFO  2025-07-01T15:19:48.145 BluetoothInit: æœªèƒ½è¿æ¥åˆ°ä¸Šæ¬¡ä¿å­˜çš„è®¾å¤‡ï¼Œå¯åŠ¨è“ç‰™æ‰«æã€‚ 
INFO  2025-07-01T15:19:48.145 ModbusBt::startScan - æ‰«æè¿‡ç¨‹å¼€å§‹ã€‚ 
INFO  2025-07-01T15:19:48.145 ModbusBt::startScan - å·²æ¸…ç©ºç°æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œå‡†å¤‡é‡æ–°å‘ç°ã€‚ 
INFO  2025-07-01T15:19:48.145 ModbusBt::startScan - å‘ç°ä»£ç†å½“å‰ä¸æ´»è·ƒï¼Œæ— éœ€åœæ­¢ç°æœ‰æ‰«æã€‚ 
INFO  2025-07-01T15:19:48.153 ModbusBt::startScan - å·²å¯åŠ¨æ–°çš„è“ç‰™è®¾å¤‡å‘ç°ã€‚ 
INFO  2025-07-01T15:19:50.058 "ModbusBt::onDeviceDiscoveredï¼š>>>>>>>å‘ç°ç›®æ ‡è“ç‰™è®¾å¤‡MOTOR06ae--A0:DD:6C:02:06:AE<<<<<<<" 
INFO  2025-07-01T15:19:50.058 "ModbusBt::onDeviceDiscoveredï¼šç°æŒ‡å®šè®¾å¤‡ [MOTOR06ae]ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥..." 
INFO  2025-07-01T15:19:50.059 "ModbusBt::onDeviceDiscoveredï¼šè“ç‰™æ‰«æè¡Œä¸ºå·²åœæ­¢ï¼Œå‡†å¤‡è¿æ¥è®¾å¤‡[MOTOR06ae]ã€‚" 
INFO  2025-07-01T15:19:50.059 "ModbusBt::open - Socket æœªæ‰“å¼€åˆ†æ”¯ï¼Œå°†å°è¯•è¿æ¥ã€‚" 
INFO  2025-07-01T15:19:50.059 "ModbusBt::open - æ‰¾åˆ°ç›®æ ‡è®¾å¤‡ [MOTOR06ae]ï¼Œå°è¯•è¿æ¥åˆ°åœ°å€ [A0:DD:6C:02:06:AE]ã€‚" 
INFO  2025-07-01T15:19:50.437 "è“ç‰™è®¾å¤‡[MOTOR06ae]è¿æ¥æˆåŠŸ!" 
INFO  2025-07-01T15:19:50.437 "å‘é€ä¿¡å· em_motorConnected, å½“å‰è®¾å¤‡: [MOTOR06ae]" 
INFO  2025-07-01T15:19:50.437 "è®¾å¤‡[MOTOR06ae]è¿æ¥æˆåŠŸå Socket çŠ¶æ€: 3 (é”™è¯¯ç : -2, é”™è¯¯ä¿¡æ¯: )" 
INFO  2025-07-01T15:19:50.437 "ModbusBt::open - è¿æ¥MOTOR06aeè“ç‰™è®¾å¤‡æˆåŠŸ." 
INFO  2025-07-01T15:19:50.437 "ModbusBt::open - è°ƒç”¨ç»“æŸï¼Œè¿”å›: [1], m_isHold (ç»“æŸæ—¶): [1], m_currDev (ç»“æŸæ—¶): [MOTOR06ae]" 
WARN  2025-07-01T15:20:07.918 BluetoothInit: è“ç‰™æ‰«æè¶…æ—¶ï¼Œæœªæ‰¾åˆ°æˆ–è¿æ¥åˆ°ç›®æ ‡è®¾å¤‡ã€‚ 
INFO  2025-07-01T15:20:07.918 "BluetoothInit: é€šè¿‡æ‰«ææˆåŠŸè¿æ¥åˆ°è“ç‰™è®¾å¤‡ [MOTOR06ae]ã€‚" 
INFO  2025-07-01T15:20:08.130 "BluetoothInit: å·²å°†æ–°è¿æ¥çš„è®¾å¤‡ [MOTOR06ae] ä¿å­˜åˆ°æ•°æ®åº“ã€‚" 
```

`ModbusBt::open` åœ¨å°è¯•è¿æ¥ `MOTOR06ae` æ—¶ï¼Œ**é‡åˆ°äº†é”™è¯¯ï¼Œæ— æ³•æˆåŠŸå»ºç«‹è¿æ¥**ã€‚é”™è¯¯ä¿¡æ¯è¡¨æ˜è®¾å¤‡å¯èƒ½æ²¡æ‰¾åˆ°ï¼Œæˆ–è€…è¿æ¥è¿‡ç¨‹å¤±è´¥äº†ã€‚

æˆ‘ä»¬çœ‹ä¸‹å…·ä½“çš„è°ƒç”¨é€»è¾‘ï¼š

```C++
// 1. é¦–å…ˆå°è¯•è¿æ¥æ•°æ®åº“ä¸­ä¿å­˜çš„è®¾å¤‡
if (!initialPortName.isEmpty()) {
    statusLabel->setText(QString("æ­£åœ¨å°è¯•è¿æ¥ä¸Šæ¬¡è®¾å¤‡: %1...").arg(initialPortName));
    QLOG_INFO() << QString("BluetoothInit: å°è¯•è¿æ¥æ•°æ®åº“ä¸­ä¿å­˜çš„è“ç‰™è®¾å¤‡ [%1]").arg(initialPortName);
    connectionSuccessful = modbusBtInstance->open(initialPortName, false);
    if (connectionSuccessful) {
       
        QLfor(int i = 0; i < m_devices.size(); i++){..}OG_INFO() << QString("BluetoothInit: æˆåŠŸè¿æ¥åˆ°ä¸Šæ¬¡ä¿å­˜çš„è“ç‰™è®¾å¤‡ [%1]ã€‚").arg(initialPortName);
        statusLabel->setText(QString("å·²æˆåŠŸè¿æ¥åˆ°è®¾å¤‡: %1").arg(initialPortName));
    } else {
        QLOG_WARN() << QString("BluetoothInit: æ— æ³•è¿æ¥åˆ°ä¸Šæ¬¡ä¿å­˜çš„è“ç‰™è®¾å¤‡ [%1]ã€‚").arg(initialPortName);
    }
}


// æœ‰è¶£çš„open
for(int i = 0; i < m_devices.size(); i++){..}
```

ä¸ºä»€ä¹ˆè¯´æœ‰è¶£çš„`open()`å‘¢ã€‚å› ä¸º`open`çš„é€»è¾‘æ˜¯ï¼š

- åˆ¤æ–­æ˜¯å¦å½“å‰æœ‰è¿æ¥

  ```C++
  if(m_socket->isOpen())
  ```

- å¦‚æœæ²¡æœ‰è¿æ¥ï¼Œåˆ™ä¼šè·³åˆ°å”¯ä¸€è¿›è¡Œè¿æ¥å°è¯•çš„ä½ç½®

  ```C++
  for(int i = 0; i < m_devices.size(); i++){..}
  ```

  å¯¹äº`m_devices`ä¸­çš„`MAC`åœ°å€ï¼Œè¿›è¡Œè¿æ¥

é‚£å°±è§£é‡Šå¾—é€šäº†ã€‚å› ä¸ºæˆ‘ä»¬æ‰“å¼€çš„`initialPortName`åªåŒ…å«nameï¼Œè€Œå¯¹åº”çš„`MAC`åœ°å€å¹¶æ²¡æœ‰ä¿å­˜ã€‚å¹¶ä¸”åˆå§‹åŒ–`ModbusBt`çš„æ—¶å€™ï¼Œ`m_devices`ä¼šè¢«æ¸…ç©ºæ‰ã€‚

### è§£å†³æ–¹æ¡ˆ

åŠ å…¥æ•°æ®åº“å­—æ®µï¼Œåœ¨`sysInfo_tb`ä¸­ï¼ŒåŠ å…¥`BtMAC`çš„ä¿¡æ¯ï¼Œä»¥æ­¤å­˜å‚¨å­—ç¬¦ä¸²ç±»å‹çš„MACåœ°å€ã€‚è€Œ`portName`ä»ä½œä¸ºè®¾å¤‡åç§°ä¿å­˜ã€‚

æ¶‰åŠçš„ä¿®æ”¹åœ°ç‚¹ä¸ºï¼š

DbCtrlï¼š

```C++
typedef struct __systemInfo_tb__{
    int mode; // 0:PC; 1:pad
    int screenTime;
    int xMode; // 0 åŒç”µæœº, 1å•ç”µæœºå·¦, 2å•ç”µæœºå³
    int targetWidth;
    int targetHeight;
    int targetLength;
    char portName[128];
    int baudRate;
    int dataBits;
    int flowContrl;
    int parity;
    int stopBits;
    int useBt;
    char BtMAC[128];
}T_systemInfo_tb;

int DbCtrl::updateSystemInfo(T_systemInfo_tb &info);
int DbCtrl::DbInit(bool reInit);
```

ç»è¿‡æµ‹è¯•ï¼Œå‘ç°å·²ç»æˆåŠŸè®¾ç½®äº†æ•°æ®åº“å­—æ®µã€‚æˆ‘å·²ç»æˆåŠŸåŠ å…¥äº†BtMACå­—æ®µ

ç°åœ¨å°±éœ€è¦åœ¨mainå‡½æ•°çš„åˆå§‹åŒ–è“ç‰™è®¾å¤‡çš„æ—¶å€™ï¼Œè¯»å–åˆ°è®¾å¤‡ä¿¡æ¯åï¼Œå°±è¦å°†åç§°å’ŒMACå†™å…¥åˆ°æ•°æ®åº“ã€‚å¹¶ä¸”å†æ‰“å¼€çš„æ—¶å€™ï¼Œé¦–å…ˆè¯»å–æ•°æ®åº“çš„ä¸¤ä¸ªå­—æ®µï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º`ModbusBt`ä¸­çš„`m_devices`ã€‚ç„¶åè°ƒç”¨`open()`çš„æ—¶å€™å°±æ²¡é—®é¢˜äº†ã€‚

## åˆ·æ–°åˆ—è¡¨é”™è¯¯

ç°åœ¨å¤šæ¬¡ç‚¹å‡»åˆ·æ–°åˆ—è¡¨ï¼Œå®Œæ•´æ—¥å¿—ä¸º

```bash
INFO  2025-07-01T19:45:07.874 MotorCtrl: è®¤è¯æˆåŠŸï¼Œå‡†å¤‡è¿›å…¥è®¾ç½®é¡µé¢ï¼Œæ‘‡æ†å†æ¬¡ç¡®ä¿ç¦ç”¨ã€‚ 
INFO  2025-07-01T19:45:11.306 "BaseConfig::getDevList - è“ç‰™è¿æ¥ï¼Œæ­£åœ¨è°ƒç”¨æ–¹æ³• startScan() æ‰«æè®¾å¤‡..." 
INFO  2025-07-01T19:45:11.306 ModbusBt::startScan - æ‰«æè¿‡ç¨‹å¼€å§‹ã€‚ 
INFO  2025-07-01T19:45:11.306 ModbusBt::clearDiscoveredDevices - å·²æ¸…ç©ºæ‰€æœ‰å·²å‘ç°è®¾å¤‡ã€‚ 
INFO  2025-07-01T19:45:11.306 ModbusBt::startScan - å·²æ¸…ç©ºç°æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œå‡†å¤‡é‡æ–°å‘ç°ã€‚ 
INFO  2025-07-01T19:45:11.306 ModbusBt::startScan - å‘ç°ä»£ç†å½“å‰ä¸æ´»è·ƒï¼Œæ— éœ€åœæ­¢ç°æœ‰æ‰«æã€‚ 
INFO  2025-07-01T19:45:11.324 ModbusBt::startScan - å·²å¯åŠ¨æ–°çš„è“ç‰™è®¾å¤‡å‘ç°ã€‚ 
INFO  2025-07-01T19:45:11.960 "BaseConfig::getDevList - è“ç‰™è¿æ¥ï¼Œæ­£åœ¨è°ƒç”¨æ–¹æ³• startScan() æ‰«æè®¾å¤‡..." 
INFO  2025-07-01T19:45:11.960 ModbusBt::startScan - æ‰«æè¿‡ç¨‹å¼€å§‹ã€‚ 
INFO  2025-07-01T19:45:11.960 ModbusBt::clearDiscoveredDevices - å·²æ¸…ç©ºæ‰€æœ‰å·²å‘ç°è®¾å¤‡ã€‚ 
INFO  2025-07-01T19:45:11.960 ModbusBt::startScan - å·²æ¸…ç©ºç°æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œå‡†å¤‡é‡æ–°å‘ç°ã€‚ 
INFO  2025-07-01T19:45:11.964 ModbusBt::startScan - å‘ç°ä»£ç†å½“å‰æ´»è·ƒï¼Œå·²åœæ­¢ç°æœ‰æ‰«æã€‚ 
INFO  2025-07-01T19:45:11.964 ModbusBt::startScan - å·²å¯åŠ¨æ–°çš„è“ç‰™è®¾å¤‡å‘ç°ã€‚ 
INFO  2025-07-01T19:45:12.549 "BaseConfig::getDevList - è“ç‰™è¿æ¥ï¼Œæ­£åœ¨è°ƒç”¨æ–¹æ³• startScan() æ‰«æè®¾å¤‡..." 
INFO  2025-07-01T19:45:12.549 ModbusBt::startScan - æ‰«æè¿‡ç¨‹å¼€å§‹ã€‚ 
INFO  2025-07-01T19:45:12.550 ModbusBt::clearDiscoveredDevices - å·²æ¸…ç©ºæ‰€æœ‰å·²å‘ç°è®¾å¤‡ã€‚ 
INFO  2025-07-01T19:45:12.550 ModbusBt::startScan - å·²æ¸…ç©ºç°æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œå‡†å¤‡é‡æ–°å‘ç°ã€‚ 
INFO  2025-07-01T19:45:12.554 ModbusBt::startScan - å‘ç°ä»£ç†å½“å‰æ´»è·ƒï¼Œå·²åœæ­¢ç°æœ‰æ‰«æã€‚ 
INFO  2025-07-01T19:45:12.554 ModbusBt::startScan - å·²å¯åŠ¨æ–°çš„è“ç‰™è®¾å¤‡å‘ç°ã€‚ 
INFO  2025-07-01T19:45:12.979 "BaseConfig::getDevList - è“ç‰™è¿æ¥ï¼Œæ­£åœ¨è°ƒç”¨æ–¹æ³• startScan() æ‰«æè®¾å¤‡..." 
INFO  2025-07-01T19:45:12.980 ModbusBt::startScan - æ‰«æè¿‡ç¨‹å¼€å§‹ã€‚ 
INFO  2025-07-01T19:45:12.980 ModbusBt::clearDiscoveredDevices - å·²æ¸…ç©ºæ‰€æœ‰å·²å‘ç°è®¾å¤‡ã€‚ 
INFO  2025-07-01T19:45:12.980 ModbusBt::startScan - å·²æ¸…ç©ºç°æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œå‡†å¤‡é‡æ–°å‘ç°ã€‚ 
INFO  2025-07-01T19:45:12.983 ModbusBt::startScan - å‘ç°ä»£ç†å½“å‰æ´»è·ƒï¼Œå·²åœæ­¢ç°æœ‰æ‰«æã€‚ 
INFO  2025-07-01T19:45:12.983 ModbusBt::startScan - å·²å¯åŠ¨æ–°çš„è“ç‰™è®¾å¤‡å‘ç°ã€‚ 
INFO  2025-07-01T19:45:13.410 "BaseConfig::getDevList - è“ç‰™è¿æ¥ï¼Œæ­£åœ¨è°ƒç”¨æ–¹æ³• startScan() æ‰«æè®¾å¤‡..." 
INFO  2025-07-01T19:45:13.410 ModbusBt::startScan - æ‰«æè¿‡ç¨‹å¼€å§‹ã€‚ 
INFO  2025-07-01T19:45:13.410 ModbusBt::clearDiscoveredDevices - å·²æ¸…ç©ºæ‰€æœ‰å·²å‘ç°è®¾å¤‡ã€‚ 
INFO  2025-07-01T19:45:13.410 ModbusBt::startScan - å·²æ¸…ç©ºç°æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œå‡†å¤‡é‡æ–°å‘ç°ã€‚ 
INFO  2025-07-01T19:45:13.413 ModbusBt::startScan - å‘ç°ä»£ç†å½“å‰æ´»è·ƒï¼Œå·²åœæ­¢ç°æœ‰æ‰«æã€‚ 
INFO  2025-07-01T19:45:13.414 ModbusBt::startScan - å·²å¯åŠ¨æ–°çš„è“ç‰™è®¾å¤‡å‘ç°ã€‚ 
```

å‡ºç°çš„é—®é¢˜ä¸ºï¼š

`BaseConfig::getDevList()` å¤šæ¬¡è°ƒç”¨äº† `startScan()`ã€‚

ä½†åœ¨åˆå§‹æˆåŠŸè¿æ¥åï¼ŒUI çš„ä¸‹æ‹‰æ¡†ï¼ˆ`m_com_cb`ï¼‰ä¼¼ä¹æ²¡æœ‰æ ¹æ®å‘ç°çš„è®¾å¤‡è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿæ²¡æœ‰çœ‹åˆ° `onDeviceDiscovered` æˆ– `onScanFinished` çš„æ—¥å¿—ã€‚

------

### é—®é¢˜åˆ†æ

ä»ä½ çš„æ—¥å¿—å’Œä»£ç æ¥çœ‹ï¼Œé—®é¢˜çš„æ ¹æºåœ¨äºï¼š

1. **é‡å¤æ‰«æçš„å¿…è¦æ€§ï¼š** ä½ çš„åº”ç”¨å¯åŠ¨æ—¶å·²ç»é€šè¿‡æ•°æ®åº“ä¿¡æ¯æˆåŠŸè¿æ¥åˆ°äº†è“ç‰™è®¾å¤‡ `MOTOR06ae`ã€‚åç»­å¤šæ¬¡è°ƒç”¨ `BaseConfig::getDevList()` åˆå†æ¬¡è§¦å‘äº† `startScan()`ã€‚è™½ç„¶ `startScan()` ä¼šæ¸…ç©º `m_devices` å¹¶é‡æ–°å¼€å§‹æ‰«æï¼Œä½†ç”±äºè®¾å¤‡å·²ç»è¿æ¥ï¼Œ`ModbusBt::onDeviceDiscovered` ä¸­çš„é€»è¾‘ä¼šè·³è¿‡å†æ¬¡å°è¯•è¿æ¥å’Œå‘å‡º `em_motorDiscovered` ä¿¡å·ï¼ˆå› ä¸º `m_socket->state()` ä¸æ˜¯ `UnconnectedState`ï¼Œå¹¶ä¸” `addDiscoveredDevice` ä¼šé˜»æ­¢é‡å¤æ·»åŠ ç›¸åŒçš„è®¾å¤‡åˆ°åˆ—è¡¨ï¼‰ã€‚
2. **UI æ›´æ–°æœºåˆ¶ï¼š** `m_com_cb` çš„æ›´æ–°ä¾èµ–äº `em_motorDiscovered` ä¿¡å·çš„å‘å‡ºï¼Œä½†å¦‚ä¸Šæ‰€è¿°ï¼Œåœ¨è®¾å¤‡å·²è¿æ¥çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªä¿¡å·å¯èƒ½ä¸ä¼šå†æ¬¡å‘å‡ºã€‚
3. **æ—¥å¿—ç¼ºå¤±ï¼š** è“ç‰™æ‰«æç»“æŸåï¼Œåº”è¯¥ä¼šè§¦å‘ `onScanFinished`ã€‚å¦‚æœé•¿æ—¶é—´æ²¡æœ‰çœ‹åˆ°è¿™ä¸ªæ—¥å¿—ï¼Œå¯èƒ½æ„å‘³ç€æ‰«æè¿‡ç¨‹æœ¬èº«é‡åˆ°äº†é—®é¢˜ï¼ˆè™½ç„¶ç¬¬ä¸€æ¬¡è¿æ¥æˆåŠŸäº†ï¼Œä½†åç»­æ‰«æå¯èƒ½å› ç¯å¢ƒæˆ–å¹¶å‘è°ƒç”¨è€Œè¡¨ç°å¼‚å¸¸ï¼‰ï¼Œæˆ–è€…ä½ æ²¡æœ‰åœ¨ `BaseConfig` ä¸­è¿æ¥ `onScanFinished` ä¿¡å·ã€‚

------

### è§£å†³æ–¹æ¡ˆå’Œä»£ç ä¼˜åŒ–

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å¹¶ä¼˜åŒ–é€»è¾‘ï¼Œå»ºè®®ä»¥ä¸‹ä¿®æ”¹ï¼š

1. **è§£è€¦ `BaseConfig::getDevList()` å’Œè¿æ¥é€»è¾‘ï¼š** `getDevList()` çš„ä¸»è¦èŒè´£åº”è¯¥æ˜¯æ›´æ–°è®¾å¤‡åˆ—è¡¨ UIã€‚è¿æ¥çŠ¶æ€çš„æ˜¾ç¤ºåº”è¯¥é€šè¿‡ä¿¡å·æ§½æœºåˆ¶æ¥å®Œæˆã€‚
2. **ç¡®ä¿ `m_com_cb` åˆ—è¡¨å’Œå½“å‰è¿æ¥çŠ¶æ€åŒæ­¥ï¼š** ä¸ç®¡æœ‰æ²¡æœ‰æ‰«æï¼Œå¦‚æœè®¾å¤‡å·²ç»è¿æ¥ï¼Œ`m_com_cb` éƒ½åº”è¯¥æ­£ç¡®æ˜¾ç¤ºã€‚
3. **ä¼˜åŒ–æ‰«æå¯åŠ¨æ—¶æœºï¼š** é¿å…ä¸å¿…è¦çš„é‡å¤æ‰«æã€‚

## è“ç‰™å›¾æ ‡

ç°åœ¨æƒ³åœ¨ä¸»ç•Œé¢ï¼Œå¢åŠ ä¸€ä¸ªè“ç‰™çŠ¶æ€æŒ‰é’®ã€‚

# 7.2

## å¿«é€Ÿç§»åŠ¨æ‘‡æ†é—®é¢˜

å¿«é€Ÿåœ°ç”¨æ‘‡æ†è¿›è¡Œâ€œæ¾å¼€-æŒ‰ä¸‹â€æ“ä½œæ—¶ï¼Œ`isRunning()` é€»è¾‘è§¦å‘äº†è­¦å‘Šï¼Œå¹¶ä¸”ç”µæœºæ²¡æœ‰åœæ­¢ã€‚

```Cpp
bool MotorCtrl::isRunning()
{
    if(m_checkWoker && m_checkWoker->isRunning()){
        QLOG_WARN()<<QString("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…");
        SMessageBox::sQdialogBoxOk(this, QMessageBox::Information, tr("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…"));
        if(m_jog_done){
            return true;
        }
    }
    return false;
}
```

### é—®é¢˜åˆ†æ

1. **`isRunning()` çš„è¯¯åˆ¤å’Œé˜»å¡ï¼š**

   - `if(m_checkWoker && m_checkWoker->isRunning())`ï¼šè¿™ç¡®å®æ£€æŸ¥äº†çº¿ç¨‹æ˜¯å¦åœ¨è¿è¡Œã€‚
   - `QLOG_WARN()<<QString("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…"); SMessageBox::sQdialogBoxOk(...)`ï¼š**è¿™ä¸ªæ˜¯æ ¸å¿ƒé—®é¢˜ï¼** ä½ åœ¨è¿™é‡Œå¼¹å‡ºä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡† (`SMessageBox::sQdialogBoxOk`)ã€‚æ¨¡æ€å¯¹è¯æ¡†ä¼š **é˜»å¡å½“å‰çº¿ç¨‹** (UI çº¿ç¨‹)ï¼Œç›´åˆ°ç”¨æˆ·ç‚¹å‡»ç¡®å®šã€‚
   - `if(m_jog_done){ return true; }`ï¼šå³ä½¿ `m_jog_done` å·²ç»ä¸º `true` (è¡¨ç¤ºä¹‹å‰çš„ Jog ä»»åŠ¡å·²å®Œæˆ)ï¼Œç”±äºå¯¹è¯æ¡†çš„é˜»å¡ï¼Œ`isRunning()` ä»ç„¶ä¼šæ˜¾ç¤ºè­¦å‘Šå¹¶ç­‰å¾…ç”¨æˆ·ç¡®è®¤ã€‚
   - **åæœï¼š** å½“ç”¨æˆ·å¿«é€Ÿæ¾å¼€æ‘‡æ†ï¼ˆ`joyForwardMoveEnd` è§¦å‘ `on_actionUpRightFrontBt_released`ï¼Œä½†ç”±äºé˜»å¡å¯èƒ½è¿˜æ²¡æ¥å¾—åŠæ‰§è¡Œåœæ­¢é€»è¾‘ï¼‰åˆç«‹åˆ»æŒ‰ä¸‹ï¼ˆ`joyForwardMoveStart` è§¦å‘ `on_actionUpRightFrontBt_pressed`ï¼‰ï¼Œç¬¬äºŒæ¬¡æŒ‰ä¸‹æ—¶ï¼Œ`isRunning()` å‘ç°çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œå°±ä¼šå¼¹å‡ºé˜»å¡å¯¹è¯æ¡†ã€‚è¿™æ„å‘³ç€ï¼š
     - `on_actionUpRightFrontBt_released` å¯¹åº”çš„åœæ­¢é€»è¾‘å¯èƒ½æ ¹æœ¬æ²¡æ‰§è¡Œæˆ–è¢«å»¶è¿Ÿæ‰§è¡Œã€‚
     - æ–°çš„ `actionJog` è°ƒç”¨è¢« `isRunning()` é˜»æ­¢ã€‚
     - ä½ æ— æ³•åœ¨ç”µæœºè¿åŠ¨æ—¶è¿›è¡Œå…¶ä»–æ“ä½œï¼Œå› ä¸ºå®ƒè¢«æ¨¡æ€å¯¹è¯æ¡†é˜»å¡äº†ã€‚
2. **`m_jog_done` çš„æ›´æ–°æ—¶æœºï¼š** `m_jog_done` åº”è¯¥åœ¨ `checkJog` çº¿ç¨‹çœŸæ­£å®Œæˆå…¶ä»»åŠ¡å¹¶åœæ­¢è¿åŠ¨æ—¶æ‰è®¾ä¸º `true`ã€‚ä»ä½ çš„ä»£ç çœ‹ï¼Œå®ƒåœ¨ `actionJog` ä¸­è¢«è®¾ä¸º `false`ï¼Œåœ¨ `on_threadFinished` ä¸­æ‰å¯èƒ½è¢«è®¾ä¸º `true`ã€‚å¦‚æœ `on_threadFinished` è¿˜æ²¡æ¥å¾—åŠæ‰§è¡Œï¼Œé‚£ä¹ˆ `m_jog_done` å°±ä»ç„¶æ˜¯ `false`ã€‚

   **ç¼ºä¹å¯¹ `released` äº‹ä»¶çš„å¿«é€Ÿå“åº”ï¼š** ä½ çš„ `on_actionUpRightFrontBt_released` æ§½å‡½æ•°è´Ÿè´£åœæ­¢ç”µæœºã€‚å¦‚æœè¿™ä¸ªæ§½å‡½æ•°åœ¨ `isRunning()` é˜»å¡æœŸé—´è¢«è°ƒç”¨ï¼Œå®ƒå¯èƒ½æ ¹æœ¬æ— æ³•æ‰§è¡Œã€‚

### è§£å†³æ–¹æ¡ˆ

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦é‡æ–°æ€è€ƒä½ çš„çº¿ç¨‹ç®¡ç†å’ŒUIåé¦ˆç­–ç•¥ã€‚ä¿®æ”¹ç­–ç•¥ï¼šå°†å¼¹çª—å±•ç¤ºè®¾ä¸ºå»¶è¿Ÿéé˜»å¡å¼¹çª—ã€‚

## ä¿®æ”¹å®‰å“å›¾æ ‡

æŒ‰ç…§[å¸–å­](https://blog.csdn.net/qq_16126823/article/details/121462030)æ¥å°±å®Œäº‹äº†~

# 7.3

ä»Šå¤©è¦å¼€å§‹åšfpgaç›¸å…³çš„åŠŸèƒ½

## FPGAé¡¹ç›®

ç°åœ¨è¦åš`fpga`ç¡¬ä»¶ç›¸å…³çš„é©±åŠ¨éœ€æ±‚ï¼Œæ¨¡å— `fpga.c` çš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š

> å°è£…å¯¹ FPGA å¯„å­˜å™¨çš„è¯»å†™æ“ä½œï¼Œæä¾›æ§åˆ¶ LEDã€ADCã€Gainã€Resetã€Training ç­‰åŠŸèƒ½çš„æ¥å£ã€‚

`fpga_reg_read`/`fpga_reg_write` çš„å®ç°æ˜¯é€šè¿‡ `I2C`ï¼ˆ`user_i2c.c`ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè½¯ä»¶ä¸FPGAè¿›è¡Œåº•å±‚äº¤äº’çš„çœŸæ­£æ–¹å¼ï¼šé€šè¿‡I2Cæ€»çº¿ã€‚

## ä½¿ç”¨TDDé‡æ„é¡¹ç›®

| ç›®æ ‡                         | æ–¹æ³•                                    |
| ---------------------------- | --------------------------------------- |
| ğŸ’¡ åˆ†ç¦»ç¡¬ä»¶ä¾èµ–ï¼Œä¾¿äºå•å…ƒæµ‹è¯• | æŠ½è±¡ `fpga_reg_read` / `fpga_reg_write` |
| âœ… é’ˆå¯¹æ¯ä¸ªåŠŸèƒ½å†™æµ‹è¯•ç”¨ä¾‹     | ä½¿ç”¨ `test/fpga_test.c`                 |
| âš™ï¸ ä¿æŒ Makefile ç¼–è¯‘æµç¨‹     | å¢åŠ  `make test` æˆ– `make fpga_test`    |

åœ¨ `test/` ç›®å½•ä¸‹å»ºç«‹ä»¥ä¸‹ç»“æ„ï¼š

```bash
test/
â”œâ”€â”€ fpga_mock.c       # æ¨¡æ‹Ÿ fpga_reg_read/write çš„å®ç°
â”œâ”€â”€ fpga_mock.h       # æä¾› mock çš„æ›¿æ¢æ¥å£
â”œâ”€â”€ fpga_test.c       # æµ‹è¯•ç”¨ä¾‹ï¼ˆTDD æµ‹è¯•é€»è¾‘å†™åœ¨è¿™é‡Œï¼‰
â””â”€â”€ Makefile          # test çš„ä¸“ç”¨ Makefileï¼Œæ”¯æŒç¼–è¯‘ fpga_test å¯æ‰§è¡Œæ–‡ä»¶
```

## é‡æ„ `fpga.c` ä¸ºå¯æµ‹è¯•æ¶æ„

### æ­¥éª¤ 1ï¼šæŠ½è±¡ I/O å‡½æ•°

ä½œç”¨æ˜¯è§£è€¦çœŸå®ç¡¬ä»¶è®¿é—®å’Œä¸šåŠ¡é€»è¾‘ã€‚

- `fpga_reg_read()` / `fpga_reg_write()` æ˜¯ **çœŸå®ç¡¬ä»¶è®¿é—®æ¥å£**ï¼Œä¸€æ—¦ä½ è¿›å…¥æµ‹è¯•åœºæ™¯ï¼ˆæ²¡æœ‰çœŸå®ç¡¬ä»¶ï¼‰ï¼Œè¿™äº›è°ƒç”¨ä¼šå¤±è´¥ã€‚
- `fpga_read` / `fpga_write` æ˜¯ **å‡½æ•°æŒ‡é’ˆå˜é‡**ï¼Œå¯ä»¥åŠ¨æ€ç»‘å®šåˆ°ï¼š
  - çœŸæ­£çš„å¯„å­˜å™¨è®¿é—®ï¼ˆéƒ¨ç½²æ—¶ç”¨ï¼‰
  - æ¨¡æ‹Ÿå¯„å­˜å™¨ï¼ˆæµ‹è¯•æ—¶ç”¨ï¼‰

ä¿®æ”¹ `dev/fpga.c`ï¼Œä¸è¦ç›´æ¥ä¾èµ– `fpga_reg_write()`ï¼ˆçœŸå®çš„ç¡¬ä»¶æ¥å£ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ä¸€å±‚å¯æ›¿æ¢çš„å‡½æ•°æŒ‡é’ˆã€‚**å‡½æ•°æŒ‡é’ˆæœºåˆ¶**çš„å…¸å‹ç”¨æ³•ï¼Œç›®çš„æ˜¯è®©**å‡½æ•°çš„è°ƒç”¨å…·æœ‰â€œå¯åˆ‡æ¢æ€§â€æˆ–â€œå¯æ’æ‹”æ€§â€**ï¼Œå®ç°çµæ´»çš„æŠ½è±¡å±‚è®¾è®¡ã€‚

```C
// dev/fpga_io.hï¼ˆæ–°å¢ï¼‰
#pragma once
#include <stdint.h>

typedef int (*fpga_reg_read_t)(uint16_t reg, uint32_t* val);
typedef int (*fpga_reg_write_t)(uint16_t reg, uint32_t val);

extern fpga_reg_read_t fpga_read;
extern fpga_reg_write_t fpga_write;
extern int fpga_reg_safe_write(uint16_t reg, uint32_t val);
```

```C
// dev/fpga.c
#include "fpga_io.h"

// é»˜è®¤å®ç°
fpga_reg_read_t fpga_read = fpga_reg_read;
fpga_reg_write_t fpga_write = fpga_reg_write;

// åŸæœ‰ä»£ç ä¸­ï¼šæ›¿æ¢æ‰€æœ‰ fpga_reg_read/write ä¸º fpga_read/fpga_write
// æ–¹æ³•ä¸ºï¼šsed -i 's/\bfpga_reg_read\b/fpga_read/g; s/\bfpga_reg_write\b/fpga_write/g' fpga.c
fpga_read(LED_CTL, &value);
fpga_write(FPGA_REG_GAIN_A + chn, val);
```

### æ­¥éª¤ 2ï¼šå¯¹ mock å±‚æä¾›æ›¿æ¢æ¥å£

```C
// test/fpga_mock.h
#pragma once
#include <stdint.h>

int fpga_mock_reg_read(uint16_t reg, uint32_t* val);
int fpga_mock_reg_write(uint16_t reg, uint32_t val);

void fpga_mock_reset();  // æ¸…ç©º mock å¯„å­˜å™¨å€¼
```

```C
// test/fpga_mock.c
#include "fpga_mock.h"
#include <string.h>

#define FPGA_REG_COUNT 256
static uint32_t fpga_regs[FPGA_REG_COUNT];

int fpga_mock_reg_read(uint16_t reg, uint32_t* val)
{
    if (reg >= FPGA_REG_COUNT) return -1;
    *val = fpga_regs[reg];
    return 0;
}

int fpga_mock_reg_write(uint16_t reg, uint32_t val)
{
    if (reg >= FPGA_REG_COUNT) return -1;
    fpga_regs[reg] = val;
    return 0;
}

void fpga_mock_reset()
{
    memset(fpga_regs, 0, sizeof(fpga_regs));
}
```

### ä¸‰ã€æµ‹è¯•ä»£ç  `test/fpga_test.c`

```C
// test/fpga_test.c
#include <stdio.h>
#include "fpga.h"
#include "fpga_io.h"
#include "fpga_mock.h"

int test_fpga_collect_enable()
{
    fpga_mock_reset();
    fpga_write(FPGA_REG_COLLECT_EN, 0x0);

    // æµ‹è¯•é‡‡é›†ä½¿èƒ½å¯„å­˜å™¨
    fpga_write(FPGA_REG_COLLECT_EN, 0x1);

    uint32_t val = 0;
    fpga_read(FPGA_REG_COLLECT_EN, &val);
    return (val & 0x1) == 0x1;
}

int test_led_set()
{
    fpga_mock_reset();
    int ret = run_led_set(LED_ON);
    uint32_t val = 0;
    fpga_read(FPGA_REG_LED_CTL, &val);
    return ret == 0 && (val & 0x7) == LED_ON;
}

int main()
{
    // æ›¿æ¢ä¸º mock å‡½æ•°
    fpga_read = fpga_mock_reg_read;
    fpga_write = fpga_mock_reg_write;

    printf("==== FPGA TDD Test ====\n");

    printf("[TEST] collect_enable: %s\n", test_fpga_collect_enable() ? "PASS" : "FAIL");
    printf("[TEST] run_led_set:    %s\n", test_led_set() ? "PASS" : "FAIL");

    return 0;
}
```

### å››ã€æµ‹è¯• Makefile

åœ¨ `test/Makefile` ä¸­è¿™æ ·ç¼–å†™ï¼š

```C
CC = gcc
CFLAGS = -I../dev -I. -I.. -Wall -g

SRCS = fpga_test.c fpga_mock.c ../dev/fpga.c ../commdef.c
OBJS = $(SRCS:.c=.o)

TARGET = fpga_test

all: $(TARGET)

$(TARGET): $(OBJS)
	$(CC) -o $@ $^

clean:
	rm -f $(OBJS) $(TARGET)
```

ç„¶åï¼š

```bash
cd test
make
./fpga_test
```

é¢„æœŸè¾“å…¥ï¼š

```C
==== FPGA TDD Test ====
[TEST] collect_enable: PASS
[TEST] run_led_set:    PASS
```

## æµ‹è¯•æ¡†æ¶æŠ¥é”™

### 1.undefined reference to `fpga_reg_safe_write'

æ‰§è¡Œå®Œæ¯•åï¼ŒæŠ¥é”™

```bash
../dev/fpga.o: In function `run_led_set':
fpga.c:(.text+0x54): undefined reference to `fpga_reg_safe_write'
../dev/fpga.o: In function `alarm_led_set':
fpga.c:(.text+0xc5): undefined reference to `fpga_reg_safe_write'
```

åŸå› æ˜¯ï¼š

- `fpga_reg_safe_write` è°ƒç”¨çš„æ˜¯å…·ä½“çš„ `fpga_reg_write` å’Œ `fpga_reg_read` å‡½æ•°ã€‚
- ä½ åœ¨æµ‹è¯•æ—¶ç”¨å‡½æ•°æŒ‡é’ˆ `fpga_read` å’Œ `fpga_write` æ¥æ›¿ä»£è°ƒç”¨ï¼Œè¿™æ ·å¯ä»¥mockã€‚
- **ä½†ä½ çš„ `fpga_reg_safe_write` ç›®å‰ç›´æ¥è°ƒç”¨çš„æ˜¯åº•å±‚å‡½æ•°ï¼Œä¸æ˜¯å‡½æ•°æŒ‡é’ˆ**ï¼Œæ‰€ä»¥mockæ›¿æ¢ä¼šå¤±æ•ˆã€‚

å› ä¸ºæ­¤å‡½æ•°çš„å®ç°æ˜¯åœ¨`user_i2c.h`ä¸­ã€‚

- `fpga_reg_safe_write` æ˜¯å†™åœ¨ `user_i2c.c` / `user_i2c.h` ä¸­çš„ï¼Œé‡Œé¢ç›´æ¥è°ƒç”¨äº†åº•å±‚çš„ `fpga_reg_read` å’Œ `fpga_reg_write`ï¼Œè€Œéå‡½æ•°æŒ‡é’ˆã€‚
- è¿™æ ·ä¸€æ¥ï¼Œä½ åœ¨ `fpga.c` é‡Œç”¨å‡½æ•°æŒ‡é’ˆæ›¿æ¢`fpga_read`ã€`fpga_write`ï¼Œå¯¹ `fpga_reg_safe_write` æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºå®ƒç›´æ¥è°ƒç”¨äº†å…·ä½“å‡½æ•°ã€‚

`fpga_reg_safe_write` æ˜¯**æ²¡æœ‰ä½¿ç”¨æŠ½è±¡å±‚ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰**ï¼Œè€Œæ˜¯ç›´æ¥ä¾èµ–åº•å±‚å‡½æ•°å®ç°çš„ã€‚è¦æ”¯æŒæµ‹è¯•æ—¶mockæ›¿æ¢ï¼Œå¿…é¡»è®© `fpga_reg_safe_write` ä¹Ÿä¾èµ–äºå‡½æ•°æŒ‡é’ˆæˆ–è€…æä¾›ä¸€ä¸ªå¯æ›¿æ¢çš„æ¥å£ã€‚

ä¸ºäº†æŠŠæ‰€æœ‰ FPGA æ“ä½œç»Ÿä¸€é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨ï¼Œæ–¹ä¾¿mockå’Œæ‰©å±•ï¼Œå¿…é¡»å°† `fpga_reg_safe_write` ä» `user_i2c.c` ç§»åŠ¨åˆ° `fpga.c` å¹¶æ”¹å†™ä¸ºä½¿ç”¨å‡½æ•°æŒ‡é’ˆ

#### ä¿®æ”¹ç­–ç•¥

è§£å†³åŠæ³•ï¼šå°†`fpga_reg_safe_write` ä» `user_i2c.c` ç§»åŠ¨åˆ° `fpga.c` å¹¶æ”¹å†™ä¸ºä½¿ç”¨å‡½æ•°æŒ‡é’ˆ

- æŠŠ `fpga_reg_safe_write` ç§»åˆ° `fpga.c`ï¼ˆæˆ–è€…`fpga_io.c`ï¼Œä½ mockçš„é‚£ä¸ªæ–‡ä»¶ï¼‰
- é‡Œé¢è°ƒç”¨çš„æ”¹æˆ `fpga_write` å’Œ `fpga_read` å‡½æ•°æŒ‡é’ˆ
- è¿™æ ·æµ‹è¯•æ—¶æ›¿æ¢å‡½æ•°æŒ‡é’ˆï¼Œ`fpga_reg_safe_write` å°±ä¼šè‡ªåŠ¨ç”¨mockç‰ˆæœ¬

```C
// fpga_io.h
extern fpga_reg_read_t fpga_read;
extern fpga_reg_write_t fpga_write;

int fpga_reg_safe_write(uint16_t reg, uint32_t val);

// fpga_io.c (æˆ–è€… fpga.c)
int fpga_reg_safe_write(uint16_t reg, uint32_t val)
{
    uint32_t readbk = 0;
    for(int i=0; i<10; i++){
        fpga_write(reg, val);
        fpga_read(reg, &readbk);
        if(readbk == val) return 0;
        ERR_LOG("try again\n");
    }
    return -1;
}
```

è¿™æ ·ï¼Œæ— è®ºæµ‹è¯•è¿˜æ˜¯æ­£å¸¸ï¼Œéƒ½åªç”¨å‡½æ•°æŒ‡é’ˆè°ƒç”¨ã€‚

### 2.undefined reference to `g_app_cfgctrl'

#### æŠ¥é”™æè¿°

```bash
../dev/fpga.o: In function `gain_control':
fpga.c:(.text+0x2d5): undefined reference to `g_app_cfgctrl'
```

#### æŠ¥é”™ä½ç½®

```C
int gain_control(int chn, int gain)
{
    if (chn < 0 || chn >= 8) {
        ERR_LOG("Invalid channel number: %d\n", chn);
        return -1;
    }

    int g_id = (gain == 20) ? 1 : (gain == 40) ? 2 : 0;
    int rep = g_app_cfgctrl->cfg.reparation[g_id][chn];
    uint16_t code = (uint16_t)((87.57 - gain) * 4096 / 100);
    int iRet = fpga_write(AD_GAIN_CH(chn), code - rep);

    if (iRet != 0) {
        ERR_LOG("Gain set, data write failed!\n");
        return -1;
    }

    INFO_LOG("Gain %d set, chn%d code = %d reparation = %d\n", gain, chn, code, rep);
    return 0;
}
```

#### åŸå› 

ç›´æ¥ä¾èµ–å…¨å±€å˜é‡ `g_app_cfgctrl`ï¼Œè¿™ä¼šå½±å“å•å…ƒæµ‹è¯•çš„ç‹¬ç«‹æ€§ã€‚

æ‰€ä»¥éœ€è¦

- è§£è€¦ `gain_control` å’Œ `g_app_cfgctrl` å…¨å±€å˜é‡
- ä¿ç•™åŸæœ‰åŠŸèƒ½
- ä½¿å…¶å¯ä»¥åœ¨æµ‹è¯•ä¸­æ³¨å…¥ mock çš„ `reparation[][]` æ•°æ®

#### æ”¹é€ æ–¹æ¡ˆ

ä¼ å‚æ³¨å…¥é…ç½®æŒ‡é’ˆï¼ˆæ¨èç”¨äºå•å…ƒæµ‹è¯•å‹å¥½ï¼‰

æ”¹é€  `gain_control` æ¥å£ï¼Œå°†`gain`ä¹Ÿæ”¾å…¥åˆ° `cfg` å‚æ•°ä¹‹ä¸­ï¼š

```c
int gain_control(int chn, const user_cfg_t* cfg)
{
    if (chn < 0 || chn >= MAX_CHN_CNT) {
        ERR_LOG("Invalid channel number: %d\n", chn);
        return -1;
    }

    int gain = cfg->gain[chn];
    int g_id = (gain == 20) ? 1 : (gain == 40) ? 2 : 0;
    int rep = cfg->reparation[g_id][chn];

    uint16_t code = (uint16_t)((87.57f - gain) * 4096 / 100);
    int iRet = fpga_write(AD_GAIN_CH(chn), code - rep);

    if (iRet != 0) {
        ERR_LOG("Gain set, data write failed!\n");
        return -1;
    }

    INFO_LOG("Gain %d set, chn %d code = %d reparation = %d\n", gain, chn, code, rep);
    return 0;
}
```

åŸå§‹è°ƒç”¨ï¼š

```C
gain_control(0, 20);
```

æ”¹ä¸ºï¼š

```c
gain_control(0, &g_app_cfgctrl->cfg);
```

åœ¨æµ‹è¯•ä¸­å¯ç”¨ mock config æ›¿ä»£ã€‚





## å‡½æ•°æŒ‡é’ˆå­¦ä¹ 

```C
typedef int (*fpga_reg_read_t)(uint16_t reg, uint32_t* val);
typedef int (*fpga_reg_write_t)(uint16_t reg, uint32_t val);

extern fpga_reg_read_t fpga_read;
extern fpga_reg_write_t fpga_write;
```

æ˜¯ C è¯­è¨€ä¸­**å‡½æ•°æŒ‡é’ˆæœºåˆ¶**çš„å…¸å‹ç”¨æ³•ï¼Œç›®çš„æ˜¯è®©**å‡½æ•°çš„è°ƒç”¨å…·æœ‰â€œå¯åˆ‡æ¢æ€§â€æˆ–â€œå¯æ’æ‹”æ€§â€**ï¼Œå®ç°çµæ´»çš„æŠ½è±¡å±‚è®¾è®¡ã€‚

### å¿«é€Ÿç†è§£å‡½æ•°æŒ‡é’ˆ

å‡½æ•°æŒ‡é’ˆï¼Œå°±æ˜¯â€œ**æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ**â€ï¼Œå¯ä»¥ç”¨å˜é‡åæ¥é—´æ¥è°ƒç”¨ä¸€ä¸ªå‡½æ•°ã€‚

```C
int add(int a, int b) {
    return a + b;
}

// å£°æ˜ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå˜é‡
int (*func_ptr)(int, int);

// ä½¿ç”¨
func_ptr = add;  // æŒ‡é’ˆæŒ‡å‘å‡½æ•°
int result = func_ptr(3, 4);  // è°ƒç”¨å‡½æ•° â†’ å®é™…è°ƒç”¨çš„æ˜¯ add(3, 4)
```

### ç†è§£FPGAä¸­çš„å‡½æ•°æŒ‡é’ˆ

#### å‡½æ•°æŒ‡é’ˆç±»å‹

é¦–å…ˆå®šä¹‰äº†å‡½æ•°æŒ‡é’ˆç±»å‹ï¼š

```C
typedef int (*fpga_reg_read_t)(uint16_t reg, uint32_t* val);
typedef int (*fpga_reg_write_t)(uint16_t reg, uint32_t val);
```

è¡¨ç¤ºï¼š

- `fpga_reg_read_t` æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹ï¼Œ**å‚æ•°ä¸ºåœ°å€+è¾“å‡ºæŒ‡é’ˆï¼Œè¿”å› int çŠ¶æ€ç **
- `fpga_reg_write_t` æ˜¯å¦ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹ï¼Œ**å‚æ•°ä¸ºåœ°å€+å†™å…¥å€¼ï¼Œè¿”å›çŠ¶æ€ç **

#### å£°æ˜ä¸¤ä¸ªå¤–éƒ¨å˜é‡

```C
extern fpga_reg_read_t fpga_read;
extern fpga_reg_write_t fpga_write;
```

è¡¨ç¤ºä½ é¡¹ç›®ä¸­å°†æœ‰è¿™æ ·ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆå˜é‡ï¼Œå®ƒä»¬**åœ¨åˆ«å¤„å®šä¹‰ï¼ˆæ¯”å¦‚ `dev/fpga.c` ä¸­ï¼‰**ï¼Œä½ å¯ä»¥è¿™æ ·ç”¨ï¼š

```C
uint32_t val = 0;
fpga_read(0x05, &val);    // å®é™…è°ƒç”¨åº•å±‚ I2C è¯»å‡½æ•°
fpga_write(0x05, 0x1234); // å®é™…è°ƒç”¨åº•å±‚ I2C å†™å‡½æ•°
```

### ä¼˜åŠ¿

è¿™æ˜¯ä¸€ç§**æ¥å£æŠ½è±¡åŒ–**ï¼Œç›¸å½“äºä½ æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„â€œæ“ä½œå¯„å­˜å™¨çš„æ¥å£â€ï¼Œä½†ä¸å…³å¿ƒå…·ä½“æ˜¯é€šè¿‡ï¼š

- I2Cï¼Ÿ
- SPIï¼Ÿ
- PCIeï¼Ÿ
- æ¨¡æ‹Ÿå¯„å­˜å™¨æ˜ å°„ï¼Ÿ

è¿™æ ·ä½ çš„**ä¸Šå±‚ä¸šåŠ¡ä»£ç **ï¼ˆæ¯”å¦‚ `adc_training()`ï¼‰å°±å¯ä»¥ç”¨ï¼š

```C
fpga_write(FPGA_REG_ADC_WRITE, 0x800);
```

ä¸éœ€è¦çŸ¥é“åº•å±‚æ˜¯ `ioctl()` è¿˜æ˜¯ `mmap()`ï¼Œåªéœ€è°ƒç”¨ç»Ÿä¸€çš„ `fpga_write` å³å¯ã€‚

### å›¾è§£

```bash
+----------------+     fpga_write â†’ å¯æŒ‡å‘ I2C å†™å‡½æ•°ã€PCIe å†™å‡½æ•°ç­‰
| ä¸šåŠ¡é€»è¾‘æ¨¡å—   |     fpga_read  â†’ å¯æŒ‡å‘ I2C è¯»å‡½æ•°ã€PCIe è¯»å‡½æ•°ç­‰
+----------------+         â†“
        |           +------------------+
        |           | I2C å®ç°å‡½æ•°     |ï¼ˆI2Cã€PCIe ç­‰åº•å±‚ç»†èŠ‚å¯åˆ‡æ¢ï¼‰
        +----------â†’| fpga_i2c_write() |
                    | fpga_i2c_read()  |
                    +------------------+
```

## å…¨å±€æ›¿æ¢åç§°

ç°åœ¨é‡æ„`fpga.c`ï¼Œéœ€è¦å°†ä¹‹å‰ä¾èµ–ç¡¬ä»¶`I2C`æ¨¡å—å®ç°çš„

```C
int fpga_reg_write(uint16_t reg, uint32_t val);
int fpga_reg_read(uint16_t reg, uint32_t *val);
```

å°† `fpga.c` ä¸­æ‰€æœ‰ `fpga_reg_read()` å’Œ `fpga_reg_write()` æ›¿æ¢ä¸º `fpga_read()` å’Œ `fpga_write()`ã€‚ä½ å¯ä»¥ä½¿ç”¨ Linux ä¸‹æœ€å¸¸è§çš„æ–‡æœ¬å¤„ç†å·¥å…· `sed` æ¥**æ‰¹é‡æ›¿æ¢** `fpga.c` æ–‡ä»¶ä¸­çš„å‡½æ•°åã€‚ä»¥ä¸‹æ˜¯æœ€ç›´æ¥ã€å®‰å…¨çš„æ“ä½œæ–¹å¼ï¼š

------

### âœ… ä¸€ã€ä½¿ç”¨ `sed` è¿›è¡Œæ›¿æ¢

æ‰“å¼€ç»ˆç«¯ï¼Œåˆ‡æ¢åˆ°åŒ…å« `fpga.c` çš„ç›®å½•ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
sed -i 's/\bfpga_reg_read\b/fpga_read/g; s/\bfpga_reg_write\b/fpga_write/g' fpga.c
```

------

### âœ… è¯´æ˜ï¼š

| éƒ¨åˆ†            | å«ä¹‰                                                  |
| --------------- | ----------------------------------------------------- |
| `-i`            | ç›´æ¥ä¿®æ”¹æ–‡ä»¶ï¼ˆ**å°±åœ°ç¼–è¾‘**ï¼‰                          |
| `'s/old/new/g'` | æ›¿æ¢æ‰€æœ‰åŒ¹é…é¡¹ï¼ˆ**g = global**ï¼‰                      |
| `\b`            | å•è¯è¾¹ç•Œï¼Œé˜²æ­¢è¯¯ä¼¤ï¼ˆä¾‹å¦‚ä¸ä¼šæ”¹ `fpga_reg_read_safe`ï¼‰ |
| `;`             | ä¸²è”ä¸¤ä¸ªæ›¿æ¢è¯­å¥                                      |

------

### âœ… äºŒã€æ›¿æ¢å‰å»ºè®®å¤‡ä»½

ä¸ºäº†ä¿é™©ï¼Œä½ å¯ä»¥å…ˆå¤‡ä»½ä¸€ä»½ï¼š

```bash
cp fpga.c fpga.c.bak
```

ç„¶åå†æ‰§è¡Œ `sed`ã€‚

------

### âœ… ä¸‰ã€éªŒè¯æ›¿æ¢ç»“æœï¼ˆéå¿…é¡»ï¼‰

ä½ ä¹Ÿå¯ä»¥å…ˆé¢„è§ˆæ›¿æ¢å†…å®¹ï¼Œè€Œä¸ä¿®æ”¹åŸæ–‡ä»¶ï¼Œç”¨ `cat` + `sed`ï¼š

```bash
sed 's/\bfpga_reg_read\b/fpga_read/g; s/\bfpga_reg_write\b/fpga_write/g' fpga.c | less
```

------

### âœ… å››ã€å¯é€‰ï¼šç”¨ Vim æ‰¹é‡æ›¿æ¢

æ‰“å¼€ `fpga.c`ï¼š

```bash
vim fpga.c
```

ç„¶åæ‰§è¡Œï¼š

```vim
:%s/\<fpga_reg_read\>/fpga_read/g
:%s/\<fpga_reg_write\>/fpga_write/g
:wq
```

------

# 7.4

## æ—‹è½¬è½´Err13

æ’æŸ¥æ–¹å‘ã€‚

### ç”µæœºå‹å·

è¿™ä¸ªéœ€è¦è¯¦ç»†è®°å½•ã€‚

### æŠ±é—¸æ—¶åº

| å‚æ•°ç¼–å· | åç§°             | æ§åˆ¶é˜¶æ®µ       | å»¶æ—¶ä½œç”¨                 | æ¨èè®¾å®š          |
| -------- | ---------------- | -------------- | ------------------------ | ----------------- |
| PA94     | åˆ¶åŠ¨å™¨æ¾å¼€å»¶æ—¶   | å¯åŠ¨/ä½¿èƒ½      | ç”µæµå¼€å¯ â†’ BRK ON        | 5~~15 (50~~150ms) |
| PA54     | ä½¿èƒ½å¤±æ•ˆå»¶è¿Ÿæ–­ç”µ | åœæœº/å¤±èƒ½      | BRK OFF â†’ ç”µæµæ–­å¼€       | 5~~15 (50~~150ms) |
| PA47     | åœæœºæ—¶æ–­ç”µå»¶æ—¶   | ç”µæœºä¸»åŠ¨åœæœº   | BRK OFF â†’ ç”µæµæ–­å¼€       | â‰¥ åˆ¶åŠ¨å™¨åŠ¨ä½œæ—¶é—´  |
| PA48     | è¿è½¬æ—¶åˆ¶åŠ¨å»¶æ—¶   | åœæœºå‡é€Ÿ       | ç”µæµæ–­å¼€ â†’ BRK OFF       | é…åˆ PA49         |
| PA49     | è¿è½¬æ—¶åˆ¶åŠ¨é€Ÿåº¦   | åœæœºå‡é€Ÿ       | å‡é€Ÿåˆ°æŸé€Ÿåº¦åæ‰åŠ¨ä½œ BRK | é€šå¸¸ 50~200 rpm   |
| PA99     | åˆ¶åŠ¨å™¨æœ€å¤§å ç©ºæ¯” | åˆ¶åŠ¨å™¨æ‰“å¼€æœŸé—´ | é˜²æ­¢è¿‡çƒ­                 | 50%~80%           |

```BASH
ğŸŸ¢ ä½¿èƒ½é˜¶æ®µï¼ˆä¸Šç”µ/å¯åŠ¨ï¼‰ï¼š

ä¼ºæœä½¿èƒ½ON
â†“
[ç«‹åˆ»] ç”µæµå¼€å¯
â†“ï¼ˆç­‰å¾… PA94 æ—¶é—´ï¼‰
åˆ¶åŠ¨å™¨æ¾å¼€ï¼ˆBRK=ONï¼‰
â†“
ç”µæœºè‡ªç”±è½¬åŠ¨

ğŸ›‘ å¤±èƒ½é˜¶æ®µï¼ˆæ–­ç”µ/åœæœºï¼‰ï¼š

ä¼ºæœä½¿èƒ½OFF
â†“
åˆ¶åŠ¨å™¨é—­åˆä¿¡å·å‘å‡ºï¼ˆBRK=OFFï¼‰
â†“ï¼ˆç­‰å¾… PA54 æ—¶é—´ï¼‰
åˆ‡æ–­ç”µæµ
â†“
ç”µæœºå®Œå…¨åœæ­¢
```

æ­£å¸¸å¯åœé¡ºåºï¼š

| æ­¥éª¤ | åŠ¨ä½œ                                | è¯´æ˜                                       |
| ---- | ----------------------------------- | ------------------------------------------ |
| 1ï¸âƒ£    | æ§åˆ¶å™¨å‘å‡ºâ€œä¼ºæœä½¿èƒ½â€ä¿¡å·            | ç”µæœºå‡†å¤‡ä¸Šç”µã€è¿›å…¥å·¥ä½œçŠ¶æ€                 |
| 2ï¸âƒ£    | ç”µæœºé©±åŠ¨å™¨ç»™ç”µæœºâ€œä¸Šç”µâ€ï¼ˆä¾›ç”µ/é€šç”µï¼‰ | å»ºç«‹ç£åœºï¼Œç”µæœºå¤„äºé”å®šçŠ¶æ€ï¼ˆå…·æœ‰è¾“å‡ºåŠ›çŸ©ï¼‰ |
| 3ï¸âƒ£    | **å»¶è¿Ÿä¸€æ®µæ—¶é—´**ï¼ˆPA94æ§åˆ¶ï¼‰        | è®©ç”µæœºç£åœºå®Œå…¨å»ºç«‹ï¼Œæœ‰è¶³å¤ŸåŠ›çŸ©æ”¯æ’‘è´Ÿè½½     |
| 4ï¸âƒ£    | **æ¾å¼€åˆ¶åŠ¨å™¨ï¼ˆBRK=ONï¼‰**            | ç”µæœºè½´èƒ½è‡ªç”±è½¬åŠ¨ï¼Œä½†å·²æœ‰åŠ›çŸ©æ‰¿è½½å®ƒ         |
| 5ï¸âƒ£    | å¼€å§‹è¿åŠ¨æŒ‡ä»¤                        | ç”µæœºæ­£å¸¸å¯åŠ¨è¿è¡Œ                           |

#### PA47 - ç”µæœº**åœæ­¢**æ—¶çš„æœºæ¢°åˆ¶åŠ¨å»¶è¿Ÿè®¾å®š

**è§¦å‘æ¡ä»¶ï¼š** ç”µæœºåœä¸‹æ¥ï¼Œå‡†å¤‡æ–­ç”µå¹¶ä½¿æœºæ¢°åˆ¶åŠ¨å™¨å¤¹ç´§
**è®¾å®šèŒƒå›´ï¼š** 0ï½200 Ã— 10msï¼ˆå³ 0ï½2 ç§’ï¼‰

ä½œç”¨

- åœ¨ **æœºæ¢°åˆ¶åŠ¨å™¨å¼€å§‹å¤¹ç´§ï¼ˆBRK OFFï¼‰å**ï¼Œ**å»¶è¿Ÿä¸€æ®µæ—¶é—´å†æ–­ç”µ**ã€‚
- **é˜²æ­¢åœ¨æœºæ¢°åˆ¶åŠ¨å™¨å°šæœªå¤¹ç‰¢å‰ç”µæœºå¤±å»åŠ›çŸ©**ï¼ˆå› ç”µæµæ–­å¼€ï¼‰å¯¼è‡´ä½ç½®æ¼‚ç§»æˆ–è®¾å¤‡æ‰è½ã€‚

è®¾ç½®å»ºè®®

- å¿…é¡» â‰¥ æœºæ¢°åˆ¶åŠ¨å™¨çš„åŠ¨ä½œæ—¶é—´ Tb
- å¦‚æœ Tb = 80msï¼Œå»ºè®®è®¾ç½® PA47 = 100msï¼ˆå³ 10ï¼‰å¦‚æœ Tb = 80msï¼Œå»ºè®®è®¾ç½® PA47 = 100msï¼ˆå³ 10ï¼‰

#### PA48 - ç”µæœº**è¿è½¬æ—¶**çš„æœºæ¢°åˆ¶åŠ¨å»¶è¿Ÿè®¾å®š

**è§¦å‘æ¡ä»¶ï¼š** ç”µæœºæ­£åœ¨è¿è¡Œï¼Œè¢«æŒ‡ä»¤åœæœº
**è®¾å®šèŒƒå›´ï¼š** 0ï½200 Ã— 10msï¼ˆå³ 0ï½2 ç§’ï¼‰
**æ§åˆ¶é€»è¾‘ï¼š** **åœ¨ç”µæµæ–­å¼€åå»¶è¿Ÿä¸€æ®µæ—¶é—´å†è§¦å‘åˆ¶åŠ¨å™¨ï¼ˆBRK OFFï¼‰**

ä½œç”¨

- é˜²æ­¢ç”µæœºåœ¨é«˜é€Ÿè¿è½¬ä¸­**ç›´æ¥åˆ¶åŠ¨**ï¼Œé¿å…åˆ¶åŠ¨å™¨è¢«å†²å‡»æŸåã€‚

- å®é™…åŠ¨ä½œæ—¶é—´ä¸ºï¼š

  ```scss
  min(PA48å»¶æ—¶æ—¶é—´ï¼Œå‡é€Ÿåˆ°PA49çš„æ—¶é—´)
  ```

è®¾ç½®å»ºè®®

- å¯¹äºé«˜é€Ÿè½´ï¼ŒPA48è®¾ç½®å¤§ä¸€äº›ï¼ˆå¦‚ 100~200msï¼‰
- å¦‚æœç³»ç»Ÿèƒ½å¿«é€Ÿå‡é€Ÿåˆ°PA49è®¾å®šé€Ÿåº¦ï¼Œå¯ä»¥æ›´ä¾èµ–PA49

#### PA49 â€” ç”µæœºè¿è½¬æ—¶æœºæ¢°åˆ¶åŠ¨å™¨åŠ¨ä½œé€Ÿåº¦è®¾å®š

ä½œç”¨ï¼š

- æŒ‡å®š**ç”µæœºå‡é€Ÿåˆ°æŸä¸ªä½é€Ÿ**æ—¶ï¼Œæ‰å…è®¸åˆ¶åŠ¨å™¨åŠ¨ä½œã€‚

- å’Œ PA48 ä¸€èµ·å†³å®šâ€œä½•æ—¶è§¦å‘ BRK OFFâ€ï¼š

  ```lua
  å®é™…åŠ¨ä½œæ—¶é—´ = min(PA48å»¶æ—¶ï¼Œå‡é€Ÿåˆ°PA49é€Ÿåº¦æ‰€éœ€æ—¶é—´)
  ```

è®¾ç½®å»ºè®®

- è®¾å®šå€¼ä¸è¦å¤ªé«˜ï¼ˆä¸€èˆ¬ 50~200rpm åˆé€‚ï¼‰
- ç”µæœºé™é€Ÿå®¹æ˜“åˆ°è¾¾è¿™ä¸ªå€¼æ—¶å°±æ—©ç‚¹åŠ¨ä½œ

#### PA54 â€” ä¼ºæœä½¿èƒ½å»¶æ—¶å…³é—­æ—¶é—´

**å®šä¹‰**ï¼šå½“ä¼ºæœâ€œå¤±èƒ½â€ï¼ˆä½¿èƒ½ä¿¡å·å…³é—­ï¼‰åï¼Œå»¶è¿Ÿåˆ‡æ–­ç”µæœºç”µæµçš„æ—¶é—´ã€‚
**ä½œç”¨é˜¶æ®µ**ï¼šä¼ºæœä»â€œè¿è¡ŒçŠ¶æ€ â†’ åœæ­¢ä½¿èƒ½â€
**æ§åˆ¶ç›®æ ‡**ï¼šå»¶è¿Ÿåˆ‡æ–­ç”µæµï¼Œç»™æœºæ¢°åˆ¶åŠ¨å™¨åŠ¨ä½œæä¾›ç¼“å†²ã€‚ç”µæœºè¦**å»¶è¿Ÿä¸€æ®µæ—¶é—´åå†æ–­ç”µ**

ä½œç”¨ï¼š

- å¦‚æœç«‹å³æ–­ç”µï¼Œè€Œåˆ¶åŠ¨å™¨å°šæœªå¤¹ç´§ï¼Œç”µæœºä¼šå› æ— åŠ›çŸ©æ”¯æ’‘è€Œç§»åŠ¨æˆ–ä¸‹æ»‘
- æ‰€ä»¥è¦å…ˆåŠ¨ä½œåˆ¶åŠ¨å™¨ï¼Œç„¶åå†å»¶è¿Ÿæ–­ç”µï¼Œé¿å…å®‰å…¨éšæ‚£

å»ºè®®å€¼

- ä¸€èˆ¬è®¾ç½®ä¸º 50msï½150msï¼ˆ5ï½15 çš„è®¾å®šå€¼ï¼‰ï¼Œæ ¹æ®æœºæ¢°åˆ¶åŠ¨å™¨åŠ¨ä½œæ—¶é—´å†³å®š

#### PA94 â€” ç”µç£åˆ¶åŠ¨å™¨æ‰“å¼€å»¶æ—¶æ—¶é—´

> **å®šä¹‰**ï¼šç”µæœºä¸Šç”µï¼ˆåˆšåˆšä½¿èƒ½ï¼‰æ—¶ï¼Œä»**ç”µæµå¼€å¯**åˆ°**åˆ¶åŠ¨å™¨æ¾å¼€ï¼ˆBRK ONï¼‰**ä¹‹é—´çš„å»¶æ—¶æ—¶é—´ã€‚

âœ… åº”ç”¨åœºæ™¯ï¼š

- ç”µæœºä»å¤±èƒ½ â†’ ä½¿èƒ½è¿‡ç¨‹ä¸­ï¼Œå…ˆåŠ ç”µæµè®©è½¬å­äº§ç”ŸåŠ›çŸ©ï¼Œå†æ‰“å¼€åˆ¶åŠ¨å™¨
- é˜²æ­¢åˆ¶åŠ¨å™¨æ¾å¼€åç”µæœºâ€œæ‰ä¸‹æ¥â€æˆ–ç¬é—´è½¬åŠ¨

âœ… æ§åˆ¶é¡ºåºå¦‚ä¸‹ï¼š

1. ä¼ºæœè¢«â€œä½¿èƒ½â€
2. æ§åˆ¶å™¨**å…ˆé€ç”µæµ**ï¼ˆäº§ç”ŸåŠ›çŸ©ï¼‰
3. å»¶è¿Ÿä¸€æ®µæ—¶é—´å**æ‰æ¾å¼€åˆ¶åŠ¨å™¨**ï¼ˆBRK è¾“å‡ºä¸º ONï¼‰

è¿™ä¸ªâ€œå»¶è¿Ÿâ€çš„æ—¶é—´å°±æ˜¯ PA94ã€‚

â±ï¸ å»ºè®®å€¼ï¼š

- ä¸€èˆ¬è®¾ä¸º 50~150msï¼ˆ5ï½15ï¼‰
- æ ¹æ®å®é™…è´Ÿè½½ï¼ˆå°¤å…¶æ˜¯å‚ç›´è´Ÿè½½ï¼‰å†³å®šï¼Œä»¥ç¡®ä¿ç”µæœºå·²ç»å…·å¤‡æ”¯æ’‘åŠ›çŸ©å†æ¾åˆ¹è½¦

PA94 å¤ªå°ï¼Œåˆ¶åŠ¨å™¨æå‰æ¾å¼€ï¼Œç”µæœºè¿˜æ²¡å‡†å¤‡å¥½å°±è¢«â€œæ‹‰ç€åŠ¨â€ï¼Œç­‰äºâ€œæ²¡åŠ›æ°”å°±ä¸Šæˆ˜åœºâ€ï¼Œç”µæœºä¼šè¿‡è½½æŠ¥è­¦æˆ–éœ‡è¡ã€‚

### è´Ÿè½½æƒ¯é‡

ä¼°ç®—å®é™…è´Ÿè½½æƒ¯é‡ï¼ˆé€šè¿‡JOGè¿è¡Œè§‚å¯ŸåŠ å‡é€ŸæŠ–åŠ¨ï¼‰

### é™ä½å¢ç›Š

- ä½ç½®å¢ç›Šï¼ˆPA9ï¼‰ï¼šé»˜è®¤80ï¼Œé€‚å½“å‡å°ï¼ˆå¦‚60ï¼‰ã€‚
- é€Ÿåº¦å¢ç›Šï¼ˆPA5ï¼‰ï¼šé»˜è®¤150ï¼Œå‡å°è‡³100-120ã€‚

### è½¬çŸ©é™åˆ¶

ç¡®è®¤å¤–éƒ¨è½¬çŸ©é™åˆ¶å‚æ•°ï¼ˆPA34-PA37ï¼‰æ˜¯å¦è¿‡ä½ï¼ˆé»˜è®¤å€¼è§æ‰‹å†Œç¬¬64é¡µï¼‰ã€‚



## Err19

```bash
[ä½¿èƒ½ON] â†’ ç”µæœºä¸Šç”µï¼ˆæœ‰ç”µæµè¾“å‡ºï¼‰
          â†“ï¼ˆç­‰å¾… PA94 å»¶æ—¶ï¼‰
      BRK è¾“å‡ºON â†’ åˆ¶åŠ¨å™¨å¼€å§‹é‡Šæ”¾
                       â†“ï¼ˆä»åœ¨é‡Šæ”¾ä¸­ï¼‰
              æ§åˆ¶å™¨æå‰å‘å‡ºè¿åŠ¨æŒ‡ä»¤ â†’
              ç”µæœºå°è¯•è½¬åŠ¨ â†’
              æŠ¥è­¦ Err19ï¼šæŠ±é—¸æœªæ‰“å¼€

```

PA94 å»¶æ—¶æ—¶é—´å¿…é¡» < è¿åŠ¨å‘½ä»¤å“åº”å»¶è¿Ÿæ—¶é—´ã€‚

```text
ä½¿èƒ½ä¿¡å· ON
â†“
é©±åŠ¨å™¨ç»™ç”µæœºä¸Šç”µ â†’ ç”µæµå»ºç«‹ â†’ ç”µæœºäº§ç”Ÿæ‰­çŸ©
â†“
å»¶è¿Ÿä¸€æ®µæ—¶é—´ï¼ˆPA94 æ§åˆ¶ï¼‰â†’ åˆ¶åŠ¨å™¨é‡Šæ”¾ï¼ˆBRK ONï¼‰
â†“
ç³»ç»Ÿå‡†å¤‡å¥½è¿åŠ¨ â†’ æ§åˆ¶å™¨æ‰å¼€å§‹å‘è„‰å†²ï¼ˆæˆ–ä½ å»¶è¿Ÿå‘è„‰å†²ï¼‰
```

å¦‚ä½•ç¡®ä¿æŒ‡ä»¤è„‰å†²åœ¨æ¾é—¸ä¹‹åæ‰å‘å‡ºï¼Ÿ

## FPGAå¢ç›Š

åœ¨ä½ çš„ FPGA é¡¹ç›®ä¸­ï¼Œ`ADDR_GAIN_A` åˆ° `ADDR_GAIN_H` è¿™äº›å¯„å­˜å™¨å¾ˆå¯èƒ½å°±æ˜¯ç”¨æ¥æ§åˆ¶ ADCï¼ˆæ¨¡æ•°è½¬æ¢å™¨ï¼‰è¾“å…¥é€šé“çš„**æ¨¡æ‹Ÿå¢ç›Š**ã€‚

- **ADC å¢ç›Šæ§åˆ¶ï¼š** å½“ä½ å°†ä¸€ä¸ªæ¨¡æ‹Ÿä¿¡å·ï¼ˆæ¯”å¦‚æ¥è‡ªä¼ æ„Ÿå™¨æˆ–å¤–éƒ¨è®¾å¤‡çš„ç”µå‹ï¼‰è¾“å…¥åˆ° ADC è¿›è¡Œæ•°å­—è½¬æ¢æ—¶ï¼Œå¦‚æœåŸå§‹ä¿¡å·å¤ªå¼±ï¼ŒADC å¯èƒ½æ— æ³•å‡†ç¡®åœ°æ•è·å…¶ç»†èŠ‚ã€‚è¿™æ—¶ï¼Œé€šè¿‡è°ƒæ•´ ADC å‰ç«¯çš„å¢ç›Šç”µè·¯ï¼Œå¯ä»¥æ”¾å¤§è¿™ä¸ªå¾®å¼±çš„æ¨¡æ‹Ÿä¿¡å·ï¼Œä½¿å…¶è¾¾åˆ° ADC æœ€ä½³çš„è¾“å…¥èŒƒå›´ï¼Œä»è€Œæé«˜æµ‹é‡ç²¾åº¦å’Œä¿¡å™ªæ¯”ã€‚
- `gain_control` å‡½æ•°å°±æ˜¯æ ¹æ®ä½ è®¾ç½®çš„ç›®æ ‡å¢ç›Šå€¼ï¼ˆä»¥ dB ä¸ºå•ä½ï¼Œä¾‹å¦‚ 20dB, 40dBï¼‰ä»¥åŠæ¿å¡çš„ç‰¹æ€§å’Œæ ¡å‡†æ•°æ®ï¼Œè®¡ç®—å‡ºä¸€ä¸ªé€‚åˆå†™å…¥ FPGA å¢ç›Šå¯„å­˜å™¨ (`ADDR_GAIN_X`) çš„æ•°å­—ç¼–ç  (CODE)ã€‚è¿™ä¸ª CODE ä¼šå‘Šè¯‰ FPGA å†…éƒ¨çš„å¢ç›Šæ§åˆ¶æ¨¡å—ï¼Œåº”è¯¥å°†è¾“å…¥ä¿¡å·æ”¾å¤§å¤šå°‘å€ã€‚
- `calc_reparation` å‡½æ•°åˆ™æ˜¯ç”¨äºè®¡ç®—å¢ç›Šæ ¡å‡†å€¼ï¼Œå› ä¸ºå®é™…çš„æ¨¡æ‹Ÿå¢ç›Šç”µè·¯å¯èƒ½ä¸ä¼šå®Œå…¨è¾¾åˆ°ç†è®ºä¸Šçš„å¢ç›Šå€æ•°ï¼Œéœ€è¦é€šè¿‡æ ¡å‡†æ¥è¡¥å¿è¯¯å·®ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œä½ çš„ FPGA é¡¹ç›®ä¸­çš„â€œå¢ç›Šâ€å°±æ˜¯ä¸ºäº†ç¡®ä¿è¿›å…¥ ADC çš„æ¨¡æ‹Ÿä¿¡å·å¤„äºä¸€ä¸ªç†æƒ³çš„å¹…åº¦èŒƒå›´ï¼Œä»è€Œä¿è¯æ•°å­—è½¬æ¢çš„è´¨é‡å’Œç²¾åº¦ã€‚

## ä¿¡å·é‡‡é›†è·¯å¾„

**å…¸å‹çš„ä¿¡å·é‡‡é›†é“¾è·¯**ï¼šâ€œ**é€šé“ â†’ ADC â†’ FPGA**â€ã€‚

### é€šé“ -> ADC -> FPGA

- é€šé“ï¼ˆSensor Channelï¼‰ï¼šæ˜¯æ•°æ®çš„æ¥æºï¼Œæ˜¯ä¼ æ„Ÿå™¨æ¥å£ã€‚
-  ADCï¼ˆæ¨¡æ•°è½¬æ¢å™¨ï¼‰ï¼šæŠŠæ¨¡æ‹Ÿä¿¡å·å˜æˆæ•°å­—ã€‚ä¿¡å·ç¿»è¯‘å™¨ï¼šç”µå‹ â†’ æ•°å­—
- FPGAï¼šæ§åˆ¶ + è¿ç®— + æ¥å£ç®¡ç†ã€‚åšæ•°æ®å¤„ç†ï¼Œæ¯”å¦‚æ»¤æ³¢ã€è¡¥å¿ã€å»å™ªã€æ£€æµ‹ã€‚ç„¶åé€šè¿‡ PCIe ç­‰æ–¹å¼é€ç»™ä¸Šä½æœºï¼›

```bash
      æ¨¡æ‹Ÿä¿¡å·ï¼ˆä¼ æ„Ÿå™¨ï¼‰
           â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
é€šé“ â”€â–¶â”‚ ADCèŠ¯ç‰‡     â”‚â”€â”€â–º æ•°å­—é‡‡æ ·å€¼ï¼ˆå¦‚ 2053ï¼‰
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ FPGAé€»è¾‘å¤„ç† â”‚â”€â”€â–º æ•°æ®è¿‡æ»¤ã€è¡¥å¿ã€å¢ç›Šã€å‘é€
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
         ä¸»æœºè½¯ä»¶ï¼ˆPCï¼‰
```

### ä¸ºä»€ä¹ˆè¦æœ‰ gain[]ï¼ˆå¢ç›Šï¼‰

#### åŸå› ï¼šä¸åŒé€šé“ï¼Œä¿¡å·å¼ºåº¦ä¸ä¸€æ ·

- æœ‰çš„ä¼ æ„Ÿå™¨è¾“å‡º 0.01V ï½ 0.1Vï¼›
- æœ‰çš„è¾“å‡º 0 ï½ 3.3Vï¼›
- ADC çš„è¾“å…¥èŒƒå›´æ˜¯å›ºå®šçš„ï¼ˆæ¯”å¦‚ 0 ï½ 3.3Vï¼‰ï¼›

æ‰€ä»¥å¿…é¡»å¯¹ä¿¡å·è¿›è¡Œâ€œæ”¾å¤§æˆ–è¡°å‡â€æ“ä½œï¼Œè®©å®ƒåˆšå¥½è½åœ¨ ADC å¯ç”¨èŒƒå›´å†…ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åˆ†è¾¨ç‡æœ€å¤§ã€ä¸ä¼šå¤±çœŸã€‚

#### gain çš„å®é™…æ“ä½œ

åœ¨ FPGA ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ä¹˜æ³•å™¨ç»™æ¯ä¸ªé€šé“çš„å€¼ä¹˜ä¸Šä¸€ä¸ªå¢ç›Šç³»æ•°ï¼š

```C
val = raw_adc[ch];
val = val * gain[ch];  // gain[ch] æ˜¯æ¯”ä¾‹å› å­ï¼Œæ¯”å¦‚ 1.5ã€2.0ã€0.75
```

è¿™å«åšâ€œ**æ•°å­—å¢ç›Šè¡¥å¿**â€æˆ–è€…â€œè½¯ä»¶å¢ç›Šâ€ã€‚

### reparation[][] æ˜¯å¹²å˜›çš„ï¼Ÿ

#### åŸå› 

é‡‡æ ·ç»“æœå¸¸å¸¸ä¸å®Œç¾

ç°å®ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªé€šé“å¯èƒ½æœ‰è¿™äº›é—®é¢˜ï¼š

- å›ºå®šåç§»ï¼ˆOffsetï¼‰ï¼›
- é€šé“é—´æ—¶åºä¸ä¸€è‡´ï¼ˆDelayï¼‰ï¼›
- é€šé“ç”µè·¯ä¸å®Œå…¨ä¸€æ ·ï¼ˆå¤±é…ï¼‰ï¼›

æ‰€ä»¥ä½ éœ€è¦åŠ ä¸€ä¸ª **ä¿®æ­£å€¼**ï¼ŒæŠŠæµ‹é‡æ•°æ®å¾®è°ƒä¸€ä¸‹ï¼š

```C
val = val * gain[ch];          // æ”¾å¤§æˆ–ç¼©å°ä¿¡å·
val = val + reparation[0][ch]; // åŠ ä¸€ä¸ªè¡¥å¿ä¿®æ­£å€¼
```

è¿™ä¸ªä¿®æ­£å€¼å¯èƒ½æ˜¯ä»ï¼š

- å®éªŒæ ‡å®šå¾—åˆ°çš„ï¼›
- ç”µè·¯åˆ†æä¸­è®¡ç®—çš„ï¼›
- è½¯ä»¶é…ç½®ä¸­è®¾å®šçš„ã€‚

### ç†è§£ä¸¤è€…å…³ç³»

| é¡¹ç›®     | gain[]          | reparation[][]     |
| -------- | --------------- | ------------------ |
| æ„ä¹‰     | æ§åˆ¶â€œæ”¾å¤§/ç¼©å°â€ | æ§åˆ¶â€œåŠ /å‡åç§»â€    |
| æ‰€åœ¨é˜¶æ®µ | æ•°æ®å¤„ç†æœ€å‰é¢  | å¢ç›Šåï¼Œä¿®æ­£ä¹‹å‰   |
| ä½¿ç”¨æ–¹å¼ | `value * gain`  | `value + repair`   |
| æ ¡å‡†ç›®çš„ | å¯¹é½ä¿¡å·å¹…åº¦    | ä¿®æ­£é‡‡æ ·è¯¯å·®       |
| æ˜¯å¦å¿…é¡» | é€šå¸¸å¿…é¡»        | é€‰é…ï¼ˆé«˜ç²¾åº¦æ‰ç”¨ï¼‰ |

åœ¨ â€œé€šé“ â†’ ADC â†’ FPGAâ€ çš„é‡‡é›†é“¾è·¯ä¸­ï¼Œ**gain[] æ˜¯ä¿¡å·æ”¾å¤§å™¨ï¼Œreparation[][] æ˜¯è¯¯å·®ä¿®æ­£å™¨**ã€‚ä»–ä»¬å…±åŒä½œç”¨ï¼Œè®©ä½ é‡‡é›†åˆ°çš„ä¿¡å·**æ›´å¤§ã€æ›´å‡†ã€æ›´çœŸå®**ã€‚

# 7.5

## æ›´å¤šå¢ç›ŠæŒ¡ä½

ç°åœ¨éœ€è¦å°†**`reparation[3][MAX_CHN_CNT]` å‡çº§ä¸ºæ”¯æŒæ›´å¤šå¢ç›Šæ¡£ä½ï¼ˆå¦‚ï¼š-20 åˆ° 40 dBï¼‰**ï¼Œå¹¶èƒ½ä» `.ini` é…ç½®æ–‡ä»¶ä¸­è¯»å†™è¿™äº›æ ¡å‡†å€¼ã€‚

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ç»“æ„ä½“ `user_cfg_t`

æŠŠåŸæ¥çš„ `reparation[3][MAX_CHN_CNT]` **æ‰©å±•æˆ 8 ä¸ª gain æ¡£**ï¼š

```C
#define MAX_CHN_CNT 8
#define GAIN_CAL_CNT 8

// æ”¯æŒçš„å¢ç›Šå€¼é›†åˆï¼ˆå»ºè®®ç»Ÿä¸€æ”¾ä¸€ä¸ªåœ°æ–¹å£°æ˜ï¼‰
static const int g_supported_gain_db[GAIN_CAL_CNT] = { -20, -10, -6, 0, 6, 20, 30, 40 };

typedef struct user_cfg_s {
  uint32_t  debug;
  uint32_t  storage;
  uint32_t  sampleRate;
  uint32_t  bitWidth;
  int findPulseMult;
  int findPulseOff;
  uint32_t  gain[MAX_CHN_CNT];

  int32_t reparation[GAIN_CAL_CNT][MAX_CHN_CNT];  // ä¿®æ”¹ï¼š8ä¸ªå¢ç›Š Ã— 8é€šé“

  uint64_t  pcieBarAddr[PCIE_BARCNT];
  uint32_t  pcieBarSize[PCIE_BARCNT];
  int32_t   pcieBarWidth[PCIE_BARCNT];

} user_cfg_t;
```

### ç¬¬äºŒæ­¥ï¼šå¦‚ä½•è·å–è¡¥å¿å€¼

å°è£…ä¸€ä¸ªå‡½æ•°ï¼š

```C
/**
 * @brief è·å–æŒ‡å®šé€šé“çš„å¢ç›Šè¡¥å¿å€¼ã€‚
 * æ ¹æ®ç”¨æˆ·é…ç½®å’Œå¢ç›Šæ¡£ä½ï¼Œè¿”å›å¯¹åº”é€šé“çš„è¡¥å¿å€¼ã€‚
 * @param cfg æŒ‡å‘ç”¨æˆ·é…ç½®ç»“æ„ä½“çš„æŒ‡é’ˆã€‚
 * @param gain_db å¢ç›Šå€¼ (dB)ã€‚
 * @param chn é€šé“å· (0 åˆ° MAX_CHN_CNT-1)ã€‚
 * @return è¡¥å¿å€¼ï¼Œå¦‚æœæœªæ‰¾åˆ°åŒ¹é…åˆ™è¿”å›0ã€‚
 */
int get_reparation(const user_cfg_t* cfg, int gain_db, int chn) {
  // å‚æ•°æ ¡éªŒ
  if (cfg == NULL) {
      ERR_LOG("Configuration pointer (cfg) is NULL for get_reparation.\n");
      return 0;
  }
  if (chn < 0 || chn >= MAX_CHN_CNT) {
      ERR_LOG("Invalid channel number %d for get_reparation. Must be 0 to %d.\n", chn, MAX_CHN_CNT - 1);
      return 0;
  }

  // éå†æ”¯æŒçš„å¢ç›Šæ¡£ä½ï¼ŒæŸ¥æ‰¾åŒ¹é…çš„ç´¢å¼•
  for (int i = 0; i < GAIN_CAL_CNT; ++i) {
      if (g_supported_gain_db[i] == gain_db) {
          // æ‰¾åˆ°åŒ¹é…çš„å¢ç›Šæ¡£ä½ï¼Œè¿”å›å¯¹åº”é€šé“çš„è¡¥å¿å€¼
          INFO_LOG("Found reparation for gain %d dB, channel %d: %d\n", gain_db, chn, cfg->reparation[i][chn]);
          return cfg->reparation[i][chn];
      }
  }
  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¢ç›Šæ¡£ä½ï¼Œåˆ™è¿”å›0è¡¥å¿
  INFO_LOG("No matching gain_db %d found in g_supported_gain_db. Returning 0 reparation.\n", gain_db);
  return 0;
}
```

ç„¶ååœ¨ `gain_control()` ä¸­æ›¿æ¢åŸæ¥çš„ï¼š

```C
int rep = get_reparation(cfg, gain, chn);
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ–‡ä»¶æ ¼å¼ `.ini`

```ini
[adc]
reparation_-20=12,15,14,10,13,11,12,14
reparation_-10=8,7,9,6,7,8,9,7
reparation_-6=4,5,4,5,4,5,4,5
reparation_0=0,0,0,0,0,0,0,0
reparation_6=-2,-1,-1,-2,-2,-1,-1,-2
reparation_20=-10,-10,-10,-10,-10,-10,-10,-10
reparation_30=-15,-15,-15,-15,-15,-15,-15,-15
reparation_40=-20,-20,-20,-20,-20,-20,-20,-20
```

### ç¬¬å››æ­¥ï¼šè¯»å– reparation æ•°ç»„ï¼ˆåŠ è½½é…ç½®å‡½æ•°ï¼‰

```C
int load_reparation_from_ini(user_cfg_t* cfg, const char* ini_path) {
  for (int i = 0; i < GAIN_CAL_CNT; ++i) {
    int gain = g_supported_gain_db[i];
    char key[64];
    snprintf(key, sizeof(key), "adc:reparation_%d", gain);

    const char* val = ini_get_string(ini_path, key, NULL); // ç”¨ä½ ç”¨çš„ ini åº“API
    if (!val) {
      fprintf(stderr, "Missing key for gain %d\n", gain);
      return -1;
    }

    for (int chn = 0; chn < MAX_CHN_CNT; ++chn) {
      char* endptr;
      cfg->reparation[i][chn] = strtol(val, &endptr, 10);
      if (chn < MAX_CHN_CNT - 1 && *endptr != ',') return -2;
      val = endptr + 1;
    }
  }
  return 0;
}
```

### ç¬¬äº”æ­¥ï¼šå†™å› `.ini` æ–‡ä»¶ï¼ˆä¿å­˜é…ç½®ï¼‰

```c
int save_reparation_to_ini(const user_cfg_t* cfg, const char* ini_path) {
  for (int i = 0; i < GAIN_CAL_CNT; ++i) {
    int gain = g_supported_gain_db[i];
    char key[64], val[256] = {0};
    snprintf(key, sizeof(key), "reparation_%d", gain);

    for (int chn = 0; chn < MAX_CHN_CNT; ++chn) {
      char tmp[16];
      snprintf(tmp, sizeof(tmp), "%d", cfg->reparation[i][chn]);
      strcat(val, tmp);
      if (chn < MAX_CHN_CNT - 1) strcat(val, ",");
    }

    ini_set_string("adc", key, val);  // å–å†³äºä½ ä½¿ç”¨çš„ ini åº“
  }

  ini_save_to_file(ini_path);  // ä¿å­˜
  return 0;
}
```

## è°ƒæ•´æµ‹è¯•æ¡†æ¶

ç°åœ¨éœ€è¦åŠ å…¥å…¶ä»–æ¨¡å—çš„æµ‹è¯•ã€‚ä¾‹å¦‚`app/cfg.c`çš„æµ‹è¯•ã€‚ä½†æ˜¯ç°åœ¨èƒ½åšçš„åªæ˜¯å°†`dev/fpga.c`çš„æµ‹è¯•åŠ å…¥è¿›å»äº†ã€‚ç°åœ¨`test/`ç›®å½•ä¸‹çš„ç»“æ„ä¸ºï¼š

```bash
forlinx@ubuntu:~/work/pcieCollector/test$ tree
.
â”œâ”€â”€ fpga_mock.c
â”œâ”€â”€ fpga_mock.h
â”œâ”€â”€ fpga_test.c
â””â”€â”€ Makefile

0 directories, 4 files
```

å¯¹åº”Makefileä¸º

```makefile
CC = gcc
CFLAGS += -I../dev -I../i2c -I. -I.. -Wall -g
LIBS = -lm

SRCS = fpga_test.c fpga_mock.c ../dev/fpga.c ../commdef.c ../i2c/user_i2c.c
OBJS = fpga_test.o fpga_mock.o ../dev/fpga.o ../commdef.o ../i2c/user_i2c.o

TARGET = fpga_test

# é»˜è®¤ä½¿ç”¨å¤šçº¿ç¨‹ï¼ˆ-j8ï¼‰ç¼–è¯‘ï¼Œç„¶åæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶
.PHONY: all run clean

all: $(TARGET) run

$(TARGET): $(OBJS)
	$(CC) -o $@ $^ $(LIBS)

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

run: $(TARGET)
	./$(TARGET)

clean:
	rm -f $(OBJS) $(TARGET)
```

ç°åœ¨è¦è°ƒæ•´çš„æ˜¯ï¼ŒæŒ‰ç…§ä¸åŒçš„æ¨¡å—ï¼ŒåŠ å…¥å¯¹åº”çš„æµ‹è¯•ã€‚

ä¾‹å¦‚ç°åœ¨çš„æ•´ä½“ç›®å½•ç»“æ„ï¼š

```bash
forlinx@ubuntu:~/work/pcieCollector$ tree
.
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ calc.c
â”‚   â”œâ”€â”€ calc.h
â”‚   â”œâ”€â”€ cfg.c
â”‚   â”œâ”€â”€ cfg.h
â”‚   â”œâ”€â”€ datasend.c
â”‚   â”œâ”€â”€ datasend.h
â”‚   â”œâ”€â”€ dealcmd.c
â”‚   â””â”€â”€ dealcmd.h
â”œâ”€â”€ collecter_ver
â”œâ”€â”€ collector.sh
â”œâ”€â”€ commdef.c
â”œâ”€â”€ commdef.h
â”œâ”€â”€ dev
â”‚   â”œâ”€â”€ fpga.c
â”‚   â”œâ”€â”€ fpga.h
â”‚   â””â”€â”€ fpga_io.h
â”œâ”€â”€ i2c
â”‚   â”œâ”€â”€ i2c-dev.h
â”‚   â”œâ”€â”€ user_i2c.c
â”‚   â””â”€â”€ user_i2c.h
â”œâ”€â”€ libs
â”‚   â”œâ”€â”€ libfftw3.a
â”‚   â””â”€â”€ libfftw3.la
â”œâ”€â”€ main.c
â”œâ”€â”€ Makefile
â”œâ”€â”€ pcie
â”‚   â”œâ”€â”€ user_pcie.c
â”‚   â””â”€â”€ user_pcie.h
â”œâ”€â”€ test
â”‚   â”œâ”€â”€ fpga_mock.c
â”‚   â”œâ”€â”€ fpga_mock.h
â”‚   â”œâ”€â”€ fpga_test.c
â”‚   â””â”€â”€ Makefile
â”œâ”€â”€ three_src
â”‚   â”œâ”€â”€ cJSON.c
â”‚   â”œâ”€â”€ cJSON.h
â”‚   â”œâ”€â”€ dictionary.c
â”‚   â”œâ”€â”€ dictionary.h
â”‚   â”œâ”€â”€ fftw3.h
â”‚   â”œâ”€â”€ filelock.c
â”‚   â”œâ”€â”€ filelock.h
â”‚   â”œâ”€â”€ iniparser.c
â”‚   â””â”€â”€ iniparser.h
â””â”€â”€ version.h
```

æˆ‘ç°åœ¨å°±æƒ³åŠ å…¥`app/cfg.c`çš„æµ‹è¯•ï¼Œæˆ‘è¯¥æ€ä¹ˆè§„åˆ’æ ·å¼å’Œä¿®æ”¹makefileï¼Ÿ

### 1.åˆ›å»ºç›®å½•ç»“æ„

æ ¹æ®ä¸åŒæ¨¡å—ï¼ŒåŠ å…¥ä¸åŒçš„æµ‹è¯•æ¨¡å—

```bash
test/
â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ fpga_test.c
â”‚   â”œâ”€â”€ fpga_mock.c
â”‚   â””â”€â”€ fpga_mock.h
â”œâ”€â”€ app/
â”‚   â””â”€â”€ cfg_test.c
â”œâ”€â”€ Makefile
```

### 2.æ™ºèƒ½ Makefile

| åŠŸèƒ½                                       | å®ç° |
| ------------------------------------------ | ---- |
| è‡ªåŠ¨æ‰«æå­ç›®å½•ï¼ˆå¦‚ `dev/`, `app/`ï¼‰        | âœ…    |
| æ”¯æŒ `make test MODULE=dev`                | âœ…    |
| æ”¯æŒ `make all` ç¼–è¯‘æ‰€æœ‰æ¨¡å—æµ‹è¯•           | âœ…    |
| æ”¯æŒ `make run MODULE=app` è‡ªåŠ¨è¿è¡Œæµ‹è¯•    | âœ…    |
| æ”¯æŒ `make clean` æ¸…ç†æ‰€æœ‰å¯¹è±¡ä¸å¯æ‰§è¡Œæ–‡ä»¶ | âœ…    |

```bash
# test/Makefile

CC = gcc
CFLAGS = -Wall -g \
  -I../ -I../dev -I../app -I../i2c -I../three_src

LIBS = -lm

# æ‰€æœ‰æ¨¡å—ç›®å½•ï¼ˆè‡ªåŠ¨éå† test/ ä¸‹çš„ç›®å½•ï¼‰
MODULES := $(shell find . -maxdepth 1 -type d ! -name '.' | sed 's|./||')

# ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰‹åŠ¨æŒ‡å®šæ¯ä¸ªæµ‹è¯•ç¨‹åºçš„ä¾èµ–æºæ–‡ä»¶
# key = target, value = source filesï¼ˆæ”¯æŒå¤šè¡Œï¼‰
SOURCES_dev/fpga_test = \
  dev/fpga_test.c \
  dev/fpga_mock.c \
  ../dev/fpga.c \
  ../i2c/user_i2c.c \
  ../commdef.c

SOURCES_app/cfg_test = \
  app/cfg_test.c \
  ../app/cfg.c \
  ../three_src/iniparser.c \
  ../three_src/dictionary.c \
  ../commdef.c

# è‡ªåŠ¨æ”¶é›†æ‰€æœ‰æµ‹è¯•ç›®æ ‡
TARGETS := $(patsubst SOURCES_%, %, $(filter SOURCES_%, $(.VARIABLES)))

# é»˜è®¤æ„å»ºæ‰€æœ‰æµ‹è¯•ç›®æ ‡
.PHONY: all clean run test $(TARGETS)

all: $(TARGETS)

# æ„å»ºè§„åˆ™ï¼šæ¯ä¸ª target ä½¿ç”¨å…¶ SOURCES_$(target) ä¸­åˆ—å‡ºçš„æºæ–‡ä»¶
$(TARGETS):
	@echo "Building test: $@"
	$(CC) $(CFLAGS) $(SOURCES_$@) -o $@ $(LIBS)

# æŒ‡å®šæ¨¡å—æµ‹è¯•ï¼Œå¦‚ make test MODULE=dev
test:
ifndef MODULE
	@echo "Usage: make test MODULE=dev"
	@exit 1
endif
	@echo "Building tests under module: $(MODULE)"
	@$(MAKE) $(addprefix $(MODULE)/, $(notdir $(basename $(wildcard $(MODULE)/*_test.c))))

# æŒ‡å®šæ¨¡å—è¿è¡Œï¼Œå¦‚ make run MODULE=app
run:
ifndef MODULE
	@echo "Usage: make run MODULE=app"
	@exit 1
endif
	@echo "Running test for module $(MODULE)"
	@target=$$(basename $$(find $(MODULE) -type f -name '*_test')); \
	if [ -x $(MODULE)/$$target ]; then ./$(MODULE)/$$target; else echo "Target not built: $(MODULE)/$$target"; fi

# æ¸…ç†å¯¹è±¡å’Œå¯æ‰§è¡Œæ–‡ä»¶
clean:
	@echo "Cleaning..."
	rm -f */*.o */*_test

```

ä½¿ç”¨ç¤ºä¾‹ï¼š

```makefile
cd test

# æ„å»ºæ‰€æœ‰æ¨¡å—æµ‹è¯•
make all

# æ„å»ºæŒ‡å®šæ¨¡å—ï¼ˆå¦‚ devï¼‰ä¸‹çš„æ‰€æœ‰ _test.c
make test MODULE=dev

# æ„å»ºå¹¶è¿è¡Œ app/cfg_test
make test MODULE=app
make run MODULE=app

# æ¸…ç†å…¨éƒ¨æµ‹è¯•æ„å»ºäº§ç‰©
make clean
```

## å®é™…ç¡¬ä»¶æµ‹è¯•æ–¹æ³•

ç°åœ¨è¦å°†æˆå“æ”¾åœ¨çœŸæ­£çš„ä¸»æœºä¸Šè¿›è¡Œæµ‹è¯•äº†ã€‚æˆ‘åº”è¯¥æŒ‰ç…§ä»€ä¹ˆæ¥å»è®¾è®¡ä¸»ç¨‹åºï¼Œä»¥æ­¤æ¥æ£€æµ‹ç¨‹åºåœ¨ç¡¬ä»¶è¿è¡Œçš„æ­£ç¡®æ€§å‘¢ï¼Ÿ

### æ”¹å†™çŠ¶æ€

é¦–å…ˆï¼Œéœ€è¦æ”¹å†™fpgaå¯„å­˜å™¨çš„çŠ¶æ€æ¥å®ç°ç›¸åº”çš„åŠŸèƒ½ã€‚

ç›®æ ‡æ˜¯ï¼šåœ¨ `main()` ä¸­ç›´æ¥è°ƒç”¨ `fpga.h` ä¸­å®šä¹‰çš„åŠŸèƒ½å‡½æ•°ï¼Œæµ‹è¯•å¯„å­˜å™¨çŠ¶æ€å˜åŒ–æ˜¯å¦å¦‚é¢„æœŸã€‚å¯ä»¥åœ¨`fpga.c`ä¸­å®ç°äº†FPGAå¯„å­˜å™¨æµ‹è¯•è°ƒåº¦å‡½æ•°ï¼š

```C
void fpga_test_dispatch(int reg, int val)
{
  printf("FPGAå¯„å­˜å™¨æµ‹è¯•ï¼šreg=0x%02X, val=0x%X\n", reg, val);

  switch (reg) {
  case FPGA_REG_COLLECT_EN:
    if (val)
      fpga_collect_enable();
    else
      fpga_collect_disable();
    break;

  case FPGA_REG_DEV_RST:
    // è®¾å¤‡å¤ä½ï¼Œå†™0è§¦å‘å¤ä½
    fpga_reg_write(FPGA_REG_DEV_RST, 0);
    break;
    ...
}
```

#### æ‰©å±•å‘½ä»¤è¡Œå‚æ•°

åœ¨mainå‡½æ•°ä¸­ï¼ŒåŠ å…¥ï¼š

```C
static const struct option long_options [] = {
  { "help",        no_argument,       NULL, 'h' },
  { "listenport",  required_argument, NULL, 'l' },
  { "sendport",    required_argument, NULL, 'p' },
  { "fpga",        required_argument, NULL, 'f' },  // æ–°å¢fpgaæµ‹è¯•å‚æ•°
  { 0, 0, 0, 0 }
};

static const char short_options [] = "hl:p:f:";
```

#### æ·»åŠ è§£æé€»è¾‘å¹¶æ‰§è¡Œå¯¹åº”æ“ä½œ

åœ¨ `main()` å‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼ˆæ”¾åˆ° `while((option = getopt_long(...))` çš„ `switch` ä¸­ï¼‰ï¼š

```C
int fpga_test = 0;
int fpga_arg1 = -1, fpga_arg2 = -1;
...
case 'f':
  fpga_test = 1;
  if(optind < argc - 1) {
    fpga_arg1 = atoi(optarg);      // å¯„å­˜å™¨ç´¢å¼•
    fpga_arg2 = atoi(argv[optind]); // æ“ä½œå€¼
  } else {
    printf("ç”¨æ³•: -f <reg_index> <value>\n");
    return -1;
  }
  break;

```

### è¯»å–çŠ¶æ€

åœ¨ç¡¬ä»¶ä¸­ï¼Œæœ‰ä¸“é—¨çš„fpgaå¯„å­˜å™¨æ£€æµ‹ç¨‹åº`fpga`ï¼Œå…¶ä½¿ç”¨æ–¹æ³•æ˜¯

```bash
root@localhost:~# fpga -h
Usage: fpga [options]

Options:
 -h | --help                 Print this message
 -r | --read                 read fpga
 -w | --write                write fpga
 -R | --commrd               i2c common read
 -W | --commwr               i2c common write
```

å…¶ä¸­è¯»å–å¯„å­˜å™¨çš„æ–¹æ³•ä¸º

```bash
./fpga -r 0x1
```

### å¯¹æ¯”ç»“æœ

# 7.7

ç°åœ¨æœ‰ç‚¹å¤´ç—›ï¼Œå¯èƒ½æ„Ÿå†’äº†æœ‰ç‚¹ã€‚æ‰€ä»¥ç°åœ¨è„‘å­å¾ˆæ··ä¹±ã€‚

## å‡ºé—®é¢˜çš„adc_reset

æˆ‘ç°åœ¨é‡åˆ°çš„é—®é¢˜æ˜¯ï¼Œåœ¨æ‰§è¡Œ`adc_reset()`çš„æ—¶å€™ï¼ŒæŠ¥é”™å†™å…¥æ•°æ®å’Œè¯»å–æ•°æ®ä¸ä¸€è‡´

```bash
 [ERROR][fpga_reg_safe_write](42)Verification failed for register 0x07. Wrote 0x00000803, Read back 0x00000000. Retrying...
```

è¿™æ˜¯ç”±äºå‘å¯„å­˜å™¨`0x07`å†™`0x803`çš„æ—¶å€™ï¼Œè·å–çš„å€¼å’Œè¯»å–çš„å€¼ä¸ä¸€è‡´å¯¼è‡´çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯»å–çš„å€¼æ˜¯`0x0`ã€‚æ­¤æ—¶çœ‹å¯„å­˜å™¨æè¿°ï¼š

```bash
write only
```

å¥½å§ï¼Œç›´æ¥ä½¿ç”¨`fpga_reg_write`è€Œä¸æ˜¯`fpga_reg_safe_write`å³å¯ã€‚

### è§£å†³åŠæ³•

å°†æ‰€æœ‰æ¶‰åŠåˆ°åªå†™å¯„å­˜å™¨çš„`FPGA_REG_ADC_WRITE`çš„å†™æ–¹æ³•ï¼Œæ”¹ä¸ºæ­£å¸¸çš„`fpga_write()`

------



# 7.8

## gain_control

ç°åœ¨æƒ³è¦æµ‹è¯•`gain_control()`çš„æ­£ç¡®æ€§ã€‚

æˆ‘éœ€è¦æ€ä¹ˆæ‰èƒ½æµ‹è¯•æ­£ç¡®æ€§å‘¢ï¼Ÿ

### é€»è¾‘

1. `gain_control()`é¦–å…ˆæ ¹æ®å½“å‰çš„é€šé“ï¼Œè·å–é…ç½®ä¿¡æ¯è¡¨`g_app_cfgctrl->cfg`ä¸­çš„æ•°æ®

   ```C
   int gain = cfg->gain[chn]; // è·å–æŒ‡å®šé€šé“çš„æ ‡ç§°å¢ç›Šå€¼
   reparation = cfg->reparation[i][chn];
   ```

2. è·å–å½“å‰fpgaç‰ˆæœ¬ï¼Œæ ¹æ®ç‰ˆæœ¬è·å–å¢ç›Šå‚è€ƒå¸¸æ•°`gain_ref_const`

   ```C
   if (board_type == 0) {}
   ```

3. å°†ä¹‹å‰è·å–åˆ°çš„æ•°æ®ï¼Œè¿›è¡Œè®¡ç®—ï¼Œå¹¶å°†å…¶æ”¾åœ¨FPGAå¢ç›Šå¯„å­˜å™¨`gain_reg_addr`

   ```C
   uint16_t gain_reg_addr = AD_GAIN_CH(chn);
   ```

æ‰€ä»¥æˆ‘ç°åœ¨éœ€è¦ä¿®æ”¹ï¼š

- é€šé“
- å¯¹åº”é€šé“çš„gainå’Œreparation
- æ¿ç±»å‹

ç„¶åæ£€æµ‹FPGAçš„å¢ç›Šå¯„å­˜å™¨æ˜¯å¦è·å–äº†æ­£ç¡®çš„æ•°æ®ã€‚

### æµ‹è¯•ç¨‹åº

é€šé“ä»1åˆ°8ã€‚

> å‡è®¾æ¿å¡ç±»å‹ä¸º 0ï¼Œå¢ç›Šè®¾ç½®å¦‚ä¸‹ï¼š
>
> - **é€šé“ 1**: å¢ç›Š 6 dBï¼Œå¸¸æ•° 87.57ï¼Œè®¡ç®—ç»“æœï¼š
>
>   $RAW=(87.57âˆ’6)Ã—4096/100=3341.11$
>
>   æ ¡å‡†å€¼ 0ï¼Œæœ€ç»ˆä»£ç å€¼ä¸º 3341ï¼ˆ0xD0Dï¼‰ã€‚
>
> - **é€šé“ 2**: å¢ç›Š -20 dBï¼Œå¸¸æ•° 87.57ï¼Œè®¡ç®—ç»“æœï¼š
>
>   $RAW=(87.57+20)Ã—4096/100=4406.07$
>
>   æ ¡å‡†å€¼ 5ï¼Œæœ€ç»ˆä»£ç å€¼ä¸º 4401ï¼ˆ0xACAï¼‰ã€‚
>
> - **é€šé“ 3**: å¢ç›Š 30 dBï¼Œå¸¸æ•° 87.57ï¼Œè®¡ç®—ç»“æœï¼š
>
>   $RAW=(87.57âˆ’30)Ã—4096/100=2358.07$
>
>   æ ¡å‡†å€¼ -3ï¼Œæœ€ç»ˆä»£ç å€¼ä¸º 2361ï¼ˆ0x939ï¼‰ã€‚
>
> ```bash
> [adc]
> reparation_-20=0,5,0,0,0,0,0,0
> reparation_-10=0,0,0,0,0,0,0,0
> reparation_-6=0,0,0,0,0,0,0,0
> reparation_0=0,0,0,0,0,0,0,0
> reparation_6=0,0,0,0,0,0,0,0
> reparation_20=0,0,0,0,0,0,0,0
> reparation_30=0,0,-3,0,0,0,0,0
> reparation_40=0,0,0,0,0,0,0,0
> ```
>
> å‡è®¾æ¿ç±»å‹ä¸º1ï¼Œå¢ç›Šè®¾ç½®å¦‚ä¸‹ï¼š
>
> - é€šé“2ï¼šå¢ç›Š0dbï¼Œå¸¸æ•°61.9726ï¼Œè®¡ç®—ç»“æœ
>
>   $RAW = (61.9726 - 0)Ã—4096/100 = 2538.40$
>
>   æ ¡å‡†å€¼ä¸º5dbï¼Œæœ€ç»ˆä»£ç å€¼ä¸º2533ï¼ˆ0x9E5ï¼‰
>
> - é€šé“3ï¼šå¢ç›Š20dBï¼Œå¸¸æ•°61.9726ï¼Œè®¡ç®—ç»“æœ
>
>   $RAW = (61.9726 - 20)Ã—4096/100 = 1719.20$
>
>   æ ¡å‡†å€¼-3dBï¼Œæœ€ç»ˆä»£ç å€¼ä¸º1722ï¼ˆ0x6BAï¼‰
>
> - é€šé“4ï¼šå¢ç›Š40dBï¼Œå¸¸æ•°61.9726ï¼Œè®¡ç®—ç»“æœ
>
>   $RAW = (61.9726 - 40)Ã—4096/100 = 900.00$
>
>   æ ¡å‡†å€¼2dBï¼Œæœ€ç»ˆä»£ç ä¸º898ï¼ˆ0x382ï¼‰
>
> å¯¹åº”çš„`config.ini`é…ç½®
>
> ```bash
> [adc]
> reparation_-20=0,0,0,0,0,0,0,0
> reparation_-10=0,0,0,0,0,0,0,0
> reparation_-6=0,0,0,0,0,0,0,0
> reparation_0=0,5,0,0,0,0,0,0
> reparation_6=0,0,0,0,0,0,0,0
> reparation_20=0,0,-3,0,0,0,0,0
> reparation_30=0,0,0,0,0,0,0,0
> reparation_40=0,0,0,2,0,0,0,0
> ```

å¯ä»¥ï¼Œæœ€ç»ˆç»“æœæ˜¯æ²¡é—®é¢˜çš„ã€‚

## Err13

æ˜¨æ™šåˆæ˜¯æ— æ•Œè§£å†³ç”µæœºé—®é¢˜çš„ä¸€æ™šã€‚

ç°åœ¨æ°´æ± æš‚æ—¶ä¸æµ‹è¯•ï¼Œéœ€è¦æ€¥äºè§£å†³çš„é—®é¢˜æ˜¯ï¼šæ—‹è½¬ç”µæœºä½ç½®ç§»åŠ¨çš„è¿è¡Œè¿‡ç¨‹ä¸­æŠ¥é”™Err13çš„é—®é¢˜ã€‚ç°åœ¨æŒ‰ç…§æ‰‹å†Œï¼Œå°†å¯èƒ½çš„åŸå› ç½—åˆ—ä¸€ä¸‹ã€‚

### è¶…è¿‡é¢å®šè½¬çŸ©è¿è¡Œ

1. æ£€æŸ¥è´Ÿè½½ã€‚
2. é™ä½èµ·åœé¢‘ç‡ã€‚
3. å‡å°‘è½¬çŸ©é™åˆ¶å€¼ã€‚
4. æ¢æ›´å¤§åŠŸç‡é©±åŠ¨å™¨å’Œç”µæœº

#### æ—‹è½¬ç”µæœºè½¬çŸ©

é¦–å…ˆå°±æ˜¯è®¡ç®—æ—‹è½¬ç”µæœºçš„è½¬çŸ©ã€‚ï¼ˆè¿™ä¸ªå› ä¸ºæ¶‰åŠåˆ°å¾ˆå¤šçŸ¥è¯†ï¼Œå°±å…ˆæš‚æ—¶æ”¾ä¸€ä¸‹ï¼Œå…ˆè§£å†³å…¶ä»–å¯èƒ½çš„æƒ…å†µã€‚ï¼‰

#### å¯åœé¢‘ç‡

ä»€ä¹ˆæ˜¯å¯åœé¢‘ç‡ï¼Ÿæ˜¯ç”µæœºåœ¨å•ä½æ—¶é—´å†…å¯åŠ¨å’Œåœæ­¢çš„æ¬¡æ•°ã€‚

**é™ä½å¯åœé¢‘ç‡å¸¦æ¥çš„å½±å“**ï¼š

1. **ä¼˜åŒ–è¿åŠ¨æ›²çº¿**ï¼šå°½é‡å‡å°‘ä¸å¿…è¦çš„å¯åœï¼Œå¯ä½¿ç”¨è¿ç»­è¿åŠ¨æˆ–æ’å€¼è¿åŠ¨ã€‚
2. **å¢åŠ ç¼“å†²/å‡é€Ÿæ®µ**ï¼šé¿å…çªå˜ï¼Œé™ä½å†²å‡»ã€‚
3. **ä½¿ç”¨é£è½®æˆ–è½¯å¯åŠ¨æ–¹å¼**ï¼šå‡å°å¯åŠ¨è´Ÿè½½ã€‚
4. **æ›´æ¢æ›´è€å¯åœå†²å‡»çš„è®¾å¤‡**ï¼šä¾‹å¦‚é€‰æ‹©ä¸“é—¨æ”¯æŒé«˜å¯åœé¢‘ç‡çš„ä¼ºæœç³»ç»Ÿã€‚

ç°åœ¨æ‰§è¡Œçš„åŠ é€Ÿå‡é€Ÿæ—¶é—´å‡ä¸º4sï¼Œè¶³å¤ŸåŠ é€Ÿå‡é€Ÿï¼Œä½†æ˜¯ä»å‡ºç°è¿™ä¸ªé—®é¢˜å—ï¼Ÿå¯ä»¥å¤šå°è¯•æ—‹è½¬ç”µæœºè§’åº¦æ—‹è½¬ã€‚

#### è½¬çŸ©é™åˆ¶

æˆ‘ä»¬å¥½åƒä¹Ÿæ²¡æœ‰ç”¨åˆ°è½¬çŸ©æ¨¡å¼ï¼Œè¿™ä¸ªè½¬çŸ©é™åˆ¶

| ç°è±¡                           | å¯èƒ½å‚æ•°é—®é¢˜          | å»ºè®®åŠ¨ä½œ                |
| ------------------------------ | --------------------- | ----------------------- |
| æŠ±é—¸åŠ¨ä½œæ—¶ç”µæœºè½»å¾®æ»‘åŠ¨         | PA47 å¤ªå°             | å¢åŠ  PA47 åˆ° 20~50      |
| åœæœºæ—¶æŠ¥é”™ Err13ï¼Œä¸”ç”µæœºä»åœ¨åŠ¨ | PA48 å¤ªå°æˆ– PA49 å¤ªé«˜ | å¢åŠ  PA48ã€é™ä½ PA49    |
| é€Ÿåº¦æŒ‡ä»¤è¾“å…¥æ—¶ç”µæœºæŠ–åŠ¨æˆ–å‘çƒ­   | PA46 å¤ªé«˜             | é™ä½ PA46 åˆ° 100Hz ä»¥å†… |
| ç”µæœºååº”è¿Ÿç¼“                   | PA46 å¤ªä½             | å¢åŠ  PA46 åˆ° 200~300Hz  |

## æ°´æ± ä¸‹å é—®é¢˜

ç°åœ¨å·²ç»ç†è§£äº†Z1ä¸‹å çš„é—®é¢˜å‡ºç°åœ¨äº†é‚£é‡Œï¼š

> ä»…åœ¨â€œ**ç‚¹åŠ¨ä¸‹é™**â€åœæ­¢æ—¶ï¼Œå‡ºç°â€œ**çªç„¶ä¸‹å **â€ï¼›
>  ç‚¹åŠ¨**åœæ­¢æ—¶ç”µæœºæ²¡æœ‰æŒ‰ç…§ PA41ï¼ˆå‡é€Ÿæ—¶é—´å¸¸æ•°ï¼‰æ…¢æ…¢å‡é€Ÿ**ï¼Œè€Œæ˜¯**ç›´æ¥æ–­ç”µåˆ¹è½¦**ã€‚

### æ ¹æœ¬åŸå› 

> åœ¨â€œç‚¹åŠ¨æ¨¡å¼â€ä¸‹ï¼Œé©±åŠ¨å™¨æ¥æ”¶åˆ° **DI ç‚¹åŠ¨ä¿¡å·é‡Šæ”¾ï¼ˆOFFï¼‰** æ—¶ï¼Œé»˜è®¤ä¸æ˜¯èµ° **æ­£å¸¸å‡é€Ÿè¿‡ç¨‹**ï¼Œè€Œæ˜¯ç›´æ¥â€œä¼ºæœ OFFâ€ æˆ–â€œå¼ºåˆ¶åˆ¹è½¦â€å¤„ç†ã€‚

ç‚¹åŠ¨æ¾æ‰‹ç¬é—´ï¼Œæ§åˆ¶é€»è¾‘ï¼š**ç«‹å³åœè½¬ â†’ ç”µæµç«‹æ–­ â†’ æŠ±é—¸å»¶è¿Ÿè¿˜æ²¡åŠ¨ä½œ** â†’ è´Ÿè½½ä¸‹å 

## ç‚¹åŠ¨å¦‚ä½•å¯åŠ¨PA41

## PA41å¯åŠ¨æ¡ä»¶

æ‰‹å†Œä¸Šè®°å½•çš„æ˜¯ï¼š

> ä»…ç”¨äºé€Ÿåº¦æ§åˆ¶åŠå†…éƒ¨ä½ç½®æ§åˆ¶æ–¹å¼ï¼Œå…¶ä»–æ§åˆ¶æ–¹å¼æ— æ•ˆ

ç”¨äºæ§åˆ¶ç”µæœºç§»åŠ¨æ–¹å¼çš„å‚æ•°æ˜¯`PA4`ã€‚ç°åœ¨ç”µæœºZ1çš„`PA4`å¯„å­˜å™¨æ˜¯3

```bash
3ï¼šä½ç½®é€Ÿåº¦æ··åˆæ§åˆ¶æ–¹å¼ï¼›
```

å†è§‚å¯Ÿç”µæœºZ1åœ¨ä¸¤ç§è¿è¡ŒçŠ¶æ€ä¸‹ï¼Œæ˜¯å¦æ”¹å˜äº†å¯„å­˜å™¨`PA4`çš„å€¼ã€‚å¾ˆæ˜æ˜¾ï¼Œç”µæœºZ1åœ¨ä¸¤ç§æƒ…å†µä¸‹å‡æ²¡æœ‰æ”¹å˜å¯„å­˜å™¨`PA4`çš„å€¼ã€‚å¹¶ä¸”ä»£ç ä¸­é™¤äº†ä¸€å¼€å§‹è®¾è®¡çš„PA4åˆå§‹åŒ–ä¸º3ï¼Œå…¶ä»–æƒ…å†µå¹¶æ²¡æœ‰å‡ºç°ä¿®æ”¹çš„æƒ…å†µã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç‚¹åŠ¨å’Œå†…éƒ¨ä½ç½®æ§åˆ¶çš„æ—¶å€™ï¼ŒPA41åº”è¯¥éƒ½ä¼šå¯ç”¨çš„ã€‚

é‚£ä¹ˆåˆ°åº•æ˜¯å“ªé‡Œå½±å“äº†ç”µæœºç‚¹åŠ¨åœæ­¢æ—¶å€™çš„é€»è¾‘å‘¢ï¼Ÿ

## ç‚¹åŠ¨é€»è¾‘

å†çœ‹ä¸€ä¸‹`motorCtrl`ä¸­å…³äºç‚¹åŠ¨å¼€å§‹ä¸åœæ­¢çš„é€»è¾‘ã€‚

### å‰è¿›é€»è¾‘

#### æŒ‰é’®æŒ‰ä¸‹

```C++
void MotorCtrl::on_actionUpRightFrontBt_pressed()
{
    if (!checkMotorConfigurationValidity()) {
         QLOG_ERROR()<<QString("MotorCtrlï¼šå‰è¿›æŒ‰é’®é•¿æŒ‰å¤±æ•ˆ");
         return;
    }
    // [ç‚¹åŠ¨æ¨¡å¼] ç§»åŠ¨
    if(m_runMode_chb->isChecked()){
        if(!isRunning()){
            QLOG_INFO() << "---------->[å‰è¿›ç‚¹åŠ¨å¼€å§‹]on_actionUpRightFrontBt_pressed - æ‰§è¡Œ[å‰è¿›ç‚¹åŠ¨]å¼€å§‹....<----------";
            actionJog(1);
        }
    }
}
```

#### æ£€æµ‹æ˜¯å¦è¿è¡Œ

```Cpp
bool MotorCtrl::isRunning()
{
    if(m_checkWoker && m_checkWoker->isRunning()){
        QLOG_WARN()<<QString("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…");
//        SMessageBox::sQdialogBoxOk(this, QMessageBox::Information, tr("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…"));
        SMessageBox::sQdialogDelayMS(this, QMessageBox::Information, tr("å·²æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·è€å¿ƒç­‰å¾…"), 1000); // æ˜¾ç¤º 1 ç§’
        if(m_jog_done){
            return true;
        }
    }
    return false;
}
```

#### ç‚¹åŠ¨æ‰§è¡Œé€»è¾‘

```CPP
void MotorCtrl::actionJog(int dir)
{
    if (!canStartJog()) return;

    // è·å–ç”µæœºID
    int motorID = getMotorID();
    m_jog_done = false;
    m_allDone = false;

    disableAllbt(dir);
    logJogStart(motorID, dir);

    // é¢„å¯åŠ¨ç”µæœº
    if (!applyJogConfig(motorID, dir)) return;
    if (!isPositionWithinLimit(motorID, dir)) return;

    // ç‚¹åŠ¨æ§åˆ¶ä¼ºæœä½¿èƒ½
    enableJogServo(motorID, dir);

    m_jog_dir = dir;
    m_checkWoker = new QThread;
    connect(m_checkWoker, &QThread::started, this, &MotorCtrl::checkJog);
    connect(m_checkWoker, &QThread::finished, this, &MotorCtrl::on_threadFinished);
    m_checkWoker->start();
}
```

é¢„å¯åŠ¨é€»è¾‘åªæ˜¯ä¿®æ”¹äº†è¾“å…¥ç«¯å­çš„åŠŸèƒ½ï¼Œå°†æ­£å‘ç‚¹åŠ¨å’Œè´Ÿå‘ç‚¹åŠ¨é…ç½®è¿›å»ã€‚

æœ€é‡è¦çš„å°±æ˜¯ç‚¹åŠ¨æ§åˆ¶ä¼ºæœä½¿èƒ½çš„`enableJogServo()`ï¼š

- å°†X1X2çš„ç”µæœºç§»åŠ¨æ¨¡å¼ï¼Œæ”¹ä¸º`M_ALL`çš„å¹¿æ’­æ¨¡å¼
- è°ƒç”¨`jogStart()`è¿›è¡Œç‚¹åŠ¨ä½¿èƒ½

#### ç‚¹åŠ¨ä½¿èƒ½

```CPP
bool MotorCtrl::jogStart(int motorID)
{
    if(!m_motorRegs->writeReg16(motorID, MotorRegs::PA53, 1)){
        QLOG_ERROR()<<QString("ä¼ºæœä½¿èƒ½å¤±è´¥ï¼šç”µæœºç¼–å·%1å†™å…¥PA53=1å¤±è´¥").arg(motorID);
        return false;
    }
    QLOG_INFO() << QString("ç”µæœº[%1]ä½¿èƒ½æˆåŠŸ").arg((motorID==M_ALL)?("X1X2"):(DbCtrl::s_motorNameList.at(motorID)));
    return true;
}
```

PA53æ˜¯è½¯ä»¶å¼ºåˆ¶ä½¿èƒ½ï¼Œä½¿ä¼ºæœå¼ºåˆ¶ä½¿èƒ½ä¸Šç”µï¼Œæ­¤æ—¶å¹¶æœªå‡ºç°çªç„¶ä¸‹å é—®é¢˜ã€‚

#### æ£€æŸ¥çº¿ç¨‹å¯åŠ¨

```CPP
m_checkWoker = new QThread;
connect(m_checkWoker, &QThread::started, this, &MotorCtrl::checkJog);
connect(m_checkWoker, &QThread::finished, this, &MotorCtrl::on_threadFinished);
m_checkWoker->start();
```

è¿™é‡Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œé‡ç‚¹çœ‹æ­¤æ£€æŸ¥çº¿ç¨‹ä¸­å…³äºåœæ­¢çš„é€»è¾‘

### åœæ­¢é€»è¾‘

#### æ‘‡æ†æ¾å¼€

```CPP
void MotorCtrl::on_actionUpRightFrontBt_released()
{
    if (!checkMotorConfigurationValidity()) {
         QLOG_ERROR()<<QString("MotorCtrlï¼šå‰è¿›æŒ‰é’®æ¾å¼€å¤±æ•ˆ");
         return;
    }
    if(m_runMode_chb->isChecked()){
        m_allDone = true;
        QLOG_INFO() << "---------->[å‰è¿›ç‚¹åŠ¨ç»“æŸ]on_actionUpRightFrontBt_released - ç”¨æˆ·å·²ç»æ¾å¼€å‰è¿›æŒ‰é’®ï¼Œ m_allDone = true....<----------";
    }else{
        on_actionUpRightFrontBt_clicked();
    }
}
```

æ­¤æ—¶å¾ˆæ˜æ˜¾ï¼Œç‚¹åŠ¨åœæ­¢çš„æ ‡å¿—å°±æ˜¯æ­¤æ§½å‡½æ•°å‘ç¨‹åºå‘å¸ƒä¸€ä¸ªçŠ¶æ€`m_allDone = true`

#### ç‚¹åŠ¨æ£€æŸ¥

åœ¨æ£€æŸ¥çº¿ç¨‹`checkJog()`ä¸­ï¼Œè¿›è¡Œæ­¤çŠ¶æ€çš„æ£€æŸ¥

```CPP
void MotorCtrl::checkJog()
{
    QLOG_INFO()<<QString("è¡Œè½¦ç‚¹åŠ¨è¿åŠ¨çŠ¶æ€æ£€æŸ¥çº¿ç¨‹å¯åŠ¨");
    McuCtrl::running();

    // é‡ç½®ç‚¹åŠ¨æ“ä½œå®Œæˆæ ‡å¿—ã€‚æ­¤æ ‡å¿—è®¾ä¸º falseï¼Œè¡¨æ˜å½“å‰æœ‰ç‚¹åŠ¨æ“ä½œæ­£åœ¨è¿›è¡Œã€‚
    m_jog_done = false;

    // ä¸»ç›‘æ§å¾ªç¯ï¼šåªè¦ 'm_allDone' æ ‡å¿—ä¸º falseï¼Œå¾ªç¯å°±ä¼šç»§ç»­ã€‚
    // 'm_allDone' åœ¨æ£€æµ‹åˆ°éœ€è¦åœæ­¢çš„æ¡ä»¶æ—¶ï¼ˆå¦‚é™ä½åˆ°è¾¾ã€åŒæ­¥é—®é¢˜æˆ–å¤–éƒ¨åœæ­¢ï¼‰ä¼šè¢«è®¾ç½®ä¸º trueã€‚
    do{
      ....
    }while(!m_allDone);

    actionJogStop();
    QLOG_INFO()<<QString("è¡Œè½¦ç‚¹åŠ¨è¿è¡Œç»“æŸ.");
    emit em_jogDone(true);
}
```

æŒºå…´å¥‹çš„ï¼Œç°åœ¨å¾ˆæ˜æ˜¾çŸ¥é“ï¼Œåº”è¯¥æ˜¯`actionJogStop()`é€»è¾‘äº†

#### åœæ­¢ç‚¹åŠ¨

`actionJogStop()`å®é™…è°ƒç”¨äº†`jogStop()`å‡½æ•°æ¥è¿›è¡Œåœæ­¢é€»è¾‘ï¼š

```CPP
bool MotorCtrl::jogStop(int motorID)
{
  ...
  if(!m_motorRegs->writeReg16(motorID, MotorRegs::PA53, 0)){
    QLOG_ERROR()<<QString("ç”µæœº%1å†™å…¥PA53=0å¤±è´¥").arg(DbCtrl::s_motorNameList.at(motorID));
    return false;
  }
  if(!m_motorRegs->writeReg16(motorID, MotorRegs::P3_31, MotorRegs::JogMode)){
    QLOG_ERROR()<<QString("ç”µæœº%1å†™å…¥P3_31=%2å¤±è´¥").arg(DbCtrl::s_motorNameList.at(motorID)).arg(MotorRegs::JogMode);
    return false;
  }
  return true;
}
```

- ä¼ºæœå¼ºåˆ¶æ–­å¼€ï¼Œå¼ºåˆ¶å…³é—­ä¼ºæœä½¿èƒ½ï¼ˆæ–­ç”µï¼‰
- æ¢å¤è¾“å…¥ç«¯å­çš„ç‚¹åŠ¨è¾“å…¥æ¨¡å¼

é‚£ä¹ˆæ˜¯å¦æ˜¯ç”±äºå¼ºåˆ¶ä¼ºæœæ–­å¼€ä½¿èƒ½å¯¼è‡´çš„å‘¢ï¼Ÿ

åº”è¯¥æ˜¯çš„ï¼š

- **æ–­å¼€ `PA53=0` = ç›´æ¥å…³é—­åŠ±ç£ â†’ ç”µæœºç«‹å³è¿›å…¥â€œæ— åŠ›â€çŠ¶æ€**ï¼›
- **è€ŒæŠ±é—¸è¿˜æœªé—­åˆï¼ˆéœ€è¦å»¶æ—¶ PA48ï¼‰ï¼Œè´Ÿè½½æ­¤æ—¶æ²¡æœ‰ä»»ä½•æ”¯æ’‘åŠ› â†’ ä¸‹å **ï¼›
- åŒæ—¶ï¼Œ**æ²¡æœ‰è¿›å…¥ä»»ä½•â€œå‡é€Ÿè¿‡ç¨‹â€ï¼Œè€Œæ˜¯ç«‹å³åœæœº + åˆ‡ç”µ**ï¼ŒPA41 å®Œå…¨æ— æ³•ä»‹å…¥ã€‚

è€Œåº”è¯¥æ˜¯ï¼šå‡é€Ÿ + æŠ±é—¸äº¤æ¥åŠ›çŸ©

### ç¬¬ä¸€ç‰ˆä¿®æ”¹

ç°åœ¨ç¬¬ä¸€ç‰ˆï¼Œæ˜¯è®©ç”µæœºé™é€Ÿ1000msåï¼Œå†ä¼ºæœæ–­ç”µã€‚

```CPP
// 1. è®©ç”µæœºèµ°å‡é€Ÿè¿‡ç¨‹ï¼Œä¿æŒä¼ºæœåŠ±ç£
if(!m_motorRegs->writeReg16(motorID, MotorRegs::P3_31, MotorRegs::JogMode)){
    QLOG_ERROR()<<QString("MotorCtrl::jogStop - ç”µæœº%1å†™å…¥P3_31=%2å¤±è´¥").arg(DbCtrl::s_motorNameList.at(motorID)).arg(MotorRegs::JogMode);
    return false;
}

// 2. ç­‰å¾… PA41 æ§åˆ¶ä¸‹çš„æ­£å¸¸åœæ­¢ï¼ˆé€Ÿåº¦é™åˆ°50rpm/minï¼‰,æŠ±é—¸é¢„ç•™é—­åˆæ—¶é—´
QLOG_INFO() << "MotorCtrl::jogStop - å‡é€Ÿç­‰å¾…ä¸­...";
QThread::msleep(1000);

// 3. æœ€åæ–­å¼€ä¼ºæœ
m_motorRegs->writeReg16(motorID, MotorRegs::PA53, 0);  // Servo OFF
```

ä½†æ˜¯ç»è¿‡å®æµ‹ï¼Œ35mm/sçš„é€Ÿåº¦ï¼Œä»æ—§æ˜¯ä¼šå‡ºç°ä¸‹å ã€‚æˆ‘æƒ³èµ·æ¥äº†ï¼åº”è¯¥æ˜¯é™é€Ÿåˆ°ç›®æ ‡é€Ÿåº¦åå†è¿›è¡Œåœæ­¢ã€‚

è®©`QThread::msleep(1000)`è¿™ä¸ªè¿‡ç¨‹ï¼Œæ›¿æ¢ä¸ºè½®è¯¢è¯»å–å½“å‰è½¬é€Ÿï¼Œå¹¶ä¸PA49è®¾å®šçš„åœæ­¢é€Ÿåº¦å¯¹æ¯”ï¼Œä¸€è‡´åå†æ–­ç”µå³å¯ï¼

ä¹Ÿä¸éœ€è¦ï¼Œç›´æ¥é€šè¿‡å¯„å­˜å™¨`PA47`çš„å€¼

### ç¬¬äºŒç‰ˆä¿®æ”¹

```CPP
// 1. è®©ç”µæœºèµ°å‡é€Ÿè¿‡ç¨‹ï¼Œä¿æŒä¼ºæœåŠ±ç£
if(!m_motorRegs->writeReg16(motorID, MotorRegs::P3_31, MotorRegs::JogMode)){
    QLOG_ERROR()<<QString("MotorCtrl::jogStop - ç”µæœº%1å†™å…¥P3_31=%2å¤±è´¥").arg(DbCtrl::s_motorNameList.at(motorID)).arg(MotorRegs::JogMode);
    return false;
}
```

ç›´æ¥ä¸å†æ‰‹åŠ¨å…³ä¼ºæœï¼Œäº¤ç»™é©±åŠ¨å™¨å†…éƒ¨æµç¨‹æ§åˆ¶ã€‚é€šè¿‡`PA47`è®¾å®šè‡ªåŠ¨æ§åˆ¶åˆ¹è½¦ä¸æ–­ç”µæµç¨‹ã€‚ä½†æ˜¯ç°åœ¨å¥½åƒæœ‰ç”µæµå£°ï¼Œéš¾é“ä¼ºæœåˆ¹è½¦åæ²¡æœ‰è‡ªåŠ¨æ–­ç”µå—ï¼Ÿæˆ‘è¯¥æ€ä¹ˆçœ‹ï¼Ÿçœ‹å“ªä¸ªå¯„å­˜å™¨æ‰èƒ½çŸ¥é“ä¼ºæœæ˜¯å¦æ–­ç”µï¼Ÿ

å¯ä»¥ï¼Œç»è¿‡æŸ¥è¯¢æ‰‹å†Œï¼Œå‘ç°æ˜¯åœ¨ç›‘æ§ç•Œé¢dpçš„`dp I`å¯ä»¥æŸ¥çœ‹ç”µæµã€‚åœ¨æ‰§è¡Œç‚¹åŠ¨å®Œæˆåï¼Œå…¶å¹¶æ²¡æœ‰æŒ‰ç…§é¢„å®šçš„`PA47`è§„åˆ™ï¼ŒæŠ±é—¸åå»¶æ—¶æ‰§è¡Œä¼ºæœæ–­ç”µçš„æ“ä½œã€‚

é‚£ä¹ˆæˆ‘åº”è¯¥æ‰‹åŠ¨æ”¹å§ï¼Œæ€ä¹ˆæ”¹å‘¢ï¼Ÿæ‰‹åŠ¨æ–­ç”µï¼š

- DOå£è¾“å‡ºæŠ±é—¸ä¿¡å·åï¼Œæ–­ç”µ
- è½¬é€Ÿä¸º0åï¼Œæ–­ç”µï¼ˆè¿™ä¸ªæ›´ä½³ï¼Œç¬¦åˆä½¿ç”¨åœºæ™¯ï¼‰

### ç¬¬ä¸‰ç‰ˆä¿®æ”¹

è¿™ä¸€ç‰ˆä»£ç å°±æ˜¯è§£å†³æŠ±é—¸åä¸æ–­ç”µçš„é—®é¢˜ã€‚è™½ç„¶å·²ç»è®¾ç½®äº†æŠ±é—¸åè‡ªåŠ¨æ–­ç”µçš„é€»è¾‘ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾æ²¡å•¥ç”¨ï¼Œéœ€è¦æ‰‹åŠ¨æã€‚

æ€è·¯å°±æ˜¯ï¼š

- è®©ç”µæœºèµ°å‡é€Ÿçš„æ—¶å€™ï¼Œè·å–å…¶`PA47`å‚æ•°ï¼Œè·å–æŠ±é—¸åˆ°åœç”µåº”è¯¥æŒç»­çš„æ—¶é—´`brakeToServoOffDelayMs`
- è½®è¯¢`50ms`è·å–ç”µæœºå½“å‰çš„é€Ÿåº¦ï¼Œå¦‚æœå½“å‰é€Ÿåº¦ä¸º0ï¼Œåˆ™åˆ¤å®šå·²ç»æŠ±é—¸
- å»¶è¿Ÿ`brakeToServoOffDelayMs`äº‹ä»¶åï¼Œå¼ºåˆ¶ä¼ºæœæ–­ç”µ

è¿™æ ·æ•´ä½“é€»è¾‘å°±æ˜¯ï¼š

```BASH
1. è·å– PA47 â†’ å¾—åˆ°åˆ¶åŠ¨å™¨åŠ¨ä½œåçš„å»¶è¿Ÿæ–­ç”µæ—¶é—´ï¼ˆmsï¼‰

2. æ‰§è¡Œ Jog åœæ­¢ï¼Œè¿›å…¥å‡é€Ÿæµç¨‹

3. è½®è¯¢å½“å‰ç”µæœºé€Ÿåº¦ï¼š
    - æ¯ 50ms è¯»å–ä¸€æ¬¡ï¼›
    - ä¸€æ—¦é€Ÿåº¦ â‰ˆ 0ï¼ˆä¾‹å¦‚ â‰¤5 rpmï¼‰ â†’ åˆ¤å®šä¸ºâ€œå·²ç»é™æ­¢â€

4. å»¶è¿Ÿ brakeToServoOffDelayMsï¼ˆå¦‚ 500msï¼‰ â†’ ç»™åˆ¶åŠ¨å™¨æ—¶é—´å®Œå…¨é—­åˆ

5. å†™å…¥ PA53 = 0 â†’ å…³é—­ä¼ºæœä½¿èƒ½
```

 **â€œè½¯åœæ­¢ + æŠ±é—¸æ¥åŠ› + å»¶è¿Ÿæ–­ç”µâ€** æµç¨‹ï¼Œè§£å†³äº†ï¼š

- ç‚¹åŠ¨åœæ­¢ç«‹å³æ–­ç”µå¯¼è‡´ä¸‹å ï¼›
- æŠ±é—¸æœªé—­åˆå¯¼è‡´è½´æŠ–åŠ¨/è·Œè½ï¼›
-  ä¼ºæœé•¿æœŸä½¿èƒ½å‘çƒ­ã€ä¸èŠ‚èƒ½ã€‚

è¿™é‡Œå…³äºå¦‚ä½•æ£€æµ‹é€Ÿåº¦ä¸º0ï¼Œåˆ™å¯ä»¥é€šè¿‡å¯„å­˜å™¨`PA75`æ¥è®¾ç½®

```tex
1. ç”µæœºé€Ÿåº¦ä½äºæ­¤å‚æ•°æ—¶ï¼Œæ•°å­—è¾“å‡ºDOçš„
ZSPï¼ˆé›¶é€Ÿï¼‰ONï¼Œå¦åˆ™OFFã€‚
2. å½“æ•°å­—è¾“å…¥DIçš„ZCLAMP ONæ—¶ï¼Œé€Ÿåº¦æŒ‡
ä»¤å€¼ä½äºæ­¤å€¼æ—¶ï¼Œé€Ÿåº¦æŒ‡ä»¤å€¼å¼ºåˆ¶ä¸ºé›¶ã€‚
```

ä½†æ˜¯ç°åœ¨DOå£5ä¸ªå¯èƒ½å‡æœ‰ç”¨é€”ï¼Œä½†æ˜¯å¯ä»¥çŸ¥é“çš„å°±æ˜¯ï¼Œ`P3-21`å¯„å­˜å™¨ä»£è¡¨çš„DO2æ§åˆ¶çš„æ˜¯8ï¼Œåˆ¹è½¦è¾“å‡ºå±•ç¤º

```tex
OFF ï¼šç”µç£åˆ¶åŠ¨å™¨åˆ¶åŠ¨ï¼›
ON ï¼šç”µç£åˆ¶åŠ¨å™¨é‡Šæ”¾
```

æ‰€ä»¥ç›´æ¥è¯»å–DO2æ˜¯å¦å·²ç»åˆ¶åŠ¨ï¼Œæ¥å»¶è¿Ÿæ–­ç”µå³å¯ã€‚

é‚£ä¹ˆå¦‚ä½•è¯»å–DOè¾“å‡ºå‘¢ï¼Ÿ

æ‰‹å†Œä¸­ï¼Œ`P3-33`æœ‰ç›¸å…³ä»‹ç»ã€‚

```tex
P3-33 è™šæ‹Ÿè¾“å‡ºç«¯å­çŠ¶æ€å€¼ 0000-1111 0000
```

è¿™ä¸ªå¯„å­˜å™¨æ˜¯å¦èƒ½è¾“å‡º

### ç¬¬å››ç‰ˆä¿®æ”¹

å¥½çš„ç°åœ¨å·²ç»çŸ¥é“å¦‚ä½•è¯»å–ç”µæœºå½“å‰è½¬é€Ÿäº†ï¼Œæ˜¯é€šè¿‡ä¸€ä¸ªå¥‡æ€ªçš„å¯„å­˜å™¨è¯»å–çš„ã€‚tmdï¼Œæ‰‹å†Œå†™çš„ä¸€å›¢ç³Ÿã€‚

1. **å‡é€Ÿè¿‡ç¨‹ä¸ä¿æŒä¼ºæœåŠ±ç£**ï¼š
    é¦–å…ˆï¼Œä¿æŒç”µæœºå¤„äºå‡é€Ÿæ¨¡å¼ (`JogMode`)ã€‚

2. **è·å– `PA47` å’Œ `PA49` çš„å€¼**ï¼š

   - `PA47`ï¼šç”µæœºåœæ­¢åï¼Œ**æœºæ¢°åˆ¶åŠ¨å™¨åŠ¨ä½œåˆ°ç”µæœºæ–­ç”µçš„å»¶è¿Ÿæ—¶é—´**ï¼›

   - `PA49`ï¼šç”µæœºåœæ­¢æ—¶ï¼Œ**æœ€å°å…è®¸è½¬é€Ÿ**ï¼ˆå¦‚æœä½äºæ­¤é€Ÿåº¦å°±å¯ä»¥æŠ±é—¸ï¼‰ã€‚

3. **è½®è¯¢å½“å‰ç”µæœºè½¬é€Ÿ**ï¼š
    æ¯ 100 æ¯«ç§’æ£€æŸ¥ä¸€æ¬¡ç”µæœºè½¬é€Ÿï¼Œç›´åˆ°ç”µæœºè½¬é€Ÿä½äº `PA49`ï¼ˆæœ€å°æŠ±é—¸è½¬é€Ÿï¼‰æ—¶é€€å‡ºã€‚

4. **ç­‰å¾…æŠ±é—¸é—­åˆçš„å»¶è¿Ÿæ—¶é—´**ï¼š
    åœ¨ç”µæœºè½¬é€Ÿé™åˆ°å®‰å…¨å€¼åï¼Œç­‰å¾… `PA47` å®šä¹‰çš„å»¶è¿Ÿæ—¶é—´æ¥ç¡®ä¿æŠ±é—¸å®Œå…¨é—­åˆã€‚

5. **æ–­å¼€ä¼ºæœä½¿èƒ½**ï¼š
    æœ€åï¼Œå†™å…¥ `PA53 = 0` å…³é—­ä¼ºæœåŠ±ç£ã€‚

ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥å®ç°æ‰€æœ‰Z1ç”µæœºåœ¨è´Ÿè½½20kgçš„æƒ…å†µä¸‹ï¼Œç‚¹åŠ¨é€Ÿåº¦80mm/så·¦å³ä¸Šä¸‹ï¼Œä¸ä¼šå‘ç”Ÿä¸‹å é—®é¢˜ã€‚

## å»ºæ¨¡ä¸ç”»å›¾

# 7.9

ä»Šå¤©è¦è§£å†³çš„æ˜¯ï¼Œpspå‘é€ä¿¡å·ç¯æ¶ˆæ¯ä¼šå½±å“æ•°æ®è·å–çš„é—®é¢˜ã€‚

## ä¿¡å·ç¯å‘é€é€»è¾‘

ç°åœ¨è“ç‰™å‘é€ä¿¡å·ç¯æ•°æ®çš„æ—¶å€™ï¼Œæ˜¯ç›´æ¥å†™ä¸æ£€æµ‹è¿”å›æ•°æ®ã€‚

å‘é€ä¿¡å·ç¯é€»è¾‘

```CPP
#define USER_MODBUS_ID          0xFE

McuCtrl::running();

void McuCtrl::running()
{
    ctrl(YELLOW, 60);
}

bool McuCtrl::ctrl(REG reg, quint16 op)
{
    return MotorRegs::get_instance()->writeReg16(USER_MODBUS_ID, reg, op);
}
```

```CPP
QBluetoothSocket *m_socket;
ret = m_socket->write(writeData);
if(mID == (USER_MODBUS_ID+1)){	// è¿™é‡ŒåŠ 1æ˜¯å› ä¸ºwriteReg16ä¼šå°†æ‰€æœ‰IDåŠ 1
    QLOG_INFO()<<QString("ModbusBt::write - ä¿¡å·ç¯å¹¿æ’­æ•°æ®ï¼Œç›´æ¥è¿”å› true");
    return true;
}
```

ä½†æ˜¯è¿™æ ·å°±ä¼šå¯¼è‡´ï¼Œä¿¡å·ç¯åç»­çš„è“ç‰™è¯»å–æ“ä½œä¸æ­£å¸¸ã€‚å°±åƒæ˜¯ç°åœ¨è¿™ä¸ªåœºæ™¯ï¼š

```CPP
QLOG_INFO()<<QString("------------> è¡Œè½¦è¿åŠ¨çŠ¶æ€æ£€æŸ¥çº¿ç¨‹å¯åŠ¨ <------------");
McuCtrl::running();

// è·å–ä½ç½®æ£€æµ‹çš„å‚æ•°
int id = getMotorID();
quint16 maxDiffValue;
QLOG_INFO() << "checkMove - å¼€å§‹è·å–æ£€æµ‹å‚æ•°PA16...";
m_motorRegs->readReg16(id, MotorRegs::PA16, maxDiffValue);
QLOG_INFO() << QString("checkMoveï¼šå®šä½å®ŒæˆèŒƒå›´PA16ï¼š(%1)pulse").arg(maxDiffValue);
m_motorRegs->readReg16(id, MotorRegs::PA17, tmp);
QLOG_INFO() << QString("checkMoveï¼šä½ç½®è¶…å·®èŒƒå›´ï¼š(%1)pulse").arg(tmp);
m_motorRegs->readReg16(id, MotorRegs::PA18, tmp);
QLOG_INFO() << QString("checkMoveï¼šè¶…å·®æŠ¥è­¦æ£€æµ‹ï¼š%1").arg(tmp == 0 ? "æœ‰æ•ˆ" : "æ— æ•ˆ");
```

- å‘é€æ­£åœ¨ç§»åŠ¨çš„ä¿¡å·ç¯ä¿¡æ¯
- è¯»å–ç”µæœºPA16å¯„å­˜å™¨
- è¯»å–ç”µæœºPA17å¯„å­˜å™¨
- è¯»å–ç”µæœºPA18å¯„å­˜å™¨

ä½†æ˜¯æ­¤æ—¶æ—¥å¿—è®°å½•ä¸ºï¼š

```bash
INFO  2025-07-09T11:45:43.128 "------------> è¡Œè½¦è¿åŠ¨çŠ¶æ€æ£€æŸ¥çº¿ç¨‹å¯åŠ¨ <------------" 
INFO  2025-07-09T11:45:43.129 "ModbusBt::write - è“ç‰™å†™æ•°æ®å‘é€:" "ff060011003ccc00" 
INFO  2025-07-09T11:45:43.129 "ModbusBt::write - ä¿¡å·ç¯å¹¿æ’­æ•°æ®ï¼Œç›´æ¥è¿”å› true" 
INFO  2025-07-09T11:45:43.129 "ç”µæœº254å†™å…¥æˆåŠŸ,16(17,60)" 
INFO  2025-07-09T11:45:43.129 checkMove - å¼€å§‹è·å–æ£€æµ‹å‚æ•°PA16... 
INFO  2025-07-09T11:45:43.129 "ModbusBt::read - è“ç‰™è¯»è¯·æ±‚å‘é€:" "050300100001844b" 
ERROR 2025-07-09T11:45:43.184 "æ•°æ®é•¿åº¦é”™è¯¯ï¼ŒæœŸæœ›2å­—èŠ‚ï¼Œå®é™…0å­—èŠ‚" 
INFO  2025-07-09T11:45:43.184 "checkMoveï¼šå®šä½å®ŒæˆèŒƒå›´PA16ï¼š(0)pulse" 
INFO  2025-07-09T11:45:43.184 "ModbusBt::read - è“ç‰™è¯»è¯·æ±‚å‘é€:" "050300110001d58b" 
INFO  2025-07-09T11:45:43.185 "checkMoveï¼šä½ç½®è¶…å·®èŒƒå›´ï¼š(130)pulse" 
INFO  2025-07-09T11:45:43.185 "ModbusBt::read - è“ç‰™è¯»è¯·æ±‚å‘é€:" "050300120001258b" 
INFO  2025-07-09T11:45:43.260 "checkMoveï¼šè¶…å·®æŠ¥è­¦æ£€æµ‹ï¼šæ— æ•ˆ" 
```

é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯ä¿¡å·ç¯å¹¶ä¸æ˜¯å¹¿æ’­æ•°æ®ï¼Œéœ€è¦æ¥æ”¶å“åº”å‘¢ï¼Ÿ

ç»è¿‡å®éªŒï¼Œå‘ç°æ˜¯è¿™æ ·çš„é—®é¢˜ã€‚å°±æ˜¯ä¿¡å·ç¯ä¸ºéå¹¿æ’­æ•°æ®ä½†æ˜¯å¹¿æ’­äº†ã€‚

# 7.10

## æ¶ˆå¤±çš„gain_control

ä¹‹å‰å·å·æ”¹è¿‡`gain_control()`çš„é€»è¾‘ã€‚ä¹‹å‰ç‰ˆæœ¬æ˜¯

```C
int gain_control(int chn, int gain);

int gain_control(int chn, int gain)
{
  int iRet = 0;
  uint16_t code;
  int g_id = 0;
  if(20 == gain){
    g_id = 1;
  }else if(40 == gain){
    g_id = 2;
  }
  int rep = g_app_cfgctrl->cfg.reparation[g_id][chn];
  code = (87.57- gain)*4096/100;

  iRet = fpga_reg_write(AD_GAIN_CH(chn), code-rep);
  if(iRet != 0){
    ERR_LOG("Gain set, data write failed!\n");
    return -1;
  }
  INFO_LOG("Gain %d set, chn%d code = %d reparation = %d\n", gain, chn, code, rep);

  return 0;
}
```

æ­¤ç‰ˆæœ¬çš„ä»£ç ä¸­ï¼Œè¿™é‡Œ `chn` æ˜¯é€šé“å·ï¼Œ`gain` æ˜¯å¢ç›Šå€¼ã€‚å¢ç›Šæ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å‚æ•°ä¼ å…¥ï¼Œç„¶åå¯¹åº”é€šé“å’Œå¢ç›Šçš„æ ¡å‡†å€¼`rep`æ˜¯é€šè¿‡å…¨å±€å˜é‡`g_app_cfgctrl`æ¥è·å–çš„ã€‚

è€Œä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œå¹¶ä¸”ç»Ÿä¸€å˜é‡ï¼Œå°±å°†åŸå‡½æ•°è°ƒæ•´ä¸ºäº†ä¼ å…¥è®¾ç½®å‚æ•°ç»“æ„ä½“ï¼Œå¹¶å°†`gain`çš„å€¼å­˜æ”¾ç»“æ„ä½“ä¸­ã€‚

```C
int gain_control(int chn, const user_cfg_t* cfg) {
  // 1. å‚æ•°æ ¡éªŒï¼šæ£€æŸ¥é€šé“å·å’Œé…ç½®æŒ‡é’ˆçš„æœ‰æ•ˆæ€§
  if (chn < 0 || chn >= MAX_CHN_CNT) {
    ERR_LOG("Invalid channel number: %d. Must be between 0 and %d.\n", chn, MAX_CHN_CNT - 1);
    return -1;
  }
  if (cfg == NULL) {
    ERR_LOG("User configuration pointer is NULL.\n");
    return -1;
  }

  int gain = cfg->gain[chn]; // è·å–æŒ‡å®šé€šé“çš„æ ‡ç§°å¢ç›Šå€¼
  ...
}
```

ä½†æ˜¯ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä¿®æ”¹å®Œæ¯•åï¼Œç«Ÿç„¶åœ¨å…¶åŸæœ¬çš„è°ƒç”¨éƒ¨åˆ†æ²¡æœ‰ä¿®æ”¹ã€‚å¤´ç–¼...

æ‰¾åˆ°è°ƒç”¨å‡½æ•°`gain_control()`çš„ä½ç½®ï¼š

```bash
forlinx@ubuntu:~/work/pcieCollector$ grep -rn --include="*.c" gain_control .
./app/calc.c:118:      gain_control(c, gain);
./app/calc.c:170:      gain_control(c, gain);
./app/dealcmd.c:72:          gain_control(i, &g_app_cfgctrl->cfg);
```

æœ¬ç€é‡æ„éœ€è¦å…ˆç†è§£ï¼Œæˆ‘ä»¬å…ˆç†è§£ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„é€»è¾‘ï¼š

- `int adc_adjust()` - å¯¹åº”calc.cæ–‡ä»¶
  - `static int handle_adjust()` - å¯¹åº”dealcmd.cæ–‡ä»¶
- `static int handle_collect_start()`- å¯¹åº”dealcmd.cæ–‡ä»¶

æˆ‘ä»¬å…ˆä»`adc_adjust()`æ¥çœ‹ï¼Œå¦‚ä½•ä¿®æ”¹å¯¹åº”çš„`gain_control()`é€»è¾‘

## `adc_adjust`

è¿™é‡Œæˆ‘ä»¬ç€é‡è®°å½•ä¸‹ä¿®æ”¹ç‚¹ï¼š

1. è¦æ ¡å‡†çš„å¢ç›ŠIDæ•°ç»„ï¼š`adj_gainIDs`ä»3ä¸ªå¢ç›Šæ”¹ä¸º8ä¸ªå¢ç›Š

   ```C
   // æ„å»º adj_gainIDs çš„å­—ç¬¦ä¸²è¡¨ç¤º
   snprintf(gains_str, sizeof(gains_str), "[%d", adj_gainIDs[0]);
   for (int i = 1; i < GAIN_CAL_CNT; i++) {
     snprintf(gains_str + strlen(gains_str), sizeof(gains_str) - strlen(gains_str), ",%d", adj_gainIDs[i]);
   }
   strcat(gains_str, "]");
   
   // æ„å»º adj_chns çš„å­—ç¬¦ä¸²è¡¨ç¤º
   snprintf(chns_str, sizeof(chns_str), "[%d", adj_chns[0]);
   for (int i = 1; i < MAX_CHN_CNT; i++) {
       snprintf(chns_str + strlen(chns_str), sizeof(chns_str) - strlen(chns_str), ",%d", adj_chns[i]);
   }
   strcat(chns_str, "]");
   
   INFO_LOG("ADC adjust starting. Gains to adjust: %s, Channels to adjust: %s, SignalHz=%d, ppMv=%f\n",
     gains_str, chns_str, signalHz, ppMv);
   ```

   è¿™é‡Œåç»­è¦æ£€æŸ¥è°ƒç”¨`adc_adjust()`çš„å‡½æ•°ï¼Œæ£€æŸ¥ä¼ å…¥å‚æ•°`adj_gainIDs`æ˜¯å¦ä¸º8ä¸ªã€‚

2. gain_control

   è¿™éƒ¨åˆ†å°±æ˜¯é€šè¿‡è®¾ç½®

   ```C
   g_app_cfgctrl->cfg.gain[chn] = gain; // è®¾ç½®å½“å‰é€šé“çš„å¢ç›Š
   g_app_cfgctrl->cfg.reparation[g_id][chn] = repa[chn]; // é‡æ–°è®¾ç½®ä¸ºåŸå§‹è¡¥å¿å€¼
   gain_control(chn, &g_app_cfgctrl->cfg);
   ```

   æ¥å®ç°å¢ç›Šæ§åˆ¶çš„ã€‚è¿™éƒ¨åˆ†æµ‹è¯•è¾ƒä¸ºå……åˆ†ã€‚

ç„¶åæˆ‘ä»¬é’ˆå¯¹é—®é¢˜1å¯èƒ½å‡ºç°çš„bugï¼Œçœ‹ä¸‹å“ªé‡Œè°ƒç”¨äº†`adc_adjust()`

```bash
forlinx@ubuntu:~/work/pcieCollector$ grep -rn --include="*.c" "adc_adjust" .
./app/calc.c:99:int adc_adjust(int *adj_gainIDs, int *adj_chns, int signalHz, float ppMv)
./app/dealcmd.c:162:  return adc_adjust(adj_gainIDs, chns,  singleHz, ppMv);
```

å¯ä»¥çœ‹å‡ºå°±åœ¨`dealcmd.c`ä¸‹çš„å‡½æ•°`handle_adjust()`ä¸­ã€‚

## `handle_adjust`

ä¿è¯å…¶è°ƒç”¨`adc_adjust()`çš„æ—¶å€™ï¼Œå¢ç›ŠæŒ¡ä½ä¸ªæ•°éƒ½å¯¹çš„`GAIN_CAL_CNT`ã€‚

```bash
forlinx@ubuntu:~/work/pcieCollector$ git diff
diff --git a/app/dealcmd.c b/app/dealcmd.c
index 97bb78e..1a838b0 100644
--- a/app/dealcmd.c
+++ b/app/dealcmd.c
@@ -108,7 +108,7 @@ static int handle_adjust(const cJSON *json, char *response_buf, size_t response_
 {
   cJSON *tmp_json;
   int cnt = 0;
-  int adj_gainIDs[3] = {0};
+  int adj_gainIDs[GAIN_CAL_CNT] = {0};^M
   int chns[MAX_CHN_CNT] = {0};
   int singleHz = 0;
   int ppMv = 0;
@@ -133,10 +133,10 @@ static int handle_adjust(const cJSON *json, char *response_buf, size_t response_
     return -1;
   }
   if(cJSON_IsArray(tmp_json)){
-  cnt = cJSON_GetArraySize(tmp_json);
+    cnt = cJSON_GetArraySize(tmp_json);^M
   }
-  if(cnt!=3){
-    ERR_LOG("Adjust request gains count != 3\n");
+  if(cnt != GAIN_CAL_CNT){^M
+    ERR_LOG("Adjust request gains count != GAIN_CAL_CN(%d)\n", GAIN_CAL_CNT);^M
     return -2;
   }
   for (int i = 0; i < cnt; i++){
@@ -149,9 +149,9 @@ static int handle_adjust(const cJSON *json, char *response_buf, size_t response_
     return -1;
   }
   if(cJSON_IsArray(tmp_json)){
-  cnt = cJSON_GetArraySize(tmp_json);
+    cnt = cJSON_GetArraySize(tmp_json);^M
   }
-  if(cnt!=MAX_CHN_CNT){
+  if(cnt != MAX_CHN_CNT){^M
     ERR_LOG("Adjust request chns count != %d\n", MAX_CHN_CNT);
     return -2;
   }
diff --git a/commdef.h b/commdef.h
index 842541e..8acf6fe 100644
--- a/commdef.h
+++ b/commdef.h
@@ -66,7 +66,7 @@
 #define MAX_UDP_MSG_LEN         (1024)
 #define PCIE_DATABLOCK_SIZE     (4096)
 #define PCIE_BLOCK_HEAD_LEN     (16)
-#define GAIN_CAL_CNT 8  // å¢ç›Šæ¡£ä½
+#define GAIN_CAL_CNT (8)  // å¢ç›Šæ¡£ä½^M
```

## `handle_collect_start`

ä¹‹å‰å·²ç»ä¿®æ”¹å®Œäº†ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†é€»è¾‘äº†ã€‚

## å¦ä¸€å—å•æ¿2k

ç°åœ¨å¦ä¸€æ¬¾å•æ¿ä¹Ÿéœ€è¦åŠ å…¥ç›¸åŒçš„`gain_control()`é€»è¾‘ï¼Œè¿™æ¬¡å°±ä¸æ“å¿ƒè´¹ç¥çš„ä¿®æ”¹`gain_control()`çš„å‚æ•°äº†ã€‚æµ‹è¯•ç±»æˆ‘ä¹Ÿæ‡’å¾—åŠ äº†ã€‚

ä½†æ˜¯ç°åœ¨å¥½ç´¯ï¼Œæœ‰ç‚¹é¥¿ã€‚

### å¼€å‘ç¯å¢ƒ

ç°åœ¨ä¸èƒ½åœ¨ç¼–è¯‘ç¯å¢ƒä¸‹å¼€å‘ï¼Œå› ä¸ºå¥½åƒæœ‰äº›ä¸œè¥¿å½±å“äº†å¼€å‘ã€‚æ‰€ä»¥éœ€è¦ï¼šæœ¬åœ°ä¿®æ”¹å®Œæ¯•ä»£ç åï¼Œå†å°†ä»£ç æäº¤åˆ°ç¼–è¯‘ç¯å¢ƒ

```bash
ssh solid@10.1.2.111     // solid123
```

å…¶å¯¹åº”çš„å¼€å‘ç¯å¢ƒç›®å½•ä¸ºï¼šï¼ˆéœ€è¦æ”¹å®Œåå°†æ–‡ä»¶æäº¤åˆ°æ­¤ç›®å½•ï¼‰

```bash
/home/solid/mt7621_sdk_base/package/utils/collecter/src
```

æœ€ç»ˆç¼–è¯‘è„šæœ¬åœ¨ï¼š

```bash
/home/solid/mt7621_sdk_base/
```

### è¿è¡Œç¯å¢ƒ

è¿è¡Œç¯å¢ƒåœ¨`10.1.2.180`.

ç¨‹åºçš„è¿è¡Œç›®å½•åœ¨ï¼š

```bash
/version
```

æ—¥å¿—è®°å½•åœ¨

```bash
/www/message.log
```

### å¿«é€Ÿç¼–è¯‘

ç°åœ¨æˆ‘æƒ³åœ¨`/home/solid/mt7621_sdk_base/package/utils/collecter/src`ä¿®æ”¹å®Œä»£ç åï¼Œæ‰§è¡Œ

```bash
./home/solid/mt7621_sdk_base/mk.sh collecter
```

å¹¶ä¸”å°†ç”Ÿæˆåçš„æ–‡ä»¶`collecter`åœ¨

```bash
/home/solid/mt7621_sdk_base/tf-card/collecter
```

scpåˆ°`10.1.2.180\version\collecter`

å¦‚ä½•æ‰èƒ½æ‰§è¡Œè¿™ä¸ªå¿«é€Ÿç¼–è¯‘å‘¢ï¼Ÿ

# 7.11

è¿™æ¬¡ä¿®æ”¹è„‘å­è¦æ¸…é†’ä¸€ç‚¹ï¼Œéœ€è¦æ”¹çš„åœ°æ–¹ä¿®æ”¹ï¼Œä¸éœ€è¦çš„åœ°æ–¹ä¸ä¿®æ”¹ï¼å› ä¸ºä»£ç æ— æ³•é˜…è¯»ï¼

## 8ä¸ªå¢ç›ŠæŒ¡ä½

æ›¿æ¢æ‰€æœ‰è·Ÿå¢ç›ŠæŒ¡ä½æœ‰å…³çš„ä½ç½®ã€‚

# 7.14

ä»Šå¤©ç»§ç»­è°ƒè¯•å•æ¿ã€‚

## ä¿®æ”¹fpga

### ä¿®æ”¹æšä¸¾ç±»

ç°åœ¨çš„æšä¸¾ç±»çœ‹ç€éå¸¸éš¾å—ï¼Œå…ˆå…¨å±€ä¿®æ”¹æ‰€æœ‰çš„æšä¸¾ç±»å§ã€‚

### å¢ç›Šé…ç½®

é‡æ–°ç†è§£ä¸‹å¢ç›Šé…ç½®CODEéœ€æ±‚ã€‚ç°åœ¨æ¯ä¸ªé…ç½®æ–‡ä»¶åŒ…å«ä¸¤ä¸ªä¿¡æ¯ï¼š

- å¢ç›Š`gain`
- æ ¡å‡†å€¼`reparation`

ä¸¤ä¸ªå˜é‡å‡åœ¨ç»“æ„ä½“`user_cfg_t`ä¸­å®šä¹‰ï¼š

```C
uint32_t  gain[MAX_CHN_CNT];
int32_t   reparation[GAIN_CAL_CNT][MAX_CHN_CNT];
```

è€Œè¿™ä¸ªç»“æ„ä½“ä¼šåœ¨ä»£ç åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé€šè¿‡å‡½æ•°`int get_user_cfg(const char* conf, user_cfg_t* cfg)`æ¥ä»é…ç½®ä¸­è¯»å–ã€‚

è¿™ä¸ªè¡¥å¿å€¼æ˜¯ä¸€ä¸ªå¢ç›Šã€é€šé“å†³å®šçš„äºŒç»´æ•°ç»„ã€‚å…¶åœ¨`INI`æ–‡ä»¶çš„é…ç½®ç±»ä¼¼ï¼š

```ini
reparation_-20=0,0,0,0,0,0,0,0
reparation_-10=0,0,0,0,0,0,0,0
reparation_-6=0,0,0,0,0,0,0,0
reparation_0=0,0,0,0,0,0,0,0
reparation_6=0,0,0,0,0,0,0,0
reparation_20=0,0,0,0,0,0,0,0
reparation_30=0,0,0,0,0,0,0,0
reparation_40=0,0,0,0,0,0,0,0
```

æ ¼å¼ä¸ºï¼š

```INI
reparation_gain=chn1_rep, chn2_rep, ... , chn8_rep
```

ç°åœ¨æƒ³å®ç°ç»™å®šé…ç½®ä¿¡æ¯å’Œé€šé“ï¼Œæ¥é…ç½®å¯¹åº”é€šé“çš„CODEå€¼ã€‚

## ä¿®æ”¹bug

# 7.15

## å¢ç›ŠæŒ¡ä½ä¸åŒ¹é…

### gain = 1

ç°åœ¨å› ä¸ºå‰ç«¯å‘è¿‡æ¥çš„å¢ç›ŠæŒ¡ä½æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼š

```bash
Mon Jul 14 00:16:10 2025 daemon.info cm_server: (bdz_handler.c:1093) body.p {"chns":[1,0,0,0,0,0,0,0],"gain":1,"freq":32,"state":0}"token":849414544}}data":[]}}
Mon Jul 14 00:16:10 2025 daemon.info cm_server: (bdz_handler.c:1098) recv plot request.
Mon Jul 14 00:16:10 2025 daemon.info cm_server: (bdz_handler.c:1167) plot, gain=1, chns=[1,0,0,0,0,0,0,0]
```

æˆ‘ä»¬è®¾ç½®çš„20dbå¢ç›Šï¼Œæ˜¯æ€ä¹ˆå˜æˆ`gain=1`çš„æ•°æ®ä¼ è¾“è¿‡æ¥çš„å‘¢ï¼Ÿ

çœ‹æ—¥å¿—æ‰“å°ä½ç½®æ˜¯åœ¨`bdz_handler.c`ä¸­çš„ 1093 è¡Œã€‚æ¥åˆ°`cm_server`é¡¹ç›®ä¸‹ï¼ŒæŸ¥çœ‹ 1093 è¡Œä»£ç ï¼š

```C
static void getplot_handler(struct uh_connection * conn, int event) {
    ...
    struct uh_str body = conn->extract_body(conn);
	int gain_range[] = {0, 20, 30};
    log_info("body.p %s\n", body.p);
    ...
}
```

å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå‡½æ•°æ˜¯è¢«è°ƒç”¨åä¼ å…¥çš„å‚æ•°`conn`å‘é€è¿‡æ¥çš„ã€‚

é‚£ä¹ˆè°è°ƒç”¨çš„è¿™ä¸ªå‡½æ•°`getplot_handler()`å‘¢ï¼Ÿç»è¿‡è®¨è®ºï¼Œå‘ç°æ˜¯å‰ç«¯ç•Œé¢è°ƒç”¨çš„è¿™ä¸ªå‡½æ•°ï¼Œéœ€è¦å‰ç«¯è°ƒæ•´ã€‚

ç°åœ¨å·²ç»çŸ¥é“è¿™ä¸ªå¥‡æ€ªçš„é¡¹ç›®ï¼Œä¼šç”¨åˆ°ç›¸åŒçš„`share.h`ï¼Œå…¶ä¸­åŒ…æ‹¬äº†å¾ˆå¤šçš„å®å®šä¹‰å’Œç»“æ„ä½“ã€‚æ€ªä¸å¾—æˆ‘å‘ç°`cm_server`é¡¹ç›®ä¸­å¾ˆå¤šå®å®šä¹‰æ‰¾ä¸åˆ°ã€‚

## ä¿®æ”¹gain_range

### æ­§ä¹‰çš„å˜é‡

é¦–å…ˆå°±æ˜¯è¦ä¿®æ”¹ç»Ÿä¸€çš„å¢ç›ŠæŒ¡ä½å’Œå¢ç›Šå€¼ã€‚å°†å‰ç«¯ä¼ è¾“è¿‡æ¥çš„å¢ç›ŠæŒ¡ä½`calc_gain`æ”¹ä¸º

```C
uint32_t calc_gain_idx;       /* åœ¨æŸå¢ç›ŠæŒ¡ä½ä¸‹è¿›è¡Œæ ¡å‡†æˆ–æŸ¥çœ‹æ³¢å½¢ */
```

éœ€è¦åŒæ—¶ä¿®æ”¹è¿™ä¸¤ä¸ªé¡¹ç›®ä»¥æ±‚åŒæ­¥ã€‚

### å…¨å±€ä¿®æ”¹

å°†`gain_range`é¦–å…ˆæ”¹åä¸ºç»Ÿä¸€çš„å…¨å±€å˜é‡`g_supported_gain_db`ã€‚

### get_status_handler

åœ¨`/get_status`è·¯å¾„ä¸‹ã€‚è¿”å›ç»™å‰ç«¯JSONæ•°æ®ï¼š

- `reparation`ï¼šä¼šæ”¶åˆ° 8 ä¸ªæ•°ç»„æ•°æ®ã€‚æ¯ä¸ªæ•°ç»„åŒ…å« 8 ä¸ªé€šé“çš„æ•°æ®ã€‚
- `gain_range`ï¼šå°†ä¼šæ”¶åˆ°8ä¸ªå¢ç›ŠæŒ¡ä½

### set_configs_handler

`/set_configs`è·¯å¾„ä¸‹ï¼Œå‰ç«¯éœ€è¦ä¼ è¾“çš„æ ¼å¼ä¿®æ”¹ï¼š

- `reparation`ï¼šéœ€è¦ä¼ å…¥ 8 ä¸ªå¢ç›ŠæŒ¡ä½ä¸‹çš„é€šé“æ•°æ®ã€‚æ¯ä¸ªå¢ç›ŠæŒ¡ä½ä¸‹ï¼ŒåŒ…å«äº† 8 ä¸ªé€šé“ã€‚å°±æ˜¯ 8 Ã— 8 çš„äºŒç»´æ•°ç»„

### adjust_handler

`/adjust`å‰ç«¯éœ€è¦ä¿®æ”¹ä¼ å…¥å‚æ•°ï¼š

- `gain`ï¼šä»£è¡¨çš„å¢ç›ŠæŒ¡ä½ï¼Œéœ€è¦ä¿®æ”¹ä¸º`gain_idx`ï¼Œå¹¶ä¸”èŒƒå›´æ˜¯`[0, 7]`å…± 8 ä¸ªã€‚

### getplot_handler

`/plot`å‰ç«¯éœ€è¦ä¿®æ”¹ä¼ å…¥çš„å‚æ•°ï¼š

- `gain`ï¼šä¿®æ”¹ä¸º`gain_idx`ï¼Œä»£è¡¨å¢ç›ŠæŒ¡ä½ã€‚èŒƒå›´ä¸º`[0, 7]`å…±8ä¸ª

## å¿«é€Ÿç¼–è¯‘è„šæœ¬2

ç°åœ¨å‡ºç°äº†å¦ä¸€ä¸ªç‰›é€¼é¡¹ç›®ï¼Œé‚£å°±æ˜¯`cm_server`ã€‚ç°åœ¨ä¹Ÿéœ€è¦ç»™`cm_server`åšä¸€ä¸ªå¿«é€Ÿç¼–è¯‘è„šæœ¬ï¼Œè¦å®ç°çš„æ˜¯ï¼š

1. ä¿å­˜å½“å‰è·¯å¾„
2. åˆ‡æ¢ç›®å½•åˆ°`/home/solid/mt7621_sdk_base`
3. æ‰§è¡Œè„šæœ¬`./mk.sh cm_server`
4. ç¼–è¯‘å®Œæˆåï¼Œè¿›å…¥ç›®å½•`/home/solid/mt7621_sdk_base/tf-card`è·å–åˆ°ç¼–è¯‘æ–‡ä»¶`cm_server`
5. é€šè¿‡scpå‘½ä»¤ï¼Œå°†`cm_server`å¤åˆ¶åˆ°`10.1.2.180\www\cm_server`
6. åˆ‡æ¢åˆ°ä¹‹å‰çš„å·¥ä½œè·¯å¾„

## æ„å»ºæµ‹è¯•ä½“ç³»

ç°åœ¨æ”¹ä»£ç ï¼Œæ—¢éœ€è¦ç†è§£åŸæœ‰é€»è¾‘ï¼Œåˆè¦åŠ å…¥æ–°çš„é€»è¾‘ã€‚å¯¼è‡´ä¿®æ”¹å¾ˆç–²æƒ«ã€‚

å…ˆä»æ€»ä½“ç†è§£ä»£ç ï¼Œç„¶åå†é‡æ„ä»£ç ã€‚

## è®¾å¤‡æ ¡å‡†

æˆ‘ä»¬å°±ä»¥â€œè®¾å¤‡æ ¡å‡†â€åŠŸèƒ½å¼€å§‹ï¼Œçœ‹ä¸‹å†…éƒ¨é€»è¾‘æ˜¯æ€æ ·çš„ã€‚

### æŸ¥è¯¢çŠ¶æ€ä¿¡æ¯

ç‚¹å¼€â€œè®¾å¤‡æ ¡å‡†â€åŠŸèƒ½ï¼Œç½‘é¡µä¼šè¯·æ±‚

```html
http://10.1.2.180/get_status
```

æ­¤è¯·æ±‚å¯¹åº”çš„`cm_server`å‡½æ•°ä¸º`get_status_handler`ï¼š

```C
srv->add_path_handler(srv, "/get_status", get_status_handler);
```

é˜…è¯»ä»£ç ï¼Œå‘ç°å¾ˆå¤šæ•°æ®æ˜¯éœ€è¦é€šè¿‡è®¿é—®ç»“æ„ä½“æ‰è¡Œï¼Œä½†æ˜¯ç»“æ„ä½“å¹¶æ²¡æœ‰åœ¨æ­¤å®šä¹‰ã€‚æ€ä¹ˆè·å–åˆ°çš„å‘¢ï¼Ÿç­”æ¡ˆåœ¨`collecter`çš„

```C
static int create_global_mem()
```

æ­¤å‡½æ•°ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºä¸€å—å…±äº«å†…å­˜åŒºåŸŸï¼Œå¹¶å°†å…¶åˆ’åˆ†ä¸ºä¸åŒçš„é€»è¾‘éƒ¨åˆ†ï¼Œç”¨äºå­˜å‚¨åº”ç”¨ç¨‹åºçš„å…¨å±€é…ç½®ã€çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯ã€‚é€šè¿‡ä½¿ç”¨å…±äº«å†…å­˜ï¼Œå¯ä»¥å®ç°ä¸åŒè¿›ç¨‹ä¹‹é—´çš„æ•°æ®å…±äº«ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªè¿›ç¨‹è´Ÿè´£æ•°æ®é‡‡é›†ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹è´Ÿè´£ Web æœåŠ¡ï¼Œå®ƒä»¬éƒ½å¯ä»¥è®¿é—®å’Œæ›´æ–°è¿™äº›å…±äº«æ•°æ®ã€‚æ—¥åéœ€è¦è®¤çœŸç†è§£ã€‚

è¿™ä¸ªç½‘é¡µä¸€å¼€å§‹è·å–çš„ï¼Œå°±æ˜¯é‡‡é›†ä¿¡æ¯ã€‚

### å›¾è°±æŸ¥çœ‹

åœ¨â€œè®¾å¤‡æ ¡å‡†â€ç•Œé¢ä¸­ï¼Œé€‰ä¸­ï¼š

- é€šé“3
- å¢ç›Š30db
- ä¿¡å·æºå³°å³°å€¼ï¼š0.1

è¯·æ±‚çš„åœ°å€ä¸º

```html
http://10.1.2.180/plot
```

è¯·æ±‚ä½“ä¸ºï¼š

```json
{"chns":[0,0,1,0,0,0,0,0],"gain":0,"freq":32,"state":1,"token":881607477}
```

å¯¹åº”`cm_server`çš„ plot å¤„ç†å‡½æ•°ä¸º`getplot_handler`ï¼š

```C
srv->add_path_handler(srv, "/plot", getplot_handler);
```

# 7.16

ä»Šå¤©å°±æ˜¯ç»§ç»­ç†è§£ä¹‹å‰çš„é€»è¾‘ã€‚ç°åœ¨å¸ƒç½®ä¸Šæ–°ç‰ˆæœ¬å‰ç«¯ã€`cm_server`å’Œ`collecter`åï¼Œé‡å¯ã€‚

## tee

æŠŠ `tail -f` è¾“å‡ºçš„å­—ç¬¦å®æ—¶åœ°ä¿å­˜åˆ°æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚

```bash
tail -f message.log | tee output.txt
```

## ç†è§£è¿›ç¨‹é€šä¿¡

`cm_server`æ¥æ”¶åˆ°ç»˜å›¾è¯·æ±‚åä¿®æ”¹äº†`g_app_cfgctrl->show_charts`è¿™ä¸ªå˜é‡ã€‚ç–‘æƒ‘`collecter`è¿›ç¨‹å¦‚ä½•è·å–åˆ°è¿™ä¸ªä¿®æ”¹ã€‚

### cm_serverå¯åŠ¨è„šæœ¬

æ‰“å°è¿›ç¨‹`cm_server`ä¿¡æ¯ï¼š

```bash
root@bdz:/www# ps | grep cm_server
 1455 root      1312 S    grep cm_server
 1786 root      1312 S    /bin/sh /www/cm_server.sh
 1795 root     23280 S    /www/cm_server -a 0:80 -h /www/
```

å¯ä»¥çœ‹å‡ºæ‰§è¡Œäº†å¯åŠ¨è„šæœ¬`cm_server.sh`ï¼š

```bash
#!/bin/sh

while [ 1 ]
do 
	echo `date` "cm_server start!" >> /version/collecter.log
	/www/cm_server -a 0:80 -h /www/
	echo `date` "cm_server stop!" >> /version/collecter.log
	sleep 3 
done
```

æ‰§è¡Œä½äº`/www/`ç›®å½•ä¸‹çš„`cm_server`å¯æ‰§è¡Œæ–‡ä»¶ã€‚å…¶ä¸­çš„`-a 0:80` å’Œ `-h /www/` æ˜¯ä¼ é€’ç»™`cm_server`ç¨‹åºçš„**å‘½ä»¤è¡Œå‚æ•°**

é‚£ä¹ˆè¿™ä¸¤ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

é€šè¿‡æŸ¥çœ‹mainå‡½æ•°ï¼Œå¯ä»¥å¾—çŸ¥ä¿¡æ¯æ˜¯ï¼š

- å¯åŠ¨ **`cm_server` ç¨‹åºä½œä¸ºä¸€ä¸ª HTTP æœåŠ¡å™¨**ï¼Œå®ƒå°†åœ¨ **ç«¯å£ `80` ä¸Šç›‘å¬æ‰€æœ‰ä¼ å…¥çš„ç½‘ç»œè¿æ¥**ã€‚
- å½“æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå®ƒä¼š**ä» `/www/` ç›®å½•ä¸­æŸ¥æ‰¾å¹¶æä¾›è¯·æ±‚çš„èµ„æº**ã€‚
- æ­¤å¤–ï¼Œå®ƒè¿˜ä¼šæ ¹æ® `reg_handlers` å‡½æ•°æ³¨å†Œçš„é€»è¾‘æ¥å¤„ç†ç‰¹å®šçš„è¯·æ±‚ï¼Œæ¯”å¦‚ä½ æåˆ°çš„â€œç»˜å›¾è¯·æ±‚â€ã€‚

å¹¶ä¸”å¦ä¸€ä¸ªé‡è¦çš„ç‚¹æ˜¯ï¼š`reg_handlers` å’Œ `create_global_mem` å‡½æ•°ä»£ç ã€‚

### reg_handlers

å…¶ä¸º`cm_server` ä½œä¸º Web æœåŠ¡å™¨çš„æ ¸å¿ƒé…ç½®éƒ¨åˆ†ã€‚å®ƒçš„ä¸»è¦èŒè´£æ˜¯ï¼š

- åˆå§‹åŒ–å…¨å±€å†…å­˜ï¼šè°ƒç”¨ `create_global_mem()` å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ˜¯å…³é”®ï¼Œå› ä¸ºå®ƒè´Ÿè´£è®¾ç½®è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ã€‚
- è®¾ç½®é»˜è®¤è¯·æ±‚å¤„ç†å™¨ï¼šå½“å®¢æˆ·ç«¯è¯·æ±‚çš„ URL æ²¡æœ‰è¢«å…¶ä»–ç‰¹å®šçš„å¤„ç†å™¨åŒ¹é…æ—¶ï¼Œ`default_handler` ä¼šè¢«è°ƒç”¨æ¥å¤„ç†è¿™äº›è¯·æ±‚ã€‚
- æ³¨å†Œç‰¹å®š URL è·¯å¾„çš„å¤„ç†å‡½æ•°

`reg_handlers` ç¡®ä¿äº† `cm_server` ä¸ä»…èƒ½æä¾›é™æ€ç½‘é¡µæœåŠ¡ï¼Œè¿˜èƒ½å“åº”ç‰¹å®šçš„ API è¯·æ±‚æ¥æ‰§è¡Œå„ç§è®¾å¤‡ç®¡ç†å’Œæ•°æ®è·å–åŠŸèƒ½ã€‚

### `create_global_mem`

```C
static int create_global_mem()
{
	int iRet = 0;
    int s_shm_id = -1;
    unsigned char *s_shm_addr = NULL;

    // 1. è·å–æˆ–åˆ›å»ºå…±äº«å†…å­˜æ®µ
	s_shm_id=shmget((key_t)COMM_MEM_KEY, GLOBAL_MEM_SIZE,0666|IPC_CREAT);
	if(-1 == s_shm_id){
		log_err("shmget error\n");
		return -1;
	}
	
    // 2. å°†å…±äº«å†…å­˜æ®µé™„åŠ åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´
	s_shm_addr=(unsigned char *)shmat(s_shm_id, NULL,0);
	if(-1 == (int)s_shm_addr){
		log_err("shmat error\n");
		return -1;
	}else{
		log_info("share-mem addr=%p\n", s_shm_addr);
	}
	
    // 3. å°†å…±äº«å†…å­˜åŒºåŸŸçš„ä¸åŒåç§»é‡æ˜ å°„åˆ°å…¨å±€ç»“æ„ä½“æŒ‡é’ˆ
	g_app_cfgctrl = (T_app_cfgctrl*)(s_shm_addr);
	g_stat_group = (T_stat_group*)(s_shm_addr+2*MEM_1K);
	g_error_group = (T_error_group*)(s_shm_addr+3*MEM_1K);

    iRet = create_recv_buf();

	return iRet;
}
```

è¿™ä¸ªå‡½æ•°åœ¨`cm_server`å’Œ`collecter`ä¸­å‡å­˜åœ¨ã€‚

`create_global_mem` å‡½æ•°æ˜ç¡®åœ°ä½¿ç”¨äº† **å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰** ä½œä¸ºè¿›ç¨‹é—´é€šä¿¡çš„æœºåˆ¶ã€‚

1. `shmget((key_t)COMM_MEM_KEY, GLOBAL_MEM_SIZE, 0666 | IPC_CREAT);`
   - `shmget` æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äº**è·å–æˆ–åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜æ®µ**ã€‚
   - `COMM_MEM_KEY`ï¼šè¿™æ˜¯ä¸€ä¸ªé”®å€¼ï¼ˆ`key_t` ç±»å‹ï¼‰ï¼Œå®ƒå”¯ä¸€æ ‡è¯†ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå…±äº«å†…å­˜æ®µã€‚å¦‚æœ `cm_server` å’Œ `collecter` éƒ½ä½¿ç”¨ç›¸åŒçš„ `COMM_MEM_KEY`ï¼Œå®ƒä»¬å°±èƒ½è®¿é—®åŒä¸€ä¸ªå…±äº«å†…å­˜åŒºåŸŸã€‚ï¼ˆå¾ˆæ˜æ˜¾ï¼Œåœ¨`collecter`ä¸­ä¹Ÿæœ‰ç›¸åŒçš„æ­¤idï¼‰
2. **`s_shm_addr = (unsigned char \*)shmat(s_shm_id, NULL, 0);`**
   - `shmat` æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºå°†å‰é¢è·å¾—çš„å…±äº«å†…å­˜æ®µ**é™„åŠ ï¼ˆattachï¼‰åˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´**ã€‚è¿™æ„å‘³ç€è¯¥è¿›ç¨‹ç°åœ¨å¯ä»¥åƒè®¿é—®è‡ªå·±çš„æ™®é€šå†…å­˜ä¸€æ ·è®¿é—®è¿™å—å…±äº«å†…å­˜ã€‚
3. **`g_app_cfgctrl = (T_app_cfgctrl\*)(s_shm_addr);`**
   - è¿™è¡Œä»£ç æ˜¯æ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼å®ƒå°†å…±äº«å†…å­˜çš„èµ·å§‹åœ°å€ `s_shm_addr` å¼ºåˆ¶è½¬æ¢ä¸º `T_app_cfgctrl*` ç±»å‹ï¼Œå¹¶èµ‹å€¼ç»™**å…¨å±€å˜é‡ `g_app_cfgctrl`**ã€‚
   - è¿™æ„å‘³ç€ `g_app_cfgctrl` æŒ‡å‘çš„å†…å­˜åŒºåŸŸå®é™…ä¸Šæ˜¯å…±äº«å†…å­˜çš„ä¸€éƒ¨åˆ†ã€‚

### `collecter` å¦‚ä½•è·å– `show_charts` çš„ä¿®æ”¹ï¼Ÿ

ç°åœ¨ç­”æ¡ˆå¾ˆæ¸…æ™°äº†ï¼š

- **å…±äº«å†…å­˜ï¼š** `cm_server` å’Œ `collecter` éƒ½é€šè¿‡è°ƒç”¨ `shmget` å’Œ `shmat`ï¼Œä½¿ç”¨**ç›¸åŒçš„ `COMM_MEM_KEY`** æ¥è®¿é—®åŒä¸€ä¸ªç‰©ç†å…±äº«å†…å­˜åŒºåŸŸã€‚
- **æŒ‡é’ˆæ˜ å°„ï¼š** ä¸¤ä¸ªè¿›ç¨‹éƒ½ä¼šå°†å…±äº«å†…å­˜çš„èµ·å§‹åœ°å€æ˜ å°„åˆ°å®ƒä»¬å„è‡ªçš„ `g_app_cfgctrl` æŒ‡é’ˆï¼ˆæˆ–å…¶ä»–ç›¸å…³æŒ‡é’ˆï¼Œå¦‚ `g_stat_group`, `g_error_group`ï¼‰ã€‚
- **ç›´æ¥è®¿é—®ï¼š** å½“ `cm_server`ï¼ˆä¾‹å¦‚åœ¨ `getplot_handler` ä¸­ï¼‰ä¿®æ”¹ `g_app_cfgctrl->show_charts` æ—¶ï¼Œå®ƒå®é™…ä¸Šæ˜¯**ç›´æ¥ä¿®æ”¹äº†å…±äº«å†…å­˜ä¸­çš„æ•°æ®**ã€‚
- **å®æ—¶å¯è§ï¼š** ç”±äº `collecter` ä¹Ÿå°†åŒä¸€å—å…±äº«å†…å­˜é™„åŠ åˆ°äº†è‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œå¹¶ä¸”å…¶ `g_app_cfgctrl` æŒ‡å‘ç›¸åŒçš„å…±äº«å†…å­˜åœ°å€ï¼Œå› æ­¤ **`collecter` å¯ä»¥ç›´æ¥è¯»å–è¿™å—å…±äº«å†…å­˜ä¸­çš„ `g_app_cfgctrl->show_charts` å˜é‡ï¼Œä»è€Œå®æ—¶è·å–åˆ° `cm_server` æ‰€åšçš„ä¿®æ”¹ã€‚**

ç†è§£äº†è¿›ç¨‹é—´çš„ç›¸äº’é€šä¿¡åï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æä¸ºä»€ä¹ˆæ²¡æœ‰æ•°æ®ã€‚

## æ—¥å¿—åˆ†æ

### æ¥æ”¶å¹¶å¤„ç†ç»˜å›¾è¯·æ±‚

```bash

Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1206) æ¥æ”¶åˆ°ç»˜å›¾è¯·æ±‚ä½“: {"chns":[1,0,0,0,0,0,0,0],"gain_idx":3,"freq":32,"state":0}
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1213) æ£€æµ‹åˆ°æ–°çš„ç»˜å›¾è¯·æ±‚ï¼Œé‡ç½®ç³»ç»Ÿç»˜å›¾çŠ¶æ€ä¸º 'e_calc_off'ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1251) å·²é…ç½®é€šé“ 1 çš„è¯·æ±‚çŠ¶æ€ä¸º: 1ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1251) å·²é…ç½®é€šé“ 2 çš„è¯·æ±‚çŠ¶æ€ä¸º: 0ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1251) å·²é…ç½®é€šé“ 3 çš„è¯·æ±‚çŠ¶æ€ä¸º: 0ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1251) å·²é…ç½®é€šé“ 4 çš„è¯·æ±‚çŠ¶æ€ä¸º: 0ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1251) å·²é…ç½®é€šé“ 5 çš„è¯·æ±‚çŠ¶æ€ä¸º: 0ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1251) å·²é…ç½®é€šé“ 6 çš„è¯·æ±‚çŠ¶æ€ä¸º: 0ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1251) å·²é…ç½®é€šé“ 7 çš„è¯·æ±‚çŠ¶æ€ä¸º: 0ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1251) å·²é…ç½®é€šé“ 8 çš„è¯·æ±‚çŠ¶æ€ä¸º: 0ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1263) åˆå§‹åŒ–é¦–ä¸ªæ´»åŠ¨é€šé“ç´¢å¼•ä¸º: 0ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1274) å·²é…ç½®ç»˜å›¾é‡‡æ ·é¢‘ç‡ä¸º: 32ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1292) å·²é…ç½®ç»˜å›¾å¢ç›Šç´¢å¼•ä¸º: 3 (å¯¹åº”å®é™…å¢ç›Š: 0 dB)ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1305) å·²å°†å…¨å±€ç»˜å›¾çŠ¶æ€è®¾ç½®ä¸º 'e_calc_req'ï¼Œå¹¶ç”Ÿæˆæ–°ä¼šè¯ä»¤ç‰Œ: 493333836ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1320) å·²é‡ç½®æ•°æ®ç±»å‹å’Œåç§»é‡ï¼Œå‡†å¤‡å¼€å§‹æ•°æ®ä¼ è¾“ã€‚
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1324) ç»˜å›¾ä¼šè¯å·²å¯åŠ¨ã€‚å¢ç›Šç´¢å¼•: 3 (å®é™…å¢ç›Š: 0 dB)ï¼Œé€‰ä¸­é€šé“: [
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1327) 1,
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1327) 0,
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1327) 0,
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1327) 0,
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1327) 0,
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1327) 0,
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1327) 0,
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1327) 0
Wed Jul 16 10:58:25 2025 daemon.info cm_server: (bdz_handler.c:1329) ]
```

**å¤„ç†æµç¨‹**ï¼š

1. æ ¡éªŒé€šé“æ•°é‡(`MAX_CHN_CNT=8`)

2. ä¿å­˜é€šé“æ¿€æ´»çŠ¶æ€åˆ°å…¨å±€é…ç½®

3. ç¡®å®šé¦–ä¸ªæ¿€æ´»é€šé“ç´¢å¼•(`current_channel_index=0`)

4. éªŒè¯å¢ç›Šç´¢å¼•æœ‰æ•ˆæ€§(`0 <= gain_idx < GAIN_CAL_CNT`)

5. ç”Ÿæˆéšæœºä¼šè¯ä»¤ç‰Œ(`current_session_token=493333836`)

6. è¿”å›å“åº”ï¼š

   ```json
   {
     "code": 20000,
     "state": 1,           // e_calc_req
     "token": 493333836,
     "message": "æ•°æ®è¯·æ±‚å·²å‘é€..."
   }
   ```

### æ‰§è¡Œæ•°æ®é‡‡é›†

å½“ `collecter` æ£€æµ‹åˆ° `g_app_cfgctrl->show_charts` æˆ–ç›¸å…³çŠ¶æ€å˜ä¸º `e_calc_req` æ—¶ï¼Œå®ƒå°±çŸ¥é“æœ‰æ–°çš„ç»˜å›¾ä»»åŠ¡æ¥äº†ã€‚

`collecter` æ„ŸçŸ¥çŠ¶æ€å˜åŒ–å¹¶æ‰§è¡Œæ•°æ®é‡‡é›†ï¼ˆå…±äº«å†…å­˜é©±åŠ¨ï¼‰ã€‚æ­¤éƒ¨åˆ†æ—¥å¿—æ¥è‡ªäºè¿›ç¨‹`collecter`:

```bash
10:58:25 2025 : [INFO][calc_data](87)Entering calc_data. Current state: 1 (plot mode).
10:58:25 2025 : [INFO][calc_data](97)Entering e_calc_req state for plot operation.
10:58:25 2025 : [INFO][calc_data](103)Channel 0 requested for plot.
10:58:25 2025 : [INFO][calc_data](123)Setting channel 1 gain to 0 dB (from gain ID 3).
10:58:25 2025 : [INFO][calc_data](123)Setting channel 2 gain to 0 dB (from gain ID 3).
10:58:25 2025 : [INFO][calc_data](123)Setting channel 3 gain to 0 dB (from gain ID 3).
10:58:25 2025 : [INFO][calc_data](123)Setting channel 4 gain to 0 dB (from gain ID 3).
10:58:25 2025 : [INFO][calc_data](123)Setting channel 5 gain to 0 dB (from gain ID 3).
10:58:25 2025 : [INFO][calc_data](123)Setting channel 6 gain to 0 dB (from gain ID 3).
10:58:25 2025 : [INFO][calc_data](123)Setting channel 7 gain to 0 dB (from gain ID 3).
10:58:25 2025 : [INFO][calc_data](123)Setting channel 8 gain to 0 dB (from gain ID 3).
10:58:25 2025 : [INFO][calc_data](126)Setting collection frequency to 32 Hz.
10:58:25 2025 : [INFO][calc_data](133)Calculated scaling factor (xs): 1160802.000000 (based on gain 0 dB).
10:58:26 2025 : [ERROR][arp_get_hw_from_ipaddr](84)system flush arp failed and exit code 1
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=0 write=00000000  readbk=00000000
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=1 write=94ea0000  readbk=94ea0000
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=2 write=9f7bf425  readbk=9f7bf425
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=3 write=00450008  readbk=00450008
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=4 write=00001e04  readbk=00002004
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=5 write=11800000  readbk=11800000
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=6 write=010a0000  readbk=010af569
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=7 write=010ab402  readbk=010ab402
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=8 write=a6132402  readbk=a6132402
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=9 write=0a04a613  readbk=0c04a613
10:58:26 2025 : [INFO][fpga_init](295)FPGA UDP head index=10 write=00000000  readbk=00000000
10:58:26 2025 : [INFO][fpga_init](303)FPGA date = 202507140001 ver=164
10:58:27 2025 : [INFO][fpga_set_ad_clock](95)AD clock set from 0xFF to 0x8 (enum value 8).
10:58:27 2025 : [INFO][fpga_init](311)chn0 gain=0 reparation=0
10:58:27 2025 : [INFO][fpga_init](311)chn1 gain=0 reparation=0
10:58:27 2025 : [INFO][fpga_init](311)chn2 gain=0 reparation=0
10:58:27 2025 : [INFO][fpga_init](311)chn3 gain=0 reparation=0
10:58:27 2025 : [INFO][fpga_init](311)chn4 gain=0 reparation=0
10:58:27 2025 : [INFO][fpga_init](311)chn5 gain=0 reparation=0
10:58:27 2025 : [INFO][fpga_init](311)chn6 gain=0 reparation=0
10:58:27 2025 : [INFO][fpga_init](311)chn7 gain=0 reparation=0
10:58:27 2025 : [INFO][calc_data](137)FPGA initialized for new configuration.	  
10:58:27 2025 : [INFO][calc_data](142)Plot mode: Transitioning to e_calc_cfg_ok.
10:58:27 2025 : [INFO][calc_data](159)Data collection enabled. Counter reset.
10:58:27 2025 : [INFO][calc_data](87)Entering calc_data. Current state: 2 (plot mode).
10:58:27 2025 : [INFO][calc_data](164)Entering e_calc_cfg_ok state for plot operation. Current packet count: 0.
10:58:27 2025 : [INFO][calc_data](166)plot operation: Configuration done. Starting data drop phase.
10:58:27 2025 : [INFO][calc_data](87)Entering calc_data. Current state: 2 (plot mode).
10:58:27 2025 : [INFO][calc_data](164)Entering e_calc_cfg_ok state for plot operation. Current packet count: 1.
```

å¥½çš„ï¼Œæˆ‘å¹¶ä¸çŸ¥é“å‡ºç°ä»€ä¹ˆé—®é¢˜äº†ã€‚ç°åœ¨æˆ‘æƒ³åˆ‡æ¢åˆ°æœ€åˆçš„ç‰ˆæœ¬è¿›è¡Œé‡æ–°å¼€å‘ã€‚

é‡æ„å¯ä»¥ï¼Œå…ˆå¾—ç†è§£æœ€åˆçš„é€»è¾‘~ï¼

## å›é€€åˆ°æŸä¸ªæ—§ç‰ˆæœ¬

è¿™ç§åšæ³•å¸¸ç”¨äºä½ æƒ³æŠŠ **ç‰ˆæœ¬åº“çŠ¶æ€**æ¢å¤ä¸ºæ—§çš„é‚£ä¸€ç‰ˆã€‚

### æ­¥éª¤å¦‚ä¸‹ï¼š

æŸ¥çœ‹æäº¤å†å²

```bash
svn log -l 10
```

å‡è®¾å½“å‰æ˜¯ **r20**ï¼Œä½ æƒ³å›æ»šåˆ° **r19**ï¼š

```bash
svn merge -r 20:19 .
```

ç„¶åæäº¤ï¼š

```bash
svn commit -m "å›æ»šåˆ°r19"
```

### ğŸ” åŸç†è¯´æ˜ï¼š

è¿™æ˜¯ä¸€æ¬¡ **åå‘ merge**ï¼Œå®ƒä¼šæŠŠ r20 ä¸­çš„æ›´æ”¹æ’¤é”€ï¼ˆè¿˜åŸä¸º r19 çš„å†…å®¹ï¼‰ã€‚

# 7.17

ä»Šå¤©ç»§ç»­å§ã€‚å…ˆåŠ å…¥å……åˆ†çš„æ³¨é‡Šï¼Œé…åˆç†è§£æ ¡å‡†æµç¨‹å’Œè·å–å›¾åƒã€‚

## æ ¡å‡†

### å…¥å‚

- é€šé“ï¼šé€šé“1
- å¢ç›Šï¼š0db
- ä¿¡å·æºå³°å³°å€¼ï¼š100mv

è‡ªåŠ¨æ ¡å‡†ã€‚è°ƒç”¨`cm_server`çš„`adjust`åŠŸèƒ½ã€‚å¯¹åº”å‡½æ•°`adjust_handler()`

### calc_data

è¿™æ˜¯`collecter`çš„è®¡ç®—å‡½æ•°ã€‚æˆ‘ç°åœ¨æ¯”è¾ƒæ„Ÿå…´è¶£çš„æ˜¯ï¼š

```C
xs = (float)((1ull << 31) * pow(10, (c->cfg.gain[0] / 20)) / 1000 / 1.85);
```

ç–‘é—®ï¼š

- ADCçš„å‚æ•°ï¼š 32 ä½ï¼Œæœ€å¤§æ•°å­—è¾“å‡ºå€¼ï¼Œæ»¡é‡ç¨‹ç”µå‹ï¼Œå½’ä¸€åŒ–å¸¸æ•°è¿™äº›åè¯éƒ½æ˜¯æ˜¯ä»€ä¹ˆï¼Ÿ

åŸå§‹çš„ ADC æ•°å­—å€¼æ˜¯ç»è¿‡ VGA æ”¾å¤§åï¼Œå†ç”± ADC è½¬æ¢å¾—åˆ°çš„ã€‚ä¸ºäº†å¾—åˆ°**åŸå§‹ä¿¡å·ï¼ˆVGA è¾“å…¥ç«¯ï¼‰çš„çœŸå®ç”µå‹å¹…å€¼**ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. å°† ADC çš„æ•°å­—å€¼è½¬æ¢ä¸ºå…¶è¾“å…¥ç«¯çš„å®é™…ç”µå‹ã€‚
2. å†é€šè¿‡ VGA çš„å¢ç›Šï¼Œå°†è¿™ä¸ªç”µå‹â€œç¼©å°â€å› VGA æ”¾å¤§ä¹‹å‰çš„åŸå§‹ç”µå‹ã€‚

## ADCçš„ç›¸å…³å‚æ•°

**ADC (Analog-to-Digital Converter)** å·¥ä½œåŸç†çš„å…³é”®å‚æ•°ã€‚

### Bit(Resolution)

å°±æ˜¯èƒ½å°†æ¨¡æ‹Ÿä¿¡å·è½¬ä¸ºå¤šå°‘ä½çš„äºŒè¿›åˆ¶æ•°ã€‚ä¸€ä¸ª N ä½çš„ ADC èƒ½å¤ŸåŒºåˆ† 2^N ä¸ªä¸åŒçš„æ•°å­—é‡ã€‚

- ä¸€ä¸ª **8 ä½ ADC** å¯ä»¥åŒºåˆ† 28=256 ä¸ªä¸åŒçš„æ•°å­—é‡ï¼ˆé€šå¸¸æ˜¯ 0 åˆ° 255ï¼‰ã€‚

- ä¸€ä¸ª **10 ä½ ADC** å¯ä»¥åŒºåˆ† 210=1024 ä¸ªä¸åŒçš„æ•°å­—é‡ï¼ˆé€šå¸¸æ˜¯ 0 åˆ° 1023ï¼‰ã€‚

### æœ€å¤§æ•°å­—è¾“å‡ºå€¼

**Maximum Digital Output Value**ã€‚æ˜¯ ADC èƒ½å¤Ÿè¾“å‡ºçš„**æœ€å¤§æ•°å­—é‡**ã€‚å®ƒå–å†³äº ADC çš„ä½æ·±å’Œå®ƒçš„ç¼–ç æ–¹å¼ï¼ˆæœ‰ç¬¦å·æˆ–æ— ç¬¦å·ï¼‰ã€‚

- ä¸€ä¸ª 8 ä½çš„**æ— ç¬¦å·** ADCï¼Œå…¶æ•°å­—è¾“å‡ºèŒƒå›´é€šå¸¸æ˜¯ 0 åˆ° 255ï¼Œæ‰€ä»¥æœ€å¤§æ•°å­—è¾“å‡ºå€¼æ˜¯ 255ã€‚

è¿™ä¸ªå€¼æ˜¯ ADC æ•°å­—è¾“å‡ºçš„ä¸Šé™ï¼Œå¯¹åº”ç€ ADC çš„**æ»¡é‡ç¨‹ç”µå‹**ã€‚

###  æ»¡é‡ç¨‹ç”µå‹

**(Full-Scale Voltage / Full-Scale Range, FSR)**

- æ»¡é‡ç¨‹ç”µå‹æ˜¯æŒ‡ ADC èƒ½å¤Ÿå‡†ç¡®è½¬æ¢çš„**æœ€å¤§æ¨¡æ‹Ÿè¾“å…¥ç”µå‹èŒƒå›´**ã€‚å½“æ¨¡æ‹Ÿè¾“å…¥ä¿¡å·è¾¾åˆ°æˆ–è¶…è¿‡è¿™ä¸ªç”µå‹æ—¶ï¼ŒADC çš„æ•°å­—è¾“å‡ºå°†è¾¾åˆ°å…¶æœ€å¤§å€¼ï¼Œå¹¶ä¸”æ— æ³•å†åŒºåˆ†æ›´é«˜çš„ç”µå‹ï¼ˆå‡ºç°é¥±å’Œæˆ–å‰Šæ³¢ï¼‰ã€‚
- **ä¾‹å­ï¼š** å¦‚æœä¸€ä¸ª ADC çš„æ»¡é‡ç¨‹ç”µå‹æ˜¯ 3Vï¼Œé‚£ä¹ˆå½“è¾“å…¥æ¨¡æ‹Ÿä¿¡å·åœ¨ 0V åˆ° 3V ä¹‹é—´æ—¶ï¼ŒADC éƒ½èƒ½å°†å…¶è½¬æ¢ä¸ºå¯¹åº”çš„æ•°å­—é‡ã€‚å¦‚æœè¾“å…¥è¶…è¿‡ 3Vï¼Œä¾‹å¦‚ 3.5Vï¼ŒADC çš„æ•°å­—è¾“å‡ºä»ç„¶ä¼šæ˜¯æœ€å¤§å€¼ï¼Œå› ä¸ºå®ƒâ€œçœ‹ä¸è§â€3V ä»¥ä¸Šçš„ä¿¡å·äº†ã€‚
-  å®ƒæ˜¯ ADC çš„â€œæµ‹é‡ä¸Šé™â€ã€‚é€‰æ‹©åˆé€‚çš„æ»¡é‡ç¨‹ç”µå‹å¯¹äºä¿è¯æµ‹é‡ç²¾åº¦å’Œé¿å…ä¿¡å·å¤±çœŸéå¸¸é‡è¦ã€‚ä½ ä¹‹å‰æåˆ° VGA çš„ä½œç”¨å°±æ˜¯å°†ä¿¡å·è°ƒæ•´åˆ° 0 åˆ° 3V å·¦å³ï¼Œè¿™æ­£æ˜¯ä¸ºäº†è®©ä¿¡å·è½åœ¨ ADC çš„æ»¡é‡ç¨‹èŒƒå›´å†…ã€‚

### å½’ä¸€åŒ–å¸¸æ•° (Normalization Constant)

- **å®šä¹‰ï¼š** å½’ä¸€åŒ–å¸¸æ•°æ˜¯ä¸€ä¸ªç”¨äºå°†ä¸åŒèŒƒå›´æˆ–å•ä½çš„æ•°æ®ï¼Œè½¬æ¢åˆ°ä¸€ä¸ªç»Ÿä¸€ã€æ ‡å‡†çš„èŒƒå›´æˆ–å•ä½çš„ä¹˜æ•°æˆ–é™¤æ•°ã€‚åœ¨ ADC çš„è¯­å¢ƒä¸­ï¼Œå®ƒé€šå¸¸ç”¨äºå°† ADC çš„åŸå§‹æ•°å­—è¾“å‡ºï¼ˆä¸€ä¸ªæ•´æ•°å€¼ï¼‰ï¼Œè½¬æ¢ä¸ºå®é™…çš„ç”µå‹å€¼æˆ–è€…ä¸€ä¸ªæ¯”ä¾‹å€¼ï¼ˆä¾‹å¦‚ï¼Œ0 åˆ° 1 ä¹‹é—´ï¼‰ã€‚
- **ä¾‹å­ï¼š**
  - å‡è®¾ä¸€ä¸ª 10 ä½ ADC çš„æ»¡é‡ç¨‹ç”µå‹æ˜¯ 5Vï¼Œæœ€å¤§æ•°å­—è¾“å‡ºå€¼æ˜¯ 1023ã€‚é‚£ä¹ˆä¸€ä¸ªåŸå§‹æ•°å­—è¯»æ•° `D` å¯¹åº”çš„å®é™…ç”µå‹ `V` å¯ä»¥è®¡ç®—ä¸ºï¼š `V = D * (5V / 1023)`ã€‚è¿™é‡Œçš„ `(5V / 1023)` å°±æ˜¯ä¸€ä¸ªå½’ä¸€åŒ–å¸¸æ•°ï¼ˆæ¯æ•°å­—é‡å¯¹åº”çš„ç”µå‹å€¼ï¼‰ã€‚
  - åœ¨ä½ çš„ä»£ç ä¸­ `xs` å°±æ˜¯ä¸€ä¸ªå½’ä¸€åŒ–å¸¸æ•°ï¼Œå®ƒå°† ADC çš„æ•°å­—è¾“å‡ºè½¬æ¢ä¸ºå®é™…çš„ç”µå‹å¹…å€¼ã€‚å®ƒè€ƒè™‘äº† VGA çš„å¢ç›Šå’Œ ADC è‡ªèº«çš„ç‰¹æ€§ã€‚

## ADCå·¥ä½œåŸç†

ADC å°†**è¿ç»­çš„æ¨¡æ‹Ÿä¿¡å·**è½¬æ¢ä¸º**ç¦»æ•£çš„æ•°å­—ä¿¡å·**ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š**é‡‡æ · (Sampling)** å’Œ **é‡åŒ– (Quantization)**ã€‚

- **é‡‡æ ·ç‡ â‰ˆ æ¯ç§’æ‹å‡ å¼ ç…§ç‰‡**
   â‡’ è¶Šé«˜å°±è¶Šåƒé«˜é€Ÿæ‘„å½±æœºï¼Œèƒ½çœ‹æ¸…è¿åŠ¨è½¨è¿¹

- **åˆ†è¾¨ç‡ â‰ˆ æ¯å¼ ç…§ç‰‡çš„åƒç´ æ•°**
   â‡’ è¶Šé«˜å›¾åƒè¶Šæ¸…æ™°ã€ç»†èŠ‚è¶Šå¤š

| å±æ€§       | å†³å®šå†…å®¹                              | å½±å“è¯´æ˜                                     |
| ---------- | ------------------------------------- | -------------------------------------------- |
| **é‡‡æ ·ç‡** | **æ—¶é—´åˆ†è¾¨ç‡** / å¯é‡‡æ ·çš„**é¢‘ç‡å¸¦å®½** | æ§åˆ¶å¯ä»¥æ•æ‰å¤šå¿«çš„ä¿¡å·å˜åŒ–ï¼ˆä¾‹å¦‚æ³¢å½¢ã€è„‰å†²ï¼‰ |
| **åˆ†è¾¨ç‡** | **å¹…å€¼åˆ†è¾¨ç‡** / æ¯æ¬¡é‡‡æ ·çš„**ç²¾åº¦**   | æ§åˆ¶æ¯ä¸€ä¸ªé‡‡æ ·ç‚¹çš„ç”µå‹é‡åŒ–ç²¾åº¦ï¼ˆç»†è‡´ç¨‹åº¦ï¼‰   |

# 7.21

## gdbè¿œç¨‹è°ƒè¯•

- **ä½ çš„ç¨‹åºå**ï¼š`pcieCollecter`
- **ä½ çš„å¼€å‘æ¿ IP**ï¼š`10.1.2.175`
- **ä½ çš„ PC æœ‰æºç è·¯å¾„**ï¼š`~/work/pcieCollector/`
- **ä½ æ˜¯äº¤å‰ç¼–è¯‘ï¼ˆAArch64 æ¶æ„ï¼‰**ï¼šå³ PC æ˜¯ x86ï¼Œç›®æ ‡æ˜¯ ARM64

### å¼€å‘æ¿å¯åŠ¨ gdbserver

```bash
gdbserver :1234 /root/pcieCollecter
```

æ­¤æ—¶å¼€å‘æ¿ç›‘å¬ç«¯å£ 1234ï¼Œç­‰å¾… GDB è¿æ¥ã€‚

### PC ä¸Šå¯åŠ¨ `gdb-multiarch`

```bash
cd ~/work/pcieCollector/
gdb-multiarch ./pcieCollecter
```

è¿›å…¥ GDB åä¼šçœ‹åˆ° `(gdb)` æç¤ºç¬¦ã€‚

### è¿æ¥åˆ°è¿œç¨‹å¼€å‘æ¿

```bash
(gdb) set architecture aarch64
(gdb) target remote 10.1.2.175:1234
```

## Z2ç”µæœºè·ç¦»è°ƒè¯•é—®é¢˜

### ä¼ºæœå›ºå®šå‚æ•°

- PA59ï¼šç”µæœºç¼–ç å™¨åˆ†è¾¨ç‡ã€‚ä¸€èˆ¬æ˜¯17ï¼Œä¸º2çš„17æ¬¡æ–¹ï¼Œ131072ã€‚ç”µæœºæ—‹è½¬ä¸€åœˆï¼Œç¼–ç å™¨è„‰å†²ä¸º131072è„‰å†²æ•°
- PA12ï¼šä½ç½®æŒ‡ä»¤è„‰å†²ç”µå­é½¿è½®ç¬¬ä¸€åˆ†å­ã€‚å³ä¸ºç”µæœºç¼–ç å™¨åˆ†è¾¨ç‡æ¯”ä¾‹å…³ç³»ã€‚è®¾ç½®ä¸º8192
- PA13ï¼šä½ç½®æŒ‡ä»¤è„‰å†²ç”µå­é½¿è½®åˆ†æ¯ã€‚å³ä¸ºä¼ºæœæŒ‡ä»¤åˆ†è¾¨ç‡ã€‚è®¾ç½®ä¸º675

å…¶å¯¹åº”å…³ç³»ä¸ºï¼šä¼ºæœå‘é€10800ä¸ªæŒ‡ä»¤ï¼Œç”µæœºä¼šæ—‹è½¬1åœˆï¼Œç”µæœºç¼–ç å™¨è®°å½•å³ä¸º131072è„‰å†²æ•°ã€‚

### è·ç¦»å½±å“å‚æ•°

ç”µæœºéœ€è¦é€šè¿‡å·®é€Ÿå™¨å’Œä¸æ†è¿æ¥è´Ÿè½½ã€‚å½“å‰è®¾ç½®çš„å‚æ•°ï¼š

- å‡é€Ÿå™¨ = 80ï¼šç”µæœºæ—‹è½¬80åœˆï¼Œè´Ÿè½½é½¿è½®æ—‹è½¬1åœˆã€‚
- ä¸æ†èºè·ï¼šè´Ÿè½½é½¿è½®è½¬1åœˆï¼Œä¸æ†å‰è¿›12mm

ç”µæœºè½¬ä¸€åœˆï¼Œä¸æ†å‰è¿›å¤šå°‘è·ç¦»ï¼Ÿ

ç»™å®šï¼š

- å‡é€Ÿå™¨æ¯” = 80
- ä¸æ†èºè· = 12mm

è®¡ç®—ï¼š

- ç”µæœºè½¬ä¸€åœˆï¼Œè´Ÿè½½è½¬ï¼š
  $$
  1/80åœˆ
  $$
  
- ä¸æ†æ¨è¿›ï¼š
  $$
  12/80=0.15mm
  $$

æ‰€ä»¥ç†æƒ³çŠ¶æ€ä¸‹ï¼Œ**ç”µæœºè½¬1åœˆï¼Œä¸æ†å‰è¿›0.15mm**ã€‚

ä½†æ˜¯è¿™æ ·è®¾ç½®åï¼Œä½ç½®ç§»åŠ¨10mmï¼Œä¼šå‡ºç°å®é™…ç§»åŠ¨143mmã€‚ç°åœ¨éœ€è¦æ’æŸ¥é—®é¢˜åˆ°åº•å‡ºåœ¨å“ªé‡Œã€‚

## Z2è°ƒè¯•è®°å½•

**ä¸‹å‘æŒ‡ä»¤ç§»åŠ¨ 10mmï¼Œå®é™…ç§»åŠ¨ 143mm**ï¼Œæ”¾å¤§äº† **14.3 å€**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸æ†æ¯å‰è¿› 1mmï¼Œç³»ç»Ÿä»¥ä¸ºåªèµ°äº†çº¦ 0.07mm**ï¼Œæ¯”é¢„æœŸå¤šè½¬äº† 14.3 å€ã€‚

é¦–å…ˆæ£€æŸ¥Z2ç”µæœºçš„PA59ã€PA12å’ŒPA13è®¾ç½®æ˜¯å¦ä¸º17ã€8192å’Œ675ã€‚æ’é™¤ä¼ºæœå‚æ•°å½±å“ã€‚æ£€æŸ¥æ— è¯¯åï¼Œç»§ç»­ä¸‹é¢æ­¥éª¤ã€‚

### æ­¥éª¤1ï¼š**å®æµ‹ç”µæœºè½¬ä¸€åœˆï¼Œä¸æ†å‰è¿›å¤šå°‘mm**

- è®©ç”µæœºç²¾å‡†è½¬åŠ¨ 1åœˆ
  - æ‰‹åŠ¨å…³é—­å½“å‰Î¸æ—‹è½¬ç”µæœºç”µæºï¼Œé¿å…ä»åœ°å€å†²çªå‡ºç°é—®é¢˜ã€‚
  - PA71ï¼šè®¾ç½®Z2ç”µæœºMODBUSä»åœ°å€ä¸ºæ—‹è½¬ç”µæœºÎ¸çš„ç¼–å·ï¼Œ`5`
  - ä½¿ç”¨æ–°pspæ§åˆ¶å™¨ï¼Œè¿›å…¥è®¾ç½®ç•Œé¢ï¼Œè°ƒæ•´æ—‹è½¬è½´ç”µæœºçš„**é½¿è½®æ¯”**ä¸º1ã€‚
  - éªŒè¯æ˜¯å¦è®¾ç½®æ­£ç¡®ï¼špspè®¾ç½®æ—‹è½¬è½´ä½ç½®ä¸º0ï¼Œéšåä½ç½®ç§»åŠ¨`360`åº¦ï¼ˆ1åœˆï¼‰ã€‚æŸ¥çœ‹æ—¥å¿—å’Œdpç›‘è§†é¢æ¿ä¸‹ï¼ŒP-PoSä»£è¡¨çš„ç”µæœºç»å¯¹ä½ç½®è„‰å†²æ•°æ˜¯å¦ä¸º`131072`ï¼ˆÂ±100ï¼‰ã€‚

- ç”¨å¡å°ºæˆ–ç™¾åˆ†è¡¨æµ‹é‡ä¸æ†çš„ç›´çº¿ä½ç§»

 è®°å½•è¿™ä¸ªä½ç§»å€¼ï¼Œè®°ä¸º `X` mmã€‚

### æ­¥éª¤2ï¼šåæ¨å®é™…çš„æ€»ä¼ åŠ¨æ¯”

- å¦‚æœæµ‹å¾—ä¸æ†å‰è¿›äº† **2.15mm**ï¼Œè¯´æ˜ï¼š

$$
æ¯åœˆä½ç§» =2.15mmâ†’å®é™…æ€»ä¼ åŠ¨æ¯”=12/2.15â‰ˆ5.58
$$

è¿™æ˜æ˜¾æ¯”è®¾å®šçš„ 80 ä½å¾ˆå¤šï¼Œè¯´æ˜å®é™…çš„â€œå‡é€Ÿæ¯” Ã— èºè·â€ä¸è®¾å®šçš„ä¸åŒã€‚

### æ­¥éª¤3ï¼š**å•ç‹¬æµ‹ä¸æ†èºè·**

- æ–­å¼€ç”µæœºæˆ–ç”µæº
- æ‰‹åŠ¨æ—‹è½¬å·®é€Ÿå™¨è¾“å‡ºè½´ï¼ˆæˆ–ä¸æ†ç›´æ¥è¿æ¥çš„è½´ï¼‰ä¸€åœˆ
- ç”¨å¡å°ºæµ‹é‡ä¸æ†æ¨è¿›è·ç¦»

è®°å½•å®é™…çš„èºè·å€¼ï¼Œè®°ä¸º `P_real`

###  æ­¥éª¤4ï¼š**å®é™…å‡é€Ÿå™¨æ¯” = ç†è®ºç”µæœºåœˆæ•° Ã· è¾“å‡ºè½´åœˆæ•°**

- Î¸ç”µæœºæ—‹è½¬`360Ã—80 = 28800`åº¦ï¼Œè§‚å¯Ÿå·®é€Ÿå™¨æ—‹è½¬åœˆæ•°æ˜¯å¦ä¸º1

- ç”¨å…¬å¼ï¼š
  $$
  å®é™…å‡é€Ÿæ¯” =ç”µæœºè½¬æ•°/è¾“å‡ºè½´è½¬æ•°
  $$

## gdbè°ƒè¯•

ç°åœ¨ç”±äºå¯¹`pcieCollecter`é¡¹ç›®ä¸­ï¼Œå¢ç›Šè®¾ç½®å¹¶ä¸ç†è§£ï¼Œå¯¼è‡´æ— æ³•ä¸‹æ‰‹æ–°é€»è¾‘ã€‚ç°åœ¨éœ€è¦ç†è§£ä¸‹å…¶ä»£ç çš„å«ä¹‰ã€‚ç†è§£å§ï¼Œæ—©æ™šè¦é‡æ„ï¼

### ä»å¯åŠ¨å¼€å§‹

å¯åŠ¨ç¨‹åº`pcieCollecter`ï¼Œè¿›å…¥`main`å‡½æ•°ã€‚æ‰§è¡Œ

```css
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main()        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ comm_init()   â”‚â†’ åˆå§‹åŒ–ç³»ç»Ÿ + ADC è®­ç»ƒ + ä¿¡å·é‡ + PCIe
â”‚ create_workers() â”‚â†’ å¯åŠ¨é‡‡é›†/å‘é€çº¿ç¨‹
â”‚ LED æ§åˆ¶      â”‚â†’ æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
â”‚ dealCmdLoop() â”‚â†’ ç­‰å¾…å¹¶å¤„ç†UDPå‘½ä»¤
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ dealCmdLoop()                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ recvfrom() é˜»å¡æ¥æ”¶å‘½ä»¤             â”‚â—„â”€â”˜
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚ parse_and_handle_message() è§£æå¤„ç† â”‚
â”‚  â”‚ send_message() å“åº”å®¢æˆ·ç«¯           â”‚
â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## linuxç¯å¢ƒé…ç½®

ç°åœ¨æƒ³å®ç°å®Œå…¨çš„vim+bashçš„å¼€å‘ç¯å¢ƒï¼Œè·³è„±VSCODEçš„ååŠ©ã€‚ç°åœ¨éœ€è¦æŒ‰ç…§vscodeæ—¥å¸¸ç”¨åˆ°è¾ƒå¤šçš„åŠŸèƒ½ï¼Œé…ç½®åˆ°vim+bashçš„ç¯å¢ƒä¸Šã€‚

vimä¸Šæƒ³è¦å®ç°vscodeçš„ï¼š

1. æ™ºèƒ½è‡ªåŠ¨è¡¥å…¨ï¼šè¾“å…¥æ—¶è‡ªåŠ¨æç¤ºå˜é‡ã€å‡½æ•°ã€ç±»å‹ã€æ–‡æ¡£ã€‚

   - æ”¯æŒè¯­è¨€æœåŠ¡ï¼ˆå¦‚ Pythonã€C/C++ã€Goã€Rustã€JavaScriptï¼‰ã€‚

   - é€šè¿‡ Ctrl + Space æ‰‹åŠ¨è§¦å‘æç¤ºã€‚

2. è¯­æ³•æ£€æŸ¥ä¸é”™è¯¯æç¤º

   - è¯­æ³•æ£€æŸ¥ä¸é”™è¯¯æç¤º
   - æ”¯æŒ ESLintã€Pylintã€clangd ç­‰æ£€æŸ¥å™¨ã€‚

3. è·³è½¬å®šä¹‰ / æŸ¥æ‰¾å¼•ç”¨

   - `F12`ï¼šè·³è½¬åˆ°å®šä¹‰
   - `Shift + F12`ï¼šæŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨
   - `Alt + F12`ï¼šå†…è”æŸ¥çœ‹å®šä¹‰

4. ä»£ç é‡æ„ä¸é‡å‘½å

   - `F2`ï¼šé‡å‘½åå˜é‡ / å‡½æ•° / ç±»ï¼Œè‡ªåŠ¨æ›´æ–°æ‰€æœ‰å¼•ç”¨ã€‚

5. æ ¼å¼åŒ–ä»£ç 

   - `Shift + Alt + F`ï¼šæ ¼å¼åŒ–æ•´ä¸ªæ–‡æ¡£ã€‚
   - è‡ªåŠ¨ä¿å­˜æ—¶æ ¼å¼åŒ–

6. ä»£ç ç‰‡æ®µ

   - è¾“å…¥ `for` è‡ªåŠ¨è¡¥å…¨å¾ªç¯

7. å°æŠ€å·§

   - `Ctrl + P`ï¼šå¿«é€Ÿæ‰“å¼€æ–‡ä»¶ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰

     `Ctrl + Shift + O`ï¼šåˆ—å‡ºå½“å‰æ–‡ä»¶çš„å‡½æ•° / ç±»ï¼ˆç¬¦å·å¯¼èˆªï¼‰

     `Ctrl + Shift + M`ï¼šæŸ¥çœ‹æ‰€æœ‰é—®é¢˜ï¼ˆè­¦å‘Š + é”™è¯¯ï¼‰

     `Ctrl + Shift + [` / `]`ï¼šæŠ˜å /å±•å¼€ä»£ç å—

     `Alt + â†‘ / â†“`ï¼šæ•´è¡Œä¸Šä¸‹ç§»åŠ¨

     `Shift + Alt + â†“`ï¼šæ•´è¡Œå¤åˆ¶

# 7.22

ä»Šå¤©å°±æ˜¯æŠ˜è…¾äº†linuxç¯å¢ƒã€‚

## é…ç½®Linux

é¦–å…ˆå°±æ˜¯å°†ç¼–è¾‘å™¨æ¢ä¸ºäº†Neovimã€‚å¹¶ä¸”æ ¹æ®[å¸–å­](https://martinlwx.github.io/zh-cn/config-neovim-from-scratch/#%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AE-nvim)æŒ‡å¼•ï¼Œé…ç½®äº†ä¸€äº›åŸºç¡€çš„ä¸œè¥¿ã€‚ä½†æ˜¯ç°åœ¨é—®é¢˜æ˜¯ï¼Œæˆ‘ä¸ä¼šä½¿ç”¨Nvimï¼Œæ‰€ä»¥ç°åœ¨éœ€è¦å­¦ä¹ Nvimçš„æ“ä½œä»¥åŠluaè„šæœ¬ã€‚

Neovim çš„ç°ä»£é…ç½®ï¼Œå°±æ˜¯ Lua é©±åŠ¨çš„ã€‚æ‰€ä»¥è¦æƒ³å­¦ä¹ Neovimçš„é…ç½®ï¼Œå°±å…ˆéœ€è¦äº†è§£Luaè¯­è¨€ã€‚

### Luaå­¦ä¹ 

å¤§ä½“æµè§ˆä¸€ä¸‹[Learn X in Y minutes](https://learnxinyminutes.com/)çš„å¿ƒå¾—ã€‚åŸºæœ¬å°±æ˜¯pythonè¯­æ³•ï¼Œæ¯”è¾ƒç®€å•ã€‚

### é…ç½®

- å¿«æ·åˆ‡å‰²çª—å£splitå’Œåˆ‡æ¢paneæ–¹æ³•ã€‚

å¥½äº†ï¼ŒæŠ˜è…¾äº†ä¸€æ®µæ—¶é—´åï¼Œæˆ‘æ”¾å¼ƒäº†ã€‚è¿˜æ˜¯åŸºæœ¬çš„vscode+mobaxtermå§ã€‚ä½†æ˜¯æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œæ¯æ¬¡éƒ½é€šè¿‡vscodeçš„sshæ‰“å¼€é¡¹ç›®è¿›è¡Œç¼–è¯‘

# 7.23

## é‡æ„`on_quickCfg_clicked()`

ç”±äºè¦ç†è§£è®¾ç½®ç›¸å¯¹ä½ç½®ç§»åŠ¨çš„é€»è¾‘ï¼Œæ‰€ä»¥éœ€è¦é˜…è¯»æ­¤å‡½æ•°ä»£ç ã€‚ä½†æ˜¯æ­¤ä»£ç é˜…è¯»èµ·æ¥éå¸¸éš¾å—ï¼Œéœ€è¦é‡æ„ä¸€ä¸‹ã€‚

æ ¹æ®æ¸è¿›å¼é‡æ„ï¼ˆRefactoring in stepsï¼‰çš„æœ€ä½³å®è·µï¼š

1. **ç†è§£**ï¼šç¡®ä¿ä¸ç ´åç°æœ‰åŠŸèƒ½ã€‚
2. **åˆ†è§£**ï¼šå°†å¤§é—®é¢˜æ‹†è§£æˆå°é—®é¢˜ã€‚
3. **ä¼˜åŒ–**ï¼šé€ä¸ªè§£å†³æ¯ä¸ªå°é—®é¢˜ï¼Œæå‡ä»£ç è´¨é‡ã€‚

æˆ‘å‡†å¤‡å…ˆæ³¨é‡Šï¼Œå†ç®€åŒ–å‡½æ•°é•¿åº¦ï¼Œç„¶åè€ƒè™‘æ–°æ¨¡å—å®ç°ã€‚

å¥½å§ï¼Œæˆ‘æ‰¿è®¤è‡ªå·±å¤ªç‹‚äº†ï¼Œè¿™ä¸ªé‡æ„åŸºæœ¬ä¸å¯èƒ½ã€‚

## ç›¸å¯¹ä½ç½®ç§»åŠ¨é€»è¾‘

ç°åœ¨æƒ³åŠ å…¥å¤§å±ç»å¯¹ä½ç½®ç§»åŠ¨çš„é€»è¾‘ï¼Œä½†æ˜¯é‡Œé¢æ¶‰åŠçš„ç•Œé¢è®¾ç½®ã€ä½ç½®ç§»åŠ¨çš„å±•ç¤ºæ“ä½œæ¯”è¾ƒå¤šï¼Œå®¹æ˜“å‡ºé”™ã€‚å…ˆç†è§£ä¸‹å½“å‰çš„ç›¸å¯¹ä½ç½®ç§»åŠ¨çš„é€»è¾‘ã€‚

### ç•Œé¢è®¾ç½®

åœ¨å‡½æ•°`UI_setupRunConfigPanel()`ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†ä½ç½®ç§»åŠ¨å¤é€‰æ¡†

```c++
m_runMode_chb = new QCheckBox("ç‚¹åŠ¨æ§åˆ¶", this);
m_runMode_chb->setObjectName("runMode_chb");
```

éšåå°†å…¶æ”¾åœ¨äº†ä¸€ä¸ªå¸ƒå±€ä¸­ï¼Œä¸é€Ÿåº¦ä¿¡æ¯æŒ‰é’®å’Œä½ç½®ä¿¡æ¯æŒ‰é’®ç›¸å…³è”ï¼š

```C++
runCfgLy = new QVBoxLayout;
runCfgLy->setMargin(marg);
runCfgLy->addWidget(m_runMode_chb);
runCfgLy->addSpacing(marg);
runCfgLy->addWidget(m_speed_bt);
runCfgLy->addSpacing(marg);
runCfgLy->addWidget(m_distance_bt);

m_rightLayout->addLayout(runCfgLy,                    6, 0, 3, 2);
m_rightLayout->addItem((new QSpacerItem(1,1,QSizePolicy::Fixed,QSizePolicy::Expanding)),               9, 0);
```

å¹¶ä¸”è®¾ç½®åœ¨å¤§å±æ¨¡å¼ï¼ˆ`DbCtrl::m_systemInfo_tb.mode = 0`ï¼‰ä¸‹ï¼Œä¸å…è®¸ç‚¹åŠ¨ï¼Œä»è€Œå–æ¶ˆ`ç‚¹åŠ¨æ§åˆ¶`å¤é€‰æ¡†ã€‚

```C++
if(DbCtrl::m_systemInfo_tb.mode){     // PAD æ¨¡å¼
    m_runMode_chb->setChecked(true);
    m_distance_bt->setVisible(false);
}else{
    m_runMode_chb->setChecked(false);
    m_runMode_chb->setVisible(false);   // å¤§å±æ¨¡å¼ä¸‹ä¸å…è®¸ä½¿ç”¨ç‚¹åŠ¨æ§åˆ¶
    m_distance_bt->setVisible(true);
}
```

è¿™å°±æ˜¯å¤§å±æ¨¡å¼ä¸‹ï¼Œä½ç½®ç§»åŠ¨çš„ç•Œé¢è®¾è®¡ï¼šå–æ¶ˆ`ç‚¹åŠ¨æ§åˆ¶`ï¼Œåªå…è®¸ä½ç½®ç§»åŠ¨ã€‚

### ä½ç½®ç§»åŠ¨é€»è¾‘

é¦–å…ˆéœ€è¦è®¾ç½®ç›¸å¯¹ä½ç½®ç§»åŠ¨çš„è·ç¦»ã€‚æ­¤è®¾ç½®åœ¨å‡½æ•°`on_quickCfg_clicked()`ä¸­å®ç°ã€‚

```C++
connect(m_distance_bt, &QPushButton::clicked, this, &MotorCtrl::on_quickCfg_clicked);
```



## å¤§å±åŠ å…¥ç»å¯¹ä½ç½®ç§»åŠ¨

ç°åœ¨å¤§å±ç”µæœºç§»åŠ¨çš„æ—¶å€™ï¼Œåªèƒ½é€šè¿‡ç›¸å¯¹ç§»åŠ¨çš„æ–¹å¼ã€‚ç°åœ¨ç”±äºåŠ å…¥äº†é™ä½å¯ä»¥å®‰å…¨åœ°ç§»åŠ¨ï¼Œæ‰€ä»¥æƒ³åŠ å…¥ä¸€ä¸ªç»å¯¹ç§»åŠ¨çš„é€»è¾‘ã€‚

### ç•Œé¢è®¾è®¡

å¤§å±æ¨¡å¼ä¸‹ï¼Œæä¾›ä¸€ä¸ªç»å¯¹ä½ç½®å¯é€‰æ¡†ï¼Œé»˜è®¤ä¸å‹¾é€‰ã€‚

### é€»è¾‘

- é€‰ä¸­ï¼Œ`ç‚¹åŠ¨è·ç¦»`æ”¹ä¸º`ç»å¯¹ä½ç½®`ï¼Œæ­¤æ—¶`ç»å¯¹ä½ç½®`è¾“å…¥100ï¼Œåˆ™ç”µæœºè¿åŠ¨åˆ°ç»å¯¹ä½ç½®100çš„ä½ç½®ï¼ˆä»¥åŸç‚¹ä¸ºåŸºç¡€ç‚¹ï¼‰
- ä¸å‹¾é€‰ï¼Œåˆ™æ­£å¸¸è¿åŠ¨å³å¯ã€‚

### å®ç°æ€è·¯

1. åˆå§‹åŒ–ç•Œé¢ï¼š`UI_setupRunConfigPanel()`ä¼šå¸ƒç½®ç‚¹åŠ¨æ§åˆ¶å’Œä½ç½®ç§»åŠ¨çš„ç•Œé¢ã€‚

   æ­¤æ—¶å¦‚æœæ˜¯å¤§å±æ¨¡å¼ï¼Œå°±ä¼šå°†`ç‚¹åŠ¨æ§åˆ¶é€‰æ‹©æ¡†`ï¼ˆ`m_runMode_chb`ï¼‰éšè—èµ·æ¥ã€‚

   å¯ä»¥å¤§å±æ¨¡å¼çš„æ—¶å€™ï¼Œå°†`ç»å¯¹ä½ç½®ç§»åŠ¨`å¤é€‰æ¡†æ›¿æ¢åˆ°`ç‚¹åŠ¨æ§åˆ¶`çš„ä½ç½®ã€‚

2. å±•ç¤ºé€»è¾‘ï¼šåœ¨å‡½æ•°`on_quickCfg_clicked()`ä¸­ï¼Œä¿®æ”¹å…³äºç»å¯¹ä½ç½®çš„å±•ç¤ºã€‚

   - é…ç½®å¼¹çª—å†…å®¹ä¸ºç»å¯¹ä½ç½®
   - é…ç½®å¼¹çª—æ•°æ®ä¸ºç”µæœºå½“å‰ä½ç½®
   - è®¾ç½®å®Œæ¯•ç»å¯¹ä½ç½®å

3. ç§»åŠ¨é€»è¾‘

   å› ä¸ºå¤§å±åªèƒ½ä½ç½®ç§»åŠ¨ï¼Œæ‰€ä»¥åœ¨`actionDir()`ä¸­ç›´æ¥ä¿®æ”¹å³å¯ã€‚

## è®¾è®¡servoV6

ç°åœ¨éœ€è¦é‡æ–°è®¾è®¡ç”µæœºæ§åˆ¶è½¯ä»¶V6ç‰ˆã€‚æ­¤ç‰ˆæœ¬æ–°ç‰¹æ€§æœ‰ï¼š

- ä½¿ç”¨Qt6+qtquickå¼€å‘ï¼Œå‰åç«¯é€»è¾‘åˆ†ç¦»
- åˆ†å±‚æ¶æ„ï¼ŒåŸºäºTDDå¼€å‘æ¨¡å¼ï¼Œä¿è¯æµ‹è¯•å…ˆäºå¼€å‘

ç°åœ¨å…ˆåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹`servoV6`ï¼Œåé¢çš„é©±åŠ¨å¼€å‘è®°å½•ï¼Œå‡åœ¨æ­¤ç›®å½•ä¸‹è¿›è¡Œã€‚

# 7.25

ä»Šå¤©å°±æ˜¯åšä¸€ç‰ˆQtç¨‹åºï¼Œç”¨MODBUSåè®®æ¥è¯»å–ä¸€äº›å¯„å­˜å™¨ã€‚çœ‹çœ‹æ˜¯å¦ç¬¦åˆæ¥å£è§„èŒƒã€‚

## MODBUS

# 7.29

ä»Šå¤©ä»»åŠ¡å°±æ˜¯ï¼Œé©±åŠ¨å‹å·P100Sçš„ç”µæœºï¼Œä»¥æ—‹è½¬åŠŸèƒ½å®Œæˆç‚¹åŠ¨ã€ä½ç½®ç§»åŠ¨å’Œè¯»å–ä½ç½®ä¿¡æ¯çš„åŠŸèƒ½ã€‚

æ”¯çº¿ä»»åŠ¡å°±æ˜¯ï¼š

- ä¸è€æ°´æ± å¼€å‘æ²Ÿé€šï¼Œç†è§£ç¥ç§˜å‚æ•°
- è¿œç¨‹å­¦ä¹ cmake

## æ—‹è½¬åŠŸèƒ½åˆ†è§£

ç°åœ¨è¦åŸºäºæ­¤æ¶æ„ï¼Œå¼€å‘ä¸€ä¸ªå®Œæ•´çš„ç”µæœºæ—‹è½¬åŠŸèƒ½ï¼š

```bash
servoV6/
â”œâ”€â”€ adapters/            # âœ… é€‚é…å™¨å±‚ï¼Œç»„åˆåŠŸèƒ½+å‹å·+åè®®
â”œâ”€â”€ app/                 # ğŸš€ ç¨‹åºå…¥å£ + Qtå‰ç«¯
â”œâ”€â”€ application/         # ğŸ§  æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆè°ƒåº¦/æ‰§è¡Œï¼‰
â”œâ”€â”€ build/               # âš™ï¸ æ„å»ºè¾“å‡ºç›®å½•ï¼ˆç”± Qt Creator ç”Ÿæˆï¼‰
â”œâ”€â”€ domain/              # ğŸ“ é¢†åŸŸæ¨¡å‹å®šä¹‰ï¼ˆæ¥å£ã€æŠ½è±¡å‘½ä»¤ï¼‰
â”œâ”€â”€ external/            # ğŸ“¦ å¤–éƒ¨ä¾èµ–ï¼ˆspdlog ç­‰ï¼‰
â”œâ”€â”€ tests/               # âœ… å•å…ƒæµ‹è¯•
â”œâ”€â”€ utils/               # ğŸ”§ å·¥å…·ç±»ï¼ˆæ—¥å¿—ç­‰ï¼‰
â”œâ”€â”€ CMakeLists.txt*      # æ„å»ºé…ç½®
â”œâ”€â”€ README.md            # é¡¹ç›®è¯´æ˜
```

å…¶ä¸­

```bash
adapters/
â”œâ”€â”€ ServoAdapterFactory.*  # å·¥å‚ç±»ï¼šæ ¹æ®åŠŸèƒ½+å‹å·+åè®®åˆ›å»º ServoAdapter
â”œâ”€â”€ motors/                # ç”µæœºå‹å·ï¼ˆIMotorï¼‰ç›¸å…³å®ç°
â”œâ”€â”€ protocol/              # é€šä¿¡åè®®å®ç°ï¼ˆModbus/Bluetooth...ï¼‰
â””â”€â”€ servos/                # ServoAdapter çš„åŠŸèƒ½å®ç°ï¼ˆæ—‹è½¬/çº¿æ€§ç­‰ï¼‰
```

ç°åœ¨çš„éœ€æ±‚æ˜¯ï¼š

- å®ç°ä¸€ä¸ªå‹å·P100Sçš„ç”µæœºï¼Œä½¿å…¶åŠŸèƒ½ä¸ºæ—‹è½¬ç”µæœºï¼Œæœ€ç»ˆèƒ½å¤Ÿå®ç°æ—‹è½¬ç”µæœºçš„æ‰€æœ‰åŠŸèƒ½ã€‚å¹¶ä¸”ä½¿ç”¨ä¸²å£åè®®ã€‚

è¯·ä½ æ ¹æ®å½“å‰çš„ç»“æ„ï¼Œç»™å‡ºä¸€ä¸ªTDDçš„æµ‹è¯•å¼€å‘æµç¨‹ï¼Œèƒ½è®©æˆ‘ä¸€æ­¥æ­¥è¿›è¡Œä¸‹å»

googleçš„geminiç»™å‡ºçš„å»ºè®®æ˜¯ï¼Œä»åº•å±‚å¼€å§‹ï¼Œé€æ­¥å‘ä¸Šæ„å»ºã€‚

å¥½çš„ï¼Œç°åœ¨æ—‹è½¬åŠŸèƒ½å¡åœ¨äº†åè®®ä¸Šã€‚å› ä¸ºè¦å®ç°serialåè®®ï¼Œä½†æ˜¯å‘ç°Qtå¹¶æ²¡æœ‰ä¸‹è½½è¿™ä¸ªé¢å¤–çš„åº“ã€‚tmdï¼Œè¿™é€¼æˆ‘è‡ªå·±é‡æ–°å¸è½½äº†é‡æ–°å®‰è£…äº†ä¸€éã€‚

ç°åœ¨è¶ç€ç©ºæŒ¡ï¼Œå­¦ä¹ ä¸‹[googletest](https://google.github.io/googletest/quickstart-cmake.html)ã€‚å¥½å§ï¼Œç°åœ¨å·²ç»å®‰è£…å®Œäº†ï¼Œä¸–äº‹éš¾æ–™ï¼å¼€æï¼

ç®—äº†ï¼Œå·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼Œæˆ‘ç°åœ¨æœ€å¤§çš„é—®é¢˜ï¼Œå°±æ˜¯å‘ç°è‡ªå·±çš„GoogleTestæµ‹è¯•æ¡†æ¶å¡ä½äº†è‡ªå·±çš„å‰è¿›ã€‚æ‰€ä»¥æˆ‘è¦è®¤çœŸç†è§£ä¸‹ï¼Œè¿™ä¸ªæµ‹è¯•æ¡†æ¶çš„ç”¨é€”ã€‚

å¥½äº†ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„æ–—äº‰ï¼Œæˆ‘ç»ˆäºå¦¥åäº†ï¼Œåˆ é™¤äº†googleTestæ¡†æ¶ï¼Œæ”¹ä¸ºäº†Qtestã€‚

åŸºäºæ­¤æ¶æ„ï¼Œé‡æ–°è®¾è®¡ç‰ˆæœ¬ã€‚å¥½ç´¯ã€‚

# 7.30

ä»Šå¤©æœ€èµ·ç è¦èŠ±ä¸€ä¸ªå°æ—¶ï¼Œå­¦ä¹ cmakeï¼ï¼

## è®¾ç½®åŸç‚¹å’Œè·å–ä½ç½®

ç°åœ¨é‡æ–°æ„å»ºæ—‹è½¬ç‚¹åŠ¨åŠŸèƒ½çš„æµç¨‹ï¼š

- è®¾ç½®å½“å‰ä½ç½®ä¸ºåŸç‚¹
- è·å–å½“å‰ä½ç½®ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º0
- è®¾ç½®ç‚¹åŠ¨é€Ÿåº¦ä¸º100Â°/s
- ä»¥ä¸Šè¿°ç‚¹åŠ¨é€Ÿåº¦ï¼Œç‚¹åŠ¨æ­£è½¬3s
- è´Ÿå‘ç‚¹åŠ¨è½¬åŠ¨2s
- è·å–å½“å‰ä½ç½®

åŸºäºç‚¹åŠ¨çš„æµç¨‹ï¼Œéœ€è¦å®ç°çš„åŠŸèƒ½åœ¨ä¸‹é¢è®¨è®ºä¸‹ã€‚

### ç”µæœºåŠŸèƒ½

è¦æƒ³å®ç°ç”µæœºçš„æ—‹è½¬ï¼Œéœ€è¦ç”µæœºæ”¯æŒä¸‹é¢çš„æ“ä½œï¼š

- è®¾ç½®åŸç‚¹ï¼šæ¸…ç©ºä½ç½®å¯„å­˜å™¨çš„å€¼ï¼Œå°†å½“å‰çš„ä½ç½®è®¾ç½®ä¸º0
- è·å–å½“å‰ä½ç½®ï¼šè·å–å½“å‰çš„ç”µæœºæ—‹è½¬çš„åœˆæ•°

åœ¨`IMotor`ä¸­ï¼ŒåŠ å…¥è¿™ä¸¤æ¡å¹¶åœ¨`P100S`çš„ç”µæœºä¸­ä¹Ÿå£°æ˜è¿™ä¸¤ä¸ªåŠŸèƒ½ï¼š

```CPP
// æ–°å¢æ¥å£å£°æ˜ï¼šå°†å½“å‰ä½ç½®é‡ç½®ä¸º 0
bool setCurrentPositionAsZero() override;
// æ–°å¢æ¥å£å£°æ˜ï¼šè·å–å½“å‰ä½ç½®ï¼ˆåœˆæ•°ï¼‰
double getCurrentRevolutions() const override;
```

ä¸‹é¢æ˜¯å®ç°è¿™ä¸¤ä¸ªåŠŸèƒ½çš„æ€è·¯ã€‚

å½“å‰P100Sç”µæœºè·å–ä½ä½ç½®`getCurrentRevolutions()`çš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡è¯»åœ°å€`0x1018`ä»£è¡¨çš„ç»å¯¹ä½ç½®å¯„å­˜å™¨çš„64ä½ã€‚

ç›´æ¥ä½¿ç”¨`readUInt64()`å³å¯å®ç°è¯»å–ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„ç‚¹ï¼š

- `readUInt64()`è¯»å–çš„æ˜¯æ— ç¬¦å·æ•´å‹ï¼Œä½†æ˜¯å®é™…çš„ç»å¯¹ä½ç½®ä¸ºæœ‰ç¬¦å·æ•°ï¼Œéœ€è¦åšè½¬æ¢
- è¯»å–çš„æ˜¯å½“å‰ç”µæœºè®°å½•çš„ç»å¯¹ä½ç½®çš„è„‰å†²æ•°ï¼Œè¦æƒ³è·å–ç”µæœºå®é™…æ—‹è½¬çš„åœˆæ•°ï¼Œéœ€è¦é™¤ä»¥ç”µæœºç¼–ç å™¨åˆ†è¾¨ç‡

å½“å‰ç”µæœºç¼–ç å™¨åˆ†è¾¨ç‡ä¿å­˜åœ¨å¯„å­˜å™¨`PA95`ï¼ˆåœ°å€å°±æ˜¯95ï¼‰ä¸­ã€‚å…¶ä¿å­˜çš„æ˜¯åˆ†è¾¨ç‡çš„æŒ‡æ•°ï¼ˆä¾‹å¦‚17ï¼Œæœ€ç»ˆåˆ†è¾¨ç‡åº”è¯¥ä¸º2^17 = 131072ï¼‰ã€‚

å¦å¤–å°†å½“å‰ä½ç½®é‡ç½®ä¸º 0å°±æ›´å¥½å¤„ç†äº†ï¼ŒP100Sæä¾›äº†è®¾ç½®é›¶ç‚¹çš„æ–¹æ³•ï¼ˆä¾‹å­ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼‰ï¼š

> P4_2 = 0x202,   // ç¬¬ä¸€æ®µå†…éƒ¨ä½ç½®åœˆæ•°è®¾ç½®ä¸º0
>
> P4_3 = 0x203,   // ç¬¬ä¸€æ®µå†…éƒ¨ä½ç½®åœˆå†…è„‰å†²æ•°è®¾ç½®ä¸º0
>
> P3_34 = 0x122,  //1 å¤ä½å½’é›¶ç¼–ç å™¨å¤šåœˆæ•°æ®ï¼ˆè®¾ç½®ä¸º1ï¼‰
> m_motorRegs->writeReg16(motorID, MotorRegs::P4_2, 0);
> m_motorRegs->writeReg16(motorID, MotorRegs::P4_3, 0);
> m_motorRegs->writeReg16(motorID, MotorRegs::P3_34, 1);

æ‰€ä»¥ç°åœ¨è¦åšçš„å°±æ˜¯è¿›è¡Œè¿™ä¸¤ä¸ªåŠŸèƒ½çš„é€‚é…ã€‚è¯·ä½ ä¾æ®TDDçš„å¼€å‘æµç¨‹ï¼Œæµ‹è¯•å…ˆäºå¼€å‘ï¼ŒæŒ‰æ­¥éª¤è¿›è¡Œå¼€å‘ã€‚

### TDDæ€è·¯

ç›´æ¥ç”¨ä¸€ä¸ªæµ‹è¯•å‡½æ•°è¿›è¡Œé›†åˆå°±å¯ä»¥ã€‚

- ä»¥ä¸²å£é€šè®¯çš„æ–¹å¼ï¼Œåˆ›å»ºP100S
- è·å–å½“å‰ä½ç½®åœˆæ•°
- æ¸…é›¶
- è·å–ä½ç½®åœˆæ•°ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨Â±0.01åœˆå†…ã€‚

## è¯»å–æ•°æ®çš„æ€è€ƒ

### ç°çŠ¶æ€»ç»“

- `ICommProtocol` æ˜¯çº¯ç²¹çš„é€šä¿¡æŠ½è±¡æ¥å£ï¼Œå®šä¹‰äº†æœ€åº•å±‚çš„æ‰“å¼€ã€å…³é—­ã€è¯»å†™æ–¹æ³•ï¼Œæ”¯æŒå„ç§é€šä¿¡æ–¹å¼ï¼ˆä¸²å£ã€è“ç‰™ç­‰ï¼‰å®ç°ã€‚
- `SerialCommProtocol` å®ç°äº† `ICommProtocol`ï¼Œå®Œæˆäº†åŸºäº Qt Modbus çš„ä¸²å£é€šä¿¡ã€‚
- ä½ åœ¨ `SerialCommProtocol` ä¸­é¢å¤–æä¾›äº†å‡ ä¸ªä¾¿åˆ©å‡½æ•°ï¼š`readUInt16/32/64`ï¼Œæ–¹ä¾¿è¯»å†™ä¸åŒå®½åº¦çš„æ•°æ®ã€‚
- è¿™äº›ä¾¿åˆ©å‡½æ•°ç´§è´´ä¸²å£é€šä¿¡å®ç°ï¼Œä½†å®é™…å®ƒä»¬æœ¬è´¨ä¸Šæ˜¯å¯¹å¯„å­˜å™¨æ•°æ®è¯»å–çš„å°è£…ã€‚

### è®¾è®¡é—®é¢˜

> è¿™å‡ ä¸ªè¯»å†™16/32/64ä½æ•°æ®çš„å‡½æ•°ï¼Œæ˜¯å¦åº”è¯¥æ”¾åˆ°é€šä¿¡åè®®å±‚ï¼ˆä¸²å£ã€è“ç‰™ï¼‰ä¹‹å¤–ï¼Œæˆä¸º**ç”µæœºå‹å·å±‚**æˆ–**ä¸šåŠ¡å±‚**çš„æ¥å£ï¼Ÿ

| è®¾è®¡é€‰æ‹©                               | ä¼˜ç‚¹                                       | ç¼ºç‚¹                                           |
| -------------------------------------- | ------------------------------------------ | ---------------------------------------------- |
| æ”¾åœ¨é€šä¿¡åè®®å±‚ï¼ˆå¦‚SerialCommProtocolï¼‰ | ç›´æ¥æ“ä½œé€šä¿¡ç»†èŠ‚ï¼Œç»Ÿä¸€ç®¡ç†ï¼Œè°ƒç”¨æ–¹ä¾¿       | ä¸åŒè®¾å¤‡ä¸šåŠ¡ä¾§éœ€è¦é‡å¤åŒ…è£…ï¼Œåè®®å±‚èŒè´£è¿‡é‡     |
| æ”¾åœ¨ä¸šåŠ¡å±‚ï¼ˆç”µæœºæ¨¡å‹å±‚ï¼‰               | æŒ‰å‹å·éœ€æ±‚å®šåˆ¶ï¼Œè§£è€¦é€šä¿¡å®ç°ï¼Œä¸šåŠ¡é€»è¾‘æ¸…æ™° | å¯èƒ½å¯¼è‡´å„å‹å·ç”µæœºé‡å¤å†™ç±»ä¼¼ä»£ç ï¼Œç»´æŠ¤æˆæœ¬ä¸Šå‡ |
| æŠ½è±¡æˆç‹¬ç«‹çš„è¾…åŠ©ç±»ï¼ˆå·¥å…·ç±»ï¼‰           | ä¸šåŠ¡å’Œé€šä¿¡æ¸…æ™°åˆ†ç¦»ï¼Œå¯å¤ç”¨ï¼Œå¤šåè®®å¤ç”¨     | éœ€è¦é¢å¤–è®¾è®¡æ¥å£å’Œä¾èµ–å…³ç³»ï¼Œç¨å¤æ‚             |

### æ¨èæ–¹æ¡ˆ

1. åœ¨ `ICommProtocol` é‡Œåªä¿ç•™æœ€åº•å±‚çš„è¯»å†™ï¼ˆ16ä½å¯„å­˜å™¨å—è¯»å†™ï¼‰

   - `read(int mID, int regType, int startReg, int stopReg, RegisterBlock&)`

   - `write(int mID, int regType, int reg, const RegisterBlock&)`

2. åˆ›å»ºä¸€ä¸ªâ€œæ•°æ®å°è£…å±‚â€æ¥å£ï¼Œä¾‹å¦‚ `IRegisterAccessor` 

   - è´Ÿè´£**æ ¹æ®å¯„å­˜å™¨åœ°å€å’Œç±»å‹ï¼Œå®Œæˆç‰¹å®šå®½åº¦æ•°æ®çš„è¯»å–å’Œå†™å…¥**

   - ä¸šåŠ¡å±‚ï¼ˆå¦‚ `P100SMotor`ï¼‰è°ƒç”¨æ­¤æ¥å£ï¼Œä¸ç›´æ¥ä¸ `ICommProtocol` æ‰“äº¤é“

     ```cpp
     class IRegisterAccessor {
     public:
         virtual ~IRegisterAccessor() = default;
     
         virtual bool readUInt16(int mID, int regType, int startReg, quint16& outVal) = 0;
         virtual bool readUInt32(int mID, int regType, int startReg, quint32& outVal) = 0;
         virtual bool readUInt64(int mID, int regType, int startReg, quint64& outVal) = 0;
     
         virtual bool writeUInt16(int mID, int regType, int reg, quint16 inVal) = 0;
         // ä¹Ÿå¯ä»¥æ·»åŠ 32/64å†™å…¥æ¥å£
     };
     ```

3. è®©æ‰€æœ‰å…·ä½“åè®®å®ç°ç±»ï¼ˆå¦‚ `SerialCommProtocol`ï¼‰ç»§æ‰¿å¹¶å®ç° `IRegisterAccessor`ï¼Œæ–¹ä¾¿ä¸šåŠ¡å±‚å¤šæ€è°ƒç”¨

   ```cpp
   class SerialCommProtocol : public ICommProtocol, public IRegisterAccessor {
       // å…·ä½“å®ç° readUInt16/32/64ï¼ŒwriteUInt16 ç­‰
   };
   ```

   ä¸šåŠ¡å±‚æŒæœ‰ `IRegisterAccessor*` æŒ‡é’ˆï¼Œåšè¯»å†™æ“ä½œï¼Œé¿å…ä¾èµ–åº•å±‚å…·ä½“é€šä¿¡ç»†èŠ‚ã€‚

### æ¨èç¼˜ç”±

- **èŒè´£åˆ†ç¦»**ï¼š`ICommProtocol` å…³æ³¨è¿æ¥å’Œå—è¯»å†™ï¼›`IRegisterAccessor` å…³æ³¨å…·ä½“æ•°æ®ç±»å‹çš„è¯»å†™å°è£…ã€‚
- **å¤ç”¨æ€§å¼º**ï¼šä¸åŒç”µæœºå‹å·ä¸šåŠ¡åªä¾èµ– `IRegisterAccessor` æ¥å£ï¼Œä¸å…³å¿ƒå…·ä½“é€šä¿¡æ–¹å¼ã€‚
- **æ˜“æ‰©å±•**ï¼šæœªæ¥æ·»åŠ æ–°çš„è¯»å†™å®½åº¦ï¼Œæˆ–æ–°åè®®ï¼ˆå¦‚è“ç‰™ï¼‰å®ç°ï¼Œåªéœ€å®ç° `IRegisterAccessor`ã€‚
- **ä¾¿äºå•å…ƒæµ‹è¯•**ï¼šä¸šåŠ¡å±‚å¯ä»¥mock `IRegisterAccessor` æ–¹ä¾¿æµ‹è¯•ã€‚

### ä¸‹ä¸€æ­¥å¯ä»¥æ€ä¹ˆåš

- æŠŠ `readUInt16/32/64` å’Œå¯¹åº”å†™å…¥æ–¹æ³•ï¼Œä» `SerialCommProtocol` ä¸­æå–åˆ°ç‹¬ç«‹æ¥å£ `IRegisterAccessor`ã€‚
- è®© `SerialCommProtocol` å®ç°è¯¥æ¥å£ã€‚
- `P100SMotor` æŒæœ‰ `IRegisterAccessor*` æŒ‡é’ˆï¼ˆæˆ–ä¼ å…¥æ„é€ ï¼‰ï¼Œè°ƒç”¨è¿™äº›å°è£…çš„è¯»å†™æ–¹æ³•ã€‚
- ä¿ç•™åŸå§‹çš„ `ICommProtocol` ä½œä¸ºé€šä¿¡åº•å±‚æ¥å£ã€‚

# 7.31

## è°ƒæ•´`SerialCommProtocol`ç»“æ„

ç°åœ¨`SerialCommProtocol`çš„å®šä¹‰ä¸ºï¼š

```cpp
class SerialCommProtocol : public ICommProtocol, public IRegisterAccessor{}
```

å…¶ç»§æ‰¿äº†ä¸¤ä¸ªæ¥å£ã€‚å®ç°ç”µæœºåº•å±‚é€šè¿‡ä¸²å£é€šä¿¡çš„æ–¹å¼ï¼Œè¿›è¡Œå¯„å­˜å™¨è¯»å†™ã€‚æš´éœ²çš„æ¥å£ä¸ºï¼š

```cpp
// ICommProtocol å®ç°ï¼ˆä»ä¿ç•™ regTypeï¼‰
bool open(const std::string& deviceName, bool reOpen = false) override;
void close() override;
bool isOpen() const override;

bool read(int mID, int regType, int startReg, int stopReg, RegisterBlock& out) override;
bool write(int mID, int regType, int reg, const RegisterBlock& in) override;

// IRegisterAccessor å®ç°
bool readUInt16(int mID, int regType, int reg, uint16_t& outVal) override;
bool writeUInt16(int mID, int regType, int reg, uint16_t value) override;

bool readUInt32(int mID, int regType, int reg, uint32_t& outVal) override;
bool writeUInt32(int mID, int regType, int reg, uint32_t value) override;

bool readUInt64(int mID, int regType, int reg, uint64_t& outVal) override;
bool writeUInt64(int mID, int regType, int reg, uint64_t value) override;
```

ä½†æ˜¯ç°åœ¨æˆ‘çš„è€ƒè™‘æ˜¯ï¼Œç°åœ¨è¿™ä¸ªç»“æ„æ˜¯ä¸å¤Ÿå®Œå–„çš„ã€‚

å› ä¸ºç”µæœºå…¶å®è¯»å–çš„åº”è¯¥åªè€ƒè™‘å¯„å­˜å™¨å°±å¯ä»¥äº†ï¼Œè€Œä¸æ˜¯åŸºäºå„ç§é€šè®¯åè®®å®ç°ã€‚

å°±æ˜¯ä¾‹å¦‚åŠ å…¥ä¸€å±‚å¯„å­˜å™¨è¯»å†™å±‚`MotorRegisterAccessor`è´Ÿè´£è´Ÿè´£ä¸ç”µæœºäº¤äº’ï¼Œæ˜¯ç”µæœºç¡¬ä»¶äº¤äº’çš„æŠ½è±¡å±‚ï¼Œå¼ºè°ƒåº•å±‚åè®®å®ç°çš„æ— å…³æ€§ï¼ˆè“ç‰™/ä¸²å£ç­‰ï¼‰ï¼š

```cpp
bool writeReg16(qint32 motorID, quint32 regAddr, quint16 val);
bool writeReg32(qint32 motorID, quint32 regAddr, quint32 val);
bool writeReg64(qint32 motorID, quint32 regAddr, quint64 val);
bool readReg16(qint32 motorID, quint32 regAddr, quint16 &val);
bool readReg32(qint32 motorID, quint32 regAddr, quint32 &val);
bool readReg64(qint32 motorID, quint32 regAddr, quint64 &val);
```

ç”µæœºç›´æ¥è·Ÿè¿™ä¸€å±‚è¿›è¡Œäº¤äº’ã€‚å®ƒä¼šè°ƒç”¨`ICommProtocol`çš„æ–¹æ³•æ¥å®ç°å¯¹åº”çš„è¯»å†™é€»è¾‘ã€‚

ç°åœ¨é¡¹ç›®ç»“æ„ä¸º

```bash
Administrator@CRX MINGW64 /f/project/servoV6 (master)
$ tree -L 2
.
|-- CMakeLists.txt
|-- CMakeLists.txt.user
|-- README.md
|-- adapters
|   |-- CMakeLists.txt
|   |-- ServoAdapterFactory.cpp
|   |-- ServoAdapterFactory.h
|   |-- motors
|   |-- protocol
|   `-- servos
|-- app
|   |-- CMakeLists.txt
|   |-- main.cpp
|   `-- qml
|-- application
|   |-- BusinessLogic.cpp
|   |-- BusinessLogic.h
|   |-- CMakeLists.txt
|   |-- MotorCommandExecutor.cpp
|   `-- MotorCommandExecutor.h
|-- build
|   `-- Desktop_Qt_6_9_1_MinGW_64_bit-Debug
|-- domain
|   |-- CMakeLists.txt
|   |-- CommandVisitor.h
|   |-- ICommProtocol.h
|   |-- IMotor.h
|   |-- IRegisterAccessor.h
|   |-- IServoAdapter.h
|   `-- MovementCommand.h
|-- external
|   `-- spdlog
|-- tests
|   |-- CMakeLists.txt
|   |-- test_main.cpp
|   |-- test_p100smotor.cpp
|   |-- test_p100smotor.h
|   |-- test_serialcommprotocol.cpp
|   `-- test_serialcommprotocol.h
`-- utils
    |-- CMakeLists.txt
    |-- Logger.cpp
    `-- Logger.h

14 directories, 29 files
```

è¯·ä½ ä¾æ®æ­¤ç»“æ„ï¼Œè§£å†³å‡ ä¸ªé—®é¢˜ï¼š

- å¯„å­˜å™¨è¯»å†™ç±»`MotorRegisterAccessor`åº”è¯¥æ”¾åœ¨é‚£ä¸€å±‚
- æ˜¯å¦åº”è¯¥åˆ é™¤è¿™ä¸ªå†—ä½™çš„`IRegisterAccessor`ï¼Ÿ
- ä»¥TDDçš„å¼€å‘æ¨¡å¼çš„è¯ï¼Œä¸‹ä¸€æ­¥ä¼˜åŒ–æ­¥éª¤æ˜¯ä»€ä¹ˆï¼Ÿ

### è®¾è®¡æ€è·¯

#### 1. ç±»ä½ç½®ï¼š`domain`å±‚

```diff
domain/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ CommandVisitor.h
â”œâ”€â”€ ICommProtocol.h
+â”œâ”€â”€ MotorRegisterAccessor.h  # æ–°å¢å¯„å­˜å™¨è®¿é—®å™¨
â”œâ”€â”€ IMotor.h
-â”œâ”€â”€ IRegisterAccessor.h     # åˆ é™¤å†—ä½™æ¥å£
â””â”€â”€ MovementCommand.h
```

#### 2. åˆ é™¤å†—ä½™çš„`IRegisterAccessor`

**å®Œå…¨åˆ é™¤ç†ç”±**ï¼š

1. `MotorRegisterAccessor`æä¾›äº†æ›´ä¸“ä¸šçš„å¯„å­˜å™¨è®¿é—®æ¥å£
2. åŸæœ‰æ¥å£åŒ…å«å†—ä½™çš„`regType`å‚æ•°ï¼ˆå¯„å­˜å™¨ç±»å‹åœ¨ç”µæœºå¯„å­˜å™¨æ¨¡å‹ä¸­ä¸å¿…è¦ï¼‰
3. ç®€åŒ–æ¶æ„ï¼Œå‡å°‘æ¥å£è†¨èƒ€

#### 3. `MotorRegisterAccessor`å…·ä½“å®ç°

```cpp
// domain/MotorRegisterAccessor.h
#pragma once
#include "ICommProtocol.h"

class MotorRegisterAccessor {
public:
    explicit MotorRegisterAccessor(ICommProtocol* protocol);
    
    // å¯„å­˜å™¨å†™å…¥æ“ä½œ
    bool writeReg16(int32_t motorID, uint32_t regAddr, uint16_t value);
    bool writeReg32(int32_t motorID, uint32_t regAddr, uint32_t value);
    bool writeReg64(int32_t motorID, uint32_t regAddr, uint64_t value);
    
    // å¯„å­˜å™¨è¯»å–æ“ä½œ
    bool readReg16(int32_t motorID, uint32_t regAddr, uint16_t& outVal);
    bool readReg32(int32_t motorID, uint32_t regAddr, uint32_t& outVal);
    bool readReg64(int32_t motorID, uint32_t regAddr, uint64_t& outVal);

    // æ‰¹é‡å¯„å­˜å™¨æ“ä½œï¼ˆå¯é€‰æ‰©å±•ï¼‰
    bool readRegBlock(int32_t motorID, uint32_t startAddr, uint16_t* buffer, size_t count);
    bool writeRegBlock(int32_t motorID, uint32_t startAddr, const uint16_t* values, size_t count);

private:
    ICommProtocol* m_protocol; // åè®®å®ç°ï¼ˆä¸æ‹¥æœ‰æ‰€æœ‰æƒï¼‰
    
    // å­—èŠ‚åºå¤„ç†ï¼ˆæ ¹æ®ç¡¬ä»¶éœ€æ±‚ï¼‰
    void convertEndian(uint16_t& value);
    void convertEndian(uint32_t& value);
    void convertEndian(uint64_t& value);
};
```

### æ„å»ºTDDæµ‹è¯•æµç¨‹

#### åˆ›å»ºæµ‹è¯•ç±»

åœ¨`tests/`ç›®å½•ä¸‹ï¼Œåˆ›å»º`test_motorregisteraccessor.cpp`ï¼Œå¹¶ä¸”åœ¨`test_main.cpp`ä¸­åŠ å…¥æµ‹è¯•

#### æµ‹è¯•å†…å®¹

é¦–å…ˆéœ€è¦æ ¹æ®å½“å‰çš„å¯„å­˜å™¨è¯»å†™å‡½æ•°ï¼Œå†™å¯¹åº”çš„æµ‹è¯•ã€‚å·²ç»å¯çŸ¥çš„èƒ½è¯»å–å’Œå†™å…¥çš„å¯„å­˜å™¨æœ‰ï¼š

- `0x1018`ï¼šå­˜æ”¾äº†64ä½çš„ä½ç½®æ•°æ®ï¼Œåªèƒ½è¯»å–
- `21`ï¼šå­˜æ”¾äº†è½¬é€Ÿï¼ˆrpmï¼‰ä¿¡æ¯ï¼Œå¯è¯»å¯å†™ï¼Œæœ€å¤§200rpm

è¯·ä½ ä»¥æ­¤è®¾è®¡æµ‹è¯•æ–¹æ³•ï¼Œç»™å‡ºä»£ç å®ç°ã€‚

## è®¾ç½®é€Ÿåº¦

è¿™ä¸ªåŠŸèƒ½ä¹Ÿè¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ˜¯è¯»å†™å¯„å­˜å™¨ã€‚ä¸æ¶‰åŠè¾ƒä¸ºå¤æ‚çš„é€»è¾‘ã€‚å¯„å­˜å™¨åç§°å’Œåœ°å€ï¼š

```CPP
P4_4 = 0x204,   // ç¬¬ä¸€æ®µå†…éƒ¨ä½ç½®é€Ÿåº¦ 0-6000r/min
PA21 = 21,      // JOGæ“ä½œçš„è¿è¡Œé€Ÿåº¦ 0-6000r/min
```

æ‰€ä»¥åŸºäºä¸¤ä¸ªå¯„å­˜å™¨ï¼Œè¯·ä½ æŒ‰ç…§æ¨¡æ¿åŠ å…¥ç®¡ç†ï¼š

```cpp
    enum P100SRegisterAddr : uint32_t {
        P4_2_SetMultiTurns = 0x202,
        P4_3_SetInnerPulse = 0x203,
        P3_34_ResetEncoderMultiTurns = 0x122,
        CurrentPositionPulse = 0x1018,
        PA95_EncoderResolutionExp = 95,
    };
```

å¹¶ä¸”åŸºäºTDDçš„å¼€å‘æ¨¡å¼ï¼Œæµ‹è¯•è·å–å’Œè®¾ç½®é€Ÿåº¦çš„æ­£ç¡®æ€§ï¼ŒåŠ å…¥æ–°çš„æµ‹è¯•å‡½æ•°ï¼š

```cpp
#ifndef TEST_P100SMOTOR_H
#define TEST_P100SMOTOR_H

#include <QObject>

class P100SMotorTest : public QObject
{
    Q_OBJECT

private slots:
    void positionAndReset_shouldWork();
};

#endif // TEST_P100SMOTOR_H

```

ç„¶åå®ç°è®¾ç½®å’Œè·å–é€Ÿåº¦çš„æ–¹æ³•ï¼š

```cpp
bool P100SMotor::setJogRPM(int rpm) {
    if (!checkRPMRange(rpm)) {
        LOG_WARN("ç‚¹åŠ¨è½¬é€Ÿè®¾ç½®å¤±è´¥ï¼Œè¶…å‡ºèŒƒå›´: {}", rpm);
        return false;
    }
    jogRPM_ = rpm;
    LOG_INFO("è®¾ç½®ç‚¹åŠ¨è½¬é€Ÿä¸º {}", rpm);
    // TODO: æ ¹æ®ç¡¬ä»¶åè®®å†™å¯„å­˜å™¨å®ç°å®é™…è®¾ç½®
    return false;
}

int P100SMotor::getJogRPM() const {
    return jogRPM_;
}

bool P100SMotor::setMoveRPM(int rpm) {
    if (!checkRPMRange(rpm)) {
        LOG_WARN("ä½ç½®ç§»åŠ¨è½¬é€Ÿè®¾ç½®å¤±è´¥ï¼Œè¶…å‡ºèŒƒå›´: {}", rpm);
        return false;
    }
    moveRPM_ = rpm;
    LOG_INFO("è®¾ç½®ä½ç½®ç§»åŠ¨è½¬é€Ÿä¸º {}", rpm);
    // TODO: æ ¹æ®ç¡¬ä»¶åè®®å†™å¯„å­˜å™¨å®ç°å®é™…è®¾ç½®
    return false;
}

int P100SMotor::getMoveRPM() const {
    return moveRPM_;
}
```

## ä½ç½®ç§»åŠ¨

åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ã€‚ç°åœ¨å°±è¦åšæ¯”è¾ƒå¤æ‚çš„ä½ç½®ç§»åŠ¨äº†ã€‚åˆ†æä¸‹ä¹‹å‰çš„ç›¸å¯¹ä½ç½®ç§»åŠ¨é€»è¾‘ã€‚

### æ”¯æŒç¯å¢ƒ

åœ¨ä½ç½®ç§»åŠ¨ä¹‹å‰ï¼Œéœ€è¦ç¯å¢ƒæ”¯æŒä½ç½®ç§»åŠ¨ã€‚ç„¶åå°±åªéœ€è¦è®¾ç½®ä½ç½®ç§»åŠ¨çš„åœˆæ•°åï¼Œä½¿èƒ½ç”µæœºè¿›è¡Œç§»åŠ¨å³å¯ã€‚

- PA4è®¾ç½®ä½ç½®ç§»åŠ¨æ¨¡å¼ï¼šï¼ˆå½“å‰è®¾ç½®çš„æ˜¯ï¼šä½ç½®é€Ÿåº¦æ··åˆæ§åˆ¶æ–¹å¼3ï¼‰

- ç”µå­é½¿è½®æ¯”ï¼š

  ç”µå­é½¿è½®æ¯” = ç”µæœºæ—‹è½¬ä¸€åœˆéœ€è¦çš„æŒ‡ä»¤è„‰å†² / ç”µæœºç¼–ç å™¨åˆ†è¾¨ç‡

  - PA95 = 17ï¼Œç”µæœºç¼–ç å™¨åˆ†è¾¨ç‡ï¼ˆç”µæœºæ¯æ—‹è½¬1 åœˆçš„ä½ç½®è®°å½•è„‰å†²ï¼‰ã€‚é»˜è®¤ä¸º17ï¼Œå³ä¸º2^17ã€‚å†³å®šäº†ç”µæœºæ—‹è½¬ä¸€åœˆï¼Œç”µæœºè®°å½•çš„è„‰å†²æ•°
  - PA11 = 0ã€‚PA11å­˜å‚¨çš„æ˜¯â€œç”µæœºæ¯æ—‹è½¬1 åœˆçš„æŒ‡ä»¤è„‰å†²æ•°"ã€‚å½“PA11 è®¾ç½®ä¸º0çš„æ—¶å€™ï¼Œä¼ºæœæ§åˆ¶å™¨å°±ä¼šæŒ‰ç…§ç”µæœºè®¾ç½®çš„ç”µå­é½¿è½®æ¯”ï¼Œè¿›è¡ŒæŒ‡ä»¤è„‰å†²ä¸ä½ç½®è„‰å†²çš„æ¢ç®—ã€‚
  - PA12 = 131072/16ã€‚PA11 ä¸ºâ€œä½ç½®æŒ‡ä»¤è„‰å†²ç”µå­é½¿è½®ç¬¬ä¸€åˆ†å­â€ã€‚
  - PA13 = 10800/16ã€‚PA12ä¸ºâ€œä½ç½®æŒ‡ä»¤è„‰å†²ç”µå­é½¿è½®åˆ†æ¯â€ã€‚

- P3-30 = 2ã€‚è™šæ‹Ÿè¾“å…¥ç«¯å­æ§åˆ¶ 

  P ç³»åˆ—é©±åŠ¨å™¨çš†æœ‰ 4 ä¸ªè¾“å…¥ç«¯å­ï¼Œ4 ä¸ªè¾“å‡ºç«¯å­ï¼Œå¯é€šè¿‡ P3 ç»„ç³»åˆ—å‚æ•°æ”¹å˜ç«¯å­è¾“å…¥è¾“å‡ºå®šä¹‰å€¼ï¼Œå®Œæˆå„ç§è¾“å…¥è¾“å‡ºå®šä¹‰ã€‚ï¼ˆè¾“å…¥ç«¯å­é»˜è®¤ä½ç”µå¹³æœ‰æ•ˆï¼‰

  ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼šç”±äºç‰©ç†ç«¯å£ DI1~DI4 æ•°é‡æœ‰é™ï¼ˆç¡¬ä»¶é™åˆ¶ï¼‰ï¼ŒP ç³»åˆ—é©±åŠ¨å™¨æä¾›äº†â€œè™šæ‹Ÿè¾“å…¥â€çš„åŠŸèƒ½ï¼Œå…è®¸é€šè¿‡å‚æ•°æ¨¡æ‹Ÿè¾“å…¥ä¿¡å·ï¼Œä¾¿äºè°ƒè¯•æˆ–é€šè¿‡é€šè®¯æ§åˆ¶é©±åŠ¨å™¨ã€‚

  - **é»˜è®¤å€¼ 0**ï¼šæ­¤æ¨¡å¼ä»…ä½¿ç”¨**ç‰©ç†è¾“å…¥ç«¯å­ DI1~DI4**ï¼Œå…± 4 ä¸ªè¾“å…¥ä¿¡å·ã€‚å¯¹åº”å‚æ•° P3-0~P3-3æ¥æ§åˆ¶ 4 ä¸ª DI çš„åŠŸèƒ½ã€‚

  - **è™šæ‹Ÿè¾“å…¥æ§åˆ¶ 1** ï¼šæ­¤æ¨¡å¼ä»…ä½¿ç”¨**è™šæ‹Ÿè¾“å…¥**ï¼Œå…± 8 ä¸ªè™šæ‹Ÿè¾“å…¥ä¿¡å·ã€‚

    - æ§åˆ¶è¾“å…¥æ¥è‡ªå‚æ•° P3-31 çš„ä½ä½å›¾ï¼ˆbit0 ~ bit7ï¼‰
    - æ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªè¾“å…¥ç«¯å­çš„çŠ¶æ€ï¼ˆ0=ä½ç”µå¹³æœ‰æ•ˆï¼Œ1=æ— æ•ˆï¼‰
    - å¯¹åº”å‚æ•°è®¾ç½®ï¼š`P3-38 ~ P3-45`

    > ä¾‹å¦‚æ­¤æ—¶ï¼ŒP3-31 = 0b00000001ï¼ˆbit0 = 1ï¼‰â†’ æ¨¡æ‹Ÿ DI1 ä¸ºâ€œé«˜ç”µå¹³â€ï¼Œè¡¨ç¤ºâ€œæ²¡æœ‰è§¦å‘â€ã€‚æ­¤æ—¶å¯ä»¥é€šè¿‡P3-38 è®¾ç½®ï¼šè™šæ‹Ÿ DI1 ä¸ºâ€œå¯åŠ¨å‘½ä»¤â€

  - **æ··åˆè¾“å…¥æ¨¡å¼ 2**ï¼šæ­¤æ¨¡å¼æ—¢ä½¿ç”¨ **DI1~DI4**ï¼ˆç‰©ç†è¾“å…¥éœ€è¦æ¥çº¿ï¼‰ åˆä½¿ç”¨**P3-31**ï¼ˆè™šæ‹Ÿè¾“å…¥ä¸éœ€è¦æ¥çº¿ï¼‰ï¼Œå…± 12 ä¸ªè¾“å…¥ä¿¡å·ã€‚

    - å¯¹åº” DI çš„åŠŸèƒ½è®¾ç½®ä»¥ï¼šçœŸå®ç«¯å­ï¼šP3-0 ~ P3-3ï¼Œä»¥åŠè™šæ‹Ÿè¾“å…¥ï¼š`P3-38 ~ P3-45` æ¥å…±åŒå†³å®šã€‚

  æ‰€ä»¥å¦‚æœå°†`P3-30`è®¾ç½®ä¸ºæ··åˆè¾“å…¥æ¨¡å¼ï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡è®¾ç½®P3-31ï¼ˆè™šæ‹Ÿè¾“å…¥ç«¯å­çŠ¶æ€å€¼ï¼‰æ¥æ§åˆ¶è™šæ‹Ÿ DI ç«¯å­çš„å€¼ã€‚å¹¶ä¸”ä½ç”µå¹³æœ‰æ•ˆï¼Œé«˜ç”µå¹³æ— æ•ˆã€‚

  è€Œæ¯ä¸ªè™šæ‹Ÿ DI ç«¯å­çš„çš„åŠŸèƒ½ï¼Œéœ€è¦é€šè¿‡`P3-38 ~ P3-45`è®¾ç½®å¯¹åº”çš„å€¼æ¥æ§åˆ¶ã€‚

  | è¾“å…¥ç¼–å· | è¾“å…¥æ¥æº | åŠŸèƒ½å®šä¹‰å‚æ•° | ç”µå¹³æ§åˆ¶æ–¹å¼          |
  | -------- | -------- | ------------ | --------------------- |
  | DI1      | ç‰©ç†ç«¯å­ | P3-0         | å¤–éƒ¨ä½ç”µå¹³æœ‰æ•ˆ        |
  | DI2      | ç‰©ç†ç«¯å­ | P3-1         | å¤–éƒ¨ä½ç”µå¹³æœ‰æ•ˆ        |
  | DI3      | ç‰©ç†ç«¯å­ | P3-2         | å¤–éƒ¨ä½ç”µå¹³æœ‰æ•ˆ        |
  | DI4      | ç‰©ç†ç«¯å­ | P3-3         | å¤–éƒ¨ä½ç”µå¹³æœ‰æ•ˆ        |
  | DI5      | è™šæ‹Ÿè¾“å…¥ | P3-38        | P3-31 bit0ï¼ˆä½=æœ‰æ•ˆï¼‰ |
  | DI6      | è™šæ‹Ÿè¾“å…¥ | P3-39        | P3-31 bit1ï¼ˆä½=æœ‰æ•ˆï¼‰ |
  | DI7      | è™šæ‹Ÿè¾“å…¥ | P3-40        | P3-31 bit2ï¼ˆä½=æœ‰æ•ˆï¼‰ |
  | DI8      | è™šæ‹Ÿè¾“å…¥ | P3-41        | P3-31 bit3ï¼ˆä½=æœ‰æ•ˆï¼‰ |
  | DI9      | è™šæ‹Ÿè¾“å…¥ | P3-42        | P3-31 bit4ï¼ˆä½=æœ‰æ•ˆï¼‰ |
  | DI10     | è™šæ‹Ÿè¾“å…¥ | P3-43        | P3-31 bit5ï¼ˆä½=æœ‰æ•ˆï¼‰ |
  | DI11     | è™šæ‹Ÿè¾“å…¥ | P3-44        | P3-31 bit6ï¼ˆä½=æœ‰æ•ˆï¼‰ |
  | DI12     | è™šæ‹Ÿè¾“å…¥ | P3-45        | P3-31 bit7ï¼ˆä½=æœ‰æ•ˆï¼‰ |

- è™šæ‹Ÿ IO è¾“å…¥ DI çš„åŠŸèƒ½å®šä¹‰

  ä¸Šé¢æ—¢ç„¶å®šä¹‰äº†ä¼ºæœæ”¯æŒç‰©ç†çš„DIæ§åˆ¶ï¼Œä¹Ÿæ”¯æŒè™šæ‹Ÿç«¯å­çš„DIæ§åˆ¶ï¼Œé‚£ä¹ˆå°±è¦å®šä¹‰ä¸€ä¸‹ç¬¦åˆå½“å‰ç”µæœºç§»åŠ¨çš„DIè¾“å…¥ã€‚æˆ‘ä»¬çœ‹ä¸‹ä¹‹å‰è®¾ç½®çš„å„ä¸ªDIåŠŸèƒ½å‚æ•°ï¼Œä»¥æ­¤çª¥æ¢åˆ°åº•ä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼š

  - P3-38 = 28ã€‚`CTRG`ï¼Œå†…éƒ¨ä½ç½®å‘½ä»¤è§¦å‘ã€‚æ˜¯è§¦å‘ä½ç½®è¿åŠ¨çš„åŠŸèƒ½ã€‚

    > åœ¨å†…éƒ¨ä½ç½®å¯„å­˜å™¨æ¨¡å¼æ—¶ï¼Œé€‰æ‹©å†…éƒ¨ä½ç½®å¯„å­˜å™¨æ§åˆ¶å‘½ä»¤ï¼ˆPOS0-2ï¼‰åï¼Œæ­¤ä¿¡å·è§¦å‘ï¼Œç”µæœºæ ¹æ®å†…éƒ¨ä½ç½®å¯„å­˜å™¨å‘½ä»¤è¿è½¬ã€‚å½“æ•°å­—è¾“å‡ºé›¶é€Ÿåº¦ä¿¡å·ï¼ˆZSPD=1ï¼‰åï¼Œæ‰æ¥å—ä¸‹ä¸€æ¬¡è§¦å‘å†…éƒ¨ä½ç½®å‘½ä»¤

  - P3-39 = 16.`CMODE`ï¼Œå¤åˆæ¨¡å¼æ§åˆ¶æ¨¡å¼è®¾å®šã€‚

    > å½“ PA-4 è®¾ç½®ä¸º 3ï¼Œ4ï¼Œ5 æ—¶ï¼Œå¤„äºæ··åˆæ§åˆ¶æ¨¡å¼ï¼Œå¯é€šè¿‡æ­¤è¾“å…¥ç«¯å­å¯åˆ‡æ¢æ§åˆ¶æ¨¡å¼ï¼š
    > (1)PA-4 ä¸º 3 æ—¶,CMODE OFFï¼Œä¸ºä½ç½®æ¨¡å¼ï¼›CMODE ONï¼Œåˆ™ä¸ºé€Ÿåº¦æ¨¡å¼ï¼›ï¼ˆä¹‹å‰å°±è®¾ç½®çš„å€¼ä¸º3ï¼‰
    > (2)PA-4 ä¸º 4 æ—¶,CMODE OFFï¼Œä¸ºä½ç½®æ¨¡å¼ï¼›CMODE ONï¼Œåˆ™ä¸ºè½¬çŸ©æ¨¡å¼ï¼›
    > (3)PA-4 ä¸º 5 æ—¶,CMODE OFFï¼Œä¸ºé€Ÿåº¦æ¨¡å¼ï¼›CMODE ONï¼Œåˆ™ä¸ºè½¬çŸ©æ¨¡å¼

  - P3-40 = 22.`JOGP`ï¼Œæ­£å‘ç‚¹åŠ¨ã€‚

    > é€Ÿåº¦æ¨¡å¼ä¸‹ï¼ŒPA22=5 æ—¶ï¼Œæ­¤ä¿¡å·æ¥é€šï¼Œç”µæœºæ­£æ–¹å‘å¯¸åŠ¨ï¼Œç‚¹åŠ¨é€Ÿåº¦å— PA21 è®¾ç½®ã€‚
    > æ³¨æ„ï¼šæ­¤ä¿¡å·è·Ÿåå‘å¯¸åŠ¨åŒæ—¶æ¥é€šï¼Œå¯¸åŠ¨åŠŸèƒ½æ— æ•ˆã€‚

  - P3-41 = 23.`JOGN`ï¼Œåå‘ç‚¹åŠ¨ã€‚

    > é€Ÿåº¦æ¨¡å¼ä¸‹ï¼ŒPA22=5 æ—¶ï¼Œæ­¤ä¿¡å·æ¥é€šï¼Œç”µæœºåæ–¹å‘å¯¸åŠ¨ï¼Œç‚¹åŠ¨é€Ÿåº¦å— PA21 è®¾ç½®ã€‚
    > æ³¨æ„ï¼šæ­¤ä¿¡å·è·Ÿåå‘å¯¸åŠ¨åŒæ—¶æ¥é€šï¼Œå¯¸åŠ¨åŠŸèƒ½æ— æ•ˆã€‚

  - P3-42 = 27. `HOLD`ï¼Œå†…éƒ¨ä½ç½®æ§åˆ¶å‘½ä»¤åœæ­¢ã€‚æ˜¯ä½ç½®ç§»åŠ¨çš„ç´§æ€¥åœæ­¢ä¿¡å·ã€‚

    > åœ¨å†…éƒ¨ä½ç½®å¯„å­˜å™¨æ¨¡å¼æ—¶ï¼Œæ­¤ä¿¡å·æ¥é€šï¼Œç”µæœºå°†åœæ­¢è¿è½¬ï¼ˆåªèƒ½åœ¨å†…éƒ¨ä½ç½®æ¨¡å¼ PA-14=3 æ—¶ä½¿ç”¨ï¼‰ã€‚
