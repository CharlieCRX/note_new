# P100S位置移动参数解析

千呼万唤始出来。现在就要做比较复杂的位置移动了。分析下之前的相对位置移动逻辑。

这是一个 **多圈绝对位置移动设置案例**。

## 通讯基础

需要建立通信的基础：

- PA71：MODBUS 从机地址
- PA72：MODBUS 通讯波特率
- PA73：MODBUS 通讯协议

这个是通过上位机进行配置的。

## 支持环境

在位置移动之前，需要环境支持位置移动。然后就只需要设置位置移动的圈数后，使能电机进行移动即可。

### 1.移动模式

- PA4设置位置移动模式：（当前设置的是：位置速度混合控制方式3）
- PA14设置位置指令脉冲方式为：内部位置输入3

### 2.电子齿轮比

- 电子齿轮比：

  电子齿轮比 = 电机旋转一圈需要的指令脉冲 / 电机编码器分辨率

  - PA95 = 17，电机编码器分辨率（电机每旋转1 圈的位置记录脉冲）。默认为17，即为2^17。决定了电机旋转一圈，电机记录的脉冲数
  - PA11 = 0。PA11存储的是“电机每旋转1 圈的指令脉冲数"。当PA11 设置为0的时候，伺服控制器就会按照电机设置的电子齿轮比，进行指令脉冲与位置脉冲的换算。
  - PA12 = 131072/16。PA11 为“位置指令脉冲电子齿轮第一分子”。
  - PA13 = 10800/16。PA12为“位置指令脉冲电子齿轮分母”。

### 3.DI配置

- P3-30 = 2。虚拟输入端子控制 

  P 系列驱动器皆有 4 个输入端子，4 个输出端子，可通过 P3 组系列参数改变端子输入输出定义值，完成各种输入输出定义。（输入端子默认低电平有效）

  翻译过来就是：由于物理端口 DI1~DI4 数量有限（硬件限制），P 系列驱动器提供了“虚拟输入”的功能，允许通过参数模拟输入信号，便于调试或通过通讯控制驱动器。

  - **默认值 0**：此模式仅使用**物理输入端子 DI1~DI4**，共 4 个输入信号。对应参数 P3-0~P3-3来控制 4 个 DI 的功能。

  - **虚拟输入控制 1** ：此模式仅使用**虚拟输入**，共 8 个虚拟输入信号。

    - 控制输入来自参数 P3-31 的位位图（bit0 ~ bit7）
    - 每一位代表一个输入端子的状态（0=低电平有效，1=无效）
    - 对应参数设置：`P3-38 ~ P3-45`

    > 例如此时，P3-31 = 0b00000001（bit0 = 1）→ 模拟 DI1 为“高电平”，表示“没有触发”。此时可以通过P3-38 设置：虚拟 DI1 为“启动命令”

  - **混合输入模式 2**：此模式既使用 **DI1~DI4**（物理输入需要接线） 又使用**P3-31**（虚拟输入不需要接线），共 12 个输入信号。

    - 对应 DI 的功能设置以：真实端子：P3-0 ~ P3-3，以及虚拟输入：`P3-38 ~ P3-45` 来共同决定。

  所以如果将`P3-30`设置为混合输入模式，此时需要通过设置P3-31（虚拟输入端子状态值）来控制虚拟 DI 端子的值。并且低电平有效，高电平无效。

  而每个虚拟 DI 端子的的功能，需要通过`P3-38 ~ P3-45`设置对应的值来控制。

  | 输入编号 | 输入来源 | 功能定义参数 | 电平控制方式          |
  | -------- | -------- | ------------ | --------------------- |
  | DI1      | 物理端子 | P3-0         | 外部低电平有效        |
  | DI2      | 物理端子 | P3-1         | 外部低电平有效        |
  | DI3      | 物理端子 | P3-2         | 外部低电平有效        |
  | DI4      | 物理端子 | P3-3         | 外部低电平有效        |
  | DI1      | 虚拟输入 | P3-38        | P3-31 bit0（低=有效） |
  | DI2      | 虚拟输入 | P3-39        | P3-31 bit1（低=有效） |
  | DI3      | 虚拟输入 | P3-40        | P3-31 bit2（低=有效） |
  | DI4      | 虚拟输入 | P3-41        | P3-31 bit3（低=有效） |
  | DI5      | 虚拟输入 | P3-42        | P3-31 bit4（低=有效） |
  | DI6      | 虚拟输入 | P3-43        | P3-31 bit5（低=有效） |
  | DI7      | 虚拟输入 | P3-44        | P3-31 bit6（低=有效） |
  | DI8      | 虚拟输入 | P3-45        | P3-31 bit7（低=有效） |

### 4.DI逻辑

- 虚拟 IO 输入 DI 的功能定义

  上面既然定义了伺服支持物理的DI控制，也支持虚拟端子的DI控制，那么就要定义一下符合当前电机移动的DI输入。我们看下之前设置的各个DI功能参数，以此窥探到底为什么这么做：

  首先明确的是，P3-38到P3-45对应的分别是DI1和DI8的功能。

  - P3-38 = 28。DI1 设置`CTRG`，内部位置命令触发。是触发位置运动的功能。

    > 在内部位置寄存器模式时，选择内部位置寄存器控制命令（POS0-2）后，此信号触发，电机根据内部位置寄存器命令运转。当数字输出零速度信号（ZSPD=1）后，才接受下一次触发内部位置命令

  - P3-39 = 16.DI2 设置`CMODE`，复合模式控制模式设定。这里PA4为3，所以仅看（1）即可。
  
    > 当 PA-4 设置为 3，4，5 时，处于混合控制模式，可通过此输入端子可切换控制模式：
    > (1)PA-4 为 3 时,CMODE OFF，为位置模式；CMODE ON，则为速度模式；（之前就设置的值为3）
    > (2)PA-4 为 4 时,CMODE OFF，为位置模式；CMODE ON，则为转矩模式；
    > (3)PA-4 为 5 时,CMODE OFF，为速度模式；CMODE ON，则为转矩模式

  - P3-40 = 22.DI3 设置`JOGP`，正向点动。
  
    > 速度模式下，PA22=5 时，此信号接通，电机正方向寸动，点动速度受 PA21 设置。
    > 注意：此信号跟反向寸动同时接通，寸动功能无效。

  - P3-41 = 23.DI4设置`JOGN`，反向点动。
  
    > 速度模式下，PA22=5 时，此信号接通，电机反方向寸动，点动速度受 PA21 设置。
    > 注意：此信号跟反向寸动同时接通，寸动功能无效。

  - P3-42 = 27. DI5 设置`HOLD`，内部位置控制命令停止。是位置移动的紧急停止信号。
  
    > 在内部位置寄存器模式时，此信号接通，电机将停止运转

### 5.移动到指定绝对位置

- `P4-0 = 0`：设置绝对式位置指令。此时目标位置为“编码器坐标”，电机将移动到指定绝对位置。
- `PA62 = 5`：多圈绝对值编码器。可持续记住绝对位置（包括圈数）断电后也能恢复

`P4-0` 是驱动器中用于配置 **内部位置指令控制模式** 的关键参数，它决定了你在使用“内部位置控制”功能时，驱动器如何解释位置指令的方式 —— 是按“绝对值”控制，还是“增量移动”，以及是否配合“多圈/单圈编码器”。

功能介绍：

| P4-0 数值 | 模式类型       | 配合编码器类型（PA62）     | 说明与适用场景                                   |
| --------- | -------------- | -------------------------- | ------------------------------------------------ |
| `0`       | 绝对式位置指令 | `PA62 = 5`（多圈编码器）   | 目标位置为“编码器坐标”，电机将移动到指定绝对位置 |
| `1`       | 增量式位置指令 | 无要求（适用于任何编码器） | 每次命令表示相对当前位置的“增量”位移             |
| `2`       | 绝对式位置指令 | `PA62 = 4`（单圈编码器）   | 同 `0`，但仅适用于单圈编码器，不支持多圈值       |

| PA-62 值 | 编码器类型       | 特点                                         |
| -------- | ---------------- | -------------------------------------------- |
| `4`      | 单圈绝对值编码器 | 每圈内有位置精度，但无圈数追踪功能           |
| `5`      | 多圈绝对值编码器 | 可持续记住绝对位置（包括圈数）断电后也能恢复 |

对比：

| P4-0 | 控制模式       | 编码器要求     | 移动含义                 | 特点             |
| ---- | -------------- | -------------- | ------------------------ | ---------------- |
| 0    | 绝对式位置控制 | 多圈（PA62=5） | 移动到绝对坐标（带圈数） | 精度高、掉电恢复 |
| 1    | 增量式位置控制 | 无要求         | 从当前位置移动一个增量   | 控制直观         |
| 2    | 绝对式位置控制 | 单圈（PA62=4） | 移动到单圈绝对位置       | 简洁但不跨圈     |

因为我们使用的电机场景，需要记录电机的位置，并且有精准移动到某个位置的需求。所以选择绝对式位置指令。

## DO逻辑

相较于 DI 较为麻烦的设置逻辑，DO 这块较为明确。

首先，电机存在了5个 DO 端口。其功能是寄存器P3-20到P3-24负责。

当前DO的设置规则为：

- P3-20 = 5。bit0 对应的DO1 功能为`COIN`，定位完成。功能是在位置控制时，
  - OFF ：位置偏差大于参数 PA-16；
  - ON ：位置偏差小于参数 PA-16
- P3-21 = 8。bit1 对应的DO2 功能为`BRK`，电磁制动器。
  - OFF ：电磁制动器制动；
  - ON ：电磁制动器释放。
- P3-22 = 0。无效
- P3-23 =3。bit3 对应的DO4 功能为`ALM`，报警。
  - OFF ：有报警；
  - ON ：无

## 位置移动

上面已经配置好了 P100S 电机的通讯、以及位置/速度运动模式，下面就需要通过设置位置移动的参数，来实现位置移动了。

### 1.伺服使能

- `PA53 = 1`

位置移动前，需要先将电机通电。这里发现一个很有意思的参数：

> PA54：伺服使能延时关闭时间。这个感觉能解决点动停止速度过慢的问题。

### 2.位置移动速度

因为我们只涉及到第一段内部位置移动，所以要设置第一段内部位置移动的速度。

- `P4-4(0X0204)`：第一段内部位置速度,RPM

### 3.绝对位置

根据之前设置的**多圈**绝对式位置指令，电机会根据设置的绝对目标位置进行移动。所以这里需要设置绝对位置的圈数和圈内脉冲数：

- `P4-2(0x202)`：第一段内部位置圈数
- `P4-3(0x203)`：第一段内部位置圈内脉冲数

## 正常移动结束

移动停止的主要原因有两个：

- 电机运行到目标位置，正常运动结束
- 执行内部位置控制命令停止。

> 例如P3-20 设置为 16 定义 DO1 输出内部位置定位完成，可以通过读 0X1010，读到状态位 bit0 变化。 

### 1.定位完成

- `P3-20 = 5`：DO1功能为位置误差判断。
- `PA16`：定位完成范围

其中P3-20到P3-24对应的是DO1-DO5的5个输出端子。而DO端子的功能对照为：

- 5：`COIN`，定位完成。位置控制时，
  - OFF ：位置偏差大于参数 PA-16；
  - ON ：位置偏差小于参数 PA-16
- 16：`CMDOK`，内部位置命令完成。
  - OFF ：当内部位置命令未完成或内部位置命令未停止时，不输出信号；
  - ON ： 当内部位置命令完成或内部位置命令停止时，经过 P4-1 设置时间后输出信号。

| 特性             | `COIN (5)`            | `CMDOK (16)`             |
| ---------------- | --------------------- | ------------------------ |
| 响应依据         | 实际位置偏差          | 控制器内部状态（程序流） |
| 响应时机         | 达到设定精度后        | 命令执行完毕立即或延迟   |
| 对误差敏感       | 敏感（受 PA-16 控制） | 不敏感                   |
| 对PID性能依赖    | 高                    | 低                       |
| 典型使用         | 精准停靠确认          | 流程判断、逻辑切换       |
| 可用于超限检测？ | 否                    | 否                       |

因为我们是为了实现“精密位置对准、准停确认”的需求，所以使用

> **推荐用 DO = COIN（5）**，依赖位置误差精度。

而对于 DO = CMDOK(16):

> 适用于“移动到某圈 → 抓取 → 回原位 → 释放”，
>  **推荐用 DO = CMDOK（16）**，判断“位置命令完成”。

### 2.轮询获取DO1状态

现在已经知道DO1的功能是位置误差判断。所以位置移动开始后，需要一个循环定时读取DO1的值，直到获取DO1输出为1。

获取DO1输出的方法就是读取`0x1010`位置的bit0位置。如果是1，则证明位置移动完成。

## 异常移动结束

异常包括了：

- 电机、负载故障导致位置移动结束
- 提前释放位置移动结束信号。

> P3-42 设置为 27 定义 DI5 内部位置停止，只需要让 DI 的 bit4输出为 1 就可以停止终止位置移动。

而异常的读取可以通过：

- `P3-23 = 3`：设置 DO4 功能为`ALM`，报警
  - OFF ：有报警
  - ON ：无报警

所以检测 DO4 如果输出0，则为告警即可。

------

# P100S位置移动案例

以下是一个**完整的 P100S 多圈绝对位置移动设置案例**，涵盖了从基础通讯配置、控制模式设定、电子齿轮比设置、DI/DO功能配置，到触发位置移动全过程，便于你一步步测试或部署。

------

## ✅ 步骤一：基础通信配置

通过上位机建立 MODBUS 通讯：

| 参数地址 | 参数名     | 设置值          | 说明                                     |
| -------- | ---------- | --------------- | ---------------------------------------- |
| `PA71`   | 从机地址   | `4`             | 可自定义，主站需与之通讯匹配             |
| `PA72`   | 通讯波特率 | `96`×100 = 9600 | 与主站设置一致                           |
| `PA73`   | 协议类型   | `0`             | 8位数据位，**无奇偶校验**，**2位停止位** |

------

## ✅ 步骤二：控制模式设置

设置为位置控制模式 + 多圈编码器：

| 参数地址 | 参数名       | 设置值 | 说明                           |
| -------- | ------------ | ------ | ------------------------------ |
| `PA4`    | 控制模式     | `3`    | 位置/速度复合控制              |
| `P4-0`   | 内部位置模式 | `0`    | 绝对式位置控制（编码器坐标）   |
| `PA62`   | 编码器类型   | `5`    | 多圈绝对值编码器，断电记忆位置 |

------

## ✅ 步骤三：电子齿轮比配置

确保位置单位正确映射到电机圈数与细分脉冲：

| 参数地址                     | 参数名           | 设置值 | 说明                               |
| ---------------------------- | ---------------- | ------ | ---------------------------------- |
| ~~`PA95`（默认参数不修改）~~ | 编码器分辨率指数 | `17`   | 表示每圈 2¹⁷ = 131072 脉冲         |
| `PA11`                       | 指令脉冲数/圈    | `0`    | 由齿轮比 PA12 / PA13 决定          |
| `PA12`                       | 齿轮比分子       | `8192` | = 131072 / 16                      |
| `PA13`                       | 齿轮比分母       | `675`  | = 10800 / 16，示例匹配电子齿轮配置 |

------

## ✅ 步骤四：虚拟输入（DI）控制配置

启用混合输入模式，配置位置触发等逻辑：

| 参数地址 | 参数名        | 设置值 | 说明                                     |
| -------- | ------------- | ------ | ---------------------------------------- |
| `P3-30`  | 输入模式选择  | `2`    | 混合输入：支持物理 DI 与虚拟 DI 同时使用 |
| `P3-38`  | 虚拟 DI1 功能 | `28`   | CTRG：触发内部位置命令（核心启动信号）   |
| `P3-39`  | 虚拟 DI2 功能 | `16`   | CMODE：混合控制模式切换                  |
| `P3-42`  | 虚拟 DI5 功能 | `27`   | HOLD：中止位置移动（紧急停止）           |

> ⚠️ 控制触发时通过 `P3-31` 位图控制 DI1~DI8 的电平，上升沿0→1 = 有效。

------

## ✅ 步骤五：输出端口（DO）配置

设定 DO 输出信号，方便监控定位状态与报警状态：

| 参数地址 | 参数名       | 设置值 | 说明                           |
| -------- | ------------ | ------ | ------------------------------ |
| `P3-20`  | DO1 输出功能 | `5`    | COIN：定位完成（误差小于PA16） |
| `P3-23`  | DO4 输出功能 | `3`    | ALM：报警                      |

------

## ✅ 步骤六：位置移动速度与目标位置设置

设置运动速度及目标绝对位置（圈数 + 圈内位置）：

| 参数地址 | 参数名                      | 设置值（示例） | 说明                           |
| -------- | --------------------------- | -------------- | ------------------------------ |
| `P4-4`   | 内部位置速度（0-5000r/min） | `600`          | 实际速度依据机械结构设定       |
| `P4-2`   | 目标圈数(30000- 30000)      | `3`            | 多圈绝对位置的圈数部分         |
| `P4-3`   | 圈内脉冲(±~~电机~~分辨率)   | `32768`        | 一圈 = 131072 脉冲，可设置细分 |

P4-2 和 P4-3 可设置正负值，P4-4 只能为正值。

电机每旋转 1 圈的指令脉冲数 = 10000的时候，P4-2 设置为 2， P4-3 设置为-5000。电机实际位置=2*10000-5000=15000。

这里 P4-2 和 P4-3 对应的是**指令脉冲数**。

------

## ✅ 步骤七：伺服使能与准备

通电准备就绪：

| 参数地址 | 参数名   | 设置值 | 说明           |
| -------- | -------- | ------ | -------------- |
| `PA53`   | 伺服使能 | `1`    | 通电并准备执行 |

------

## ✅ 步骤八：触发移动命令

通过控制虚拟输入位图（P3-31 = 0x011F ），实现如下操作：

| 步骤 |           操作           |       虚拟 DI        |
| :--: | :----------------------: | :------------------: |
|  1   |       清零触发信号       |   0x011F = 0x0000    |
|  2   |        制造上升沿        |   0x011F = 0x0001    |
|  ✅   | 成功触发内部位置控制移动 | 自动前往设定绝对位置 |

说明：

- bit0 控制 DI1（CTRG）；这是因为`PA59`代表的**指令脉冲有效沿**默认是以脉冲上升沿有效的。
- 写入后，伺服开始从当前位置移动到 `P4-2` + `P4-3` 所设定的多圈绝对目标位置。

------

## ✅ 步骤九：检测定位完成状态

轮询读取 `0x1010` 状态寄存器：

- `bit0 = 1` → DO1 输出高电平，定位完成（COIN）
- `bit3 = 0` → DO4 报警输出低电平，说明无故障

也可直接读取 DO 寄存器输出位状态确认。

------

## ✅ 步骤十：异常停止处理

如需中途停止或遇故障，可触发：

- 将 `P3-31 bit4 = 0`（控制 DI9=HOLD），立即中止内部位置控制
- 监控 `0x1010 bit3 = 0`，若为0表示 DO4 报警，需检查伺服状态码

------

## ✅ 示例效果

假设：

- 当前电机停在位置 = 0
- 设置目标圈数 = 3，圈内位置 = 32768（25% 圈）
- 电机将在**顺时针方向**移动 3.25 圈，到达新的绝对位置，并在误差范围内稳定停止
- `0x1010 bit0 == 1` 表示定位成功

------

# 观测方法

现在就是观察下，当前已有的P100S位置移动的DI配置以及DO是否符合上面的逻辑。

已知电机的监控面板`Dp`下，存在能够查看DI和DO状态的值：

- P-In：输入端子
- P-Out：输出端子
