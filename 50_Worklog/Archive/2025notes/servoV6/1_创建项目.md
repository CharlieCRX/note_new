# é¡¹ç›®åˆ›å»º

è¿™é‡Œè®°å½•ä¸‹è‡ªå·±åˆ›å»ºQt6çš„QtQuickç¨‹åºservoV6æ—¶å€™è¸©åˆ°çš„å‘ã€‚

```bash
.
â”œâ”€â”€ app/                # Qt åº”ç”¨ç¨‹åºå…¥å£å’Œç•Œé¢å±‚
â”‚   â”œâ”€â”€ main.cpp        # åº”ç”¨ä¸»å…¥å£
â”‚   â””â”€â”€ qml/            # Qt Quick ç•Œé¢æ–‡ä»¶ï¼ˆQMLï¼‰
â”‚       â””â”€â”€ Main.qml
â”‚
â”œâ”€â”€ core/               # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ä¸æŠ½è±¡æ¥å£
â”‚   â”œâ”€â”€ IMotor.h                 # ç”µæœºæ¥å£æŠ½è±¡
â”‚   â”œâ”€â”€ MovementCommand.h/.cpp   # è¿åŠ¨å‘½ä»¤ç»“æ„ä½“åŠåºåˆ—åŒ–
â”‚   â”œâ”€â”€ BusinessLogic.h/.cpp     # ä¸šåŠ¡é€»è¾‘è°ƒåº¦å±‚ï¼ˆä¸šåŠ¡æµç¨‹å®ç°ï¼‰
â”‚   â”œâ”€â”€ Motor.h/.cpp             # ç”µæœºæ§åˆ¶æŠ½è±¡å±‚ï¼Œè°ƒç”¨é€‚é…å™¨æ¥å£
â”‚   â””â”€â”€ IServoAdapter.h          # ç”µæœºé©±åŠ¨é€‚é…å™¨æ¥å£å®šä¹‰
â”‚
â”œâ”€â”€ drivers/            # è®¾å¤‡é©±åŠ¨å®ç°å±‚ï¼ˆä¸åŒå‹å·ç”µæœºé€‚é…å™¨ï¼‰
â”‚   â”œâ”€â”€ ServoAdapterA.h/.cpp     # å‹å·Aç”µæœºé€‚é…å™¨å®ç°
â”‚   â”œâ”€â”€ ServoAdapterB.h/.cpp     # å‹å·Bç”µæœºé€‚é…å™¨å®ç°
â”‚   â””â”€â”€ RegisterAccessor.h/.cpp  # å¯„å­˜å™¨è¯»å†™å°è£…å±‚
â”‚
â”œâ”€â”€ transport/          # é€šè®¯åè®®å®ç°å±‚ï¼ˆModbusã€è“ç‰™ç­‰ï¼‰
â”‚   â”œâ”€â”€ ICommInterface.h           # é€šè®¯æ¥å£æŠ½è±¡ï¼ˆå‘é€/æ¥æ”¶ï¼‰
â”‚   â””â”€â”€ ModbusClient.h/.cpp        # Modbusåè®®å…·ä½“å®ç°
â”‚
â”œâ”€â”€ tests/              # å•å…ƒæµ‹è¯•æ¨¡å—
â”‚   â”œâ”€â”€ test_businesslogic.cpp     # ä¸šåŠ¡é€»è¾‘æµ‹è¯•
â”‚   â”œâ”€â”€ test_motor.cpp             # ç”µæœºå±‚æµ‹è¯•
â”‚   â”œâ”€â”€ test_adapter.cpp           # é€‚é…å™¨å±‚æµ‹è¯•
â”‚   â””â”€â”€ CMakeLists.txt             # æµ‹è¯•æ„å»ºé…ç½®
â”‚
â””â”€â”€ CMakeLists.txt      # é¡¹ç›®æ ¹CMakeæ„å»ºæ–‡ä»¶

```

## åŠ å…¥å­ç›®å½•

ç°åœ¨åˆ›å»ºå®Œæ¯•åï¼Œé¦–å…ˆè¦åŠ å…¥ç›®å½•`core`ã€‚ä½†æ˜¯æˆ‘åœ¨ç›¸åº”ç›®å½•ä¸‹ï¼Œåˆ›å»ºäº†`core`ç›®å½•åï¼Œå¹¶ä¸èƒ½åŠ å…¥åˆ°Qté¡¹ç›®ä¸­æ¥ï¼Œæˆ‘éœ€è¦æ€ä¹ˆåšï¼Ÿ

ä»¥ä¸‹æ˜¯ä¸ºä½ çš„ Qt6 QtQuick é¡¹ç›® `servoV6` é…ç½®çš„ä¸€å¥— **æ¨¡å—åŒ– CMake é¡¹ç›®ç»“æ„**ï¼ŒåŒ…å«æ¯ä¸ªç›®å½•ä¸‹æ¨èçš„ `CMakeLists.txt` å†™æ³•ï¼Œ**ç»“æ„æ¸…æ™°ã€æ‰©å±•æ–¹ä¾¿ã€é€‚é… Qt Creatorã€æ”¯æŒæµ‹è¯•æ¨¡å—**ã€‚

------

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„ï¼ˆå«è¯´æ˜ï¼‰

```
servoV6/
â”œâ”€â”€ CMakeLists.txt               â† ä¸»æ„å»ºå…¥å£
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.cpp                 â† QtQuick ä¸»å…¥å£
â”‚   â””â”€â”€ qml/
â”‚       â””â”€â”€ Main.qml            â† QML UI æ–‡ä»¶
â”‚   â””â”€â”€ CMakeLists.txt          â† app æ¨¡å—æ„å»ºè„šæœ¬
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ *.h/.cpp                â† ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘
â”‚   â””â”€â”€ CMakeLists.txt
â”œâ”€â”€ drivers/
â”‚   â”œâ”€â”€ *.h/.cpp                â† é©±åŠ¨æŠ½è±¡å®ç°
â”‚   â””â”€â”€ CMakeLists.txt
â”œâ”€â”€ transport/
â”‚   â”œâ”€â”€ *.h/.cpp                â† é€šä¿¡å®ç°
â”‚   â””â”€â”€ CMakeLists.txt
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ *.cpp                   â† å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ CMakeLists.txt
```

------

## ğŸ”§ é¡¶å±‚ `CMakeLists.txt`

```cmake
cmake_minimum_required(VERSION 3.18)
project(servoV6 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# å¯ç”¨ Qt Quick å’Œ Qt Test
find_package(Qt6 REQUIRED COMPONENTS Core Quick Gui Test)

# æ·»åŠ å­æ¨¡å—
add_subdirectory(app)
add_subdirectory(core)
add_subdirectory(drivers)
add_subdirectory(transport)
add_subdirectory(tests)
```

------

## ğŸ”§ `app/CMakeLists.txt`

```cmake
qt_add_executable(servoV6
    main.cpp
)

# åŠ è½½ QML æ–‡ä»¶ï¼ˆå¯é€‰ï¼šç”¨äºéƒ¨ç½²ï¼‰
qt_add_qml_module(servoV6
    URI ServoApp
    VERSION 1.0
    QML_FILES
        qml/Main.qml
)

target_link_libraries(servoV6
    PRIVATE
        Qt6::Core
        Qt6::Quick
        Qt6::Gui
        corelib
        driverslib
        transportlib
)
```

------

## ğŸ”§ `core/CMakeLists.txt`

```cmake
add_library(corelib
    MovementCommand.cpp
    BusinessLogic.cpp
    Motor.cpp
)

target_include_directories(corelib PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})
```

------

## ğŸ”§ `drivers/CMakeLists.txt`

```cmake
add_library(driverslib
    ModbusServoAdapter.cpp
    BluetoothServoAdapter.cpp
)

target_include_directories(driverslib PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})
```

------

## ğŸ”§ `transport/CMakeLists.txt`

```cmake
add_library(transportlib
    ModbusClient.cpp
)

target_include_directories(transportlib PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})
```

------

## ğŸ”§ `tests/CMakeLists.txt`

```cmake
enable_testing()

add_executable(tests
    test_businesslogic.cpp
    test_motor.cpp
    test_adapter.cpp
    main.cpp
)

target_link_libraries(tests
    PRIVATE
        Qt6::Test
        corelib
        driverslib
        transportlib
)

add_test(NAME RunUnitTests COMMAND tests)
```

------

## âœ… å…¶ä»–è¯´æ˜

| é¡¹ç›®éœ€æ±‚        | è§£å†³æ–¹æ³•                                                     |
| --------------- | ------------------------------------------------------------ |
| **é¡¹ç›®æ ‘æ¸…æ™°**  | æ¯ä¸ªæ¨¡å—åˆ†ç›®å½•ç®¡ç†                                           |
| **IDEå¯è§æ€§å¼º** | `target_sources()` æ˜¾å¼åˆ—å‡ºæºæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰æˆ–åˆ‡æ¢ Qt Creator åˆ°â€œæ–‡ä»¶ç³»ç»Ÿâ€è§†å›¾ |
| **æµ‹è¯•é›†æˆ**    | ä½¿ç”¨ Qt Test + `enable_testing()`                            |
| **æ¨¡å—è§£è€¦**    | æ¯ä¸ªæ¨¡å—éƒ½ `add_library()`ï¼Œç”± `servoV6` ä¸»ç¨‹åºé“¾æ¥          |

------

å¹¶ä¸”åœ¨testä¸­è¦åŠ å…¥`main.cpp`ï¼Œå¦åˆ™ä¼šå‡ºç°ç¼–è¯‘æŠ¥é”™ã€‚

# GoogleTest

## åŸºç¡€è®¾æ–½

ç°åœ¨ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ã€‚é¡¹ç›®ä¸­å­˜åœ¨è¿™äº›æƒ…å†µæ—¶ï¼Œ**æ¨èä½¿ç”¨ GTest**ï¼š

- æœ‰å¤§é‡ **çº¯ C++ æ ¸å¿ƒé€»è¾‘**ï¼ˆå¦‚ `BusinessLogic`ã€`MovementCommand` ç­‰ï¼‰
- å­˜åœ¨æŠ½è±¡æ¥å£å’Œ **Mockæµ‹è¯•éœ€æ±‚**ï¼ˆå¦‚ `IServoAdapter`ã€`IMotorInterface`ï¼‰
- å¸Œæœ›ä½¿ç”¨ TDD / CI è‡ªåŠ¨åŒ–æµ‹è¯•
- å¸Œæœ›æµ‹è¯•ä»£ç æ¸…æ™°å¯ç»´æŠ¤ï¼Œæ”¯æŒç»“æ„åŒ–ã€æ¨¡å—åŒ–æµ‹è¯•ã€‚

å½“å‰çš„é¡¹ç›®ä¸­åŒ…å«å¤§é‡çš„ `core/`ã€`drivers/` å±‚ã€æŠ½è±¡æ¥å£ã€ç»„åˆé€»è¾‘ï¼Œ**GoogleTest æ˜¯éå¸¸é€‚åˆçš„é€‰æ‹©**ã€‚

æ‰€ä»¥éœ€è¦å°†GoogleTest ä½œä¸ºservoV6çš„æµ‹è¯•æ¡†æ¶ã€‚

### é›†æˆGoogleTest

åœ¨[GoogleTestæ„å»ºæ‰‹å†Œ](https://github.com/google/googletest/tree/main/googletest#generic-build-instructions)ä¸­ï¼Œé€šè¿‡ `FetchContent` åœ¨æ„å»ºæ—¶è‡ªåŠ¨é›†æˆï¼Œè¿™æ˜¯ä¸€ç§ âœ…**æ¨èã€ç°ä»£ã€æœ€ç®€æ´** çš„åšæ³•ã€‚è¿™ä¸ªæ–¹æ³•è®©ä½ æ— éœ€æ‰‹åŠ¨ä¸‹è½½ï¼Œä¹Ÿé¿å…äº† debug/releaseã€CMake å·¥å…·é“¾ä¸ä¸€è‡´ç­‰é—®é¢˜ï¼Œéå¸¸é€‚åˆä½ å½“å‰çš„ç»“æ„ã€‚

------

## âœ… æ¨èçš„é›†æˆæ–¹å¼ï¼ˆä½¿ç”¨ `FetchContent`ï¼‰

ä½ ç°åœ¨çš„é¡¹ç›®ç»“æ„ä¸­ï¼Œæµ‹è¯•æ¨¡å—å·²ç»ç‹¬ç«‹äº `tests/` ç›®å½•ä¸­ï¼Œéå¸¸é€‚åˆç›´æ¥é€šè¿‡ `FetchContent` ä¸‹è½½ GTest å¹¶ç¼–è¯‘ã€‚

### ğŸ”§ æ­¥éª¤å¦‚ä¸‹ï¼š

------

### **1. ä¿®æ”¹é¡¹ç›®æ ¹ç›®å½•çš„ `CMakeLists.txt`**

```cmake
cmake_minimum_required(VERSION 3.14)  # FetchContent éœ€è¦è‡³å°‘ 3.14

# Qt å’Œä½ å·²æœ‰è®¾ç½®...
project(servoV6 LANGUAGES CXX)

# ...ï¼ˆä½ çš„ Qt è®¾ç½®éƒ¨åˆ†ï¼‰...

# === æ·»åŠ  GoogleTest ===
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

enable_testing()
```

------

### **2. ä¿®æ”¹ `tests/CMakeLists.txt`**ï¼ˆä½ å·²æœ‰è¯¥æ–‡ä»¶ï¼‰

```cmake
# tests/CMakeLists.txt

# æ·»åŠ ä½ çš„æµ‹è¯•ç›®æ ‡
add_executable(test_businesslogic test_businesslogic.cpp)
target_link_libraries(test_businesslogic PRIVATE gtest_main corelib)

add_executable(test_motor test_motor.cpp)
target_link_libraries(test_motor PRIVATE gtest_main corelib driverslib)

add_executable(test_adapter test_adapter.cpp)
target_link_libraries(test_adapter PRIVATE gtest_main driverslib transportlib)

# å¯é€‰ï¼šæ³¨å†Œæµ‹è¯•
include(GoogleTest)
gtest_discover_tests(test_businesslogic)
gtest_discover_tests(test_motor)
gtest_discover_tests(test_adapter)
```

------

### **3. ä¿®æ”¹ä½ çš„æ ¹ CMake æ–‡ä»¶ï¼ŒåŒ…å« `tests/CMakeLists.txt`**

```cmake
add_subdirectory(tests)
```

------

### âœ… ä½ çš„æ•´ä½“ç»“æ„åº”è¯¥æ˜¯ï¼š

```
.
â”œâ”€â”€ CMakeLists.txt             # åŒ…å« FetchContent å’Œ add_subdirectory(tests)
â”œâ”€â”€ core/
â”œâ”€â”€ drivers/
â”œâ”€â”€ transport/
â”œâ”€â”€ app/
â””â”€â”€ tests/
    â”œâ”€â”€ CMakeLists.txt         # æ·»åŠ  gtest æµ‹è¯•ç›®æ ‡
    â”œâ”€â”€ test_motor.cpp
    â””â”€â”€ ...
```

------

## ğŸ§ª ç¤ºä¾‹æµ‹è¯•ä»£ç ï¼ˆtests/test_motor.cppï¼‰

```cpp
#include <gtest/gtest.h>
#include "Motor.h"

TEST(MotorTest, InitWithDefaults) {
    Motor motor;
    EXPECT_FALSE(motor.isRunning());
}
```

------

## ğŸ’¡ ä¼˜ç‚¹æ€»ç»“

| ä¼˜ç‚¹                                                    | è¯´æ˜ |
| ------------------------------------------------------- | ---- |
| âœ… è‡ªåŠ¨ä¸‹è½½ï¼Œæ— éœ€ git submodule æˆ–æ‰‹åŠ¨æ‹·è´               |      |
| âœ… Windows ä¸Šè‡ªåŠ¨åŒ¹é… MSVC/MinGW æ„å»ºå‚æ•°ï¼Œé¿å… CRT å†²çª |      |
| âœ… æ–¹ä¾¿ CIï¼ˆè‡ªåŠ¨ä¸‹è½½ã€æ— é¢å¤–ä¾èµ–ï¼‰                       |      |
| âœ… æ¸…æ™°çš„æµ‹è¯•ç»„ç»‡ï¼ˆæ¯ä¸ªæµ‹è¯•æ–‡ä»¶å¯¹åº”ä¸€ä¸ªæµ‹è¯•ç¨‹åºï¼‰        |      |
| âœ… å’Œ `enable_testing()`ã€CTest/GTest åŸç”Ÿå…¼å®¹           |      |

------

## ğŸ“Œ ä¾èµ–ç‰ˆæœ¬è¯´æ˜ï¼ˆå¯é€‰ï¼‰

ä½ ä½¿ç”¨çš„æ˜¯ï¼š

```cmake
URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
```

è¿™æ˜¯ 2024 å¹´ä¸­æœŸç¨³å®šç‰ˆï¼Œå¯ä»¥ï¼Œä½†ä½ ä¹Ÿå¯ä»¥æ”¹ä¸ºï¼š

```cmake
GIT_REPOSITORY https://github.com/google/googletest.git
GIT_TAG release-1.14.0
```

------

## â—æ³¨æ„äº‹é¡¹

- ç¡®ä¿ CMake â‰¥ 3.14ã€‚
- å¦‚æœ Qt é¡¹ç›®ä½¿ç”¨è¾ƒæ—§ç‰ˆæœ¬ CMakeï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ `FetchContent`ã€‚
- å¯¹äºéæµ‹è¯•ç›®æ ‡ï¼ˆä¸»ç¨‹åºï¼‰æ— éœ€é“¾æ¥ `gtest`ã€‚

------



