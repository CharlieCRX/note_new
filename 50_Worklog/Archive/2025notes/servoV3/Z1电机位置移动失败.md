## 电机旋转并未到位

日志

```bash
// 从 -90 回正到 0
2025-05-21T20:29:18.240 "收到请求(127.0.0.1:62459):" "{\n    \"cmd\": 0,\n    \"motor\": 4,\n    \"target\": 0\n}\n" 
2025-05-21T20:29:18.307 "目标：0，当前：-90.6487" 
2025-05-21T20:29:18.500 "电机θ读取点动速度成功，RPM=8" 
2025-05-21T20:29:18.560 "电机θ读取速度成功，RPM=8" 
2025-05-21T20:29:18.560 offset angle  90.6487 
2025-05-21T20:29:18.626 "角度0,  pulse 0" 
2025-05-21T20:29:18.626 target angle  0.000267029  target pulse  0 
2025-05-21T20:29:18.701 "电机4写入成功,16(514,0)" 
2025-05-21T20:29:18.771 "电机4写入成功,16(515,0)" 
2025-05-21T20:29:18.841 "电机4写入成功,16(53,1)" 
2025-05-21T20:29:18.901 "电机4写入成功,16(287,0)" 
2025-05-21T20:29:18.901 "电机θ预启动配置完成" 
2025-05-21T20:29:18.961 "电机4写入成功,16(287,1)" 
2025-05-21T20:29:18.961 "电机θ已使能" 
2025-05-21T20:29:18.961 "行车运动状态检查线程启动" 


2025-05-21T20:29:19.197 发送角度更新: "{"cmd": 2, "curr": -89.76200103759766, "motor": 4, "result": 1}" 
2025-05-21T20:29:19.507 发送角度更新: "{"cmd": 2, "curr": -88.34100341796875, "motor": 4, "result": 1}" 
2025-05-21T20:29:19.807 发送角度更新: "{"cmd": 2, "curr": -86.93399810791016, "motor": 4, "result": 1}" 
2025-05-21T20:29:20.107 发送角度更新: "{"cmd": 2, "curr": -85.66999816894531, "motor": 4, "result": 1}" 
2025-05-21T20:29:20.416 发送角度更新: "{"cmd": 2, "curr": -84.22000122070312, "motor": 4, "result": 1}" 
2025-05-21T20:29:20.717 发送角度更新: "{"cmd": 2, "curr": -82.81999969482422, "motor": 4, "result": 1}" 
2025-05-21T20:29:21.017 发送角度更新: "{"cmd": 2, "curr": -81.64099884033203, "motor": 4, "result": 1}" 
2025-05-21T20:29:21.327 发送角度更新: "{"cmd": 2, "curr": -80.16000366210938, "motor": 4, "result": 1}" 
2025-05-21T20:29:21.560 "行车(电机θ)已到位"
2025-05-21T20:29:21.631 "电机4写入成功,16(53,0)" 
2025-05-21T20:29:21.697 发送角度更新: "{\n    \"cmd\": 2,\n    \"curr\": -78.58200073242188,\n    \"motor\": 4,\n    \"result\": 1\n}\n" 
2025-05-21T20:29:21.760 "行车运行结束.result=1" 
2025-05-21T20:29:21.760 "行车已到位!" 
2025-05-21T20:29:21.760 "行车检查线程正常退出" 
2025-05-21T20:29:21.827 发送回应: "{\n    \"cmd\": 0,\n    \"curr\": -78.57916259765625,\n    \"motor\": 4,\n    \"result\": 1,\n    \"target\": 0\n}\n" 
```

旋转电机已经接收到从-90旋转到0度的命令。但是在位置移动中，移动到-78就正常停止了。

### 问题分析

怀疑是检测旋转电机是否位置移动成功的逻辑存在问题。

既然电机实际位置并没有达到目标位置但是又提示位置移动成功，那我们看下旋转电机是怎么检测位置移动成功的。

在位置移动到`-80.16`角度的时候，系统提示

```bash
INFO  2025-05-21T20:29:21.560 "行车(电机θ)已到位"
```

证明此时槽函数`on_workDone()`已经执行完毕。而调用此槽函数的位置结束信号为

```CPP
connect(this, &MotorCtrl::em_workDone, this, &MotorCtrl::on_workDone);
```

顺着信号`em_workDone()`，我们可以看到在函数`checkMove()`中检测位置移动成功并且返回行车运动成功的逻辑

```Cpp
// 判断电机是否完成位置移动
if (i == M_Y2) {
    ret = checkPositionMoveSuccess(M_Y2, tmp);
} else {
    ret = m_motorRegs->readReg16(i, MotorRegs::S16, tmp);
}
if(ret){
    if(tmp&0x1){
        m_needCheck[i] = false;
        // 电机伺服断开
        if (i == M_Y2) {
            setPositionRunEnable(M_Y2, false);
            setServoEnable(M_Y2, false);
        }
        emit em_workDone(i);
    }else{
        isCheckDone = false;
    }
```

旋转电机型号是`M_Angle`，是`P100S`的伺服电机型号。所以使用

```Cpp
ret = m_motorRegs->readReg16(i, MotorRegs::S16, tmp);
```

检测电机是否完成位置移动。

### 手册提示

现在看下检测电机是否完成位置移动的逻辑

```CPP
ret = m_motorRegs->readReg16(i, MotorRegs::S16, tmp);
```

寄存器`S16`是型号为`P100S`的控制寄存器：

```
S16  = 0x1010,  //DO状态
```

我们看下此型号的电机手册中，对于该寄存器`S16`的描述。

经过不懈努力😥，终于在`伺服驱动器通讯功能的说明及使用.pdf`中，找到了`0x1010`的描述

```text
1010H:  显示输出端子状态
```

那么这个输出端子状态寄存器为什么能检测电机位置移动成功呢？

### P100s位置移动参数

带着问题，来到`p100s.pdf`。

在5.1节 位置模式说明中，当电机定位完成的时候，会通过COIN输出给上位机。COIN，是伺服驱动器与控制器之间的一种信号交互方式，用于确认运动指令是否已正确执行。

那么根据代码的理解，当伺服电机到达目标位置后，驱动器会拉高 `COIN` 信号，通知控制器“定位完成”。

但是现在存在的问题是，目标位置并没有到达，但是`COIN`信号依旧返回了高信号`1`。这样就会导致代码误判电机已经位置成功，从而产生了这个问题。

如果想证明

> 目标位置并没有到达，但是`COIN`信号依旧返回了高信号`1`

可以在检测`COIN`信号的同时，获取当前电机的绝对值脉冲数`currentPulse`和目标位置脉冲`targetPulse`数进行比较。如果产生了此场景：

- `COIN`信号为`1`：电机自己认为已经位置移动成功
- `currentPulse != targetPulse`：证明实际电机并未移动完成

那么就可以验证`COIN`产生了错误的高电平信号，从而导致了行车位置移动错误问题。

### COIN出错

根据Deepseek对于

> 场景目标位置并没有到达，但是`COIN`信号依旧返回了高信号`1`是否存在

的回答，有一个可能的因素会导致这个场景错误：

> #### **伺服系统动态性能不足**
>
> - **跟随误差（Following Error）过大**
>   - 如果伺服系统的刚性不足（如增益太低、负载惯性大），电机可能无法快速跟踪指令位置，但驱动器仍可能错误触发 `COIN`。
>   - **解决方法**：
>     1. 检查伺服驱动器的 **位置误差（Pn300/Pn202）** 实际值（通过调试软件或面板）。
>     2. 调整 **PID 增益参数**（提高位置环比例增益 `Kp`）。
>     3. 检查机械负载是否过重或存在卡滞。