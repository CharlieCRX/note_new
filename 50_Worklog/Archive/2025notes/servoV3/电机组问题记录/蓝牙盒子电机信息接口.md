## 1一、文档概述

本文档定义了上位机与 ESP32 电机控制器之间的 **Modbus RTU 通信协议**，
 用于设备参数与电机参数的读写与持久化。
 系统支持通过 **RS485 或蓝牙串口** 进行通信。

⚙️ **主要功能命令共 4 个：**

1. 写入设备整体配置（Write Device Config）
2. 读取设备整体配置（Read Device Config）
3. 写入单个电机完整配置（Write Motor Config）
4. 读取单个电机完整配置（Read Motor Config）

> ⚠️ 所有读写操作均以 **整块结构体为单位**，
>  不支持对单个字段（如 `char name[8]`）进行独立写入或读取。

------

## 二、通信基础

| 参数     | 说明         |
| -------- | ------------ |
| 协议     | Modbus RTU   |
| 波特率   | 9600 bps     |
| 数据位   | 8            |
| 停止位   | 2            |
| 校验位   | 无           |
| 从机地址 | 0xFF（广播） |

------

## 三、支持功能码

| 功能码 | 说明                             |
| ------ | -------------------------------- |
| `0x03` | 读保持寄存器（用于读取配置）     |
| `0x10` | 写多个寄存器（用于写入整块配置） |

------

## 四、寄存器映射

### 1. 设备配置区（基地址 0x0020 ）

| 地址范围  | 名称     | 类型     | 寄存器数 | 说明                        |
| --------- | -------- | -------- | -------- | --------------------------- |
| 0x40-0x4F | 设备名称 | char[32] | 16       | 设备名称（UTF-8，自动补零） |
| 0x50      | 配置版本 | uint32   | 2        | 当前配置结构体版本号        |
| 0x52      | 电机数量 | uint16   | 1        | 已启用的电机数量            |
| 0x53      | 系统状态 | uint16   | 1        | 系统运行状态                |
| 0x54-0x5F | 保留     | -        | 12       | 未来扩展                    |

每个设备配置块固定长度为：120字节，60寄存器

------

### 2. 电机配置区

每个电机的基地址计算方式：

```
电机基地址 = 0x0064 + 电机ID × 108
```

| 偏移 | 字段                 | 类型     | 寄存器数 | 说明                  |
| ---- | -------------------- | -------- | -------- | --------------------- |
| 0x00 | id                   | short    | 1        | 电机编号              |
| 0x02 | name                 | char[8]  | 4        | 电机名称              |
| 0x0A | model                | char[64] | 32       | 电机型号              |
| 0x4A | modbusID             | short    | 1        | 电机从机地址          |
| 0x4C | groupID              | short    | 1        | 电机分组ID            |
| 0x4E | gearRatio            | short    | 1        | 齿轮传动比            |
| 0x50 | outsideDiameter      | float    | 2        | 外径(mm)              |
| 0x54 | screwPitch           | short    | 1        | 丝杆螺距(mm)          |
| 0x56 | clickDistance        | float    | 2        | 点动距离              |
| 0x5A | dir                  | short    | 1        | 方向(1正 -1反)        |
| 0x5C | isEnable             | short    | 1        | 是否启用(1启用 0禁用) |
| 0x5E | maxLimit             | short    | 1        | 最大限位              |
| 0x60 | minLimit             | short    | 1        | 最小限位              |
| 0x62 | specialLimit         | short    | 1        | 特殊限位起始值        |
| 0x64 | specialStop          | short    | 1        | 特殊限位结束值        |
| 0x66 | relativeZeroPosition | float    | 2        | 相对零点的绝对位置    |
| 0x6A | version              | short    | 1        | 结构体版本号          |

------

## 五、命令接口定义

### 1️⃣ 读取设备整体配置（功能码 0x03）

**请求帧：**

```
[地址]  [0x03]  [起始高]  [起始低] [数量高] [数量低] [CRC_L] [CRC_H]
 0xFF  	0x03    0x00     0x40    0x00    0x20         CRC
```

**响应帧：**

```
[地址] [0x03] [字节数] [设备配置数据] [CRC_L] [CRC_H]
```

> ⚙️ 返回内容即 `设备配置结构体` 的序列化结果（含名称、版本、数量、状态等）。

------

### 2️⃣ 写入设备整体配置（功能码 0x10）

**请求帧：**

```
[地址] [0x10] [起始高] [起始低] [数量高] [数量低] [字节数] [配置数据] [CRC_L] [CRC_H]
0xFF  0x10   0x00      0x40      0x00      0x20       0x40       ...数据...  CRC
```

**响应帧：**

```
[地址] [0x10] [起始高] [起始低] [数量高] [数量低] [CRC_L] [CRC_H]
```

> ⚠️ 写入成功后，系统会自动将配置保存到 Flash（SPIFFS），重启仍保留。

------

### 3️⃣ 读取单个电机配置（功能码 0x03）

**请求帧：**

```
[地址] [0x03] [起始高] [起始低] [数量高] [数量低] [CRC_L] [CRC_H]
例: 读取电机2 → 起始地址 = 0x80 + 2×102 = 0x1B4
{0xFF, 0x03, 0x01, 0xB4, 0x00, 0x66, CRC_L, CRC_H}
```

**响应帧：**

```
[地址] [0x03] [字节数=204] [电机配置块数据] [CRC_L] [CRC_H]
```

> ⚙️ 返回完整 `T_servoMotor_tb` 序列化内容。

------

### 4️⃣ 写入单个电机配置（功能码 0x10）

**请求帧：**

```
[地址] [0x10] [起始高] [起始低] [数量高] [数量低] [字节数] [完整结构体数据] [CRC_L] [CRC_H]
```

例如写入电机ID=1：

```
{0xFF, 0x10, 0x00, 0xE6, 0x00, 0x66, 0xCC, ...结构体数据..., CRC}
```

**响应帧：**

```
[地址] [0x10] [起始高] [起始低] [数量高] [数量低] [CRC]
```

> ⚠️ 单次写入必须覆盖整个电机结构块。
>  不支持仅修改部分字段（如 name、speed 等）。

------

## 六、数据持久化与验证

- 写入操作完成后，控制器自动保存至 **SPIFFS Flash**。
- Flash 文件示例：`/spiffs/motordata.dat`
- 每次启动自动加载电机配置到寄存器。
- 建议写入后立即执行一次读取，验证写入成功。

------

## 七、异常响应（与标准Modbus一致）

| 异常码 | 含义         |
| ------ | ------------ |
| 0x01   | 非法功能码   |
| 0x02   | 非法数据地址 |
| 0x03   | 非法数据值   |
| 0x04   | 从站设备故障 |

------

## 八、使用示例

### 示例1：读取电机0的配置

```c
读命令：
FF 03 00 64 00 36 91 DD 

回复：
FF 03 6C 00 02 00 01 00 08 00 09 00 02 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 02 00 01 00 04 00 03 00 02 00 01 00 05 00 04 00 03 00 02 EF 1F 
```

### 示例2：写入电机2的完整配置

```c
uint8_t req[] = {0xFF, 0x10, 0x01, 0xB4, 0x00, 0x66, 0xCC, ...完整T_servoMotor_tb数据..., CRC_L, CRC_H};
send(req);
```

### 示例3：写入整体设备配置

```c
uint8_t req[] = {0xFF, 0x10, 0x00, 0x40, 0x00, 0x20, 0x40, ...device block..., CRC};
```

------

## 九、注意事项

1. 所有写操作均整块执行，不支持字段级别更新。
2. 写入完成后自动保存至 Flash。
3. Modbus CRC16 校验必须正确，否则数据丢弃。
4. 不允许并发写入多个电机。
5. 上位机应实现写入后读取验证逻辑。