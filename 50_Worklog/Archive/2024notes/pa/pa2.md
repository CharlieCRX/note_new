# PA2 - ç®€å•å¤æ‚çš„æœºå™¨: å†¯è¯ºä¾æ›¼è®¡ç®—æœºç³»ç»Ÿ

- task PA2.1: å®ç°æ›´å¤šçš„æŒ‡ä»¤, åœ¨NEMUä¸­è¿è¡Œå¤§éƒ¨åˆ†`cpu-tests`
- task PA2.2: å®ç°klibå’ŒåŸºç¡€è®¾æ–½
- task PA2.3: è¿è¡ŒFCEUX, æäº¤å®Œæ•´çš„å®éªŒæŠ¥å‘Š

> DDL
>
> PA2.1- 10æœˆ11å·ï¼ˆå·²å®Œæˆé™¤`mul-longlong.c`çš„æ‰€æœ‰æŒ‡ä»¤æµ‹è¯•ï¼‰
>
> PA2.2 - 10æœˆ28å·ï¼ˆå·²å®ŒæˆåŒ…æ‹¬`mul-longlong`åœ¨å†…çš„æ‰€æœ‰æŒ‡ä»¤æµ‹è¯•ï¼‰
>
> PA2.3 - 11æœˆ2å·

> [!NOTE]
>
> ##### çƒ­èº«ç»“æŸ, è¿›å…¥çœŸæ­£çš„PA
>
> åœ¨PA2ç»“æŸä¹‹å, ä½ éœ€è¦åšåˆ°å¯ä»¥ç†è§£NEMUä¸­çš„æ¯ä¸€å¤„ç»†èŠ‚. éšç€ä½ å¯¹è¿™äº›ä»£ç ç»†èŠ‚çš„äº†è§£å˜å¾—æ·±å…¥, å°±ç®—æ˜¯è°ƒbugä½ ä¹Ÿä¼šè§‰å¾—å¤šäº†å‡ åˆ†è½»æ¾. ç›¸å, å¦‚æœä½ ä»ç„¶æŠ±ç€"æµ‹è¯•èƒ½è¿‡å°±è¡Œ", "è¿™é‡Œä¸ç®—åˆ†, å…³æˆ‘Päº‹"çš„å¿ƒæ€, å¾ˆå¿«ä½ å°±ä¼šå‘ç°è¿bugéƒ½ä¸çŸ¥é“æ€ä¹ˆè°ƒäº†.
>
> æ‰€ä»¥, ä¸è¦å†å·æ‡’äº†.

å¥½çš„ï¼Œè°¢è°¢è€å¸ˆï¼Œè¢«å°é»„é¾™æŠ˜ç£¨çš„æˆ‘ï¼ŒæœŸå¾…åœ¨PA2å¾—åˆ°å¯¹åº”çš„è®­ç»ƒã€‚:laughing:

## ä¸åœè®¡ç®—çš„æœºå™¨

ä»‹ç»äº†[YEMUæ‰§è¡ŒæŒ‡ä»¤çš„æµç¨‹](https://nju-projectn.github.io/ics-pa-gitbook/ics2023/2.1.html#yemu-%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84cpu%E6%A8%A1%E6%8B%9F%E5%99%A8)

STFSCåè§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š

- ç”»å‡ºåœ¨YEMUä¸Šæ‰§è¡Œçš„åŠ æ³•ç¨‹åºçš„çŠ¶æ€æœº
- é€šè¿‡RTFSCç†è§£YEMUå¦‚ä½•æ‰§è¡Œä¸€æ¡æŒ‡ä»¤

> 1. ç”»å‡ºåœ¨YEMUä¸Šæ‰§è¡Œçš„åŠ æ³•ç¨‹åºçš„çŠ¶æ€æœº
>
>    ç”¨ä¸€ä¸ªä¸‰å…ƒç»„`(PC, r0, r1)`è¡¨ç¤ºç¨‹åºçš„æ‰€æœ‰çŠ¶æ€ï¼Œç”»å‡ºå…¶çŠ¶æ€è½¬ç§»è¿‡ç¨‹ï¼ˆæ­¤å¤„çš„`x`è¡¨ç¤ºæœªåˆå§‹åŒ–ï¼‰ï¼š
>
>    ```text
>    (0, x, x) -> (1, 33, x) -> (2, 33, 33) -> (3, 16, 33) -> (4, 49, 33)
>    ```
>
>    æœ€ç»ˆç¨‹åºä¼šå°†å¯„å­˜å™¨`r0`ä¿å­˜çš„å€¼å­˜å‚¨åˆ°å¯¹åº”çš„å†…å­˜åœ°å€å¤„ã€‚
>
> 2. é€šè¿‡RTFSCç†è§£YEMUå¦‚ä½•æ‰§è¡Œä¸€æ¡æŒ‡ä»¤
>
>    - å–æŒ‡é˜¶æ®µï¼šä»æ•°ç»„åœ°å€å¯¹åº”çš„ä¸‹æ ‡`pc`ä¸­è¯»å–ä¸€ä¸ªé•¿åº¦ä¸º8çš„æŒ‡ä»¤`this`
>    - è¯‘ç ï¼š
>      - æ“ä½œç ï¼šè®¿é—®æŒ‡ä»¤`this`çš„æ“ä½œç ä½åŸŸ`rtype.op`ï¼Œè·å–å¯¹åº”çš„æ“ä½œç `op`
>      - æ“ä½œæ•°ï¼šæ ¹æ®æŒ‡ä»¤`this`ä¸­çš„æ“ä½œç `op`ï¼Œå¯¹æŒ‡ä»¤çš„å‰©ä½™éƒ¨åˆ†æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åˆ’åˆ†ä¸ºå¯¹åº”çš„æ“ä½œæ•°
>    - æ‰§è¡Œï¼šæ ¹æ®æ“ä½œç å’Œæ“ä½œæ•°ï¼Œåšå¯¹åº”çš„è®¡ç®—
>    - æ›´æ–°`pc`ï¼šå¦‚æœå‰é¢æ‰§è¡ŒæˆåŠŸï¼Œåˆ™æ›´æ–°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€`pc = pc + 1`
>
> 3. ä¸¤è€…çš„è”ç³»æ˜¯ä»€ä¹ˆï¼Ÿ
>
>    YEMUæ‰§è¡ŒæŒ‡ä»¤ï¼Œä¼šæ›´æ–°pcï¼ŒåŒæ—¶å¯èƒ½ä¿®æ”¹å¯„å­˜å™¨çš„å€¼ã€‚çŠ¶æ€æœºå±è”½äº†ç¨‹åºæŒ‡ä»¤æ‰§è¡Œæ—¶çš„ç»†èŠ‚ï¼Œåªä¼šå±•ç¤ºæœ€åæŒ‡ä»¤çš„ç»“æœï¼›è€Œå•ç‹¬æ‰§è¡Œä¸€æ¡æŒ‡ä»¤åˆ™ä¼šå°†TRMçš„æ‰§è¡Œç»†èŠ‚å®Œæ•´å±•ç¤ºå‡ºæ¥ã€‚

## RTFM(2)

ä¸»çº¿ä»»åŠ¡:

- é˜…è¯»ç”Ÿå­˜æ‰‹å†Œä¸­æŒ‡ä»¤é›†ç›¸å…³çš„ç« èŠ‚ï¼Œäº†è§£æŒ‡ä»¤ç¡®åˆ‡çš„è¡Œä¸º

  - æ¯ä¸€æ¡æŒ‡ä»¤å…·ä½“è¡Œä¸ºçš„æè¿°

  - æŒ‡ä»¤opcodeçš„ç¼–ç è¡¨æ ¼

- å¼„æ‡‚`exec_once()`å‡½æ•°çš„æŠ€æœ¯ç»†èŠ‚ï¼šæ•´ç†ä¸€æ¡æŒ‡ä»¤åœ¨NEMUä¸­çš„æ‰§è¡Œè¿‡ç¨‹.

- ç”¨äºè¯‘ç å’Œæ‰§è¡Œä¹‹é—´çš„è§£è€¦çš„`INSTPAT`ï¼Œå…¶å®šä¹‰çš„æ¨¡å¼åŒ¹é…è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿå…¶ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

- å—é™äºæŒ‡ä»¤é•¿åº¦æœ€å¤§32ä½çš„risv32ï¼Œåº”è¯¥å¦‚ä½•è¿›è¡Œè¶…è¿‡32ä½çš„å¸¸æ•°è¯»å–æ“ä½œï¼Ÿ

- PA2ä»»åŠ¡ä¸€ï¼šå®ç°è‹¥å¹²æ¡æŒ‡ä»¤, ä½¿å¾—ç¬¬ä¸€ä¸ªç®€å•çš„Cç¨‹åº`dummy`å¯ä»¥åœ¨NEMUä¸­è¿è¡Œèµ·æ¥. ï¼ˆå¾…å®ç°çš„æŒ‡ä»¤ï¼Œå‚è€ƒå…¶åæ±‡ç¼–ç»“æœ`am-kernels/tests/cpu-tests/build/dummy-$ISA-nemu.txt`ï¼‰

- æ‰§è¡Œæœªå®ç°æŒ‡ä»¤çš„æ—¶å€™, NEMUå…·ä½“ä¼šæ€ä¹ˆåšï¼Ÿ

  ```tex
  invalid opcode(PC = 0x80000000):
          13 04 00 00 17 91 00 00 ...
          00000413 00009117...
  There are two cases which will trigger this unexpected exception:
  1. The instruction at PC = 0x80000000 is not implemented.
  2. Something is implemented incorrectly.
  ```

- å®ç°æ›´å¤šçš„æŒ‡ä»¤ï¼Œé€šè¿‡æµ‹è¯•ç”¨ä¾‹ï¼ˆæš‚åœ`string`å’Œ`hello-str`çš„å®ç°ï¼‰

- AT&Tæ ¼å¼åæ±‡ç¼–ç»“æœä¸­çš„å°‘é‡æŒ‡ä»¤ï¼Œä¸risv32æ‰‹å†Œä¸­åˆ—å‡ºçš„æŒ‡ä»¤åç§°ä¸ç¬¦ï¼Œå¦‚ä½•åœ¨æ‰‹å†Œä¸­æ‰¾åˆ°å¯¹åº”çš„æŒ‡ä»¤ï¼Ÿ

æ”¯çº¿ä»»åŠ¡ï¼š

- åœ¨PAä¸­, riscv32çš„å®¢æˆ·ç¨‹åºåªä¼šç”±RV32Iå’ŒRV32Mä¸¤ç±»æŒ‡ä»¤ç»„æˆã€‚è¿™ä¸¤ç±»æŒ‡ä»¤æ˜¯æ€ä¹ˆå®šä¹‰çš„ï¼Ÿ
-  [è¿™ç¯‡æ–‡ç« ](http://blog.sciencenet.cn/blog-414166-1089206.html)å™è¿°äº†RISC-Vçš„ç†å¿µä»¥åŠæˆé•¿çš„ä¸€äº›å†å²
- ç†è§£NEMUå¦‚ä½•ç”¨æ¨¡å¼åŒ¹é…è§„åˆ™(`nemu/src/isa/$ISA/inst.c`)ï¼Œä½¿å¾—æ–°å¢æŒ‡ä»¤å˜å¾—ç®€å•
- è®©GCCç¼–è¯‘NEMUçš„æ—¶å€™é¡ºä¾¿è¾“å‡ºé¢„å¤„ç†çš„ç»“æœ
- ä¸ºä»€ä¹ˆæ‰§è¡Œäº†æœªå®ç°æŒ‡ä»¤ä¼šå‡ºç°æŠ¥é”™ä¿¡æ¯ï¼Ÿ

è¦æ±‚ï¼š

- è¯·ç”¨clean codeæ¥ç¼–å†™ä»£ç 
- åŠæ—¶æµ‹è¯•ä»£ç 
- åŠæ—¶åšç¬”è®°çš„æ–¹å¼æ¥æ•´ç†ä»£ç ç»†èŠ‚ï¼ˆå¿…é¡»æ»´ï¼‰
- å°½å¯èƒ½åœ°ç†è§£æ¯ä¸€å¤„ç»†èŠ‚

### å–æŒ‡

åœ¨æ‰§è¡ŒæŒ‡ä»¤ä¹‹å‰ï¼Œéœ€è¦è·å–è¿™ä¸ªæŒ‡ä»¤ï¼Œæˆ‘ä»¬çœ‹ä¸‹NEMUå¦‚ä½•è·å–ä¸€æ¡æŒ‡ä»¤çš„ã€‚

`exec_once()`æ¥å—ä¸€ä¸ª`Decode`ç±»å‹çš„ç»“æ„ä½“æŒ‡é’ˆ`s`.è¿™ä¸ªç»“æ„ä½“å­˜æ”¾â€œåœ¨æ‰§è¡Œä¸€æ¡æŒ‡ä»¤è¿‡ç¨‹ä¸­æ‰€éœ€çš„ä¿¡æ¯â€ã€‚

`Decode`ç»“æ„ä½“å®šä¹‰åœ¨`nemu/include/cpu/decode.h`ä¸­

```C
typedef struct Decode {
  vaddr_t pc;
  vaddr_t snpc; // static next pc
  vaddr_t dnpc; // dynamic next pc
  ISADecodeInfo isa;
  IFDEF(CONFIG_ITRACE, char logbuf[128]);
} Decode;
```

è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œé™¤äº†æŒ‡ä»¤çš„åœ°å€ä¿¡æ¯`pc`ã€`snpc`å’Œ`dnpc`ï¼Œè¿˜åŒ…æ‹¬äº†ä¸€ä¸ªä¸ISAç›¸å…³çš„ç»“æ„ä½“æŠ½è±¡`ISADecodeInfo`.

å…¶å…·ä½“çš„å®šä¹‰åœ¨`nemu/src/isa/$ISA/include/isa-def.h`ä¸­

```C
typedef struct {
  union {
    uint32_t val;
  } inst;
} MUXDEF(CONFIG_RV64, riscv64_ISADecodeInfo, riscv32_ISADecodeInfo);
```

è¿™ä¸ª`ISADecodeInfo`ç»“æ„ä½“ä¸­åŒ…å«äº†ä¸€ä¸ªè”åˆä½“`inst`ï¼Œè”åˆä½“ä¸­æœ‰ä¸€ä¸ª`uint32_t`ç±»å‹çš„æˆå‘˜`val`ã€‚ RISC-V 32 ä½æ¶æ„ä¸­ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤çš„é•¿åº¦éƒ½æ˜¯ 32 ä½ï¼Œå› æ­¤è¿™ä¸ª `val` å¯ä»¥ç”¨äºå­˜å‚¨ä¸€æ¡å®Œæ•´çš„æŒ‡ä»¤ã€‚

ç°åœ¨`exec_once()`å‡½æ•°æ¥æ”¶äº†ä¼ å…¥å‚æ•°`s`ï¼Œç„¶åå°†å½“å‰çš„PCä¿å­˜åˆ°`s`çš„æˆå‘˜`pc`å’Œ`snpc`ä¸­ã€‚éšåè°ƒç”¨`isa_exec_once()`è¿›è¡ŒæŒ‡ä»¤çš„æ‰§è¡Œæ“ä½œã€‚

å‡½æ•°`isa_exec_once()`å®šä¹‰åœ¨`nemu/src/isa/riscv32/inst.c`ä¸­

```C
int isa_exec_once(Decode *s) {
  s->isa.inst.val = inst_fetch(&s->snpc, 4);
  return decode_exec(s);
}
```

å› ä¸º`inst.val`æ˜¯ç”¨æ¥å­˜å‚¨ä¸€æ¡å®Œæ•´æŒ‡ä»¤çš„å˜é‡ï¼Œæ‰€ä»¥æ¨æµ‹`inst_fetch()`å‡½æ•°çš„åŠŸèƒ½ï¼Œæ˜¯ç”¨æ¥å–æŒ‡ä»¤çš„ã€‚

ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹å‡½æ•°`inst_fetch()`çš„å®šä¹‰ï¼ˆ`nemu/include/cpu/ifetch.h`ï¼‰

```C
static inline uint32_t inst_fetch(vaddr_t *pc, int len) {
  uint32_t inst = vaddr_ifetch(*pc, len);
  (*pc) += len;
  return inst;
}
```

è€Œå‡½æ•°`vaddr_ifetch()`çš„åŠŸèƒ½å°±æ˜¯é€šè¿‡`pc`æ‰€æŒ‡çš„å®¢æˆ·ç¨‹åºåœ°å€ï¼Œæ‰¾åˆ°å¯¹åº”ç‰©ç†å†…å­˜ä¸­çš„é•¿åº¦ä¸º`len`çš„æ•°æ®ã€‚

å‡½æ•°`isa_exec_once()`å°†`pc->snpc`çš„åœ°å€ä½œä¸ºå‚æ•°ä¼ å…¥åˆ°å‡½æ•°`vaddr_ifetch()`ä¸­ï¼Œæ‰€ä»¥å‡½æ•°`vaddr_ifetch()`å–å®Œæ•°æ®åï¼Œä¼šæ ¹æ®`len`ï¼ˆè¿™é‡Œæ˜¯`4`ï¼‰æ¥æ›´æ–°`s -> snpc`ï¼Œä»è€Œè®©`s -> snpc`æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚

å·²ç»è·å–çš„æŒ‡ä»¤ï¼Œå°†å…¶å­˜æ”¾äºç»“æ„ä½“`s`å…³äºISAä¿¡æ¯çš„`isa`ä¸­ã€‚è‡³æ­¤ï¼Œå–æŒ‡ä»¤æµç¨‹ç»“æŸã€‚

### è¯‘ç 

éšå`s`å¸¦ç€æŒ‡ä»¤çš„ä¿¡æ¯ï¼Œä¼ å…¥åˆ°å‡½æ•°`decode_exec()`å¼€å§‹è¯‘ç ï¼Œå…¶å®šä¹‰åœ¨`nemu/src/isa/riscv32/inst.c`

```C
static int decode_exec(Decode *s) {
  int rd = 0;
  word_t src1 = 0, src2 = 0, imm = 0;
  s->dnpc = s->snpc;

#define INSTPAT_INST(s) ((s)->isa.inst.val)
#define INSTPAT_MATCH(s, name, type, ... /* execute body */ ) { \
  decode_operand(s, &rd, &src1, &src2, &imm, concat(TYPE_, type)); \
  __VA_ARGS__ ; \
}

  INSTPAT_START();
  INSTPAT("??????? ????? ????? ??? ????? 00101 11", auipc  , U, R(rd) = s->pc + imm);
  INSTPAT("??????? ????? ????? 100 ????? 00000 11", lbu    , I, R(rd) = Mr(src1 + imm, 1));
  INSTPAT("??????? ????? ????? 000 ????? 01000 11", sb     , S, Mw(src1 + imm, 1, src2));

  INSTPAT("0000000 00001 00000 000 00000 11100 11", ebreak , N, NEMUTRAP(s->pc, R(10))); // R(10) is $a0
  INSTPAT("??????? ????? ????? ??? ????? ????? ??", inv    , N, INV(s->pc));
  INSTPAT_END();

  R(0) = 0; // reset $zero to 0

  return 0;
}
```

è¯‘ç çš„ç›®çš„æ˜¯å¾—åˆ°æŒ‡ä»¤çš„æ“ä½œå’Œæ“ä½œå¯¹è±¡, è¿™ä¸»è¦æ˜¯é€šè¿‡æŸ¥çœ‹æŒ‡ä»¤çš„`opcode`æ¥å†³å®šçš„. NEMUé€šè¿‡ä¸€ä¸ªæ¨¡å¼å­—ç¬¦ä¸²æ¥æŒ‡å®šæŒ‡ä»¤ä¸­çš„`opcode`.

å› ä¸ºè¯‘ç éƒ¨åˆ†ç ”è¯»æ—¶å€™å‘ç°ç»†èŠ‚å¾ˆå¤šï¼Œæ‰€ä»¥ä¸ºäº†ç†è§£è¿™éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘è¿™ä¸ªå°èŠ‚çš„è§„åˆ’æ˜¯ï¼šå…ˆä»å®è§‚è§’åº¦è®²è¯‘ç åšäº†ä»€ä¹ˆï¼Œå³è¯‘ç çš„åŠŸèƒ½ï¼›éšåç€çœ¼ç»†èŠ‚ï¼Œå‰–æä»£ç çš„ç­‹éª¨çº¹ç†ï¼Œçœ‹çœ‹è¯‘ç æ˜¯æ€ä¹ˆå®ç°è¿™äº›åŠŸèƒ½çš„ã€‚

æ¥ä¸åŠè§£é‡Šäº†ï¼Œæˆ‘ä»¬å¼€å§‹:star:

#### åŠŸèƒ½

é¦–å…ˆçœ‹ä¸‹ï¼Œå¦‚ä½•è·å–æŒ‡ä»¤ä¸­çš„`opcode`.

NEMUå®šä¹‰äº†ç”¨äºè¯†åˆ«å¯¹åº”`opcode`çš„æ¨¡å¼åŒ¹é…è§„åˆ™`INSTPAT`ï¼ˆæ„æ€æ˜¯instruction patternï¼‰

```tex
INSTPAT(æ¨¡å¼å­—ç¬¦ä¸², æŒ‡ä»¤åç§°, æŒ‡ä»¤ç±»å‹, æŒ‡ä»¤æ‰§è¡Œæ“ä½œ);
```

å®å±•å¼€åï¼Œé¦–å…ˆè°ƒç”¨`pattern_decode()`å‡½æ•°ï¼Œå°†ä¸€æ¡åŒ…å«`opcode`å¯¹åº”åŒ¹é…è§„åˆ™çš„å­—ç¬¦ä¸²ï¼Œç»è¿‡è½¬æ¢ï¼Œä½œä¸º`opcode`çš„åˆ¤æ–­å‚æ•°ã€‚

ç„¶åå†å°†è¾“å…¥çš„`s`ä¸­çš„æŒ‡ä»¤ä¿¡æ¯`s->isa.inst.val`ï¼Œç»è¿‡ä½æ“ä½œåï¼Œè·Ÿä¸Šä¸€æ­¥éª¤ä¸­çš„`opcode`åˆ¤æ–­å‚æ•°è¿›è¡Œæ¯”å¯¹ã€‚

å¦‚æœæ¯”å¯¹æˆåŠŸï¼Œåˆ™å®£å‘Šäº†æŒ‡ä»¤çš„æ“ä½œç±»å‹å·²ç»ç¡®å®šï¼ŒæŒ‡ä»¤ç±»å‹çš„è¯‘ç å·¥ä½œå·²ç»å®Œæˆã€‚

æŒ‡ä»¤ç±»å‹ç¡®å®šåï¼Œéšåä¾¿æ˜¯å¯¹æ“ä½œå¯¹è±¡çš„è¯‘ç å¤„ç†`decode_operand()`ã€‚æ­¤å‡½æ•°æ ¹æ®ä¼ å…¥çš„æŒ‡ä»¤ç±»å‹`type`æ¥è¿›è¡Œæ“ä½œæ•°çš„è¯‘ç ï¼Œè¯‘ç ç»“æœä¼šè¢«ä¿å­˜èµ·æ¥ã€‚

```C
decode_operand(s, &rd, &src1, &src2, &imm, TYPE_U);
```

ä»¥ä¸Šå°±æ˜¯å®è§‚è§’åº¦ï¼Œå±è”½æ‰å‡½æ•°å†…éƒ¨çš„å¤æ‚ç²’åº¦ï¼Œåªæ¦‚è¿°æ¯ä¸ªå‡½æ•°çš„è¾“å…¥è¾“å‡ºï¼Œä»ç®€åŒ–è¯‘ç çš„é€»è¾‘ã€‚

ä½†æ˜¯å®é™…çš„æ“ä½œï¼Œè¿˜æ˜¯éœ€è¦ä¾é å¤æ‚çš„é€»è¾‘å¤„ç†å’Œå¯¹åº”cè¯­è¨€ç‰¹æ€§æ‰èƒ½å®ç°ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ç€æ‰‹ç»†èŠ‚ï¼Œä»ç»†èŠ‚ä¸Šå‰–æè¯‘ç çš„æ“ä½œæµç¨‹ã€‚

#### ç»†èŠ‚

é¦–å…ˆçœ‹ä¸‹å¦‚ä½•å®ç°çš„æ¨¡å¼åŒ¹é…ã€‚NEMUå¯ä»¥é€šè¿‡ä¸€ä¸ªæ¨¡å¼å­—ç¬¦ä¸²æ¥æŒ‡å®šæŒ‡ä»¤ä¸­`opcode`, ä¾‹å¦‚åœ¨riscv32ä¸­æœ‰å¦‚ä¸‹æ¨¡å¼:

```C
INSTPAT_START();
INSTPAT("??????? ????? ????? ??? ????? 00101 11", auipc, U, R(rd) = s->pc + imm);
// ...
INSTPAT_END();
```

è€Œå®šä¹‰æ¯ä¸€æ¡æ¨¡å¼åŒ¹é…è§„åˆ™çš„`INSTPAT`æ˜¯ä¸€ä¸ªå®ï¼Œå…¶æ ¼å¼ä¸ºï¼š

```tex
INSTPAT(æ¨¡å¼å­—ç¬¦ä¸², æŒ‡ä»¤åç§°, æŒ‡ä»¤ç±»å‹, æŒ‡ä»¤æ‰§è¡Œæ“ä½œ);
```

`INSTPAT`çš„å„ä¸ªå‚æ•°çš„è¯´æ˜å¦‚ä¸‹ï¼š

> `æ¨¡å¼å­—ç¬¦ä¸²`ä¸­åªå…è®¸å‡ºç°4ç§å­—ç¬¦:
>
> - `0`è¡¨ç¤ºç›¸åº”çš„ä½åªèƒ½åŒ¹é…`0`
> - `1`è¡¨ç¤ºç›¸åº”çš„ä½åªèƒ½åŒ¹é…`1`
> - `?`è¡¨ç¤ºç›¸åº”çš„ä½å¯ä»¥åŒ¹é…`0`æˆ–`1`
> - ç©ºæ ¼æ˜¯åˆ†éš”ç¬¦, åªç”¨äºæå‡æ¨¡å¼å­—ç¬¦ä¸²çš„å¯è¯»æ€§, ä¸å‚ä¸åŒ¹é…
>
> `æŒ‡ä»¤åç§°`åœ¨ä»£ç ä¸­ä»…å½“æ³¨é‡Šä½¿ç”¨, ä¸å‚ä¸å®å±•å¼€; 
>
> `æŒ‡ä»¤ç±»å‹`ç”¨äºåç»­è¯‘ç è¿‡ç¨‹; 
>
> `æŒ‡ä»¤æ‰§è¡Œæ“ä½œ`åˆ™æ˜¯é€šè¿‡Cä»£ç æ¥æ¨¡æ‹ŸæŒ‡ä»¤æ‰§è¡Œçš„çœŸæ­£è¡Œä¸º.

ä¸‹é¢çœ‹ä¸‹`INSTPAT`å®å¦‚ä½•è½¬æ¢ä¸ºå¯¹åº”çš„Cä»£ç ã€‚

æˆ‘ä»¬çœ‹ä¸‹`INSTPAT`ã€`INSTPAT_START()`å’Œ`INSTPAT_END()`å…¶å®å®šä¹‰çš„å…·ä½“å®ç°ã€‚å®ƒä»¬å‡è¢«å®šä¹‰åœ¨`nemu/include/cpu/decode.h`ä¸­ã€‚

```c
// --- pattern matching wrappers for decode ---
#define INSTPAT(pattern, ...) do { \
  uint64_t key, mask, shift; \
  pattern_decode(pattern, STRLEN(pattern), &key, &mask, &shift); \
  if ((((uint64_t)INSTPAT_INST(s) >> shift) & mask) == key) { \
    INSTPAT_MATCH(s, ##__VA_ARGS__); \
    goto *(__instpat_end); \
  } \
} while (0)

#define INSTPAT_START(name) { const void ** __instpat_end = &&concat(__instpat_end_, name);
#define INSTPAT_END(name)   concat(__instpat_end_, name): ; }
```

`INSTPAT`åˆä½¿ç”¨äº†å¦å¤–ä¸¤ä¸ªå®`INSTPAT_INST`å’Œ`INSTPAT_MATCH`, å®ƒä»¬åœ¨`nemu/src/isa/$ISA/inst.c`ä¸­å®šä¹‰. 

```C
#define INSTPAT_INST(s) ((s)->isa.inst.val)
#define INSTPAT_MATCH(s, name, type, ... /* execute body */ ) { \
  decode_operand(s, &rd, &src1, &src2, &imm, concat(TYPE_, type)); \
  __VA_ARGS__ ; \
}
```

å…·ä½“å®šä¹‰å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œä¸‹é¢æˆ‘ä»¬æŒ‰ç…§å…¶æºç ï¼Œåˆ†æä¸‹`INSTPAT`ã€`INSTPAT_START()`å’Œ`INSTPAT_END()`çš„å…·ä½“é€»è¾‘ã€‚

é¦–å…ˆæ˜¯å®`INSTPAT`çš„å„éƒ¨åˆ†å«ä¹‰è§£æï¼š

1. `pattern_decode` æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡è§£æ `pattern`ï¼ˆæ¨¡å¼ï¼‰ç”Ÿæˆ `key`ã€`mask` å’Œ `shift` è¿™ä¸‰ä¸ªå˜é‡ã€‚

2. `if ((((uint64_t)INSTPAT_INST(s) >> shift) & mask) == key)`

   - `INSTPAT_INST(s)` æ˜¯ä¸€ä¸ªå®ï¼Œç”¨äºä»å­˜æ”¾æŒ‡ä»¤æ‰§è¡Œä¿¡æ¯çš„ç»“æ„ä½“ `s` ä¸­æå–æŒ‡ä»¤æˆ–æ•°æ®ã€‚å…¶é€»è¾‘å®ç°ä¸º

     ```c
     #define INSTPAT_INST(s) ((s)->isa.inst.val)
     ```

   - `(uint64_t)INSTPAT_INST(s)`å°†æå–åˆ°çš„æŒ‡ä»¤ï¼Œè½¬æ¢ä¸º64ä½çš„æ•´æ•°

   - `& mask`ï¼šé€šè¿‡æ©ç æ“ä½œä¿ç•™éœ€è¦åŒ¹é…çš„ä½ï¼Œå±è”½æ‰å…¶ä»–ä¸ç›¸å…³çš„ä½ã€‚

   - `== key`ï¼šæœ€åå°†å¤„ç†åçš„ç»“æœä¸ `key` è¿›è¡Œæ¯”è¾ƒï¼Œåˆ¤æ–­å½“å‰æŒ‡ä»¤æˆ–æ•°æ®æ˜¯å¦ç¬¦åˆæŒ‡å®šæ¨¡å¼ã€‚

3. `INSTPAT_MATCH(s, ##__VA_ARGS__)`

   - å½“2é˜¶æ®µ`if`åˆ¤æ–­æ¡ä»¶æˆç«‹ï¼Œå®è°ƒç”¨`INSTPAT_MATCH`ï¼Œæ‰§è¡Œä¸è¯¥æ¨¡å¼åŒ¹é…çš„é€»è¾‘

     ```C
     #define INSTPAT_MATCH(s, name, type, ... /* execute body */ ) { \
       decode_operand(s, &rd, &src1, &src2, &imm, concat(TYPE_, type)); \
       __VA_ARGS__ ; \
     }
     ```

   - `##__VA_ARGS__` è¡¨ç¤ºå¯å˜å‚æ•°ï¼Œå…è®¸ä¼ é€’å¤šä¸ªå‚æ•°ç»™ `INSTPAT_MATCH`ï¼Œä½¿è¿™ä¸ªå®æ›´çµæ´»ã€‚

4. `goto *(__instpat_end)`

   - åŒ¹é…æˆåŠŸï¼Œä»£ç è·³è½¬åˆ°é¢„å®šä¹‰çš„æŒ‡é’ˆ`__instpat_end`æ‰€æŒ‡çš„åœ°å€ã€‚`__instpat_end`å®ç°åœ¨`INSTPAT_START`ä¸­

æ€»ç»“`INSTPAT`å®çš„æ•´ä½“é€»è¾‘ï¼š

1. é€šè¿‡`pattern_decode()`å‡½æ•°è§£æä¼ å…¥çš„æŒ‡ä»¤æ¨¡å¼`pattern`ï¼Œç”¨ä¸ç”ŸæˆåŒ¹é…çš„ `key`ã€`mask` å’Œ `shift`ã€‚
2. ä» `s` ä¸­æå–å¾…å¤„ç†çš„æŒ‡ä»¤æˆ–æ•°æ®ï¼Œå¹¶æ ¹æ® `shift`ã€`mask` å’Œ `key` è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚
3. å¦‚æœåŒ¹é…æˆåŠŸï¼Œæ‰§è¡Œ `INSTPAT_MATCH` ä¸­å¯¹åº”`__VA_ARGS__`çš„æ“ä½œ
4. æœ€å `goto *(__instpat_end)` è·³è½¬åˆ°é¢„å®šä¹‰çš„ä½ç½®ï¼Œå¯èƒ½æ˜¯ä¸ºäº†è·³è¿‡æŸäº›æŒ‡ä»¤æˆ–ç»“æŸå½“å‰åŒ¹é…è¿‡ç¨‹ã€‚

åˆ†æå®Œæ¯•`INSTPAT`çš„æ•´ä½“é€»è¾‘åï¼Œå†æ·±å…¥åˆ†æä¸‹å‡½æ•°`pattern_decode()`å’Œ`decode_operand()`çš„é€»è¾‘ã€‚

é¦–å…ˆæ˜¯å°†æ¨¡å¼å­—ç¬¦ä¸²è§£æåˆ°å˜é‡`key`ã€`mask`å’Œ`shift`çš„å‡½æ•°`pattern_decode()`ï¼Œå®šä¹‰åœ¨`nemu/include/cpu/decode.h`ä¸­ã€‚

```C
static inline void pattern_decode(const char *str, int len,
    uint64_t *key, uint64_t *mask, uint64_t *shift) {
  uint64_t __key = 0, __mask = 0, __shift = 0;

#define macro(i) \
  if ((i) >= len) goto finish; \
  else { \
    char c = str[i]; \
    if (c != ' ') { \
      Assert(c == '0' || c == '1' || c == '?', \
          "invalid character '%c' in pattern string", c); \
      __key  = (__key  << 1) | (c == '1' ? 1 : 0); \
      __mask = (__mask << 1) | (c == '?' ? 0 : 1); \
      __shift = (c == '?' ? __shift + 1 : 0); \
    } \
  }

#define macro2(i)  macro(i);   macro((i) + 1)
#define macro4(i)  macro2(i);  macro2((i) + 2)
#define macro8(i)  macro4(i);  macro4((i) + 4)
#define macro16(i) macro8(i);  macro8((i) + 8)
#define macro32(i) macro16(i); macro16((i) + 16)
#define macro64(i) macro32(i); macro32((i) + 32)

  macro64(0); // ä»ç´¢å¼• 0 å¼€å§‹è§£æå­—ç¬¦ä¸²
  panic("pattern too long"); // å¦‚æœè§£æåˆ°è¿™é‡Œï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²è¶…é•¿

#undef macro
finish:
  *key = __key >> __shift; // å°† __key å³ç§» __shift ä½
  *mask = __mask >> __shift; // å°† __mask å³ç§» __shift ä½
  *shift = __shift; // è¿”å›ç§»ä½å€¼
}
```

é‡Œé¢æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯å®`macro(i)`çš„ç›¸å…³å®šä¹‰ï¼Œè¿™é‡Œå­¦ä¹ ä¸‹ã€‚

```C
#define macro(i) \
  if ((i) >= len) goto finish; \
  else { \
    char c = str[i]; \
    if (c != ' ') { \
      Assert(c == '0' || c == '1' || c == '?', \
          "invalid character '%c' in pattern string", c); \
      __key  = (__key  << 1) | (c == '1' ? 1 : 0); \
      __mask = (__mask << 1) | (c == '?' ? 0 : 1); \
      __shift = (c == '?' ? __shift + 1 : 0); \
    } \
  }
```

- è¾¹ç•Œæ£€æŸ¥ï¼šå¦‚æœç´¢å¼• `i` è¶…è¿‡å­—ç¬¦ä¸²é•¿åº¦ `len`ï¼Œåˆ™è·³è½¬åˆ° `finish` æ ‡ç­¾ï¼Œç»“æŸè§£æ
- å­—ç¬¦å¤„ç†ï¼š
  - è·å–å­—ç¬¦ä¸²ä¸­ç´¢å¼•ä¸º`i`çš„å­—ç¬¦`c`
  - å¦‚æœå­—ç¬¦ä¸ºéç©ºæ ¼ï¼Œç»§ç»­ä¸‹é¢çš„æ‰§è¡Œ
  - ä½¿ç”¨å®`Assert()`ç¡®ä¿å­—ç¬¦æ˜¯`0`ã€`1`æˆ–`?`
  - æ ¹æ®å­—ç¬¦æ›´æ–°`__key`ã€`__mask` å’Œ `__shift`
    - `1`ï¼šå°† `__key` å‘å·¦ç§»ä½å¹¶è®¾ç½®æœ€ä½ä½ä¸º 1ï¼ŒåŒæ—¶åœ¨ `__mask` ä¸­å°†ç›¸åº”ä½è®¾ä¸º 1
    - `0`ï¼šå°† `__key` å‘å·¦ç§»ä½å¹¶è®¾ç½®æœ€ä½ä½ä¸º 0ï¼ŒåŒæ—¶åœ¨ `__mask` ä¸­å°†ç›¸åº”ä½è®¾ä¸º 1
    - `?`ï¼šä¸å½±å“`__Key`ï¼Œåœ¨`__mask`ä¸­å¯¹åº”ä½è®¾ç½®ä¸º`0`ï¼Œå¹¶å¢åŠ `__shift`çš„è®¡æ•°

è¿™é‡Œæˆ‘ä»¬å•ç‹¬æ‹å‡º`__key`çš„å¤„ç†æ–¹æ³•ï¼Œæ¥çœ‹çœ‹æ˜¯æ€ä¹ˆæ ¹æ®å½“å‰å­—ç¬¦`c`æ¥å†³å®šè¿™ä¸ªå‚æ•°å€¼çš„

```C
__key = (__key << 1) | (c == '1' ? 1 : 0);
```

1. å·¦ç§»æ“ä½œ`__key << 1`
2. æ¡ä»¶è¡¨è¾¾å¼`(c == '1' ? 1 : 0)`
3. æŒ‰ä½æˆ–æ“ä½œ`|`ï¼šæŒ‰ä½æˆ–æ˜¯ä½è¿ç®—çš„ä¸€ç§ï¼Œæ˜¯å°†ä¸¤ä¸ªæ•°æ®çš„äºŒè¿›åˆ¶è¡¨ç¤ºå³å¯¹é½åï¼ŒæŒ‰ä½è¿›è¡Œè¿ç®—ï¼Œä¸¤ä¸ªå¯¹åº”çš„äºŒè¿›åˆ¶ä½ä¸­åªè¦ä¸€ä¸ªæ˜¯1ï¼Œç»“æœå¯¹åº”ä½å°±æ˜¯1ã€‚

ä¸¾ä¾‹ï¼šå¦‚æœå½“å‰`__key`å€¼ä¸º`5`ï¼ˆäºŒè¿›åˆ¶`0101`ï¼‰

- å½“å‰å­—ç¬¦`c`ä¸º`1`ï¼Œåˆ™`__key = 1010 | 1 = 1011`
- å½“å‰å­—ç¬¦`c`ä¸º`0`ï¼Œåˆ™`__key = 1010 | 0 = 1010`

å…¶å®è¿™è¡Œä»£ç çš„ç›®çš„æ˜¯é€ä¸ªå¤„ç†å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ï¼Œå¹¶æ ¹æ®å­—ç¬¦æ˜¯å¦ä¸º`1`ï¼Œæ¥æ„å»ºä¸€ä¸ªäºŒè¿›åˆ¶æ•°ã€‚ä¸¾ä¸€åä¸‰ï¼Œå…¶ä»–ä¸¤ä¸ªå‚æ•°`__mask` å’Œ `__shift`çš„å€¼è·å–æ–¹å¼ç±»ä¼¼ã€‚

`pattern_decode()`ä¸­å¦ä¸€ä¸ªéœ€è¦å­¦ä¹ çš„ç‚¹ï¼Œå°±æ˜¯ç”¨äºç®€åŒ–å’ŒåŠ é€Ÿå­—ç¬¦ä¸²è§£æè¿‡ç¨‹çš„å®æ‰©å±•ã€‚

```C
#define macro2(i)  macro(i);   macro((i) + 1)
```

- é¡ºåºæ‰§è¡Œï¼šå¸¦æœ‰åˆ†å·çš„ `macro(i);` ä½¿å¾—å®ƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯­å¥ï¼Œæ¥ç€åœ¨åŒä¸€è¡Œæ‰§è¡Œ `macro((i) + 1)`ã€‚è¿™ä¸¤è€…æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿæ­£ç¡®è§£æã€‚
- é€šè¿‡ä¸€æ¬¡å®è°ƒç”¨å¤„ç†ä¸¤ä¸ªå­—ç¬¦ï¼Œç›¸æ¯”äºé€ä¸ªè°ƒç”¨ `macro(i)`ï¼Œå¯ä»¥å‡å°‘å®è°ƒç”¨çš„æ¬¡æ•°ï¼Œä»è€Œæé«˜è§£ææ•ˆç‡ã€‚

å­¦ä¹ å®Œä¸»è¦çš„å®`macro(i)`åï¼Œæˆ‘ä»¬å†å›å¤´å¯¹å‡½æ•°`pattern_decode()`ä¸»è¦éƒ¨åˆ†è¿›è¡Œè§£æ

- å® `macro(i)`ï¼šå°†å­—ç¬¦ä¸²è¡¨ç¤ºçš„æŒ‡ä»¤æ¨¡å¼è½¬æ¢ä¸ºå¯ä»¥ç”¨äºæ¯”è¾ƒçš„ä½å€¼å’Œæ©ç 

- `macro64(0)`ï¼šä»ç´¢å¼•0å¼€å§‹ï¼Œå¤„ç†ä» 0 åˆ° 63 çš„å­—ç¬¦ã€‚

- `panic()`ï¼šå°è¯•å¤„ç†çš„å­—ç¬¦è¶…å‡ºäº†å®é™…å­—ç¬¦ä¸²çš„é•¿åº¦èŒƒå›´ï¼Œä¼šè°ƒç”¨æ­¤å‡½æ•°æŠ¥é”™ã€‚

  ä¸¾ä¾‹å­—ç¬¦ä¸²å¦‚æœä¸º`1010`ï¼Œè€Œ`len`ä¸ºåè¿›åˆ¶çš„10ã€‚å°†è¿™ä¸ª4ä½çš„å­—ç¬¦ä¸²ç”¨å‡½æ•°`macro4(0)`å¤„ç†æ—¶ï¼Œå³ä½¿å¤„ç†å®Œå­—ç¬¦ä¸²ï¼Œä¹Ÿä¼šå› ä¸º`if`è¯­å¥ä¸æˆç«‹ï¼Œä¸ä¼šè·³è½¬åˆ°æ­£å¸¸çš„`finish`éƒ¨åˆ†ã€‚æ‰€ä»¥ä¼šè°ƒç”¨å‡½æ•°`panic()`æŠ¥é”™ã€‚

- `finish`ï¼šä¿ç•™`__key`å’Œ`__mask`çš„æœ‰æ•ˆä½ï¼Œå¹¶å°†è§£æè¿‡ç¨‹ä¸­é‡åˆ°çš„ `?` å­—ç¬¦çš„æ•°é‡ï¼Œæœ‰æ•ˆä½çš„åç§»é‡`__shift`è¿”å›

è¿™ä¸ª`pattern_decode()`çš„å«é‡‘é‡è¿˜æ˜¯è›®é«˜çš„ï¼Œæ€»ç»“ä¸‹é‡Œé¢å€¼å¾—å­¦ä¹ çš„ä¸œè¥¿æœ‰ï¼š

1. å®çš„ä½¿ç”¨å’Œé€’å½’è§£æï¼šçµæ´»åœ°å¤„ç†è¾“å…¥å­—ç¬¦ä¸²çš„ä¸åŒé•¿åº¦
2. å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º`key`å’Œ`mask`ï¼šå¢åŠ æ–°ç±»å‹çš„å­—ç¬¦æˆ–æ”¹å˜è§£æè§„åˆ™åªéœ€è°ƒæ•´å®é€»è¾‘ï¼Œè€Œæ— éœ€é‡å†™æ•´ä¸ªè§£æè¿‡ç¨‹ã€‚
3. é”™è¯¯ä¿æŠ¤æœºåˆ¶
4. ä»£ç ç»´æŠ¤æ€§ï¼šä½“ç°åœ¨å®å’Œ`finish`ã€‚æ‰€æœ‰è§£æç»“æœçš„æ›´æ–°é›†ä¸­åœ¨`finish:`æ ‡ç­¾å¤„ï¼Œé¿å…äº†ä»£ç é‡å¤ã€‚

åˆ†æå®Œæ¯•`pattern_decode()`ï¼Œå†å…·ä½“åˆ†æä¸‹å‡½æ•°`decode_operand()`

`INSTPAT`çš„æ•´ä½“é€»è¾‘ä¸ä»…åŒ…å«æ¨¡å¼å­—ç¬¦ä¸²å¤„ç†å‡½æ•°`pattern_decode()`ï¼Œè€Œä¸”åŒ…å«å¦ä¸€ä¸ªåŒ¹é…æ“ä½œç è¡Œä¸ºçš„å‡½æ•°`decode_operand()`ã€‚

```C
#define src1R() do { *src1 = R(rs1); } while (0)
#define src2R() do { *src2 = R(rs2); } while (0)
#define immI() do { *imm = SEXT(BITS(i, 31, 20), 12); } while(0)
#define immU() do { *imm = SEXT(BITS(i, 31, 12), 20) << 12; } while(0)
#define immS() do { *imm = (SEXT(BITS(i, 31, 25), 7) << 5) | BITS(i, 11, 7); } while(0)

static void decode_operand(Decode *s, int *rd, word_t *src1, word_t *src2, word_t *imm, int type) {
  uint32_t i = s->isa.inst.val;
  int rs1 = BITS(i, 19, 15);
  int rs2 = BITS(i, 24, 20);
  *rd     = BITS(i, 11, 7);
  switch (type) {
    case TYPE_I: src1R();          immI(); break;
    case TYPE_U:                   immU(); break;
    case TYPE_S: src1R(); src2R(); immS(); break;
  }
}
```

å…¶ä¸­ç”¨åˆ°çš„å®å®šä¹‰`BITS`å’Œ`SEXT`åœ¨`nemu/include/macro.h`ä¸­å®šä¹‰ï¼Œåˆ†åˆ«ç”¨äºä½æŠ½å–å’Œç¬¦å·æ‰©å±•

```C
#define BITMASK(bits) ((1ull << (bits)) - 1)
#define BITS(x, hi, lo) (((x) >> (lo)) & BITMASK((hi) - (lo) + 1)) // similar to x[hi:lo] in verilog
#define SEXT(x, len) ({ struct { int64_t n : len; } __x = { .n = x }; (uint64_t)__x.n; })
```

å®çš„ç®€å•ä»‹ç»ï¼š

- `BITMASK(bits)`ï¼šç”Ÿæˆä¸€ä¸ªç”± `bits` ä¸ªä½ä½ä¸º 1 çš„æ— ç¬¦å·é•¿æ•´å‹æ©ç ã€‚ä¾‹å¦‚ï¼Œ`BITMASK(3)` çš„ç»“æœæ˜¯ `0b111`ï¼Œå³åè¿›åˆ¶çš„ 7ã€‚
- `BITS(x, hi, lo)`ï¼šè·å–`x`çš„`[lo, hi]`éƒ¨åˆ†æ•°æ®
- `SEXT(x, len)`ï¼šå°†`x`ç¬¦å·æ‰©å±•ä¸º64ä½çš„æ— ç¬¦å·æ•´æ•°

è¿™é‡Œæ·±å…¥å­¦ä¹ ä¸‹å®`SEXT()`:

```C
#define SEXT(x, len) ({ struct { int64_t n : len; } __x = { .n = x }; (uint64_t)__x.n; })
```

1. **ä½åŸŸç»“æ„ä½“çš„å®šä¹‰**

   ```C
   { struct { int64_t n : len; } __x;
   ```

   è¿™éƒ¨åˆ†å®šä¹‰äº†ä¸€ä¸ªåŒ¿åçš„ç»“æ„ä½“ `__x`ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªåä¸º `n` çš„æˆå‘˜ã€‚è¿™ä¸ªæˆå‘˜ `n` æ˜¯ä¸€ä¸ª**ä½åŸŸï¼ˆbit-fieldï¼‰**ï¼Œå®ƒä½¿ç”¨ `len` ä½æ¥å­˜å‚¨æ•°æ®ã€‚

2. **ç»“æ„ä½“çš„åˆå§‹åŒ–**

   ```C
   __x = { .n = x };
   ```

   è¿™ä¸€éƒ¨åˆ†ä½¿ç”¨çš„æ˜¯**æŒ‡å®šæˆå‘˜åˆå§‹åŒ–**çš„è¯­æ³•ã€‚è¿™ç§åˆå§‹åŒ–æ–¹å¼å…è®¸ä½ åœ¨å®šä¹‰ç»“æ„ä½“å®ä¾‹æ—¶ï¼Œç›´æ¥ä¸ºå…¶ä¸­çš„ç‰¹å®šæˆå‘˜èµ‹å€¼ã€‚ä¸‹é¢æ˜¯ä¸€äº›å…³é”®ç‚¹ï¼š

   - `__x` æ˜¯ä¸€ä¸ªç»“æ„ä½“å˜é‡ï¼Œå®ƒçš„ç±»å‹æ˜¯å‰é¢å®šä¹‰çš„åŒ¿åç»“æ„ä½“ç±»å‹ã€‚
   - `{ .n = x }` æ˜¯ä¸€ä¸ªåˆå§‹åŒ–è¯­å¥ï¼Œè¡¨ç¤ºå°† `x` çš„å€¼èµ‹ç»™ç»“æ„ä½“ `__x` çš„æˆå‘˜ `n`ã€‚è¿™é‡Œçš„ `.n` æ˜¯æŒ‡å®šæˆå‘˜ `n` æ¥åˆå§‹åŒ–çš„è¯­æ³•ã€‚

   ä½¿ç”¨ `{ .member_name = value }` çš„å½¢å¼ï¼Œå¯ä»¥åˆå§‹åŒ–ç»“æ„ä½“ä¸­çš„ç‰¹å®šæˆå‘˜ï¼Œè€Œä¸æ˜¯ä¾èµ–äºç»“æ„ä½“å®šä¹‰çš„é¡ºåºã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ`x` çš„å€¼ä¼šèµ‹ç»™ `n`ï¼Œå¹¶ä¸”ç”±äº `n` æ˜¯ä¸€ä¸ªä½åŸŸï¼Œå®ƒä¼šè‡ªåŠ¨æ ¹æ® `len` è¿›è¡Œå¤„ç†ï¼Œå¯èƒ½ä¼šæˆªæ–­æˆ–è€…æ‰©å±•ã€‚

3. **ç¬¦å·æ‰©å±•ä¸ä½åŸŸ**

   åœ¨å® `SEXT(x, len)` ä¸­ï¼Œè¿™æ®µä»£ç çš„ä½œç”¨æ˜¯å°† `x` çš„å€¼æ”¾å…¥ä¸€ä¸ªå ç”¨ `len` ä½çš„ä½åŸŸ `n` ä¸­ã€‚ä½åŸŸä¼šæ ¹æ® `len` è¿™ä¸ªé•¿åº¦è‡ªåŠ¨å¤„ç† `x` çš„å€¼ï¼ŒåŒ…æ‹¬ä¿ç•™ç¬¦å·ä½è¿›è¡Œç¬¦å·æ‰©å±•ã€‚

   å…·ä½“çš„è¿‡ç¨‹æ˜¯ï¼š

   - å¦‚æœ `x` æ˜¯ä¸€ä¸ªè¾ƒçŸ­çš„æœ‰ç¬¦å·æ•´æ•°ï¼Œ`n : len` ä¼šå°†å®ƒæˆªæ–­æˆ–æ‰©å±•åˆ° `len` ä½ã€‚
   - ä½åŸŸä¸­ï¼Œå¦‚æœ `x` æ˜¯è´Ÿæ•°å¹¶ä¸”éœ€è¦æ‰©å±•ä½æ•°ï¼Œç¬¦å·ä½ï¼ˆæœ€é«˜ä½ï¼‰ä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ›´å¤§çš„èŒƒå›´ã€‚
   - è¿™æ ·å¯ä»¥æ–¹ä¾¿åœ°å®ç°ç¬¦å·æ‰©å±•ï¼Œè€Œä¸ç”¨æ‰‹åŠ¨è¿›è¡Œä½ç§»å’Œæ©ç æ“ä½œã€‚

4. **è¯­æ³•æ‰©å±• `({ ... })`**

   GCC è¯­æ³•æ‰©å±•ï¼Œå®ƒå…è®¸åœ¨å®å®šä¹‰ä¸­åŒ…å«ä¸€æ®µå¤åˆè¯­å¥å¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚è¿™æ®µå¤åˆè¯­å¥ç›¸å½“äºä¸€ä¸ªä»£ç å—ï¼Œæœ€åä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼ä¼šè¢«è¿”å›ã€‚

5. **æ€»ç»“**

   è¿™ä¸ªå®çš„ç›®çš„æ˜¯å°†ä¸€ä¸ª `x` å€¼ï¼ˆé€šå¸¸æ˜¯è¾ƒçŸ­çš„æœ‰ç¬¦å·æ•´æ•°ï¼‰è¿›è¡Œç¬¦å·æ‰©å±•ï¼Œæ‰©å±•åˆ° `len` æŒ‡å®šçš„ä½æ•°é•¿åº¦ã€‚

è¿™æ ·å‡½æ•°`decode_operand()`æ ¹æ®æŒ‡ä»¤çš„ç±»å‹`type`ï¼Œæ¥è¿›è¡Œæ“ä½œæ•°çš„è¯‘ç ï¼Œå¹¶å°†è¯‘ç ç»“æœè®°å½•åˆ°å‡½æ•°å‚æ•°`rd`, `src1`, `src2`å’Œ`imm`ä¸­, å®ƒä»¬åˆ†åˆ«ä»£è¡¨ç›®çš„æ“ä½œæ•°çš„å¯„å­˜å™¨å·ç , ä¸¤ä¸ªæºæ“ä½œæ•°å’Œç«‹å³æ•°.

### æ‰§è¡Œ

æ‰§è¡Œçš„æ“ä½œå…¶å®è¢«åŒ…å«åœ¨äº†å®`INSTPAT`ä¸­äº†ï¼š

```C
// --- pattern matching wrappers for decode ---
#define INSTPAT(pattern, ...) do { \
  uint64_t key, mask, shift; \
  pattern_decode(pattern, STRLEN(pattern), &key, &mask, &shift); \
  if ((((uint64_t)INSTPAT_INST(s) >> shift) & mask) == key) { \
    INSTPAT_MATCH(s, ##__VA_ARGS__); \
    goto *(__instpat_end); \
  } \
} while (0)
```

å½“æŒ‡ä»¤çš„ç±»å‹è¢«ç¡®å®šåï¼Œå³åˆ¤æ–­æ¡ä»¶æˆç«‹ï¼š

```C
(((uint64_t)INSTPAT_INST(s) >> shift) & mask) == key
```

è¿™æ—¶å€™æ¥åˆ°äº†`INSTPAT_MATCH`æµç¨‹å®ç°ä¸¤ä¸ªåŠŸèƒ½ï¼š

```C
#define INSTPAT_MATCH(s, name, type, ... /* execute body */ ) { \
  decode_operand(s, &rd, &src1, &src2, &imm, concat(TYPE_, type)); \
  __VA_ARGS__ ; \
}
```

1. è°ƒç”¨å‡½æ•°`decode_operand()`ï¼Œå°†æŒ‡ä»¤ä¸­çš„å¯„å­˜å™¨ã€ç«‹å³æ•°ç­‰è§£æåˆ°å¯¹åº”çš„å˜é‡ `rd`, `src1`, `src2`, `imm` ä¸­ã€‚
2. ` __VA_ARGS__ `:ä¼ å…¥çš„é¢å¤–å‚æ•°ï¼ˆå¯å˜å‚æ•°ï¼‰ä¼šè¢«æ›¿æ¢åˆ° `__VA_ARGS__` è¿™ä¸ªä½ç½®ä¸Š.å¦‚æœæƒ³ä¼ å…¥å¤šæ¡è¯­å¥ä½œä¸º `__VA_ARGS__`ï¼Œå¯ä»¥ç›´æ¥åœ¨å®è°ƒç”¨ä¸­ä¼ é€’è¿™äº›è¯­å¥ï¼Œå¹¶å°†å®ƒä»¬ç”¨åˆ†å·åˆ†éš”ï¼Œæˆ–è€…ç”¨å¤§æ‹¬å·`{...}`å°†å¤šæ¡è¯­å¥åŒ…è£¹èµ·æ¥ã€‚

**`INSTPAT_MATCH`ä¸¾ä¾‹**

å‡è®¾ä½ è¿™æ ·è°ƒç”¨å®:

```C
INSTPAT_MATCH(s, "auipc", U, R(rd) = s->pc + imm);
```

æ­¤æ—¶å®å±•å¼€ä¸ºï¼š

```c
{
  decode_operand(s, &rd, &src1, &src2, &imm, concat(TYPE_, U)); 
  R(rd) = s->pc + imm;
}
```

è¿™é‡Œï¼Œ`__VA_ARGS__` è¢«æ›¿æ¢ä¸ºäº† `R(rd) = s->pc + imm`ï¼Œç›¸å½“äºä½ å¯ä»¥åœ¨å®è°ƒç”¨æ—¶æ’å…¥ä¸€æ®µå¯æ‰§è¡Œä»£ç ã€‚

è¿™æ ·å°±å°±å®Œæˆäº†æŒ‡ä»¤çš„æ‰§è¡Œã€‚

æŒ‡ä»¤æ‰§è¡Œçš„é˜¶æ®µç»“æŸä¹‹å, `decode_exec()`å‡½æ•°å°†ä¼šè¿”å›`0`, å¹¶ä¸€è·¯è¿”å›åˆ°`exec_once()`å‡½æ•°ä¸­. ä¸è¿‡ç›®å‰ä»£ç å¹¶æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªè¿”å›å€¼, å› æ­¤å¯ä»¥å¿½ç•¥å®ƒ.

### æ›´æ–°PC

æœ€åæ˜¯æ›´æ–°PC. æ›´æ–°PCçš„æ“ä½œéå¸¸ç®€å•, åªéœ€è¦æŠŠ`s->dnpc`èµ‹å€¼ç»™`cpu.pc`å³å¯. 

`snpc`æ˜¯ä¸‹ä¸€æ¡é™æ€æŒ‡ä»¤, è€Œ`dnpc`æ˜¯ä¸‹ä¸€æ¡åŠ¨æ€æŒ‡ä»¤. 

~~å¯¹äºé¡ºåºæ‰§è¡Œçš„æŒ‡ä»¤~~, å®ƒä»¬çš„`snpc`å’Œ`dnpc`æ˜¯ä¸€æ ·çš„; ä½†å¯¹äºè·³è½¬æŒ‡ä»¤, `snpc`å’Œ`dnpc`å°±ä¼šæœ‰æ‰€ä¸åŒ, `dnpc`åº”è¯¥æŒ‡å‘è·³è½¬ç›®æ ‡çš„æŒ‡ä»¤. æ˜¾ç„¶, æˆ‘ä»¬åº”è¯¥ä½¿ç”¨`s->dnpc`æ¥æ›´æ–°PC, å¹¶ä¸”åœ¨æŒ‡ä»¤æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ­£ç¡®åœ°ç»´æŠ¤`s->dnpc`.

##  è¿è¡Œç¬¬ä¸€ä¸ªCç¨‹åº

ä¸»çº¿ä»»åŠ¡ï¼š

1. å®ç°`dummy`åæ±‡ç¼–ä¸­å…·æœ‰çš„æŒ‡ä»¤ï¼Œå¹¶ä¸”æˆåŠŸè¿è¡Œ

æ”¯çº¿ä»»åŠ¡ï¼š

1. ä¸ºä»€ä¹ˆæ‰§è¡Œäº†æœªå®ç°æŒ‡ä»¤ä¼šå‡ºç°ä¸Šè¿°æŠ¥é”™ä¿¡æ¯ï¼Ÿï¼ˆæ€è€ƒé¢˜ï¼‰

   ```bash
   invalid opcode(PC = 0x80000000):
           13 04 00 00 17 91 00 00 ...
           00000413 00009117...
   There are two cases which will trigger this unexpected exception:
   1. The instruction at PC = 0x80000000 is not implemented.
   2. Something is implemented incorrectly.
   Find this PC(0x80000000) in the disassembling result to distinguish which case it is.
   
   If it is the first case, see
          _                         __  __                         _ 
         (_)                       |  \/  |                       | |
     _ __ _ ___  ___ ________   __ | \  / | __ _ _ __  _   _  __ _| |
    | '__| / __|/ __|______\ \ / / | |\/| |/ _` | '_ \| | | |/ _` | |
    | |  | \__ \ (__        \ V /  | |  | | (_| | | | | |_| | (_| | |
    |_|  |_|___/\___|        \_/   |_|  |_|\__,_|_| |_|\__,_|\__,_|_|
   
   for more details.
   
   If it is the second case, remember:
   * The machine is always right!
   * Every line of untested code is always wrong!
   ```

#### RISC-VæŒ‡ä»¤æ ¼å¼

> åœ¨RISC-V 32ä½ï¼ˆRV32ï¼‰æ¶æ„çš„æŒ‡ä»¤é›†ä¸­ï¼Œæ¯æ¡æŒ‡ä»¤çš„é•¿åº¦ä¸ºå›ºå®šçš„32ä½ã€‚æŒ‡ä»¤çš„ä¸åŒéƒ¨åˆ†è¡¨ç¤ºä¸åŒçš„å­—æ®µï¼Œå…·ä½“å­—æ®µåŠå…¶æ„ä¹‰å–å†³äºæŒ‡ä»¤çš„ç±»å‹ã€‚RISC-V æœ‰å¤šç§æŒ‡ä»¤æ ¼å¼ï¼Œæœ€å¸¸è§çš„åŒ…æ‹¬ **Rå‹**ã€**Iå‹**ã€**Så‹**ã€**Bå‹**ã€**Uå‹** å’Œ **Jå‹**ã€‚æ¯ç§æ ¼å¼çš„æŒ‡ä»¤å­—æ®µå¸ƒå±€ç•¥æœ‰ä¸åŒã€‚ä¸‹é¢æˆ‘å°†ç®€è¦ä»‹ç»è¿™äº›æ ¼å¼ä»¥åŠå®ƒä»¬å¯¹åº”çš„ä½åŒºé—´ä»£è¡¨çš„å‚æ•°ã€‚
>
> 1. **Rå‹æŒ‡ä»¤ï¼ˆR-Type Instructionï¼‰**
>
> Rå‹æŒ‡ä»¤ç”¨äºå¯„å­˜å™¨é—´çš„æ“ä½œï¼Œä¸¤ä¸ªæºå¯„å­˜å™¨å’Œä¸€ä¸ªç›®æ ‡å¯„å­˜å™¨ã€‚
>
> | ä½åŒºé—´  | å­—æ®µå | ä½å®½ | æè¿°                       |
> | ------- | ------ | ---- | -------------------------- |
> | [31:25] | funct7 | 7    | åŠŸèƒ½ç ï¼ˆç¡®å®šå…·ä½“è¿ç®—ç±»å‹ï¼‰ |
> | [24:20] | rs2    | 5    | æºå¯„å­˜å™¨2                  |
> | [19:15] | rs1    | 5    | æºå¯„å­˜å™¨1                  |
> | [14:12] | funct3 | 3    | åŠŸèƒ½ç ï¼ˆå†³å®šè¿ç®—ç±»å‹ï¼‰     |
> | [11:7]  | rd     | 5    | ç›®æ ‡å¯„å­˜å™¨                 |
> | [6:0]   | opcode | 7    | æ“ä½œç ï¼ˆç¡®å®šæŒ‡ä»¤ç±»å‹ï¼‰     |
>
> - **opcode**ï¼šæ“ä½œç ï¼Œå†³å®šæŒ‡ä»¤ç±»å‹ï¼Œå¦‚åŠ æ³•ã€å‡æ³•ã€æŒ‰ä½ä¸ç­‰ã€‚
> - **funct3** å’Œ **funct7**ï¼šè¿™ä¸¤ä¸ªå­—æ®µå…±åŒå†³å®šäº†å…·ä½“çš„è¿ç®—ç±»å‹ã€‚
> - **rs1** å’Œ **rs2**ï¼šä¸¤ä¸ªæºå¯„å­˜å™¨ã€‚
> - **rd**ï¼šç›®æ ‡å¯„å­˜å™¨ã€‚
>
> **ä¾‹å­**ï¼š`ADD x1, x2, x3` æ˜¯ä¸€æ¡ Rå‹æŒ‡ä»¤ï¼Œè¡¨ç¤ºå°† `x2` å’Œ `x3` ä¸­çš„å€¼ç›¸åŠ ï¼Œå¹¶å°†ç»“æœå­˜å…¥ `x1`ã€‚
>
> 2. **Iå‹æŒ‡ä»¤ï¼ˆI-Type Instructionï¼‰**
>
> Iå‹æŒ‡ä»¤åŒ…å«ä¸€ä¸ª12ä½çš„ç«‹å³æ•°ï¼Œé€šå¸¸ç”¨äºç«‹å³æ•°è¿ç®—æˆ–å†…å­˜è®¿é—®ã€‚
>
> | ä½åŒºé—´  | å­—æ®µå    | ä½å®½ | æè¿°                     |
> | ------- | --------- | ---- | ------------------------ |
> | [31:20] | imm[11:0] | 12   | ç«‹å³æ•°ï¼ˆç¬¦å·æ‰©å±•åˆ°32ä½ï¼‰ |
> | [19:15] | rs1       | 5    | æºå¯„å­˜å™¨1                |
> | [14:12] | funct3    | 3    | åŠŸèƒ½ç ï¼ˆå†³å®šè¿ç®—ç±»å‹ï¼‰   |
> | [11:7]  | rd        | 5    | ç›®æ ‡å¯„å­˜å™¨               |
> | [6:0]   | opcode    | 7    | æ“ä½œç                    |
>
> - **imm[11:0]**ï¼š12ä½çš„ç«‹å³æ•°ï¼Œç»è¿‡ç¬¦å·æ‰©å±•ç”¨äºè¿ç®—ã€‚
> - **rs1**ï¼šæºå¯„å­˜å™¨1ï¼Œå­˜å‚¨ç¬¬ä¸€ä¸ªæ“ä½œæ•°ã€‚
> - **rd**ï¼šç›®æ ‡å¯„å­˜å™¨ï¼Œå­˜å‚¨è¿ç®—ç»“æœã€‚
> - **opcode** å’Œ **funct3**ï¼šå…±åŒå†³å®šå…·ä½“æŒ‡ä»¤å’Œè¿ç®—ç±»å‹ã€‚
>
> **ä¾‹å­**ï¼š`ADDI x1, x2, 10` è¡¨ç¤ºå°† `x2` ä¸­çš„å€¼ä¸ç«‹å³æ•° `10` ç›¸åŠ ï¼Œå¹¶å°†ç»“æœå­˜å…¥ `x1`ã€‚
>
> 3. **Så‹æŒ‡ä»¤ï¼ˆS-Type Instructionï¼‰**
>
> Så‹æŒ‡ä»¤ç”¨äºå†…å­˜å­˜å‚¨æ“ä½œï¼Œå¦‚å­˜å‚¨å­—èŠ‚ã€å­˜å‚¨åŠå­—æˆ–å­˜å‚¨å­—ã€‚
>
> | ä½åŒºé—´  | å­—æ®µå    | ä½å®½ | æè¿°            |
> | ------- | --------- | ---- | --------------- |
> | [31:25] | imm[11:5] | 7    | ç«‹å³æ•°ï¼ˆé«˜7ä½ï¼‰ |
> | [24:20] | rs2       | 5    | æºå¯„å­˜å™¨2       |
> | [19:15] | rs1       | 5    | æºå¯„å­˜å™¨1       |
> | [14:12] | funct3    | 3    | åŠŸèƒ½ç           |
> | [11:7]  | imm[4:0]  | 5    | ç«‹å³æ•°ï¼ˆä½5ä½ï¼‰ |
> | [6:0]   | opcode    | 7    | æ“ä½œç           |
>
> - **imm[11:5]** å’Œ **imm[4:0]**ï¼šç«‹å³æ•°åˆ†ä¸ºé«˜7ä½å’Œä½5ä½ï¼Œæ„æˆ12ä½ç«‹å³æ•°ï¼Œç”¨äºè®¡ç®—å†…å­˜åœ°å€åç§»ã€‚
> - **rs1**ï¼šæºå¯„å­˜å™¨1ï¼Œç”¨äºæä¾›åŸºåœ°å€ã€‚
> - **rs2**ï¼šæºå¯„å­˜å™¨2ï¼Œæä¾›è¦å­˜å‚¨çš„å€¼ã€‚
>
> **ä¾‹å­**ï¼š`SW x2, 4(x3)` è¡¨ç¤ºå°† `x2` ä¸­çš„å€¼å­˜å‚¨åˆ° `x3 + 4` æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ä¸­ã€‚
>
> 4. **Bå‹æŒ‡ä»¤ï¼ˆB-Type Instructionï¼‰**
>
> Bå‹æŒ‡ä»¤ç”¨äºæ¡ä»¶è·³è½¬æ“ä½œï¼Œä½¿ç”¨ä¸¤ä¸ªæºå¯„å­˜å™¨è¿›è¡Œæ¯”è¾ƒã€‚
>
> | ä½åŒºé—´  | å­—æ®µå    | ä½å®½ | æè¿°                |
> | ------- | --------- | ---- | ------------------- |
> | [31]    | imm[12]   | 1    | ç«‹å³æ•°ï¼ˆç¬¬12ä½ï¼‰    |
> | [30:25] | imm[10:5] | 6    | ç«‹å³æ•°ï¼ˆç¬¬10åˆ°5ä½ï¼‰ |
> | [24:20] | rs2       | 5    | æºå¯„å­˜å™¨2           |
> | [19:15] | rs1       | 5    | æºå¯„å­˜å™¨1           |
> | [14:12] | funct3    | 3    | åŠŸèƒ½ç               |
> | [11:8]  | imm[4:1]  | 4    | ç«‹å³æ•°ï¼ˆç¬¬4åˆ°1ä½ï¼‰  |
> | [7]     | imm[11]   | 1    | ç«‹å³æ•°ï¼ˆç¬¬11ä½ï¼‰    |
> | [6:0]   | opcode    | 7    | æ“ä½œç               |
>
> - **imm[12:1]**ï¼šç»„åˆæˆä¸€ä¸ªåˆ†æ”¯ç›®æ ‡åœ°å€çš„åç§»é‡ï¼Œç¬¦å·æ‰©å±•åç”¨äºè·³è½¬ã€‚
> - **rs1** å’Œ **rs2**ï¼šç”¨äºæ¯”è¾ƒçš„ä¸¤ä¸ªæºå¯„å­˜å™¨ã€‚
> - **opcode** å’Œ **funct3**ï¼šå†³å®šå…·ä½“çš„æ¡ä»¶è·³è½¬ç±»å‹ã€‚
>
> **ä¾‹å­**ï¼š`BEQ x1, x2, offset` è¡¨ç¤ºå½“ `x1` ç­‰äº `x2` æ—¶ï¼Œè·³è½¬åˆ°æŒ‡å®šçš„åç§»åœ°å€ã€‚
>
> 5. **Uå‹æŒ‡ä»¤ï¼ˆU-Type Instructionï¼‰**
>
> Uå‹æŒ‡ä»¤ç”¨äºåŠ è½½é«˜ä½ç«‹å³æ•°ï¼Œå¸¸è§çš„æŒ‡ä»¤å¦‚ `LUI` å’Œ `AUIPC`ã€‚
>
> | ä½åŒºé—´  | å­—æ®µå     | ä½å®½ | æè¿°           |
> | ------- | ---------- | ---- | -------------- |
> | [31:12] | imm[31:12] | 20   | ç«‹å³æ•°çš„é«˜20ä½ |
> | [11:7]  | rd         | 5    | ç›®æ ‡å¯„å­˜å™¨     |
> | [6:0]   | opcode     | 7    | æ“ä½œç          |
>
> - **imm[31:12]**ï¼šç«‹å³æ•°çš„é«˜20ä½ï¼Œä½12ä½ä¸º0ï¼Œç»„æˆä¸€ä¸ª32ä½ç«‹å³æ•°ã€‚
> - **rd**ï¼šç›®æ ‡å¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨ç«‹å³æ•°ç»“æœã€‚
>
> **ä¾‹å­**ï¼š`LUI x1, 0x12345` è¡¨ç¤ºå°† `0x12345000` å­˜å…¥å¯„å­˜å™¨ `x1`ã€‚
>
> 6. **Jå‹æŒ‡ä»¤ï¼ˆJ-Type Instructionï¼‰**
>
>    Jå‹æŒ‡ä»¤ç”¨äºæ— æ¡ä»¶è·³è½¬ï¼Œå¸¸è§çš„æŒ‡ä»¤æ˜¯ `JAL`ï¼ˆJump and Linkï¼‰ã€‚
>
>
> | ä½åŒºé—´  | å­—æ®µå     | ä½å®½ | æè¿°               |
> | ------- | ---------- | ---- | ------------------ |
> | [31]    | imm[20]    | 1    | ç«‹å³æ•°çš„ç¬¬20ä½     |
> | [30:21] | imm[10:1]  | 10   | ç«‹å³æ•°çš„ç¬¬10åˆ°1ä½  |
> | [20]    | imm[11]    | 1    | ç«‹å³æ•°çš„ç¬¬11ä½     |
> | [19:12] | imm[19:12] | 8    | ç«‹å³æ•°çš„ç¬¬19åˆ°12ä½ |
> | [11:7]  | rd         | 5    | ç›®æ ‡å¯„å­˜å™¨         |
> | [6:0]   | opcode     | 7    | æ“ä½œç              |
>
> - **imm[20:1]**ï¼šè·³è½¬ç›®æ ‡åœ°å€çš„åç§»é‡ï¼Œç¬¦å·æ‰©å±•åä¸å½“å‰PCç›¸åŠ å½¢æˆè·³è½¬åœ°å€ã€‚
> - **rd**ï¼šå­˜å‚¨è¿”å›åœ°å€çš„å¯„å­˜å™¨ã€‚
>
> **ä¾‹å­**ï¼š`JAL x1, offset` è¡¨ç¤ºè·³è½¬åˆ°æŒ‡å®šçš„åç§»åœ°å€ï¼Œå¹¶å°†è¿”å›åœ°å€å­˜å…¥ `x1`ã€‚

é¦–å…ˆçœ‹ä¸‹`dummy`åæ±‡ç¼–ç»“æœï¼ˆ`am-kernels/tests/cpu-tests/build/dummy-riscv32-nemu.txt`ï¼‰	

```assembly
Disassembly of section .text:

80000000 <_start>:
80000000: 00000413            li  s0,0
80000004: 00009117            auipc sp,0x9
80000008: ffc10113            addi  sp,sp,-4 # 80009000 <_end>
8000000c: 00c000ef            jal ra,80000018 <_trm_init>

80000010 <main>:
80000010: 00000513            li  a0,0
80000014: 00008067            ret

80000018 <_trm_init>:
80000018: ff010113            addi  sp,sp,-16
8000001c: 00000517            auipc a0,0x0
80000020: 01c50513            addi  a0,a0,28 # 80000038 <_etext>
80000024: 00112623            sw  ra,12(sp)
80000028: fe9ff0ef            jal ra,80000010 <main>
8000002c: 00050513            mv  a0,a0
80000030: 00100073            ebreak
80000034: 0000006f            j 80000034 <_trm_init+0x1c>
```

`.text`æ˜¯ç¨‹åºçš„ä»£ç æ®µï¼Œä¸»è¦ç”¨äºå­˜æ”¾å¯æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ã€‚

å¯¹æ¯”`INSTPAT`å·²ç»å®ç°çš„æ¨¡å¼åŒ¹é…è§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦å®ç°è¿™å‡ ä¸ªæŒ‡ä»¤

- `addi`ï¼š`I`ç±»å‹æŒ‡ä»¤ï¼ŒåŠ ç«‹å³æ•°ã€‚

  ```c
  addi rd, rs1, immediate    //x[rd] = x[rs1] + sext(immediate)
  ```

- `jal`ï¼š`J`ç±»å‹æŒ‡ä»¤ï¼Œè·³è½¬å¹¶é“¾æ¥ã€‚`JAL rd,imm`

  ```c
  jal rd, offset  //x[rd] = pc+4; pc += sext(offset)
  ```

- ~~`li`ï¼šä¼ªæŒ‡ä»¤ï¼Œ`CI`ç±»å‹æŒ‡ä»¤ï¼Œè½¬å…¥ç«‹å³æ•° (å³`ADDI rd,x0,imm`)~~

- `ret`ï¼š`I`ç±»å‹æŒ‡ä»¤ï¼Œè¿”å› (å³ `JALR x0,0(ra)`)

  ```c
  jalr rd, offset(rs1)     // t =pc+4; pc=(x[rs1]+sext(offset))&~1; x[rd]=t
  ```

- `sw`ï¼š`S`ç±»å‹ï¼Œå­˜å­—`SW rs2,imm(rs1)`

  ```c
  sw rs2, offset(rs1)   //M[x[rs1] + sext(offset)] = x[rs2][31: 0]
  ```

- ~~`mv`ï¼šä¼ªæŒ‡ä»¤ï¼Œ`R`ç±»å‹ï¼Œä¼ é€ (å³ `ADDI rd,rs,0`)~~

- ~~`j`ï¼š`J`ç±»å‹ï¼Œè·³è½¬ (å³ `JAL x0,imm`)~~

å¯ä»¥çœ‹å‡ºï¼Œä¼ªæŒ‡ä»¤`li`å’Œ`mv`éƒ½æ˜¯åŸºäºå‰ç½®æŒ‡ä»¤`addi`å®ç°çš„ã€‚åŒæ ·åœ°ï¼Œä¼ªæŒ‡ä»¤`ret`åŸºäºå‰ç½®æŒ‡ä»¤`JALR`(Jump And Link Register)ï¼›ä¼ªæŒ‡ä»¤`j`å¯ä»¥é€šè¿‡`JAL`ï¼ˆJump And Linkï¼‰æŒ‡ä»¤æ¥å®ç°ã€‚

æ‰€ä»¥æˆ‘ä»¬è¦æ·»åŠ `INSTPAT`æ¥åŒ¹é…çš„æŒ‡ä»¤å°±æ˜¯`addi`ã€`jal`ã€`jalr`å’Œ`sw`ã€‚è€ŒæŒ‡ä»¤çš„å…·ä½“æ“ä½œå¯ä»¥å‚è€ƒ[RV32IåŸºç¡€æ•´æ•°æŒ‡ä»¤é›†](https://www.cnblogs.com/mikewolf2002/p/11196680.html).

## è¿è¡Œæ›´å¤šçš„ç¨‹åº

> `add-longlong-run`
>
> - [x] å®ç°`sltu`æŒ‡ä»¤0x800000a0	
> - [x] å®ç°`xor`æŒ‡ä»¤0x0x800000ac
> - [x] å®ç°`or`æŒ‡ä»¤0x800000b4
>
> `bit`
>
> - [x] å®ç°`sh`æŒ‡ä»¤$pc==0x800000bc
> - [x] å®ç°`srai`æŒ‡ä»¤$pc==0x80000028
> - [x] å®ç°`andi`æŒ‡ä»¤$pc==0x80000034
> - [x] å®ç°`sll`æŒ‡ä»¤$pc==0x8000003c
> - [x] å®ç°`and`æŒ‡ä»¤$pc==0x80000040
> - [x] å®ç°`xori`æŒ‡ä»¤$pc==0x800000c4
>
> `bubble-sort`
>
> - [x] å®ç°`bge`æŒ‡ä»¤$pc==0x80000040
> - [x] å®ç°`bgeu`æŒ‡ä»¤
> - [x] å®ç°`blt`æŒ‡ä»¤
> - [x] å®ç°`bltu`æŒ‡ä»¤
>
> `crc32`
>
> - [x] å®ç°`lui`æŒ‡ä»¤$pc==0x80000038
> - [x] å®ç°`srli`æŒ‡ä»¤$pc==0x8000005c
> - [x] å®ç°`slli`æŒ‡ä»¤$pc==0x800000a8
>
> `div`
>
> - [x] å®ç°`mul`æŒ‡ä»¤$pc==0x8000007c
> - [x] å®ç°`div`æŒ‡ä»¤$pc==0x800000a8
>
> `goldbach`
>
> - [x] å®ç°`rem`æŒ‡ä»¤$pc==0x8000007c
>
> `if-else`
>
> - [x] å®ç°`slt`æŒ‡ä»¤$pc==0x80000084
>
> `load-store`
>
> - [x] å®ç°`lh`æŒ‡ä»¤$pc==80000064ï¼ˆç¬¦å·æ‹“å±•ï¼Œåº”è¯¥æ˜¯ä»16ä½æ‹“å±•åˆ°64ä½ï¼‰
>
> `mersenne`
>
> - [x] å®ç°`mulh`æŒ‡ä»¤$pc==0x80000098
> - [x] å®ç°`remu`æŒ‡ä»¤$pc==0x8000018c
> - [x] å®ç°`divu`æŒ‡ä»¤$pc==0x80000198
>
> `movsx`
>
> - [x] å®ç°`srai`æŒ‡ä»¤$pc==0x80000098ï¼ˆç¬¦å·æ‹“å±•ï¼Œåº”å…ˆå°†src1å€¼ä½æ‰©å±•åå†ç§»åŠ¨ï¼‰
>
> `mul-longlong`
>
> è¿™ä¸ªæ–‡ä»¶ä¼¼ä¹æœ‰é—®é¢˜:
>
> å½“`i`å’Œ`j`å‡ä¸º0æ—¶ï¼Œ
>
> ```C
> int test_data[0] = 0xaeb1c2aaï¼›
> long long ans[0] = 0x19d29ab9db1a18e4LL
> long long result = mul(test_data[0],test_data[0]);//0x7736 200D DB1A 18E4
> check(ans[0] == result);	
> ```
>
> å¾ˆæ˜æ˜¾ä¸¤ä¸ªæ•°çš„é«˜32ä½ä¸åŒã€‚
>
> `shift`
>
> - [x] å®ç°`sra`æŒ‡ä»¤$pc==0x800000a8
> - [x] å®ç°`srl`æŒ‡ä»¤$pc==0x800000e0

## ç¨‹åº, è¿è¡Œæ—¶ç¯å¢ƒä¸AM

ä¸»çº¿ä»»åŠ¡ï¼š

- é€šè¿‡æ‰¹å¤„ç†æ¨¡å¼è¿è¡ŒNEMU:é˜…è¯»NEMUçš„ä»£ç å¹¶åˆé€‚åœ°ä¿®æ”¹Makefile, ä½¿å¾—é€šè¿‡AMçš„Makefileå¯ä»¥é»˜è®¤å¯åŠ¨æ‰¹å¤„ç†æ¨¡å¼çš„NEMU.
- å®ç°`abstract-machine/klib/src/string.c`ä¸­åˆ—å‡ºçš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°, è®©`cpu-tests`ä¸­çš„æµ‹è¯•ç”¨ä¾‹`string`å¯ä»¥æˆåŠŸè¿è¡Œ
- å®ç°åº“å‡½æ•°`sprintf()`ï¼Œé€šè¿‡æµ‹è¯•ç”¨ä¾‹`hello-str`

æ”¯çº¿ä»»åŠ¡ï¼š

- é€šè¿‡RTFSCå’ŒRTFMæ¥ç†è§£ä¸‹å·§å¦™çš„`abstract-machine`é¡¹ç›®çš„Makefileæ˜¯å¦‚ä½•å·¥ä½œçš„
- é˜…è¯»[Undefined Behavior: What Happened to My Code?](https://homes.cs.washington.edu/~akcheung/papers/apsys12.pdf)

ä¸€äº›é˜…è¯»æ—¶å€™çš„æ€è€ƒã€‚

> - æ¶æ„å’Œç¨‹åºè§£è€¦çš„æ€è€ƒï¼š`n`ä¸ªç¨‹åºè¿è¡Œåœ¨`m`ä¸ªæ¶æ„ä¸Šï¼Œç»ˆæ­¢æŒ‡ä»¤ä¸åŒï¼Œéš¾é“è¦ç»´æŠ¤`n*m`ä»½ä»£ç ï¼Ÿ
>
>   ç­”ï¼šä¾‹å¦‚å¯¹`m`ä¸ªæ¶æ„çš„ç»ˆæ­¢æ–¹å¼ç»Ÿä¸€æŠ½è±¡ä¸ºä¸€ä¸ªæ¥å£`halt()`ï¼Œåªéœ€è¦ç»´æŠ¤`m`ä¸ªæ¶æ„çš„å…·ä½“ç»ˆæ­¢æ¥å£`halt()`å³å¯
>
> - å¦‚æœç¨‹åºéœ€è¦å¤§é‡çš„æ¶æ„åŠŸèƒ½å®ç°çš„æ¥å£æ€ä¹ˆåŠï¼Ÿ
>
>   ç­”ï¼šå°†ç¨‹åºæ‰€éœ€è¦çš„æ¶æ„æ¥å£ï¼ŒæŠ½è±¡ä¸ºAPIåï¼Œé›†åˆä¸ºä¸€ä¸ªåº“
>
> - è¿™æ ·æŠ½è±¡çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ
>
>   ç­”ï¼šä¸åŒçš„ç¨‹åºä¸éœ€è¦å®ç°å¯¹åº”æ¶æ„çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œå‡å°‘äº†ä»£ç é‡ã€‚é™ä½äº†ç»´æŠ¤æˆæœ¬
>
> - AMæ˜¯ä»€ä¹ˆï¼Ÿ
>
>   ç­”ï¼šæŠ½è±¡è®¡ç®—æœºã€‚å°†ç¡¬ä»¶çš„åŠŸèƒ½æ‰“åŒ…æˆæ¥å£ï¼Œæ–¹ä¾¿ç¨‹åºè¿è¡Œæ—¶å€™è°ƒç”¨ã€‚æ»¡è¶³äº†ç¨‹åºè¿è¡Œå¯¹è®¡ç®—æœºçš„éœ€æ±‚
>
> - PAåˆ°åº•æƒ³å®ç°ä»€ä¹ˆï¼Ÿ
>
>   ç­”ï¼šæ¨¡æ‹Ÿè®¡ç®—æœºç¡¬ä»¶ï¼ˆcpuã€å†…å­˜ç­‰ï¼‰ï¼Œç„¶åå†å®ç°AMï¼Œé€šè¿‡ä¸¤è€…é…åˆä¸ºç¨‹åºçš„è¿è¡Œä¿é©¾æŠ¤èˆª

### AM - è£¸æœº(bare-metal)è¿è¡Œæ—¶ç¯å¢ƒ

> AM(Abstract machine)é¡¹ç›®å°±æ˜¯è¿™æ ·è¯ç”Ÿçš„. ä½œä¸ºä¸€ä¸ªå‘ç¨‹åºæä¾›è¿è¡Œæ—¶ç¯å¢ƒçš„åº“, AMæ ¹æ®ç¨‹åºçš„éœ€æ±‚æŠŠåº“åˆ’åˆ†æˆä»¥ä¸‹æ¨¡å—
>
> ```text
> AM = TRM + IOE + CTE + VME + MPE
> ```
>
> - TRM(Turing Machine) - å›¾çµæœº, æœ€ç®€å•çš„è¿è¡Œæ—¶ç¯å¢ƒ, ä¸ºç¨‹åºæä¾›åŸºæœ¬çš„è®¡ç®—èƒ½åŠ›
> - IOE(I/O Extension) - è¾“å…¥è¾“å‡ºæ‰©å±•, ä¸ºç¨‹åºæä¾›è¾“å‡ºè¾“å…¥çš„èƒ½åŠ›
> - CTE(Context Extension) - ä¸Šä¸‹æ–‡æ‰©å±•, ä¸ºç¨‹åºæä¾›ä¸Šä¸‹æ–‡ç®¡ç†çš„èƒ½åŠ›
> - VME(Virtual Memory Extension) - è™šå­˜æ‰©å±•, ä¸ºç¨‹åºæä¾›è™šå­˜ç®¡ç†çš„èƒ½åŠ›
> - MPE(Multi-Processor Extension) - å¤šå¤„ç†å™¨æ‰©å±•, ä¸ºç¨‹åºæä¾›å¤šå¤„ç†å™¨é€šä¿¡çš„èƒ½åŠ› (MPEè¶…å‡ºäº†ICSè¯¾ç¨‹çš„èŒƒå›´, åœ¨PAä¸­ä¸ä¼šæ¶‰åŠ)
>
> AMç»™æˆ‘ä»¬å±•ç¤ºäº†ç¨‹åºä¸è®¡ç®—æœºçš„å…³ç³»: åˆ©ç”¨è®¡ç®—æœºç¡¬ä»¶çš„åŠŸèƒ½å®ç°AM, ä¸ºç¨‹åºçš„è¿è¡Œæä¾›å®ƒä»¬æ‰€éœ€è¦çš„è¿è¡Œæ—¶ç¯å¢ƒ.

è€Œæ€ä¹ˆç†è§£ä¸‹é¢è¿™æ®µè¯ï¼Œå°±å¾ˆæœ‰æ„æ€äº†ğŸ˜€

> å®ç°NEMUï¼ˆç¡¬ä»¶ï¼‰å’ŒAMï¼ˆè½¯ä»¶ï¼‰ä¹‹é—´çš„**æ¡¥æ¢**æ¥æ”¯æ’‘ç¨‹åºçš„è¿è¡Œï¼Œæ˜¯ç†è§£PAç»ˆæç›®æ ‡â€œç†è§£ç¨‹åºå¦‚ä½•åœ¨è®¡ç®—æœºä¸Šè¿è¡Œâ€çš„å”¯ä¸€é€‰æ‹©ã€‚

- NEMUï¼šæ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿç¡¬ä»¶è¿è¡Œçš„å·¥å…·ï¼Œå®ƒå¯ä»¥æ¨¡æ‹Ÿå‡ºçœŸå®çš„ç¡¬ä»¶ç¯å¢ƒï¼ˆæ¯”å¦‚å¤„ç†å™¨ã€å†…å­˜ç­‰ï¼‰ï¼Œè®©æˆ‘ä»¬åœ¨æ²¡æœ‰çœŸå®ç¡¬ä»¶çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è¿è¡Œå’Œæµ‹è¯•ç¨‹åºã€‚é€šè¿‡ä½¿ç”¨NEMUï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ç¡¬ä»¶å±‚é¢ä¸Šçš„è¿ä½œæœºåˆ¶ã€‚
- AMï¼šæ˜¯è½¯ä»¶å±‚é¢ä¸Šä¸ºç¨‹åºæä¾›ç»Ÿä¸€æ¥å£çš„ç¯å¢ƒã€‚å®ƒè®©ç¨‹åºä¸éœ€è¦ç›´æ¥æ¥è§¦ç¡¬ä»¶ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç»„æŠ½è±¡çš„APIä¸åº•å±‚ç¡¬ä»¶äº¤äº’ã€‚AMç›¸å½“äºåœ¨ç¡¬ä»¶å’Œåº”ç”¨ç¨‹åºä¹‹é—´æ­å»ºäº†ä¸€åº§æ¡¥æ¢ï¼Œå±è”½äº†ç¡¬ä»¶çš„å¤æ‚æ€§ã€‚
- **æ­å»ºæ¡¥æ¢**ï¼šè¦è®©ç¨‹åºèƒ½å¤Ÿé¡ºåˆ©åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å¹¶æ­å»ºNEMUå’ŒAMä¹‹é—´çš„è”ç³»ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯è¦ç†è§£ç¨‹åºå¦‚ä½•é€šè¿‡AMè°ƒç”¨ç¡¬ä»¶èµ„æºï¼ŒNEMUå¦‚ä½•æ¨¡æ‹Ÿç¡¬ä»¶å“åº”ç¨‹åºçš„è¯·æ±‚ã€‚

### RTFSC(3)

> ï¼ˆ`abstract-machine/am/src/platform/nemu/trm.c`ï¼‰`halt()`ä¸­è°ƒç”¨äº†`nemu_trap()`å® (åœ¨`abstract-machine/am/src/platform/nemu/include/nemu.h`ä¸­å®šä¹‰)
>
> è¿™ä¸ªå®å±•å¼€ä¹‹åæ˜¯ä¸€æ¡[å†…è”æ±‡ç¼–](http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html)è¯­å¥. å†…è”æ±‡ç¼–è¯­å¥å…è®¸æˆ‘ä»¬åœ¨Cä»£ç ä¸­åµŒå…¥æ±‡ç¼–è¯­å¥, ä»¥riscv32ä¸ºä¾‹, `nemu_trap(code)`å®å±•å¼€ä¹‹åå°†ä¼šå¾—åˆ°:
>
> ```c
> asm volatile("mv a0, %0; ebreak" : :"r"(code));
> ```
>
> æ˜¾ç„¶, è¿™ä¸ªå®çš„å®šä¹‰æ˜¯å’ŒISAç›¸å…³çš„, å¦‚æœä½ æŸ¥çœ‹`nemu/src/isa/$ISA/inst.c`, ä½ ä¼šå‘ç°è¿™æ¡æŒ‡ä»¤æ­£æ˜¯é‚£æ¡ç‰¹æ®Šçš„`nemu_trap`! `nemu_trap()`å®è¿˜ä¼šæŠŠä¸€ä¸ªæ ‡è¯†ç»“æŸçš„ç»“æŸç ç§»åŠ¨åˆ°é€šç”¨å¯„å­˜å™¨ä¸­, è¿™æ ·, è¿™æ®µæ±‡ç¼–ä»£ç çš„åŠŸèƒ½å°±å’Œ`nemu/src/isa/$ISA/inst.c`ä¸­`nemu_trap`çš„è¡Œä¸ºå¯¹åº”èµ·æ¥äº†: é€šç”¨å¯„å­˜å™¨ä¸­çš„å€¼å°†ä¼šä½œä¸ºå‚æ•°ä¼ ç»™`set_nemu_state()`, å°†`halt()`ä¸­çš„ç»“æŸç è®¾ç½®åˆ°NEMUçš„monitorä¸­, monitorå°†ä¼šæ ¹æ®ç»“æŸç æ¥æŠ¥å‘Šç¨‹åºç»“æŸçš„åŸå› . 

è¿™é‡Œéœ€è¦ææ˜ç™½NEMUåœ¨æ‰§è¡ŒæŒ‡ä»¤`ebreak`çš„æ—¶å€™ï¼Œåˆ°åº•åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ

> æŒ‡ä»¤ä¸å¯¹åº”çš„`ebreak`æ¨¡å¼åŒ¹é…
>
> ```C
> INSTPAT("0000000 00001 00000 000 00000 11100 11", ebreak, N, NEMUTRAP(s->pc, R(10)));
> ```
>
> è€Œå¯¹åº”çš„å®`NEMUTRAP`åœ¨`nemu/include/cpu/cpu.h`ä¸­å®šä¹‰ï¼ˆå¯¹åº”çš„`set_nemu_state`åœ¨`nemu/src/engine/interpreter/hostcall.c`å®šä¹‰ï¼‰
>
> ```C
> void set_nemu_state(int state, vaddr_t pc, int halt_ret) {
>   difftest_skip_ref();
>   nemu_state.state = state;
>   nemu_state.halt_pc = pc;
>   nemu_state.halt_ret = halt_ret;
> }
> #define NEMUTRAP(thispc, code) set_nemu_state(NEMU_END, thispc, code)
> ```
>
> å±•å¼€åä¾¿å¯ä»¥çœ‹åˆ°æ‰§è¡ŒæŒ‡ä»¤`ebreak`çš„æ“ä½œ
>
> ```c
> { const void ** __instpat_end = &&__instpat_end_;
> do {
>   uint64_t key, mask, shift;
>   pattern_decode("0000000 00001 00000 000 00000 11100 11", 38, &key, &mask, &shift);
>   if ((((uint64_t)s->isa.inst.val >> shift) & mask) == key) {
>     {
>       decode_operand(s, &rd, &src1, &src2, &imm, TYPE_N);
>       nemu_state.state = NEMU_END;
>      nemu_state.halt_pc = s->pc;
>       nemu_state.halt_ret = halt_ret;
>     }
>     goto *(__instpat_end);
>   }
> } while (0);
> // ...
> __instpat_end_: ; }
> ```

æ‰€ä»¥AMå®ç°äº†ç»Ÿä¸€çš„ç»ˆæ­¢æ–¹æ³•`halt()`åï¼Œä¼šè‡ªåŠ¨è°ƒç”¨å¯¹åº”NEMUæ¶æ„ä¸‹ï¼ˆæ­¤æ—¶ä¸ºRISCV32ï¼‰çš„ä¸­æ–­æŒ‡ä»¤`ebreak`.

å½“NEMUä¸Šè¿è¡Œçš„ç¨‹åºæƒ³è¦ç»ˆæ­¢è¿›ç¨‹çš„æ—¶å€™ï¼Œå°±å¯ä»¥è°ƒç”¨åº“æ–¹æ³•`halt()`æ¥å®ç°ã€‚è¿™æ ·åšçš„å¥½å¤„å°±ä¸ç”¨ç¨‹åºè€ƒè™‘NEMUçš„å…·ä½“æ¶æ„åŠå…¶å¯¹åº”çš„ç»ˆæ­¢æ–¹æ³•ï¼Œæå‡äº†å¼€å‘æ•ˆç‡ã€‚

è¿™é‡Œå®Œæˆç¬¬ä¸€ä¸ªæ”¯çº¿ä»»åŠ¡ï¼š**é€šè¿‡æ‰¹å¤„ç†æ¨¡å¼è¿è¡ŒNEMU**

> **ä»»åŠ¡**
>
> NEMUä¸­å®ç°äº†ä¸€ä¸ªæ‰¹å¤„ç†æ¨¡å¼, å¯ä»¥åœ¨å¯åŠ¨NEMUä¹‹åç›´æ¥è¿è¡Œå®¢æˆ·ç¨‹åº. è¯·ä½ é˜…è¯»NEMUçš„ä»£ç å¹¶åˆé€‚åœ°ä¿®æ”¹Makefile, ä½¿å¾—é€šè¿‡AMçš„Makefileå¯ä»¥é»˜è®¤å¯åŠ¨æ‰¹å¤„ç†æ¨¡å¼çš„NEMU.
>
> **è§£å†³æ€è·¯**
>
> - NEMUçš„æ‰¹å¤„ç†æ¨¡å¼åœ¨`nemu/src/monitor/sdb/sdb.c`ä¸­å®šä¹‰
>
>   ```C
>   static int is_batch_mode = false;
>   
>   void sdb_set_batch_mode() {
>     is_batch_mode = true;
>   }
>   ```
>
>   å¹¶ä¸”åœ¨NEMUçš„ç®€æ˜“è°ƒè¯•å™¨(Simple Debugger)ä¸»å¾ªç¯`sdb_mainloop()` (åœ¨`nemu/src/monitor/sdb/sdb.c`ä¸­å®šä¹‰)ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ‰¹å¤„ç†æ¨¡å¼å¦‚ä½•å½±å“æ‰§è¡Œç¨‹åºçš„ã€‚
>
>   ```C
>   void sdb_mainloop() {
>     if (is_batch_mode) {
>       cmd_c(NULL);
>       return;
>     }
>     //...
>   }
>   ```
>
> - æ ¹æ®ä¸Šé¢æä¾›çš„ä¿¡æ¯ï¼Œè¦æƒ³"é€šè¿‡AMçš„Makefileå¯ä»¥é»˜è®¤å¯åŠ¨æ‰¹å¤„ç†æ¨¡å¼çš„NEMU"ï¼Œå°±éœ€è¦ä¿®æ”¹AMçš„Makefileä¸­çš„å¯åŠ¨NEMUçš„å‘½ä»¤ã€‚
>
>   ç›´æ¥åœ¨Makefileçš„ç¼–è¯‘é€‰é¡¹`CFLAGS`ä¸­ï¼ŒåŠ å…¥æ‰¹å¤„ç†çš„å®`BATCH_MODE`
>
>   ```makefile
>   CFLAGS += -DBATCH_MODE
>   ```
>
>   è¿™æ ·å³å¯æ ¹æ®`BATCH_MODE`æ˜¯å¦å®šä¹‰æ¥ç¡®å®šæ­¤ç¨‹åºæ˜¯å¦ä¸ºAMç¼–è¯‘çš„ã€‚
>
>   éšååœ¨å‡½æ•°`engine_start()`ï¼ˆåœ¨`nemu/src/engine/interpreter/init.c`å®šä¹‰ï¼‰ä¸­ï¼Œæ·»åŠ å¯¹äºæ‰¹å¤„ç†æ¨¡å¼çš„è¯†åˆ«
>
>   ```C
>   void engine_start() {
>   #ifdef CONFIG_TARGET_AM
>     cpu_exec(-1);
>   #else
>     /* Receive commands from user. */
>   #ifdef BATCH_MODE
>     sdb_set_batch_mode();
>   #endif
>     sdb_mainloop();
>   #endif
>   }
>   ```
>
>   ç­‰åç»­ç¼–è¯‘å®Œæˆåå†æ¥éªŒè¯æ˜¯å¦æ­£ç¡®ã€‚//TODO

è€Œåœ¨å®ç°ä¸»çº¿ä»»åŠ¡çš„æ—¶å€™ï¼Œæœ‰å‡ ä¸ªCè¯­è¨€çš„å°æŠ€å·§å¸®åŠ©äº†æˆ‘å¾ˆå¤šï¼Œåœ¨æ­¤è®°å½•ä¸‹ï¼š

- ä»¥å­—èŠ‚ä¸ºå•ä½ç´¢å¼•åŒºåŸŸ`s`

  ```C
  unsigned char *p = s;
  ```

- å†…å­˜é‡å ï¼šä»åå¾€å‰å¤åˆ¶å³å¯

  ```C
  unsigned char *d = dest;
  const unsigned char *s = src;
  
  *(--d) = *(--s);
  ```

- å°†æ•°å­—çš„ä¸ªä½è½¬æ¢ä¸ºå¯¹åº”çš„å­—ç¬¦ä¸²

  ```c
  char a = (num % 10) + '0';
  ```

> :flags:æˆªè‡³2024å¹´10æœˆ17å·ï¼Œå·²å®Œæˆæ­¤å°ç»“ä¸»çº¿ä»»åŠ¡ 

##  åŸºç¡€è®¾æ–½(2)

ä¸»çº¿ä»»åŠ¡ï¼š

- å®ç°æŒ‡ä»¤ç¯å½¢ç¼“å†²åŒºiringbuf
- å®ç°mtrace
- å®ç°ftrace
-  å®ç°DiffTest
- åœ¨`am-kernels/tests/`ç›®å½•ä¸‹æ–°å¢ä¸€ä¸ªé’ˆå¯¹klibçš„æµ‹è¯•é›†`klib-tests`
- åœ¨Kconfigå’Œç›¸å…³æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„ä»£ç , ä½¿å¾—å¯ä»¥é€šè¿‡menuconfigæ¥æ‰“å¼€æˆ–è€…å…³é—­mtrace

æ”¯çº¿ä»»åŠ¡ï¼š

- å¦‚ä½•è‡ªå®šä¹‰è¾“å‡ºtraceçš„æ¡ä»¶ï¼Ÿ
- ç†è§£å¦‚ä½•ç”Ÿæˆnativeçš„å¯æ‰§è¡Œæ–‡ä»¶
- å°è¯•ä¸º`klib-tests`æ·»åŠ é’ˆå¯¹ç¬¬äºŒç±»åªè¯»å‡½æ•°çš„æµ‹è¯•, ä¾‹å¦‚`memcmp()`, `strlen()`ç­‰
- å°è¯•ä¸º`klib-tests`æ·»åŠ é’ˆå¯¹æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°çš„æµ‹è¯•. ä½ å¯ä»¥å…ˆé€šè¿‡`sprintf()`æŠŠå®é™…è¾“å‡ºæ‰“å°åˆ°ä¸€ä¸ªç¼“å†²åŒºä¸­, ç„¶åé€šè¿‡`strcmp()`æ¥å’Œé¢„æœŸè¾“å‡ºè¿›è¡Œå¯¹æ¯”.
- æ•æ‰æ­»å¾ªç¯(æœ‰ç‚¹éš¾åº¦)

###  bugè¯Šæ–­çš„åˆ©å™¨ - è¸ªè¿¹

#### itrace

1. è¸ªè¿¹åŠŸèƒ½ -- NEMUå¦‚ä½•è®°å½•`inst_fetch()`å–åˆ°çš„æ¯ä¸€æ¡æŒ‡ä»¤çš„

é¦–å…ˆçœ‹ä¸‹`build/nemu-log.txt`åœ¨æ‰§è¡Œé»˜è®¤ç¨‹åºçš„æ—¶å€™ï¼Œè®°å½•çš„å†…å®¹

```bash
^[[1;34m[src/monitor/monitor.c:29 welcome] If trace is enabled, a log file will be generated to record the trace. This may lead to a large log file. If it is not necessary, you can disable it in menuconfig^[[0m
^[[1;34m[src/monitor/monitor.c:32 welcome] Build time: 17:00:42, Sep 10 2024^[[0m
0x80000000: 00 00 02 97 auipc t0, 0
0x80000004: 00 02 88 23 sb  zero, 16(t0)
0x80000008: 01 02 c5 03 lbu a0, 16(t0)
0x8000000c: 00 10 00 73 ebreak
^[[1;34m[src/cpu/cpu-exec.c:130 cpu_exec] nemu: ^[[1;32mHIT GOOD TRAP^[[0m at pc = 0x8000000c^[[0m
```

è€Œè¿™ä¸ªè®°å½•åŠŸèƒ½ï¼Œå°±åœ¨cpuæ‰§è¡Œä¸€æ¡æŒ‡ä»¤çš„å‡½æ•°`exec_once()`ä¸­å®ç°çš„

```C
static void exec_once(Decode *s, vaddr_t pc) {
  s->pc = pc;
  s->snpc = pc;
  isa_exec_once(s);
  cpu.pc = s->dnpc;
#ifdef CONFIG_ITRACE
  /*
  	å®ç°çš„å…·ä½“é€»è¾‘
  */
#endif
#endif
}
```

cpuæ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤å¹¶æ›´æ–°pcåï¼Œä¾¿ä¼šæ ¹æ®æ˜¯å¦è®¾ç½®`CONFIG_ITRACE`æ¥åšå·²æ‰§è¡ŒæŒ‡ä»¤çš„è®°å½•åŠŸèƒ½ã€‚

æˆ‘ä»¬å•ç‹¬çœ‹ä¸‹å…·ä½“çš„è®°å½•é€»è¾‘

```C
#ifdef CONFIG_ITRACE
  char *p = s->logbuf;
  // logè®°å½•åˆšæ‰æ‰§è¡ŒæŒ‡ä»¤çš„pcå€¼
  p += snprintf(p, sizeof(s->logbuf), FMT_WORD ":", s->pc);
  int ilen = s->snpc - s->pc;  					// æŒ‡ä»¤çš„å­—èŠ‚æ•°
  int i;
  uint8_t *inst = (uint8_t *)&s->isa.inst.val;  // æŒ‰ç…§å­—èŠ‚é¡ºåºè®¿é—®æ­¤æŒ‡ä»¤
  for (i = ilen - 1; i >= 0; i --) {
    p += snprintf(p, 4, " %02x", inst[i]);		// æŒ‰ç…§å­—èŠ‚é¡ºåºæ‰“å°æ­¤æŒ‡ä»¤çš„åå…­è¿›åˆ¶å€¼
  }

  // logåŠ  space_len ä¸ªç©ºæ ¼çš„é—´éš”
  int ilen_max = MUXDEF(CONFIG_ISA_x86, 8, 4);
  int space_len = ilen_max - ilen;
  if (space_len < 0) space_len = 0;
  space_len = space_len * 3 + 1;
  memset(p, ' ', space_len);
  p += space_len;
  
  // logåŠ å…¥åæ±‡ç¼–çš„ç»“æœ
  /* å‚æ•°åŒ…æ‹¬
  
  	p: æŒ‡å‘æ—¥å¿—ç¼“å†²åŒºçš„æŒ‡é’ˆ
    s->logbuf + sizeof(s->logbuf) - p: æŒ‡å®šå¯ç”¨çš„ç¼“å†²åŒºå¤§å°
    MUXDEF(CONFIG_ISA_x86, s->snpc, s->pc): æŒ‡å®šç¨‹åºè®¡æ•°å™¨
    (uint8_t *)&s->isa.inst.valï¼šæŒ‡å‘å½“å‰æŒ‡ä»¤çš„ä»£ç 
    ilen:æŒ‡ä»¤çš„å­—èŠ‚æ•°
  */
  void disassemble(char *str, int size, uint64_t pc, uint8_t *code, int nbyte);
  disassemble(p, s->logbuf + sizeof(s->logbuf) - p,
      MUXDEF(CONFIG_ISA_x86, s->snpc, s->pc), (uint8_t *)&s->isa.inst.val, ilen);
#endif
```

å¯¹äºå…¶ä¸­çš„

```c
void disassemble(char *str, int size, uint64_t pc, uint8_t *code, int nbyte);
```

è¿™æ˜¯ä¸€ä¸ªå‡½æ•°å£°æ˜ï¼Œæ„å‘³ç€ `disassemble` å‡½æ•°åœ¨å…¶ä»–åœ°æ–¹å·²ç»å®šä¹‰ã€‚æ­¤å¤„çš„å£°æ˜å‘Šè¯‰ç¼–è¯‘å™¨è¯¥å‡½æ•°çš„å‚æ•°å’Œè¿”å›ç±»å‹ï¼Œä½†å¹¶ä¸æä¾›å…¶å®ç°ã€‚

è€Œå½“ç¼–è¯‘å™¨çœ‹åˆ°ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥ä¼ é€’ç»™è¯¥å‡½æ•°çš„å‚æ•°ç±»å‹æ˜¯å¦ä¸å‡½æ•°å£°æ˜ä¸­å®šä¹‰çš„å‚æ•°ç±»å‹åŒ¹é…ã€‚å¦‚æœä¸åŒ¹é…ï¼Œç¼–è¯‘å™¨ä¼šå‘å‡ºé”™è¯¯æç¤ºã€‚è¿™æœ‰åŠ©äºæ•è·æ½œåœ¨çš„é”™è¯¯ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯çš„å¯èƒ½æ€§ã€‚

2. å¦‚ä½•è‡ªå®šä¹‰è¾“å‡ºtraceï¼Ÿ

å›é¡¾`si`å’Œ`c`å‡ä¼šè°ƒç”¨å‡½æ•°`cpu_exec(n)`æ¥å®ç°å¯¹åº”çš„åŠŸèƒ½ï¼Œè€Œå·®å¼‚å°±åœ¨`n`çš„å¤§å°ä¸Šã€‚

æ‰§è¡Œä¸€æ¡æŒ‡ä»¤`si`çš„æ—¶å€™ï¼Œä¼šæ‰“å°å½“å‰æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œè€Œä½¿ç”¨`c`æ‰§è¡Œå®Œæ¯•ç¨‹åºæ‰€æœ‰æŒ‡ä»¤çš„æ—¶å€™ï¼Œåè€Œä¸ä¼šè¾“å‡ºæŒ‡ä»¤ã€‚

æˆ‘ä»¬æ¢ç©¶ä¸‹æŒ‡ä»¤çš„æ•°é‡å¦‚ä½•å½±å“traceçš„è¾“å‡ºã€‚

1. è°ƒç”¨å‡½æ•°`cpu_exec()`ï¼š

   ```c
   g_print_step = (n < MAX_INST_TO_PRINT);
   ```

   `n`è‹¥å°äº`MAX_INST_TO_PRINT`ï¼Œåˆ™`g_print_step`è¢«èµ‹å€¼ä¸º`1`.

   `n`è‹¥å¤§äº`MAX_INST_TO_PRINT`ï¼Œåˆ™`g_print_step`è¢«èµ‹å€¼ä¸º`0`.

   è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œ`c`ä¼šæ‰§è¡Œ`cpu_exec(-1)`ï¼Œè€Œ`-1`çš„æ— ç¬¦å·æ•°è¦å¤§äº`MAX_INST_TO_PRINT`ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´è¿™ä¸ªå€¼å§‹ç»ˆä¸º0.

2. è°ƒç”¨`trace_and_difftest()`

   ```C
   if (g_print_step) { IFDEF(CONFIG_ITRACE, puts(_this->logbuf));
   ```

   è¿™æ ·å°±å¯ä»¥å¾—å‡ºæŒ‡ä»¤çš„æ•°é‡`n`ä¼šå½±å“traceçš„è¾“å‡ºäº†ã€‚

è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰è¾“å‡ºtraceçš„æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•æ—¥åç”¨åˆ°å†è¯•ã€‚

#### iringbuf

1. å¦‚ä½•åˆ¤æ–­å¼‚å¸¸æ‰§è¡Œï¼Ÿ

æˆ‘ä»¬çœ‹ä¸‹`cpu_exec()`åœ¨æ‰§è¡ŒæŒ‡ä»¤çš„æ—¶å€™ï¼Œå¯¹äºå¼‚å¸¸çŠ¶æ€çš„å¤„ç†

```c
// .... 
case NEMU_END: case NEMU_ABORT:
      Log("nemu: %s at pc = " FMT_WORD,
          (nemu_state.state == NEMU_ABORT ? ANSI_FMT("ABORT", ANSI_FG_RED) :
           (nemu_state.halt_ret == 0 ? ANSI_FMT("HIT GOOD TRAP", ANSI_FG_GREEN) :
            ANSI_FMT("HIT BAD TRAP", ANSI_FG_RED))),
          nemu_state.halt_pc);
// ....
```

å¯ä»¥çœ‹å‡ºå½“å‰çŠ¶æ€å¦‚æœä¸æ˜¯`NEMU_ABORT`ï¼ŒåŒæ—¶`nemu_state.halt_ret`ä¸ä¸º0æ—¶ï¼Œåˆ™ä¼šæ‰“å°`HIT BAD TRAP`

æ‰€ä»¥è¿™ä¸ªæ¡ä»¶å°±æ˜¯ç¨‹åºæ‰§è¡Œå‡ºé”™çš„æ¡ä»¶ã€‚

2. å¦‚ä½•è·å–æœ€è¿‘æ‰§è¡Œçš„è‹¥å¹²æ¡æŒ‡ä»¤ï¼Ÿ

åœ¨riscv-32çš„ä½“ç³»ç»“æ„ä¸­ï¼Œæ¯æ¡æŒ‡ä»¤é•¿åº¦ä¸º4ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥å¾—çŸ¥å½“å‰pcå€¼ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸Šä¸€æ¡æŒ‡ä»¤çš„pcå€¼ï¼›åä¹‹ï¼Œä¹Ÿå¯ä»¥å¾—åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„pcå€¼ã€‚å¾—çŸ¥æŒ‡ä»¤çš„pcå€¼åï¼Œå°±å¯ä»¥é€šè¿‡ä¸`itrace`ç›¸åŒçš„åŠæ³•è¾“å‡ºè¿™äº›æŒ‡ä»¤äº†ã€‚

3. ç¯å½¢ç¼“å†²åŒºçš„æ•°æ®ç»“æ„å±æ€§æ˜¯ä»€ä¹ˆï¼Ÿ

å¸¦å¤´å’Œå°¾èŠ‚ç‚¹çš„é“¾è¡¨ã€‚

4. ç¯å½¢ç¼“å†²åŒºçš„éœ€æ±‚æ¢³ç†

å¦‚æœå®¢æˆ·ç¨‹åºå‡ºé”™ï¼Œåˆ™è¾“å‡ºç¯å½¢ç¼“å†²åŒºçš„å†…å®¹

å¦‚æœå®¢æˆ·ç¨‹åºæ­£å¸¸ï¼Œåˆ™ç»´æŠ¤ç¯å½¢ç¼“å†²åŒºçš„å†…å®¹

æ ¹æ®æ‰§è¡ŒæŒ‡ä»¤çš„pcå€¼ç»´æŠ¤ç¼“å†²åŒºï¼š

- è·å–å½“å‰æŒ‡ä»¤ä¿¡æ¯
- ~~è·å–åé¢çš„æŒ‡ä»¤ä¿¡æ¯~~
- ä¿¡æ¯åŠ å…¥åˆ°ç¯å½¢ç¼“å†²åŒºçš„å°¾éƒ¨

5. å®ç°ç¯å½¢ç¼“å†²åŒºçš„æ•°æ®ç»“æ„

æ»¡å‘˜åï¼Œæ–°å¢æ•°æ®åœ¨å°¾éƒ¨ï¼Œç§»é™¤çš„æ•°æ®åœ¨å‰æ–¹ï¼Œå…¸å‹çš„é˜Ÿåˆ—

å®ç°æ€è·¯æ˜¯å®šä¹‰ä¸€ä¸ªæ–‡ä»¶`iringbuf.c`å•ç‹¬å­˜æ”¾ä¸ç¯å½¢ç¼“å†²åŒºçš„ä»£ç ã€‚æˆªè‡³æ™šä¸Š23ç‚¹35åˆ†ï¼Œå†™å®Œå¹¶ä¸”æµ‹è¯•å®Œæ¯•ã€‚

æ–‡ä»¶`iringbuf.c`çš„å®ç°ï¼š

```c
#define IRINGBUF_MAX_LEN 10
typedef struct Node {
	char message[128];
	struct Node *next;
} Node;

typedef struct {
	Node *head;
	Node *tail;
	int count; // é“¾è¡¨å…ƒç´ çš„æ•°é‡
} iringbuf;

// å‡½æ•°å£°æ˜
void init_ringbuf(iringbuf *rb);
void pop(iringbuf *rb);
void push(iringbuf *rb, const char *msg);
void destroy_ringbuf(iringbuf *rb);
void print_ringbuf(iringbuf *rb);

// å‡½æ•°å®ç°
void init_ringbuf(iringbuf *rb) {
	rb->head = NULL;
	rb->tail = NULL;
	rb->count = 0;
}

// åˆ é™¤é˜Ÿåˆ—çš„é¦–å…ƒç´ 
void pop(iringbuf *rb) {
	if(rb->count == 0) return;

	Node *temp = rb->head;			// ä¿å­˜å½“å‰å¤´èŠ‚ç‚¹
	rb->head = rb->head->next;	// æ›´æ–°å¤´èŠ‚ç‚¹ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹

	if (rb->head == NULL) {			// ä»…æœ‰ä¸€ä¸ªå…ƒç´ ä¸”åˆ é™¤åï¼Œå°¾èŠ‚ç‚¹ä¹Ÿä¸ºç©º
		rb->tail = NULL;
	}

	rb->count--;
	free(temp);

}

// åœ¨ç¼“å†²åŒºæœ«å°¾ä¿å­˜æŒ‡ä»¤ä¿¡æ¯
void push(iringbuf *rb, const char *msg) {
	Node *new_node = (Node *) malloc(sizeof(Node));	// åˆ†é…æ–°èŠ‚ç‚¹å†…å­˜

	// å¦‚æœå·²ç»è¾¾åˆ°ç¼“å†²åŒºæœ€å¤§å®¹çº³é‡
	if (rb->count == IRINGBUF_MAX_LEN) {
		pop(rb);		// åˆ é™¤ç¼“å†²åŒºä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤ä¿¡æ¯
	}

	// åœ¨æœ«å°¾æ·»åŠ æ–°çš„å¸¦æœ‰ä¿¡æ¯èŠ‚ç‚¹
	strncpy(new_node->message, msg, sizeof(new_node->message));	// å¤åˆ¶ä¿¡æ¯
	new_node->next = NULL;

	if (rb->count == 0) { // å¦‚æœç¼“å†²åŒºåªæœ‰æ­¤ä¸€æ¡æ–°ä¿¡æ¯ï¼Œåˆ™é¦–å°¾çš†æ›´æ”¹ä¸ºæ­¤ä¿¡æ¯
		rb->head = new_node;
		rb->tail = new_node;
	} else {
		rb->tail->next = new_node;	// æ—§å°¾èŠ‚ç‚¹åæ·»åŠ æ­¤èŠ‚ç‚¹
		rb->tail = new_node;				// æ›´æ–°å°¾èŠ‚ç‚¹æŒ‡é’ˆ
	}

	rb->count++;

}

void destroy_ringbuf(iringbuf *rb) {
	while( rb->count > 0 ) {
		pop(rb);
	}
}

void print_ringbuf(iringbuf *rb) {
	// è·å–ç¼“å†²åŒºçš„é¦–å…ƒç´ åœ°å€
	Node *temp = rb->head;

	for (int i = 0; i < rb->count; i++) {
		// æœ€åä¸€ä¸ªå…ƒç´ çš„ç‰¹æ®Šè¾“å‡º
		if(i == rb->count - 1) {
			printf("  --> ");
		} else {
			printf("      ");
		}

		// è¾“å‡ºå½“å‰å…ƒç´ çš„ä¿¡æ¯
		printf("%s\n", temp->message);
		temp = temp->next;	// æ›´æ–°ä¸´æ—¶èŠ‚ç‚¹ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹
	}
}
```

#### ftrace

ç”±äºè‡ªå·±å¯¹äºNEMUçš„Makefileå­¦ä¹ ä¸å¤Ÿæ·±å…¥ï¼Œå¯¹äºå¾ˆå¤šç»†èŠ‚ä¸å¤Ÿäº†è§£ï¼Œå¯¼è‡´åšäº†3å¤©ä¹Ÿæ²¡æ•´å‡ºä¸ªæ‰€ä»¥ç„¶æ¥ã€‚è¿™é‡Œå°±è´´ä¸€ä¸‹è¿™ä½å¤§ä½¬çš„[å®ç°](https://www.cnblogs.com/nosae/p/17066439.html#%E5%AE%9E%E7%8E%B0ftrace)ï¼ŒåŸºäºè‡ªå·±çš„ç†è§£ï¼Œå†™ä¸€å†™è‡ªå·±çš„å®ç°ä¹‹è·¯ã€‚è‡ªç„¶è‡ªå·±çš„å¾ˆå¤šä»£ç ä¹Ÿå‚è€ƒäº†è¿™ä½å¤§ä½¬çš„ä»£ç å®ç°ï¼Œæ”¾ä¸€ä¸‹å¤§ä½¬çš„åšå®¢ï¼š**[NOSAE's Blog](https://www.cnblogs.com/nosae)**

ftraceå› ä¸ºæ¶‰åŠåˆ°ç›‘æ§æŒ‡ä»¤æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦æ”¾åœ¨`monitor`ä¸­å»å®ç°ã€‚æ‰€ä»¥åœ¨`nemu/src/monitor/`ä¸‹ï¼Œæ–°å»ºä¸“é—¨å¤„ç†ä¸ftraceæœ‰å…³çš„æ–‡ä»¶`ftrace.c`ã€‚

`ftrace.c`çš„å­˜åœ¨ä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š

- æä¾›ç»™ç›‘è§†å™¨ï¼Œç”¨æ¥è§£æELFæ–‡ä»¶çš„å‡½æ•°
- æä¾›ç»™è¯‘ç å™¨ï¼Œç”¨æ¥è®°å½•å‡½æ•°è°ƒç”¨å’Œè¿”å›æŒ‡ä»¤ä¿¡æ¯çš„å‡½æ•°

```C
static uint32_t call_depth = 0;
static uint32_t trace_func_call_flag = 0; // Flag to determine whether to trace function calls

void parse_elf(const char *elf_file) {
  if (elf_file == NULL) {
    return;
  }
  Log("The elf file is %s\n", elf_file);
  trace_func_call_flag = 1;
  FILE *file = fopen(elf_file, "rb");
  assert(file != NULL);

  init_symtab_entrys(file);
}
void trace_func_call(paddr_t pc, paddr_t target) {
  if (trace_func_call_flag == 0) return; //No elf file
  ++call_depth;

  if (call_depth <= 2) return; // ignore _trm_init & main

  char *name  = get_function_name_by_addres(target);
  // Example output: 0x800001f8:     call [f0@0x80000010]
  ftrace_write(FMT_PADDR ": %*scall [%s@" FMT_PADDR "]\n",
    pc,
    (call_depth-3)*2, "",
    name?name:"???",
    target
  );
}

void trace_func_ret(paddr_t pc) {
  if (trace_func_call_flag == 0) return; //No elf file
  if (call_depth <= 2) return; // ignore _trm_init & main

  char *name = get_function_name_by_addres(pc);
  ftrace_write(FMT_PADDR ": %*sret [%s]\n",
    pc,
    (call_depth-3)*2, "",
    name?name:"???"
  );
    
  --call_depth;
}
```

åŸºæœ¬å‡½æ•°æ¡†æ¶ç¡®å®šåï¼Œä¸‹ä¸€æ­¥å°±éœ€è¦åœ¨`nemu/src/monitor/monitor.c`ä¸­ï¼ŒåŠ å…¥è§£æELFæ–‡ä»¶çš„å‡½æ•°`parse_elf`

```c
static char *elf_file = NULL;

void parse_elf(const char *elf_file);

static int parse_args(int argc, char *argv[]) {
  const struct option table[] = {
    {"elf"      , required_argument, NULL, 'e'},
  };
  int o;
  while ( (o = getopt_long(argc, argv, "-bhl:d:p:e:", table, NULL)) != -1) {
    switch (o) {
      case 'e': elf_file = optarg; break;
      default:
        printf("\t-e,--elf=FILE           elf file to be parsed\n");
    }
  }
  return 0;
}
            
void init_monitor(int argc, char *argv[]) {
  /* Initialize elf. */
  parse_elf(elf_file);
}
```

ç”±äºè¿è¡Œ`nemu`çš„å‘½ä»¤å’Œå‚æ•°æ˜¯åœ¨Makefileä¸­ç”Ÿæˆçš„ï¼Œå› æ­¤ä¿®æ”¹`$AM_HOME/scripts/platform/nemu.mk`ï¼Œç»™`NEMUFLAGS`å˜é‡æ·»åŠ `-e`å‚æ•°ï¼Œè¿è¡Œæ¨¡æ‹Ÿå™¨æ—¶å°±ä¼šåŠ ä¸Šè¿™ä¸ªå‚æ•°ï¼Œä»è€Œä¸€æ­¥æ­¥ä¼ å…¥`parse_args`ä¸­è¿›è¡Œè§£æ

```c
NEMUFLAGS += -l $(shell dirname $(IMAGE).elf)/nemu-log.txt
NEMUFLAGS += -e $(IMAGE).elf
```

ftraceçš„æœ€åä¸€æ­¥ä¾¿æ˜¯åœ¨è¯‘ç é˜¶æ®µï¼Œåˆ¤æ–­ä¸ºè°ƒç”¨æˆ–è¿”å›æŒ‡ä»¤æ—¶å€™ï¼Œè°ƒç”¨ftraceè®°å½•å‡½æ•°ï¼ˆè¯‘ç å®ç°åœ¨`nemu/src/isa/riscv32/inst.c`ï¼‰

```c
static int decode_exec(Decode *s) {
  //.....
  INSTPAT_START();
  INSTPAT("??????? ????? ????? ??? ????? 11011 11", jal     , J, { R(rd) = s->pc + 4; s->dnpc = s->pc + imm; IFDEF(CONFIG_ITRACE, {
    if (rd == 1) {  					// x1($ra): stores return value
      trace_func_call(s->pc,  s->dnpc);
      }
    })
  });

  INSTPAT("??????? ????? ????? 000 ????? 11001 11", jalr    , I, { R(rd) = s->pc + 4; s->dnpc = (src1 + imm) & ~1; IFDEF(CONFIG_ITRACE, {
    if (s->isa.inst.val == 0x00008067) { // ret: jalr x0, 0(x1)
      trace_func_ret(s->pc);
    }
  }
  )});
  INSTPAT_END();
  R(0) = 0; // reset $zero to 0
  return 0;
}
```

å®ç°`ftrace.c`å‰©ä½™çš„[è¾…åŠ©å‡½æ•°](https://github.com/CharlieCRX/pa/blob/pa2/nemu/src/monitor/ftrace/ftrace.c)åï¼Œftraceå®ç°çš„æ¡†æ¶å°±å¯ä»¥è¿è¡Œäº†ã€‚

å› ä¸ºæ¶‰åŠåˆ°ELFæ–‡ä»¶çš„å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡ŒæŒ‰ç…§`man 5 elf`çš„ä¿¡æ¯ï¼Œå†™äº†ä¸€ä¸ª[å°ç¨‹åº](https://github.com/CharlieCRX/pa/blob/pa2/nemu/src/monitor/ftrace/test.c)æ¥å¤„ç†ELFæ–‡ä»¶ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æ¥çœ‹ä¸‹ã€‚

### Differential Testing

DiffTestçš„æ€æƒ³ç†è®ºåŸºç¡€ï¼š æ‰¾ä¸€ä¸ªæ­£ç¡®çš„å®ç°, è·Ÿå®ƒå¯¹æ¯”ç»“æœ.

DiffTeståº”ç”¨äºNEMUçš„å®è·µåˆ™æ˜¯ï¼šNEMUæ¨¡æ‹Ÿå‡ºäº†ä¸€ä¸ªriscv32çš„ç¡¬ä»¶ç³»ç»Ÿï¼Œæ­¤ä¸ºæµ‹è¯•å¯¹è±¡ï¼ˆDUTï¼‰ï¼›ç„¶åæ‰¾ä¸€ä¸ªå·²ç»æˆåŠŸå®ç°çš„riscv32æ¶æ„çš„ç¡¬ä»¶ç³»ç»Ÿï¼ˆè¿™é‡Œæ˜¯riscv32æ¨¡æ‹Ÿå™¨`Spike`ï¼Œåœ¨PAä¸­åˆç§°ä¹‹ä¸ºçœŸæœºï¼‰ï¼Œä½œä¸ºå‚è€ƒå®ç°ï¼ˆREFï¼‰

è€ŒNEMUç¡¬ä»¶ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µï¼Œåˆå¯ä»¥è¢«çŠ¶æ€æœºç†è®ºæŠ½è±¡ä¸ºä¸€ä¸ªçŠ¶æ€äºŒå…ƒç»„`S = <R, M>`ã€‚è¿™æ ·å°±é€šè¿‡å¯¹æ¯”ä¸¤ä¸ªç³»ç»Ÿçš„å¯„å­˜å™¨å’Œå†…å­˜çŠ¶æ€ï¼Œå°±å¯ä»¥å¾—çŸ¥ä¸¤ä¸ªç³»ç»Ÿæ˜¯å¦è¿è¡Œä¸€è‡´ã€‚

è¿™æ ·ä¸¤å¥—ç³»ç»Ÿæ‰§è¡Œç›¸åŒæŒ‡ä»¤åï¼Œè§‚å¯Ÿä¸¤ä¸ªç³»ç»Ÿçš„çŠ¶æ€æ˜¯å¦ä¸€è‡´ï¼Œå³å¯å¾—çŸ¥æµ‹è¯•å¯¹è±¡æ˜¯å¦å¾—åˆ°äº†æ­£ç¡®çš„ç»“æœã€‚

å®ç°`isa_difftest_checkregs()`å‡½æ•°ï¼ˆåœ¨`nemu/src/isa/riscv32/difftest/dut.c`ä¸­å®šä¹‰ï¼‰

```C
bool isa_difftest_checkregs(CPU_state *ref_r, vaddr_t pc) {
  if(cpu.pc == ref_r->pc) {
    for(int i = 0; i < MUXDEF(CONFIG_RVE, 16, 32); i++) {
      if (gpr(i) != ref_r->gpr[i]) {
        return false;
      }
    }
  }
  return true;
}
```

è€Œæœ€ç»ˆçš„å›å½’æµ‹è¯•ï¼Œè¢«`mulh`çš„è¯‘ç å›°ä½äº†ã€‚

ä¸€å¼€å§‹æˆ‘ä½¿ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢æ¥è·å¾—æœ‰ç¬¦å·ä¹˜æ³•çš„é«˜32ä½ï¼š

```c
R(rd) = (int64_t) src1 *(int64_t) src2 >> 32
```

ä½†æ˜¯ç»“æœä»ç„¶ä¸å¯¹ï¼ŒçŒœæµ‹æ˜¯NEMUåœ¨è¿™é‡Œé™åˆ¶äº†å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚

ç„¶åå°†æœ‰ç¬¦å·æ•°çš„ä¹˜æ³•ï¼Œå˜æˆé«˜ä½çš„æ— ç¬¦å·æ•°ä¹˜æ³•ï¼š

```c
R(rd) = SEXT(src1, 32) * SEXT(src2, 32) >> 32
```

è¿™æ ·å°±å¯ä»¥é€šè¿‡æµ‹è¯•äº†ã€‚å…¶ä»–æŒ‡ä»¤çš„å®ç°è¯·çœ‹[è¿™é‡Œ](https://github.com/CharlieCRX/pa/blob/pa2/nemu/src/isa/riscv32/inst.c#L83)

PA2.2é˜¶æ®µç”¨æ—¶17å¤©ï¼Œæ•ˆç‡æ…¢çš„åŸå› åœ¨äºï¼š

- é—·å¤´ç¼–å†™ä»£ç ï¼šftraceçš„å®ç°ï¼Œéå¸¸ä¾èµ–å¯¹äºé¡¹ç›®æ¶æ„çš„ç†è§£ã€‚Makefileä¸ä¼šç›´æ¥STFW
- å®Œç¾ä¸»ä¹‰ï¼šæ€»æƒ³å†™æ¼‚äº®ä»£ç ï¼Ÿå…ˆè®©ä½ çš„æ€è·¯æ­£å¸¸è·‘é€šå§~

PA2é˜¶æ®µ2åˆ°æ­¤ç»“æŸ.ï¼ˆ10.28-22ï¼š28ï¼‰

### ä¸²å£

**NEMUä¸²å£å¦‚ä½•è¾“å‡ºå­—ç¬¦**

é¦–å…ˆçœ‹ä¸‹ï¼Œåœ¨`AM`ä¸­ï¼Œè¾“å‡ºä¸€ä¸ªå­—ç¬¦åšäº†ä»€ä¹ˆï¼Ÿ

1. `am-kernels/kernels/hello/hello.c`ï¼šè°ƒç”¨`AM`çš„`TRM`éƒ¨åˆ†å®šä¹‰çš„`putch()`å‡½æ•°è¾“å‡ºå­—ç¬¦

2. `abstract-machine/am/src/platform/nemu/trm.c`ï¼šè°ƒç”¨é’ˆå¯¹`riscv`æ¶æ„çš„æ•°æ®å†™å…¥æŒ‡ä»¤`outb()`

   ```c
   void putch(char ch) {
     outb(SERIAL_PORT, ch); // SERIAL_PORT = (DEVICE_BASE + 0x00003f8) 
     //abstract-machine\am\src\platform\nemu\include\nemu.h
   }
   ```

   è€Œ`SERIAL_PORT`ï¼ˆåœ¨`abstract-machine\am\src\platform\nemu\include\nemu.h`å®šä¹‰ï¼‰ä¸º

   ```c
   #define DEVICE_BASE 0xa0000000
   #define SERIAL_PORT = (DEVICE_BASE + 0x00003f8) 
   ```

3. `am/src/riscv/riscv.h`ï¼šå®šä¹‰`outb()`ä¸º

   ```c
   void outb(uintptr_t addr, uint8_t  data) { *(volatile uint8_t  *)addr = data; }
   ```

   å³å°†`addr`å¤„çš„ä¸€ä¸ªå­—èŠ‚ä¿å­˜æ•°æ®`data`

æ‰€ä»¥è¿è¡Œåœ¨ç‰¹å®šæ¶æ„`riscv32-nemu`çš„`AM`ä¸­ï¼Œè°ƒç”¨å‡½æ•°`putch()`è¾“å‡ºä¸€ä¸ªå­—ç¬¦çš„ç»“æœï¼Œæ˜¯å°†ä¸€ä¸ªå­—ç¬¦ä¿å­˜åˆ°åœ°å€ä¸º`0x0xa00003f8`çš„ç©ºé—´ä¸­ã€‚

ç„¶åæˆ‘ä»¬å†çœ‹ä¸‹NEMUå¯¹äºä¸²å£ç¡¬è®¾å¤‡çš„ç®¡ç†ï¼ˆåœ¨`nemu/src/device/serial.c`ä¸­å®šä¹‰ï¼‰

ä»ä¸²å£åˆå§‹åŒ–å‡½æ•°`init_serial()`å¯ä»¥å¾—çŸ¥çš„å‡ ä¸ªä¿¡æ¯:

- æ³¨å†Œ`0x3F8`å¤„é•¿åº¦ä¸º8ä¸ªå­—èŠ‚çš„ç«¯å£
- æ³¨å†Œ`0xa00003F8`å¤„é•¿åº¦ä¸º8å­—èŠ‚çš„MMIOç©ºé—´
- ä¸¤ä¸ªæ³¨å†Œéƒ½ä¼šæ˜ å°„åˆ°ä¸²å£çš„æ•°æ®å¯„å­˜å™¨`serial_base`

ä¸²å£åˆå§‹åŒ–å‡½æ•°ï¼Œè¯´æ˜ä¸²å£æ•°æ®å¯„å­˜å™¨ï¼Œä¼šè¢«æ˜ å°„åˆ°å†…å­˜åœ°å€ä¸º`0xa00003F8`å¤„ã€‚è€Œæ­¤åœ°å€æ°å¥½æ˜¯åŸºäº`riscv32-nemu`çš„AMè¾“å‡ºå­—ç¬¦æ—¶ï¼Œå°†å­—ç¬¦ä¿å­˜èµ·æ¥çš„åœ°å€ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨NEMUè¿è¡Œçš„ç¨‹åºï¼Œè¾“å‡ºä¸€ä¸ªå­—ç¬¦çš„æ­¥éª¤ä¸ºï¼š

- è°ƒç”¨AMçš„`TRM`æ¨¡å—æä¾›çš„å­—ç¬¦è¾“å‡ºå‡½æ•°`putch()`
- `putch()`çš„å®ç°ä¾èµ–äºæ¶æ„`riscv32-nemu`ï¼Œå…·ä½“å®ç°å°±æ˜¯é€šè¿‡`outb()`å°†å­—ç¬¦ä¿å­˜åˆ°ä¸²å£æ•°æ®å¯„å­˜å™¨ä¸­

è€Œä¸²å£æ•°æ®å¯„å­˜å™¨æ‹¿åˆ°å­—ç¬¦åï¼Œåˆ™ä¼šæ‰§è¡Œç›¸åº”çš„é€»è¾‘å°†å­—ç¬¦æ‰“å°ã€‚è¿™å°±æ˜¯è¾“å‡ºä¸€ä¸ªå­—ç¬¦çš„æµç¨‹ã€‚

**å¯å˜å‚æ•°å‡½æ•°çš„å¤„ç†**

```c
#include <stdio.h>
#include <stdarg.h>

// ç¤ºä¾‹å‡½æ•°ï¼Œè®¡ç®—ä¼ å…¥çš„æ•´æ•°ä¹‹å’Œ
int sum(int count, ...) {
    va_list args;       // å®šä¹‰å¯å˜å‚æ•°åˆ—è¡¨
    va_start(args, count); // åˆå§‹åŒ– argsï¼Œcount æ˜¯æœ€åä¸€ä¸ªå›ºå®šå‚æ•°

    int total = 0;
    for (int i = 0; i < count; i++) {
        total += va_arg(args, int); // è·å–ä¸‹ä¸€ä¸ªå‚æ•°ï¼Œç±»å‹ä¸º int
    }

    va_end(args); // æ¸…ç† va_list
    return total;
}

int main() {
    int result = sum(4, 1, 2, 3, 4); // è®¡ç®— 1 + 2 + 3 + 4
    printf("Sum: %d\n", result); // è¾“å‡ºç»“æœ
    return 0;
}
```

- ä½¿ç”¨ `va_start(args, count);` åˆå§‹åŒ– `args`ï¼Œä»¥ä¾¿å¯ä»¥ä»å‡½æ•°å‚æ•°ä¸­è·å–å¯å˜å‚æ•°ã€‚`count` æ˜¯æœ€åä¸€ä¸ªå›ºå®šå‚æ•°ã€‚
- ä½¿ç”¨å¾ªç¯å’Œ `va_arg(args, int)` è·å–å¯å˜å‚æ•°ã€‚`va_arg` å°†è¿”å›ä¸‹ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°ç±»å‹ç”±ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šï¼ˆåœ¨è¿™é‡Œæ˜¯ `int`ï¼‰ã€‚
- ä½¿ç”¨ `va_end(args);` æ¸…ç† `va_list`ï¼Œé‡Šæ”¾ç›¸å…³èµ„æºã€‚

**å…³äºsprintf()å’Œprintf()çš„åŠŸèƒ½æ€è€ƒ**

```c
int sprintf(char *out, const char *fmt, ...);
```

- å¤„ç†æ ¼å¼åŒ–å­—ç¬¦ä¸²
- å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¼ å…¥åˆ°`out`åŒºåŸŸ
- è¿”å›å­—ç¬¦çš„æ•°é‡

```c
int printf(const char *fmt, ...);
```

- å¤„ç†æ ¼å¼åŒ–å­—ç¬¦ä¸²
- å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¼ å…¥åˆ°ä¸²å£
- è¿”å›å­—ç¬¦çš„æ•°é‡

æ‰€ä»¥ä¸¤è€…è€¦åˆçš„éƒ¨åˆ†æ˜¯å¤„ç†æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å¤„ç†çš„ä»£ç å’Œè·å–å­—ç¬¦çš„æ•°é‡ä»£ç ã€‚

å¤„ç†æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ä»£ç å¯ä»¥æŠ½è±¡ä¸ºä¸€ä¸ªå‡½æ•°ï¼š

```c
int process_format_string(char *out, const char *fmt, va_list args);
```

æ­¤å‡½æ•°è¾“å…¥å­—ç¬¦ä¸²è¾“å‡ºçš„ç¼“å†²åŒºæŒ‡é’ˆ`out`ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²`fmt`ä»¥åŠå¯¹åº”çš„å¯å˜å‚æ•°`args`ï¼›è¾“å‡ºå¤„ç†æ ¼å¼åŒ–é€»è¾‘åçš„å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚å‡½æ•°å…·ä½“å®ç°æ”¾åœ¨[è¿™é‡Œ](https://github.com/CharlieCRX/pa/blob/pa2/abstract-machine/klib/src/stdio.c)

### æ—¶é’Ÿ

è§£æ`nemu\src\device\timer.c`

- `init_timer()`å°†æ—¶é’Ÿè®¾å¤‡æ³¨å†Œåˆ°æ˜ å°„ç»“æ„ä½“æ•°ç»„`map[]`ä¸­ã€‚æ³¨å†Œåçš„æ—¶é’Ÿè®¾å¤‡çš„æ˜ å°„å‚æ•°:
  - `name`ï¼šæ—¶é’Ÿè®¾å¤‡æ˜ å°„çš„åå­—`rtc`
  - `low`ï¼šæ˜ å°„çš„èµ·å§‹åœ°å€ï¼Œä¸º`CONFIG_RTC_MMIO`(0xa0000048)
  - `high`ï¼šæ˜ å°„çš„ç»“æŸåœ°å€ï¼Œä¸º`CONFIG_RTC_MMIO + 8`(0xa000004f)
  - `space`ï¼šæ˜ å°„çš„ç›®æ ‡ç©ºé—´ä¸ºæ—¶é’Ÿæ•°æ®å¯„å­˜å™¨`rtc_port_base`
  - `callback`ï¼šå›è°ƒå‡½æ•°`rtc_io_handler`
- `rtc_io_handler()`ï¼šè¯»å–AMç³»ç»Ÿ64ä½çš„å¯åŠ¨æ—¶é—´ï¼Œå¹¶å°†å…¶å†™å…¥åˆ°`rtc_port_base`çš„8ä¸ªå­—èŠ‚ä¸­ã€‚

å½“CPUè®¿é—®åœ°å€`[0xa0000048, 0xa000004f]`çš„æ—¶å€™ï¼ˆè°ƒç”¨`map_read()`ï¼‰ï¼Œä¼šè°ƒç”¨å‡½æ•°`rtc_io_handler()`ï¼Œç„¶åæ—¶é’Ÿæ•°æ®å¯„å­˜å™¨`rtc_port_base`å°†å¯åŠ¨æ—¶é—´è®°å½•ä¸‹æ¥ï¼Œç›¸å½“äºè®¿é—®æ—¶é’Ÿè¿›è¡ŒçŠ¶æ€çš„æ›´æ–°ã€‚

å½“ç¨‹åºè·å–ç³»ç»Ÿå¯åŠ¨æ—¶é—´æµç¨‹ï¼š

1. è°ƒç”¨klibä¸­æä¾›çš„`io_read()`å®ï¼Œè®¿é—®æ—¶é’Ÿè®¾å¤‡`AM_TIMER_UPTIME`ä¿å­˜çš„å¯åŠ¨æ—¶é—´ä¿¡æ¯ã€‚

2. `io_read`ä½¿ç”¨AMæä¾›çš„è®¾å¤‡è®¿é—®å‡½æ•°`ioe_read()`ï¼Œè®¿é—®ç¼–å·ä¸º`AM_TIMER_UPTIME`æ‰€ä»£è¡¨çš„æ—¶é’Ÿè®¾å¤‡

   ```c
   enum { AM_TIMER_UPTIME = 6};
   typedef struct { uint64_t us; } AM_TIMER_UPTIME_T
       
   uint64_t io_read(AM_TIMER_UPTIME) 
     ({ AM_TIMER_UPTIME_T __io_param; 
       ioe_read(AM_TIMER_UPTIME, &__io_param); 
       __io_param; })
   ```

3. `ioe_read()`è°ƒç”¨æ—¶é’Ÿå¯¹åº”çš„å‡½æ•°`__am_timer_uptime`ï¼ˆåœ¨`abstract-machine\am\src\platform\nemu\ioe\timer.c`å®šä¹‰ï¼‰

   ```c
   void __am_timer_uptime(&__io_param) {
       __io_param->us = 0; //TODO
   }
   ```

åŸºäº`riscv32-nemu`çš„AMï¼Œå¯ä»¥é€šè¿‡MMIOçš„æ–¹å¼ï¼Œåœ¨å†…å­˜`0xa0000048`å¤„è®¿é—®åˆ°æ˜ å°„åˆ°æ—¶é’Ÿæ•°æ®å¯„å­˜å™¨çš„æ•°æ®ã€‚

éœ€è¦æ³¨æ„ä¸‰ä¸ªç‚¹ä¸º

1. nemuçš„æ—¶é’Ÿè®¾å¤‡ç”¨ä¸¤ä¸ª32ä½çš„å¯„å­˜å™¨`rtc_port_base[2]`ä¿å­˜ä¸€ä¸ª64ä½çš„æ—¶é—´æ•°æ®

   ```c
   uint64_t us = get_time();
   rtc_port_base[0] = (uint32_t)us;	// 0xa0000048 å­˜æ”¾usä½32ä½
   rtc_port_base[1] = us >> 32;		// 0xa000004C å­˜æ”¾usé«˜32ä½
   ```

   æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯»å–ä¸¤æ¬¡4å­—èŠ‚çš„æ•°æ®ï¼Œç„¶åç»„è£…æ—¶é—´æ•°æ®ã€‚

2. åŸºäºriscvçš„æ•°æ®è¯»å–é•¿åº¦ä¸º4ä¸ªå­—èŠ‚çš„æŒ‡ä»¤ä¸º`inl`ï¼ˆåœ¨`abstract-machine\am\src\riscv\riscv.h`å®šä¹‰ï¼‰

   ```c
   static inline uint32_t inl(uintptr_t addr) { return *(volatile uint32_t *)addr; }
   ```

3. æ—¶é’Ÿæ•°æ®å¯„å­˜å™¨æ˜ å°„åˆ°å†…å­˜çš„åœ°å€ä¸º`CONFIG_RTC_MMIO`ï¼ˆåœ¨`abstract-machine\am\src\platform\nemu\include\nemu.h`å®šä¹‰ï¼‰

   ```c
   #define RTC_ADDR        (DEVICE_BASE + 0x0000048)
   ```

åŸºäºä¸Šé¢çš„è®¤è¯†ï¼Œå®ç°`AM_TIMER_UPTIME`çš„åŠŸèƒ½ï¼š

```c
void __am_timer_uptime(AM_TIMER_UPTIME_T *uptime) {
  uint64_t us = 0;
  uint32_t us_high = inl(RTC_ADDR + 4);
  uint32_t us_low  = inl(RTC_ADDR);
  us = (uint64_t)us_low | ((uint64_t)us_high << 32);
  uptime->us = us;
}
```

è¿è¡Œæµ‹è¯•ï¼ˆåˆ†æå‚æ•°`mainargs`å¦‚ä½•å½±å“ç¨‹åºæ‰§è¡Œçš„ï¼Ÿï¼‰

```makefile
make ARCH=riscv32-nemu run mainargs='t'
```

è¿è¡Œåå‘ç°æœ‰æµ®ç‚¹æº¢å‡ºï¼Œç»è¿‡æ£€æŸ¥å‘ç°æ›´æ–°æ—¶é’Ÿæ•°æ®å¯„å­˜å™¨çš„ç»†èŠ‚ï¼š

```c
static void rtc_io_handler(uint32_t offset, int len, bool is_write) {
  assert(offset == 0 || offset == 4);
  if (!is_write && offset == 4) {
    uint64_t us = get_time();
    rtc_port_base[0] = (uint32_t)us;
    rtc_port_base[1] = us >> 32;
  }
}
```

### é”®ç›˜

`abstract-machine/am/include/amdev.h`ä¸­ä¸ºé”®ç›˜çš„åŠŸèƒ½å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡å¯„å­˜å™¨:

- `AM_INPUT_KEYBRD`, AMé”®ç›˜æ§åˆ¶å™¨, å¯è¯»å‡ºæŒ‰é”®ä¿¡æ¯. `keydown`ä¸º`true`æ—¶è¡¨ç¤ºæŒ‰ä¸‹æŒ‰é”®, å¦åˆ™è¡¨ç¤ºé‡Šæ”¾æŒ‰é”®. `keycode`ä¸ºæŒ‰é”®çš„æ–­ç , æ²¡æœ‰æŒ‰é”®æ—¶, `keycode`ä¸º`AM_KEY_NONE`

å½“CPUè®¿é—®é”®ç›˜æ•°æ®å¯„å­˜å™¨çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆä¸æ—¶é’Ÿç±»ä¼¼ï¼‰

1. è°ƒç”¨klibä¸­æä¾›çš„`io_read()`å®ï¼Œè®¿é—®AMé”®ç›˜æ§åˆ¶å™¨`AM_INPUT_KEYBRD`ä¸­ä¿å­˜çš„æŒ‰é”®ä¿¡æ¯

2. å®å±•å¼€ä½¿ç”¨AMæä¾›çš„è®¾å¤‡è®¿é—®å‡½æ•°`ioe_read()`ï¼Œè®¿é—®ç¼–å·ä¸º`AM_INPUT_KEYBRD`æ‰€ä»£è¡¨çš„é”®ç›˜æ§åˆ¶å™¨

   ```c
   enum { AM_INPUT_KEYBRD = (8) }; 
   typedef struct { bool keydown; int keycode; } AM_INPUT_KEYBRD_T;
       
   uint64_t io_read(AM_INPUT_KEYBRD) 
     ({ AM_INPUT_KEYBRD_T __io_param; 
       ioe_read(AM_INPUT_KEYBRD, &__io_param); 
       __io_param; })
   ```

3. `ioe_read()`è°ƒç”¨è·å–é”®ç›˜æ§åˆ¶å™¨ä¿¡æ¯çš„å‡½æ•°`__am_input_keybrd`ï¼ˆåœ¨`abstract-machine\am\src\platform\nemu\ioe\input.c`ä¸­å®šä¹‰ï¼‰

æˆ‘ä»¬è¦æƒ³å®ç°è¯»å–é”®ç›˜çš„æ•°æ®ï¼Œå°±è¦çœ‹ä¸‹åŸºäºNEMUæ¶æ„çš„é”®ç›˜æ•°æ®å¯„å­˜å™¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼ˆåœ¨`nemu\src\device\keyboard.c`ä¸­å®šä¹‰ï¼‰

```c
static uint32_t *i8042_data_port_base = NULL;

static void i8042_data_io_handler(uint32_t offset, int len, bool is_write) {
  assert(!is_write);
  assert(offset == 0);
  i8042_data_port_base[0] = key_dequeue();
}
```

å½“è®¿é—®é”®ç›˜æ•°æ®å¯„å­˜å™¨çš„æ—¶å€™ï¼Œé”®ç›˜æ§åˆ¶å™¨ä¼šåœ¨è¯»å‘½ä»¤çš„çŠ¶æ€ä¸‹ï¼Œä»ç»´æŠ¤çš„æŒ‰é”®é˜Ÿåˆ—ä¸­è¯»å–ä¸€ä¸ª4å­—èŠ‚çš„æ•°æ®ã€‚è€Œ

é”®ç›˜äº‹ä»¶çš„ç»´æŠ¤æ˜¯é€šè¿‡é”®ç›˜æ§åˆ¶å™¨çš„å‡½æ•°`send_key()`å®ç°çš„ï¼š

```c
#define KEYDOWN_MASK 0x8000

void send_key(uint8_t scancode, bool is_keydown) {
  // NEMUåœ¨æ­£å¸¸çŠ¶æ€`NEMU_RUNNING`è¿è¡Œå¹¶ä¸”é”®å…¥çš„æ‰«æç `scancode`åœ¨é”®ç›˜æ˜ å°„è¡¨`keymap`ä¸­å¯¹åº”æœ‰æ•ˆçš„é”®å€¼ã€‚
  if (nemu_state.state == NEMU_RUNNING && keymap[scancode] != NEMU_KEY_NONE) {
    // æ„é€ ä¸€ä¸ªæ‰©å±•çš„æ‰«æç  am_scancode
    uint32_t am_scancode = keymap[scancode] | (is_keydown ? KEYDOWN_MASK : 0);
    // å†™å…¥é”®ç›˜äº‹ä»¶é˜Ÿåˆ—
    key_enqueue(am_scancode);
  }
}
```

- `scancode`ï¼šè¡¨ç¤ºé”®äº‹ä»¶çš„åŸå§‹æ‰«æç ã€‚
- `is_keydown`ï¼šå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ­¤äº‹ä»¶æ˜¯æŒ‰ä¸‹ï¼ˆtrueï¼‰è¿˜æ˜¯æŠ¬èµ·ï¼ˆfalseï¼‰
- æ„é€ æ‹“å±•çš„æ‰«æç 
  - `keymap[scancode]` å–å‡ºå¯¹åº”çš„é”®å€¼
  - å¦‚æœ `is_keydown` ä¸º `true`ï¼Œåˆ™æŒ‰ä¸‹çš„é”®ä¼šè¢«åŠ ä¸Šè¿™ä¸ªæ©ç ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæŒ‰ä¸‹äº‹ä»¶ï¼›å¦‚æœä¸º `false`ï¼Œåˆ™æ˜¯æŠ¬èµ·äº‹ä»¶ã€‚
  - ä½¿ç”¨ä½è¿ç®—å°† `KEYDOWN_MASK`ï¼ˆç”¨äºæ ‡è¯†æŒ‰é”®æŒ‰ä¸‹çš„çŠ¶æ€ï¼Œåœ¨NEMUä¸­ä¸º`0x8000`ï¼‰ä¸ `keymap[scancode]` ç»“åˆã€‚

è¿™æ ·é”®ç›˜æ•°æ®å¯„å­˜å™¨ä¸­ä¿å­˜çš„ä¸€ä¸ªé”®ç›˜äº‹ä»¶ï¼Œå°±æ˜¯ä¸€ä¸ªæ‹“å±•åçš„4å­—èŠ‚æ‰«æç æ•°æ®ã€‚æŒ‰ç…§æ„é€ æ‰«æç çš„é€»è¾‘ï¼Œé€šè¿‡ä¸€ä¸ªé”®ç›˜äº‹ä»¶ï¼Œè·å–é”®å€¼`keycode`å’Œåˆ¤æ–­æ˜¯å¦æŒ‰é”®æŒ‰ä¸‹çš„ä¿¡æ¯é€»è¾‘ä¸ºï¼š

```c
// è·å–ä¸€ä¸ªé”®ç›˜äº‹ä»¶
uint32_t k = key_dequeue();

bool keydown = (k & KEYDOWN_MASK ? true : false);
uint32_t keycode = k &  ~KEYDOWN_MASK;
```

### VGA	

ä»NEMUè¿›è¡Œvgaè®¾å¤‡çš„åˆå§‹åŒ–æµç¨‹ï¼š

```c
#define SCREEN_W 400
#define SCREEN_H 300

static uint32_t screen_width() {
  return SCREEN_W;
}

static uint32_t screen_height() {
  return SCREEN_H;
}

static uint32_t screen_size() {
  return screen_width() * screen_height() * sizeof(uint32_t);
}

void init_vga() {
  // åˆå§‹åŒ–VGAæ˜¾ç¤ºæ§åˆ¶å™¨æ•°æ®ï¼Œå°† vgactl çš„æ§åˆ¶å¯„å­˜å™¨æ˜ å°„åˆ°å†…å­˜åœ°å€[0xa0000100,0xa0000108]
  vgactl_port_base = (uint32_t *)new_space(8);
  vgactl_port_base[0] = (screen_width() << 16) | screen_height();
  
  add_mmio_map("vgactl", CONFIG_VGA_CTL_MMIO, vgactl_port_base, 8, NULL);

  // åˆ†é…æ˜¾ç¤ºå†…å­˜.å°† vmem æ˜ å°„åˆ°å†…å­˜åœ°å€[0xa1000000ï¼Œ 0xa1000008]
  vmem = new_space(screen_size());
  add_mmio_map("vmem", CONFIG_FB_ADDR, vmem, screen_size(), NULL);
  init_screen();
  memset(vmem, 0, screen_size());
}
```

æœ¬èŠ‚è¦å®ç°ä¸¤ä¸ªå…³äºGPUçš„æŠ½è±¡å¯„å­˜å™¨ï¼ˆä¸NEMUè¾“å‡ºè®¾å¤‡VAGå…³è”ï¼‰ï¼š

- `AM_GPU_CONFIG`, AMæ˜¾ç¤ºæ§åˆ¶å™¨ä¿¡æ¯, å¯è¯»å‡ºå±å¹•å¤§å°ä¿¡æ¯`width`å’Œ`height`. 
- `AM_GPU_FBDRAW`, AMå¸§ç¼“å†²æ§åˆ¶å™¨, å¯å†™å…¥ç»˜å›¾ä¿¡æ¯, å‘å±å¹•`(x, y)`åæ ‡å¤„ç»˜åˆ¶`w*h`çš„çŸ©å½¢å›¾åƒ. å›¾åƒåƒç´ æŒ‰è¡Œä¼˜å…ˆæ–¹å¼å­˜å‚¨åœ¨`pixels`ä¸­, æ¯ä¸ªåƒç´ ç”¨32ä½æ•´æ•°ä»¥`00RRGGBB`çš„æ–¹å¼æè¿°é¢œè‰². è‹¥`sync`ä¸º`true`, åˆ™é©¬ä¸Šå°†å¸§ç¼“å†²ä¸­çš„å†…å®¹åŒæ­¥åˆ°å±å¹•ä¸Š.

é¦–å…ˆåˆ†æ`AM_GPU_CONFIG`å¯„å­˜å™¨éœ€è¦çš„æ•°æ®åœ¨VGAçš„å“ªäº›å¯„å­˜å™¨ä¸­ï¼š

```C
typedef struct { bool present, has_accel; int width, height, vmemsz; } AM_GPU_CONFIG_T;
```

- `width`ï¼š  å±å¹•å®½åº¦	-->  VGAæ˜¾ç¤ºæ§åˆ¶å™¨å¯„å­˜å™¨`vgactl_port_base`çš„`screen_width`
- `height`ï¼šå±å¹•é«˜åº¦        --> VGAæ˜¾ç¤ºæ§åˆ¶å™¨å¯„å­˜å™¨`vgactl_port_base`çš„`screen_height`
- `vmemsz`ï¼šæ˜¾å­˜å¤§å°        --> æ˜¾å­˜`vmem`çš„`screen_size`

```c
void __am_gpu_config(AM_GPU_CONFIG_T *cfg) {
  *cfg = (AM_GPU_CONFIG_T) {
    .present = true, .has_accel = false,
    .width = 0, .height = 0,
    .vmemsz = 0
  };
}
```

å†åˆ†æ`AM_GPU_FBDRAW`çš„é€»è¾‘ï¼Œçœ‹ä¸‹VGAåŒæ­¥å¯„å­˜å™¨åœ¨å“ªé‡Œï¼š

```C
#define SYNC_ADDR (VGACTL_ADDR + 4)

void __am_gpu_fbdraw(AM_GPU_FBDRAW_T *ctl) {
  if (ctl->sync) {
    outl(SYNC_ADDR, 1);
  }
}
```

ç»“åˆVGAéƒ¨åˆ†åˆ·æ–°å±å¹•çš„ä»£ç `vga_update_screen`ï¼š

```c
void vga_update_screen() {
  // TODO: call `update_screen()` when the sync register is non-zero,
  // then zero out the sync register
}
```

å¯ä»¥æ¨æ–­å‡ºVGAåŒæ­¥å¯„å­˜å™¨å­˜åœ¨äºVGAæ˜¾ç¤ºæ§åˆ¶å™¨ä¸Šï¼Œä¸”ä½äºé«˜4å­—èŠ‚ã€‚æ˜ å°„äºå†…å­˜ä½ç½®ä¸º`[0xa0000104,0xa0000108]`ã€‚

è‡³æ­¤2024å¹´11æœˆ2å·ï¼Œå®Œç»“PA2.3(10.29-11.2)
