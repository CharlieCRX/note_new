# PA1ï¼šæœ€ç®€å•çš„è®¡ç®—æœº

## è®¡ç®—æœºé‡‡ç”¨æŒ‡ä»¤åºåˆ—æ‰§è¡Œ

å°†Cè¯­è¨€ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶åï¼Œå…¶æœ¬è´¨æ˜¯å°†å…¶åŒ–ä¸ºäº†ä¸€æ¡æ¡çš„æŒ‡ä»¤ã€‚ä»æ­¤ä»¥å, è®¡ç®—æœºå°±åªéœ€è¦åšä¸€ä»¶äº‹æƒ…:

```c
while (1) {
  ä»PCæŒ‡ç¤ºçš„å­˜å‚¨å™¨ä½ç½®å–å‡ºæŒ‡ä»¤;
  æ‰§è¡ŒæŒ‡ä»¤;
  æ›´æ–°PC;
}
```

é‚£ä¹ˆä¸ºä»€ä¹ˆCPUä¸ç›´æ¥å®ç°Cè¯­è¨€çš„åŠŸèƒ½ï¼Œè€Œæ˜¯åšâ€œæŒ‡ä»¤â€è¿™æ ·çš„äº‹æƒ…å‘¢ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼Œå®ƒè§¦åŠäº†è®¡ç®—æœºç§‘å­¦ä¸­æœ€æ ¸å¿ƒçš„æ¦‚å¿µä¹‹ä¸€ï¼š**æŠ½è±¡ï¼ˆAbstractionï¼‰**ã€‚

- CPUä¹‹æ‰€ä»¥åªåšâ€œæŒ‡ä»¤â€è¿™æ ·çš„äº‹æƒ…ï¼Œæ˜¯å› ä¸ºå®ƒè¿½æ±‚çš„æ˜¯**æœ€åŸºç¡€ã€æœ€å¿«é€Ÿã€æœ€é€šç”¨ã€æœ€å¯æ§**çš„è®¡ç®—å•å…ƒã€‚
- è€ŒCè¯­è¨€è¿™æ ·çš„é«˜çº§è¯­è¨€ï¼Œè¿½æ±‚çš„æ˜¯**å¼€å‘æ•ˆç‡ã€ä»£ç å¯è¯»æ€§ã€è·¨å¹³å°æ€§**ã€‚
- **ç¼–è¯‘å™¨**å°±æ˜¯è¿æ¥è¿™ä¸¤è€…ä¹‹é—´çš„æ¡¥æ¢ã€‚å®ƒå°†ç¨‹åºå‘˜ç”¨Cè¯­è¨€è¡¨è¾¾çš„å¤æ‚æ„å›¾ï¼Œç¿»è¯‘æˆCPUèƒ½å¤Ÿç†è§£å’Œæ‰§è¡Œçš„ä¸€ç³»åˆ—ç®€å•æŒ‡ä»¤ã€‚

å¹¶ä¸”å¦‚æœCPUç›´æ¥å®ç°Cè¯­è¨€çš„åŠŸèƒ½ï¼Œå°±ä¼šè¢«è¯­è¨€ç²’åº¦ç»™æ‹–ç´¯ï¼šå®ç°æŒ‡é’ˆã€å†…å­˜ç®¡ç†ã€å˜é‡ç­‰ã€‚å¯¼è‡´ç”µè·¯è®¾è®¡å¤æ‚ï¼ŒåæœŸCPUå‡çº§è¾ƒä¸ºå›°éš¾ã€‚å¹¶ä¸”æ¯æ¬¡Cè¯­è¨€æ ‡å‡†æ›´æ–°æˆ–è€…å¼•å…¥æ–°çš„ç¼–ç¨‹èŒƒå¼ï¼ŒCPUä¹Ÿéœ€è¦è·Ÿç€æ›´æ–°ã€‚

è€Œç‹¬ç«‹äºCè¯­è¨€çš„æŒ‡ä»¤ï¼Œå¯ä»¥ç‹¬ç«‹äºCè¯­è¨€çš„å‘å±•è€Œæ¼”è¿›ã€‚

## æœ€ç®€å•çš„è®¡ç®—æœº

æœ€ç®€å•çš„çœŸå®è®¡ç®—æœºéœ€è¦æ»¡è¶³å“ªäº›æ¡ä»¶:

- ç»“æ„ä¸Š, TRMæœ‰å­˜å‚¨å™¨, æœ‰PC, æœ‰å¯„å­˜å™¨, æœ‰åŠ æ³•å™¨
- å·¥ä½œæ–¹å¼ä¸Š, TRMä¸æ–­åœ°é‡å¤ä»¥ä¸‹è¿‡ç¨‹: ä»PCæŒ‡ç¤ºçš„å­˜å‚¨å™¨ä½ç½®å–å‡ºæŒ‡ä»¤, æ‰§è¡ŒæŒ‡ä»¤, ç„¶åæ›´æ–°PC

NEMUä¸­é€šè¿‡Cä»£ç å®ç°äº†è¿™ä¸ªåŸºæœ¬çš„è®¡ç®—æœºï¼Œç§°ä¹‹ä¸ºâ€œå®¢æˆ·è®¡ç®—æœºâ€ã€‚

- å®¢æˆ·è®¡ç®—æœºï¼šNEMUä¸­æ¨¡æ‹Ÿçš„è®¡ç®—æœº
- å®¢æˆ·ç¨‹åºï¼šNEMUä¸­è¿è¡Œçš„ç¨‹åº

## kconfigç”Ÿæˆçš„å®ä¸æ¡ä»¶ç¼–è¯‘

å¦‚ä½•ç†è§£

```C
#define DEBUG 1
IFDEF(DEBUG, printf("Test IFDEF"));
```

å‚è€ƒ [Macro_Expansion](../../../../../30_KnowHow/Cè¯­è¨€/C_Macro_Expansion.md)

## å‚æ•°ä»å“ªé‡Œæ¥

åœ¨æ‰§è¡Œ NEMU çš„æ—¶å€™ï¼š

```bash
make run
```

è¾“å‡ºï¼š

```bash
crx@ubuntu:nemu$ make run
/home/crx/study/2025/ics2024/nemu/build/riscv32-nemu-interpreter --log=/home/crx/study/2025/ics2024/nemu/build/nemu-log.txt  
[src/utils/log.c:30 init_log] Log is written to /home/crx/study/2025/ics2024/nemu/build/nemu-log.txt
```

æ‰€ä»¥`make run`æœ€ç»ˆæ˜¯è°ƒç”¨äº†`riscv32-nemu-interpreter`ï¼Œå¹¶ä¸”ä¼ å…¥äº†å‚æ•°ï¼š

- `--log=/home/crx/study/2025/ics2024/nemu/build/nemu-log.txt `

```bash
/home/crx/study/2025/ics2024/nemu/build/riscv32-nemu-interpreter 
--log=/home/crx/study/2025/ics2024/nemu/build/nemu-log.txt  
```

è¾“å…¥ç¨‹åº`riscv32-nemu-interpreter `çš„å‚æ•°`--log=...`ï¼Œæœ€ç»ˆä¼šç”±`monitor.c`ä¸­çš„å‡½æ•°`parse_args(argc, argv)`æ¥è§£æã€‚

é‚£ä¹ˆè¿™æ˜¯ä»å“ªé‡Œè¾“å…¥çš„å‚æ•°å‘¢ï¼Ÿ

æˆ‘ä»¬å°±çœ‹ä¸‹ï¼Œ`make run`çš„å‘½ä»¤æ„æˆæ˜¯ä»€ä¹ˆã€‚å…¶å®šä¹‰åœ¨`native.mk`ï¼Œè¿›å…¥æ­¤æ–‡ä»¶å¯ä»¥çœ‹åˆ°ï¼ˆé€šè¿‡æœç´¢å…³é”®å­—`nemu-log.txt`ï¼‰ï¼š

```makefile
# Some convenient rules

override ARGS ?= --log=$(BUILD_DIR)/nemu-log.txt
override ARGS += $(ARGS_DIFF)

# Command to execute NEMU
IMG ?=
NEMU_EXEC := $(BINARY) $(ARGS) $(IMG)

run-env: $(BINARY) $(DIFF_REF_SO)

run: run-env
	$(NEMU_EXEC)
```

å¯ä»¥çœ‹å‡ºå¦‚æœ `ARGS_DIFF` æ²¡æœ‰å®šä¹‰æˆ–ä¸ºç©ºï¼Œé‚£ `ARGS` å°±è¿˜æ˜¯åªæœ‰ `--log=...`ã€‚è€Œæœ€ç»ˆçš„ç¼–è¯‘ç»“æœå°±æ˜¯å¹¶æ²¡æœ‰åŠ å…¥`ARGS_DIFF`çš„ç›¸å…³å‚æ•°ï¼Œè¯æ˜å¹¶æ²¡æœ‰å®šä¹‰è¿™ä¸ªå®ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹`native.mk`æ¥ä¿®æ”¹`nemu`çš„å…¥å‚ã€‚

## init_mem()

NEMU è°ƒç”¨`init_monitor()`è¿›è¡Œåˆå§‹åŒ–å·¥ä½œçš„æ—¶å€™ï¼Œè°ƒç”¨äº†å‡½æ•°`init_mem()`åšäº†ä¸€äº›å†…å­˜æ–¹é¢çš„åˆå§‹åŒ–å·¥ä½œã€‚ä¸‹é¢å°±ç»“åˆä»£ç ç†è§£ä¸‹ï¼ˆ`src/memory/paddr.c`ä¸­ï¼‰ï¼š

```C
// å®šä¹‰ä¸€ä¸ª 128 MB çš„å…¨å±€é™æ€å†…å­˜æ•°ç»„ pmemï¼Œ
// å¹¶ä¸”è¦æ±‚ èµ·å§‹åœ°å€å¿…é¡»æ˜¯ 4096 å­—èŠ‚å¯¹é½ï¼Œå†…å®¹åˆå§‹åŒ–ä¸º 0ã€‚
#define PG_ALIGN __attribute((aligned(4096)))
#define CONFIG_MSIZE 0x8000000
static uint8_t pmem[CONFIG_MSIZE] PG_ALIGN = {};


void init_mem() {
#if   defined(CONFIG_PMEM_MALLOC)
  pmem = malloc(CONFIG_MSIZE);
  assert(pmem);
#endif
  IFDEF(CONFIG_MEM_RANDOM, memset(pmem, rand(), CONFIG_MSIZE));
  Log("physical memory area [" FMT_PADDR ", " FMT_PADDR "]", PMEM_LEFT, PMEM_RIGHT);
}
```

å±•å¼€å…¶å®å®šä¹‰ï¼Œä»£ç å±•ç¤ºä¸ºï¼š

```C
static uint8_t pmem[0x8000000] __attribute((aligned(4096))) = {};
void init_mem() {
  memset(pmem, rand(), 0x8000000);
  Log("physical memory area [" 0x%08x ", " 0x%08x "]", 0x80000000, 0x87FFFFFF));
}
```

è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯ï¼š

- åˆå§‹åŒ–äº†ä¸€æ®µè™šæ‹Ÿçš„ç‰©ç†å†…å­˜ï¼ŒèŒƒå›´æ˜¯ **0x80000000 ~ 0x87FFFFFF**ï¼Œå¤§å°ä¸º 128 MB

## å®¢æˆ·ç¨‹åºæ”¾åœ¨å“ªäº†

`init_isa()`å‡½æ•°(åœ¨`nemu/src/isa/riscv32/init.c`ä¸­å®šä¹‰)è¿›è¡Œä¸¤ä¸ªæ“ä½œï¼š

```C
void init_isa() {
  /* Load built-in image. */
  memcpy(guest_to_host(RESET_VECTOR), img, sizeof(img));

  /* Initialize this virtual computer system. */
  restart();
}
```

- ç¬¬ä¸€é¡¹æ˜¯å°†ä¸€ä¸ªå†…ç½®çš„å®¢æˆ·ç¨‹åºè¯»å…¥åˆ°å†…å­˜ä¸­
- ç¬¬äºŒé¡¹ä»»åŠ¡æ˜¯åˆå§‹åŒ–å¯„å­˜å™¨

é‚£æˆ‘ä»¬å°±èšç„¦äºç¬¬ä¸€æ­¥ï¼Œçœ‹çœ‹å®¢æˆ·ç¨‹åºæ”¾åœ¨å“ªäº†ã€‚

é¦–å…ˆå®¢æˆ·ç¨‹åºæ˜¯ä¸€ä¸ªriscvçš„ç¨‹åºï¼š

```C
// this is not consistent with uint8_t
// but it is ok since we do not access the array directly
static const uint32_t img [] = {
  0x00000297,  // auipc t0,0
  0x00028823,  // sb  zero,16(t0)
  0x0102c503,  // lbu a0,16(t0)
  0x00100073,  // ebreak (used as nemu_trap)
  0xdeadbeef,  // some data
};
```

å¯ä»¥çœ‹å‡º`img`æ˜¯ä¸€ä¸ª`uint32_t`çš„æ•°ç»„ã€‚è¿™é‡Œè§£é‡Šä¸‹ä¸ºä»€ä¹ˆä¸€ä¸ªçœ‹èµ·æ¥æœ‰ç‚¹â€œå¥‡æ€ªâ€çš„å£°æ˜æ–¹å¼æ˜¯å¯æ¥å—çš„ï¼š

> ç”±äº **RISC-V 32 ä½æ¶æ„æŒ‡ä»¤é•¿åº¦ä¸º 32 ä½**çš„ç‰¹æ€§ï¼Œä½¿å¾— `uint32_t` æˆä¸ºå­˜å‚¨è¿™äº›æŒ‡ä»¤çš„ç†æƒ³æ•°æ®ç±»å‹ã€‚
>
> æ³¨é‡Šåªæ˜¯æé†’ä½ ï¼Œå°½ç®¡åœ¨å†…å­˜å±‚é¢è¿™äº›æ•°æ®æœ€ç»ˆè¿˜æ˜¯ä»¥å­—èŠ‚å½¢å¼å­˜åœ¨ï¼Œä½†åœ¨ C ä»£ç å±‚é¢ï¼Œåªè¦ä½ ä¸è¿›è¡Œå­—èŠ‚çº§çš„ç›´æ¥è®¿é—®ï¼Œå°†å®ƒä»¬è§†ä¸º 32 ä½æ•´æ•°æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ã€‚

å®¢æˆ·ç¨‹åºè¢«åˆ†é…åˆ°äº†`guest_to_host(RESET_VECTOR)`çš„ä½ç½®ã€‚å¦‚æœæƒ³çŸ¥é“å­˜æ”¾åœ¨å“ªé‡Œï¼Œå°±éœ€è¦ç†è§£å‡½æ•°`guest_to_host(paddr)`ï¼ˆåœ¨`src/memory/paddr.c`ï¼‰ã€‚

```C
#define CONFIG_MBASE 0x80000000
#define CONFIG_MSIZE 0x8000000
#define PG_ALIGN __attribute((aligned(4096)))

#if defined(CONFIG_PMEM_MALLOC)
static uint8_t *pmem = NULL;
#else
static uint8_t pmem[CONFIG_MSIZE] PG_ALIGN = {};
#endif

typedef MUXDEF(PMEM64, uint64_t, uint32_t) paddr_t;

uint8_t* guest_to_host(paddr_t paddr) { return pmem + paddr - CONFIG_MBASE; }
```

è¿™ä¸ªå‡½æ•°çš„ç›®æ ‡æ˜¯å°† **å®¢æˆ·æœºï¼ˆguestï¼‰ç‰©ç†åœ°å€ `paddr`**ï¼Œè½¬æ¢æˆåœ¨ **å®¿ä¸»æœºï¼ˆhostï¼‰ä¸Šçš„å†…å­˜åœ°å€**ï¼ˆå³å®é™…å†…å­˜è®¿é—®åœ°å€ï¼‰ã€‚å®ƒæœ¬è´¨ä¸Šæ„å»ºäº†ä¸€ä¸ªä»â€œå®¢æˆ·æœºç‰©ç†åœ°å€ç©ºé—´â€åˆ°â€œå®¿ä¸»æœºè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´â€çš„ **çº¿æ€§æ˜ å°„**ã€‚ä¸‹é¢æ˜¯è¯¦ç»†åˆ†æï¼š

- **`CONFIG_MBASE`**: è¿™æ˜¯ä¸€ä¸ªå®ï¼Œå®šä¹‰äº†å®¢æˆ·æœºï¼ˆguestï¼‰ç‰©ç†å†…å­˜çš„**èµ·å§‹åŸºåœ°å€**ã€‚æ„å‘³ç€å¯¹äºå®¢æˆ·æœºç¨‹åºæ¥è¯´ï¼Œå®ƒçš„å†…å­˜åœ°å€ä» `0x80000000` å¼€å§‹ã€‚

- **`PG_ALIGN`**: è¿™æ˜¯ä¸€ä¸ªå®ï¼Œç”¨äºå†…å­˜å¯¹é½ã€‚

  - **`__attribute((aligned(4096)))`**ï¼Œè¿™æ˜¯ GCC (GNU Compiler Collection) ç¼–è¯‘å™¨çš„ä¸€ä¸ªæ‰©å±•å±æ€§ã€‚
  - **`aligned(4096)`**ï¼Œè¡¨ç¤ºè¢«è¿™ä¸ªå±æ€§ä¿®é¥°çš„å˜é‡ï¼ˆæˆ–å†…å­˜å—ï¼‰çš„èµ·å§‹åœ°å€å¿…é¡»æ˜¯ `4096` å­—èŠ‚ï¼ˆå³ 4KBï¼‰çš„æ•´æ•°å€ã€‚

- `pmem`ä¸ºå®¢æˆ·ç¨‹åºçš„ç‰©ç†å†…å­˜ã€‚

  - `static uint8_t pmem[CONFIG_MSIZE]`: `pmem` è¢«å£°æ˜ä¸ºä¸€ä¸ªé™æ€çš„ `uint8_t` æ•°ç»„ã€‚å…¶å¤§å°ä¸º`CONFIG_MSIZE`ï¼Œå³ä¸º`0x8000000`ä¸ªå­—èŠ‚ã€‚
  - `PG_ALIGN`: è¿™ä¸ªå®åœ¨è¿™é‡Œç”Ÿæ•ˆï¼Œç¡®ä¿ `pmem` æ•°ç»„çš„èµ·å§‹åœ°å€æ˜¯ 4096 å­—èŠ‚å¯¹é½çš„ã€‚

  è¿™ç§æ–¹å¼ä¼šåœ¨ç¨‹åºç¼–è¯‘é“¾æ¥æ—¶å°±ä¸º `pmem` åˆ†é…å›ºå®š`128MB`å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œé€šå¸¸åœ¨ç¨‹åºçš„ BSS æ®µæˆ–æ•°æ®æ®µã€‚é€‚ç”¨äºå†…å­˜å¤§å°å›ºå®šä¸”åœ¨ç¼–è¯‘æ—¶å·²çŸ¥çš„åœºæ™¯ã€‚

- åœ°å€è½¬æ¢å‡½æ•°`guest_to_host(paddr_t)`

  - **`paddr_t` **æ˜¯ç”¨æ¥è¡¨ç¤º**â€œå®¢æˆ·æœºçš„ç‰©ç†åœ°å€â€**çš„ä¸“ç”¨ç±»å‹ï¼Œä»£è¡¨å®¢æˆ·ç¨‹åºçœ¼ä¸­çš„çœŸå®å†…å­˜ä½ç½®ã€‚
  - `paddr_t` è¡¨ç¤ºå®¢æˆ·ç¨‹åºå‘å‡ºçš„ç‰©ç†åœ°å€ï¼ˆå¦‚å–æŒ‡ä»¤ã€è¯»å†™æ•°æ®ï¼‰
  - `guest_to_host` æŠŠå®ƒæ˜ å°„åˆ°å®¿ä¸»æœºä¸­çœŸæ­£çš„å†…å­˜æŒ‡é’ˆï¼ˆæ¨¡æ‹Ÿå†…å­˜ï¼‰

- `paddr - CONFIG_MBASE`

  - å› ä¸ºå®¢æˆ·æœºç‰©ç†å†…å­˜æ˜¯ä» `0x80000000` å¼€å§‹çš„ï¼Œæ‰€ä»¥å‡å» `CONFIG_MBASE`ï¼Œç›¸å½“äºè®¡ç®—å®¢æˆ·æœºåœ°å€åœ¨ pmem è¿™å—å†…å­˜ä¸­çš„åç§»ã€‚

    ä¾‹å¦‚ï¼š

    ```C
    paddr = 0x80001000
    CONFIG_MBASE = 0x80000000
    offset = 0x1000
    ```

- ### `pmem + offset`

  - æœ€åå°†è¿™ä¸ªåç§»åŠ åˆ° `pmem` ä¸Šï¼Œå¾—åˆ°çš„æ˜¯ï¼šå®¿ä¸»æœºè¿›ç¨‹ä¸­å®é™…è¦è®¿é—®çš„è™šæ‹Ÿåœ°å€ã€‚
  - è¡¨ç¤º â€œå®¢æˆ·æœºåœ°å€ `0x80001000` æ˜ å°„åˆ°å®¿ä¸»æœºä¸­ `pmem + 0x1000`â€

å®å®šä¹‰`RESET_VECTOR `å€¼ä¸º`0x80000000`ï¼ˆåœ¨`nemu/include/memory/paddr.h`ä¸­å®šä¹‰ï¼‰ï¼š

```C
#define RESET_VECTOR (PMEM_LEFT + CONFIG_PC_RESET_OFFSET)

#define PMEM_LEFT  ((paddr_t)CONFIG_MBASE)  // è¾…åŠ©å®
#define CONFIG_PC_RESET_OFFSET 0x0			// è¾…åŠ©å®
```

æ‰€ä»¥ï¼š

```C
guest_to_host(0x80000000) == pmem + (0x80000000 - 0x80000000) == pmem
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç¨‹åºä» `0x80000000` å¼€å§‹ï¼Œå°±è¢«åŠ è½½åˆ° `pmem[0]` å¼€å§‹çš„ä½ç½®ï¼ˆä¸»æœºä½ç½®ï¼‰ã€‚è¿™ä¹Ÿè¯´æ˜ï¼š

- å®¢æˆ·ç¨‹åºå®é™…åœ¨å®¿ä¸»æœºçš„ `pmem[0]` å¼€å§‹å­˜æ”¾ã€‚
- `guest_to_host()` æä¾›äº†ä¸€ä¸ªä» **å®¢æˆ·æœºè§†è§’åœ°å€ç©ºé—´** åˆ° **å®¿ä¸»æœºåœ°å€ç©ºé—´çš„è®¿é—®æ‰‹æ®µ**ã€‚

### æ€»ç»“`guest_to_host(paddr)`

- **åŠŸèƒ½**ï¼šå°† guest ç‰©ç†åœ°å€ï¼ˆä»¥ `CONFIG_MBASE` ä¸ºèµ·ç‚¹ï¼‰æ˜ å°„åˆ° host ä¸­ `pmem` çš„åç§»åœ°å€ã€‚
- **æ„ä¹‰**ï¼šåœ¨æ¨¡æ‹Ÿå™¨æˆ–è½¯ç¡¬ä»¶åä½œç³»ç»Ÿä¸­ï¼Œè®© host ç³»ç»Ÿèƒ½å¤Ÿè¯»å†™å®¢æˆ·æœºçš„å†…å­˜ã€‚
- **å…³é”®å‰æ**ï¼šå®¢æˆ·æœºæ‰€æœ‰åœ°å€éƒ½å¿…é¡»åœ¨ `[CONFIG_MBASE, CONFIG_MBASE + CONFIG_MSIZE)` ä¹‹é—´ï¼Œå¦åˆ™è¶Šç•Œè®¿é—®ã€‚

### æ£€éªŒæŒ‡ä»¤åŠ è½½æµç¨‹

å®¢æˆ·ç¨‹åºä» `0x80000000` å¼€å§‹ï¼Œå°±è¢«åŠ è½½åˆ° `pmem[0]` å¼€å§‹çš„ä½ç½®ï¼ˆä¸»æœºä½ç½®ï¼‰ã€‚

æˆ‘ä»¬ä¸å¦¨ä½¿ç”¨ gdb åšä¸ªæµ‹è¯•ï¼š

> âœ…éªŒè¯å®¢æˆ·ç¨‹åºè¢«æ­£ç¡®åœ°åŠ è½½åˆ°äº† guest çš„ `0x80000000` åœ°å€ï¼ˆå³ host çš„ `pmem[0]`ï¼‰ï¼Œä¸ `guest_to_host(paddr)` çš„ç†è®ºä¸€è‡´ã€‚

```bash
(gdb) b monitor.c:118                                                                                                                     Breakpoint 1 at 0x4756: file src/monitor/monitor.c, line 118.                                                                             (gdb) run                                                                                                                                 Starting program: /home/crx/study/2025/ics2024/nemu/build/riscv32-nemu-interpreter --log=/home/crx/study/2025/ics2024/nemu/build/nemu-log.txt                                                                    
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[src/utils/log.c:30 init_log] Log is written to /home/crx/study/2025/ics2024/nemu/build/nemu-log.txt
[src/memory/paddr.c:50 init_mem] physical memory area [0x80000000, 0x87ffffff]

Breakpoint 1, init_monitor (argc=<optimized out>, argv=<optimized out>) at src/monitor/monitor.c:118
118       init_isa();

(gdb) p guest_to_host(RESET_VECTOR)
// pmem æ˜¯æ¨¡æ‹Ÿçš„ç‰©ç†å†…å­˜ï¼Œä½äº host çš„è™šæ‹Ÿåœ°å€ç©ºé—´ 0x55555555f000ã€‚
$1 = (uint8_t *) 0x55555555f000 <pmem> '\340' <repeats 199 times>, <incomplete sequence \340>...

(gdb) x pmem
0x55555555f000 <pmem>:  0xe0e0e0e0

(gdb) p (pmem == guest_to_host(RESET_VECTOR))
$2 = 1

(gdb) n	// æ­¤æ—¶å·²ç»æ‰§è¡Œå®Œæ¯• memcpy(...);
42        restart();

(gdb) set $addr = guest_to_host (RESET_VECTOR)
(gdb) x/5xw $addr
0x55555555f000 <pmem>:  0x00000297      0x00028823      0x0102c503      0x00100073
0x55555555f010 <pmem+16>:       0xdeadbeef

(gdb) x/5xw pmem
0x55555555f000 <pmem>:  0x00000297      0x00028823      0x0102c503      0x00100073
0x55555555f010 <pmem+16>:       0xdeadbeef
```

## åŸºç¡€è®¾æ–½

### æ‰“å°å¯„å­˜å™¨

è¿™é‡Œéœ€è¦ç”¨æˆ·åœ¨è¾“å…¥`info r`åæ‰“å°æ‰€æœ‰å¯„å­˜å™¨çš„å€¼ã€‚é¦–å…ˆå°±æ˜¯éœ€è¦æ‰¾åˆ°å­˜æ”¾å¯„å­˜å™¨å€¼çš„ä½ç½®åœ¨å“ªé‡Œã€‚

æ ¹æ®ä¹‹å‰ RTFSC ç« èŠ‚ï¼Œå¯ä»¥å¾—çŸ¥ï¼šåœ¨ NEMU çš„æ¡†æ¶ä»£ç ä¸­ï¼ŒCPU çš„æ‰€æœ‰å¯„å­˜å™¨ï¼ˆå¦‚é€šç”¨å¯„å­˜å™¨ã€ç¨‹åºè®¡æ•°å™¨ **PC** ç­‰ï¼‰çš„æ•°æ®ä¼šè¢«ç»„ç»‡åœ¨ä¸€ä¸ª**æ•°æ®ç»“æ„**ä¸­ï¼Œè¿™ä¸ªç»“æ„ä½“ä»£è¡¨äº† CPU çš„å½“å‰çŠ¶æ€ã€‚

å¯„å­˜å™¨ç»“æ„ä½“åœ¨`src/isa/riscv32/include/isa-def.h`ä¸­å®šä¹‰ï¼š

```C
typedef struct {
  word_t gpr[MUXDEF(CONFIG_RVE, 16, 32)];
  vaddr_t pc;
} MUXDEF(CONFIG_RV64, riscv64_CPU_state, riscv32_CPU_state);
```

å¹¶ä¸”æ ¹æ®å®å®šä¹‰ä»¥åŠé…ç½®æ–‡ä»¶ç”Ÿæˆçš„`autoconf.c`ï¼Œä»¥åŠ`.config`ä¸­çš„æè¿°ï¼š

```ini
# CONFIG_RV64 is not set
# CONFIG_RVE is not set
```

å¯ä»¥å¾—çŸ¥ riscv32 çš„å¯„å­˜å™¨ç»“æ„ä½“ä¸ºï¼š

```C
typedef struct {
  word_t gpr[32]; // RISC-V 32-bit (RV32I) æ ‡å‡†æœ‰ 32 ä¸ªé€šç”¨å¯„å­˜å™¨ (x0-x31)
  vaddr_t pc;
} riscv32_CPU_state;
```

å¹¶ä¸”é¡¹ç›®åœ¨`nemu/src/cpu/cpu-exec.c`ä¸­å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡`cpu`:

```C
CPU_state cpu = {};
```

å¯ä»¥å¾—çŸ¥ï¼Œå¯„å­˜å™¨çš„å€¼ï¼Œå°±åœ¨å˜é‡`cpu`ä¸­ã€‚

æ—¢ç„¶æ‰¾åˆ°äº†å¯„å­˜å™¨çš„å­˜æ”¾ä½ç½®ï¼Œä¸‹é¢å°±æ˜¯æ‰“å°å¯„å­˜å™¨çš„å€¼äº†ã€‚

ç»Ÿä¸€çš„æ‰“å°å¯„å­˜å™¨å€¼çš„å‡½æ•°åœ¨å¯¹åº”`$ISA`ä¸­ï¼Œå½“å‰æ¶æ„çš„å‡½æ•°å®šä¹‰åœ¨`src/isa/riscv32/reg.c`ä¸‹ï¼š

```C
void isa_reg_display() {
}
```

æ‰“å°è¦æ±‚å°±æ˜¯å°†å¯„å­˜å™¨çš„æ‰€æœ‰æ•°æ®æ‰“å°ï¼š

- æ‰“å° 32 ä¸ªé€šç”¨å¯„å­˜å™¨
- æ‰“å° PC

æ‰“å°å½¢å¼ç±»ä¼¼äº gdb è¾“å‡ºï¼š

```bash
(gdb) info r
rax            0x5555555565a9      93824992241065
rbx            0x7fffffffe158      140737488347480
...
```

æ ¼å¼ï¼š

- åå…­è¿›åˆ¶ä¸è¡¥ 0

- æ•´ä½“å®½åº¦ä¾æ—§ä¿æŒä¸€è‡´

- ä¸ç­‰é•¿çš„ hex è¾“å‡ºå³ä¾§è¡¥ç©ºæ ¼ï¼Œä½¿åˆ—å¯¹é½

  ä¾‹å¦‚

  ```bash
  0x0       
  0xa       
  0x1234    
  0x12345678
  ```

ç¤ºä¾‹å®ç°ï¼š

```C
void isa_reg_display() {
  for (int i = 0; i < 32; i ++) {
    uint32_t val = gpr(i);

    char hexbuf[16];
    sprintf(hexbuf, "0x%x", val);   // ä¸è¡¥é›¶

    printf("%s\t%-10s\t%d\n", reg_name(i), hexbuf, val);
  }

  char pcbuf[16];
  sprintf(pcbuf, "0x%x", cpu.pc);

  printf("pc\t%-10s\t%d\n", pcbuf, cpu.pc);
}
```

### è®¿é—®å®¢æˆ·è®¡ç®—æœºçš„å†…å­˜æ•°æ®

è¿™é‡Œé¦–å…ˆéœ€è¦ç†è§£ï¼Œå®¢æˆ·è®¡ç®—æœºçš„å†…å­˜æ˜¯ä»€ä¹ˆç»´æŠ¤çš„å’Œå¦‚ä½•è®¿é—®çš„ã€‚

åœ¨[ å‡†å¤‡ç¬¬ä¸€ä¸ªå®¢æˆ·ç¨‹åº](https://nju-projectn.github.io/ics-pa-gitbook/ics2025/1.3.html#%E5%87%86%E5%A4%87%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%A8%8B%E5%BA%8F)ç« èŠ‚ä¸­ï¼Œæåˆ°äº† :

> å†…å­˜é€šè¿‡åœ¨`nemu/src/memory/paddr.c`ä¸­å®šä¹‰çš„å¤§æ•°ç»„`pmem`æ¥æ¨¡æ‹Ÿ. åœ¨å®¢æˆ·ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­, æ€»æ˜¯ä½¿ç”¨`vaddr_read()`å’Œ`vaddr_write()` (åœ¨`nemu/src/memory/vaddr.c`ä¸­å®šä¹‰)æ¥è®¿é—®æ¨¡æ‹Ÿçš„å†…å­˜. vaddr, paddråˆ†åˆ«ä»£è¡¨è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€. 

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`vaddr_read()`æ¥è®¿é—®å®¢æˆ·æœºçš„è™šæ‹Ÿå†…å­˜ã€‚ä¸‹ä¸€æ­¥å°±æ˜¯ç¡®å®šæ¨¡æ‹Ÿå†…å­˜çš„åˆæ³•ç©ºé—´ã€‚

å†…å­˜çš„èµ·å§‹åœ°å€ä¸ºï¼š`0x80000000`ï¼›ç©ºé—´å¤§å°ä¸ºï¼š`0x8000000`ã€‚æ‰€ä»¥åˆæ³•ç©ºé—´ä¸º`[0x80000000, 0x88000000]`

ç†è§£äº†å†…å­˜æ˜¯å¦‚ä½•è®¿é—®çš„ï¼Œé‚£ä¹ˆçœ‹ä¸‹å–å‡ºçš„æ•°æ®è¾“å‡ºæ ¼å¼ï¼š

> æ±‚å‡ºè¡¨è¾¾å¼`EXPR`çš„å€¼, å°†ç»“æœä½œä¸ºèµ·å§‹å†…å­˜åœ°å€, ä»¥åå…­è¿›åˆ¶å½¢å¼è¾“å‡ºè¿ç»­çš„`N`ä¸ª4å­—èŠ‚

è¾“å‡ºçš„æ ¼å¼ä¸ºï¼š

- N ä¸ªæ•°æ®
- åå…­è¿›åˆ¶
- æ¯ä¸ªæ•°æ®å¤§å°ä¸º 4 å­—èŠ‚

è¿™æ ·å¯¹åº”çš„`gdb`å†…å­˜è¾“å‡ºå‘½ä»¤æ ¼å¼ç±»ä¼¼ä¸ºï¼š

```bash
(gdb) x/10xw 0x7fffffffdd58
0x7fffffffdd58: 0xffffe0f1      0x00007fff      0xffffe12d      0x00007fff
0x7fffffffdd68: 0x00000000      0x00000000      0xffffe163      0x00007fff
0x7fffffffdd78: 0xffffe173      0x00007fff
```

ç»¼ä¸Šï¼Œæˆ‘ä»¬è¦å®ç°çš„å¾ªç¯æ‰“å° N ä¸ªå†…å­˜æ•°æ®ä¸»è¦é€»è¾‘æœ‰ï¼š

1. é€šè¿‡`vaddr_read()`è¯»å– 32 ä½çš„æ•°æ®
2. ä»¥ 16 è¿›åˆ¶çš„æ ¼å¼è¾“å‡º
3. å†…å­˜å‰è¿› 4 ä¸ªå­—èŠ‚

ç„¶åæ ¼å¼ä¸Šå°½é‡ä¸ `gdb` è¾“å‡ºçš„æ ¼å¼ç±»ä¼¼ï¼š

1. é¦–å…ˆä»¥ 16 è¿›åˆ¶çš„æ ¼å¼ï¼Œè¾“å‡ºåœ°å€
2. ç„¶åæ¯ 4 ä¸ª 32 ä½ï¼ˆ4å­—èŠ‚ï¼‰çš„æ•°æ®ä¸€è¡Œè¾“å‡ºæ‰“å°

> ğŸ”¥ç–‘ç‚¹è®°å½•ï¼šmonitor åº”ä¸åº”è¯¥ç›´æ¥ä½¿ç”¨ paddr èŒƒå›´æ£€æŸ¥ï¼Ÿ
>
> ç­”ï¼š
>
> ä¸ç”¨ã€‚å› ä¸ºï¼š
>
> - monitor **è´Ÿè´£è§£é‡Šå‘½ä»¤**
> - vaddr_read **è´Ÿè´£æ£€æŸ¥åˆæ³•æ€§**
> - paddr_read **è´Ÿè´£åˆ¤æ–­æ˜¯å¦åœ¨ç‰©ç†å†…å­˜**
>
> monitor ä¸åº”è¯¥è¶Šç•Œåš paddr èŒƒå›´åˆ¤æ–­ã€‚
>
> æ€»ç»“å°±æ˜¯ï¼š
>
> â—monitor æ˜¯â€œç”¨æˆ·æ€â€è§†è§’ï¼Œåªèƒ½å¤„ç† vaddr
>
> â—åœ°å€åˆæ³•æ€§åˆ¤æ–­ç”± vaddr_read() / paddr_read() å®Œæˆ

## è¡¨è¾¾å¼æ±‚å€¼

### è¯æ³•åˆ†æ

å°†è¡¨è¾¾å¼æ‹†æˆä¸€ä¸ªä¸ªçš„åŸºç¡€å•å…ƒï¼Œæ–¹ä¾¿åç»­æ±‚å€¼å¤„ç†ã€‚å…·ä½“åˆ†æè¯·çœ‹ [è¯æ³•åˆ†æï¼ˆLexical Analysisï¼‰](../../Topics/Expr/01-Lexical.md)ç« èŠ‚

