# PLC 开发需求

------

## 1. 系统概述

系统基于 PLC 实现多轴运动控制，包含：

- 一组双轴同步控制电机（X1 / X2）
- 三个独立控制电机
- 共 5 个电机轴，其中：
  - 4 个直线轴（单位：mm、mm/s）
  - 1 个旋转轴（单位：°、°/s）

系统以**机械物理量**作为统一控制接口。

------

## 2. 轴机械参数配置

每个轴需支持以下机械参数配置：

- 传动方式（丝杆 / 齿轮 / 直连）
  - 丝杆导程（mm / rev，若适用）
  - 齿轮外径（mm）

- 减速机减速比
- 轴类型（直线轴 / 旋转轴）

PLC 根据上述参数完成物理量到电机转速的自动换算。

------

## 3. 通用轴控制接口

每个轴需支持：

- 点动速度配置（mm/s 或 °/s）
- 位置移动速度配置（mm/s 或 °/s）
- 正向点动
- 反向点动
- 相对位置移动（mm 或 °）
- 绝对位置移动（mm 或 °）

所有接口仅接受**物理单位参数**。

------

## 4. 双轴同步控制

- X1 / X2 构成同步轴
- 同步模式下：
  - 两轴目标速度相同（物理单位）
  - 方向相反
- PLC 内部自动完成转速换算与下发

------

## 5. 双轴位置超差检测与处理

- 实时监测双轴物理位置偏差
- 当偏差超过阈值：
  - 触发受控停机
  - 禁止同步模式
  - 进入补偿流程

------

## 6. 单轴补偿模式

- 支持在超差后切换至单轴补偿
- 补偿目标基于物理位置差计算
- 补偿过程受所有限位与安全规则约束

------

## 7. 限位与安全规则

### 7.1 通用限位

- 每轴具备独立最大 / 最小物理限位

### 7.2 组合限位

- 支持基于 X-Z 轴位置的动态限位修正
- 限位逻辑统一封装

------

## 8. 状态管理与对外接口

- PLC 维护完整运行状态机
- 对外提供：
  - 当前状态
  - 错误类型
  - 是否允许运动

------

## 9. 位置坐标体系与原点管理

### 9.1 坐标定义

系统对每个轴维护以下三类位置量：

- **绝对位置（Absolute Position）**

  - 来源于电机绝对值编码器
  - 上电即有效
  - 不依赖回原流程
  - 单位与轴类型一致（mm 或 °）

- **相对原点偏移（Relative Zero Offset）**

  - 由 PLC 维护的软件偏移量
  - 不写入驱动器
  - 用于定义用户参考零点

- **相对位置（Relative Position）**

  - 由 PLC 计算得到

  - 计算公式：

    ```C
    Relative Position = Absolute Position - Relative Zero Offset
    ```

------

### 9.2 相对原点操作接口

PLC 需支持以下操作：

#### 1）设置当前位置为相对原点

- 操作行为：

  - 将当前绝对位置记录为相对原点偏移

- PLC 行为：

  ```C
  Relative Zero Offset := Absolute Position
  ```

- 结果：

  - 相对位置显示为 0
  - 绝对位置保持不变

------

#### 2）清除相对原点

- 操作行为：

  - 清除用户定义的相对原点

- PLC 行为（推荐）：

  ```C
  Relative Zero Offset := Absolute Position
  ```

- 目的：

  - 便于重新定义相对 0 点
  - 避免历史偏移累积

------

### 9.3 绝对位置清零操作（受控）

- PLC 需支持对驱动器执行**绝对位置清零**
- 该操作：
  - 会修改电机绝对位置基准
  - 会影响所有相对位置计算
- 要求：
  - 仅允许在停机状态下执行
  - 执行后应提示用户清除或重新设置相对原点

------

### 9.4 显示与接口要求

- 对外需同时提供：
  - 绝对位置
  - 相对位置
- 所有运动指令：
  - 绝对位置移动：基于**相对位置坐标系**
  - 相对位置移动：基于**相对位置增量**

## 10.  旋转轴专用接口

### 10.1 对外接口定义

**接口语义：**

> 让旋转轴回到机械零位，并将该位置同时设置为：
>
> - 绝对位置零点
> - 相对位置零点

### 10.2 接口调用前置条件（硬约束）

PLC 必须检查：

- 当前轴状态 == 停机
- 无报警
- 不在同步模式
- 不在补偿流程（双电机无超差预警）
- 安全条件满足（门锁 / 急停 / 使能）

否则：

- 拒绝执行
- 返回错误状态

### 10.3回原点完成后的系统行为约定

调用完成后：

| 项目         | 数值 |
| ------------ | ---- |
| 绝对位置     | 0°   |
| 相对位置     | 0°   |
| 相对原点偏移 | 0°   |

------

## 11. 运动过程状态检测与上报

------

### 11.1 设计目标

PLC 需对每一次运动指令的执行过程进行完整状态监测，并对外提供**统一、明确、可机读的运动状态信号**，用于：

- 上位机 UI 显示
- 工艺流程联动
- 异常处理与恢复

------

### 11.2 运动状态定义

PLC 对每个轴（及同步轴组）维护以下运行状态：

| 状态          | 含义                     |
| ------------- | ------------------------ |
| IDLE          | 空闲，未运动             |
| RUNNING       | 正在运动                 |
| FINISHED      | 运动正常完成             |
| ALARM         | 运动过程中发生报警       |
| ALARM_CLEARED | 报警已解除，等待重新启动 |

------

### 11.3 运动状态触发规则

#### 11.3.1 进入 RUNNING 状态

当满足以下条件时，PLC 进入 RUNNING 状态：

- 接收到有效运动指令（点动 / 相对 / 绝对）
- 所有安全与限位条件满足
- 运动命令已成功下发至驱动器

PLC 行为：

- 状态切换为 `RUNNING`
- 对外上报“运行中”状态

------

#### 11.3.2 运动完成检测（FINISHED）

PLC 必须基于以下条件综合判断运动完成：

- 驱动器反馈：
  - 到位信号（`InPosition` / `TargetReached`）
  - 或速度为 0 且误差小于阈值
- PLC 逻辑确认：
  - 未触发限位
  - 未进入报警状态

PLC 行为：

- 状态切换为 `FINISHED`
- 对外发送“运动完成”状态信号

> ⚠️ **禁止仅以“命令发送完成”作为运动完成依据**

------

#### 11.3.3 报警状态检测（ALARM）

在运动过程中，若发生以下任一情况：

- 驱动器报警
- 超出物理限位 / 组合限位
- 同步轴超差
- 通信异常
- 内部状态机异常

PLC 行为：

- 立即进入 `ALARM` 状态
- 执行受控停机
- 对外发送“报警状态”信号
- 禁止一切新的运动指令

------

#### 11.3.4 报警解除（ALARM_CLEARED）

当满足以下条件时，允许解除报警：

- 报警源已消失
- 驱动器处于可使能状态
- 用户或上位机明确执行“解除报警”操作

PLC 行为：

- 清除报警标志
- 状态切换为 `ALARM_CLEARED`
- 对外发送“报警已解除”信号
- 等待重新下发运动指令

------

### 11.4 点动过程状态监测（Jog Monitoring）

#### 11.4.1 点动状态规则

在点动模式下：

- 轴状态视为 `RUNNING`
- PLC 需周期性监测：
  - 当前物理位置
  - 点动累计位移
  - 是否触发限位或报警

------

#### 11.4.2 点动实时上报接口

PLC 对外提供点动监测数据，包括：

- 当前点动位移（物理单位）
- 当前轴状态（RUNNING / ALARM）

该数据用于上位机实时显示与安全判断。

------

11.5 对外接口要求

PLC 对外至少提供以下状态接口：

| 接口项       | 说明                       |
| ------------ | -------------------------- |
| 当前运行状态 | RUNNING / FINISHED / ALARM |
| 报警类型     | 报警代码或分类             |
| 是否允许运动 | true / false               |

------

### 11.6 设计约束

- 运动状态由 PLC **唯一维护**
- 上位机不得自行推断运动完成
- 报警状态具有最高优先级
- 状态切换必须单向、可追溯

------

