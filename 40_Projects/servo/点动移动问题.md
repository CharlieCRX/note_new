# 点动问题汇总

## 一、Z1不运行 ERR13

### 1.前提条件

在大量运行X1X2点动无异常后，此时切换Z1电机，执行位置移动。

此时Z1无反应，但是松开摇杆后，蜂鸣器提示电机运行结束。

查看伺服控制器，发现报错ERR13：驱动器过负载。

### 2.日志记录

[Z1点动失效](./log/Z1点动失效.txt)

### 3.问题背景

#### 3.1 DO输出与刹车

这里首先介绍下，P100S的[DO输出和抱闸](./P100S的DO输出与抱闸.md)之间的关系。

#### 3.2 Modbus 广播 (Broadcast)

**Modbus 广播 (Broadcast)** 是一种特殊的通信方式，允许主站（Master，例如 PLC 或电脑）向网络中连接的**所有从站**（Slave，例如伺服驱动器）同时发送指令。

- **广播地址**：Modbus 协议规定 **地址 0** 为广播地址。
  - 当主站向地址 `0` 发送数据时，网络上的**每一台**从站都会接收并执行这条指令。

- **不回复（No Response）**：这是广播最重要的特征。

  - 在正常的点对点通信中，从站收到指令后必须回复（应答）。

  - 在广播模式下，**所有从站都只接收执行，绝不回复**。

  - **原因**：RS485 是半双工总线，如果所有从站同时回复，信号会撞车（冲突），导致主站什么也收不到。

#### 3.3 点动模式的广播

已知当前的项目出现 Modbus 从地址为`M_ALL(-1)`的相关写，都是Modbus 广播通讯（因为底层都+1了，所以最终从地址0）。

那我们检查下点动模式下，涉及到的广播逻辑：

首先是双电机运行时涉及到的广播：

1. `clearBrakeDOConfig(M_ALL)`：将所有电机的 DO2 的抱闸控制取消（其它电机使能也不会运动）
2. `jogStart(M_ALL)`：所有电机伺服使能（`PA53 = 1`）（此时因为其他电机 DO2 抱闸控制失效，所以电机使能也不会真的运动）

另外就是单电机运行时，也会发送广播：

- `restoreBrakeDOConfig(M_ALL)`：恢复所有电机的 DO2 抱闸控制。

#### 3.4 位置移动的广播

因为也涉及到位置移动的相关流程，所以这里也整理下位置移动的时候，发送的广播。

双电机位置移动：

- `run2Target(M_ALL)`：向所有电机的`P3_31`输入端子写入1，代表位置移动开始

### 4.问题分析

#### 4.1 双电机点动取消DO2控制抱闸

首先双电机在运行的时候，调用`clearBrakeDOConfig()`取消了所有电机的 DO2 的抱闸控制功能。

但是在运行之前，又调用`restoreBrakeDOConfig()`恢复了X1、X2电机的 DO2 抱闸控制功能。

所以在后续广播给所有电机进行伺服使能`jogStart()`后，X1X2电机可以正常点动。

#### 4.2 Z1位置移动与抱闸控制失效

在双电机点动结束后，此时除X1、X2电机的 DO2 是正常控制抱闸外，其他电机的 DO2 口均无法正常控制抱闸。

由于位置移动也不会恢复 Z1 电机的抱闸控制，所以会导致 Z1电机使能后，抱闸一直不能松开，从而导致 ERR13 过负载问题。

### 5.解决思路

可以通过学习位置移动逻辑来控制。

这个取消和恢复抱闸，均是为了服务于点动的最终启动逻辑`jogStart()`。这个函数就是给电机使能的。

那可以通过伺服使能先于点动模式配置，从而消除对 DO2 的抱闸逻辑配置。

#### 5.1设想

双电机点动逻辑为：

1. 预启动：将X1X2 DI 输入设置为点动模式，并分别配置 X1、X2使能
2. DI点动输入：广播所有电机为点动模式

这样仅是X1、X2电机使能且配置了点动模式的电机，才能点动运行。

无法实现，原因是：X1X2的方向不一致，无法使用广播同时发送不同的JOGMOVE方向。

## 二、X1X2位置移动会导致Z1电机乱动

### 1.前提条件

- X1X2点动
- 切换到位置移动
- X1X2位置移动

此时会发生的现象是：

1. X1X2前进的同时
2. Z1也一起运动，且一顿一顿的，有卡嚓声（估计是抱闸）

### 2.问题分析

#### 4.1 双电机点动取消DO2控制抱闸

首先双电机在运行的时候，调用`clearBrakeDOConfig()`取消了所有电机的 DO2 的抱闸控制功能。

但是在运行之前，又调用`restoreBrakeDOConfig()`恢复了X1、X2电机的 DO2 抱闸控制功能。

所以在后续广播给所有电机进行伺服使能`jogStart()`后，X1X2电机可以正常点动。

#### 4.2 位置移动Z1运动

是否Z1还是处于使能状态？`jogStop()`是这样的。

在X1X2前进的时候，广播给所有电机使能。但是此时除了X1X2配置了点动模式外，其他电机并没有配置点动模式，所以不会运动。

但是停止的时候，并没有将所有电机的使能关闭，只是关闭了X1、X2电机的使能。

在X1、X2位置移动的时候，此时会广播让所有电机的`P3-31`输入为1，则为位置移动模式。由于之前的电机均未使能关闭，这就导致其实除了Z1外，其他电机也都在运动。

所以罪魁祸首就是`jogStop()`的逻辑问题。在末尾加上所有电机停止即可了。